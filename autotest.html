<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»çµ±å…¨åŠŸèƒ½è‡ªå‹•æª¢æ ¸ - è‡è‡å®…é…ç¶²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #111827; color: #d1d5db; font-family: 'Consolas', 'Monaco', monospace; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .bg-red-500 { background-color: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .bg-green-500 { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .bg-yellow-500 { background-color: #eab308; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .category-header { background-color: #374151; color: #e5e7eb; font-weight: bold; padding: 10px 16px; border-left: 4px solid #6366f1; }
        /* é®ç½©å±¤ï¼šæœªæˆæ¬Šæ™‚é®è”½å…§å®¹ */
        #auth-overlay { position: fixed; inset: 0; background: #111827; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body class="p-4 md:p-8 max-w-5xl mx-auto relative">

    <div id="auth-overlay">
        <h2 class="text-2xl font-bold text-red-500 mb-4">ğŸ”’ æ¬Šé™é©—è­‰ä¸­...</h2>
        <p class="text-gray-400">æ­£åœ¨æª¢æŸ¥ç®¡ç†å“¡èº«åˆ†</p>
    </div>

    <header class="mb-6 flex justify-between items-center border-b border-gray-700 pb-4">
        <div>
            <h1 class="text-2xl font-bold text-white">ğŸ¤– ç³»çµ±å…¨åŠŸèƒ½è‡ªå‹•æª¢æ ¸</h1>
            <p class="text-xs text-gray-400 mt-1">æ³¨æ„ï¼šåŸ·è¡ŒåŠŸèƒ½æª¢æ ¸éœ€è¦æ‚¨å…·å‚™ã€Œç®¡ç†è€…ã€æ¬Šé™</p>
        </div>
        <div class="flex gap-4">
            <a href="./admin.html" class="text-indigo-400 hover:text-white flex items-center gap-1">âš™ï¸ å¾Œå°</a>
            <a href="./dashboard.html" class="text-indigo-400 hover:text-white flex items-center gap-1">ğŸ  å‰å°</a>
        </div>
    </header>

    <div class="bg-gray-800 rounded-xl shadow-lg border border-gray-700 overflow-hidden">
        <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-900">
            <span id="global-status" class="font-bold text-yellow-400 text-lg">â³ ç­‰å¾…å•Ÿå‹•...</span>
            <button id="start-btn" onclick="startAllTests()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg transition">
                ğŸš€ é–‹å§‹å…¨æª¢æ¸¬
            </button>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-gray-900 text-gray-400 text-sm uppercase">
                    <tr>
                        <th class="py-3 px-6 w-1/3">æª¢æ ¸é …ç›®</th>
                        <th class="py-3 px-6 w-1/6 text-center">ç‹€æ…‹</th>
                        <th class="py-3 px-6">å›æ‡‰è¨Šæ¯ / è€—æ™‚</th>
                    </tr>
                </thead>
                <tbody id="test-results">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // æ¸¬è©¦ç”¨è®Šæ•¸
        let createdUserId = null;
        let createdChallengeId = null;

        // â˜…â˜…â˜… å®‰å…¨æ€§æª¢æŸ¥ï¼šç¶²é è¼‰å…¥æ™‚ç«‹å³åŸ·è¡Œ â˜…â˜…â˜…
        document.addEventListener('DOMContentLoaded', async () => {
            const overlay = document.getElementById('auth-overlay');
            const overlayTitle = overlay.querySelector('h2');
            const overlayText = overlay.querySelector('p');

            try {
                // 1. æª¢æŸ¥ Session
                const { data: { session } } = await client.auth.getSession();
                if (!session) throw new Error('æœªç™»å…¥');

                // 2. æª¢æŸ¥ Role
                const { data: profile, error } = await client.from('profiles')
                    .select('role')
                    .eq('id', session.user.id)
                    .single();
                
                if (error || profile?.role !== 'ç®¡ç†è€…') throw new Error('æ¬Šé™ä¸è¶³');

                // 3. é€šéé©—è­‰ï¼Œç§»é™¤é®ç½©
                overlay.style.display = 'none';

            } catch (err) {
                // é©—è­‰å¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤ä¸¦æä¾›è¿”å›æŒ‰éˆ•
                overlayTitle.textContent = 'â›” å­˜å–è¢«æ‹’';
                overlayText.innerHTML = `
                    <div class="text-center">
                        <p class="mb-4 text-red-300">æ­¤é é¢åƒ…é™ç®¡ç†å“¡å­˜å–ã€‚<br>åŸå› ï¼š${err.message}</p>
                        <a href="./admin.html" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded">è¿”å›ç™»å…¥é </a>
                    </div>
                `;
            }
        });

        // å®šç¾©æ¸¬è©¦ç¾¤çµ„
        const testGroups = {
            system: {
                title: "ğŸ–¥ï¸ ç³»çµ±åŸºç¤é€£ç·š (System)",
                tests: [
                    { name: 'Supabase é€£ç·š (Ping)', func: testPing },
                    { name: 'æ¬Šé™é©—è­‰ (Admin Auth)', func: testAdminAuth },
                    { name: 'Edge Function (Health)', func: testEdgeFunction },
                    { name: 'Storage å­˜å– (Images)', func: testStorage }
                ]
            },
            challenges: {
                title: "ğŸ„ æŒ‘æˆ°åŠŸèƒ½æª¢æ ¸ (Challenge CRUD)",
                tests: [
                    { name: 'è®€å–æŒ‘æˆ°åˆ—è¡¨ (Read)', func: testFetchChallenges },
                    { name: 'ç™¼å¸ƒæ¸¬è©¦æŒ‘æˆ° (Create)', func: testCreateChallenge },
                    { name: 'ç·¨è¼¯æ¸¬è©¦æŒ‘æˆ° (Update)', func: testUpdateChallenge },
                    { name: 'åˆªé™¤æ¸¬è©¦æŒ‘æˆ° (Delete)', func: testDeleteChallenge }
                ]
            },
            users: {
                title: "ğŸ‘¥ ä½¿ç”¨è€…ç®¡ç†æª¢æ ¸ (User Management)",
                tests: [
                    { name: 'è®€å–ä½¿ç”¨è€…åˆ—è¡¨ (List)', func: testListUsers },
                    { name: 'æ–°å¢æ¸¬è©¦ä½¿ç”¨è€… (Create)', func: testCreateUser },
                    { name: 'è®Šæ›´ä½¿ç”¨è€…è§’è‰² (Role)', func: testUpdateRole },
                    { name: 'é‡è¨­ä½¿ç”¨è€…å¯†ç¢¼ (Reset PW)', func: testResetPassword },
                    { name: 'åˆªé™¤æ¸¬è©¦ä½¿ç”¨è€… (Delete)', func: testDeleteUser }
                ]
            }
        };

        async function startAllTests() {
            const btn = document.getElementById('start-btn');
            const tbody = document.getElementById('test-results');
            const statusLabel = document.getElementById('global-status');
            
            btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed');
            tbody.innerHTML = '';
            statusLabel.textContent = 'ğŸ”„ æª¢æ¸¬é€²è¡Œä¸­...';
            statusLabel.className = 'font-bold text-yellow-400 text-lg';

            let globalPass = true;

            for (const [key, group] of Object.entries(testGroups)) {
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = `<td colspan="3" class="category-header">${group.title}</td>`;
                tbody.appendChild(headerRow);

                for (const test of group.tests) {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700 hover:bg-gray-700/30 transition';
                    row.innerHTML = `
                        <td class="py-3 px-6 font-medium text-gray-300 pl-8 border-l-2 border-gray-700">${test.name}</td>
                        <td class="py-3 px-6 text-center"><span class="status-dot bg-yellow-500"></span></td>
                        <td class="py-3 px-6 text-sm text-gray-500 font-mono">Pending...</td>
                    `;
                    tbody.appendChild(row);
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    const start = performance.now();
                    try {
                        const msg = await test.func();
                        const time = (performance.now() - start).toFixed(0);
                        
                        row.querySelector('td:nth-child(1)').classList.add('border-l-2', 'border-green-500');
                        row.querySelector('td:nth-child(2)').innerHTML = `<span class="status-dot bg-green-500" title="æ­£å¸¸"></span>`;
                        row.querySelector('td:nth-child(3)').innerHTML = `<span class="text-green-400 font-bold">OK</span> <span class="text-gray-500 ml-2">(${time}ms)</span> <span class="text-gray-400 text-xs block md:inline md:ml-2">${msg || ''}</span>`;
                    } catch (err) {
                        globalPass = false;
                        const errMsg = err.message || err;
                        row.querySelector('td:nth-child(1)').classList.add('border-l-2', 'border-red-500');
                        row.querySelector('td:nth-child(2)').innerHTML = `<span class="status-dot bg-red-500" title="ç•°å¸¸"></span>`;
                        row.querySelector('td:nth-child(3)').innerHTML = `<span class="text-red-400 font-bold">FAIL</span> <span class="text-red-300 ml-2 text-xs break-all">${errMsg}</span>`;
                    }
                    await new Promise(r => setTimeout(r, 200));
                }
            }

            statusLabel.textContent = globalPass ? 'âœ… å…¨ç³»çµ±é‹ä½œæ­£å¸¸' : 'âš ï¸ æª¢æ¸¬å®Œæˆï¼Œç™¼ç¾ç•°å¸¸';
            statusLabel.className = globalPass ? 'font-bold text-green-400 text-lg' : 'font-bold text-red-400 text-lg';
            btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        // ==========================================
        // æ¸¬è©¦é‚è¼¯å¯¦ä½œ
        // ==========================================

        async function testPing() {
            const { error } = await client.from('wish_stats').select('count', { count: 'exact', head: true });
            if (error) throw error;
            return 'Database Connected';
        }

        async function testAdminAuth() {
            const { data: { session }, error } = await client.auth.getSession();
            if (error || !session) throw new Error('æœªç™»å…¥');
            return `å·²é©—è­‰: ${session.user.email}`;
        }

        async function testEdgeFunction() {
            const { data, error } = await client.functions.invoke('admin-actions', { body: { action: 'ping' } });
            if (error) throw error;
            return 'Function Alive';
        }

        async function testStorage() {
            const { data } = client.storage.from('challenge-images').getPublicUrl('test.jpg');
            if (!data.publicUrl) throw new Error('Public URL ç”Ÿæˆå¤±æ•—');
            return 'Bucket Configured';
        }

        async function testFetchChallenges() {
            const { data, error } = await client.from('challenges').select('id').limit(5);
            if (error) throw error;
            return `è®€å– ${data.length} ç­†`;
        }

        async function testCreateChallenge() {
            const { data: { session } } = await client.auth.getSession();
            const now = new Date();
            const { data, error } = await client.from('challenges').insert({
                host_id: session.user.id,
                mushroom_type: 'æ¸¬è©¦',
                slots: 1,
                start_time: now.toISOString(),
                details: 'è‡ªå‹•åŒ–æ¸¬è©¦(AutoTest)',
                status: 'å·²é¡æ»¿',
                cooking_style: 'éš¨ä¾¿äº‚ç‚’ï¼ˆä¸é™æˆ°åŠ›ï¼‰'
            }).select().single();

            if (error) throw error;
            createdChallengeId = data.id;
            return `ID: ${data.id} Created`;
        }

        async function testUpdateChallenge() {
            if (!createdChallengeId) throw new Error('ç„¡æ¸¬è©¦æŒ‘æˆ° ID');
            const { error } = await client.from('challenges').update({ details: 'å·²ç·¨è¼¯(AutoTest)' }).eq('id', createdChallengeId);
            if (error) throw error;
            return 'Updated Success';
        }

        async function testDeleteChallenge() {
            if (!createdChallengeId) throw new Error('ç„¡æ¸¬è©¦æŒ‘æˆ° ID');
            const { data, error } = await client.functions.invoke('admin-actions', {
                body: { action: 'delete-challenge', payload: { challengeId: createdChallengeId } }
            });
            if (error) throw error;
            if (data?.error) throw new Error(data.error);
            createdChallengeId = null;
            return 'Deleted via Edge Function';
        }

        async function testListUsers() {
            const { data, error } = await client.functions.invoke('admin-actions', {
                body: { action: 'list-users-with-details', payload: {} }
            });
            if (error) throw error;
            return `è®€å– ${data.users?.length || 0} ä½ä½¿ç”¨è€…`;
        }

        async function testCreateUser() {
            const timestamp = Date.now();
            const testNickname = `AT_${timestamp}`;
            const { data, error } = await client.functions.invoke('admin-actions', {
                body: { 
                    action: 'create-user', 
                    payload: { nickname: testNickname, password: 'password123', role: 'å ±åè€…' } 
                }
            });

            if (error) throw error;
            if (data?.error) throw new Error(data.error);
            
            // â˜… ä¿®æ”¹é‡é»ï¼šç›¸å®¹å…©ç¨®å›å‚³çµæ§‹ (data.user.id æˆ– data.user.user.id)
            if (data.user && data.user.id) {
                createdUserId = data.user.id;
            } else if (data.user && data.user.user && data.user.user.id) {
                createdUserId = data.user.user.id;
            } else {
                console.log('Create User Response:', data); // æ–¹ä¾¿é™¤éŒ¯
                throw new Error('æœªå›å‚³ User ID (è«‹æŸ¥çœ‹ Console)');
            }

            return `User Created: ${testNickname}`;
        }

        async function testUpdateRole() {
            if (!createdUserId) throw new Error('ç„¡æ¸¬è©¦ User ID');
            const { data, error } = await client.functions.invoke('admin-actions', {
                body: { action: 'update-user-role', payload: { userId: createdUserId, role: 'ç™¼è‡è€…' } }
            });
            if (error) throw error;
            return 'Role Updated';
        }

        async function testResetPassword() {
            if (!createdUserId) throw new Error('ç„¡æ¸¬è©¦ User ID');
            const { data, error } = await client.functions.invoke('admin-actions', {
                body: { action: 'reset-user-password', payload: { userId: createdUserId, password: 'newpassword456' } }
            });
            if (error) throw error;
            return 'Password Reset OK';
        }

        async function testDeleteUser() {
            if (!createdUserId) throw new Error('ç„¡æ¸¬è©¦ User ID');
            const { data, error } = await client.functions.invoke('admin-actions', {
                body: { action: 'delete-user', payload: { userId: createdUserId } }
            });
            if (error) throw error;
            createdUserId = null;
            return 'User Deleted';
        }
    </script>
</body>
</html>