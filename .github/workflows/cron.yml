name: Mushroom Check Cron

on:
  schedule:
    # 設定排程時間 (UTC 時間)
    # 說明：
    # 分鐘 '0,30'：代表每小時的 00分 和 30分 執行
    # 小時 '0-15'：代表 UTC 0點到15點 (即台灣 08:00 到 23:00)
    # 組合起來就是：從台灣 08:00 開始，最後一次執行是 23:30
    - cron: '0,30 0-15 * * *'

  # 維持手動測試按鈕
  workflow_dispatch:

jobs:
  trigger-supabase:
    runs-on: ubuntu-latest
    steps:
      - name: Call Supabase Edge Function
        run: |
          curl -X POST 'https://htdddmoclmhqebyvzean.supabase.co/functions/v1/admin-actions' \
          -H "Authorization: Bearer ${{ secrets.SECRET_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"action": "scheduled-email-notify"}'

  # ▼▼▼ 新增：觸發逾時清理 ▼▼▼
      - name: Cleanup Expired Challenges
        run: |
          curl -X POST 'https://htdddmoclmhqebyvzean.supabase.co/functions/v1/admin-actions' \
          -H "Authorization: Bearer ${{ secrets.SECRET_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"action": "cleanup-expired"}'