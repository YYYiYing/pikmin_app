<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾ç‰‡è—å»Š - è‡è‡å®…é…ç¶²</title>
    <link rel="icon" href="./mashroom_s.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #111827; color: #d1d5db; }
        .dark-input { background-color: #374151; border-color: #4b5563; color: #d1d5db; }
        .dark-input:focus { border-color: #8b5cf6; --tw-ring-color: #8b5cf6; outline: none; ring: 2px; } 
        .card-bg { background-color: #1f2937; border: 1px solid #374151; transition: all 0.3s; }
        .card-bg:hover { border-color: #8b5cf6; transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }
        
        /* ä»¿é›·é”ç«™çš„æ¨™ç±¤æ¨£å¼ */
        .category-tab {
            transition: all 0.2s;
            white-space: nowrap;
            cursor: pointer;
            padding: 4px 12px;
            border-radius: 9999px; /* è—¥ä¸¸ç‹€ */
            background-color: #374151;
            color: #d1d5db;
            font-size: 0.9rem;
            border: 1px solid #4b5563;
        }
        .category-tab:hover {
            background-color: #4b5563;
            color: white;
        }
        .category-tab.active {
            background-color: #8b5cf6; /* ç´«è‰² */
            color: white;
            font-weight: bold;
            border-color: #8b5cf6;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.4);
        }
        
        .like-btn { cursor: pointer; transition: transform 0.2s; user-select: none; }
        .like-btn:active { transform: scale(1.2); }
        .like-btn.liked { color: #f43f5e; } 
        
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.8); }
        .custom-dropdown-container { position: relative; width: 100%; }
        .dropdown-options { position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background-color: #374151; border: 1px solid #4b5563; border-radius: 0.5rem; max-height: 200px; overflow-y: auto; z-index: 60; display: none; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        .dropdown-options.show { display: block; }
        .dropdown-option { padding: 10px 12px; color: #d1d5db; cursor: pointer; border-bottom: 1px solid #4b5563; text-align: left; font-size: 0.875rem; }
        .dropdown-option:hover { background-color: #8b5cf6; color: white; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen pb-20">
    
    <div class="max-w-7xl mx-auto">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4 border-b border-gray-700 pb-6">
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 flex items-center gap-2 cursor-pointer" onclick="window.location.reload()">
                <span>ğŸ¨</span> ç¾ç‰‡è—å»Š
            </h1>
            <div class="flex items-center gap-4">
                <button id="add-postcard-btn" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition flex items-center gap-2 transform hover:scale-105">
                    <span>â•</span> åˆ†äº«ç¾ç‰‡
                </button>
                <a href="javascript:history.back()" class="text-gray-400 hover:text-white transition cursor-pointer">â† è¿”å›å¤§å»³</a>
            </div>
            <div id="user-display" class="w-full md:w-auto text-center md:text-right text-xs text-gray-500 font-mono"></div>
        </header>

        <div class="mb-6 space-y-4">
            <div>
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-gray-400 text-sm">ğŸ·ï¸ ç†±é–€æ¨™ç±¤ï¼š</span>
                </div>
                <div id="filter-container" class="flex flex-wrap gap-2 items-center">
                    <button class="category-tab active" data-tag="all">å…¨éƒ¨é¡¯ç¤º</button>
                    </div>
            </div>

            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 grid grid-cols-3 gap-2 text-sm">
                <div>
                    <label class="text-xs text-gray-500 block mb-1">åœ‹å®¶</label>
                    <select id="filter-country" class="dark-input w-full p-2 rounded text-xs"><option value="all">å…¨éƒ¨</option></select>
                </div>
                <div>
                    <label class="text-xs text-gray-500 block mb-1">åœ°å€</label>
                    <select id="filter-region" class="dark-input w-full p-2 rounded text-xs"><option value="all">å…¨éƒ¨</option></select>
                </div>
                <div>
                    <label class="text-xs text-gray-500 block mb-1">ç´°é …</label>
                    <select id="filter-area" class="dark-input w-full p-2 rounded text-xs"><option value="all">å…¨éƒ¨</option></select>
                </div>
            </div>
        </div>

        <div id="postcard-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <p class="col-span-full text-center py-12 text-gray-500 animate-pulse">æ­£åœ¨è¼‰å…¥è—å»Š...</p>
        </div>
    </div>

    <div id="postcard-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-gray-800 border border-gray-600 w-full max-w-lg rounded-2xl shadow-2xl p-6 relative max-h-[90vh] overflow-y-auto">
            <button id="close-modal-x" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">&times;</button>
            <h2 id="modal-title" class="text-2xl font-bold text-white mb-6">åˆ†äº«ç¾ç‰‡</h2>
            
            <form id="postcard-form" class="space-y-4">
                <input type="hidden" id="edit-id">
                
                <div id="image-upload-section">
                    <label class="block text-sm font-medium text-gray-400 mb-1">ä¸Šå‚³åœ–ç‰‡</label>
                    <input type="file" id="image-upload" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-600 file:text-white hover:file:bg-violet-700 transition cursor-pointer"/>
                </div>

                <div id="preview-section" class="hidden text-center">
                    <p class="text-sm text-gray-400 mb-1 text-left">åœ–ç‰‡é è¦½</p>
                    <img id="preview-image" src="" class="rounded-lg max-h-48 mx-auto object-contain border border-gray-600 shadow-md">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">åº§æ¨™</label>
                    <div class="relative">
                        <input type="text" id="coordinate-input" required placeholder="ä¾‹å¦‚: 22.6123, 120.3456 (æ”¯æ´ Google Maps ç¶²å€)" class="dark-input w-full rounded-lg shadow-sm pl-3 pr-16 py-2.5">
                        <button type="button" id="paste-coord-btn" class="absolute right-2 top-2 bg-gray-700 hover:bg-gray-600 text-green-400 px-2 py-1.5 rounded transition font-bold text-xs">ğŸ“‹ è²¼ä¸Š</button>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-1">æ”¯æ´è²¼ä¸Š Google Maps ç¶²å€è‡ªå‹•è½‰æ›</p>
                </div>

                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">åœ‹å®¶</label>
                        <div class="custom-dropdown-container">
                            <input type="text" id="input-country" class="dark-input w-full rounded-lg px-2 py-2 text-sm" placeholder="è¼¸å…¥æˆ–é¸æ“‡">
                            <div id="dropdown-country" class="dropdown-options"></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">åœ°å€</label>
                        <div class="custom-dropdown-container">
                            <input type="text" id="input-region" class="dark-input w-full rounded-lg px-2 py-2 text-sm" placeholder="è¼¸å…¥æˆ–é¸æ“‡">
                            <div id="dropdown-region" class="dropdown-options"></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">ç´°é …</label>
                        <div class="custom-dropdown-container">
                            <input type="text" id="input-area" class="dark-input w-full rounded-lg px-2 py-2 text-sm" placeholder="è¼¸å…¥æˆ–é¸æ“‡">
                            <div id="dropdown-area" class="dropdown-options"></div>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">æ¨™ç±¤ (æœ€å¤š3å€‹)</label>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="custom-dropdown-container"><input type="text" id="tag-1" placeholder="Tag1" class="dark-input w-full rounded-lg px-2 py-2 text-center text-sm"><div id="dropdown-1" class="dropdown-options"></div></div>
                        <div class="custom-dropdown-container"><input type="text" id="tag-2" placeholder="Tag2" class="dark-input w-full rounded-lg px-2 py-2 text-center text-sm"><div id="dropdown-2" class="dropdown-options"></div></div>
                        <div class="custom-dropdown-container"><input type="text" id="tag-3" placeholder="Tag3" class="dark-input w-full rounded-lg px-2 py-2 text-center text-sm"><div id="dropdown-3" class="dropdown-options"></div></div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-700">
                    <button type="button" id="close-modal-btn" class="px-5 py-2.5 bg-gray-600 text-gray-200 rounded-lg hover:bg-gray-500 font-bold transition">å–æ¶ˆ</button>
                    <button type="submit" id="submit-btn" class="px-5 py-2.5 bg-violet-600 text-white rounded-lg hover:bg-violet-700 font-bold transition shadow-lg">ç™¼å¸ƒ</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-message" class="hidden fixed top-5 right-5 text-white py-3 px-6 rounded-xl shadow-2xl z-[70] font-bold flex items-center gap-2 transform transition-all duration-300"></div>
    <div id="image-viewer-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm transition-opacity duration-300" onclick="closeImageViewer()">
        <div class="relative max-w-5xl w-full max-h-[95vh] flex justify-center items-center p-2" onclick="event.stopPropagation()">
            <button type="button" onclick="closeImageViewer()" class="absolute -top-12 right-0 md:top-4 md:right-4 text-white text-4xl hover:text-gray-300 font-bold bg-black/50 rounded-full w-12 h-12 flex items-center justify-center">&times;</button>
            <img id="viewer-image" src="" class="rounded-lg shadow-2xl max-h-[85vh] md:max-h-[90vh] w-auto object-contain bg-gray-900 border border-gray-800">
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co';
        const PUBLIC_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, PUBLIC_KEY);

        // State
        let allCards = [];
        let activeTag = 'all';
        let uniqueCountries = new Set(), uniqueRegions = new Set(), uniqueAreas = new Set();
        let guestNick = localStorage.getItem('guest_nick');
        let guestCode = localStorage.getItem('guest_code');
        let myIpFingerprint = null; 
        let isAdmin = false; //ç®¡ç†å“¡ç‹€æ…‹
        let currentUser = null; // ç”¨ä¾†å­˜å„²å·²ç™»å…¥çš„æœƒå“¡è³‡è¨Š

        // å„ªåŒ–ç®¡ç†å“¡æª¢æŸ¥èˆ‡æœƒå“¡ç™»å…¥ç‹€æ…‹
        async function checkAdmin() {
            try {
                // 1. æª¢æŸ¥ Supabase Auth (æœƒå“¡ç™»å…¥)
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                const userDisplay = document.getElementById('user-display');
                
                if (session) {
                    // --- å·²ç™»å…¥æœƒå“¡ ---
                    currentUser = session.user;
                    
                    // æŸ¥è©¢ Profile å–å¾—æš±ç¨±èˆ‡è§’è‰²
                    const { data: profile } = await supabaseClient
                        .from('profiles')
                        .select('nickname, role')
                        .eq('id', session.user.id)
                        .single();
                    
                    // è¨­å®šé¡¯ç¤ºåç¨± (å„ªå…ˆä½¿ç”¨æœƒå“¡æš±ç¨±)
                    const displayName = profile?.nickname || 'æœƒå“¡';
                    
                    // åˆ¤æ–·æ˜¯å¦ç‚ºç®¡ç†å“¡
                    if (profile?.role === 'ç®¡ç†è€…') {
                        isAdmin = true;
                        // é¡¯ç¤ºï¼š[ç®¡ç†å“¡æ¨¡å¼] æš±ç¨±
                        userDisplay.innerHTML = `<span class="text-orange-400 font-bold border border-orange-500/50 px-2 py-0.5 rounded mr-2 text-xs">ç®¡ç†å“¡æ¨¡å¼</span><span class="text-gray-300">${displayName}</span>`;
                    } else {
                        // é¡¯ç¤ºï¼š[æœƒå“¡] æš±ç¨±
                        userDisplay.innerHTML = `<span class="text-indigo-400 font-bold border border-indigo-500/50 px-2 py-0.5 rounded mr-2 text-xs">æœƒå“¡</span><span class="text-gray-300">${displayName}</span>`;
                    }
                    
                } else {
                    // --- æœªç™»å…¥ (ä½¿ç”¨è¨ªå®¢è³‡è¨Š) ---
                    // åƒ…é¡¯ç¤ºæš±ç¨±ï¼Œä¸é¡¯ç¤ºå¥½å‹ç¢¼
                    const displayNick = guestNick || 'æœªç™»å…¥è¨ªå®¢';
                    
                    // å¦‚æœæœ‰è¨ªå®¢æš±ç¨±ï¼Œé¡¯ç¤º [è¨ªå®¢] æš±ç¨±
                    if (guestNick) {
                        userDisplay.innerHTML = `<span class="text-gray-500 font-bold border border-gray-600/50 px-2 py-0.5 rounded mr-2 text-xs">è¨ªå®¢</span><span class="text-gray-400">${displayNick}</span>`;
                    } else {
                        userDisplay.textContent = 'æœªç™»å…¥';
                    }
                }
            } catch (e) { 
                console.error('Auth check failed', e); 
            }
        }

        // ç§»æ¤è‡ª radar.html çš„åº§æ¨™æ ¼å¼åŒ–å‡½å¼
        function formatCoordinateString(val) {
            if (!val) return "";
            let str = val.trim();

            // 1. å˜—è©¦è§£æ Google Maps ç¶²å€ (æœ€å„ªå…ˆ)
            let match = str.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
            if (match) return `${parseFloat(match[1]).toFixed(7)}, ${parseFloat(match[2]).toFixed(7)}`;
            
            match = str.match(/q=(-?\d+\.\d+),(-?\d+\.\d+)/);
            if (match) return `${parseFloat(match[1]).toFixed(7)}, ${parseFloat(match[2]).toFixed(7)}`;
            
            match = str.match(/!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/);
            if (match) return `${parseFloat(match[1]).toFixed(7)}, ${parseFloat(match[2]).toFixed(7)}`;

            // 2. å˜—è©¦è§£ææ¨™æº–åº§æ¨™
            // å…ˆæŠŠå…¨å½¢é€—è™Ÿè½‰åŠå½¢
            let tempStr = str.replace(/ï¼Œ/g, ',');
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºåº¦åˆ†ç§’ (DMS)
            const isDMS = tempStr.includes('Â°') && (tempStr.includes("'") || tempStr.includes('"') || tempStr.includes('â€™'));
            
            let lat = 0, lng = 0;
            let success = false;

            if (isDMS) {
                // === è™•ç†åº¦åˆ†ç§’ ===
                const numbers = tempStr.match(/(\d+(\.\d+)?)/g);
                const directions = tempStr.match(/[NSEWåŒ—å—æ±è¥¿]/gi) || [];
                
                if (numbers && numbers.length >= 6) {
                    const d1 = parseFloat(numbers[0]), m1 = parseFloat(numbers[1]), s1 = parseFloat(numbers[2]);
                    const d2 = parseFloat(numbers[3]), m2 = parseFloat(numbers[4]), s2 = parseFloat(numbers[5]);

                    lat = d1 + (m1 / 60) + (s1 / 3600);
                    lng = d2 + (m2 / 60) + (s2 / 3600);

                    const dirStr = directions.join('');
                    if (/[Så—]/.test(dirStr)) lat = -lat; 
                    if (/[Wè¥¿]/.test(dirStr)) lng = -lng;

                    success = true;
                }
            } else {
                // === è™•ç†ä¸€èˆ¬å°æ•¸æ ¼å¼ ===
                const numbers = tempStr.match(/(-?\d+\.\d+)/g);
                
                if (numbers && numbers.length >= 2) {
                    lat = parseFloat(numbers[0]);
                    lng = parseFloat(numbers[1]);
                    
                    // ç¯„åœæª¢æŸ¥ (-90~90, -180~180) é¿å…æŠŠæ—¥æœŸèª¤åˆ¤ç‚ºåº§æ¨™
                    if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                        if (/[Så—]/.test(tempStr) && lat > 0) lat = -lat;
                        if (/[Wè¥¿]/.test(tempStr) && lng > 0) lng = -lng;
                        success = true;
                    }
                }
            }

            if (success) {
                return `${lat.toFixed(7)}, ${lng.toFixed(7)}`;
            } else {
                return val; 
            }
        }

        // â˜… å·¥å…·å‡½å¼ï¼šè‡ªå‹•åæŸ¥åœ°ç†ä½ç½® (å‘¼å«å¾Œç«¯)
        async function autoFillLocation(lat, lng) {
            const countryInput = document.getElementById('input-country');
            const regionInput = document.getElementById('input-region');
            const areaInput = document.getElementById('input-area');

            // 1. é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
            const originalPlaceholders = {
                country: countryInput.placeholder,
                region: regionInput.placeholder,
                area: areaInput.placeholder
            };
            
            // æ¸…ç©ºèˆŠå€¼ä¸¦é¡¯ç¤ºæœå°‹ä¸­
            countryInput.value = ''; countryInput.placeholder = 'ğŸ”...';
            regionInput.value = ''; regionInput.placeholder = 'ğŸ”...';
            areaInput.value = ''; areaInput.placeholder = 'ğŸ”...';

            try {
                // 2. å‘¼å«å¾Œç«¯ API
                const { data: resData, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ 
                        action: 'reverse-geocode', 
                        payload: { lat, lng } 
                    })
                });

                if (error) throw error;
                if (!resData.success) throw new Error(resData.message);

                const data = resData.data;

                // 3. å¡«å…¥è³‡æ–™
                if (data && data.address) {
                    const addr = data.address;

                    // åœ‹å®¶
                    if (addr.country) countryInput.value = addr.country;

                    // åœ°å€ (è‡ªå‹•ä¿®æ­£ "è‡º" ç‚º "å°" ä»¥çµ±ä¸€æ ¼å¼)
                    const region = addr.city || addr.county || '';
                    if (region) regionInput.value = region.replace(/è‡º/g, 'å°');

                    // ç´°é … (å€/é„‰/é®)
                    const area = addr.suburb || addr.district || addr.town || '';
                    if (area) areaInput.value = area;
                    
                    // 4. è¦–è¦ºå›é¥‹ (é–ƒçˆç¶ æ¡†ä»£è¡¨æˆåŠŸ)
                    [countryInput, regionInput, areaInput].forEach(el => {
                        if(el.value) {
                            el.classList.add('ring-2', 'ring-green-500', 'border-green-500');
                            setTimeout(() => el.classList.remove('ring-2', 'ring-green-500', 'border-green-500'), 1500);
                        }
                    });
                }
            } catch (e) {
                console.error('è‡ªå‹•å¡«å¯«ä½ç½®å¤±æ•—:', e);
                // å¤±æ•—æ™‚æ¢å¾©åŸæœ¬çš„ placeholder
                countryInput.placeholder = originalPlaceholders.country;
                regionInput.placeholder = originalPlaceholders.region;
                areaInput.placeholder = originalPlaceholders.area;
            }
        }

        // Helper: Compress Image
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                new Compressor(file, {
                    quality: 0.6, maxWidth: 1600, maxHeight: 1600, mimeType: 'image/jpeg',
                    success(result) { resolve(new File([result], file.name, { type: 'image/jpeg' })); },
                    error(err) { reject(err); },
                });
            });
        }

        //  Init å‡½å¼
        async function init() {
            // å„ªå…ˆåŸ·è¡Œèº«åˆ†æª¢æŸ¥ (å› ç‚ºé€™æœƒæ±ºå®š user-display çš„å…§å®¹)
            await checkAdmin();

            // æª¢æŸ¥è¨ªå®¢è³‡æ–™ (å¦‚æœæœªç™»å…¥æœƒå“¡ï¼Œä¸”ç„¡è¨ªå®¢è³‡æ–™ï¼Œæ‰æç¤º)
            if (!currentUser && (!guestNick || !guestCode)) {
                if(confirm('æ‚¨å°šæœªè¨­å®šè¨ªå®¢èº«åˆ†ï¼Œå»ºè­°å‰å¾€å¤§å»³è¨­å®šä»¥ä½¿ç”¨å®Œæ•´åŠŸèƒ½ã€‚')) {
                    window.location.href = './guest.html';
                    return;
                } else {
                    // æœªè¨­å®šèº«åˆ†ï¼Œç¦ç”¨ç™¼å¸ƒæŒ‰éˆ•
                    const btn = document.getElementById('add-postcard-btn');
                    if(btn) btn.disabled = true;
                }
            }
            
            await loadCards();
            initDropdowns();
        }

        async function loadCards() {
            try {
                const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ action: 'list-guest-postcards' })
                });
                if (error) throw error;
                
                allCards = data.data;
                myIpFingerprint = data.ip_fingerprint; 

                updateFilters();
                renderGrid();
            } catch (e) {
                console.error(e);
                document.getElementById('postcard-grid').innerHTML = '<p class="col-span-full text-center text-red-400">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        function updateFilters() {
            // 1. çµ±è¨ˆæ¨™ç±¤ (æ’é™¤çµ•ç‰ˆå“ï¼Œé¿å…å¹²æ“¾ç†±é–€æ’è¡Œ)
            const tagCounts = {};
            allCards.forEach(c => {
                if (!c.is_obsolete && c.tags) {
                    c.tags.forEach(t => tagCounts[t] = (tagCounts[t]||0)+1);
                }
            });
            // ä¾ç…§æ•¸é‡æ’åº
            const sortedTags = Object.keys(tagCounts).sort((a,b) => tagCounts[b] - tagCounts[a]);
            
            const tagContainer = document.getElementById('filter-container');
            tagContainer.innerHTML = ''; // æ¸…ç©ºå®¹å™¨

            // 2. å»ºç«‹ã€Œå…¨éƒ¨é¡¯ç¤ºã€æŒ‰éˆ•
            const allBtn = document.createElement('button');
            allBtn.className = `category-tab ${activeTag==='all'?'active':''}`;
            allBtn.textContent = 'å…¨éƒ¨é¡¯ç¤º';
            allBtn.dataset.tag = 'all'; // åŠ å…¥ data å±¬æ€§
            allBtn.onclick = () => setTag('all');
            tagContainer.appendChild(allBtn);

            // 3. å»ºç«‹ã€Œçµ•ç‰ˆå€ã€æŒ‰éˆ•
            const obsoleteBtn = document.createElement('button');
            const isObsoleteActive = activeTag === 'obsolete';
            obsoleteBtn.className = `category-tab ${isObsoleteActive ? 'bg-red-600 text-white border-red-600' : 'text-red-400 border-red-900/50 hover:bg-red-900/30'}`;
            obsoleteBtn.innerHTML = `ğŸš« çµ•ç‰ˆå€`;
            obsoleteBtn.dataset.tag = 'obsolete'; // åŠ å…¥ data å±¬æ€§
            obsoleteBtn.onclick = () => setTag('obsolete');
            tagContainer.appendChild(obsoleteBtn);

            // 4. è¨­å®šé¡¯ç¤ºæ•¸é‡é™åˆ¶ (çµ±ä¸€ç‚º 6 å€‹ï¼Œèˆ‡ç¾ç‰‡åœ–æ›¸é¤¨ä¸€è‡´)
            const DISPLAY_LIMIT = 6;
            const tagsToShow = sortedTags.slice(0, DISPLAY_LIMIT);
            const hiddenTags = sortedTags.slice(DISPLAY_LIMIT);

            // 5. æ¸²æŸ“å‰ 6 å€‹æ¨™ç±¤
            tagsToShow.forEach(tag => createTagButton(tag, tagCounts[tag], tagContainer));

            // 6. å¦‚æœæœ‰æ›´å¤šæ¨™ç±¤ï¼Œå»ºç«‹ã€Œæ”¶ç´å€ã€èˆ‡ã€Œæ›´å¤šæŒ‰éˆ•ã€
            if (hiddenTags.length > 0) {
                const hiddenContainer = document.createElement('span');
                hiddenContainer.className = 'hidden flex flex-wrap gap-2 items-center';
                hiddenContainer.id = 'more-tags-container';
                
                // æ¸²æŸ“å…¶é¤˜æ¨™ç±¤
                hiddenTags.forEach(tag => createTagButton(tag, tagCounts[tag], hiddenContainer));
                tagContainer.appendChild(hiddenContainer);

                // å»ºç«‹åˆ‡æ›æŒ‰éˆ•
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'text-xs text-violet-400 hover:text-violet-300 underline ml-1 font-bold';
                toggleBtn.textContent = `â–¼ æ›´å¤š (${hiddenTags.length})`;
                
                toggleBtn.onclick = () => {
                    const isHidden = hiddenContainer.classList.contains('hidden');
                    if (isHidden) {
                        hiddenContainer.classList.remove('hidden');
                        toggleBtn.textContent = 'â–² æ”¶èµ·';
                    } else {
                        hiddenContainer.classList.add('hidden');
                        toggleBtn.textContent = `â–¼ æ›´å¤š (${hiddenTags.length})`;
                    }
                };
                tagContainer.appendChild(toggleBtn);
            }

            // Regions ä¸‹æ‹‰é¸å–®é‚è¼¯ç¶­æŒä¸è®Š
            uniqueCountries = new Set(); uniqueRegions = new Set(); uniqueAreas = new Set();
            allCards.forEach(c => {
                if (!c.is_obsolete) {
                    if(c.country) uniqueCountries.add(c.country);
                    if(c.region) uniqueRegions.add(c.region);
                    if(c.area) uniqueAreas.add(c.area);
                }
            });
            fillSelect('filter-country', uniqueCountries, 'å…¨éƒ¨åœ‹å®¶');
            fillSelect('filter-region', uniqueRegions, 'å…¨éƒ¨åœ°å€');
            fillSelect('filter-area', uniqueAreas, 'å…¨éƒ¨ç´°é …');
            updateInputDropdowns();
        }

        // è¼”åŠ©å‡½å¼ï¼šå»ºç«‹æ¨™ç±¤æŒ‰éˆ•
        function createTagButton(tag, count, parent) {
            const btn = document.createElement('button');
            const isActive = activeTag === tag;
            btn.className = `category-tab ${isActive?'active':''}`;
            btn.innerHTML = `#${tag} <span class="text-[10px] opacity-70">(${count})</span>`;
            btn.dataset.tag = tag; // åŠ å…¥è­˜åˆ¥å±¬æ€§
            btn.onclick = () => setTag(tag);
            parent.appendChild(btn);
        }

        function fillSelect(id, set, defaultTxt) {
            const el = document.getElementById(id);
            const oldVal = el.value;
            el.innerHTML = `<option value="all">${defaultTxt}</option>`;
            Array.from(set).sort().forEach(v => el.add(new Option(v, v)));
            if(set.has(oldVal)) el.value = oldVal;
            el.onchange = renderGrid;
        }

        window.setTag = (tag) => {
            activeTag = tag;
            
            // â˜… ä¿®æ”¹ï¼šåªæ›´æ–°æŒ‰éˆ•æ¨£å¼ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´å€‹åˆ—è¡¨ (é¿å…ã€Œæ›´å¤šã€é¸å–®è·³å›é—œé–‰ç‹€æ…‹)
            document.querySelectorAll('.category-tab').forEach(btn => {
                if (btn.dataset.tag === tag) {
                    btn.classList.add('active');
                    // ç‰¹æ®Šè™•ç†çµ•ç‰ˆå€æŒ‰éˆ•æ¨£å¼
                    if (tag === 'obsolete') {
                        btn.className = 'category-tab active bg-red-600 text-white border-red-600';
                    }
                } else {
                    btn.classList.remove('active');
                    // é‚„åŸçµ•ç‰ˆå€æŒ‰éˆ•æ¨£å¼
                    if (btn.dataset.tag === 'obsolete') {
                        btn.className = 'category-tab text-red-400 border-red-900/50 hover:bg-red-900/30';
                    }
                }
            });

            renderGrid();
        };

        function renderGrid() {
            const grid = document.getElementById('postcard-grid');
            const cVal = document.getElementById('filter-country').value;
            const rVal = document.getElementById('filter-region').value;
            const aVal = document.getElementById('filter-area').value;

            // 1. ç¯©é¸é‚è¼¯
            const filtered = allCards.filter(c => {
                if (activeTag === 'obsolete') return c.is_obsolete === true;
                if (c.is_obsolete === true) return false;
                if (activeTag !== 'all' && (!c.tags || !c.tags.includes(activeTag))) return false;
                if (cVal !== 'all' && c.country !== cVal) return false;
                if (rVal !== 'all' && c.region !== rVal) return false;
                if (aVal !== 'all' && c.area !== aVal) return false;
                return true;
            });

            if (filtered.length === 0) {
                const msg = activeTag === 'obsolete' ? 'ç›®å‰æ²’æœ‰çµ•ç‰ˆçš„ç¾ç‰‡ã€‚' : 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç¾ç‰‡ã€‚';
                grid.innerHTML = `<p class="col-span-full text-center text-gray-500 py-12">${msg}</p>`;
                return;
            }

            grid.innerHTML = filtered.map(c => {
                const displayName = c.nickname || 'åŒ¿å';
                const fullLocation = [c.country, c.region, c.area].filter(Boolean).join(' Â· ');
                const tagsHtml = (c.tags||[]).map(t => `<span class="text-[10px] bg-gray-700 text-gray-300 px-2 py-0.5 rounded-full mr-1 mb-1 inline-block border border-gray-600">#${t}</span>`).join('');
                
                // æ¬Šé™åˆ¤æ–·ï¼šæœ¬äºº OR ç®¡ç†å“¡
                const isOwner = (myIpFingerprint && c.ip_fingerprint === myIpFingerprint) || 
                                (c.friend_code === guestCode && c.nickname === guestNick);
                
                const canEdit = isOwner || isAdmin;   // â˜… ç®¡ç†å“¡ä¹Ÿå¯ä»¥ç·¨è¼¯
                const canDelete = isOwner || isAdmin; // â˜… ç®¡ç†å“¡ä¹Ÿå¯ä»¥åˆªé™¤

                // ç”Ÿæˆæ§åˆ¶æŒ‰éˆ• HTML
                let controlsHtml = '';
                if (canEdit || canDelete) {
                     controlsHtml = `
                    <div class="absolute top-2 right-2 flex gap-1 bg-black/60 backdrop-blur-sm rounded-lg p-1 opacity-0 group-hover:opacity-100 transition duration-200 z-10">
                        ${canEdit ? `<button onclick="editCard(${c.id}, event)" class="text-gray-300 hover:text-white p-1.5 hover:bg-gray-700 rounded" title="ç·¨è¼¯">âœï¸</button>` : ''}
                        ${canDelete ? `<button onclick="deleteCard(${c.id}, event)" class="text-red-400 hover:text-red-300 p-1.5 hover:bg-gray-700 rounded" title="åˆªé™¤">ğŸ—‘ï¸</button>` : ''}
                    </div>`;
                }

                const heartIcon = c.isLiked ? 'â¤ï¸' : 'ğŸ¤';
                const heartClass = c.isLiked ? 'liked' : 'text-gray-500 hover:text-pink-400';

                // çµ•ç‰ˆæ¨£å¼
                const cardContainerClass = c.is_obsolete ? 'border-red-900/80' : '';
                const imgStyleClass = c.is_obsolete ? 'grayscale opacity-60 mix-blend-luminosity' : '';
                const obsoleteBadge = c.is_obsolete ? '<div class="absolute inset-0 flex items-center justify-center pointer-events-none z-20"><span class="bg-red-600/90 text-white px-4 py-1.5 rounded-full text-sm font-bold transform -rotate-12 border-2 border-red-400 shadow-[0_0_15px_rgba(220,38,38,0.5)]">å·²çµ•ç‰ˆ</span></div>' : '';
                
                // æŒ‰éˆ•åœ–ç¤ºèˆ‡æ¨£å¼
                const isObsoleteView = activeTag === 'obsolete';
                const obsBtnTitle = isObsoleteView ? 'æ¢å¾©ä¸Šæ¶' : 'å›å ±çµ•ç‰ˆ';
                
                let obsBtnHtml, obsBtnBaseClass;
                if (isObsoleteView) {
                    obsBtnHtml = `
                        <div class="flex flex-col items-center justify-center leading-none pointer-events-none">
                            <span class="text-xs">âœ…</span>
                            <span class="text-[9px] font-bold mt-1">ä¸Šæ¶</span>
                        </div>
                    `;
                    obsBtnBaseClass = 'h-auto w-auto px-1.5 py-1 text-green-400 hover:text-green-300 bg-green-900/40 border-green-700/50 rounded-lg'; 
                } else {
                    obsBtnHtml = `<span class="text-sm filter drop-shadow-md pointer-events-none">ğŸš«</span>`;
                    obsBtnBaseClass = 'w-7 h-7 rounded-full text-gray-500 hover:text-red-500 bg-gray-800/80';
                }

                return `
                    <div class="card-bg rounded-xl overflow-hidden relative group flex flex-col h-full ${cardContainerClass}">
                        <div class="aspect-video bg-gray-900 cursor-pointer relative overflow-hidden" onclick="openImageViewer('${c.image_url}')">
                            <img src="${c.image_url}" loading="lazy" class="w-full h-full object-cover transform group-hover:scale-110 transition duration-700 ease-in-out ${imgStyleClass}">
                            ${controlsHtml}
                            ${obsoleteBadge}
                            <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/80 to-transparent p-2 z-10">
                                <span class="text-xs text-white font-bold drop-shadow-md">ğŸ“ ${fullLocation.split(' Â· ')[1] || 'æœªçŸ¥å€åŸŸ'}</span>
                            </div>
                        </div>
                        
                        <div class="p-3 flex flex-col flex-grow gap-2 bg-gray-900/50">
                            <div class="flex justify-between items-start">
                                <div class="flex-1 truncate pr-2" title="${displayName}">
                                    <span class="text-xs text-gray-500 font-normal mr-0.5">By</span>
                                    <span class="text-sm font-bold text-gray-200">${displayName}</span>
                                </div>
                                
                                <div class="flex items-center gap-2 flex-shrink-0">
                                    <button onclick="toggleObsolete(${c.id}, '${displayName}')" class="flex items-center justify-center border border-gray-700 ${obsBtnBaseClass} transition active:scale-90 backdrop-blur-sm" title="${obsBtnTitle}">
                                        ${obsBtnHtml}
                                    </button>

                                    <button onclick="toggleLike(${c.id}, this)" class="like-btn flex items-center gap-1 bg-gray-800/80 border border-gray-700 px-2 py-0.5 rounded-full ${heartClass} backdrop-blur-sm">
                                        <span class="icon text-sm">${heartIcon}</span><span class="count text-xs font-bold">${c.likes}</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-gray-800/80 rounded p-1.5 flex justify-between items-center border border-gray-700">
                                <span class="text-xs font-mono text-gray-400 truncate mr-2 select-all">${c.coordinate || 'N/A'}</span>
                                <button onclick="copyText('${c.coordinate}')" class="text-xs text-green-400 hover:text-white font-bold">ğŸ“‹</button>
                            </div>

                            <div class="flex flex-wrap content-end">${tagsHtml}</div>

                            <div class="mt-auto pt-2 border-t border-gray-700/50">
                                <p class="text-xs text-gray-400 flex items-center gap-1">
                                    <span class="text-violet-400">ğŸŒ</span> ${fullLocation || 'ç„¡åœ°å€è³‡è¨Š'}
                                </p>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        // Actions
        const modal = document.getElementById('postcard-modal');
        const form = document.getElementById('postcard-form');

        document.getElementById('add-postcard-btn').onclick = () => {
            form.reset();
            document.getElementById('edit-id').value = '';
            document.getElementById('modal-title').textContent = 'åˆ†äº«ç¾ç‰‡';
            document.getElementById('image-upload-section').classList.remove('hidden');
            document.getElementById('preview-section').classList.add('hidden');
            document.getElementById('submit-btn').textContent = 'ç™¼å¸ƒ';
            modal.classList.remove('hidden');
        };

        document.getElementById('close-modal-x').onclick = () => modal.classList.add('hidden');
        document.getElementById('close-modal-btn').onclick = () => modal.classList.add('hidden');

        form.onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            const originalText = btn.textContent;
            
            // é–å®šæŒ‰éˆ•é¿å…é‡è¤‡æäº¤
            btn.disabled = true; 
            btn.textContent = 'è™•ç†ä¸­...';

            // ç”¨ä¾†è¿½è¹¤å‰›å‰›ä¸Šå‚³çš„æª”æ¡ˆåç¨± (ä»¥ä¾¿å¤±æ•—æ™‚åˆªé™¤)
            let uploadedFileName = null;

            try {
                const id = document.getElementById('edit-id').value;
                const fileInput = document.getElementById('image-upload');
                let imageUrl = null;
                
                // --- ç›£è½åº§æ¨™è¼¸å…¥æ¡† (æ ¼å¼åŒ– + è‡ªå‹•åæŸ¥) ---
                const coordInput = document.getElementById('coordinate-input');
                if (coordInput) {
                    let coordsOnFocus = '';

                    // ç´€éŒ„é€²å…¥æ™‚çš„å€¼ï¼Œä»¥ä¾¿åˆ¤æ–·æ˜¯å¦è®Šæ›´
                    coordInput.addEventListener('focus', function() {
                        coordsOnFocus = this.value.trim();
                    });

                    // 1. Blur äº‹ä»¶ (é›¢é–‹è¼¸å…¥æ¡†æ™‚)
                    coordInput.addEventListener('blur', async function() {
                        const val = this.value.trim();
                        const formatted = formatCoordinateString(val);
                        
                        // è§¸ç™¼æ¢ä»¶ï¼šå€¼æœ‰æ”¹è®Š ä¸” æ ¼å¼æ­£ç¢º
                        const isChanged = (val !== coordsOnFocus);
                        // é¡å¤–æ¢ä»¶ï¼šå¦‚æœåœ‹å®¶æ¬„ä½æ˜¯ç©ºçš„ï¼Œå°±ç®—å€¼æ²’è®Šä¹Ÿå˜—è©¦æŸ¥ä¸€æ¬¡ (è£œæ•‘æªæ–½)
                        const isCountryEmpty = !document.getElementById('input-country').value;

                        if (formatted) {
                            this.value = formatted; // å¡«å›æ ¼å¼åŒ–å¾Œçš„åº§æ¨™
                            
                            if (isChanged || isCountryEmpty) {
                                const parts = formatted.split(',');
                                if(parts.length === 2) {
                                    await autoFillLocation(parts[0].trim(), parts[1].trim());
                                }
                            }
                        }
                    });
                    
                    // 2. Paste äº‹ä»¶ (è²¼ä¸Šæ™‚)
                    coordInput.addEventListener('paste', function(e) {
                        // ä½¿ç”¨ setTimeout ç¢ºä¿è®€å–åˆ°è²¼ä¸Šå¾Œçš„å…§å®¹
                        setTimeout(async () => { 
                            const val = this.value.trim();
                            const formatted = formatCoordinateString(val);
                            
                            if(formatted) {
                                this.value = formatted;
                                showToast('å·²è¾¨è­˜åº§æ¨™æ ¼å¼', false);
                                
                                const parts = formatted.split(',');
                                if(parts.length === 2) {
                                    await autoFillLocation(parts[0].trim(), parts[1].trim());
                                }
                            }
                        }, 50); // ç¨å¾®å»¶é²ä¸€é»é»ä»¥ç¢ºä¿ UI æ›´æ–°
                    });
                }

                // 2. åœ–ç‰‡ä¸Šå‚³ (å¦‚æœæœ‰çš„è©±)
                // é‚è¼¯ï¼šå¦‚æœæ˜¯æ–°å¢(ç„¡id)æˆ–ç·¨è¼¯ä¸”æœ‰é¸æª”ï¼Œæ‰ä¸Šå‚³
                if (!id || (id && fileInput.files.length > 0)) {
                    if (fileInput.files.length === 0 && !id) throw new Error('è«‹é¸æ“‡åœ–ç‰‡'); // æ–°å¢æ™‚å¿…å¡«
                    
                    if (fileInput.files.length > 0) {
                        const compressed = await compressImage(fileInput.files[0]);
                        
                        // ç”¢ç”Ÿæª”åä¸¦è¨˜éŒ„åœ¨ uploadedFileName
                        uploadedFileName = `guest_art_${Date.now()}_${Math.floor(Math.random()*1000)}.jpg`;
                        
                        const { error: upErr } = await supabaseClient.storage.from('guest-postcard-images').upload(uploadedFileName, compressed);
                        if (upErr) throw upErr;
                        
                        const { data } = supabaseClient.storage.from('guest-postcard-images').getPublicUrl(uploadedFileName);
                        imageUrl = data.publicUrl;
                    }
                }

                // 3. æº–å‚™ Payload
                const payload = {
                    nickname: guestNick, friendCode: guestCode,
                    coordinate: coordInput.value,
                    country: document.getElementById('input-country').value,
                    region: document.getElementById('input-region').value,
                    area: document.getElementById('input-area').value,
                    tags: [1,2,3].map(i=>document.getElementById(`tag-${i}`).value.trim()).filter(Boolean),
                    imageUrl: imageUrl, // å¦‚æœæ˜¯ç·¨è¼¯ä¸”æ²’æ›åœ–ï¼Œé€™è£¡æ˜¯ nullï¼Œå¾Œç«¯æœƒå¿½ç•¥
                    id: id
                };

                // 4. å‘¼å«å¾Œç«¯ API
                const action = id ? 'edit-guest-postcard' : 'add-guest-postcard';
                const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ action, payload })
                });

                // 5. æª¢æŸ¥ç³»çµ±éŒ¯èª¤ (500 ç­‰)
                if (error) throw new Error(error.message);

                // 6. â˜… æª¢æŸ¥æ¥­å‹™é‚è¼¯éŒ¯èª¤ (ä¾‹å¦‚ï¼šåº§æ¨™é‡è¤‡)
                // é›–ç„¶ HTTP 200ï¼Œä½†å¾Œç«¯å›å‚³ success: falseï¼Œé€™æ™‚å€™å¿…é ˆæ‹‹å‡ºéŒ¯èª¤ä¾†è§¸ç™¼åœ–ç‰‡åˆªé™¤
                if (data && data.success === false) {
                    throw new Error(data.message || 'æ“ä½œè¢«æ‹’çµ•'); 
                }

                if (data && data.error) throw new Error(data.error);

                // --- æˆåŠŸå€ ---
                showToast(id ? 'æ›´æ–°æˆåŠŸ' : 'ç™¼å¸ƒæˆåŠŸ', false);
                modal.classList.add('hidden');
                loadCards();

            } catch (err) {
                console.error('Submit Error:', err);
                showToast(`å¤±æ•—ï¼š${err.message}`, true);

                // å®Œç¾å›æ»¾æ©Ÿåˆ¶ (Rollback)
                // å¦‚æœå‰›å‰›æœ‰ä¸Šå‚³æ–°åœ–ç‰‡ (`uploadedFileName` å­˜åœ¨)ï¼Œä½†æµç¨‹å¤±æ•—äº† (é€²å…¥ catch)
                // å¿…é ˆç«‹åˆ»åˆªé™¤è©²åœ–ç‰‡ï¼Œé¿å…æˆç‚ºåƒåœ¾æª”æ¡ˆ
                if (uploadedFileName) {
                    console.log('åŸ·è¡Œå›æ»¾ï¼šåˆªé™¤ç„¡æ•ˆåœ–ç‰‡', uploadedFileName);
                    // ä¸ä½¿ç”¨ await é˜»æ“‹ UIï¼Œè®“å®ƒåœ¨èƒŒæ™¯åŸ·è¡Œåˆªé™¤å³å¯
                    supabaseClient.storage.from('guest-postcard-images').remove([uploadedFileName])
                        .then(({ error }) => {
                            if (error) console.error('åœ–ç‰‡å›æ»¾åˆªé™¤å¤±æ•— (è«‹æ‰‹å‹•æª¢æŸ¥ Bucket):', error);
                            else console.log('åœ–ç‰‡å·²æˆåŠŸå›æ»¾åˆªé™¤ï¼Œç¯€çœç©ºé–“ã€‚');
                        });
                }

            } finally {
                btn.disabled = false; 
                btn.textContent = originalText;
            }
        };

        window.editCard = (id, e) => {
            e.stopPropagation();
            const c = allCards.find(x => x.id === id);
            if (!c) return;
            
            document.getElementById('edit-id').value = id;
            document.getElementById('modal-title').textContent = 'ç·¨è¼¯ç¾ç‰‡';
            document.getElementById('coordinate-input').value = c.coordinate;
            document.getElementById('input-country').value = c.country || '';
            document.getElementById('input-region').value = c.region || '';
            document.getElementById('input-area').value = c.area || '';
            
            [1,2,3].forEach(i => document.getElementById(`tag-${i}`).value = c.tags[i-1] || '');
            
            document.getElementById('image-upload-section').querySelector('label').textContent = 'æ›´æ›åœ–ç‰‡ (ä¸æ›ç•™ç©º)';
            document.getElementById('image-upload').value = '';
            document.getElementById('preview-image').src = c.image_url;
            document.getElementById('preview-section').classList.remove('hidden');
            document.getElementById('submit-btn').textContent = 'æ›´æ–°';
            modal.classList.remove('hidden');
        };

        window.deleteCard = async (id, e) => {
            e.stopPropagation();
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤ç¾ç‰‡ï¼Ÿ')) return;
            try {
                const { error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ action: 'delete-guest-postcard', payload: { id, nickname: guestNick, friendCode: guestCode } })
                });
                if (error) throw error;
                showToast('å·²åˆªé™¤', false);
                loadCards();
            } catch (err) {
                showToast('åˆªé™¤å¤±æ•—', true);
            }
        };

        window.toggleLike = async (id, btn) => {
            const c = allCards.find(x => x.id === id);
            if (!c) return;
            
            const wasLiked = c.isLiked;
            c.isLiked = !wasLiked;
            c.likes += (wasLiked ? -1 : 1);
            btn.innerHTML = `<span class="icon text-sm">${c.isLiked?'â¤ï¸':'ğŸ¤'}</span><span class="count text-xs font-bold">${c.likes}</span>`;
            btn.className = `like-btn flex items-center gap-1 bg-gray-800/50 px-2 py-0.5 rounded-full ${c.isLiked?'liked':'text-gray-500 hover:text-pink-400'}`;

            try {
                await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ action: 'toggle-guest-postcard-like', payload: { postcardId: id } })
                });
            } catch(e) { console.error('Like failed'); }
        };

        // --- ç¶å®šè²¼ä¸ŠæŒ‰éˆ•äº‹ä»¶ (ä¿®æ­£ç‰ˆï¼šè²¼ä¸Šå¾Œä¸»å‹•è§¸ç™¼åæŸ¥) ---
        document.getElementById('paste-coord-btn').onclick = async () => {
            try {
                const txt = await navigator.clipboard.readText();
                if (txt) {
                    const formatted = formatCoordinateString(txt);
                    const inputEl = document.getElementById('coordinate-input');
                    
                    // 1. å¡«å…¥æ•¸å€¼
                    inputEl.value = formatted;
                    
                    // 2. è¦–è¦ºå›é¥‹
                    showToast('å·²è®€å–å‰ªè²¼ç°¿', false);
                    
                    // 3. â˜… é‡é»ä¿®æ­£ï¼šä¸»å‹•å‘¼å«åæŸ¥ (å› ç‚ºç¨‹å¼ä¿®æ”¹å€¼ä¸æœƒè§¸ç™¼ç›£è½å™¨)
                    const parts = formatted.split(',');
                    if (parts.length === 2) {
                        // è®“ä½¿ç”¨è€…çŸ¥é“æ­£åœ¨é‹ä½œ
                        const countryInput = document.getElementById('input-country');
                        if (countryInput) countryInput.placeholder = 'ğŸ” è§£æä¸­...';
                        
                        // å‘¼å«åæŸ¥å‡½å¼
                        await autoFillLocation(parts[0].trim(), parts[1].trim());
                    }
                } else {
                    alert('å‰ªè²¼ç°¿æ˜¯ç©ºçš„');
                }
            } catch (e) {
                console.error(e);
                alert('ç„¡æ³•è®€å–å‰ªè²¼ç°¿ï¼Œè«‹å˜—è©¦ç›´æ¥åœ¨è¼¸å…¥æ¡†æŒ‰ Ctrl+V è²¼ä¸Š');
            }
        };
        
        window.openImageViewer = (url) => {
            document.getElementById('viewer-image').src = url;
            document.getElementById('image-viewer-modal').classList.remove('hidden');
        };
        window.closeImageViewer = () => document.getElementById('image-viewer-modal').classList.add('hidden');
        
        window.copyText = (t) => navigator.clipboard.writeText(t).then(() => showToast('å·²è¤‡è£½', false));
        
        function showToast(msg, isErr) {
            const el = document.getElementById('toast-message');
            el.textContent = (isErr ? 'âŒ ' : 'âœ… ') + msg;
            el.className = `fixed top-5 right-5 text-white py-3 px-6 rounded-xl shadow-2xl z-[70] font-bold ${isErr?'bg-red-600':'bg-green-600'} translate-y-0`;
            el.classList.remove('hidden');
            setTimeout(() => { el.classList.add('translate-y-[-20px]', 'opacity-0'); setTimeout(() => el.classList.add('hidden'), 300); }, 3000);
        }

        function setupDropdown(inputId, dropdownId, getSet) {
            const input = document.getElementById(inputId), dd = document.getElementById(dropdownId);
            const render = () => {
                const opts = Array.from(getSet()).sort().filter(x => x.toLowerCase().includes(input.value.toLowerCase()));
                dd.innerHTML = opts.map(x => `<div class="dropdown-option">${x}</div>`).join('') || '<div class="p-2 text-gray-500 text-xs">ç„¡é¸é …</div>';
                Array.from(dd.children).forEach(div => div.onclick = () => { input.value = div.textContent; dd.classList.remove('show'); });
            };
            input.onfocus = () => { render(); dd.classList.add('show'); };
            input.oninput = () => { render(); dd.classList.add('show'); };
            document.addEventListener('click', e => { if(!input.contains(e.target) && !dd.contains(e.target)) dd.classList.remove('show'); });
        }
        
        function updateInputDropdowns() {
            setupDropdown('input-country', 'dropdown-country', () => uniqueCountries);
            setupDropdown('input-region', 'dropdown-region', () => uniqueRegions);
            setupDropdown('input-area', 'dropdown-area', () => uniqueAreas);
            const allTags = new Set(); allCards.forEach(c => c.tags && c.tags.forEach(t => allTags.add(t)));
            [1,2,3].forEach(i => setupDropdown(`tag-${i}`, `dropdown-${i}`, () => allTags));
        }
        function initDropdowns() { updateInputDropdowns(); }

        // Bind events
        const coordInput = document.getElementById('coordinate-input');
        if(coordInput) { 
            coordInput.addEventListener('blur', function() {
                this.value = formatCoordinateString(this.value);
            });
            coordInput.addEventListener('paste', function(e) {
                setTimeout(() => { this.value = formatCoordinateString(this.value); }, 10);
            });
        }
        document.addEventListener('DOMContentLoaded', init);

        window.toggleObsolete = async (id, uploaderName) => {
            const c = allCards.find(x => x.id === id);
            if (!c) return;

            // é˜²æ­¢é»æ“Šç©¿é€ (å¦‚æœæŒ‰éˆ•åœ¨åœ–ç‰‡ä¸Š)
            if (event) event.stopPropagation();

            const isCurrentlyObsolete = c.is_obsolete;
            const actionText = isCurrentlyObsolete ? 'æ¢å¾©ä¸Šæ¶' : 'å›å ±çµ•ç‰ˆ';
            
            const confirmMsg = isCurrentlyObsolete 
                ? `ç¢ºå®šè¦å°‡é€™å¼µç¾ç‰‡ã€Œ${actionText}ã€å—ï¼Ÿ`
                : `æ‚¨ç¢ºå®šè¦å›å ±é€™å¼µç¾ç‰‡ç‚ºã€Œçµ•ç‰ˆ/å¤±æ•ˆã€å—ï¼Ÿ\n\nå›å ±å¾Œï¼Œå¡ç‰‡å°‡æœƒè®Šç°ä¸¦æ¨™ç¤ºçµ•ç‰ˆã€‚`;

            if (!confirm(confirmMsg)) return;

            try {
                // 1. æ¨‚è§€ UI æ›´æ–°
                c.is_obsolete = !isCurrentlyObsolete;
                renderGrid(); 

                // 2. å‘¼å«å¾Œç«¯
                const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ action: 'toggle-guest-postcard-obsolete', payload: { postcardId: id } })
                });

                if (error) throw error;
                if (data && data.error) throw new Error(data.error);

                showToast(data.data.message, false);

            } catch (e) {
                console.error(e);
                // å¤±æ•—å›æ»¾
                c.is_obsolete = isCurrentlyObsolete;
                renderGrid();
                showToast(`æ“ä½œå¤±æ•—: ${e.message}`, true);
            }
        };

        // â˜… å·¥å…·å‡½å¼ï¼šè‡ªå‹•åæŸ¥åœ°ç†ä½ç½® (é€éå¾Œç«¯ Proxy)
        async function autoFillLocation(lat, lng) {
            const countryInput = document.getElementById('input-country');
            const regionInput = document.getElementById('input-region');
            const areaInput = document.getElementById('input-area');

            const originalPlaceholders = {
                country: countryInput.placeholder,
                region: regionInput.placeholder,
                area: areaInput.placeholder
            };
            
            countryInput.value = ''; countryInput.placeholder = 'ğŸ” æœå°‹ä¸­...';
            regionInput.value = ''; regionInput.placeholder = 'ğŸ” æœå°‹ä¸­...';
            areaInput.value = ''; areaInput.placeholder = 'ğŸ” æœå°‹ä¸­...';

            try {
                // å‘¼å«å¾Œç«¯ Edge Function (action: reverse-geocode åœ¨ index.ts å·²å­˜åœ¨)
                const { data: resData, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ 
                        action: 'reverse-geocode', 
                        payload: { lat, lng } 
                    })
                });

                if (error) throw error;

                const data = resData.data;

                if (data && data.address) {
                    const addr = data.address;

                    // 1. åœ‹å®¶
                    if (addr.country) countryInput.value = addr.country;

                    // 2. åœ°å€ (è‡ªå‹•ä¿®æ­£ "è‡º" ç‚º "å°")
                    const region = addr.city || addr.county || addr.state || '';
                    if (region) regionInput.value = region.replace(/è‡º/g, 'å°');

                    // 3. ç´°é …
                    const area = addr.suburb || addr.district || addr.town || addr.village || addr.neighbourhood || '';
                    if (area) areaInput.value = area;
                    
                    // é–ƒçˆç¶ æ¡†æç¤ºæˆåŠŸ
                    [countryInput, regionInput, areaInput].forEach(el => {
                        if(el.value) {
                            el.classList.add('ring-2', 'ring-green-500');
                            setTimeout(() => el.classList.remove('ring-2', 'ring-green-500'), 1000);
                        }
                    });
                }
            } catch (e) {
                console.error('è‡ªå‹•å¡«å¯«ä½ç½®å¤±æ•—:', e);
                // å¤±æ•—æ™‚æ¢å¾©åŸæœ¬çš„ placeholder
                countryInput.placeholder = originalPlaceholders.country;
                regionInput.placeholder = originalPlaceholders.region;
                areaInput.placeholder = originalPlaceholders.area;
            }
        }
    </script>
</body>
</html>