<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡è‡å®…é…é€š - å¥½å‹ç¢¼åˆ†äº«</title>
    <link rel="icon" href="./mashroom_s.png" type="image/png">
    <link rel="apple-touch-icon" href="./mashroom_s.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .main-container {
            background-color: #1f2937;
            border: 1px solid #374151;
        }
        .dark-input {
            background-color: #374151;
            border-color: #4b5563;
            color: #d1d5db;
        }
        .dark-input:focus {
            --tw-ring-color: #22c55e; /* green-500 for partner page */
            border-color: #22c55e;
        }
        .primary-button {
            background-color: #22c55e; /* green-500 */
            transition: background-color 0.2s ease-in-out;
        }
        .primary-button:hover:not(:disabled) {
            background-color: #16a34a; /* green-600 */
        }
        .secondary-button {
            background-color: #4b5563;
            color: white;
        }
        .secondary-button:hover {
            background-color: #6b7280;
        }
        .table-header {
            background-color: #374151;
        }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); }
        .sort-button {
            background-color: #4b5563;
            color: #d1d5db;
        }
        .sort-button.active {
            background-color: #22c55e;
            color: white;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="mb-8 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-white flex items-center">
                <span class="mr-3">ğŸšš</span> è‡è‡å®…é…é€š
            </h1>
            <a href="./dashboard.html" class="text-indigo-400 hover:text-indigo-300 font-bold transition">è¿”å›ä¸»é </a>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- å·¦å´/ä¸Šæ–¹ï¼šæ–°å¢è¡¨å–® -->
            <div class="lg:col-span-1">
                <div class="main-container rounded-2xl p-6 sticky top-8">
                     <h2 class="text-xl font-bold mb-4">æ–°å¢å¥½å‹ç¢¼</h2>
                     <form id="add-partner-form" class="space-y-4">
                        <div>
                            <label for="new-name" class="text-sm font-medium">åç¨±</label>
                            <input type="text" id="new-name" required maxlength="50" class="dark-input mt-1 w-full rounded-md">
                        </div>
                        <div>
                            <label for="new-code" class="text-sm font-medium">å¥½å‹ç¢¼ (12ä½æ•¸å­—)</label>
                            <input type="text" id="new-code" required pattern="[0-9]{12}" title="è«‹è¼¸å…¥12ä½æ•¸å­—çš„å¥½å‹ç¢¼" class="dark-input mt-1 w-full rounded-md">
                        </div>
                        <button type="submit" id="add-partner-button" class="primary-button w-full py-2 rounded-lg font-bold disabled:opacity-50">æ–°å¢åˆ°è¯çµ¡ç°¿</button>
                     </form>
                </div>
            </div>
            
            <!-- å³å´/ä¸‹æ–¹ï¼šåˆ—è¡¨ -->
            <div class="lg:col-span-2 main-container rounded-2xl p-6">
                <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">å¥½å‹è¯çµ¡ç°¿</h2>
                    <div class="flex flex-wrap items-center gap-2">
                        <!-- æŸ¥æ‰¾åŠŸèƒ½ -->
                        <form id="search-form" class="flex items-center space-x-2">
                            <input type="text" id="search-input" placeholder="æŸ¥æ‰¾åç¨±..." class="dark-input rounded-full px-3 py-1 text-xs w-32">
                            <button type="submit" class="sort-button text-xs px-3 py-1.5 rounded-full">æŸ¥æ‰¾</button>
                        </form>
                        <!-- æ’åºåŠŸèƒ½ -->
                        <div id="sort-controls" class="flex space-x-2">
                            <button id="sort-by-name" class="sort-button text-xs px-3 py-1.5 rounded-full">ä¾åç¨±æ’åº</button>
                            <button id="sort-by-time" class="sort-button text-xs px-3 py-1.5 rounded-full active">ä¾æ™‚é–“æ’åº</button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto max-h-[75vh]">
                    <table class="w-full text-left">
                        <thead class="table-header sticky top-0">
                            <tr>
                                <th class="p-3">åç¨±</th>
                                <th class="p-3">å¥½å‹ç¢¼</th>
                                <th class="p-3 text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="partner-list-body">
                            <tr><td colspan="3" class="text-center p-4">è®€å–ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç·¨è¼¯ Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="main-container w-full max-w-sm p-8 rounded-2xl shadow-2xl">
            <h2 class="text-xl font-bold mb-6 text-white">ç·¨è¼¯è¯çµ¡äºº</h2>
            <form id="edit-partner-form">
                <input type="hidden" id="edit-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-name" class="text-sm font-medium">åç¨±</label>
                        <input type="text" id="edit-name" required maxlength="50" class="dark-input mt-1 w-full rounded-md">
                    </div>
                    <div>
                        <label for="edit-code" class="text-sm font-medium">å¥½å‹ç¢¼ (12ä½æ•¸å­—)</label>
                        <input type="text" id="edit-code" required pattern="[0-9]{12}" title="è«‹è¼¸å…¥12ä½æ•¸å­—çš„å¥½å‹ç¢¼" class="dark-input mt-1 w-full rounded-md">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-8">
                    <button type="button" id="cancel-edit-button" class="secondary-button px-4 py-2 rounded-lg">å–æ¶ˆ</button>
                    <button type="submit" class="primary-button px-4 py-2 rounded-lg font-bold">ç¢ºèªå„²å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- å…¨å±€è¨Šæ¯æç¤º -->
    <div id="toast-message" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50"></div>

    <script>
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co'; 
        const SUPABASE_ANON_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let partnerToEditId = null;
        let currentSort = { column: 'created_at', ascending: false };

        const addPartnerForm = document.getElementById('add-partner-form');
        const addPartnerButton = document.getElementById('add-partner-button');
        const partnerListBody = document.getElementById('partner-list-body');
        const editModal = document.getElementById('edit-modal');
        const editPartnerForm = document.getElementById('edit-partner-form');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const toastMessage = document.getElementById('toast-message');
        const sortByNameButton = document.getElementById('sort-by-name');
        const sortByTimeButton = document.getElementById('sort-by-time');
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');

        // --- æ ¸å¿ƒåŠŸèƒ½ ---

        async function loadPartners() {
            const searchTerm = searchInput.value.trim();
            
            let query = supabaseClient
                .from('partners')
                .select('*')
                .order(currentSort.column, { ascending: currentSort.ascending });

            if (searchTerm) {
                query = query.ilike('name', `%${searchTerm}%`);
            }

            const { data, error } = await query;

            if (error) {
                partnerListBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-red-400">ç„¡æ³•è¼‰å…¥è³‡æ–™: ${error.message}</td></tr>`;
                return;
            }
            
            if (data.length === 0) {
                const message = searchTerm ? `æ‰¾ä¸åˆ°åç¨±åŒ…å« "${escapeHtml(searchTerm)}" çš„æ‘æ°‘ã€‚` : "ç›®å‰æ²’æœ‰ä»»ä½•å¥½å‹ç¢¼ï¼Œå¿«ä¾†æ–°å¢ç¬¬ä¸€ç­†ï¼";
                partnerListBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-gray-400">${message}</td></tr>`;
                return;
            }

            partnerListBody.innerHTML = data.map(partner => `
                <tr id="partner-${partner.id}" class="border-b border-gray-700">
                    <td class="p-3">${escapeHtml(partner.name)}</td>
                    <td class="p-3 font-mono">
                        <span>${escapeHtml(partner.friend_code)}</span>
                        <button data-code="${escapeHtml(partner.friend_code)}" class="copy-button ml-2 text-gray-400 hover:text-white" title="è¤‡è£½å¥½å‹ç¢¼">ğŸ“‹</button>
                    </td>
                    <td class="p-3 text-center space-x-2">
                        <button data-id="${partner.id}" data-name="${escapeHtml(partner.name)}" data-code="${escapeHtml(partner.friend_code)}" class="edit-button text-xs px-2 py-1 bg-blue-600 rounded hover:bg-blue-500">ç·¨è¼¯</button>
                        <button data-id="${partner.id}" data-name="${escapeHtml(partner.name)}" class="delete-button text-xs px-2 py-1 bg-red-700 rounded hover:bg-red-600">åˆªé™¤</button>
                    </td>
                </tr>
            `).join('');
            updateSortButtonsUI();
        }

        addPartnerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            addPartnerButton.disabled = true;

            const name = document.getElementById('new-name').value;
            const code = document.getElementById('new-code').value;

            const { data: existing, error: checkError } = await supabaseClient.from('partners').select('name').eq('name', name).single();

            if (checkError && checkError.code !== 'PGRST116') {
                 showToast(`æª¢æŸ¥æš±ç¨±æ™‚ç™¼ç”ŸéŒ¯èª¤: ${checkError.message}`, true);
                 addPartnerButton.disabled = false;
                 return;
            }

            if (existing) {
                showToast('æ‘æ°‘å·²ç™»éŒ„ï¼Œå¯ç”¨æŸ¥æ‰¾åŠŸèƒ½æœå°‹ã€‚', true);
                addPartnerButton.disabled = false;
                return;
            }
            
            const { error } = await supabaseClient.from('partners').insert({ name: name, friend_code: code });
            
            if (error) {
                showToast(`æ–°å¢å¤±æ•—: ${error.message}`, true);
            } else {
                showToast('æ–°å¢æˆåŠŸï¼', false);
                addPartnerForm.reset();
                loadPartners(); // ã€å³æ™‚æ›´æ–°ä¿®æ­£ã€‘
            }
            addPartnerButton.disabled = false;
        });

        partnerListBody.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const { id, name, code } = button.dataset;

            if (button.classList.contains('edit-button')) {
                partnerToEditId = id;
                document.getElementById('edit-id').value = id;
                document.getElementById('edit-name').value = name;
                document.getElementById('edit-code').value = code;
                editModal.classList.remove('hidden');
            } else if (button.classList.contains('delete-button')) {
                if(confirm(`ç¢ºå®šè¦åˆªé™¤ "${name}" çš„å¥½å‹ç¢¼å—ï¼Ÿ`)) {
                    deletePartner(id);
                }
            } else if (button.classList.contains('copy-button')) {
                copyToClipboard(code);
            }
        });

        async function deletePartner(id) {
            const { error } = await supabaseClient.from('partners').delete().eq('id', id);
            if (error) { showToast(`åˆªé™¤å¤±æ•—: ${error.message}`, true); } 
            else { 
                showToast('åˆªé™¤æˆåŠŸï¼', false); 
                loadPartners(); // ã€å³æ™‚æ›´æ–°ä¿®æ­£ã€‘
            }
        }
        
        cancelEditButton.addEventListener('click', () => editModal.classList.add('hidden'));
        editPartnerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('edit-name').value;
            const code = document.getElementById('edit-code').value;

            const { error } = await supabaseClient.from('partners').update({ name: name, friend_code: code }).eq('id', id);
            
            if (error) { showToast(`æ›´æ–°å¤±æ•—: ${error.message}`, true); } 
            else { 
                showToast('æ›´æ–°æˆåŠŸï¼', false); 
                editModal.classList.add('hidden');
                loadPartners(); // ã€å³æ™‚æ›´æ–°ä¿®æ­£ã€‘
            }
        });
        
        // --- æ’åº & æŸ¥æ‰¾ ---
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            loadPartners();
        });

        sortByNameButton.addEventListener('click', () => {
            if (currentSort.column === 'name') {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.column = 'name';
                currentSort.ascending = true;
            }
            loadPartners();
        });
        sortByTimeButton.addEventListener('click', () => {
             if (currentSort.column === 'created_at') {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.column = 'created_at';
                currentSort.ascending = false;
            }
            loadPartners();
        });
        function updateSortButtonsUI() {
            document.querySelectorAll('#sort-controls button').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById(currentSort.column === 'name' ? 'sort-by-name' : 'sort-by-time');
            activeBtn.classList.add('active');
            
            const arrow = currentSort.ascending ? ' â–²' : ' â–¼';
            activeBtn.textContent = (currentSort.column === 'name' ? 'ä¾åç¨±æ’åº' : 'ä¾æ™‚é–“æ’åº') + arrow;
            
            const inactiveBtn = document.getElementById(currentSort.column === 'name' ? 'sort-by-time' : 'sort-by-name');
            inactiveBtn.textContent = inactiveBtn.id === 'sort-by-name' ? 'ä¾åç¨±æ’åº' : 'ä¾æ™‚é–“æ’åº';
        }

        // --- Realtime ---
        function setupRealtime() {
            const channel = supabaseClient.channel('partners-list');
            // ã€å³æ™‚æ›´æ–°ä¿®æ­£ã€‘ç§»é™¤æ‰‹å‹•åˆ·æ–°å¾Œï¼ŒRealtime è®Šå¾—æ›´ç‚ºé‡è¦
            channel.on('postgres_changes', { event: '*', schema: 'public', table: 'partners' }, loadPartners).subscribe();
        }

        // --- è¼”åŠ©å‡½å¼ ---
        function copyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast(`å·²è¤‡è£½å¥½å‹ç¢¼: ${text}`, false);
            } catch (err) {
                showToast('è¤‡è£½å¤±æ•—ï¼', true);
            }
            document.body.removeChild(textArea);
        }

        function showToast(message, isError = false) {
            toastMessage.textContent = message;
            toastMessage.className = `fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-white py-3 px-6 rounded-lg shadow-xl z-50 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            toastMessage.classList.remove('hidden');
            setTimeout(() => {
                toastMessage.classList.add('hidden');
            }, 2000);
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadPartners();
            setupRealtime();
        });
    </script>
</body>
</html>
