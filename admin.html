<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å¾Œå° - è‡è‡å®…é…ç¶²</title>
    <link rel="icon" href="./mashroom_s.png" type="image/png">
    <link rel="apple-touch-icon" href="./mashroom_s.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 
    <style>
        /* CSS è¨»è§£ï¼šä»¥ä¸‹æ˜¯æœ¬é é¢çš„æ¨£å¼è¨­å®š */
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #111827; color: #d1d5db; }
        .admin-container { background-color: #1f2937; border: 1px solid #374151; }
        .dark-input { background-color: #374151; border-color: #4b5563; color: #d1d5db; }
        .dark-input:focus { --tw-ring-color: #fb923c; border-color: #fb923c; } /* ç®¡ç†å¾Œå°çš„è¼¸å…¥æ¡†ï¼Œç„¦é»é¡è‰²æ”¹ç‚ºæ©˜è‰²ç³» */
        .admin-button { background-color: #f97316; transition: background-color 0.2s ease-in-out; } /* ä¸»è¦æŒ‰éˆ•ä½¿ç”¨æ©˜è‰²ç³» */
        .admin-button:hover:not(:disabled) { background-color: #ea580c; } /* æ»‘é¼ æ‡¸æµ®åœ¨å¯ç”¨çš„ä¸»è¦æŒ‰éˆ•ä¸Šæ™‚ï¼ŒåŠ æ·±é¡è‰² */
        .secondary-button { background-color: #4b5563; color: white; } /* æ¬¡è¦æŒ‰éˆ•ï¼ˆå¦‚å–æ¶ˆï¼‰ä½¿ç”¨ç°è‰²ç³» */
        .secondary-button:hover { background-color: #6b7280; }
        .table-header { background-color: #374151; } /* ä½¿ç”¨è€…åˆ—è¡¨çš„è¡¨é ­èƒŒæ™¯è‰² */
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); } /* å½ˆå‡ºè¦–çª—ï¼ˆModalï¼‰çš„åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
        .challenge-card { background-color: #1f2937; border: 1px solid #374151; transition: transform 0.3s ease, box-shadow 0.3s ease; display: flex; flex-direction: column; justify-content: space-between; }
        .status-light { width: 0.75rem; height: 0.75rem; border-radius: 9999px; transition: background-color 0.3s ease-in-out; } /* è³‡æ–™åº«é€£ç·šç‹€æ…‹çš„æŒ‡ç¤ºç‡ˆ */
        
        /* â˜… æ–°å¢ï¼šå¯æ’åºæ¨™é ­çš„æ¨£å¼ */
        .sortable-header { 
            cursor: pointer; /* ç•¶æ»‘é¼ ç§»åˆ°æ¨™é ­ä¸Šæ™‚ï¼Œé¡¯ç¤ºç‚ºå¯é»æ“Šçš„æ‰‹å½¢åœ–ç¤º */
            user-select: none; /* é˜²æ­¢ä½¿ç”¨è€…åœ¨å¿«é€Ÿé»æ“Šæ™‚é¸å–åˆ°æ¨™é ­æ–‡å­—ï¼Œæå‡é«”é©— */
            transition: background-color 0.2s; /* è®“èƒŒæ™¯è‰²è®ŠåŒ–æœ‰å¹³æ»‘çš„éæ¸¡æ•ˆæœ */
        }
        .sortable-header:hover { 
            background-color: #4b5563; /* æ»‘é¼ æ‡¸æµ®æ™‚ï¼Œæ”¹è®ŠèƒŒæ™¯è‰²ä»¥æä¾›è¦–è¦ºå›é¥‹ */
        }
        .sort-indicator { 
            color: #f97316; /* æ’åºæŒ‡ç¤ºç¬¦è™Ÿï¼ˆâ–²â–¼ï¼‰çš„é¡è‰² */
            margin-left: 6px; /* é›¢æ¨™é ­æ–‡å­—çš„è·é›¢ */
            font-size: 0.7rem; /* ç¬¦è™Ÿçš„å­—é«”å¤§å° */
            vertical-align: middle; /* è®“ç¬¦è™Ÿèƒ½å’Œæ–‡å­—å‚ç›´å°é½Š */
        }
        /* === è‡ªè¨‚ä¸‹æ‹‰é¸å–®æ¨£å¼ (ä»¿åŸç”Ÿ Select ä½†æ”¯æ´æœå°‹) === */
        .custom-dropdown-container {
            position: relative;
            width: 100%;
        }
        
        /* ä¸‹æ‹‰é¸å–®æœ¬é«” */
        .dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background-color: #374151; /* æ·±ç°èƒŒæ™¯ */
            border: 1px solid #4b5563;
            border-radius: 0.75rem; /* rounded-xl */
            max-height: 280px;      /* é™åˆ¶é«˜åº¦ */
            overflow-y: auto;       /* è¶…å‡ºæ²å‹• */
            z-index: 50;
            display: none;          /* é è¨­éš±è— */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        /* é¡¯ç¤ºç‹€æ…‹ */
        .dropdown-options.show {
            display: block;
        }

        /* é¸é …æ¨£å¼ */
        .dropdown-option {
            padding: 12px 16px;
            color: #d1d5db;
            cursor: pointer;
            transition: background-color 0.1s;
            font-size: 0.95rem;
            border-bottom: 1px solid #4b5563;
        }
        .dropdown-option:last-child {
            border-bottom: none;
        }
        .dropdown-option:hover {
            background-color: #4f46e5; /* æ‡¸æµ®è®Šé›è—è‰² */
            color: white;
        }

        /* å³å´ç®­é ­è£é£¾ */
        .input-arrow {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ° input */
            color: #9ca3af;
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="admin-login-section" class="admin-container w-full max-w-md p-8 space-y-8 rounded-2xl shadow-2xl">
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-100">ç®¡ç†å¾Œå°</h1>
            <p class="mt-2 text-gray-400">è«‹ä½¿ç”¨ç®¡ç†è€…å¸³è™Ÿç™»å…¥</p>
        </div>
        <form id="admin-login-form" class="space-y-6">
            <div>
                <label class="text-sm font-bold text-gray-400">ç®¡ç†å“¡æš±ç¨±</label>
                <div class="custom-dropdown-container mt-1">
                    <input type="text" id="admin-nickname-input" name="nickname" required 
                           class="dark-input w-full px-4 py-3 rounded-xl focus:outline-none" 
                           placeholder="é¸æ“‡ç®¡ç†å“¡..." autocomplete="off">
                    <span class="input-arrow">â–¼</span>
                    <div id="admin-nickname-dropdown" class="dropdown-options"></div>
                </div>
            </div>
            <div>
                <label for="admin-password" class="text-sm font-bold text-gray-400">å¯†ç¢¼</label>
                <input id="admin-password" name="password" type="password" autocomplete="current-password" required class="dark-input w-full px-4 py-3 mt-1 rounded-xl focus:outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <div>
                <button type="submit" id="admin-login-button" class="admin-button w-full px-4 py-3 font-bold text-white rounded-xl focus:outline-none disabled:opacity-50">ç™»å…¥</button>
            </div>
        </form>
        <div id="admin-message-box" class="p-4 text-center text-sm rounded-xl hidden"></div> <a href="./dashboard.html" class="block text-center text-indigo-400 hover:text-indigo-300 mt-4 text-sm">è¿”å›ä¸»é </a>
    </div>

    <div id="admin-dashboard-section" class="hidden w-full max-w-7xl mx-auto">
        <header class="mb-8 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-white">ç®¡ç†ä¸­å¿ƒ</h1>
            <div>
                <span id="admin-user-info" class="font-semibold text-gray-300 mr-4"></span> <a href="./dashboard.html" class="text-indigo-400 hover:text-indigo-300 mr-4">è¿”å›ä¸»é </a>
                <button id="admin-logout-button" class="bg-red-700 text-white px-4 py-2 text-sm rounded-lg font-bold hover:bg-red-600 transition">ç™»å‡º</button>
            </div>
        </header>

        <div id="global-settings-section" class="mb-8 admin-container rounded-2xl p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <div>
                    <div class="flex flex-col gap-6">
                        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                            <div class="flex items-center justify-between">
                                <h3 class="font-bold text-indigo-400">ğŸ“§ å ±åé€šçŸ¥è¨‚é–±</h3>
                                <p class="text-2xl font-bold text-white"><span id="sub-count">...</span> <span class="text-sm text-gray-500">äºº</span></p>
                            </div>
                        </div>

                        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                            <div class="flex items-center justify-between">
                                <h3 class="font-bold text-pink-400">ğŸ”” é¡æ»¿é€šçŸ¥è¨‚é–±</h3>
                                <p class="text-2xl font-bold text-white"><span id="full-sub-count">...</span> <span class="text-sm text-gray-500">äºº</span></p>
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-2">
                                <button id="trigger-check-button" class="bg-teal-600 hover:bg-teal-500 text-white px-2 py-2 rounded-lg font-bold text-xs md:text-sm flex items-center justify-center gap-1">
                                    ç™¼é€å ±åé€šçŸ¥
                                </button>
                                <button id="trigger-full-notify-button" class="bg-pink-600 hover:bg-pink-500 text-white px-2 py-2 rounded-lg font-bold text-xs md:text-sm flex items-center justify-center gap-1">
                                    ç™¼é€é¡æ»¿é€šçŸ¥
                                </button>
                                <button id="send-test-email-button" class="secondary-button px-2 py-2 rounded-lg font-bold text-xs md:text-sm border border-gray-500 hover:bg-gray-600 flex items-center justify-center gap-1">
                                    ç™¼é€æ¸¬è©¦ä¿¡
                                </button>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col justify-between h-full">
                    <div>
                        <h2 class="text-xl font-bold mb-4">âš™ï¸ ç³»çµ±å…¨åŸŸè¨­å®š</h2>
                        <div class="flex items-center gap-4 pt-2">
                            <label for="daily-limit-input" class="text-lg font-medium whitespace-nowrap">æ¯æ—¥å ±åä¸Šé™ï¼š</label>
                            <input type="number" id="daily-limit-input" min="1" class="dark-input w-24 rounded-md text-center" placeholder="è®€å–ä¸­...">
                            <button id="save-settings-button" class="admin-button px-4 py-2 rounded-lg font-bold text-sm disabled:opacity-50">å„²å­˜</button>
                        </div>
                        <span id="settings-status-text" class="text-sm text-gray-400 mt-2 block"></span>
                    </div>

                    <div class="mt-8 pt-6 border-t border-gray-700">
                        <h3 class="text-sm font-bold text-gray-400 mb-3">ğŸ‘¥ Google Groups ç®¡ç†æ·å¾‘</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <a href="https://groups.google.com/g/mushroom_notify" target="_blank" class="secondary-button px-4 py-3 rounded-lg font-bold text-sm text-center hover:bg-gray-600 hover:text-white transition border border-gray-600 block no-underline">
                                ğŸ”— é–‹å•Ÿã€Œå ±åé€šçŸ¥ã€ç¾¤çµ„
                            </a>
                            <a href="https://groups.google.com/g/full_quota_notify" target="_blank" class="secondary-button px-4 py-3 rounded-lg font-bold text-sm text-center hover:bg-gray-600 hover:text-white transition border border-gray-600 block no-underline">
                                ğŸ”— é–‹å•Ÿã€Œé¡æ»¿é€šçŸ¥ã€ç¾¤çµ„
                            </a>
                        </div>
                    </div>

                    <div class="mt-6 pt-6 border-t border-gray-700">
                        <h3 class="text-sm font-bold text-gray-400 mb-3">ğŸ› ï¸ ç¶­è­·å°å·¥å…·</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <a href="./dedupe.html" target="_blank" class="secondary-button px-4 py-3 rounded-lg font-bold text-sm text-center hover:bg-gray-600 hover:text-white transition border border-gray-600 block no-underline">
                                ğŸ§¹ é‡è¤‡æª¢æŸ¥å·¥å…·
                            </a>
                            <a href="./migration.html" target="_blank" class="secondary-button px-4 py-3 rounded-lg font-bold text-sm text-center hover:bg-gray-600 hover:text-white transition border border-gray-600 block no-underline">
                                ğŸšš ç¾ç‰‡æ¬å®¶å…¬å¸
                            </a>
                            <a href="./monitor.html" target="_blank" class="secondary-button px-4 py-3 rounded-lg font-bold text-sm text-center hover:bg-gray-600 hover:text-white transition border border-gray-600 block no-underline">
                                ğŸ“Š è³‡æºç”¨é‡ç›£æ§
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="admin-container rounded-2xl p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">æ–°å¢ä½¿ç”¨è€…</h2>
            <form id="add-user-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div>
                    <label for="new-nickname" class="text-sm font-medium">æš±ç¨±</label>
                    <input type="text" id="new-nickname" required class="dark-input mt-1 w-full rounded-md" placeholder="è¼¸å…¥æš±ç¨±">
                </div>
                <div>
                    <label for="new-password" class="text-sm font-medium">é è¨­å¯†ç¢¼</label>
                    <input type="text" id="new-password" required class="dark-input mt-1 w-full rounded-md" value="000000">
                </div>
                <div>
                    <label for="new-role" class="text-sm font-medium">è§’è‰²</label>
                    <select id="new-role" required class="dark-input mt-1 w-full rounded-md">
                        <option value="å ±åè€…">å ±åè€…</option>
                        <option value="ç™¼è‡è€…">ç™¼è‡è€… (åƒ…ç™¼)</option>
                        <option value="ç™¼è‡åŠå ±åè€…" selected>ç™¼è‡åŠå ±åè€…</option>
                        <option value="ç®¡ç†è€…">ç®¡ç†è€…</option>
                    </select>
                </div>
                <div>
                    <button type="submit" id="add-user-button" class="admin-button w-full py-2 rounded-lg font-bold disabled:opacity-50 h-[42px]">ç¢ºèªæ–°å¢</button>
                </div>
            </form>
        </div>
        
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700 mb-8 shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <span>ğŸ’¬</span> ç•™è¨€æ¿ç®¡ç†
                </h2>
                <div class="flex items-center gap-3">
                    <button onclick="batchDeleteMessages()" id="btn-batch-del" class="hidden flex items-center gap-1 text-sm bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded shadow-md transition font-bold animate-pulse">
                        <span>ğŸ—‘ï¸</span> åˆªé™¤é¸å– (<span id="batch-count">0</span>)
                    </button>
                    
                    <div class="w-[1px] h-6 bg-gray-600 mx-1"></div>
                    
                    <button onclick="clearAllMessages()" class="text-sm bg-red-900/80 hover:bg-red-700 text-red-100 border border-red-700 px-3 py-1.5 rounded transition font-bold">
                        âš ï¸ æ¸…ç©ºæ‰€æœ‰
                    </button>
                </div>
            </div>

            <div id="admin-msg-container" class="overflow-x-auto overflow-y-auto h-[60vh] rounded-lg border border-gray-700 scroll-smooth">
                <table class="w-full text-sm text-left text-gray-400">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-700 sticky top-0 z-10 shadow-md">
                        <tr>
                            <th scope="col" class="p-4 w-10">
                                <div class="flex items-center">
                                    <input id="msg-check-all" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-500 rounded focus:ring-blue-500 focus:ring-2 cursor-pointer">
                                </div>
                            </th>
                            <th scope="col" class="px-4 py-3 whitespace-nowrap">æ™‚é–“</th>
                            <th scope="col" class="px-4 py-3 whitespace-nowrap">æš±ç¨±</th>
                            <th scope="col" class="px-4 py-3 w-full">å…§å®¹</th>
                            <th scope="col" class="px-4 py-3 text-right whitespace-nowrap">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="admin-msg-list" class="divide-y divide-gray-700">
                        <tr>
                            <td colspan="5" class="px-4 py-8 text-center">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p class="text-xs text-gray-500 mt-2 text-right">é¡¯ç¤ºæœ€æ–°çš„ 300 ç­†ç•™è¨€ (ç”±èˆŠè‡³æ–°)</p>
        </div>

        <div class="mb-8 admin-container rounded-2xl p-6">
            <div class="flex items-center space-x-2 mb-4">
                <h2 class="text-xl font-bold">è˜‘è‡æŒ‘æˆ°ç®¡ç†</h2>
                <div id="db-status-light" class="status-light bg-gray-500" title="æ­£åœ¨æª¢æŸ¥è³‡æ–™åº«é€£ç·š..."></div> 
            </div>
            <div id="challenge-list-admin" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto">
                <p>è®€å–ä¸­...</p> 
            </div>
        </div>

        <div class="flex flex-col gap-8">
            
            <div class="admin-container rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">ç¾æœ‰ä½¿ç”¨è€…åˆ—è¡¨</h2>
                <div class="overflow-x-auto max-h-[60vh]">
                    <table class="w-full text-left">
                        <thead id="user-table-header" class="table-header sticky top-0"> 
                            <tr>
                                <th class="p-3 sortable-header w-60" data-sort-key="nickname">æš±ç¨±<span class="sort-indicator"></span></th>
                                <th class="p-3 sortable-header min-w-[100px]" data-sort-key="notes">å‚™è¨»<span class="sort-indicator"></span></th>
                                <th class="p-3 sortable-header" data-sort-key="role">è§’è‰²<span class="sort-indicator"></span></th>
                                <th class="p-3 sortable-header text-center" data-sort-key="monthly_signup_count">åƒèˆ‡åº¦<span class="sort-indicator"></span></th>
                                <th class="p-3 sortable-header text-center" data-sort-key="absent_score">ğŸ’¤<span class="sort-indicator"></span></th>
                                <th class="p-3 sortable-header" data-sort-key="last_active_at">æœ€å¾Œæ´»èº<span class="sort-indicator"></span></th>
                                <th class="p-3 text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="user-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div id="reset-password-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="admin-container w-full max-w-sm p-8 rounded-2xl shadow-2xl">
            <h2 class="text-xl font-bold mb-2 text-white">é‡è¨­å¯†ç¢¼</h2>
            <p class="text-gray-400 mb-6">æ­£åœ¨ç‚º <strong id="reset-pw-nickname" class="text-orange-300"></strong> é‡è¨­å¯†ç¢¼ã€‚</p>
            <form id="reset-password-form">
                <label for="reset-pw-input" class="text-sm font-medium">æ–°å¯†ç¢¼ (è‡³å°‘6ä½æ•¸)</label>
                <input type="text" id="reset-pw-input" required minlength="6" class="dark-input w-full mt-1 rounded-md mb-6" value="000000">
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-reset-pw" class="secondary-button px-4 py-2 rounded-lg">å–æ¶ˆ</button>
                    <button type="submit" class="admin-button px-4 py-2 rounded-lg font-bold">ç¢ºèªé‡è¨­</button>
                </div>
            </form>
        </div>
    </div>
    <div id="change-role-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="admin-container w-full max-w-sm p-8 rounded-2xl shadow-2xl">
            <h2 class="text-xl font-bold mb-2 text-white">è®Šæ›´è§’è‰²</h2>
            <p class="text-gray-400 mb-6">æ­£åœ¨è®Šæ›´ <strong id="change-role-nickname" class="text-orange-300"></strong> çš„è§’è‰²ã€‚</p>
            <form id="change-role-form">
                <label for="change-role-select" class="text-sm font-medium">æ–°è§’è‰²</label>
                <select id="change-role-select" required class="dark-input mt-1 w-full rounded-md mb-6">
                    <option value="å ±åè€…">å ±åè€…</option><option value="ç™¼è‡è€…">ç™¼è‡è€…</option><option value="ç™¼è‡åŠå ±åè€…">ç™¼è‡åŠå ±åè€…</option><option value="ç®¡ç†è€…">ç®¡ç†è€…</option>
                </select>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-change-role" class="secondary-button px-4 py-2 rounded-lg">å–æ¶ˆ</button>
                    <button type="submit" class="admin-button px-4 py-2 rounded-lg font-bold">ç¢ºèªè®Šæ›´</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-user-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
            <div class="admin-container w-full max-w-sm p-8 rounded-2xl shadow-2xl">
                <h2 class="text-xl font-bold mb-6 text-white">ç·¨è¼¯ä½¿ç”¨è€…æš±ç¨±</h2>
                <form id="edit-user-form">
                    <input type="hidden" id="edit-user-id">
                    <input type="hidden" id="edit-user-old-nickname">
                    <div class="space-y-4">
                        <div>
                            <label for="edit-nickname" class="text-sm font-medium">æ–°æš±ç¨±</label>
                            <input type="text" id="edit-nickname" required maxlength="50" class="dark-input mt-1 w-full rounded-md">
                        </div>
                        <div>
                            <label for="edit-notes" class="text-sm font-medium">å‚™è¨» (ç§å¯†)</label>
                            <input type="text" id="edit-notes" maxlength="100" class="dark-input mt-1 w-full rounded-md" placeholder="ä¾‹å¦‚ï¼šæŸæŸäººçš„æœ‹å‹">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-8">
                        <button type="button" id="cancel-edit-user" class="secondary-button px-4 py-2 rounded-lg">å–æ¶ˆ</button>
                        <button type="submit" id="submit-edit-user" class="admin-button px-4 py-2 rounded-lg font-bold">ç¢ºèªå„²å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    
    <script>
        // --- 1. åˆå§‹åŒ–è¨­å®š ---
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co';
        const PUBLIC_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, PUBLIC_KEY);
        
        // --- 2. æŠ“å–æ‰€æœ‰æœƒç”¨åˆ°çš„ HTML å…ƒç´  ---
        const adminLoginSection = document.getElementById('admin-login-section');
        const adminDashboardSection = document.getElementById('admin-dashboard-section');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminLoginButton = document.getElementById('admin-login-button');
        const adminMessageBox = document.getElementById('admin-message-box');
        const adminUserInfo = document.getElementById('admin-user-info');
        const adminLogoutButton = document.getElementById('admin-logout-button');
        const userListBody = document.getElementById('user-list-body');
        const addUserForm = document.getElementById('add-user-form');
        const addUserButton = document.getElementById('add-user-button');
        const resetPasswordModal = document.getElementById('reset-password-modal');
        const resetPasswordForm = document.getElementById('reset-password-form');
        const cancelResetPwButton = document.getElementById('cancel-reset-pw');
        const changeRoleModal = document.getElementById('change-role-modal');
        const changeRoleForm = document.getElementById('change-role-form');
        const cancelChangeRoleButton = document.getElementById('cancel-change-role');
        const editUserModal = document.getElementById('edit-user-modal');
        const editUserForm = document.getElementById('edit-user-form');
        const cancelEditUserButton = document.getElementById('cancel-edit-user');        
        const challengeListAdmin = document.getElementById('challenge-list-admin');
        const dbStatusLight = document.getElementById('db-status-light');
        const userTableHeader = document.getElementById('user-table-header');
        
        // å…¨åŸŸè¨­å®šèˆ‡é€šçŸ¥ç›¸é—œå…ƒç´ 
        const dailyLimitInput = document.getElementById('daily-limit-input');
        const saveSettingsButton = document.getElementById('save-settings-button');
        const settingsStatusText = document.getElementById('settings-status-text');
        const subCountEl = document.getElementById('sub-count');
        const fullSubCountEl = document.getElementById('full-sub-count');

        const sendTestEmailButton = document.getElementById('send-test-email-button');
        const triggerCheckButton = document.getElementById('trigger-check-button');
        const triggerFullNotifyButton = document.getElementById('trigger-full-notify-button');

        // --- 3. ç‹€æ…‹è®Šæ•¸ ---
        let userToEdit = null;
        let dbConnectionInterval = null;
        let allUsersData = [];
        let currentSortColumn = 'nickname';
        let currentSortDirection = 'asc';

        // --- 4. æ ¸å¿ƒåŠŸèƒ½å‡½å¼ ---

        // â˜… æ ¸å¿ƒ 1ï¼šè¼‰å…¥ä½¿ç”¨è€… (å–®ç´”é¡¯ç¤º)
        async function loadUsers() {
            userListBody.innerHTML = `<tr><td colspan="5" class="text-center p-4">è®€å–ä¸­...</td></tr>`;
            try {
                const { data, error } = await invokeAdminFunction('list-users-with-details', {});
                if (error) throw error;
                
                allUsersData = data.users || []; 
                renderUserList(); 
                // é€™è£¡ä¸å†è‡ªå·±è¨ˆç®—è¨‚é–±äººæ•¸ï¼Œæ”¹ç”¨ API
            } catch (error) {
                userListBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-red-400">ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨: ${error.message}</td></tr>`;
            }
        }

        // â˜… æ ¸å¿ƒ 2ï¼šè¼‰å…¥è¨‚é–±çµ±è¨ˆ (å‘¼å«å¾Œç«¯ API)
        async function loadSubscriptionStats() {
            // ä»‹é¢é¡¯ç¤ºè®€å–ä¸­
            if (subCountEl) subCountEl.textContent = '...';
            if (fullSubCountEl) fullSubCountEl.textContent = '...';

            try {
                // å‘¼å« index.ts ä¸­çš„ get-subscriber-counts
                const { data, error } = await invokeAdminFunction('get-subscriber-counts', {});
                
                if (error) throw error;

                if (data) {
                    if (subCountEl) subCountEl.textContent = data.signupCount;
                    if (fullSubCountEl) fullSubCountEl.textContent = data.fullCount;
                }
            } catch (err) {
                console.error('è¨‚é–±çµ±è¨ˆè®€å–å¤±æ•—', err);
                if (subCountEl) subCountEl.textContent = 'err';
                if (fullSubCountEl) fullSubCountEl.textContent = 'err';
            }
        }

        // â˜… æ–°å¢ï¼šç™¼é€æ¸¬è©¦ä¿¡æŒ‰éˆ•é‚è¼¯
        if (sendTestEmailButton) {
            sendTestEmailButton.addEventListener('click', async () => {
                if (!confirm('ç¢ºå®šè¦ç™¼é€ä¸€å°æ¸¬è©¦ä¿¡çµ¦ä¸­ç¹¼ç«™å—ï¼Ÿ')) return;
                
                sendTestEmailButton.disabled = true;
                sendTestEmailButton.textContent = 'ç™¼é€ä¸­...';
                try {
                    await invokeAdminFunction('send-test-email', {});
                    showMessage('æ¸¬è©¦ä¿¡å·²ç™¼é€ï¼è«‹æª¢æŸ¥ Gmailã€‚', false);
                } catch (error) {
                    showMessage(`ç™¼é€å¤±æ•—: ${error.message}`, true);
                } finally {
                    sendTestEmailButton.disabled = false;
                    sendTestEmailButton.textContent = 'ğŸ“¨ ç™¼é€æ¸¬è©¦ä¿¡';
                }
            });
        }

        // â˜… æ–°å¢ï¼šæ‰‹å‹•è§¸ç™¼æª¢æŸ¥æŒ‰éˆ•é‚è¼¯
        if (triggerCheckButton) {
            triggerCheckButton.addEventListener('click', async () => {
                triggerCheckButton.disabled = true;
                triggerCheckButton.innerHTML = '<span>ğŸ”„ æª¢æŸ¥ä¸­...</span>';
                try {
                    const { data } = await invokeAdminFunction('trigger-check-now', {});
                    if (data && data.sent) {
                        showMessage(`æª¢æŸ¥å®Œæˆï¼š${data.message}`, false);
                    } else {
                        showMessage(`æª¢æŸ¥å®Œæˆï¼š${data.message || 'ç„¡ç¬¦åˆæ¢ä»¶çš„è˜‘è‡'}`, false);
                    }
                } catch (error) {
                    showMessage(`æª¢æŸ¥å¤±æ•—: ${error.message}`, true);
                } finally {
                    triggerCheckButton.disabled = false;
                    triggerCheckButton.innerHTML = '<span>âš¡ ç«‹å³æª¢æŸ¥è˜‘è‡ç‹€æ…‹</span>';
                }
            });
        }

        // æ‰‹å‹•è§¸ç™¼é¡æ»¿é€šçŸ¥
        if (triggerFullNotifyButton) {
            triggerFullNotifyButton.addEventListener('click', async () => {
                triggerFullNotifyButton.disabled = true;
                const originalText = triggerFullNotifyButton.textContent;
                triggerFullNotifyButton.textContent = 'ç™¼é€ä¸­...';

                try {
                    // å‘¼å«æˆ‘å€‘å‰›å‰›åœ¨ index.ts å¯«å¥½çš„ action
                    const { data } = await invokeAdminFunction('scheduled-full-notify', {});

                    if (data && data.message) {
                        showMessage(`ç™¼é€æˆåŠŸï¼š${data.message}`, false);
                    } else {
                        showMessage('æª¢æŸ¥å®Œæˆï¼Œç›®å‰æ²’æœ‰é¡æ»¿å¾…ç™¼çš„è˜‘è‡ã€‚', false);
                    }
                } catch (error) {
                    showMessage(`ç™¼é€å¤±æ•—: ${error.message}`, true);
                } finally {
                    triggerFullNotifyButton.disabled = false;
                    triggerFullNotifyButton.textContent = originalText;
                }
            });
        }

        // --- ä»¥ä¸‹ç¶­æŒæ‚¨åŸæœ¬ç©©å®šçš„åˆ—è¡¨æ¸²æŸ“é‚è¼¯ ---

        function renderUserList() {
            updateSortIndicators();

            if (!allUsersData || allUsersData.length === 0) {
                // å› ç‚ºæ–°å¢äº†ã€Œå‚™è¨»ã€æ¬„ä½ï¼Œç¸½æ¬„ä½æ•¸è®Šç‚º 7ï¼Œæ‰€ä»¥ colspan æ”¹ç‚º 7
                userListBody.innerHTML = `<tr><td colspan="7" class="text-center p-4">ç›®å‰æ²’æœ‰ä»»ä½•ä½¿ç”¨è€…ã€‚</td></tr>`;
                return;
            }

            const sortedUsers = [...allUsersData].sort((a, b) => {
                const valA = a[currentSortColumn];
                const valB = b[currentSortColumn];

                let comparison = 0;
                
                if (currentSortColumn === 'nickname') {
                    // --- æš±ç¨±æ’åºé‚è¼¯ ---
                    const getStringType = (str) => {
                        if (!str) return 2;
                        if (/^[a-zA-Z]/.test(str)) return 1;
                        return 2;
                    };
                    const typeA = getStringType(valA);
                    const typeB = getStringType(valB);

                    if (typeA !== typeB) {
                        comparison = typeA - typeB;
                    } else {
                        comparison = String(valA || '').localeCompare(String(valB || ''));
                    }
                } else {
                    // æ•¸å€¼èˆ‡å…¶ä»–æ’åº
                    if (valA == null) return 1;
                    if (valB == null) return -1;
                    
                    if (currentSortColumn === 'monthly_signup_count') {
                        // --- åƒèˆ‡åº¦æ’åº (ç¸½å’Œ) ---
                        const totalA = (valA ?? 0) + (a.monthly_host_count ?? 0);
                        const totalB = (valB ?? 0) + (b.monthly_host_count ?? 0);
                        comparison = totalA - totalB;
                    
                    } else if (currentSortColumn === 'absent_score') {
                        // --- ç¼ºå¸­åˆ†æ•¸æ’åº (æ•¸å€¼æ¯”è¼ƒ) ---
                        comparison = (valA ?? 0) - (valB ?? 0);

                    } else if (currentSortColumn === 'last_active_at') {
                        // --- æ™‚é–“æ’åº ---
                        comparison = new Date(valA).getTime() - new Date(valB).getTime();
                    } else {
                        // ä¸€èˆ¬å­—ä¸²æ’åº (åŒ…å«å‚™è¨» notes)
                        comparison = String(valA).localeCompare(String(valB));
                    }
                }

                return currentSortDirection === 'asc' ? comparison : -comparison;
            });

            userListBody.innerHTML = sortedUsers.map(user => {
                const lastSignIn = user.last_active_at
                    ? new Date(user.last_active_at).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(',', '')
                    : 'å¾æœª';
                
                // --- è¨ˆç®—ç¶œåˆåƒèˆ‡åº¦ ---
                const signupCount = user.monthly_signup_count || 0;
                const hostCount = user.monthly_host_count || 0;
                const totalParticipation = signupCount + hostCount;
                const signupClass = signupCount > 0 ? 'text-blue-400' : 'text-gray-500';
                const hostClass = hostCount > 0 ? 'text-green-400' : 'text-gray-500';
                const participationDisplay = `<span class="font-bold text-white">${totalParticipation}</span> <span class="text-xs text-gray-400">(<span class="${signupClass}">å ±${signupCount}</span>/<span class="${hostClass}">ç™¼${hostCount}</span>)</span>`;

                // --- ç¼ºå¸­åˆ†æ•¸é¡¯ç¤ºé‚è¼¯ ---
                const absScore = user.absent_score || 0;
                const absDisplay = absScore > 0 
                    ? `<span class="text-red-400 font-bold">ğŸ’¤+${absScore}</span>` 
                    : `<span class="text-gray-600">0</span>`;

                return `
                    <tr class="border-b border-gray-700 hover:bg-gray-800/50">
                        <td class="p-3">${user.nickname || 'N/A'}</td>
                        
                        <td class="p-3 text-gray-400 text-sm">${user.notes || ''}</td>

                        <td class="p-3">${user.role || 'æœªçŸ¥'}</td>
                        
                        <td class="p-3 text-center">${participationDisplay}</td>
                        
                        <td class="p-3 text-center">${absDisplay}</td>
                        
                        <td class="p-3 text-sm text-gray-400">${lastSignIn}</td>
                        <td class="p-3 text-center space-x-2">
                            <button data-id="${user.id}" data-nickname="${user.nickname}" class="edit-user-button text-xs px-2 py-1 bg-green-600 rounded hover:bg-green-500">ç·¨è¼¯</button>
                            <button data-id="${user.id}" data-nickname="${user.nickname}" class="reset-password-button text-xs px-2 py-1 bg-blue-600 rounded hover:bg-blue-500">æ”¹å¯†ç¢¼</button>
                            <button data-id="${user.id}" data-nickname="${user.nickname}" data-role="${user.role}" class="change-role-button text-xs px-2 py-1 bg-yellow-600 text-black rounded hover:bg-yellow-500">æ”¹è§’è‰²</button>
                            <button data-id="${user.id}" data-nickname="${user.nickname}" class="delete-user-button text-xs px-2 py-1 bg-red-700 rounded hover:bg-red-600">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateSortIndicators() {
            document.querySelectorAll('.sortable-header').forEach(header => {
                const indicator = header.querySelector('.sort-indicator');
                if (indicator) {
                    if (header.dataset.sortKey === currentSortColumn) {
                        indicator.textContent = currentSortDirection === 'asc' ? 'â–²' : 'â–¼';
                    } else {
                        indicator.textContent = '';
                    }
                }
            });
        }
        
        userTableHeader.addEventListener('click', (e) => {
            const header = e.target.closest('.sortable-header');
            if (!header) return;

            const sortKey = header.dataset.sortKey;
            if (sortKey === currentSortColumn) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = sortKey;
                currentSortDirection = 'asc';
            }
            renderUserList();
        });


        // ç›£è½ç®¡ç†è€…ç™»å…¥è¡¨å–®æäº¤äº‹ä»¶
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            adminLoginButton.disabled = true; adminLoginButton.textContent = 'é©—è­‰ä¸­...';
            const { nickname, password } = e.target.elements;
            
            // --- â˜… æ ¸å¿ƒä¿®æ”¹ï¼šé›™é‡ç™»å…¥æ©Ÿåˆ¶ (Adminç‰ˆ) ---
            
            // æ ¼å¼ A (æ–°åˆ¶)
            const hexNickname = Array.from(new TextEncoder().encode(nickname.value))
                .map(b => b.toString(16).padStart(2, '0')).join('');
            const emailNew = `${hexNickname}@pikmin.sys`;

            // æ ¼å¼ B (èˆŠåˆ¶)
            const cleanNickname = (nickname.value || '').split(/[^a-zA-Z0-9\u4e00-\u9fa5\s]/)[0];
            const emailOld = `${encodeURIComponent(cleanNickname)}@pikmin.sys`;

            try {
                // 1. å˜—è©¦æ–°åˆ¶
                let { data: { user }, error } = await supabaseClient.auth.signInWithPassword({ email: emailNew, password: password.value });

                // 2. è‹¥å¤±æ•—å‰‡å˜—è©¦èˆŠåˆ¶
                if (error) {
                    const retry = await supabaseClient.auth.signInWithPassword({ email: emailOld, password: password.value });
                    if (!retry.error) {
                        user = retry.data.user;
                        error = null;
                    }
                }

                if (error) throw error;

                const { data: profile } = await supabaseClient.from('profiles').select('role, nickname').eq('id', user.id).single();
                if (profile.role !== 'ç®¡ç†è€…') throw new Error('æ¬Šé™ä¸è¶³ï¼Œåƒ…é™ç®¡ç†è€…ç™»å…¥ã€‚');
                authorizeAndShowDashboard(profile);

            } catch (error) {
                showMessage(error.message.includes('Invalid') ? 'æš±ç¨±æˆ–å¯†ç¢¼éŒ¯èª¤ã€‚' : error.message, true);
            } finally {
                adminLoginButton.disabled = false; adminLoginButton.textContent = 'ç™»å…¥';
            }
        });

        function authorizeAndShowDashboard(profile) {
            adminUserInfo.textContent = `ç®¡ç†å“¡ï¼š${profile.nickname}`;
            adminLoginSection.classList.add('hidden');
            adminDashboardSection.classList.remove('hidden');
            loadAllAdminData();
        }

        //  å„ªåŒ–ç®¡ç†å“¡ç™»å‡ºé‚è¼¯ (v2.0 åŒæ­¥å‰å°æ¨™æº–)
        adminLogoutButton.addEventListener('click', async () => {
            // 1. æä¾›è¦–è¦ºå›é¥‹
            adminLogoutButton.disabled = true;
            adminLogoutButton.textContent = 'ç™»å‡ºä¸­...';

            // 2. åœæ­¢èƒŒæ™¯é€£ç·šæª¢æŸ¥
            if (dbConnectionInterval) clearInterval(dbConnectionInterval);

            try {
                // 3. å˜—è©¦é€šçŸ¥å¾Œç«¯ç™»å‡º
                await supabaseClient.auth.signOut();
            } catch (error) {
                console.warn('å¾Œå°ç™»å‡ºç•°å¸¸ (å¯å¿½ç•¥):', error);
            }
            
            // â˜… æ–°å¢ï¼šå¼·åˆ¶æ¸…é™¤æœ¬åœ°æš«å­˜ (èˆ‡å‰å°ä¸€è‡´ï¼Œé›™é‡ä¿éšª)
            localStorage.removeItem('sb-' + PUBLIC_KEY + '-auth-token');

            // 4. â˜… ä¿®æ”¹ï¼šä½¿ç”¨ replace è·³è½‰å› admin.html (é¿å… unload è­¦å‘Šï¼Œä¸¦é‡ç½®é é¢ç‹€æ…‹)
            window.location.replace('./admin.html');
        });

        function loadAllAdminData() {
            loadGlobalSettings();
            loadUsers();
            loadChallenges();
            loadSubscriptionStats(); // â˜… é—œéµï¼šè¼‰å…¥è¨‚é–±äººæ•¸
            setupAdminRealtime();
            checkDbConnection();
            dbConnectionInterval = setInterval(checkDbConnection, 30000);
        }

        async function checkDbConnection() {
            try {
                await invokeAdminFunction('ping', {});
                dbStatusLight.className = 'status-light bg-green-500';
                dbStatusLight.title = `è³‡æ–™åº«é€£ç·šæ­£å¸¸ (ä¸Šæ¬¡æª¢æŸ¥æ–¼ ${new Date().toLocaleTimeString()})`;
            } catch (error) {
                dbStatusLight.className = 'status-light bg-red-500';
                dbStatusLight.title = `è³‡æ–™åº«é€£ç·šç•°å¸¸ (ä¸Šæ¬¡æª¢æŸ¥æ–¼ ${new Date().toLocaleTimeString()})\néŒ¯èª¤: ${error.message}`;
            }
        }
        
        async function invokeAdminFunction(action, payload) {
            try {
                const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ action, payload })
                });
                if (error) throw error;
                if (data.error) throw new Error(data.error);
                return data;
            } catch (e) {
                console.error(`Edge Function [${action}] åŸ·è¡Œå¤±æ•—:`, e);
                throw e;
            }
        }

        addUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            addUserButton.disabled = true; addUserButton.textContent = 'æ–°å¢ä¸­...';
            const nickname = document.getElementById('new-nickname').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;
            try {
                await invokeAdminFunction('create-user', { nickname, password, role });
                showMessage(`ä½¿ç”¨è€… ${nickname} æ–°å¢æˆåŠŸï¼`, false);
                addUserForm.reset();
                loadUsers();
            } catch (error) {
                showMessage(`æ–°å¢å¤±æ•—: ${error.message}`, true);
            } finally {
                addUserButton.disabled = false; addUserButton.textContent = 'ç¢ºèªæ–°å¢';
            }
        });

        // ç›£è½åˆ—è¡¨æŒ‰éˆ•é»æ“Š (ç·¨è¼¯ / é‡è¨­å¯†ç¢¼ / æ”¹è§’è‰² / åˆªé™¤)
        userListBody.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            
            // 1. å…ˆå–å¾— ID
            const userId = target.dataset.id;
            
            // 2. â˜… é—œéµä¿®æ­£ï¼šå¾å…¨åŸŸè®Šæ•¸ allUsersData ä¸­æ‰¾å‡ºè©²ä½¿ç”¨è€…çš„ã€Œå®Œæ•´è³‡æ–™ã€
            // é€™æ¨£æ‰èƒ½ç¢ºä¿è®€å–åˆ°æœ€æ–°çš„ notes (å‚™è¨») æ¬„ä½
            userToEdit = allUsersData.find(u => u.id === userId);

            // é˜²å‘†ï¼šå¦‚æœæ‰¾ä¸åˆ° (ç†è«–ä¸Šä¸æ‡‰ç™¼ç”Ÿ)ï¼Œå°±é€€å›ç”¨ dataset
            if (!userToEdit) {
                const d = target.dataset;
                userToEdit = { id: d.id, nickname: d.nickname, role: d.role, notes: '' };
            }

            if (target.classList.contains('edit-user-button')) {
                // --- ç·¨è¼¯ä½¿ç”¨è€… ---
                document.getElementById('edit-user-id').value = userToEdit.id;
                document.getElementById('edit-user-old-nickname').value = userToEdit.nickname;
                document.getElementById('edit-nickname').value = userToEdit.nickname;
                
                // å¼·åˆ¶å¸¶å…¥å‚™è¨»ï¼Œè‹¥ç„¡å‰‡è¨­ç‚ºç©ºå­—ä¸² (æ¸…ç©ºä¸Šä¸€æ¬¡çš„å€¼)
                document.getElementById('edit-notes').value = userToEdit.notes || '';
                
                editUserModal.classList.remove('hidden');

            } else if (target.classList.contains('reset-password-button')) {
                // --- é‡è¨­å¯†ç¢¼ ---
                document.getElementById('reset-pw-nickname').textContent = userToEdit.nickname;
                resetPasswordModal.classList.remove('hidden');

            } else if (target.classList.contains('change-role-button')) {
                // --- è®Šæ›´è§’è‰² ---
                document.getElementById('change-role-nickname').textContent = userToEdit.nickname;
                document.getElementById('change-role-select').value = userToEdit.role;
                changeRoleModal.classList.remove('hidden');

            } else if (target.classList.contains('delete-user-button')) {
                // --- åˆªé™¤ä½¿ç”¨è€… ---
                const confirmationMessage = `ã€é«˜é¢¨éšªç®¡ç†å“¡æ“ä½œã€‘\n\næ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ä½¿ç”¨è€…ã€Œ${userToEdit.nickname}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œæœƒå°‡å…¶å¸³è™ŸåŠæ‰€æœ‰ç›¸é—œè³‡æ–™å¾ç³»çµ±ä¸­ç§»é™¤ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚`;
                if (confirm(confirmationMessage)) {
                    target.disabled = true; target.textContent = 'åˆªé™¤ä¸­';
                    try {
                        await invokeAdminFunction('delete-user', { userId: userToEdit.id });
                        showMessage(`ä½¿ç”¨è€… ${userToEdit.nickname} å·²æˆåŠŸåˆªé™¤ã€‚`, false);
                        loadUsers();
                    } catch (error) {
                        showMessage(`åˆªé™¤ä½¿ç”¨è€…å¤±æ•—: ${error.message}`, true);
                        target.disabled = false; target.textContent = 'åˆªé™¤';
                    }
                }
            }
        });

        cancelResetPwButton.addEventListener('click', () => resetPasswordModal.classList.add('hidden'));
        resetPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('reset-pw-input').value;
            try {
                await invokeAdminFunction('reset-user-password', { userId: userToEdit.id, password: newPassword });
                showMessage(`ä½¿ç”¨è€… ${userToEdit.nickname} çš„å¯†ç¢¼å·²æˆåŠŸé‡è¨­ã€‚`, false);
                resetPasswordModal.classList.add('hidden');
                loadUsers();
            } catch(error) { showMessage(`å¯†ç¢¼é‡è¨­å¤±æ•—: ${error.message}`, true); }
        });

        cancelChangeRoleButton.addEventListener('click', () => changeRoleModal.classList.add('hidden'));
        changeRoleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newRole = document.getElementById('change-role-select').value;
            try {
                await invokeAdminFunction('update-user-role', { userId: userToEdit.id, role: newRole });
                showMessage(`ä½¿ç”¨è€… ${userToEdit.nickname} çš„è§’è‰²å·²æ›´æ–°ç‚º ${newRole}ã€‚`, false);
                changeRoleModal.classList.add('hidden');
                loadUsers();
            } catch(error) { showMessage(`è§’è‰²è®Šæ›´å¤±æ•—: ${error.message}`, true); }
        });

        cancelEditUserButton.addEventListener('click', () => editUserModal.classList.add('hidden'));
        editUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = document.getElementById('submit-edit-user');
            submitButton.disabled = true; submitButton.textContent = 'å„²å­˜ä¸­...';

            const payload = {
                userId: document.getElementById('edit-user-id').value,
                oldNickname: document.getElementById('edit-user-old-nickname').value,
                newNickname: document.getElementById('edit-nickname').value,
                // â˜… æ–°å¢ï¼šå‚³é€å‚™è¨»
                notes: document.getElementById('edit-notes').value
            };

            try {
                // action åç¨±ç¶­æŒ update-user-nickname ä¸è®Š (å¾Œç«¯æœƒä¸€ä½µè™•ç†)
                await invokeAdminFunction('update-user-nickname', payload);
                showMessage(`ä½¿ç”¨è€…è³‡æ–™æ›´æ–°æˆåŠŸã€‚`, false);
                editUserModal.classList.add('hidden');
                loadUsers();
            } catch (error) {
                showMessage(`æ›´æ–°å¤±æ•—: ${error.message}`, true);
            } finally {
                submitButton.disabled = false; submitButton.textContent = 'ç¢ºèªå„²å­˜';
            }
        });

        async function loadChallenges() {
            challengeListAdmin.innerHTML = '<p class="text-gray-400">è®€å–ä¸­...</p>';
            try {
                // 1. è®€å–ä¸€èˆ¬/å¤§è²å…¬æŒ‘æˆ° (ç›´æ¥æŸ¥è³‡æ–™è¡¨)
                const { data: challenges, error: dbError } = await supabaseClient
                    .from('challenges')
                    .select('*, host:profiles(nickname), signups(profile:profiles(nickname))')
                    .order('created_at', { ascending: false });
                
                if(dbError) throw dbError;

                // 2. è®€å–è‡ªé£›æŒ‘æˆ° (å‘¼å« Edge Function)
                // â˜… ä¿®æ”¹ï¼šä¸ä½¿ç”¨è§£æ§‹è³¦å€¼ï¼Œç›´æ¥å–å¾—å›æ‡‰ç‰©ä»¶
                const flyResponse = await invokeAdminFunction('list-guest-fly', {});
                // ç¢ºä¿å–å¾—çš„æ˜¯é™£åˆ— (flyResponse.data æ‰æ˜¯çœŸæ­£çš„é™£åˆ—)
                const flyList = flyResponse.data || [];

                // 3. æ¨™è¨˜è³‡æ–™é¡å‹ä¸¦åˆä½µ
                const normalItems = (challenges || []).map(c => ({ ...c, dataType: 'normal' }));
                const flyItems = (flyList || []).map(f => ({ ...f, dataType: 'fly' }));

                const allItems = [...normalItems, ...flyItems].sort((a, b) => {
                    // ä½¿ç”¨ created_at é€²è¡Œçµ±ä¸€æ’åº
                    const timeA = new Date(a.created_at).getTime();
                    const timeB = new Date(b.created_at).getTime();
                    return timeB - timeA; // å€’åº
                });

                // 4. æ¸²æŸ“
                if(allItems.length === 0) { 
                    challengeListAdmin.innerHTML = `<p class="text-gray-500">ç›®å‰æ²’æœ‰ä»»ä½•æŒ‘æˆ°ã€‚</p>`; 
                    return; 
                }
                
                challengeListAdmin.innerHTML = '';          
                allItems.forEach(item => {
                    if (item.dataType === 'fly') {
                        renderAdminFlyCard(item);
                    } else {
                        renderAdminChallengeCard(item);
                    }
                });

            } catch (error) {
                console.error(error);
                challengeListAdmin.innerHTML = `<p class="text-red-400">ç„¡æ³•è¼‰å…¥åˆ—è¡¨: ${error.message}</p>`;
            }
        }
        
        function renderAdminChallengeCard(challenge) {
            const card = document.createElement('div');
            card.className = 'challenge-card p-4';
            card.id = `admin-challenge-${challenge.id}`;
            
            const statusClass = challenge.status === 'é–‹æ”¾å ±åä¸­' ? 'bg-green-600' : (challenge.status === 'å·²é¡æ»¿' ? 'bg-red-600' : 'bg-yellow-600');
            const signupCount = challenge.signups ? challenge.signups.length : 0;

            let dispatchTagHtml = '';
            if (signupCount > 0) {
                const dispatchStatus = challenge.dispatch_status || 'å¾…ç™¼';
                const dispatchClass = dispatchStatus === 'å·²ç™¼' ? 'bg-teal-500' : 'bg-gray-600';
                dispatchTagHtml = `<span class="text-xs font-bold px-2 py-1 rounded-full text-white ${dispatchClass}">${dispatchStatus}</span>`;
            }

            let participantsHtml = '';
            if (signupCount > 0) {
                const participantsList = challenge.signups.map((signup) => `<span class="text-xs bg-gray-700 px-2 py-1 rounded">${signup.profile?.nickname || 'æœªçŸ¥'}</span>`).join(' ');
                participantsHtml = `<div class="mt-2 flex flex-wrap gap-2 items-center">${participantsList}</div>`;
            }

            // â˜… æ•´åˆé‚è¼¯ï¼šé¡¯ç¤ºåç¨±å„ªå…ˆé †åº (Host -> Display -> æœªçŸ¥)
            const hostName = challenge.host?.nickname || challenge.display_host_name || 'æœªçŸ¥';
            
            // â˜… æ•´åˆé‚è¼¯ï¼šè¨ªå®¢æ¨™ç±¤
            const guestLabel = challenge.is_guest ? '<span class="text-[10px] bg-pink-800 text-white px-1 rounded ml-1 border border-pink-500">è¨ªå®¢</span>' : '';

            card.innerHTML = `
            <div class="flex flex-col justify-between h-full">
                
                <div>
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-lg font-bold text-gray-100">
                        ${challenge.mushroom_type} 
                        <span class="ml-2 text-sm text-gray-500">#${challenge.id}</span>
                    </h3>
                    <div class="flex items-center space-x-2">
                    ${dispatchTagHtml}
                    <span class="text-xs font-bold px-2 py-1 rounded-full text-white ${statusClass}">
                        ${challenge.status === 'é–‹æ”¾å ±åä¸­' ? 'å ±åä¸­' : challenge.status}
                    </span>
                    </div>
                </div>

                <div class="text-sm text-gray-400 space-y-1">
                    <p><strong>ç™¼å¸ƒè€…:</strong> ${hostName} ${guestLabel}</p>
                    <p><strong>åé¡:</strong> ${signupCount} / ${challenge.slots}</p>
                    <p><strong>é–‹æ”¾æ™‚é–“:</strong> ${new Date(challenge.start_time).toLocaleString('zh-TW', { hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</p>
                </div>

                ${participantsHtml}
                </div>

                <div>
                <button data-id="${challenge.id}" class="delete-challenge-admin-button mt-4 w-full text-white font-bold py-2 px-4 rounded-lg bg-red-800 hover:bg-red-700 transition">
                    åˆªé™¤
                </button>
                </div>
                
            </div>
            `;
            challengeListAdmin.appendChild(card); 
        }

        function renderAdminFlyCard(f) {
            const card = document.createElement('div');
            card.className = 'challenge-card p-4 border-cyan-800 bg-gray-800/50'; // åŠ ä¸Šä¸€é»è—è‰²ç³»å€éš”
            card.id = `admin-fly-${f.id}`;
            
            const postTime = new Date(f.created_at).toLocaleString('zh-TW', { hour12: false, month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
            const type = f.mushroom_type || 'è‡ªé£›è‡';

            card.innerHTML = `
            <div class="flex flex-col justify-between h-full">
                <div>
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-bold text-cyan-400 flex items-center gap-2">
                            <span>âœˆï¸</span> ${type}
                            <span class="text-sm text-gray-500">#${f.id}</span>
                        </h3>
                        <span class="text-xs font-bold px-2 py-1 rounded-full text-white bg-cyan-600">
                            è‡ªé£›
                        </span>
                    </div>

                    <div class="text-sm text-gray-400 space-y-1.5">
                        <p><strong>ç™¼å¸ƒè€…:</strong> ${f.nickname} <span class="text-xs text-gray-500">(${f.friend_code})</span></p>
                        <p><strong>ç™¼å¸ƒæ™‚é–“:</strong> ${postTime}</p>
                        <p><strong>åé¡:</strong> ${f.slots}</p>
                        <div class="bg-gray-900/50 p-2 rounded border border-gray-700 font-mono text-xs truncate">
                            ${f.coordinates}
                        </div>
                        <p class="text-xs text-gray-500">å‚™è¨»: ${f.notes || 'ç„¡'}</p>
                    </div>
                </div>

                <div>
                    <button data-id="${f.id}" data-type="fly" class="delete-challenge-admin-button mt-4 w-full text-white font-bold py-2 px-4 rounded-lg bg-red-800 hover:bg-red-700 transition">
                        åˆªé™¤ (è‡ªé£›)
                    </button>
                </div>
            </div>
            `;
            challengeListAdmin.appendChild(card);
        }

        challengeListAdmin.addEventListener('click', async (e) => {
            const button = e.target.closest('.delete-challenge-admin-button');
            if(!button) return;
            
            const id = button.dataset.id;
            const type = button.dataset.type || 'normal'; // é è¨­ç‚º normal
            const name = type === 'fly' ? 'è‡ªé£›æŒ‘æˆ°' : 'æŒ‘æˆ°';

            if (confirm(`ã€ç®¡ç†å“¡æ“ä½œã€‘\næ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹ ID ç‚º ${id} çš„${name}å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                button.disabled = true; button.textContent = 'åˆªé™¤ä¸­...';
                try {
                    if (type === 'fly') {
                        // åˆªé™¤è‡ªé£›
                        await invokeAdminFunction('guest-delete-fly', { id: id });
                    } else {
                        // åˆªé™¤ä¸€èˆ¬
                        await invokeAdminFunction('delete-challenge', { challengeId: id });
                    }
                    
                    showMessage(`${name} ${id} å·²æˆåŠŸåˆªé™¤ã€‚`, false);
                    loadChallenges(); // é‡æ–°æ•´ç†åˆ—è¡¨
                } catch(error) {
                    showMessage(`åˆªé™¤å¤±æ•—: ${error.message}`, true); 
                    button.disabled = false; button.textContent = 'åˆªé™¤';
                }
            }
        });

        function setupAdminRealtime() {
            supabaseClient.channel('admin-realtime')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'challenges' }, loadChallenges)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, loadUsers) 
                .subscribe();
        }

        async function loadGlobalSettings() {
            settingsStatusText.textContent = 'è®€å–ä¸­...';
            try {
                const { data, error } = await invokeAdminFunction('get-daily-limit', {});
                
                if (error) throw error;

                if (data) {
                    dailyLimitInput.value = data.setting_value;
                    settingsStatusText.textContent = `ä¸Šæ¬¡æ›´æ–°æ–¼ ${new Date().toLocaleTimeString()}`;
                } else {
                    dailyLimitInput.placeholder = 'æœªè¨­å®š';
                    settingsStatusText.textContent = 'åœ¨è³‡æ–™åº«ä¸­æ‰¾ä¸åˆ°è¨­å®šå€¼ã€‚';
                }
            } catch (error) {
                dailyLimitInput.placeholder = 'éŒ¯èª¤';
                settingsStatusText.textContent = `è®€å–å¤±æ•—: ${error.message}`;
            }
        }

        saveSettingsButton.addEventListener('click', async () => {
            const newValue = parseInt(dailyLimitInput.value);
            if (isNaN(newValue) || newValue < 0) {
                showMessage('è«‹è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„æ­£æ•´æ•¸ã€‚', true);
                return;
            }

            saveSettingsButton.disabled = true;
            saveSettingsButton.textContent = 'å„²å­˜ä¸­...';
            settingsStatusText.textContent = '';

            try {
                const { error } = await invokeAdminFunction('set-daily-limit', { value: newValue });
                
                if (error) throw error;

                showMessage('æ¯æ—¥å ±åä¸Šé™å·²æˆåŠŸæ›´æ–°ï¼', false);
                settingsStatusText.textContent = `æ›´æ–°æˆåŠŸæ–¼ ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                showMessage(`æ›´æ–°å¤±æ•—: ${error.message}`, true);
                settingsStatusText.textContent = `æ›´æ–°å¤±æ•—ã€‚`;
            } finally {
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = 'å„²å­˜è®Šæ›´';
            }
        });

        // --- ç®¡ç†å“¡é¸å–®è®Šæ•¸ ---
        const adminInput = document.getElementById('admin-nickname-input');
        const adminDropdown = document.getElementById('admin-nickname-dropdown');
        let adminNicknames = [];

        async function populateNicknames() {
            try {
                // åªæ’ˆå–ç®¡ç†å“¡
                const { data, error } = await supabaseClient.from('profiles').select('nickname').eq('role', 'ç®¡ç†è€…').order('nickname');
                if (error) throw error;
                
                adminNicknames = data.map(p => p.nickname);
                renderAdminDropdown(adminNicknames);
            } catch (error) {
                adminInput.placeholder = 'ç„¡æ³•è¼‰å…¥';
            }
        }

        function renderAdminDropdown(items) {
            adminDropdown.innerHTML = '';
            if (items.length === 0) {
                adminDropdown.innerHTML = '<div class="dropdown-option text-center text-gray-500">ç„¡ç®¡ç†å“¡</div>';
                return;
            }
            items.forEach(name => {
                const div = document.createElement('div');
                div.className = 'dropdown-option';
                div.textContent = name;
                div.addEventListener('click', () => {
                    adminInput.value = name;
                    adminDropdown.classList.remove('show');
                });
                adminDropdown.appendChild(div);
            });
        }

        // äº’å‹•äº‹ä»¶
        adminInput.addEventListener('click', () => {
            renderAdminDropdown(adminNicknames);
            adminDropdown.classList.add('show');
        });
        
        adminInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = adminNicknames.filter(n => n.toLowerCase().includes(term));
            renderAdminDropdown(filtered);
            adminDropdown.classList.add('show');
        });

        document.addEventListener('click', (e) => {
            if (!adminInput.contains(e.target) && !adminDropdown.contains(e.target)) {
                adminDropdown.classList.remove('show');
            }
        });
        
        function showMessage(text, isError) {
            adminMessageBox.textContent = text;
            adminMessageBox.className = `p-4 text-center text-sm rounded-xl ${isError ? 'bg-red-500/50 text-red-300' : 'bg-green-500/50 text-green-300'}`;
            setTimeout(() => {
                if (adminMessageBox.textContent === text) { adminMessageBox.className += ' hidden'; }
            }, 5000);
        }
        
        async function checkInitialSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                const { data: profile } = await supabaseClient.from('profiles').select('role, nickname').eq('id', session.user.id).single();
                if (profile && profile.role === 'ç®¡ç†è€…') {
                    authorizeAndShowDashboard(profile);
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            populateNicknames();
            checkInitialSession();
        });
        
    // è¼‰å…¥ç•™è¨€åˆ—è¡¨ (æœ€çµ‚ç‰ˆï¼šé«˜åº¦ 60vh + èˆŠä¸Šæ–°ä¸‹ + è‡ªå‹•æ²åº•)
    async function loadAdminMessages() {
        const listEl = document.getElementById('admin-msg-list');
        const containerEl = document.getElementById('admin-msg-container');
        const checkAllBox = document.getElementById('msg-check-all');
        const batchBtn = document.getElementById('btn-batch-del');
        
        // 1. åˆå§‹åŒ–æŒ‰éˆ•ç‹€æ…‹
        if (checkAllBox) checkAllBox.checked = false;
        if (batchBtn) {
            batchBtn.classList.add('hidden');       
            batchBtn.disabled = false;              
            batchBtn.innerHTML = `<span>ğŸ—‘ï¸</span> åˆªé™¤é¸å– (0)`; 
        }

        try {
            // 2. æŠ“å–è³‡æ–™ (ä¾ç„¶æ˜¯æŠ“ã€Œæœ€æ–°çš„ã€300 ç­†)
            const { data, error } = await supabaseClient
                .from('guest_messages')
                .select('*')
                .order('created_at', { ascending: false }) 
                .limit(300);

            if (error) throw error;

            if (!data || data.length === 0) {
                listEl.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">ç›®å‰æ²’æœ‰ç•™è¨€</td></tr>';
                return;
            }

            // 3. â˜… é—œéµæ­¥é©Ÿï¼šåè½‰é™£åˆ—
            // åŸæœ¬æ˜¯ [æœ€æ–°...æœ€èˆŠ]ï¼Œåè½‰å¾Œè®Šæˆ [æœ€èˆŠ...æœ€æ–°]
            // é€™æ¨£æ¸²æŸ“å‡ºä¾†ï¼Œæœ€æ–°çš„å°±æœƒåœ¨è¡¨æ ¼çš„æœ€ä¸‹é¢
            const displayData = data.reverse();

            listEl.innerHTML = displayData.map(msg => {
                const time = new Date(msg.created_at).toLocaleString('zh-TW', { hour12: false });
                const safeMsg = msg.message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                
                return `
                    <tr class="bg-gray-800 hover:bg-gray-700/50 transition group">
                        <td class="p-4 w-10">
                            <div class="flex items-center">
                                <input type="checkbox" value="${msg.id}" class="msg-checkbox w-4 h-4 text-blue-600 bg-gray-700 border-gray-500 rounded focus:ring-blue-500 focus:ring-2 cursor-pointer">
                            </div>
                        </td>
                        <td class="px-4 py-3 font-mono text-xs whitespace-nowrap text-gray-500">${time}</td>
                        <td class="px-4 py-3 font-bold text-indigo-300 whitespace-nowrap">${msg.nickname}</td>
                        <td class="px-4 py-3 text-gray-300 break-all">${safeMsg}</td>
                        <td class="px-4 py-3 text-right whitespace-nowrap">
                            <button onclick="deleteMessage(${msg.id})" class="text-red-400 hover:text-red-200 text-xs px-3 py-1 rounded hover:bg-red-900/30 transition border border-transparent hover:border-red-800 whitespace-nowrap">
                                åˆªé™¤
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // 4. é‡æ–°ç¶å®šå‹¾é¸äº‹ä»¶
            bindCheckboxEvents();

            // 5. â˜… é—œéµæ­¥é©Ÿï¼šè‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
            if (containerEl) {
                // ä½¿ç”¨ setTimeout ç¢ºä¿ç•«é¢æ¸²æŸ“å®Œæˆå¾Œæ‰åŸ·è¡Œæ²å‹•
                setTimeout(() => {
                    containerEl.scrollTop = containerEl.scrollHeight;
                }, 50); // ç¨å¾®å¢åŠ ä¸€é»å»¶é²ç¢ºä¿ç©©å®š
            }

        } catch (err) {
            console.error(err);
            listEl.innerHTML = `<tr><td colspan="5" class="px-4 py-8 text-center text-red-500">è®€å–å¤±æ•—: ${err.message}</td></tr>`;
        }
    }

    // è™•ç†å‹¾é¸é€£å‹•é‚è¼¯ (ä¿®æ­£ç‰ˆï¼šé˜²æ­¢ null éŒ¯èª¤)
    function bindCheckboxEvents() {
        const checkAllBox = document.getElementById('msg-check-all');
        const checkboxes = document.querySelectorAll('.msg-checkbox');
        const batchBtn = document.getElementById('btn-batch-del');

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹å‡½å¼
        const updateBtnState = () => {
            if (!batchBtn) return; // é˜²å‘†ï¼šå¦‚æœæŒ‰éˆ•æ²’ç•«å‡ºä¾†å°±è·³é

            const checkedCount = document.querySelectorAll('.msg-checkbox:checked').length;
            
            if (checkedCount > 0) {
                batchBtn.classList.remove('hidden');
                // â˜… ä¿®æ”¹ï¼šç›´æ¥æ›´æ–°æŒ‰éˆ•å…§çš„ HTMLï¼Œä¸ä¾è³´ batch-count span
                batchBtn.innerHTML = `<span>ğŸ—‘ï¸</span> åˆªé™¤é¸å– (${checkedCount})`;
            } else {
                batchBtn.classList.add('hidden');
            }
        };

        // 1. å…¨é¸æ¡†è¢«é»æ“Š
        if (checkAllBox) {
            checkAllBox.onchange = () => {
                checkboxes.forEach(cb => cb.checked = checkAllBox.checked);
                updateBtnState();
            };
        }

        // 2. å–®ä¸€æ¡†è¢«é»æ“Š
        checkboxes.forEach(cb => {
            cb.onchange = () => {
                const allChecked = document.querySelectorAll('.msg-checkbox:checked').length === checkboxes.length;
                if (checkAllBox) checkAllBox.checked = allChecked;
                updateBtnState();
            };
        });
    }

    // æ‰¹é‡åˆªé™¤å‡½å¼
    async function batchDeleteMessages() {
        const checkedBoxes = document.querySelectorAll('.msg-checkbox:checked');
        const ids = Array.from(checkedBoxes).map(cb => cb.value);

        if (ids.length === 0) return;

        if (!confirm(`ç¢ºå®šè¦åˆªé™¤é€™ ${ids.length} å‰‡ç•™è¨€å—ï¼Ÿ(ç„¡æ³•å¾©åŸ)`)) return;

        const batchBtn = document.getElementById('btn-batch-del');
        const originalText = batchBtn.innerHTML; // æš«å­˜åŸæœ¬æ–‡å­—
        batchBtn.disabled = true;
        batchBtn.innerHTML = 'è™•ç†ä¸­...';

        try {
            const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                body: JSON.stringify({ 
                    action: 'admin-batch-delete-messages', 
                    payload: { ids: ids } 
                })
            });

            if (error) throw error;
            if (data && data.error) throw new Error(data.error);

            // alert('åˆªé™¤æˆåŠŸï¼'); 
            
            // â˜… åˆªé™¤é€™è¡Œï¼šloadAdminMessages();
            // è®“ Realtime å»åˆ·æ–°åˆ—è¡¨

        } catch (err) {
            console.error(err);
            alert(`åˆªé™¤å¤±æ•—: ${err.message}`);
            // åªæœ‰å¤±æ•—æ™‚æ‰éœ€è¦æ‰‹å‹•æ¢å¾©æŒ‰éˆ•ï¼ŒæˆåŠŸæ™‚ loadAdminMessages æœƒé‡ç¹ªæ•´å€‹å€å¡Š
            batchBtn.disabled = false;
            batchBtn.innerHTML = originalText;
        }
    }

    // åˆªé™¤å–®ä¸€ç•™è¨€
    async function deleteMessage(id) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡ç•™è¨€å—ï¼Ÿ(æ­¤æ“ä½œç„¡æ³•å¾©åŸ)')) return;

        try {
            // å‘¼å«å¾Œç«¯ Function é€²è¡Œåˆªé™¤
            const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                body: JSON.stringify({ 
                    action: 'admin-delete-message', 
                    payload: { id: id } 
                })
            });

            if (error) throw error;
            if (data && data.error) throw new Error(data.error);

        } catch (err) {
            alert(`åˆªé™¤å¤±æ•—: ${err.message}`);
        }
    }

    // æ¸…ç©ºæ‰€æœ‰ç•™è¨€
    async function clearAllMessages() {
        const confirmCode = Math.floor(Math.random() * 9000) + 1000;
        const userInput = prompt(`è­¦å‘Šï¼šé€™å°‡åˆªé™¤ã€Œæ‰€æœ‰ã€ç•™è¨€ï¼\n\nè«‹è¼¸å…¥é©—è­‰ç¢¼ ${confirmCode} ç¢ºèªåŸ·è¡Œï¼š`);
        
        if (userInput != confirmCode) {
            if(userInput !== null) alert('é©—è­‰ç¢¼éŒ¯èª¤ï¼Œå–æ¶ˆæ“ä½œ');
            return;
        }

        try {
            const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                body: JSON.stringify({ 
                    action: 'admin-clear-chat' 
                })
            });

            if (error) throw error;
            if (data && data.error) throw new Error(data.error);

            alert('æ‰€æœ‰ç•™è¨€å·²æ¸…ç©ºï¼');
            loadAdminMessages();

        } catch (err) {
            alert(`æ“ä½œå¤±æ•—: ${err.message}`);
        }
    }

    // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
    document.addEventListener('DOMContentLoaded', () => {
        loadAdminMessages();
        setupAdminMessageRealtime();
    });

    // â˜…â˜…â˜… Admin ç•™è¨€æ¿å³æ™‚ç›£è½ç³»çµ± â˜…â˜…â˜…
    function setupAdminMessageRealtime() {
        let refreshTimer = null;
        
        // å®šç¾©åˆ·æ–°é‚è¼¯ï¼šå»¶é² 0.5 ç§’åŸ·è¡Œï¼Œé¿å…é€£çºŒè§¸ç™¼
        const debouncedReload = () => {
            if (refreshTimer) clearTimeout(refreshTimer);
            refreshTimer = setTimeout(() => {
                console.log('ğŸ”„ Admin: åµæ¸¬åˆ°ç•™è¨€è®Šå‹•ï¼Œæ­£åœ¨åˆ·æ–°åˆ—è¡¨...');
                loadAdminMessages(); 
            }, 500);
        };

        // ç›£è½ guest_messages è¡¨çš„æ‰€æœ‰è®Šå‹• (æ–°å¢ã€åˆªé™¤)
        supabaseClient.channel('admin-msg-realtime')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'guest_messages' }, (payload) => {
                // æ”¶åˆ°è¨Šè™Ÿï¼ŒåŸ·è¡Œåˆ·æ–°
                debouncedReload();
            })
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    console.log('âœ… å¾Œå°ç•™è¨€æ¿å·²é€£ç·š (Realtime)');
                }
            });
    }
    </script>
</body>
</html>