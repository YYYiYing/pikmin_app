<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>ç®¡ç†å¾Œå° - è‡è‡å®…é…ç¶²</title> <script src="https://cdn.tailwindcss.com"></script> <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> <style>
        /* CSS è¨»è§£ï¼šä»¥ä¸‹æ˜¯æœ¬é é¢çš„æ¨£å¼è¨­å®š */
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #111827; color: #d1d5db; }
        .admin-container { background-color: #1f2937; border: 1px solid #374151; }
        .dark-input { background-color: #374151; border-color: #4b5563; color: #d1d5db; }
        .dark-input:focus { --tw-ring-color: #fb923c; border-color: #fb923c; } /* ç®¡ç†å¾Œå°çš„è¼¸å…¥æ¡†ï¼Œç„¦é»é¡è‰²æ”¹ç‚ºæ©˜è‰²ç³» */
        .admin-button { background-color: #f97316; transition: background-color 0.2s ease-in-out; } /* ä¸»è¦æŒ‰éˆ•ä½¿ç”¨æ©˜è‰²ç³» */
        .admin-button:hover:not(:disabled) { background-color: #ea580c; } /* æ»‘é¼ æ‡¸æµ®åœ¨å¯ç”¨çš„ä¸»è¦æŒ‰éˆ•ä¸Šæ™‚ï¼ŒåŠ æ·±é¡è‰² */
        .secondary-button { background-color: #4b5563; color: white; } /* æ¬¡è¦æŒ‰éˆ•ï¼ˆå¦‚å–æ¶ˆï¼‰ä½¿ç”¨ç°è‰²ç³» */
        .secondary-button:hover { background-color: #6b7280; }
        .table-header { background-color: #374151; } /* ä½¿ç”¨è€…åˆ—è¡¨çš„è¡¨é ­èƒŒæ™¯è‰² */
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); } /* å½ˆå‡ºè¦–çª—ï¼ˆModalï¼‰çš„åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
        .challenge-card { background-color: #1f2937; border: 1px solid #374151; transition: transform 0.3s ease, box-shadow 0.3s ease; display: flex; flex-direction: column; justify-content: space-between; }
        .status-light { width: 0.75rem; height: 0.75rem; border-radius: 9999px; transition: background-color 0.3s ease-in-out; } /* è³‡æ–™åº«é€£ç·šç‹€æ…‹çš„æŒ‡ç¤ºç‡ˆ */
        
        /* â˜… æ–°å¢ï¼šå¯æ’åºæ¨™é ­çš„æ¨£å¼ */
        .sortable-header { 
            cursor: pointer; /* ç•¶æ»‘é¼ ç§»åˆ°æ¨™é ­ä¸Šæ™‚ï¼Œé¡¯ç¤ºç‚ºå¯é»æ“Šçš„æ‰‹å½¢åœ–ç¤º */
            user-select: none; /* é˜²æ­¢ä½¿ç”¨è€…åœ¨å¿«é€Ÿé»æ“Šæ™‚é¸å–åˆ°æ¨™é ­æ–‡å­—ï¼Œæå‡é«”é©— */
            transition: background-color 0.2s; /* è®“èƒŒæ™¯è‰²è®ŠåŒ–æœ‰å¹³æ»‘çš„éæ¸¡æ•ˆæœ */
        }
        .sortable-header:hover { 
            background-color: #4b5563; /* æ»‘é¼ æ‡¸æµ®æ™‚ï¼Œæ”¹è®ŠèƒŒæ™¯è‰²ä»¥æä¾›è¦–è¦ºå›é¥‹ */
        }
        .sort-indicator { 
            color: #f97316; /* æ’åºæŒ‡ç¤ºç¬¦è™Ÿï¼ˆâ–²â–¼ï¼‰çš„é¡è‰² */
            margin-left: 6px; /* é›¢æ¨™é ­æ–‡å­—çš„è·é›¢ */
            font-size: 0.7rem; /* ç¬¦è™Ÿçš„å­—é«”å¤§å° */
            vertical-align: middle; /* è®“ç¬¦è™Ÿèƒ½å’Œæ–‡å­—å‚ç›´å°é½Š */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="admin-login-section" class="admin-container w-full max-w-md p-8 space-y-8 rounded-2xl shadow-2xl">
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-100">ç®¡ç†å¾Œå°</h1>
            <p class="mt-2 text-gray-400">è«‹ä½¿ç”¨ç®¡ç†è€…å¸³è™Ÿç™»å…¥</p>
        </div>
        <form id="admin-login-form" class="space-y-6">
            <div>
                <label for="admin-nickname-select" class="text-sm font-bold text-gray-400">ç®¡ç†å“¡æš±ç¨±</label>
                <select id="admin-nickname-select" name="nickname" required class="dark-input w-full px-4 py-3 mt-1 rounded-xl focus:outline-none appearance-none">
                    <option value="" disabled selected>è®€å–ä¸­...</option>
                </select>
            </div>
            <div>
                <label for="admin-password" class="text-sm font-bold text-gray-400">å¯†ç¢¼</label>
                <input id="admin-password" name="password" type="password" autocomplete="current-password" required class="dark-input w-full px-4 py-3 mt-1 rounded-xl focus:outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <div>
                <button type="submit" id="admin-login-button" class="admin-button w-full px-4 py-3 font-bold text-white rounded-xl focus:outline-none disabled:opacity-50">ç™»å…¥</button>
            </div>
        </form>
        <div id="admin-message-box" class="p-4 text-center text-sm rounded-xl hidden"></div> <a href="./dashboard.html" class="block text-center text-indigo-400 hover:text-indigo-300 mt-4 text-sm">è¿”å›ä¸»é </a>
    </div>

    <div id="admin-dashboard-section" class="hidden w-full max-w-7xl mx-auto">
        <header class="mb-8 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-white">ç®¡ç†ä¸­å¿ƒ</h1>
            <div>
                <span id="admin-user-info" class="font-semibold text-gray-300 mr-4"></span> <a href="./dashboard.html" class="text-indigo-400 hover:text-indigo-300 mr-4">è¿”å›ä¸»é </a>
                <button id="admin-logout-button" class="bg-red-700 text-white px-4 py-2 text-sm rounded-lg font-bold hover:bg-red-600 transition">ç™»å‡º</button>
            </div>
        </header>

        <div id="global-settings-section" class="mb-8 admin-container rounded-2xl p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <div>
                    <div class="flex flex-col gap-6">
                        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-indigo-400">ğŸ“§ å ±åé€šçŸ¥åå–®</h3>
                                <span id="sub-count" class="text-xs bg-indigo-900 text-indigo-200 px-2 py-1 rounded-full">è®€å–ä¸­...</span>
                            </div>
                            <button id="copy-subs-button" class="admin-button w-full py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2">
                                ğŸ“‹ è¤‡è£½å ±åæ¸…å–®
                            </button>
                        </div>

                        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-pink-400">ğŸ”” é¡æ»¿é€šçŸ¥åå–®</h3>
                                <span id="full-sub-count" class="text-xs bg-pink-900 text-pink-200 px-2 py-1 rounded-full">è®€å–ä¸­...</span>
                            </div>
                            <button id="copy-full-subs-button" class="secondary-button w-full py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2 hover:bg-pink-900 border border-pink-700">
                                ğŸ“‹ è¤‡è£½é¡æ»¿æ¸…å–®
                            </button>
                        </div>

                        <div class="pt-4 border-t border-gray-700 space-y-3">
                            <label class="block text-sm font-medium text-gray-400">ç³»çµ±æ’ç¨‹èˆ‡æ¸¬è©¦</label>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <button id="trigger-check-button" class="bg-teal-600 hover:bg-teal-500 text-white px-2 py-2 rounded-lg font-bold text-sm flex items-center justify-center gap-1">
                                    âš¡ ç«‹å³ç™¼é€å ±åé€šçŸ¥
                                </button>
                                <button id="send-test-email-button" class="secondary-button px-2 py-2 rounded-lg font-bold text-sm border border-gray-500 hover:bg-gray-600 flex items-center justify-center gap-1">
                                    ğŸ“¨ ç™¼é€é€£ç·šæ¸¬è©¦ä¿¡
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">èªªæ˜ï¼šå·¦å´æŒ‰éˆ•ç­‰åŒæ–¼æ‰‹å‹•è§¸ç™¼æ’ç¨‹æª¢æŸ¥ï¼›å³å´æŒ‰éˆ•åƒ…æ¸¬è©¦ç³»çµ±ç™¼ä¿¡åŠŸèƒ½æ˜¯å¦æ­£å¸¸ã€‚</p>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col justify-start">
                    <h2 class="text-xl font-bold mb-4">âš™ï¸ ç³»çµ±å…¨åŸŸè¨­å®š</h2>
                     <div class="flex items-center gap-4 pt-2">
                        <label for="daily-limit-input" class="text-lg font-medium whitespace-nowrap">æ¯æ—¥å ±åä¸Šé™ï¼š</label>
                        <input type="number" id="daily-limit-input" min="1" class="dark-input w-24 rounded-md text-center" placeholder="è®€å–ä¸­...">
                        <button id="save-settings-button" class="admin-button px-4 py-2 rounded-lg font-bold text-sm disabled:opacity-50">å„²å­˜</button>
                    </div>
                    <span id="settings-status-text" class="text-sm text-gray-400 mt-2 block"></span>
                </div>
            </div>
        </div>

        <div class="mb-8 admin-container rounded-2xl p-6">
            <div class="flex items-center space-x-2 mb-4">
                <h2 class="text-xl font-bold">è˜‘è‡æŒ‘æˆ°ç®¡ç†</h2>
                <div id="db-status-light" class="status-light bg-gray-500" title="æ­£åœ¨æª¢æŸ¥è³‡æ–™åº«é€£ç·š..."></div> 
            </div>
            <div id="challenge-list-admin" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto">
                <p>è®€å–ä¸­...</p> 
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 admin-container rounded-2xl p-6">
                <h2 class="text-xl font-bold mb-4">ç¾æœ‰ä½¿ç”¨è€…åˆ—è¡¨</h2>
                <div class="overflow-x-auto max-h-[60vh]">
                    <table class="w-full text-left">
                        <thead id="user-table-header" class="table-header sticky top-0"> 
                            <tr>
                                <th class="p-3 sortable-header" data-sort-key="nickname">æš±ç¨±<span class="sort-indicator"></span></th>
                                <th class="p-3 sortable-header" data-sort-key="role">è§’è‰²<span class="sort-indicator"></span></th>
                                <th class="p-3 sortable-header text-center" data-sort-key="monthly_signup_count">åƒèˆ‡åº¦<span class="sort-indicator"></span></th>
                                <th class="p-3 sortable-header" data-sort-key="last_active_at">æœ€å¾Œæ´»èº<span class="sort-indicator"></span></th>
                                <th class="p-3 text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="user-list-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="space-y-8">
                <div class="admin-container rounded-2xl p-6">
                    <h2 class="text-xl font-bold mb-4">æ–°å¢ä½¿ç”¨è€…</h2>
                    <form id="add-user-form" class="space-y-4">
                        <div><label for="new-nickname" class="text-sm font-medium">æš±ç¨±</label><input type="text" id="new-nickname" required class="dark-input mt-1 w-full rounded-md"></div>
                        <div><label for="new-password" class="text-sm font-medium">é è¨­å¯†ç¢¼</label><input type="text" id="new-password" required class="dark-input mt-1 w-full rounded-md" value="000000"></div>
                        <div><label for="new-role" class="text-sm font-medium">è§’è‰²</label><select id="new-role" required class="dark-input mt-1 w-full rounded-md"><option value="å ±åè€…">å ±åè€…</option><option value="ç™¼è‡è€…">ç™¼è‡è€… (åƒ…ç™¼)</option><option value="ç™¼è‡åŠå ±åè€…">ç™¼è‡åŠå ±åè€…</option><option value="ç®¡ç†è€…">ç®¡ç†è€…</option></select></div>
                        <button type="submit" id="add-user-button" class="admin-button w-full py-2 rounded-lg font-bold disabled:opacity-50">ç¢ºèªæ–°å¢</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div id="reset-password-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="admin-container w-full max-w-sm p-8 rounded-2xl shadow-2xl">
            <h2 class="text-xl font-bold mb-2 text-white">é‡è¨­å¯†ç¢¼</h2>
            <p class="text-gray-400 mb-6">æ­£åœ¨ç‚º <strong id="reset-pw-nickname" class="text-orange-300"></strong> é‡è¨­å¯†ç¢¼ã€‚</p>
            <form id="reset-password-form">
                <label for="reset-pw-input" class="text-sm font-medium">æ–°å¯†ç¢¼ (è‡³å°‘6ä½æ•¸)</label>
                <input type="text" id="reset-pw-input" required minlength="6" class="dark-input w-full mt-1 rounded-md mb-6" value="000000">
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-reset-pw" class="secondary-button px-4 py-2 rounded-lg">å–æ¶ˆ</button>
                    <button type="submit" class="admin-button px-4 py-2 rounded-lg font-bold">ç¢ºèªé‡è¨­</button>
                </div>
            </form>
        </div>
    </div>
    <div id="change-role-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="admin-container w-full max-w-sm p-8 rounded-2xl shadow-2xl">
            <h2 class="text-xl font-bold mb-2 text-white">è®Šæ›´è§’è‰²</h2>
            <p class="text-gray-400 mb-6">æ­£åœ¨è®Šæ›´ <strong id="change-role-nickname" class="text-orange-300"></strong> çš„è§’è‰²ã€‚</p>
            <form id="change-role-form">
                <label for="change-role-select" class="text-sm font-medium">æ–°è§’è‰²</label>
                <select id="change-role-select" required class="dark-input mt-1 w-full rounded-md mb-6">
                    <option value="å ±åè€…">å ±åè€…</option><option value="ç™¼è‡è€…">ç™¼è‡è€…</option><option value="ç™¼è‡åŠå ±åè€…">ç™¼è‡åŠå ±åè€…</option><option value="ç®¡ç†è€…">ç®¡ç†è€…</option>
                </select>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-change-role" class="secondary-button px-4 py-2 rounded-lg">å–æ¶ˆ</button>
                    <button type="submit" class="admin-button px-4 py-2 rounded-lg font-bold">ç¢ºèªè®Šæ›´</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-user-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
            <div class="admin-container w-full max-w-sm p-8 rounded-2xl shadow-2xl">
                <h2 class="text-xl font-bold mb-6 text-white">ç·¨è¼¯ä½¿ç”¨è€…æš±ç¨±</h2>
                <form id="edit-user-form">
                    <input type="hidden" id="edit-user-id">
                    <input type="hidden" id="edit-user-old-nickname">
                    <div class="space-y-4">
                        <div>
                            <label for="edit-nickname" class="text-sm font-medium">æ–°æš±ç¨±</label>
                            <input type="text" id="edit-nickname" required maxlength="50" class="dark-input mt-1 w-full rounded-md">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-8">
                        <button type="button" id="cancel-edit-user" class="secondary-button px-4 py-2 rounded-lg">å–æ¶ˆ</button>
                        <button type="submit" id="submit-edit-user" class="admin-button px-4 py-2 rounded-lg font-bold">ç¢ºèªå„²å­˜</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="copy-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
            <div class="admin-container w-full max-w-2xl p-6 rounded-2xl shadow-xl flex flex-col gap-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-white">ğŸ“‹ è¨‚é–±ä¿¡ç®±æ¸…å–®</h3>
                    <button type="button" id="close-copy-modal-x" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <p class="text-gray-400 text-sm">ç³»çµ±å·²è‡ªå‹•å…¨é¸ï¼Œè«‹ç›´æ¥æŒ‰ä¸‹ <strong>Ctrl+C</strong> (æˆ–æ˜¯å³éµè¤‡è£½) å³å¯ã€‚</p>
                <textarea id="copy-textarea" class="dark-input w-full h-64 p-4 rounded-lg font-mono text-sm leading-relaxed focus:ring-2 focus:ring-orange-500" readonly></textarea>
                <div class="flex justify-end">
                    <button type="button" id="close-copy-modal" class="secondary-button px-6 py-2 rounded-lg font-bold">é—œé–‰</button>
                </div>
            </div>
        </div>

    <script>
        // --- 1. åˆå§‹åŒ–è¨­å®š ---
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co';
        const PUBLIC_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, PUBLIC_KEY);
        
        // --- 2. æŠ“å–æ‰€æœ‰æœƒç”¨åˆ°çš„ HTML å…ƒç´  ---
        const adminLoginSection = document.getElementById('admin-login-section');
        const adminDashboardSection = document.getElementById('admin-dashboard-section');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminLoginButton = document.getElementById('admin-login-button');
        const adminMessageBox = document.getElementById('admin-message-box');
        const adminUserInfo = document.getElementById('admin-user-info');
        const adminLogoutButton = document.getElementById('admin-logout-button');
        const userListBody = document.getElementById('user-list-body');
        const addUserForm = document.getElementById('add-user-form');
        const addUserButton = document.getElementById('add-user-button');
        const resetPasswordModal = document.getElementById('reset-password-modal');
        const resetPasswordForm = document.getElementById('reset-password-form');
        const cancelResetPwButton = document.getElementById('cancel-reset-pw');
        const changeRoleModal = document.getElementById('change-role-modal');
        const changeRoleForm = document.getElementById('change-role-form');
        const cancelChangeRoleButton = document.getElementById('cancel-change-role');
        const editUserModal = document.getElementById('edit-user-modal');
        const editUserForm = document.getElementById('edit-user-form');
        const cancelEditUserButton = document.getElementById('cancel-edit-user');        
        const challengeListAdmin = document.getElementById('challenge-list-admin');
        const dbStatusLight = document.getElementById('db-status-light');
        const userTableHeader = document.getElementById('user-table-header');
        
        // å…¨åŸŸè¨­å®šèˆ‡é€šçŸ¥ç›¸é—œå…ƒç´ 
        const dailyLimitInput = document.getElementById('daily-limit-input');
        const saveSettingsButton = document.getElementById('save-settings-button');
        const settingsStatusText = document.getElementById('settings-status-text');
        const subCountEl = document.getElementById('sub-count');
        const copySubsButton = document.getElementById('copy-subs-button');
        const subLastUpdateEl = document.getElementById('sub-last-update');
        const sendTestEmailButton = document.getElementById('send-test-email-button');
        const triggerCheckButton = document.getElementById('trigger-check-button');
        // é¡æ»¿é€šçŸ¥ç›¸é—œå…ƒç´  
        const fullSubCountEl = document.getElementById('full-sub-count');
        const copyFullSubsButton = document.getElementById('copy-full-subs-button');

        // è¤‡è£½ Modal ç›¸é—œ
        const copyModal = document.getElementById('copy-modal');
        const copyTextarea = document.getElementById('copy-textarea');
        const closeCopyModalButton = document.getElementById('close-copy-modal');
        const closeCopyModalX = document.getElementById('close-copy-modal-x');

        // --- 3. ç‹€æ…‹è®Šæ•¸ ---
        let userToEdit = null;
        let dbConnectionInterval = null;
        let allUsersData = [];
        let currentSortColumn = 'nickname';
        let currentSortDirection = 'asc';

        // --- 4. æ ¸å¿ƒåŠŸèƒ½å‡½å¼ ---

        // â˜… ä¿®æ”¹ï¼šåœ¨è¼‰å…¥è³‡æ–™å¾Œï¼Œå‘¼å«æ›´æ–°è¨‚é–±äººæ•¸çš„å‡½å¼
        async function loadUsers() {
            userListBody.innerHTML = `<tr><td colspan="5" class="text-center p-4">è®€å–ä¸­...</td></tr>`;
            try {
                const { data, error } = await invokeAdminFunction('list-users-with-details', {});
                if (error) throw error;
                
                allUsersData = data.users || []; 
                renderUserList(); // æ¸²æŸ“åˆ—è¡¨
                updateSubscriptionUI(); // â˜… æ–°å¢ï¼šè¨ˆç®—ä¸¦é¡¯ç¤ºè¨‚é–±äººæ•¸ (é€™ä¸‹ä¸æœƒå ±éŒ¯äº†ï¼Œå› ç‚º HTML å…ƒç´ å·²è£œä¸Š)
            } catch (error) {
                userListBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-red-400">ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨: ${error.message}</td></tr>`;
            }
        }

        // â˜… æ–°å¢ï¼šæ›´æ–°è¨‚é–±çµ±è¨ˆ UI
        function updateSubscriptionUI() {
            if (!allUsersData) return;

            // 1. å ±åé€šçŸ¥çµ±è¨ˆ
            const signupEmails = allUsersData.map(u => u.notification_email).filter(e => e && e.includes('@'));
            if (subCountEl) subCountEl.textContent = `${signupEmails.length} äºº`;

            // 2. é¡æ»¿é€šçŸ¥çµ±è¨ˆ
            const fullEmails = allUsersData.map(u => u.full_notification_email).filter(e => e && e.includes('@'));
            if (fullSubCountEl) fullSubCountEl.textContent = `${fullEmails.length} äºº`;
        }

        // â˜… æ–°å¢ï¼šè¤‡è£½è¨‚é–±åå–®é‚è¼¯
        if (copyFullSubsButton) {
            copyFullSubsButton.addEventListener('click', () => {
                const emails = allUsersData
                    .map(user => user.full_notification_email)
                    .filter(email => email && email.includes('@'))
                    .sort();

                if (emails.length === 0) {
                    showMessage('ç›®å‰æ²’æœ‰äººè¨‚é–±é¡æ»¿é€šçŸ¥ã€‚', true);
                    return;
                }
                copyToModal(emails);
            });
        }

        // ç‚ºäº†é¿å…ä»£ç¢¼é‡è¤‡ï¼Œå»ºè­°å°‡åŸæœ¬çš„ copySubsButton é‚è¼¯å…§çš„è¤‡è£½å‹•ä½œæå–ç‚º copyToModal å‡½å¼
        function copyToModal(emailList) {
            copyTextarea.value = emailList.join(', ');
            copyModal.classList.remove('hidden');
            copyTextarea.focus();
            copyTextarea.select();
            try { document.execCommand('copy'); showMessage('å·²è‡ªå‹•è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', false); } catch (e) {}
        }

        // ä¿®æ”¹åŸæœ¬çš„ copySubsButton ä½¿ç”¨æ–°å‡½å¼
        if (copySubsButton) {
            copySubsButton.addEventListener('click', () => {
                const emails = allUsersData.map(u => u.notification_email).filter(e => e && e.includes('@')).sort();
                if (emails.length === 0) { showMessage('ç›®å‰æ²’æœ‰äººè¨‚é–±å ±åé€šçŸ¥ã€‚', true); return; }
                copyToModal(emails);
            });
        }

        // Modal é—œé–‰é‚è¼¯
        function hideCopyModal() { copyModal.classList.add('hidden'); }
        if (closeCopyModalButton) closeCopyModalButton.addEventListener('click', hideCopyModal);
        if (closeCopyModalX) closeCopyModalX.addEventListener('click', hideCopyModal);

        // â˜… æ–°å¢ï¼šç™¼é€æ¸¬è©¦ä¿¡æŒ‰éˆ•é‚è¼¯
        if (sendTestEmailButton) {
            sendTestEmailButton.addEventListener('click', async () => {
                if (!confirm('ç¢ºå®šè¦ç™¼é€ä¸€å°æ¸¬è©¦ä¿¡çµ¦ä¸­ç¹¼ç«™å—ï¼Ÿ')) return;
                
                sendTestEmailButton.disabled = true;
                sendTestEmailButton.textContent = 'ç™¼é€ä¸­...';
                try {
                    await invokeAdminFunction('send-test-email', {});
                    showMessage('æ¸¬è©¦ä¿¡å·²ç™¼é€ï¼è«‹æª¢æŸ¥ Gmailã€‚', false);
                } catch (error) {
                    showMessage(`ç™¼é€å¤±æ•—: ${error.message}`, true);
                } finally {
                    sendTestEmailButton.disabled = false;
                    sendTestEmailButton.textContent = 'ğŸ“¨ ç™¼é€æ¸¬è©¦ä¿¡';
                }
            });
        }

        // â˜… æ–°å¢ï¼šæ‰‹å‹•è§¸ç™¼æª¢æŸ¥æŒ‰éˆ•é‚è¼¯
        if (triggerCheckButton) {
            triggerCheckButton.addEventListener('click', async () => {
                triggerCheckButton.disabled = true;
                triggerCheckButton.innerHTML = '<span>ğŸ”„ æª¢æŸ¥ä¸­...</span>';
                try {
                    const { data } = await invokeAdminFunction('trigger-check-now', {});
                    if (data && data.sent) {
                        showMessage(`æª¢æŸ¥å®Œæˆï¼š${data.message}`, false);
                    } else {
                        showMessage(`æª¢æŸ¥å®Œæˆï¼š${data.message || 'ç„¡ç¬¦åˆæ¢ä»¶çš„è˜‘è‡'}`, false);
                    }
                } catch (error) {
                    showMessage(`æª¢æŸ¥å¤±æ•—: ${error.message}`, true);
                } finally {
                    triggerCheckButton.disabled = false;
                    triggerCheckButton.innerHTML = '<span>âš¡ ç«‹å³æª¢æŸ¥è˜‘è‡ç‹€æ…‹</span>';
                }
            });
        }

        // --- ä»¥ä¸‹ç¶­æŒæ‚¨åŸæœ¬ç©©å®šçš„åˆ—è¡¨æ¸²æŸ“é‚è¼¯ (ä¸åšè®Šæ›´) ---

        function renderUserList() {
            updateSortIndicators();

            if (!allUsersData || allUsersData.length === 0) {
                userListBody.innerHTML = `<tr><td colspan="5" class="text-center p-4">ç›®å‰æ²’æœ‰ä»»ä½•ä½¿ç”¨è€…ã€‚</td></tr>`;
                return;
            }

            const sortedUsers = [...allUsersData].sort((a, b) => {
                const valA = a[currentSortColumn];
                const valB = b[currentSortColumn];

                let comparison = 0;
                
                if (currentSortColumn === 'nickname') {
                    const getStringType = (str) => {
                        if (!str) return 2;
                        if (/^[a-zA-Z]/.test(str)) {
                            return 1;
                        }
                        return 2;
                    };

                    const typeA = getStringType(valA);
                    const typeB = getStringType(valB);

                    if (typeA !== typeB) {
                        comparison = typeA - typeB;
                    } else {
                        comparison = String(valA || '').localeCompare(String(valB || ''));
                    }
                } else {
                    if (valA == null) return 1;
                    if (valB == null) return -1;
                    
                    if (currentSortColumn === 'monthly_signup_count') {
                        // --- ä¿®æ”¹ï¼šæ’åºæ”¹ç‚ºä¾æ“šã€Œç¸½åƒèˆ‡åº¦ã€ (å ±å+ç™¼è‡) ---
                        const totalA = (valA ?? 0) + (a.monthly_host_count ?? 0);
                        const totalB = (valB ?? 0) + (b.monthly_host_count ?? 0);
                        comparison = totalA - totalB;
                    } else if (currentSortColumn === 'last_active_at') {
                        comparison = new Date(valA).getTime() - new Date(valB).getTime();
                    } else {
                        comparison = String(valA).localeCompare(String(valB));
                    }
                }

                return currentSortDirection === 'asc' ? comparison : -comparison;
            });

            userListBody.innerHTML = sortedUsers.map(user => {
                const lastSignIn = user.last_active_at
                    ? new Date(user.last_active_at).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(',', '')
                    : 'å¾æœª';
                
                // --- ä¿®æ”¹é–‹å§‹ï¼šè¨ˆç®—ç¶œåˆåƒèˆ‡åº¦ (å ±å + ç™¼è‡) ---
                // 1. è®€å–æ•¸å€¼ï¼Œè‹¥ç‚º null å‰‡è¦–ç‚º 0
                const signupCount = user.monthly_signup_count || 0;
                const hostCount = user.monthly_host_count || 0;
                
                // 2. è¨ˆç®—ç¸½åˆ†
                const totalParticipation = signupCount + hostCount;
                
                // 3. è¨­å®šé¡¯ç¤ºæ¨£å¼ (å€åˆ†é¡è‰²æ–¹ä¾¿é–±è®€)
                const signupClass = signupCount > 0 ? 'text-blue-400' : 'text-gray-500';
                const hostClass = hostCount > 0 ? 'text-green-400' : 'text-gray-500';
                
                // 4. çµ„åˆé¡¯ç¤ºå­—ä¸²ï¼š "ç¸½åˆ† (å ±X/ç™¼Y)"
                const participationDisplay = `<span class="font-bold text-white">${totalParticipation}</span> <span class="text-xs text-gray-400">(<span class="${signupClass}">å ±${signupCount}</span>/<span class="${hostClass}">ç™¼${hostCount}</span>)</span>`;
                // --- ä¿®æ”¹çµæŸ ---

                return `
                    <tr class="border-b border-gray-700 hover:bg-gray-800/50">
                        <td class="p-3">${user.nickname || 'N/A'}</td>
                        <td class="p-3">${user.role || 'æœªçŸ¥'}</td>
                        
                        <td class="p-3 text-center">${participationDisplay}</td>
                        
                        <td class="p-3 text-sm text-gray-400">${lastSignIn}</td>
                        <td class="p-3 text-center space-x-2">
                            <button data-id="${user.id}" data-nickname="${user.nickname}" class="edit-user-button text-xs px-2 py-1 bg-green-600 rounded hover:bg-green-500">ç·¨è¼¯</button>
                            <button data-id="${user.id}" data-nickname="${user.nickname}" class="reset-password-button text-xs px-2 py-1 bg-blue-600 rounded hover:bg-blue-500">æ”¹å¯†ç¢¼</button>
                            <button data-id="${user.id}" data-nickname="${user.nickname}" data-role="${user.role}" class="change-role-button text-xs px-2 py-1 bg-yellow-600 text-black rounded hover:bg-yellow-500">æ”¹è§’è‰²</button>
                            <button data-id="${user.id}" data-nickname="${user.nickname}" class="delete-user-button text-xs px-2 py-1 bg-red-700 rounded hover:bg-red-600">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
                }).join('');
            }
        
        function updateSortIndicators() {
            document.querySelectorAll('.sortable-header').forEach(header => {
                const indicator = header.querySelector('.sort-indicator');
                if (indicator) {
                    if (header.dataset.sortKey === currentSortColumn) {
                        indicator.textContent = currentSortDirection === 'asc' ? 'â–²' : 'â–¼';
                    } else {
                        indicator.textContent = '';
                    }
                }
            });
        }
        
        userTableHeader.addEventListener('click', (e) => {
            const header = e.target.closest('.sortable-header');
            if (!header) return;

            const sortKey = header.dataset.sortKey;
            if (sortKey === currentSortColumn) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = sortKey;
                currentSortDirection = 'asc';
            }
            renderUserList();
        });


        // ç›£è½ç®¡ç†è€…ç™»å…¥è¡¨å–®æäº¤äº‹ä»¶
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            adminLoginButton.disabled = true; adminLoginButton.textContent = 'é©—è­‰ä¸­...';
            const { nickname, password } = e.target.elements;
            const cleanNickname = (nickname.value || '').split(/[^a-zA-Z0-9\u4e00-\u9fa5\s]/)[0];

            const virtualEmail = `${encodeURIComponent(cleanNickname)}@pikmin.sys`;

            try {
                const { data: { user }, error } = await supabaseClient.auth.signInWithPassword({ email: virtualEmail, password: password.value });
                if (error) throw error;
                const { data: profile } = await supabaseClient.from('profiles').select('role, nickname').eq('id', user.id).single();
                if (profile.role !== 'ç®¡ç†è€…') throw new Error('æ¬Šé™ä¸è¶³ï¼Œåƒ…é™ç®¡ç†è€…ç™»å…¥ã€‚');
                authorizeAndShowDashboard(profile);
            } catch (error) {
                showMessage(error.message.includes('Invalid') ? 'æš±ç¨±æˆ–å¯†ç¢¼éŒ¯èª¤ã€‚' : error.message, true);
            } finally {
                adminLoginButton.disabled = false; adminLoginButton.textContent = 'ç™»å…¥';
            }
        });

        function authorizeAndShowDashboard(profile) {
            adminUserInfo.textContent = `ç®¡ç†å“¡ï¼š${profile.nickname}`;
            adminLoginSection.classList.add('hidden');
            adminDashboardSection.classList.remove('hidden');
            loadAllAdminData();
        }

        adminLogoutButton.addEventListener('click', async () => {
            if (dbConnectionInterval) clearInterval(dbConnectionInterval);
            await supabaseClient.auth.signOut();
            window.location.reload();
        });

        function loadAllAdminData() {
            loadGlobalSettings();
            loadUsers();
            loadChallenges();
            setupAdminRealtime();
            checkDbConnection();
            dbConnectionInterval = setInterval(checkDbConnection, 30000);
        }

        async function checkDbConnection() {
            try {
                await invokeAdminFunction('ping', {});
                dbStatusLight.className = 'status-light bg-green-500';
                dbStatusLight.title = `è³‡æ–™åº«é€£ç·šæ­£å¸¸ (ä¸Šæ¬¡æª¢æŸ¥æ–¼ ${new Date().toLocaleTimeString()})`;
            } catch (error) {
                dbStatusLight.className = 'status-light bg-red-500';
                dbStatusLight.title = `è³‡æ–™åº«é€£ç·šç•°å¸¸ (ä¸Šæ¬¡æª¢æŸ¥æ–¼ ${new Date().toLocaleTimeString()})\néŒ¯èª¤: ${error.message}`;
            }
        }
        
        async function invokeAdminFunction(action, payload) {
            try {
                const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ action, payload })
                });
                if (error) throw error;
                if (data.error) throw new Error(data.error);
                return data;
            } catch (e) {
                console.error(`Edge Function [${action}] åŸ·è¡Œå¤±æ•—:`, e);
                throw e;
            }
        }

        addUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            addUserButton.disabled = true; addUserButton.textContent = 'æ–°å¢ä¸­...';
            const nickname = document.getElementById('new-nickname').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;
            try {
                await invokeAdminFunction('create-user', { nickname, password, role });
                showMessage(`ä½¿ç”¨è€… ${nickname} æ–°å¢æˆåŠŸï¼`, false);
                addUserForm.reset();
                loadUsers();
            } catch (error) {
                showMessage(`æ–°å¢å¤±æ•—: ${error.message}`, true);
            } finally {
                addUserButton.disabled = false; addUserButton.textContent = 'ç¢ºèªæ–°å¢';
            }
        });

        userListBody.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const userData = target.dataset;
            userToEdit = { id: userData.id, nickname: userData.nickname, role: userData.role };
            if (target.classList.contains('edit-user-button')) {
                document.getElementById('edit-user-id').value = userToEdit.id;
                document.getElementById('edit-user-old-nickname').value = userToEdit.nickname;
                document.getElementById('edit-nickname').value = userToEdit.nickname;
                editUserModal.classList.remove('hidden');
            } else if (target.classList.contains('reset-password-button')) {
                document.getElementById('reset-pw-nickname').textContent = userToEdit.nickname;
                resetPasswordModal.classList.remove('hidden');
            } else if (target.classList.contains('change-role-button')) {
                document.getElementById('change-role-nickname').textContent = userToEdit.nickname;
                document.getElementById('change-role-select').value = userToEdit.role;
                changeRoleModal.classList.remove('hidden');
            } else if (target.classList.contains('delete-user-button')) {
                const confirmationMessage = `ã€é«˜é¢¨éšªç®¡ç†å“¡æ“ä½œã€‘\n\næ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ä½¿ç”¨è€…ã€Œ${userToEdit.nickname}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œæœƒå°‡å…¶å¸³è™ŸåŠæ‰€æœ‰ç›¸é—œè³‡æ–™å¾ç³»çµ±ä¸­ç§»é™¤ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚`;
                if (confirm(confirmationMessage)) {
                    target.disabled = true; target.textContent = 'åˆªé™¤ä¸­';
                    try {
                        await invokeAdminFunction('delete-user', { userId: userToEdit.id });
                        showMessage(`ä½¿ç”¨è€… ${userToEdit.nickname} å·²æˆåŠŸåˆªé™¤ã€‚`, false);
                        loadUsers();
                    } catch (error) {
                        showMessage(`åˆªé™¤ä½¿ç”¨è€…å¤±æ•—: ${error.message}`, true);
                        target.disabled = false; target.textContent = 'åˆªé™¤';
                    }
                }
            }
        });

        cancelResetPwButton.addEventListener('click', () => resetPasswordModal.classList.add('hidden'));
        resetPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('reset-pw-input').value;
            try {
                await invokeAdminFunction('reset-user-password', { userId: userToEdit.id, password: newPassword });
                showMessage(`ä½¿ç”¨è€… ${userToEdit.nickname} çš„å¯†ç¢¼å·²æˆåŠŸé‡è¨­ã€‚`, false);
                resetPasswordModal.classList.add('hidden');
                loadUsers();
            } catch(error) { showMessage(`å¯†ç¢¼é‡è¨­å¤±æ•—: ${error.message}`, true); }
        });

        cancelChangeRoleButton.addEventListener('click', () => changeRoleModal.classList.add('hidden'));
        changeRoleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newRole = document.getElementById('change-role-select').value;
            try {
                await invokeAdminFunction('update-user-role', { userId: userToEdit.id, role: newRole });
                showMessage(`ä½¿ç”¨è€… ${userToEdit.nickname} çš„è§’è‰²å·²æ›´æ–°ç‚º ${newRole}ã€‚`, false);
                changeRoleModal.classList.add('hidden');
                loadUsers();
            } catch(error) { showMessage(`è§’è‰²è®Šæ›´å¤±æ•—: ${error.message}`, true); }
        });

        cancelEditUserButton.addEventListener('click', () => editUserModal.classList.add('hidden'));
        editUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = document.getElementById('submit-edit-user');
            submitButton.disabled = true; submitButton.textContent = 'å„²å­˜ä¸­...';
        
            const payload = {
                userId: document.getElementById('edit-user-id').value,
                oldNickname: document.getElementById('edit-user-old-nickname').value,
                newNickname: document.getElementById('edit-nickname').value,
            };
        
            try {
                await invokeAdminFunction('update-user-nickname', payload);
                showMessage(`ä½¿ç”¨è€…æš±ç¨±å·²æˆåŠŸæ›´æ–°ç‚º ${payload.newNickname}ã€‚`, false);
                editUserModal.classList.add('hidden');
                loadUsers();
            } catch (error) {
                showMessage(`æ›´æ–°å¤±æ•—: ${error.message}`, true);
            } finally {
                submitButton.disabled = false; submitButton.textContent = 'ç¢ºèªå„²å­˜';
            }
        });

        async function loadChallenges() {
            challengeListAdmin.innerHTML = '<p>è®€å–ä¸­...</p>';
            try {
                const { data: challenges, error } = await supabaseClient.from('challenges').select('*, host:profiles(nickname), signups(profile:profiles(nickname))').order('created_at', { ascending: false });
                if(error) throw error;
                if(challenges.length === 0) { challengeListAdmin.innerHTML = `<p>ç›®å‰æ²’æœ‰ä»»ä½•æŒ‘æˆ°ã€‚</p>`; return; }
                challengeListAdmin.innerHTML = '';          
                challenges.forEach(c => renderAdminChallengeCard(c));
            } catch (error) {
                challengeListAdmin.innerHTML = `<p class="text-red-400">ç„¡æ³•è¼‰å…¥æŒ‘æˆ°åˆ—è¡¨: ${error.message}</p>`;
            }
        }
        
        function renderAdminChallengeCard(challenge) {
            const card = document.createElement('div');
            card.className = 'challenge-card p-4';
            card.id = `admin-challenge-${challenge.id}`;
            
            const statusClass = challenge.status === 'é–‹æ”¾å ±åä¸­' ? 'bg-green-600' : (challenge.status === 'å·²é¡æ»¿' ? 'bg-red-600' : 'bg-yellow-600');
            const signupCount = challenge.signups ? challenge.signups.length : 0;

            let dispatchTagHtml = '';
            if (signupCount > 0) {
                const dispatchStatus = challenge.dispatch_status || 'å¾…ç™¼';
                const dispatchClass = dispatchStatus === 'å·²ç™¼' ? 'bg-teal-500' : 'bg-gray-600';
                dispatchTagHtml = `<span class="text-xs font-bold px-2 py-1 rounded-full text-white ${dispatchClass}">${dispatchStatus}</span>`;
            }

            let participantsHtml = '';
            if (signupCount > 0) {
                const participantsList = challenge.signups.map((signup) => `<span class="text-xs bg-gray-700 px-2 py-1 rounded">${signup.profile?.nickname || 'æœªçŸ¥'}</span>`).join(' ');
                participantsHtml = `<div class="mt-2 flex flex-wrap gap-2 items-center">${participantsList}</div>`;
            }

            card.innerHTML = `
            <div class="flex flex-col justify-between h-full">
                
                <div>
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-lg font-bold text-gray-100">
                        ${challenge.mushroom_type} 
                        <span class="ml-2 text-sm text-gray-500">#${challenge.id}</span>
                    </h3>
                    <div class="flex items-center space-x-2">
                    ${dispatchTagHtml}
                    <span class="text-xs font-bold px-2 py-1 rounded-full text-white ${statusClass}">
                        ${challenge.status}
                    </span>
                    </div>
                </div>

                <div class="text-sm text-gray-400 space-y-1">
                    <p><strong>ç™¼å¸ƒè€…:</strong> ${challenge.host?.nickname || 'æœªçŸ¥'}</p>
                    <p><strong>åé¡:</strong> ${signupCount} / ${challenge.slots}</p>
                    <p><strong>é–‹æ”¾æ™‚é–“:</strong> ${new Date(challenge.start_time).toLocaleString('zh-TW', { hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</p>
                </div>

                ${participantsHtml}
                </div>

                <div>
                <button data-id="${challenge.id}" class="delete-challenge-admin-button mt-4 w-full text-white font-bold py-2 px-4 rounded-lg bg-red-800 hover:bg-red-700 transition">
                    åˆªé™¤
                </button>
                </div>
                
            </div>
            `;
            challengeListAdmin.appendChild(card); 
        }

        challengeListAdmin.addEventListener('click', async (e) => {
            const button = e.target.closest('.delete-challenge-admin-button');
            if(!button) return;
            const challengeId = button.dataset.id;
            if (confirm(`ã€ç®¡ç†å“¡æ“ä½œã€‘\næ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹ ID ç‚º ${challengeId} çš„æŒ‘æˆ°å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                button.disabled = true; button.textContent = 'åˆªé™¤ä¸­...';
                try {
                    await invokeAdminFunction('delete-challenge', { challengeId: challengeId });
                    showMessage(`æŒ‘æˆ° ${challengeId} å·²æˆåŠŸåˆªé™¤ã€‚`, false);
                    loadChallenges();
                } catch(error) {
                    showMessage(`åˆªé™¤æŒ‘æˆ°å¤±æ•—: ${error.message}`, true); 
                    button.disabled = false; button.textContent = 'åˆªé™¤';
                }
            }
        });

        function setupAdminRealtime() {
            supabaseClient.channel('admin-realtime')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'challenges' }, loadChallenges)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, loadUsers) 
                .subscribe();
        }

        async function loadGlobalSettings() {
            settingsStatusText.textContent = 'è®€å–ä¸­...';
            try {
                const { data, error } = await invokeAdminFunction('get-daily-limit', {});
                
                if (error) throw error;

                if (data) {
                    dailyLimitInput.value = data.setting_value;
                    settingsStatusText.textContent = `ä¸Šæ¬¡æ›´æ–°æ–¼ ${new Date().toLocaleTimeString()}`;
                } else {
                    dailyLimitInput.placeholder = 'æœªè¨­å®š';
                    settingsStatusText.textContent = 'åœ¨è³‡æ–™åº«ä¸­æ‰¾ä¸åˆ°è¨­å®šå€¼ã€‚';
                }
            } catch (error) {
                dailyLimitInput.placeholder = 'éŒ¯èª¤';
                settingsStatusText.textContent = `è®€å–å¤±æ•—: ${error.message}`;
            }
        }

        saveSettingsButton.addEventListener('click', async () => {
            const newValue = parseInt(dailyLimitInput.value);
            if (isNaN(newValue) || newValue < 0) {
                showMessage('è«‹è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„æ­£æ•´æ•¸ã€‚', true);
                return;
            }

            saveSettingsButton.disabled = true;
            saveSettingsButton.textContent = 'å„²å­˜ä¸­...';
            settingsStatusText.textContent = '';

            try {
                const { error } = await invokeAdminFunction('set-daily-limit', { value: newValue });
                
                if (error) throw error;

                showMessage('æ¯æ—¥å ±åä¸Šé™å·²æˆåŠŸæ›´æ–°ï¼', false);
                settingsStatusText.textContent = `æ›´æ–°æˆåŠŸæ–¼ ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                showMessage(`æ›´æ–°å¤±æ•—: ${error.message}`, true);
                settingsStatusText.textContent = `æ›´æ–°å¤±æ•—ã€‚`;
            } finally {
                saveSettingsButton.disabled = false;
                saveSettingsButton.textContent = 'å„²å­˜è®Šæ›´';
            }
        });

        async function populateNicknames() {
            const nicknameSelect = document.getElementById('admin-nickname-select');
            try {
                const { data, error } = await supabaseClient.from('profiles').select('nickname').eq('role', 'ç®¡ç†è€…').order('nickname');
                if (error) throw error;
                nicknameSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡ç®¡ç†å“¡æš±ç¨±</option>';
                data.forEach(p => nicknameSelect.innerHTML += `<option value="${p.nickname}">${p.nickname}</option>`);
            } catch (error) {
                nicknameSelect.innerHTML = '<option value="" disabled>ç„¡æ³•è¼‰å…¥</option>';
            }
        }
        
        function showMessage(text, isError) {
            adminMessageBox.textContent = text;
            adminMessageBox.className = `p-4 text-center text-sm rounded-xl ${isError ? 'bg-red-500/50 text-red-300' : 'bg-green-500/50 text-green-300'}`;
            setTimeout(() => {
                if (adminMessageBox.textContent === text) { adminMessageBox.className += ' hidden'; }
            }, 5000);
        }
        
        async function checkInitialSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                const { data: profile } = await supabaseClient.from('profiles').select('role, nickname').eq('id', session.user.id).single();
                if (profile && profile.role === 'ç®¡ç†è€…') {
                    authorizeAndShowDashboard(profile);
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            populateNicknames();
            checkInitialSession();
        });
    </script>
</body>
</html>