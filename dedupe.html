<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡è¤‡ç¾ç‰‡æ¸…ç†å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    <style>
        body { background-color: #111827; color: #d1d5db; font-family: 'Inter', sans-serif; padding-bottom: 40px; }
        
        /* å„ªåŒ–å¾Œçš„å¡ç‰‡ç¾¤çµ„ */
        .card-group { 
            background-color: #1f2937; 
            border: 1px solid #374151; 
            border-radius: 0.75rem; 
            overflow: hidden; 
            margin-bottom: 1.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* ç¾¤çµ„æ¨™é¡Œï¼šæ‰‹æ©Ÿç‰ˆå‚ç›´æ’åˆ—ï¼Œå¹³æ¿ä»¥ä¸Šæ°´å¹³æ’åˆ— */
        .card-header { 
            background-color: #374151; 
            padding: 0.75rem 1rem; 
            color: white; 
            display: flex; 
            flex-direction: column; 
            gap: 0.5rem;
        }
        @media (min-width: 768px) {
            .card-header { flex-direction: row; justify-content: space-between; align-items: center; }
        }

        /* å–®ä¸€å¡ç‰‡é …ç›® */
        .card-item { 
            display: flex; 
            gap: 0.75rem; 
            padding: 1rem; 
            border-bottom: 1px solid #374151; 
            align-items: flex-start; /* é ‚å°é½Šï¼Œè®“é•·å…§å®¹æ›´å¥½çœ‹ */
            position: relative;
        }
        .card-item:last-child { border-bottom: none; }

        /* æ¨™ç±¤æ¨£å¼ */
        .tag { 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-size: 0.7rem; 
            font-weight: bold; 
            white-space: nowrap;
            display: inline-block;
        }
        .tag-lib { background-color: #db2777; color: white; }
        .tag-gal { background-color: #7c3aed; color: white; }

        /* åˆ†é æŒ‰éˆ•å„ªåŒ– */
        .tab-btn { 
            flex: 1; 
            text-align: center; 
            padding: 0.75rem 0.5rem; 
            cursor: pointer; 
            border-bottom: 2px solid transparent; 
            transition: all 0.3s; 
            font-size: 0.9rem;
            color: #9ca3af;
        }
        .tab-btn.active { 
            color: #60a5fa; 
            border-bottom-color: #60a5fa; 
            font-weight: bold; 
            background-color: rgba(31, 41, 55, 0.5);
        }

        .modal-backdrop { background-color: rgba(0, 0, 0, 0.95); backdrop-filter: blur(4px); }

        /* ä¿®æ”¹ .card-group è®“å®ƒåœ¨åˆ—è¡¨æ¨¡å¼ä¸‹æ›´ç·Šæ¹Š */
        .card-group {
            background-color: #1f2937; /* Gray-800 */
            border: 1px solid #374151;
            border-radius: 0.75rem;
            overflow: hidden;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        /* åˆ—è¡¨é …ç›®çš„æ–°æ¨£å¼ */
        .list-row {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #374151;
            background-color: #1f2937; /* èˆ‡èƒŒæ™¯åŒè‰²ï¼Œæ¸›å°‘æ¡†ç·šæ„Ÿ */
            transition: background-color 0.2s;
        }
        .list-row:last-child {
            border-bottom: none;
        }
        .list-row:hover {
            background-color: #2d3748; /* Gray-750 hover */
        }
    </style>
</head>
<body class="px-4">

    <div class="max-w-3xl mx-auto">
        <header class="sticky top-0 z-40 bg-[#111827]/95 backdrop-blur-sm border-b border-gray-700 py-4 mb-6 shadow-md -mx-4 px-4 flex justify-between items-center">
            <div class="flex flex-col">
                <h1 class="text-xl md:text-2xl font-bold text-white flex items-center gap-2">
                    ğŸ§¹ ç¾ç‰‡æ¸…ç†å°å·¥å…·
                    <span class="text-[10px] bg-blue-600/20 text-blue-400 border border-blue-500/30 px-2 py-0.5 rounded whitespace-nowrap hidden md:inline-block">ç®¡ç†å“¡</span>
                </h1>
                <span class="text-xs text-gray-500 md:hidden">é‡è¤‡ç¾ç‰‡ç®¡ç†</span>
            </div>
            
            <a href="javascript:history.back()" class="flex items-center gap-1 text-sm bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-1.5 rounded-lg border border-gray-600 transition">
                <span>â†©</span> è¿”å›
            </a>
        </header>

        <div id="status-bar" class="mb-4 text-center text-gray-400 text-sm animate-pulse">æ­£åœ¨åˆå§‹åŒ–...</div>

        <div class="flex border-b border-gray-700 mb-6 bg-gray-800 rounded-t-lg overflow-hidden sticky top-[73px] z-30 shadow-lg">
            <div id="tab-exact" class="tab-btn active" onclick="switchTab('exact')">
                å®Œå…¨é‡è¤‡ <span id="count-exact" class="text-xs bg-gray-700 px-1.5 py-0.5 rounded-full ml-1">0</span>
            </div>
            <div id="tab-fuzzy" class="tab-btn" onclick="switchTab('fuzzy')">
                é„°è¿‘åµæ¸¬ <span id="count-fuzzy" class="text-xs bg-gray-700 px-1.5 py-0.5 rounded-full ml-1">0</span>
            </div>
        </div>

        <div id="list-container" class="space-y-6 pb-20">
            </div>
    </div>

    <div id="image-viewer-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-backdrop" onclick="closeImageViewer()">
        <div class="relative max-w-5xl w-full max-h-[95vh] flex justify-center items-center" onclick="event.stopPropagation()">
            <button type="button" onclick="closeImageViewer()" class="absolute -top-12 right-0 text-white text-4xl bg-black/50 rounded-full w-10 h-10 flex items-center justify-center">&times;</button>
            <img id="viewer-image" src="" class="rounded-lg shadow-2xl max-h-[80vh] w-auto object-contain bg-gray-900 border border-gray-800">
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-gray-800 border border-gray-600 w-full max-w-lg rounded-2xl shadow-2xl p-6 relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeEditModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">&times;</button>
            <h2 class="text-2xl font-bold text-white mb-6">âœï¸ ç·¨è¼¯è³‡æ–™</h2>
            
            <form id="edit-form" class="space-y-4" onsubmit="handleEditSubmit(event)">
                <input type="hidden" id="edit-source"> <input type="hidden" id="edit-id">
                
                <input type="hidden" id="edit-nickname"> 
                <input type="hidden" id="edit-friendcode">

                <div class="flex items-start gap-4 p-3 bg-gray-700/50 rounded-lg border border-gray-600">
                    <div class="relative w-24 h-24 shrink-0 bg-gray-900 rounded-lg overflow-hidden border border-gray-600 group">
                        <img id="edit-image-preview" src="" alt="é è¦½" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/0 hover:bg-black/20 transition-colors cursor-pointer" onclick="document.getElementById('edit-image-upload').click()"></div>
                    </div>
                    <div class="flex-1 min-w-0 py-1">
                        <p class="text-xs text-gray-400 mb-2 break-all truncate" id="edit-image-filename">å°šæœªé¸æ“‡æ–°åœ–ç‰‡</p>
                        <input type="file" id="edit-image-upload" accept="image/*" class="hidden" onchange="handleImagePreview(event)">
                        <button type="button" onclick="document.getElementById('edit-image-upload').click()" 
                            class="px-3 py-1.5 bg-blue-600/80 hover:bg-blue-600 text-white text-xs rounded transition flex items-center gap-1 font-bold">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
                            </svg>
                            æ›´æ›åœ–ç‰‡
                        </button>
                        <p class="text-[10px] text-gray-500 mt-1">* ä¸Šå‚³å¾Œç³»çµ±å°‡è‡ªå‹•æ›¿æ›ä¸¦æ¸…ç†èˆŠæª”ã€‚</p>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">åº§æ¨™</label>
                    <div class="relative">
                        <input type="text" id="edit-coord" required class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2.5 outline-none focus:border-blue-500 transition font-mono">
                        <button type="button" id="paste-btn" class="absolute right-2 top-2 bg-gray-600 hover:bg-gray-500 text-green-400 px-2 py-1 rounded text-xs font-bold transition">ğŸ“‹ è²¼ä¸Š</button>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2">
                    <div><label class="block text-xs text-gray-400 mb-1">åœ‹å®¶</label><input type="text" id="edit-country" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-2 py-2 text-sm"></div>
                    <div><label class="block text-xs text-gray-400 mb-1">åœ°å€</label><input type="text" id="edit-region" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-2 py-2 text-sm"></div>
                    <div><label class="block text-xs text-gray-400 mb-1">ç´°é …</label><input type="text" id="edit-area" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-2 py-2 text-sm"></div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">æ¨™ç±¤ (Tags)</label>
                    <div class="grid grid-cols-3 gap-2">
                        <input type="text" id="edit-tag-1" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-2 py-2 text-sm text-center">
                        <input type="text" id="edit-tag-2" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-2 py-2 text-sm text-center">
                        <input type="text" id="edit-tag-3" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-2 py-2 text-sm text-center">
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-700">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-600 text-gray-200 rounded-lg hover:bg-gray-500 transition font-bold text-sm">å–æ¶ˆ</button>
                    <button type="submit" id="save-btn" class="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition font-bold text-sm shadow-lg">å„²å­˜è®Šæ›´</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co';
        const PUBLIC_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, PUBLIC_KEY);

        let currentTabData = { exact: [], fuzzy: [] };
        let activeTab = 'exact';

        async function init() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡å¸³è™Ÿ'); window.location.href = './index.html'; return; }

            document.getElementById('status-bar').textContent = 'æ­£åœ¨æƒæé‡è¤‡è³‡æ–™...';
            try {
                await scanLocalDuplicates();
            } catch (err) {
                document.getElementById('status-bar').innerHTML = `<span class="text-red-500">éŒ¯èª¤: ${err.message}</span>`;
            }
        }

        const getCoordKey = (coord, precision = 6) => {
            if (!coord) return 'unknown';
            const parts = coord.split(',').map(s => {
                const num = parseFloat(s.trim());
                return isNaN(num) ? 0 : num.toFixed(precision);
            });
            return parts.join(',');
        };

        // è¨ˆç®—å…©é»åº§æ¨™è·é›¢ (å–®ä½: å…¬å°º)
        function calculateDistance(coord1, coord2) {
            if (!coord1 || !coord2) return Infinity;
            const [lat1, lon1] = coord1.split(',').map(n => parseFloat(n));
            const [lat2, lon2] = coord2.split(',').map(n => parseFloat(n));
            
            const R = 6371e3; // åœ°çƒåŠå¾‘ (å…¬å°º)
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // å›å‚³è·é›¢ (å…¬å°º)
        }

        async function scanLocalDuplicates() {
            // 1. æŠ“å–è³‡æ–™
            const [libRes, galRes] = await Promise.all([
                supabaseClient.from('postcards').select('*'),
                supabaseClient.from('guest_postcards').select('*')
            ]);

            const libraryItems = libRes.data || [];
            const galleryItems = galRes.data || [];

            const allItems = [
                ...libraryItems.map(i => ({...i, source: 'library', name: i.uploader_nickname, label: 'åœ–æ›¸é¤¨'})),
                ...galleryItems.map(i => ({...i, source: 'gallery', name: i.nickname, label: 'è—å»Š'}))
            ];
            
            // 2. ç¯©é¸ï¼šæ’é™¤ã€Œç³»çµ±è½‰ç§» (system_import)ã€ä¸”ã€Œåœ–æ›¸é¤¨å·²æœ‰åŸå§‹æª”ã€çš„åˆæ³•å…±ç”¨è³‡æ–™
            const filteredItems = allItems.filter(item => {
                if (item.source === 'gallery' && item.ip_fingerprint === 'system_import') {
                    // æª¢æŸ¥åœ–æ›¸é¤¨æ˜¯å¦å·²å­˜åœ¨ã€Œå®Œå…¨ç›¸åŒåº§æ¨™ã€çš„åŸå§‹æª”
                    const existsInLib = libraryItems.some(lib => 
                        getCoordKey(lib.coordinate, 6) === getCoordKey(item.coordinate, 6)
                    );
                    // å¦‚æœåœ–æ›¸é¤¨æœ‰åŸå§‹æª”ï¼Œäºˆä»¥éš±è—
                    if (existsInLib) return false; 
                }
                return true; 
            });

            // 3. è™•ç†å®Œå…¨é‡è¤‡ (é‚è¼¯ç¶­æŒä¸è®Š)
            const exactGroups = new Map();
            filteredItems.forEach(item => {
                const eKey = getCoordKey(item.coordinate, 6);
                if (!exactGroups.has(eKey)) exactGroups.set(eKey, []);
                exactGroups.get(eKey).push(item);
            });

            // 4. è™•ç†é„°è¿‘åµæ¸¬ (æ›´æ–°ï¼šæ”¹ç‚ºè·é›¢æ¼”ç®—æ³• 1100m)
            const fuzzyResults = [];
            const visitedIds = new Set(); // è¨˜éŒ„å·²åˆ†çµ„çš„é …ç›® (é¿å…é‡è¤‡åˆ—å…¥)
            const DISTANCE_LIMIT = 1200;  // è¨­å®šåˆ¤å®šè·é›¢ç‚º 1200 å…¬å°º

            // è¤‡è£½ä¸€ä»½é™£åˆ—ä¾†é€²è¡Œæ¯”å°
            const pool = [...filteredItems];

            for (let i = 0; i < pool.length; i++) {
                const baseItem = pool[i];
                // ç”¢ç”Ÿå”¯ä¸€ ID key (source + id) ä»¥é˜²ä¸åŒè³‡æ–™è¡¨ ID é‡è¤‡
                const baseIdKey = `${baseItem.source}_${baseItem.id}`;

                if (visitedIds.has(baseIdKey)) continue; // è‹¥å·²åˆ†çµ„éå‰‡è·³é

                // å»ºç«‹æ–°ç¾¤çµ„ï¼Œä»¥ baseItem ç‚ºä¸­å¿ƒ
                const group = [baseItem];
                visitedIds.add(baseIdKey);

                // å¾€å¾Œå°‹æ‰¾æ‰€æœ‰è·é›¢ 1200m å…§çš„é»
                for (let j = i + 1; j < pool.length; j++) {
                    const candidate = pool[j];
                    const candidateIdKey = `${candidate.source}_${candidate.id}`;

                    if (visitedIds.has(candidateIdKey)) continue;

                    // ä½¿ç”¨æ‚¨ç¬¬ä¸€æ­¥é©ŸåŠ å…¥çš„ calculateDistance å‡½å¼
                    const dist = calculateDistance(baseItem.coordinate, candidate.coordinate);
                    
                    if (dist <= DISTANCE_LIMIT) {
                        group.push(candidate);
                        visitedIds.add(candidateIdKey);
                    }
                }

                // åªæœ‰ç•¶ç¾¤çµ„å…§æœ‰ 2 ç­†ä»¥ä¸Šè³‡æ–™æ™‚æ‰ç®—é‡è¤‡ç¾¤çµ„
                if (group.length > 1) {
                    const centerCoord = getCoordKey(baseItem.coordinate, 4);
                    fuzzyResults.push({
                        key: `é„°è¿‘ç¾¤çµ„ (~${centerCoord})`, // ç¾¤çµ„æ¨™é¡Œ
                        items: group
                    });
                }
            }

            // 5. æ›´æ–°å…¨åŸŸè³‡æ–™ç‹€æ…‹
            currentTabData.exact = Array.from(exactGroups.entries())
                .filter(([_, items]) => items.length > 1)
                .map(([key, items]) => ({ key, items }));

            currentTabData.fuzzy = fuzzyResults; // ä½¿ç”¨æ–°çš„è·é›¢æ¼”ç®—çµæœ

            // 6. æ›´æ–°ä»‹é¢æ•¸å­—èˆ‡å…§å®¹
            document.getElementById('count-exact').textContent = currentTabData.exact.length;
            document.getElementById('count-fuzzy').textContent = currentTabData.fuzzy.length;
            document.getElementById('status-bar').textContent = ''; 
            
            renderActiveTab();
        }

        function switchTab(tab) {
            activeTab = tab;
            document.getElementById('tab-exact').className = `tab-btn ${tab === 'exact' ? 'active' : ''}`;
            document.getElementById('tab-fuzzy').className = `tab-btn ${tab === 'fuzzy' ? 'active' : ''}`;
            renderActiveTab();
        }

        function renderActiveTab() {
            const container = document.getElementById('list-container');
            const data = currentTabData[activeTab];
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-24 px-4 text-center border-2 border-dashed border-gray-700 rounded-xl bg-gray-800/50">
                        <div class="text-4xl mb-4 opacity-80">ğŸ‰</div>
                        <h3 class="text-xl font-bold text-gray-300 mb-2">ä¹¾æ·¨æºœæºœï¼</h3>
                        <p class="text-gray-500">æ²’æœ‰ç™¼ç¾æ­¤é¡å‹çš„é‡è¤‡è³‡æ–™ã€‚</p>
                    </div>`;
                return;
            }

            data.forEach(group => {
                const groupEl = document.createElement('div');
                groupEl.className = 'card-group';

                let htmlContent = `
                    <div class="card-header bg-gray-900/80 p-3 flex flex-wrap md:flex-nowrap justify-between items-center gap-3 border-b border-gray-700">
                        <div class="flex items-center gap-3 overflow-hidden min-w-0 flex-1">
                            <span class="flex items-center justify-center w-6 h-6 rounded-full bg-red-500/10 text-red-400 text-sm flex-shrink-0">ğŸ“</span>
                            <h2 class="font-mono text-sm md:text-base text-gray-200 truncate font-bold tracking-wide select-all" title="${group.key}">
                                ${group.key}
                            </h2>
                        </div>
                        <span class="text-xs font-mono bg-gray-800 text-gray-400 px-2 py-1 rounded border border-gray-700 whitespace-nowrap">
                            ${group.items.length} ç­†
                        </span>
                    </div>
                    <div class="flex flex-col">`;

                group.items.sort((a, b) => new Date(a.created_at) - new Date(b.created_at)).forEach((item) => {
                    const isLib = item.source === 'library';
                    const locStr = [item.country, item.region, item.area].filter(Boolean).join(' Â· ');
                    
                    const dateObj = new Date(item.created_at);
                    const dateStr = dateObj.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });

                    let displayName = (item.name || 'æœªå‘½å').replace(/\d{12}/g, '').trim();
                    if (!displayName) displayName = item.name || 'æœªå‘½å';

                    const badgeClass = isLib ? 'bg-pink-900/30 text-pink-300 border-pink-700/50' : 'bg-violet-900/30 text-violet-300 border-violet-700/50';
                    const badgeText = isLib ? 'åœ–æ›¸é¤¨' : 'è—å»Š';

                    // æ¨™ç±¤ HTML ç”Ÿæˆ
                    const tagsHtml = (item.tags || []).map(t => 
                        `<span class="text-[10px] bg-gray-700 text-gray-300 px-1.5 py-0.5 rounded border border-gray-600 whitespace-nowrap">#${t}</span>`
                    ).join('');

                    htmlContent += `
                    <div class="list-row group" id="item-${item.source}-${item.id}">
                        
                        <div class="relative w-20 h-20 md:w-24 md:h-24 shrink-0 cursor-zoom-in overflow-hidden rounded-lg bg-gray-900 border border-gray-700" onclick="viewImage('${item.image_url}')">
                            <img src="${item.image_url}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy">
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors"></div>
                        </div>

                        <div class="flex-1 min-w-0 ml-4 flex flex-col md:flex-row md:items-center gap-2 md:gap-6">
                            
                            <div class="flex flex-col md:flex-row md:items-center gap-2 md:w-1/3">
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] px-1.5 py-0.5 rounded border ${badgeClass} whitespace-nowrap">${badgeText}</span>
                                    <span class="font-bold text-gray-200 text-sm md:text-base truncate" title="${item.name}">${displayName}</span>
                                </div>
                            </div>

                            <div class="flex flex-col gap-1 md:w-1/2">
                                <div class="flex items-center gap-2 text-xs text-gray-400">
                                    <span class="w-4 text-center opacity-50">ğŸ“…</span>
                                    <span class="font-mono">${dateStr}</span>
                                </div>

                                <div class="flex items-center gap-2 text-[10px] md:text-xs tracking-tighter md:tracking-normal text-gray-400 font-mono select-all">
                                    <span class="w-4 text-center opacity-50">ğŸ“</span>
                                    <span class="truncate text-gray-300">${item.coordinate}</span>
                                </div>

                                ${locStr ? `
                                <div class="flex items-center gap-2 text-xs text-blue-300/80" title="${locStr}">
                                    <span class="w-4 text-center opacity-50">ğŸŒ</span>
                                    <span class="truncate">${locStr}</span>
                                </div>` : ''}
                                
                                ${tagsHtml ? `
                                <div class="flex flex-wrap gap-1 mt-0.5 pl-6">
                                    ${tagsHtml}
                                </div>` : ''}
                            </div>
                        </div>

                        <div class="ml-auto pl-2 flex flex-col justify-center gap-2 shrink-0">
                            <button onclick="copyToClipboard('${item.coordinate}', this)" 
                                class="flex items-center justify-center w-9 h-9 md:w-auto md:h-8 md:px-3 bg-gray-800 hover:bg-blue-500/20 text-gray-500 hover:text-blue-400 border border-gray-700 hover:border-blue-500/50 rounded transition-all duration-200" title="è¤‡è£½åº§æ¨™">
                                <span class="text-xs">ğŸ“‹</span>
                            </button>

                            <button onclick="openEditModal('${item.source}', '${item.id}')" 
                                class="flex items-center justify-center w-9 h-9 md:w-auto md:h-8 md:px-3 bg-gray-800 hover:bg-yellow-500/20 text-gray-500 hover:text-yellow-400 border border-gray-700 hover:border-yellow-500/50 rounded transition-all duration-200" title="ç·¨è¼¯">
                                <span class="text-xs">âœï¸</span>
                            </button>

                            <button onclick="deleteItem('${item.source}', '${item.id}', '${item.name.replace(/'/g, "\\'")}', '${item.friend_code || ''}')" 
                                class="flex items-center justify-center w-9 h-9 md:w-auto md:h-8 md:px-3 bg-gray-800 hover:bg-red-500/20 text-gray-500 hover:text-red-400 border border-gray-700 hover:border-red-500/50 rounded transition-all duration-200" title="åˆªé™¤">
                                <span class="text-xs">ğŸ—‘ï¸</span>
                            </button>
                        </div>
                    </div>`;
                });

                htmlContent += `</div>`;
                groupEl.innerHTML = htmlContent;
                container.appendChild(groupEl);
            });
        }

        window.deleteItem = async (source, id, nickname, friendCode) => {
            if (!confirm('ç¢ºå®šè¦åŸ·è¡Œåˆªé™¤å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·')) return;
            
            const btn = event.currentTarget; // ä½¿ç”¨ currentTarget ç¢ºä¿æŠ“åˆ° button å…ƒç´ 
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin h-4 w-4 border-2 border-red-500 border-t-transparent rounded-full"></span>';
            
            try {
                let action = source === 'library' ? 'delete-postcard' : 'delete-guest-postcard';
                let payload = source === 'library' ? { postcardId: id } : { id: id, nickname, friendCode };

                const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ action, payload })
                });

                if (error) throw error;

                // --- æˆåŠŸå¾Œçš„ UI èˆ‡è³‡æ–™æ›´æ–°é‚è¼¯ ---

                // 1. æ‰¾åˆ° DOM å…ƒç´ 
                const row = document.getElementById(`item-${source}-${id}`);
                if (!row) return;

                // 2. æ›´æ–°å…¨åŸŸè³‡æ–™è®Šæ•¸ (currentTabData)
                // é€™æ˜¯ç‚ºäº†ç¢ºä¿åˆ‡æ› Tab æ™‚ï¼Œè³‡æ–™ä¹Ÿæ˜¯æœ€æ–°çš„
                const groupData = currentTabData[activeTab].find(g => g.items.some(i => i.id == id && i.source == source));
                if (groupData) {
                    groupData.items = groupData.items.filter(i => !(i.id == id && i.source == source));
                }

                // 3. UI å‹•ç•«ï¼šç§»é™¤è©²é …ç›®
                row.style.transition = 'all 0.3s ease-out';
                row.style.opacity = '0';
                row.style.transform = 'translateX(20px)';

                setTimeout(() => {
                    const listWrapper = row.parentElement; // .flex-col å®¹å™¨
                    const cardGroup = listWrapper.parentElement; // .card-group å®¹å™¨
                    
                    row.remove(); // ç§»é™¤ DOM

                    // 4. æª¢æŸ¥è©²ç¾¤çµ„å‰©é¤˜æ•¸é‡
                    // listWrapper.children åŒ…å«äº†å‰©ä¸‹çš„ .list-row
                    const remainingCount = listWrapper.children.length;

                    if (remainingCount < 2) {
                        // å¦‚æœå‰©é¤˜æ•¸é‡å°æ–¼ 2 (åªå‰© 1 å€‹æˆ– 0 å€‹)ï¼Œä»£è¡¨ä¸å†æ˜¯ã€Œé‡è¤‡ç¾¤çµ„ã€
                        // å°‡æ•´å€‹ç¾¤çµ„å¡ç‰‡ç§»é™¤
                        cardGroup.style.transition = 'all 0.5s ease';
                        cardGroup.style.opacity = '0';
                        cardGroup.style.maxHeight = '0';
                        cardGroup.style.marginBottom = '0';
                        
                        setTimeout(() => cardGroup.remove(), 500);

                        // å¾å…¨åŸŸè³‡æ–™ä¸­ç§»é™¤è©²ç¾¤çµ„ (å› ç‚ºå®ƒä¸å†ç®—æ˜¯ä¸€çµ„é‡è¤‡è³‡æ–™)
                        if (groupData) {
                            currentTabData[activeTab] = currentTabData[activeTab].filter(g => g !== groupData);
                        }
                    } else {
                        // å¦‚æœç¾¤çµ„é‚„å­˜åœ¨ï¼Œæ›´æ–°ç¾¤çµ„æ¨™é¡Œä¸Šçš„ "N ç­†"
                        const countBadge = cardGroup.querySelector('.card-header span:last-child');
                        if (countBadge) countBadge.textContent = `${remainingCount} ç­†`;
                    }
                    
                    document.getElementById(`count-${activeTab}`).textContent = currentTabData[activeTab].length;

                }, 300);

            } catch (e) {
                console.error(e);
                alert(`åˆªé™¤å¤±æ•—: ${e.message}`);
                btn.disabled = false;
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    <span class="hidden md:inline text-xs font-medium">åˆªé™¤</span>`;
            }
        };

        // é»æ“Šè¤‡è£½åº§æ¨™åŠŸèƒ½
        window.copyToClipboard = (text, el) => {
            // é˜²æ­¢äº‹ä»¶å†’æ³¡ (é›–ç„¶ç›®å‰å¤–å±¤æ²’æœ‰é»æ“Šäº‹ä»¶ï¼Œä½†ä¿æŒå¥½ç¿’æ…£)
            event.stopPropagation();

            navigator.clipboard.writeText(text).then(() => {
                // è¦–è¦ºå›é¥‹ï¼šæš«æ™‚é¡¯ç¤º "å·²è¤‡è£½"
                const originalContent = el.innerHTML;
                // é–å®šå¯¬åº¦é¿å…è·³å‹• (é¸ç”¨)
                const width = el.offsetWidth;
                
                el.innerHTML = `
                    <span class="w-4 text-center text-green-400">âœ“</span>
                    <span class="text-green-400 font-bold">å·²è¤‡è£½!</span>
                `;
                
                setTimeout(() => {
                    el.innerHTML = originalContent;
                }, 1000);
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—:', err);
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½');
            });
        };

        window.viewImage = (url) => { document.getElementById('viewer-image').src = url; document.getElementById('image-viewer-modal').classList.remove('hidden'); };
        window.closeImageViewer = () => { document.getElementById('image-viewer-modal').classList.add('hidden'); };
        document.addEventListener('DOMContentLoaded', init);

        // --- ç·¨è¼¯åŠŸèƒ½ç›¸é—œå‡½å¼ ---
        // --- ç·¨è¼¯åŠŸèƒ½èˆ‡åœ–ç‰‡è™•ç† ---

        // 1. é–‹å•Ÿç·¨è¼¯è¦–çª—
        window.openEditModal = (source, id) => {
            let targetItem = null;
            // æœå°‹ç›®å‰é¡¯ç¤ºçš„è³‡æ–™
            for (const group of currentTabData[activeTab]) {
                const found = group.items.find(i => i.source === source && i.id == id);
                if (found) { targetItem = found; break; }
            }
            if (!targetItem) return alert('æ‰¾ä¸åˆ°è³‡æ–™');

            // å¡«å…¥è³‡æ–™
            document.getElementById('edit-source').value = source;
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-coord').value = targetItem.coordinate || '';
            document.getElementById('edit-country').value = targetItem.country || '';
            document.getElementById('edit-region').value = targetItem.region || '';
            document.getElementById('edit-area').value = targetItem.area || '';
            
            // è—å»Šéœ€è¦çš„é©—è­‰æ¬„ä½
            if (source === 'gallery') {
                document.getElementById('edit-nickname').value = targetItem.name; 
                document.getElementById('edit-friendcode').value = targetItem.friend_code;
            }

            const tags = targetItem.tags || [];
            [1,2,3].forEach((n, i) => document.getElementById(`edit-tag-${n}`).value = tags[i] || '');

            // åœ–ç‰‡é‡ç½®
            document.getElementById('edit-image-preview').src = targetItem.image_url;
            document.getElementById('edit-image-filename').textContent = 'å°šæœªé¸æ“‡æ–°åœ–ç‰‡ (ä¿ç•™åŸåœ–)';
            document.getElementById('edit-image-filename').className = 'text-xs text-gray-400 mb-2 break-all truncate';
            document.getElementById('edit-image-upload').value = '';

            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');

        // 2. åœ–ç‰‡é è¦½ (åªæ˜¯é è¦½ï¼Œä¸å½±éŸ¿è³‡æ–™åº«)
        window.handleImagePreview = (event) => {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('edit-image-preview').src = URL.createObjectURL(file);
                const nameEl = document.getElementById('edit-image-filename');
                nameEl.textContent = `æº–å‚™ä¸Šå‚³: ${file.name}`;
                nameEl.className = 'text-xs text-blue-400 font-bold mb-2 break-all truncate';
            }
        };

        // 3. é€å‡ºè¡¨å–® (ä¸Šå‚³æ–°åœ– -> å‘¼å«å¾Œç«¯ API)
        window.handleEditSubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-btn');
            const originalText = btn.textContent;
            btn.disabled = true; btn.textContent = 'è™•ç†ä¸­...';

            const source = document.getElementById('edit-source').value;
            const id = document.getElementById('edit-id').value;
            const fileInput = document.getElementById('edit-image-upload');

            try {
                let newImageUrl = null;

                // [Step 1] å¦‚æœæœ‰é¸æ–°åœ–ï¼Œå…ˆå£“ç¸®ä¸¦ä¸Šå‚³
                if (fileInput.files.length > 0) {
                    btn.textContent = 'ä¸Šå‚³åœ–ç‰‡...';
                    const compressedFile = await compressImage(fileInput.files[0]);
                    
                    // æ ¹æ“šä¾†æºæ±ºå®š Bucket (åƒè€ƒæ‚¨çš„å¾Œç«¯é‚è¼¯)
                    const bucket = source === 'library' ? 'postcard-images' : 'guest-postcard-images';
                    newImageUrl = await uploadImageToStorage(bucket, compressedFile);
                }

                // [Step 2] å‘¼å«å¾Œç«¯ API
                btn.textContent = 'å„²å­˜è³‡æ–™...';
                
                const payload = {
                    coordinate: document.getElementById('edit-coord').value,
                    country: document.getElementById('edit-country').value,
                    region: document.getElementById('edit-region').value,
                    area: document.getElementById('edit-area').value,
                    tags: [1,2,3].map(i => document.getElementById(`edit-tag-${i}`).value.trim()).filter(Boolean)
                };

                // è‹¥æœ‰æ–°åœ–æ‰æ”¾å…¥ payloadï¼Œå¾Œç«¯ index.ts æœƒè‡ªå‹•åµæ¸¬ä¸¦åˆªé™¤èˆŠåœ–
                if (newImageUrl) payload.imageUrl = newImageUrl; // æ³¨æ„åƒæ•¸åç¨±çµ±ä¸€ç‚º imageUrl

                let action = '';
                let bodyPayload = {};

                if (source === 'library') {
                    action = 'edit-postcard';
                    bodyPayload = { ...payload, postcardId: id };
                } else {
                    action = 'edit-guest-postcard';
                    bodyPayload = { 
                        ...payload, 
                        id: id,
                        nickname: document.getElementById('edit-nickname').value,
                        friendCode: document.getElementById('edit-friendcode').value
                    };
                }

                const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ action, payload: bodyPayload })
                });

                if (error) throw error;
                if (data && data.success === false) throw new Error(data.message);

                // [Step 3] æ›´æ–°æˆåŠŸï¼Œæ‰‹å‹•æ›´æ–°æœ¬åœ°åˆ—è¡¨é¡¯ç¤º
                if (newImageUrl) payload.image_url = newImageUrl; // è½‰ç‚ºå°å¯« key æ›´æ–°æœ¬åœ°å¿«å–
                updateLocalData(source, id, payload);

                alert('æ›´æ–°æˆåŠŸï¼');
                closeEditModal();
                renderActiveTab(); // é‡ç¹ªä»‹é¢

            } catch (err) {
                console.error(err);
                alert(`å¤±æ•—: ${err.message}`);
            } finally {
                btn.disabled = false; btn.textContent = originalText;
            }
        };

        // è¼”åŠ©ï¼šæ›´æ–°æœ¬åœ°è³‡æ–™ (é¿å…é‡æ–°æ•´ç†)
        function updateLocalData(source, id, newProps) {
            const updateList = (list) => {
                list.forEach(g => {
                    const item = g.items.find(i => i.source === source && i.id == id);
                    if (item) {
                        item.coordinate = newProps.coordinate;
                        item.country = newProps.country;
                        item.region = newProps.region;
                        item.area = newProps.area;
                        item.tags = newProps.tags;
                        if (newProps.image_url) item.image_url = newProps.image_url;
                    }
                });
            };
            updateList(currentTabData.exact);
            updateList(currentTabData.fuzzy);
        }

        // è¼”åŠ©ï¼šä¸Šå‚³åœ–ç‰‡åˆ° Storage
        async function uploadImageToStorage(bucket, file) {
            const fileExt = file.name.split('.').pop();
            const fileName = `${Date.now()}_${Math.random().toString(36).substring(2)}.${fileExt}`;
            const { error } = await supabaseClient.storage.from(bucket).upload(fileName, file);
            if (error) throw error;
            const { data } = supabaseClient.storage.from(bucket).getPublicUrl(fileName);
            return data.publicUrl;
        }

        // è¼”åŠ©ï¼šåœ–ç‰‡å£“ç¸® (æ¨™æº–è¨­å®š)
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                new Compressor(file, {
                    quality: 0.6, maxWidth: 1600, maxHeight: 1600, mimeType: 'image/jpeg',
                    success(result) { resolve(new File([result], file.name, { type: 'image/jpeg' })); },
                    error(err) { reject(err); },
                });
            });
        }

        // è¼”åŠ©ï¼šåº§æ¨™æ ¼å¼åŒ– & è‡ªå‹•åæŸ¥ (æ•´åˆç‰ˆ)
        function formatCoordinateString(val) {
            if (!val) return "";
            let str = val.trim();
            let match = str.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
            if (match) return `${parseFloat(match[1]).toFixed(7)}, ${parseFloat(match[2]).toFixed(7)}`;
            match = str.match(/q=(-?\d+\.\d+),(-?\d+\.\d+)/);
            if (match) return `${parseFloat(match[1]).toFixed(7)}, ${parseFloat(match[2]).toFixed(7)}`;
            
            // è™•ç†ä¸€èˆ¬åº§æ¨™
            let tempStr = str.replace(/ï¼Œ/g, ',');
            const numbers = tempStr.match(/(-?\d+(\.\d+)?)/g);
            if (numbers && numbers.length >= 2) return `${parseFloat(numbers[0]).toFixed(7)}, ${parseFloat(numbers[1]).toFixed(7)}`;
            return val;
        }

        async function autoFillLocation(lat, lng) {
            const countryIn = document.getElementById('edit-country');
            const regionIn = document.getElementById('edit-region');
            const areaIn = document.getElementById('edit-area');
            
            countryIn.placeholder = 'ğŸ”...'; regionIn.placeholder = 'ğŸ”...';
            try {
                const { data: resData } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ action: 'reverse-geocode', payload: { lat, lng } })
                });
                if (resData?.data?.address) {
                    const addr = resData.data.address;
                    if (addr.country) countryIn.value = addr.country;
                    if (addr.city || addr.county) regionIn.value = (addr.city || addr.county).replace(/è‡º/g, 'å°');
                    if (addr.suburb || addr.district) areaIn.value = addr.suburb || addr.district;
                }
            } catch (e) { console.error(e); }
            countryIn.placeholder = ''; regionIn.placeholder = '';
        }

        // ç¶å®šå·¥å…·äº‹ä»¶
        document.getElementById('paste-btn').onclick = async () => {
            try {
                const text = await navigator.clipboard.readText();
                if (text) {
                    const fmt = formatCoordinateString(text);
                    document.getElementById('edit-coord').value = fmt;
                    const parts = fmt.split(',');
                    if (parts.length === 2) await autoFillLocation(parts[0].trim(), parts[1].trim());
                }
            } catch(e) {}
        };
        document.getElementById('edit-coord').addEventListener('blur', function() { this.value = formatCoordinateString(this.value); });
    </script>
</body>
</html>