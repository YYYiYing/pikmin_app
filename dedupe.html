<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡è¤‡ç¾ç‰‡æ¸…ç†å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #111827; color: #d1d5db; font-family: 'Inter', sans-serif; padding-bottom: 40px; }
        
        /* å„ªåŒ–å¾Œçš„å¡ç‰‡ç¾¤çµ„ */
        .card-group { 
            background-color: #1f2937; 
            border: 1px solid #374151; 
            border-radius: 0.75rem; 
            overflow: hidden; 
            margin-bottom: 1.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* ç¾¤çµ„æ¨™é¡Œï¼šæ‰‹æ©Ÿç‰ˆå‚ç›´æ’åˆ—ï¼Œå¹³æ¿ä»¥ä¸Šæ°´å¹³æ’åˆ— */
        .card-header { 
            background-color: #374151; 
            padding: 0.75rem 1rem; 
            color: white; 
            display: flex; 
            flex-direction: column; 
            gap: 0.5rem;
        }
        @media (min-width: 768px) {
            .card-header { flex-direction: row; justify-content: space-between; align-items: center; }
        }

        /* å–®ä¸€å¡ç‰‡é …ç›® */
        .card-item { 
            display: flex; 
            gap: 0.75rem; 
            padding: 1rem; 
            border-bottom: 1px solid #374151; 
            align-items: flex-start; /* é ‚å°é½Šï¼Œè®“é•·å…§å®¹æ›´å¥½çœ‹ */
            position: relative;
        }
        .card-item:last-child { border-bottom: none; }

        /* æ¨™ç±¤æ¨£å¼ */
        .tag { 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-size: 0.7rem; 
            font-weight: bold; 
            white-space: nowrap;
            display: inline-block;
        }
        .tag-lib { background-color: #db2777; color: white; }
        .tag-gal { background-color: #7c3aed; color: white; }

        /* åˆ†é æŒ‰éˆ•å„ªåŒ– */
        .tab-btn { 
            flex: 1; 
            text-align: center; 
            padding: 0.75rem 0.5rem; 
            cursor: pointer; 
            border-bottom: 2px solid transparent; 
            transition: all 0.3s; 
            font-size: 0.9rem;
            color: #9ca3af;
        }
        .tab-btn.active { 
            color: #60a5fa; 
            border-bottom-color: #60a5fa; 
            font-weight: bold; 
            background-color: rgba(31, 41, 55, 0.5);
        }

        .modal-backdrop { background-color: rgba(0, 0, 0, 0.95); backdrop-filter: blur(4px); }

        /* ä¿®æ”¹ .card-group è®“å®ƒåœ¨åˆ—è¡¨æ¨¡å¼ä¸‹æ›´ç·Šæ¹Š */
        .card-group {
            background-color: #1f2937; /* Gray-800 */
            border: 1px solid #374151;
            border-radius: 0.75rem;
            overflow: hidden;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        /* åˆ—è¡¨é …ç›®çš„æ–°æ¨£å¼ */
        .list-row {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #374151;
            background-color: #1f2937; /* èˆ‡èƒŒæ™¯åŒè‰²ï¼Œæ¸›å°‘æ¡†ç·šæ„Ÿ */
            transition: background-color 0.2s;
        }
        .list-row:last-child {
            border-bottom: none;
        }
        .list-row:hover {
            background-color: #2d3748; /* Gray-750 hover */
        }
    </style>
</head>
<body class="px-4">

    <div class="max-w-3xl mx-auto">
        <header class="sticky top-0 z-40 bg-[#111827]/95 backdrop-blur-sm border-b border-gray-700 py-4 mb-6 shadow-md -mx-4 px-4 flex justify-between items-center">
            <div class="flex flex-col">
                <h1 class="text-xl md:text-2xl font-bold text-white flex items-center gap-2">
                    ğŸ§¹ ç¾ç‰‡æ¸…ç†å°å·¥å…·
                    <span class="text-[10px] bg-blue-600/20 text-blue-400 border border-blue-500/30 px-2 py-0.5 rounded whitespace-nowrap hidden md:inline-block">ç®¡ç†å“¡</span>
                </h1>
                <span class="text-xs text-gray-500 md:hidden">é‡è¤‡ç¾ç‰‡ç®¡ç†</span>
            </div>
            
            <a href="javascript:history.back()" class="flex items-center gap-1 text-sm bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-1.5 rounded-lg border border-gray-600 transition">
                <span>â†©</span> è¿”å›
            </a>
        </header>

        <div id="status-bar" class="mb-4 text-center text-gray-400 text-sm animate-pulse">æ­£åœ¨åˆå§‹åŒ–...</div>

        <div class="flex border-b border-gray-700 mb-6 bg-gray-800 rounded-t-lg overflow-hidden sticky top-[73px] z-30 shadow-lg">
            <div id="tab-exact" class="tab-btn active" onclick="switchTab('exact')">
                å®Œå…¨é‡è¤‡ <span id="count-exact" class="text-xs bg-gray-700 px-1.5 py-0.5 rounded-full ml-1">0</span>
            </div>
            <div id="tab-fuzzy" class="tab-btn" onclick="switchTab('fuzzy')">
                é„°è¿‘åµæ¸¬ <span id="count-fuzzy" class="text-xs bg-gray-700 px-1.5 py-0.5 rounded-full ml-1">0</span>
            </div>
        </div>

        <div id="list-container" class="space-y-6 pb-20">
            </div>
    </div>

    <div id="image-viewer-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-backdrop" onclick="closeImageViewer()">
        <div class="relative max-w-5xl w-full max-h-[95vh] flex justify-center items-center" onclick="event.stopPropagation()">
            <button type="button" onclick="closeImageViewer()" class="absolute -top-12 right-0 text-white text-4xl bg-black/50 rounded-full w-10 h-10 flex items-center justify-center">&times;</button>
            <img id="viewer-image" src="" class="rounded-lg shadow-2xl max-h-[80vh] w-auto object-contain bg-gray-900 border border-gray-800">
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co';
        const PUBLIC_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, PUBLIC_KEY);

        let currentTabData = { exact: [], fuzzy: [] };
        let activeTab = 'exact';

        async function init() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡å¸³è™Ÿ'); window.location.href = './index.html'; return; }

            document.getElementById('status-bar').textContent = 'æ­£åœ¨æƒæé‡è¤‡è³‡æ–™...';
            try {
                await scanLocalDuplicates();
            } catch (err) {
                document.getElementById('status-bar').innerHTML = `<span class="text-red-500">éŒ¯èª¤: ${err.message}</span>`;
            }
        }

        const getCoordKey = (coord, precision = 6) => {
            if (!coord) return 'unknown';
            const parts = coord.split(',').map(s => {
                const num = parseFloat(s.trim());
                return isNaN(num) ? 0 : num.toFixed(precision);
            });
            return parts.join(',');
        };

        async function scanLocalDuplicates() {
            const [libRes, galRes] = await Promise.all([
                supabaseClient.from('postcards').select('*'),
                supabaseClient.from('guest_postcards').select('*')
            ]);

            const libraryItems = libRes.data || [];
            const galleryItems = galRes.data || [];

            const allItems = [
                ...libraryItems.map(i => ({...i, source: 'library', name: i.uploader_nickname, label: 'åœ–æ›¸é¤¨'})),
                ...galleryItems.map(i => ({...i, source: 'gallery', name: i.nickname, label: 'è—å»Š'}))
            ];
            
            // éœ€æ±‚ï¼šæ’é™¤ã€Œç³»çµ±è½‰ç§» (system_import)ã€ä¸”ã€Œåœ–æ›¸é¤¨å·²æœ‰åŸå§‹æª”ã€çš„åˆæ³•å…±ç”¨è³‡æ–™
            const filteredItems = allItems.filter(item => {
                // 1. é–å®šè—å»Šä¾†æºï¼Œä¸” ip_fingerprint æ¨™è¨˜ç‚º 'system_import'
                if (item.source === 'gallery' && item.ip_fingerprint === 'system_import') {
                    
                    // 2. æª¢æŸ¥åœ–æ›¸é¤¨æ˜¯å¦å·²å­˜åœ¨ã€Œå®Œå…¨ç›¸åŒåº§æ¨™ã€çš„åŸå§‹æª”
                    // ä½¿ç”¨ getCoordKey(..., 6) ç¢ºä¿æ¯”å°ç²¾åº¦ä¸€è‡´
                    const existsInLib = libraryItems.some(lib => 
                        getCoordKey(lib.coordinate, 6) === getCoordKey(item.coordinate, 6)
                    );
                    
                    // 3. å¦‚æœåœ–æ›¸é¤¨æœ‰åŸå§‹æª”ï¼Œä»£è¡¨é€™æ˜¯åˆæ³•çš„å…±ç”¨ç©ºé–“ï¼Œä¸è¦–ç‚ºé‡è¤‡ï¼Œäºˆä»¥ã€éš±è—ã€‘
                    if (existsInLib) return false; 
                }
                return true; // å…¶ä»–æƒ…æ³éƒ½ä¿ç•™åœ¨æª¢æŸ¥åˆ—è¡¨ä¸­
            });

            const exactGroups = new Map();
            const fuzzyGroups = new Map();

            filteredItems.forEach(item => {
                const eKey = getCoordKey(item.coordinate, 6);
                const fKey = getCoordKey(item.coordinate, 3);

                if (!exactGroups.has(eKey)) exactGroups.set(eKey, []);
                exactGroups.get(eKey).push(item);

                if (!fuzzyGroups.has(fKey)) fuzzyGroups.set(fKey, []);
                fuzzyGroups.get(fKey).push(item);
            });

            currentTabData.exact = Array.from(exactGroups.entries())
                .filter(([_, items]) => items.length > 1)
                .map(([key, items]) => ({ key, items }));

            currentTabData.fuzzy = Array.from(fuzzyGroups.entries())
                .filter(([fKey, items]) => {
                    const uniquePoints = new Set(items.map(i => getCoordKey(i.coordinate, 6)));
                    return items.length > 1 && uniquePoints.size > 1; 
                })
                .map(([key, items]) => ({ key, items }));

            document.getElementById('count-exact').textContent = currentTabData.exact.length;
            document.getElementById('count-fuzzy').textContent = currentTabData.fuzzy.length;
            document.getElementById('status-bar').textContent = ''; 
            
            renderActiveTab();
        }

        function switchTab(tab) {
            activeTab = tab;
            document.getElementById('tab-exact').className = `tab-btn ${tab === 'exact' ? 'active' : ''}`;
            document.getElementById('tab-fuzzy').className = `tab-btn ${tab === 'fuzzy' ? 'active' : ''}`;
            renderActiveTab();
        }

        function renderActiveTab() {
            const container = document.getElementById('list-container');
            const data = currentTabData[activeTab];
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-24 px-4 text-center border-2 border-dashed border-gray-700 rounded-xl bg-gray-800/50">
                        <div class="text-4xl mb-4 opacity-80">ğŸ‰</div>
                        <h3 class="text-xl font-bold text-gray-300 mb-2">ä¹¾æ·¨æºœæºœï¼</h3>
                        <p class="text-gray-500">æ²’æœ‰ç™¼ç¾æ­¤é¡å‹çš„é‡è¤‡è³‡æ–™ã€‚</p>
                    </div>`;
                return;
            }

            data.forEach(group => {
                const groupEl = document.createElement('div');
                // ç¾¤çµ„å®¹å™¨
                groupEl.className = 'card-group';

                // 1. ç¾¤çµ„æ¨™é¡Œ (ç¶­æŒåŸæ¨£ï¼Œä½†å¾®èª¿é¡è‰²)
                let htmlContent = `
                    <div class="card-header bg-gray-900/80 p-3 flex flex-wrap md:flex-nowrap justify-between items-center gap-3 border-b border-gray-700">
                        <div class="flex items-center gap-3 overflow-hidden min-w-0 flex-1">
                            <span class="flex items-center justify-center w-6 h-6 rounded-full bg-red-500/10 text-red-400 text-sm flex-shrink-0">ğŸ“</span>
                            <h2 class="font-mono text-sm md:text-base text-gray-200 truncate font-bold tracking-wide select-all" title="${group.key}">
                                ${group.key}
                            </h2>
                        </div>
                        <span class="text-xs font-mono bg-gray-800 text-gray-400 px-2 py-1 rounded border border-gray-700 whitespace-nowrap">
                            ${group.items.length} ç­†
                        </span>
                    </div>`;

                // 2. å…§å®¹åˆ—è¡¨å®¹å™¨ (æ”¹ç‚º flex column)
                htmlContent += `<div class="flex flex-col">`;

                group.items.sort((a, b) => new Date(a.created_at) - new Date(b.created_at)).forEach((item) => {
                    const isLib = item.source === 'library';
                    const locStr = [item.country, item.region, item.area].filter(Boolean).join(' Â· ');

                    // æ—¥æœŸæ ¼å¼åŒ–
                    const dateObj = new Date(item.created_at);
                    const dateStr = dateObj.toLocaleDateString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });

                    // åç¨±è™•ç†
                    let displayName = (item.name || 'æœªå‘½å').replace(/\d{12}/g, '').trim();
                    if (!displayName) displayName = item.name || 'æœªå‘½å';

                    // æ¨™ç±¤æ¨£å¼ (æ”¹ç‚º Pill å½¢ç‹€)
                    const badgeClass = isLib 
                        ? 'bg-pink-900/30 text-pink-300 border-pink-700/50' 
                        : 'bg-violet-900/30 text-violet-300 border-violet-700/50';
                    const badgeText = isLib ? 'åœ–æ›¸é¤¨' : 'è—å»Š';

                    // åˆ—è¡¨é …ç›® HTML
                    htmlContent += `
                    <div class="list-row group" id="item-${item.source}-${item.id}">
                        
                        <div class="relative w-20 h-20 md:w-24 md:h-24 shrink-0 cursor-zoom-in overflow-hidden rounded-lg bg-gray-900 border border-gray-700" onclick="viewImage('${item.image_url}')">
                            <img src="${item.image_url}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy">
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors"></div>
                        </div>

                        <div class="flex-1 min-w-0 ml-4 flex flex-col md:flex-row md:items-center gap-2 md:gap-6">
                            
                            <div class="flex flex-col md:flex-row md:items-center gap-2 md:w-1/3">
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] px-1.5 py-0.5 rounded border ${badgeClass} whitespace-nowrap">
                                        ${badgeText}
                                    </span>
                                    <span class="font-bold text-gray-200 text-sm md:text-base truncate" title="${item.name}">
                                        ${displayName}
                                    </span>
                                </div>
                            </div>

                            <div class="flex flex-col gap-1 md:w-1/3">
                                <div class="flex items-center gap-2 text-xs text-gray-400">
                                    <span class="w-4 text-center opacity-50">ğŸ“…</span>
                                    <span class="font-mono">${dateStr}</span>
                                </div>
                                ${locStr ? `
                                <div class="flex items-center gap-2 text-xs text-blue-300/80" title="${locStr}">
                                    <span class="w-4 text-center opacity-50">ğŸŒ</span>
                                    <span class="truncate">${locStr}</span>
                                </div>` : ''}
                            </div>

                            <div class="hidden md:flex items-center gap-2 text-[10px] text-gray-500 font-mono md:w-1/4">
                                <span class="w-4 text-center">ğŸ“</span>
                                <span class="truncate opacity-50">${item.coordinate}</span>
                            </div>

                        </div>

                        <div class="ml-auto pl-3">
                            <button onclick="deleteItem('${item.source}', '${item.id}', '${item.name.replace(/'/g, "\\'")}', '${item.friend_code || ''}')" 
                                class="flex flex-col md:flex-row items-center justify-center gap-1 w-10 h-10 md:w-auto md:h-auto md:px-3 md:py-2 bg-transparent hover:bg-red-500/10 text-gray-500 hover:text-red-400 border border-transparent hover:border-red-500/30 rounded-lg transition-all duration-200 group-hover:text-gray-400"
                                title="åˆªé™¤æ­¤é …ç›®">
                                
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                <span class="hidden md:inline text-xs font-medium">åˆªé™¤</span>
                            </button>
                        </div>

                    </div>`;
                });

                htmlContent += `</div>`; // é—œé–‰ flex-col
                groupEl.innerHTML = htmlContent;
                container.appendChild(groupEl);
            });
        }

        window.deleteItem = async (source, id, nickname, friendCode) => {
            if (!confirm('ç¢ºå®šè¦åŸ·è¡Œåˆªé™¤å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·')) return;
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '...';
            btn.classList.add('opacity-50');

            try {
                let action = source === 'library' ? 'delete-postcard' : 'delete-guest-postcard';
                let payload = source === 'library' ? { postcardId: id } : { id: id, nickname, friendCode };

                const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ action, payload })
                });

                if (error) throw error;
                
                // åˆªé™¤å‹•ç•«
                const row = document.getElementById(`item-${source}-${id}`);
                if(row) {
                    row.style.transition = 'all 0.5s';
                    row.style.opacity = '0';
                    row.style.transform = 'translateX(20px)';
                    setTimeout(() => {
                        // å¦‚æœè©²ç¾¤çµ„åªå‰©ä¸€å€‹é …ç›®ï¼Œé€£ç¾¤çµ„ä¸€èµ·åˆªé™¤ (å› ç‚ºä¸é‡è¤‡äº†)
                        const parentGroup = row.parentElement;
                        row.remove();
                        if(parentGroup.children.length <= 1) { // 1 æ˜¯å› ç‚ºé‚„æœ‰ header
                            parentGroup.style.display = 'none';
                        }
                    }, 500);
                }
                
            } catch (e) {
                alert(`åˆªé™¤å¤±æ•—: ${e.message}`);
                btn.disabled = false;
                btn.textContent = 'ğŸ—‘ï¸ åˆªé™¤';
                btn.classList.remove('opacity-50');
            }
        };

        window.viewImage = (url) => { document.getElementById('viewer-image').src = url; document.getElementById('image-viewer-modal').classList.remove('hidden'); };
        window.closeImageViewer = () => { document.getElementById('image-viewer-modal').classList.add('hidden'); };
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>