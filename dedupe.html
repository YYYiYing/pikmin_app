<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡è¤‡ç¾ç‰‡æ¸…ç†å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #111827; color: #d1d5db; font-family: sans-serif; }
        .card-group { background-color: #1f2937; border: 1px solid #374151; border-radius: 0.75rem; overflow: hidden; margin-bottom: 2rem; }
        .card-header { background-color: #374151; padding: 0.75rem 1rem; font-weight: bold; color: white; display: flex; justify-content: space-between; align-items: center; }
        .card-item { display: flex; gap: 1rem; padding: 1rem; border-bottom: 1px solid #374151; align-items: center; }
        .card-item:last-child { border-bottom: none; }
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .tag-lib { background-color: #db2777; color: white; } /* ç²‰ç´…: åœ–æ›¸é¤¨ */
        .tag-gal { background-color: #7c3aed; color: white; } /* ç´«è‰²: è—å»Š */
        
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.9); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="p-6">

    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-2xl font-bold text-white">ğŸ§¹ é‡è¤‡ç¾ç‰‡æ¸…ç†å·¥å…·</h1>
            <a href="./index.html" class="text-gray-400 hover:text-white">å›é¦–é </a>
        </header>

        <div id="status-bar" class="mb-6 text-center text-gray-400">æ­£åœ¨æª¢æŸ¥æ¬Šé™...</div>

        <div id="duplicate-list" class="space-y-6"></div>
    </div>

    <div id="image-viewer-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-backdrop transition-opacity duration-300" onclick="closeImageViewer()">
        <div class="relative max-w-5xl w-full max-h-[95vh] flex justify-center items-center p-2" onclick="event.stopPropagation()">
            <button type="button" onclick="closeImageViewer()" class="absolute -top-12 right-0 md:top-4 md:right-4 text-white text-4xl hover:text-gray-300 font-bold bg-black/50 hover:bg-black/70 rounded-full w-12 h-12 flex items-center justify-center transition z-50">&times;</button>
            <img id="viewer-image" src="" alt="ç¾ç‰‡å¤§åœ–" class="rounded-lg shadow-2xl max-h-[85vh] md:max-h-[90vh] w-auto object-contain bg-gray-900 border border-gray-800">
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co';
        const PUBLIC_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, PUBLIC_KEY);

        async function init() {
            // 1. æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡å¸³è™Ÿ');
                window.location.href = './index.html';
                return;
            }

            document.getElementById('status-bar').textContent = 'æ­£åœ¨è®€å–è³‡æ–™åº«ä¸¦é€²è¡Œæœ¬åœ°æ¯”å°...';

            // 2. æ”¹ç‚ºç›´æ¥åœ¨å‰ç«¯æŠ“å–è³‡æ–™ä¸¦æ¯”å° (é€™æ¨£ä¿®æ”¹é‚è¼¯æœ€å¿«ï¼Œä¸ç”¨å‹•å¾Œç«¯)
            try {
                await scanLocalDuplicates();
            } catch (err) {
                console.error(err);
                document.getElementById('status-bar').innerHTML = `<span class="text-red-500">ç™¼ç”ŸéŒ¯èª¤: ${err.message}</span>`;
            }
        }

        // æ ¸å¿ƒé‚è¼¯ï¼šæœ¬åœ°æƒæé‡è¤‡
        // æ ¸å¿ƒé‚è¼¯ï¼šæœ¬åœ°æƒæé‡è¤‡ (ä¿®æ­£ç‰ˆï¼šåƒ…æ¯”å°å–®ä¸€ä¾†æºå…§éƒ¨çš„é‡è¤‡)
        async function scanLocalDuplicates() {
            const [libRes, galRes] = await Promise.all([
                supabaseClient.from('postcards').select('id, coordinate, created_at, image_url, uploader_nickname'),
                supabaseClient.from('guest_postcards').select('id, coordinate, created_at, image_url, nickname, friend_code, tags')
            ]);

            if (libRes.error) throw libRes.error;
            if (galRes.error) throw galRes.error;

            const libraryItems = libRes.data || [];
            const galleryItems = galRes.data || [];

            const coordMap = new Map();

            // åº§æ¨™æ¨™æº–åŒ– (å–å°æ•¸é»å¾Œ 3 ä½)
            const normalize = (coord) => {
                if (!coord) return 'unknown';
                const parts = coord.split(',').map(s => parseFloat(s.trim()));
                if (parts.length < 2 || isNaN(parts[0])) return coord;
                return `${parts[0].toFixed(3)},${parts[1].toFixed(3)}`;
            };

            // æ­¸æˆ¶è³‡æ–™
            libraryItems.forEach(item => {
                const key = normalize(item.coordinate);
                if (!coordMap.has(key)) coordMap.set(key, []);
                coordMap.get(key).push({
                    id: item.id,
                    coordinate: item.coordinate,
                    image_url: item.image_url,
                    created_at: item.created_at,
                    source: 'library',
                    sourceLabel: 'ğŸ“š åœ–æ›¸é¤¨',
                    name: item.uploader_nickname,
                    tags: []
                });
            });

            galleryItems.forEach(item => {
                const key = normalize(item.coordinate);
                if (!coordMap.has(key)) coordMap.set(key, []);
                coordMap.get(key).push({
                    id: item.id,
                    coordinate: item.coordinate,
                    image_url: item.image_url,
                    created_at: item.created_at,
                    source: 'gallery',
                    sourceLabel: 'ğŸ¨ è—å»Š',
                    name: item.nickname,
                    friend_code: item.friend_code,
                    tags: item.tags || []
                });
            });

            const duplicates = [];

            for (const [key, items] of coordMap.entries()) {
                if (key === 'unknown') continue;

                // åˆ†åˆ¥è¨ˆç®—è©²åº§æ¨™åœ¨å„è¡¨çš„ç­†æ•¸
                const libs = items.filter(i => i.source === 'library');
                const gals = items.filter(i => i.source === 'gallery');

                // --- åˆ¤æ–·é‚è¼¯ ---
                // æ¢ä»¶ Aï¼šåœ–æ›¸é¤¨å…§éƒ¨æœ‰é‡è¤‡ (>=2 ç­†)
                // æ¢ä»¶ Bï¼šè—å»Šå…§éƒ¨æœ‰é‡è¤‡ (>=2 ç­†)
                // åªè¦ç¬¦åˆå…¶ä¸­ä¸€å€‹ï¼Œé€™çµ„åº§æ¨™å°±è¦é¡¯ç¤ºå‡ºä¾†
                if (libs.length >= 2 || gals.length >= 2) {
                    // ç‚ºäº†æ–¹ä¾¿æ¸…ç†ï¼Œæˆ‘å€‘ä¾ç„¶æŠŠè©²åº§æ¨™çš„æ‰€æœ‰è³‡æ–™éƒ½é¡¯ç¤ºå‡ºä¾† (åŒ…å«å°æ‡‰çš„æ¬å®¶æª”)
                    // é€™æ¨£æ‚¨æ‰èƒ½æ±ºå®šè¦åˆªé™¤å“ªä¸€é‚Š
                    duplicates.push({ coordinateKey: key, items: items });
                }
            }

            duplicates.sort((a, b) => b.items.length - a.items.length);

            renderList(duplicates);
            document.getElementById('status-bar').textContent = `æƒæå®Œæˆï¼ç™¼ç¾ ${duplicates.length} çµ„é‡è¤‡è³‡æ–™ã€‚`;
        }

        function renderList(duplicates) {
            const container = document.getElementById('duplicate-list');
            container.innerHTML = '';

            if (duplicates.length === 0) {
                container.innerHTML = '<div class="text-center text-green-400 py-10 text-xl">ğŸ‰ å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰ç™¼ç¾é‡è¤‡çš„è³‡æ–™ã€‚</div>';
                return;
            }

            duplicates.forEach((group) => {
                const groupEl = document.createElement('div');
                groupEl.className = 'card-group';
                
                // è¨ˆç®—ç¾¤çµ„å…§çš„åˆ†é¡æ•¸é‡
                const libCount = group.items.filter(i => i.source === 'library').length;
                const galCount = group.items.filter(i => i.source === 'gallery').length;

                // ç¾¤çµ„æ¨™é¡Œ
                groupEl.innerHTML = `
                    <div class="card-header">
                        <div class="flex flex-col md:flex-row md:items-center gap-2">
                            <span>ğŸ“ åº§æ¨™: ${group.coordinateKey}</span>
                            <span class="text-xs font-normal text-gray-400">(åœ–æ›¸é¤¨: ${libCount}, è—å»Š: ${galCount})</span>
                        </div>
                        <span class="text-sm bg-gray-600 px-2 py-1 rounded whitespace-nowrap">å…± ${group.items.length} ç­†</span>
                    </div>
                `;

                // åˆ—è¡¨é …ç›®
                group.items.forEach(item => {
                    const isLib = item.source === 'library';
                    const tagClass = isLib ? 'tag-lib' : 'tag-gal';
                    const dateStr = new Date(item.created_at).toLocaleString('zh-TW', { hour12: false });
                    
                    // æª¢æŸ¥æ˜¯å¦ç‚ºç³»çµ±æ¬ç§»çš„å¡ç‰‡
                    const isSystemImport = !isLib && item.tags && item.tags.includes('system_import');
                    const systemBadge = isSystemImport 
                        ? `<span class="ml-2 text-[10px] border border-blue-500 text-blue-400 px-1 rounded">ç³»çµ±è½‰ç§»</span>` 
                        : '';

                    const itemEl = document.createElement('div');
                    itemEl.className = 'card-item bg-gray-800 hover:bg-gray-750 transition';
                    itemEl.id = `item-${item.source}-${item.id}`; 
                    
                    itemEl.innerHTML = `
                        <div class="w-24 h-16 flex-shrink-0 bg-gray-900 rounded overflow-hidden border border-gray-700 cursor-pointer hover:opacity-80 transition" onclick="viewImage('${item.image_url}')">
                            <img src="${item.image_url}" class="w-full h-full object-cover" title="é»æ“ŠæŸ¥çœ‹å¤§åœ–">
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="tag ${tagClass}">${item.sourceLabel}</span>
                                <span class="font-bold text-white truncate text-sm md:text-base">${item.name}</span>
                                <span class="text-xs text-gray-500">#${item.id}</span>
                                ${systemBadge}
                            </div>
                            <div class="text-xs text-gray-400">ğŸ“… ${dateStr}</div>
                            <div class="text-xs text-gray-500 truncate font-mono">${item.coordinate}</div>
                        </div>
                        <button onclick="deleteItem('${item.source}', '${item.id}', '${item.name}', '${item.friend_code || ''}')" 
                            class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 md:px-4 md:py-2 rounded text-xs md:text-sm font-bold transition shadow whitespace-nowrap">
                            ğŸ—‘ï¸ åˆªé™¤
                        </button>
                    `;
                    groupEl.appendChild(itemEl);
                });

                container.appendChild(groupEl);
            });
        }

        // åˆªé™¤å‡½å¼ (ç¶­æŒä¸è®Šï¼Œå‘¼å«å¾Œç«¯ Action)
        window.deleteItem = async (source, id, nickname, friendCode) => {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µå¡ç‰‡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;

            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '...';
            btn.disabled = true;

            try {
                let action = '';
                let payload = {};

                if (source === 'library') {
                    action = 'delete-postcard'; 
                    payload = { postcardId: id };
                } else {
                    action = 'delete-guest-postcard'; 
                    payload = { id: id, nickname: nickname, friendCode: friendCode };
                }

                const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ action, payload })
                });

                if (error) throw error;
                if (data && data.error) throw new Error(data.error);

                // ç§»é™¤ç•«é¢ä¸Šçš„è©²åˆ—
                const row = document.getElementById(`item-${source}-${id}`);
                if(row) {
                    row.style.opacity = '0';
                    setTimeout(() => row.remove(), 300);
                }

            } catch (e) {
                console.error(e);
                alert(`åˆªé™¤å¤±æ•—: ${e.message}`);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        };

        // åœ–ç‰‡æª¢è¦–å™¨é‚è¼¯
        window.viewImage = (url) => {
            const m = document.getElementById('image-viewer-modal');
            const i = document.getElementById('viewer-image');
            if(m && i) { 
                i.src = url; 
                m.classList.remove('hidden'); 
                document.body.style.overflow = 'hidden'; 
            }
        };
        
        window.closeImageViewer = () => {
            const m = document.getElementById('image-viewer-modal');
            if(m) { 
                m.classList.add('hidden'); 
                document.body.style.overflow = ''; 
                setTimeout(() => document.getElementById('viewer-image').src='', 300); 
            }
        };
        
        document.addEventListener('keydown', (e) => { 
            if(e.key==='Escape') window.closeImageViewer(); 
        });

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>