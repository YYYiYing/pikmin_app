<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡æºç›£æ§ - è‡è‡å®…é…ç¶²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #111827; color: #d1d5db; font-family: sans-serif; }
        .monitor-card { background-color: #1f2937; border: 1px solid #374151; border-radius: 1rem; padding: 1.5rem; }
        .bar-transition { transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.5s; }
    </style>
</head>
<body class="p-6 md:p-12">
    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-2xl font-bold text-white flex items-center gap-2">ğŸ“Š ç³»çµ±è³‡æºç›£æ§</h1>
            <div class="flex gap-3">
                <button onclick="loadStats()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition">ğŸ”„ åˆ·æ–°</button>
                <a href="./admin.html" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition">è¿”å›å¾Œå°</a>
            </div>
        </header>

        <div id="loading" class="text-center py-20 text-gray-500">æ­£åœ¨è®€å–è³‡æºæ•¸æ“š...</div>

        <div id="stats-grid" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="monitor-card">
                <div class="flex justify-between items-end mb-2">
                    <h3 class="font-bold">æ•¸æ“šåº«ç©ºé–“ (DB Size)</h3>
                    <span id="db-size-text" class="text-xs font-mono">0 / 500 MB</span>
                </div>
                <div class="w-full bg-gray-800 rounded-full h-4 overflow-hidden border border-gray-700">
                    <div id="db-size-bar" class="bar-transition h-full w-0"></div>
                </div>
                <p id="db-size-percent" class="text-[10px] mt-2 text-right text-gray-500">0%</p>
            </div>

            <div class="monitor-card">
                <div class="flex justify-between items-end mb-2">
                    <h3 class="font-bold">ç¸½è¡Œæ•¸ (Rows)</h3>
                    <span id="db-rows-text" class="text-xs font-mono">0 / 10,000</span>
                </div>
                <div class="w-full bg-gray-800 rounded-full h-4 overflow-hidden border border-gray-700">
                    <div id="db-rows-bar" class="bar-transition h-full w-0"></div>
                </div>
                <p id="db-rows-percent" class="text-[10px] mt-2 text-right text-gray-500">0%</p>
            </div>

            <div class="monitor-card">
                <div class="flex justify-between items-end mb-2">
                    <h3 class="font-bold">æ–‡ä»¶å„²å­˜ (Storage)</h3>
                    <span id="storage-text" class="text-xs font-mono">0 / 1,024 MB</span>
                </div>
                <div class="w-full bg-gray-800 rounded-full h-4 overflow-hidden border border-gray-700">
                    <div id="storage-bar" class="bar-transition h-full w-0"></div>
                </div>
                <p id="storage-percent" class="text-[10px] mt-2 text-right text-gray-500">0%</p>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co';
        const PUBLIC_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ';
        const supabaseClient = supabase.createClient(SUPABASE_URL, PUBLIC_KEY);

        async function loadStats() {
            const loading = document.getElementById('loading');
            const grid = document.getElementById('stats-grid');
            loading.classList.remove('hidden');
            grid.classList.add('hidden');

            try {
                const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ action: 'get-system-stats' })
                });

                if (error) throw error;
                if (!data.success) throw new Error(data.data?.message || 'æœªçŸ¥éŒ¯èª¤');

                const stats = data.data;

                // æ›´æ–°ä¸‰å€‹é€²åº¦æ¢
                updateVisual('db-size', stats.dbSizeMB, 500, 'MB');
                updateVisual('db-rows', stats.totalRows, 10000, 'Rows');
                updateVisual('storage', stats.storageMB, 1024, 'MB');

                loading.classList.add('hidden');
                grid.classList.remove('hidden');
            } catch (err) {
                loading.innerHTML = `<div class="text-red-400">âŒ è®€å–å¤±æ•—<br><span class="text-xs">${err.message}</span></div>`;
            }
        }

        function updateVisual(id, current, max, unit) {
            const percent = Math.min((current / max) * 100, 100);
            const bar = document.getElementById(`${id}-bar`);
            const text = document.getElementById(`${id}-text`);
            const percentText = document.getElementById(`${id}-percent`);

            // é¡è‰²é‚è¼¯
            let colorClass = 'bg-green-500'; // 0-60% ç¶ è‰²
            if (percent > 90) colorClass = 'bg-red-500'; // 91-100% ç´…è‰²
            else if (percent > 60) colorClass = 'bg-orange-500'; // 61-90% æ©˜è‰²

            bar.className = `bar-transition h-full ${colorClass}`;
            setTimeout(() => { bar.style.width = `${percent}%`; }, 100);
            
            text.textContent = `${current.toLocaleString()} / ${max.toLocaleString()} ${unit}`;
            percentText.textContent = `${percent.toFixed(1)}%`;
        }

        document.addEventListener('DOMContentLoaded', loadStats);
    </script>
</body>
</html>