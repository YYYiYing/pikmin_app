<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡æºç›£æ§ - è‡è‡å®…é…ç¶²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #111827; color: #d1d5db; font-family: sans-serif; }
        .monitor-card { background-color: #1f2937; border: 1px solid #374151; border-radius: 1rem; padding: 1.5rem; }
        .bar-transition { transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.5s; }
        
        /* è¡¨æ ¼æ¨£å¼å„ªåŒ– */
        th { font-weight: 600; color: #9ca3af; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
        td { font-size: 0.85rem; border-bottom: 1px solid #374151; }
        tr:last-child td { border-bottom: none; }
    </style>
</head>
<body class="p-6 md:p-12">
    <div class="max-w-5xl mx-auto">
        <header class="flex justify-between items-center mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-2xl font-bold text-white flex items-center gap-2">ğŸ“Š ç³»çµ±è³‡æºç›£æ§</h1>
            <div class="flex gap-3">
                <button onclick="loadStats()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition">ğŸ”„ åˆ·æ–°</button>
                <a href="./admin.html" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition">è¿”å›å¾Œå°</a>
            </div>
        </header>

        <div id="loading" class="text-center py-20 text-gray-500">æ­£åœ¨è®€å–è³‡æºæ•¸æ“š...</div>

        <div id="stats-grid" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
            
            <div class="monitor-card flex flex-col h-full">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-gray-400 text-sm font-bold">æ•¸æ“šåº«ç©ºé–“ (DB Size)</span>
                    <span class="text-2xl font-bold text-white"><span id="db-size-text">0</span> <span class="text-sm text-gray-500">/ 500 MB</span></span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2.5 mb-2 overflow-hidden">
                    <div id="db-size-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="text-right text-xs text-gray-500 mb-0" id="db-size-percent">0%</div>

                <div class="mt-6 bg-gray-800/50 rounded-lg p-4 border border-gray-700">
                    <p class="text-xs text-gray-400 mb-3 font-bold flex items-center gap-1">ğŸ“‚ ä½”ç”¨æ’è¡Œ (Top 10)</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr>
                                    <th class="pb-2">è³‡æ–™è¡¨</th>
                                    <th class="pb-2 text-right">ç¸½ä½”ç”¨</th>
                                    <th class="pb-2 text-right">ç´¢å¼•</th>
                                    <th class="pb-2 text-right">ç­†æ•¸</th>
                                </tr>
                            </thead>
                            <tbody id="db-details-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="monitor-card flex flex-col h-full">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-gray-400 text-sm font-bold">æ–‡ä»¶å„²å­˜ (Storage)</span>
                    <span class="text-2xl font-bold text-white"><span id="storage-text">0</span> <span class="text-sm text-gray-500">/ 1,024 MB</span></span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2.5 mb-2 overflow-hidden">
                    <div id="storage-bar" class="bg-purple-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="text-right text-xs text-gray-500 mb-0" id="storage-percent">0%</div>

                <div class="mt-6 bg-gray-800/50 rounded-lg p-4 border border-gray-700">
                    <p class="text-xs text-gray-400 mb-3 font-bold flex items-center gap-1">ğŸª£ å„²å­˜æ¡¶ç´°é … (Buckets)</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr>
                                    <th class="pb-2">å„²å­˜æ¡¶åç¨± (ID)</th>
                                    <th class="pb-2 text-right">å·²ä½¿ç”¨</th>
                                    <th class="pb-2 text-right">æª”æ¡ˆæ•¸</th>
                                </tr>
                            </thead>
                            <tbody id="storage-details-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co';
        const PUBLIC_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ';
        const supabaseClient = supabase.createClient(SUPABASE_URL, PUBLIC_KEY);

        async function loadStats() {
            const loading = document.getElementById('loading');
            const grid = document.getElementById('stats-grid');
            loading.classList.remove('hidden');
            grid.classList.add('hidden');

            try {
                const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ action: 'get-system-stats' })
                });

                if (error) throw error;
                if (!data.success) throw new Error(data.data?.message || 'æœªçŸ¥éŒ¯èª¤');

                const stats = data.data;

                // 1. æ›´æ–° DB æ•¸æ“š
                updateVisual('db-size', stats.dbSizeMB, 500, 'MB');
                if (stats.tableDetails) {
                    renderDBDetails(stats.tableDetails);
                }

                // 2. æ›´æ–° Storage æ•¸æ“š
                updateVisual('storage', stats.storageMB, 1024, 'MB');
                if (stats.bucketDetails) {
                    renderBucketDetails(stats.bucketDetails);
                }

                loading.classList.add('hidden');
                grid.classList.remove('hidden');
            } catch (err) {
                loading.innerHTML = `<div class="text-red-400">âŒ è®€å–å¤±æ•—<br><span class="text-xs">${err.message}</span></div>`;
            }
        }

        // æ¸²æŸ“ DB è¡¨æ ¼
        function renderDBDetails(tables) {
            const tbody = document.getElementById('db-details-body');
            tbody.innerHTML = '';
            tables.slice(0, 10).forEach(t => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-2 text-blue-300 font-mono text-xs truncate max-w-[100px]" title="${t.relname}">${t.relname}</td>
                    <td class="py-2 text-right text-gray-200 text-xs font-bold">${formatBytes(t.total_size)}</td>
                    <td class="py-2 text-right text-gray-500 text-xs">${formatBytes(t.index_size)}</td>
                    <td class="py-2 text-right text-gray-400 text-xs font-mono">${parseInt(t.live_rows).toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // æ¸²æŸ“ Storage è¡¨æ ¼
        function renderBucketDetails(buckets) {
            const tbody = document.getElementById('storage-details-body');
            tbody.innerHTML = '';
            
            if (!buckets || buckets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="py-4 text-center text-xs text-gray-500">ç„¡è³‡æ–™</td></tr>';
                return;
            }

            buckets.forEach(b => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-2 text-purple-300 font-mono text-xs truncate max-w-[120px]" title="${b.bucket_id}">${b.bucket_id}</td>
                    <td class="py-2 text-right text-gray-200 text-xs font-bold">${formatBytes(b.total_bytes)}</td>
                    <td class="py-2 text-right text-gray-400 text-xs font-mono">${parseInt(b.file_count).toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function formatBytes(bytes, decimals = 1) {
            if (!+bytes) return '0 B';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        function updateVisual(id, current, max, unit) {
            const percent = Math.min((current / max) * 100, 100);
            const bar = document.getElementById(`${id}-bar`);
            const text = document.getElementById(`${id}-text`);
            const percentText = document.getElementById(`${id}-percent`);

            let colorClass = id === 'db-size' ? 'bg-blue-600' : 'bg-purple-600'; // é è¨­é¡è‰²
            
            // åªæœ‰ç•¶ç”¨é‡éé«˜æ™‚æ‰è®Šè‰²è­¦å‘Š
            if (percent > 90) colorClass = 'bg-red-500';
            else if (percent > 75) colorClass = 'bg-orange-500';

            bar.className = `bar-transition h-full ${colorClass}`;
            setTimeout(() => { bar.style.width = `${percent}%`; }, 100);
            
            text.textContent = `${current.toLocaleString()} / ${max.toLocaleString()} ${unit}`;
            percentText.textContent = `${percent.toFixed(1)}%`;
        }

        document.addEventListener('DOMContentLoaded', loadStats);
    </script>
</body>
</html>