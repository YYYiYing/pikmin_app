<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´”é»é›·é”ç«™ - è‡è‡å®…é…ç¶²</title>
    <link rel="icon" href="./mashroom_s.png" type="image/png">
    <link rel="apple-touch-icon" href="./mashroom_s.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #111827; color: #d1d5db; }
        .dark-input { background-color: #374151; border-color: #4b5563; color: #d1d5db; }
        .dark-input:focus { border-color: #a855f7; --tw-ring-color: #a855f7; outline: none; ring: 2px; }
        .category-tab {
            transition: all 0.2s;
            white-space: nowrap; /* ç¢ºä¿å–®å€‹æ¨™ç±¤ä¸æ›è¡Œ */
            cursor: pointer;
            padding: 4px 10px;
            border-radius: 15px;
            background-color: #374151; /* é è¨­æ·±ç°åº• */
            color: #d1d5db;
        }
        .category-tab:hover {
            background-color: #4b5563;
            color: white;
        }
        .category-tab.active {
            background-color: #9333ea; /* ç´«è‰²åº• */
            color: white;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.5);
        }

        /* === æ–°å¢ï¼šè‡ªè¨‚ä¸‹æ‹‰é¸å–®èˆ‡è²¼ä¸ŠæŒ‰éˆ•æ¨£å¼ (ç§»æ¤è‡ª postcard.html) === */
        .custom-dropdown-container {
            position: relative;
            width: 100%;
        }
        .dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background-color: #374151; /* æ·±ç°èƒŒæ™¯ */
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 60;
            display: none;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        .dropdown-options.show {
            display: block;
        }
        .dropdown-option {
            padding: 10px 12px;
            color: #d1d5db;
            cursor: pointer;
            transition: background-color 0.1s;
            font-size: 0.875rem;
            border-bottom: 1px solid #4b5563;
            text-align: left;
        }
        .dropdown-option:last-child {
            border-bottom: none;
        }
        .dropdown-option:hover {
            background-color: #9333ea; /* Purple-600 */
            color: white;
        }
        /* è²¼ä¸ŠæŒ‰éˆ•çš„å®¹å™¨å®šä½ */
        .input-with-btn {
            position: relative;
        }
    </style>
</head>
<body class="min-h-screen pb-20">

    <nav class="bg-gray-800 border-b border-gray-700 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between h-14">
                <div class="flex items-center gap-2">
                    <a href="javascript:history.back()" class="text-gray-400 hover:text-white transition cursor-pointer">â† è¿”å›</a>
                    <h1 onclick="loadHomeData()" class="text-lg font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 cursor-pointer hover:opacity-80 transition select-none" title="å›åˆ°é¦–é ">
                        ğŸ“¡ ç´”é»é›·é”ç«™
                    </h1>
                </div>
                <div id="user-display" class="text-xs text-gray-400 font-mono"></div>
            </div>
        </div>
        
        <div class="bg-gray-900 shadow-inner relative group">
            <div id="category-container" class="overflow-hidden max-h-[50px] transition-all duration-300 px-4 py-3">
                <div id="category-list" class="flex flex-wrap gap-x-3 gap-y-2 text-sm text-gray-400">
                    <span class="category-tab">è¼‰å…¥ä¸­...</span>
                </div>
            </div>
            
            <button id="category-expand-btn" class="w-full text-center bg-gray-800/90 hover:bg-gray-700 text-gray-400 text-xs py-1 hidden shadow-md" onclick="toggleCategories()">
                â–¼ å±•é–‹æ›´å¤š
            </button>
        </div>
    </nav>

    <div class="max-w-3xl mx-auto p-4 space-y-6">

        <div id="category-info-section" class="hidden animate-fade-in">
            <div class="relative w-full h-28 md:h-40 bg-gray-800 rounded-xl overflow-hidden shadow-lg group">
                <img id="category-image" src="" alt="åˆ†é¡åœ–ç‰‡" class="w-full h-full object-contain bg-gray-900/50 hidden">
                <div id="category-placeholder" class="w-full h-full flex items-center justify-center text-gray-600 bg-gray-800">
                    <span class="text-4xl">ğŸ“¡</span>
                </div>
                
                <button id="admin-edit-category-btn" class="hidden absolute top-2 right-2 bg-black/50 hover:bg-black/70 text-white px-2 py-1 rounded text-xs backdrop-blur-sm">
                    âš™ï¸
                </button>

                <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/80 to-transparent p-4">
                    <h2 id="current-category-name" class="text-2xl font-bold text-white shadow-black drop-shadow-md"></h2>
                </div>
            </div>
        </div>

        <div id="share-section" class="hidden">
            <button onclick="openShareModal()" class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                <span>ğŸ“</span> åˆ†äº«æ­¤é¡åˆ¥çš„ç´”é»
            </button>
        </div>

        <div id="filter-section" class="hidden bg-gray-800 p-4 rounded-xl border border-gray-700 grid grid-cols-3 gap-2">
            <div>
                <label class="text-xs text-gray-500 block mb-1">åœ‹å®¶</label>
                <select id="filter-country" class="dark-input w-full p-2 rounded text-sm"><option value="all">å…¨éƒ¨</option></select>
            </div>
            <div>
                <label class="text-xs text-gray-500 block mb-1">åœ°å€</label>
                <select id="filter-region" class="dark-input w-full p-2 rounded text-sm"><option value="all">å…¨éƒ¨</option></select>
            </div>
            <div>
                <label class="text-xs text-gray-500 block mb-1">ç´°é …</label>
                <select id="filter-area" class="dark-input w-full p-2 rounded text-sm"><option value="all">å…¨éƒ¨</option></select>
            </div>
        </div>

        <div id="radar-list" class="grid grid-cols-1 gap-4">
            <p class="text-center text-gray-500 py-10">è«‹é¸æ“‡ä¸Šæ–¹åˆ†é¡ä»¥æŸ¥çœ‹é›·é”é»</p>
        </div>
    </div>

    <div id="share-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-gray-800 w-full max-w-md rounded-2xl p-6 shadow-2xl border border-gray-700">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <span>ğŸ“</span> <span id="modal-title">åˆ†äº«ç´”é»</span>
            </h3>
            
            <form id="share-form" class="space-y-4">
                <input type="hidden" id="post-id"> 
                
                <div>
                    <label class="block text-sm text-gray-400 mb-1">åº§æ¨™</label>
                    <div class="relative"> <input type="text" id="input-coords" placeholder="ä¾‹å¦‚: 22.123456, 120.654321" 
                            class="dark-input w-full p-3 pr-20 rounded-lg font-mono text-sm shadow-sm">
                        
                        <button type="button" id="paste-coord-btn" 
                            class="absolute right-2 top-2 bg-gray-700 hover:bg-gray-600 text-green-400 px-3 py-1 rounded transition font-bold flex items-center gap-1 text-xs" 
                            title="è²¼ä¸Šå‰ªè²¼ç°¿å…§å®¹">
                            ğŸ“‹ è²¼ä¸Š
                        </button>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-1">æ”¯æ´è²¼ä¸Š Google Maps ç¶²å€è‡ªå‹•è½‰æ›</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">åœ‹å®¶</label>
                        <div class="custom-dropdown-container">
                            <input type="text" id="input-country" placeholder="é¸æ“‡æˆ–è¼¸å…¥" autocomplete="off"
                                class="dark-input w-full p-2 rounded-lg text-sm">
                            <div id="dropdown-country" class="dropdown-options"></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">åœ°å€</label>
                        <div class="custom-dropdown-container">
                            <input type="text" id="input-region" placeholder="é¸æ“‡æˆ–è¼¸å…¥" autocomplete="off"
                                class="dark-input w-full p-2 rounded-lg text-sm">
                            <div id="dropdown-region" class="dropdown-options"></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">ç´°é …</label>
                        <div class="custom-dropdown-container">
                            <input type="text" id="input-area" placeholder="é¸æ“‡æˆ–è¼¸å…¥" autocomplete="off"
                                class="dark-input w-full p-2 rounded-lg text-sm">
                            <div id="dropdown-area" class="dropdown-options"></div>
                        </div>
                    </div>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeShareModal()" class="flex-1 py-2 bg-gray-700 text-gray-300 rounded-lg font-bold hover:bg-gray-600">å–æ¶ˆ</button>
                    <button type="submit" id="submit-btn" class="flex-1 py-2 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-500">ç™¼å¸ƒ</button>
                </div>
            </form>
        </div>
    </div>

    <div id="category-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl border border-gray-700">
            <h3 class="text-xl font-bold text-white mb-4">ç·¨è¼¯é¡åˆ¥</h3>
            <form id="category-form" class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">é¡åˆ¥åç¨±</label>
                    <input type="text" id="cat-name" required class="dark-input w-full p-2 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">ä»£è¡¨åœ–ç‰‡</label>
                    <input type="file" id="cat-image" accept="image/*" class="dark-input w-full p-1 rounded-lg text-xs">
                    <p class="text-xs text-gray-500 mt-1">è‹¥ä¸æ›´æ›è«‹ç•™ç©º</p>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="document.getElementById('category-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-700 rounded text-sm">å–æ¶ˆ</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-bold">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co';
        const PUBLIC_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, PUBLIC_KEY);

        let currentUser = null; 
        let currentCategory = null; 
        let allCategories = [];
        let allPosts = [];
        let isEditing = false;
        let uniqueAreas = new Set();
        let uniqueCountries = new Set();
        let uniqueRegions = new Set(); 

        document.addEventListener('DOMContentLoaded', async () => {
            await checkUserStatus();
            await loadCategories();
            await loadHomeData(); 
            
            const coordInput = document.getElementById('input-coords');
            if(coordInput) { 
                coordInput.addEventListener('blur', function() {
                    this.value = formatCoordinateString(this.value);
                });
                coordInput.addEventListener('paste', function(e) {
                    setTimeout(() => { this.value = formatCoordinateString(this.value); }, 10);
                });
            }
        });

        async function checkUserStatus() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            const displayEl = document.getElementById('user-display');

            if (session) {
                const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
                if (profile) {
                    currentUser = { id: session.user.id, nickname: profile.nickname, role: profile.role };
                    displayEl.textContent = `${profile.nickname}`;
                    displayEl.classList.add('text-purple-400');
                    return;
                }
            }
            
            const guestNick = localStorage.getItem('guest_nick');
            if (guestNick) {
                currentUser = { id: null, nickname: guestNick, role: 'guest' };
                displayEl.textContent = `è¨ªå®¢: ${guestNick}`;
            } else {
                displayEl.textContent = 'æœªè¨­å®šæš±ç¨±';
            }
        }

        async function loadCategories() {
            const listEl = document.getElementById('category-list');
            listEl.innerHTML = 'è¼‰å…¥ä¸­...';

            try {
                const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ action: 'get-radar-categories' })
                });
                
                if (error) throw error;
                allCategories = data.data;

                renderCategoryTabs();
            } catch (e) {
                console.error(e);
                listEl.innerHTML = 'ç„¡æ³•è¼‰å…¥åˆ†é¡';
            }
        }

        async function loadHomeData() {
            currentCategory = null; 
            
            document.getElementById('category-info-section').classList.add('hidden');
            document.getElementById('share-section').classList.add('hidden'); 
            
            document.querySelectorAll('.category-tab').forEach(el => el.classList.remove('active'));

            const listEl = document.getElementById('radar-list');
            listEl.innerHTML = '<p class="text-center py-10 text-gray-500">æ­£åœ¨æœå°‹å…¨å¢ƒè¨Šè™Ÿ...</p>';

            try {
                const session = (await supabaseClient.auth.getSession()).data.session;
                const options = {
                    body: JSON.stringify({ action: 'get-radar-home-data' })
                };
                if (session) options.headers = { Authorization: `Bearer ${session.access_token}` };

                const { data, error } = await supabaseClient.functions.invoke('admin-actions', options);
                if (error) throw error;
                
                allPosts = data.data;
                                
                const filterSec = document.getElementById('filter-section');
                if(filterSec) filterSec.classList.remove('hidden');

                // é‡æ–°æ¸²æŸ“æ¨™ç±¤ï¼Œç¢ºä¿ã€Œå…¨é¡åˆ¥ã€æŒ‰éˆ•äº®èµ·
                renderCategoryTabs();

                updateFilters(); 
                renderPosts(allPosts); 

            } catch (e) {
                console.error(e);
                listEl.innerHTML = `<p class="text-center text-red-400">è®€å–å¤±æ•—: ${e.message}</p>`;
            }
        }

        function renderCategoryTabs() {
            const listEl = document.getElementById('category-list');
            const container = document.getElementById('category-container');
            const btn = document.getElementById('category-expand-btn');
            
            listEl.innerHTML = '';

            const totalCount = allCategories.reduce((sum, cat) => sum + (cat.count || 0), 0);

            // 1. å…¨é¡åˆ¥æŒ‰éˆ•
            const allSpan = document.createElement('span');
            allSpan.dataset.id = 'all'; // â˜… æ–°å¢ï¼šè¨­å®š ID
            // åˆ¤æ–·æ˜¯å¦ç‚ºå…¨é¡åˆ¥ç‹€æ…‹ (currentCategory ç‚º null)
            allSpan.className = `category-tab ${!currentCategory ? 'active' : ''}`; 
            allSpan.innerHTML = `å…¨é¡åˆ¥ <span class="text-[10px] ml-1 opacity-70">(${totalCount})</span>`;
            allSpan.onclick = () => loadHomeData();
            listEl.appendChild(allSpan);

            // 2. å…¶ä»–åˆ†é¡æŒ‰éˆ•
            allCategories.forEach(cat => {
                const span = document.createElement('span');
                span.dataset.id = cat.id; // â˜… æ–°å¢ï¼šè¨­å®š ID
                
                // åˆ¤æ–·æ˜¯å¦ç‚ºç•¶å‰é¸ä¸­åˆ†é¡
                const isActive = currentCategory && currentCategory.id === cat.id;
                span.className = `category-tab ${isActive ? 'active' : ''}`; 
                span.innerHTML = `${cat.name} <span class="text-[10px] ml-1 opacity-70">(${cat.count || 0})</span>`;
                span.onclick = () => selectCategory(cat);
                listEl.appendChild(span);
            });

            setTimeout(() => {
                if (listEl.offsetHeight > 52) {
                    btn.classList.remove('hidden'); 
                } else {
                    btn.classList.add('hidden');
                }
            }, 0);
        }

        async function selectCategory(cat) {
            // å¦‚æœå†æ¬¡é»æ“Šå·²é¸å–çš„åˆ†é¡ -> å–æ¶ˆé¸å– (å›åˆ°é¦–é )
            if (currentCategory && currentCategory.id === cat.id) {
                await loadHomeData();
                return; 
            }
            currentCategory = cat;
            
            // æ”¹ç”¨ dataset.id é€²è¡Œç²¾æº–æ¯”å°
            document.querySelectorAll('.category-tab').forEach(el => {
                el.classList.remove('active');
                // æ³¨æ„ï¼šdataset.id æ˜¯å­—ä¸²ï¼Œcat.id å¯èƒ½æ˜¯æ•¸å­—ï¼Œä½¿ç”¨ == è®“å®ƒå€‘å¯ä»¥æ¯”å°
                if (el.dataset.id == cat.id) el.classList.add('active');
            });

            const infoSec = document.getElementById('category-info-section');
            const imgEl = document.getElementById('category-image');
            const phEl = document.getElementById('category-placeholder');
            const nameEl = document.getElementById('current-category-name');
            const adminBtn = document.getElementById('admin-edit-category-btn');
            const shareSec = document.getElementById('share-section');
            const filterSec = document.getElementById('filter-section');

            if (infoSec) {
                infoSec.classList.remove('hidden');
                if (nameEl) nameEl.textContent = cat.name;

                if (cat.image_url) {
                    if (imgEl) {
                        imgEl.src = cat.image_url;
                        imgEl.classList.remove('hidden');
                    }
                    if (phEl) phEl.classList.add('hidden');
                } else {
                    if (imgEl) imgEl.classList.add('hidden');
                    if (phEl) phEl.classList.remove('hidden');
                }

                if (adminBtn) {
                    if (currentUser && currentUser.role === 'ç®¡ç†è€…') {
                        adminBtn.classList.remove('hidden');
                        adminBtn.onclick = () => openCategoryModal();
                    } else {
                        adminBtn.classList.add('hidden');
                    }
                }
            }

            if (shareSec) shareSec.classList.remove('hidden');
            
            if (filterSec) {
                filterSec.classList.remove('hidden');
            }

            const container = document.getElementById('category-container');
            const btn = document.getElementById('category-expand-btn');
            
            if (container && !container.classList.contains('max-h-[50px]')) {
                container.classList.add('max-h-[50px]');
                container.classList.remove('max-h-[1000px]');
                if (btn) btn.textContent = 'â–¼ å±•é–‹æ›´å¤š';
            }
            
            setTimeout(() => {
                const activeTab = document.querySelector('.category-tab.active');
                if (activeTab) {
                    activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            }, 300);

            await loadRadarPosts(cat.id);
        }

        async function loadRadarPosts(categoryId) {
            const listEl = document.getElementById('radar-list');
            listEl.innerHTML = '<p class="text-center py-10 text-gray-500">æœå°‹è¨Šè™Ÿä¸­...</p>';

            try {
                const session = (await supabaseClient.auth.getSession()).data.session;
                const options = {
                    body: JSON.stringify({ action: 'get-radar-posts', payload: { categoryId } })
                };
                if (session) {
                    options.headers = { Authorization: `Bearer ${session.access_token}` };
                }

                const { data, error } = await supabaseClient.functions.invoke('admin-actions', options);
                if (error) throw error;
                
                allPosts = data.data;
                updateFilters(); 
                renderPosts(allPosts); 

            } catch (e) {
                console.error(e);
                listEl.innerHTML = `<p class="text-center text-red-400">è®€å–å¤±æ•—: ${e.message}</p>`;
            }
        }

        function updateFilters() {
            uniqueCountries = new Set();
            uniqueRegions = new Set();
            uniqueAreas = new Set();
            
            allPosts.forEach(p => {
                if(p.country) uniqueCountries.add(p.country);
                if(p.region) uniqueRegions.add(p.region);
                if(p.area) uniqueAreas.add(p.area);
            });

            const fillSelect = (id, options, defaultText = 'å…¨éƒ¨') => {
                const el = document.getElementById(id);
                if (!el) return; 
                el.innerHTML = defaultText ? `<option value="all">${defaultText}</option>` : '';
                options.sort().forEach(val => {
                    el.add(new Option(val, val));
                });
            };
            
            const fillDatalist = (id, options) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.innerHTML = '';
                options.sort().forEach(val => {
                    el.innerHTML += `<option value="${val}">`;
                });
            }

            fillDatalist('country-list', [...uniqueCountries]);
            fillDatalist('region-list', [...uniqueRegions]);
            fillDatalist('area-list', [...uniqueAreas]);

            const selCountry = document.getElementById('filter-country');
            const selRegion = document.getElementById('filter-region');
            const selArea = document.getElementById('filter-area');

            if(selCountry) {
                const oldVal = selCountry.value;
                fillSelect('filter-country', [...uniqueCountries], 'å…¨éƒ¨åœ‹å®¶');
                if([...uniqueCountries].includes(oldVal)) selCountry.value = oldVal;
                selCountry.onchange = applyFilter;
            }
            if(selRegion) {
                const oldVal = selRegion.value;
                fillSelect('filter-region', [...uniqueRegions], 'å…¨éƒ¨åœ°å€');
                if([...uniqueRegions].includes(oldVal)) selRegion.value = oldVal;
                selRegion.onchange = applyFilter;
            }
            if(selArea) {
                const oldVal = selArea.value;
                fillSelect('filter-area', [...uniqueAreas], 'å…¨éƒ¨ç´°é …');
                if([...uniqueAreas].includes(oldVal)) selArea.value = oldVal;
                selArea.onchange = applyFilter;
            }

            if (typeof updateInputDropdowns === 'function') {
                updateInputDropdowns();
            }
        }

        function applyFilter() {
            const cVal = document.getElementById('filter-country').value;
            const rVal = document.getElementById('filter-region').value;
            const aVal = document.getElementById('filter-area').value; 
            
            const filtered = allPosts.filter(p => {
                const matchC = (cVal === 'all') || (p.country === cVal);
                const matchR = (rVal === 'all') || (p.region === rVal);
                const matchA = (aVal === 'all') || (p.area === aVal);
                return matchC && matchR && matchA;
            });

            renderPosts(filtered);
            
            const regionOptions = new Set();
            allPosts.forEach(p => {
                if (cVal === 'all' || p.country === cVal) regionOptions.add(p.region);
            });
            const selRegion = document.getElementById('filter-region');
            const oldR = selRegion.value;
            selRegion.innerHTML = '<option value="all">å…¨éƒ¨</option>';
            [...regionOptions].sort().forEach(r => selRegion.add(new Option(r, r)));
            if ([...regionOptions].includes(oldR) || oldR === 'all') selRegion.value = oldR;

            const areaOptions = new Set();
            allPosts.forEach(p => {
                const matchC = (cVal === 'all' || p.country === cVal);
                const matchR = (rVal === 'all' || p.region === rVal); 
                if (matchC && matchR && p.area) areaOptions.add(p.area);
            });
            const selArea = document.getElementById('filter-area');
            const oldA = selArea.value;
            selArea.innerHTML = '<option value="all">å…¨éƒ¨</option>';
            [...areaOptions].sort().forEach(a => selArea.add(new Option(a, a)));
            if ([...areaOptions].includes(oldA) || oldA === 'all') selArea.value = oldA;
        }

        function renderPosts(posts) {
            const listEl = document.getElementById('radar-list');
            listEl.innerHTML = '';

            if (posts.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-500 py-10">é€™è£¡é‚„æ²’æœ‰è¨Šè™Ÿ...</p>';
                return;
            }
            
            const catMap = {};
            allCategories.forEach(c => catMap[c.id] = c);

            posts.forEach(p => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 rounded-xl p-4 border border-gray-700 shadow-sm relative';
                
                let isOwner = false;
                if (currentUser) {
                    if (currentUser.role === 'ç®¡ç†è€…') isOwner = true;
                    if (currentUser.id && currentUser.id === p.uploader_id) isOwner = true;
                }

                let controlBtns = '';
                if (isOwner) {
                    const pStr = JSON.stringify(p).replace(/"/g, '&quot;');
                    controlBtns = `
                        <div class="absolute top-3 right-3 flex gap-3">
                            <button onclick="editPost(${pStr})" class="text-gray-500 hover:text-blue-400 transition" title="ç·¨è¼¯">âœï¸</button>
                            <button onclick="deletePost('${p.id}')" class="text-gray-500 hover:text-red-400 transition" title="åˆªé™¤">ğŸ—‘ï¸</button>
                        </div>
                    `;
                }

                const safeName = (p.uploader_nickname || 'æœªçŸ¥').replace(/[\s\uFEFF\xA0]*\d{12}[\s\uFEFF\xA0]*$/, '').trim();
                const pureActive = p.my_vote === 'pure' ? 'text-green-400 bg-green-900/30 border-green-500' : 'text-gray-400 border-gray-600 hover:text-green-300';
                const impureActive = p.my_vote === 'impure' ? 'text-red-400 bg-red-900/30 border-red-500' : 'text-gray-400 border-gray-600 hover:text-red-300';
                const areaTag = p.area ? `<span class="bg-teal-900/30 text-teal-300 border border-teal-500/30 px-2 py-0.5 rounded">${p.area}</span>` : '';

                let categoryBadge = '';
                if (!currentCategory && catMap[p.category_id]) {
                    const c = catMap[p.category_id];
                    categoryBadge = `
                        <span class="ml-auto mr-5 text-[10px] bg-gray-700 text-gray-300 px-2 py-0.5 rounded-full border border-gray-600 cursor-pointer hover:bg-gray-600" onclick="selectCategoryById(${c.id})">
                            ${c.name}
                        </span>`;
                }

                card.innerHTML = `
                    ${controlBtns}
                    <div class="space-y-2 pr-12">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-purple-300 bg-purple-900/30 px-2 py-0.5 rounded-full">ğŸ“¡ è¨Šè™Ÿä¾†æº</span>
                            <span class="text-sm font-bold text-white">${safeName}</span>
                            ${categoryBadge}
                        </div>

                        <div class="flex items-center gap-2 bg-gray-900/50 p-2 rounded-lg border border-gray-700/50">
                            <code class="text-sm text-cyan-300 font-mono flex-1 truncate">${p.coordinates}</code>
                            <button onclick="copyText('${p.coordinates}')" class="text-xs bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded transition">è¤‡è£½</button>
                        </div>

                        <div class="flex flex-wrap gap-2 text-xs">
                            <span class="bg-blue-900/30 text-blue-300 border border-blue-500/30 px-2 py-0.5 rounded">${p.country}</span>
                            <span class="bg-indigo-900/30 text-indigo-300 border border-indigo-500/30 px-2 py-0.5 rounded">${p.region}</span>
                            ${areaTag}
                        </div>

                        <div class="flex gap-3 pt-2 mt-2 border-t border-gray-700/50">
                            <button onclick="votePost('${p.id}', 'pure', this)" class="flex-1 flex items-center justify-center gap-1 py-1.5 rounded border ${pureActive} transition text-sm font-bold">
                                ğŸ¥´ å¥½ç´” <span class="count text-xs ml-1">(${p.pure_count})</span>
                            </button>
                            <button onclick="votePost('${p.id}', 'impure', this)" class="flex-1 flex items-center justify-center gap-1 py-1.5 rounded border ${impureActive} transition text-sm font-bold">
                                ğŸ¥² ä¸ç´” <span class="count text-xs ml-1">(${p.impure_count})</span>
                            </button>
                        </div>
                    </div>
                `;
                listEl.appendChild(card);
            });
        }

        function openShareModal() {
            if (!currentUser && !localStorage.getItem('guest_nick')) {
                if(confirm('è«‹å…ˆè¨­å®šæš±ç¨±æ‰èƒ½ç™¼å¸ƒï¼å‰å¾€è¨­å®šï¼Ÿ')) {
                    window.location.href = './guest.html';
                }
                return;
            }
            
            isEditing = false;
            document.getElementById('modal-title').textContent = 'åˆ†äº«ç´”é»';
            document.getElementById('post-id').value = ''; 
            document.getElementById('share-form').reset(); 
            document.getElementById('submit-btn').textContent = 'ç™¼å¸ƒ';
            
            document.getElementById('share-modal').classList.remove('hidden');
        }

        function editPost(post) {
            isEditing = true;
            document.getElementById('modal-title').textContent = 'ç·¨è¼¯ç´”é»';
            document.getElementById('post-id').value = post.id; 
            
            document.getElementById('input-coords').value = post.coordinates;
            document.getElementById('input-country').value = post.country;
            document.getElementById('input-region').value = post.region;
            document.getElementById('input-area').value = post.area || ''; 
            
            document.getElementById('submit-btn').textContent = 'æ›´æ–°';
            document.getElementById('share-modal').classList.remove('hidden');
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.add('hidden');
            document.getElementById('share-form').reset();
        }

        async function votePost(postId, type, btnEl) {
            try {
                const session = (await supabaseClient.auth.getSession()).data.session;
                const options = {
                    body: JSON.stringify({ action: 'vote-radar-post', payload: { postId, type } })
                };
                if (session) options.headers = { Authorization: `Bearer ${session.access_token}` };

                const { data, error } = await supabaseClient.functions.invoke('admin-actions', options);
                if (error) throw error;

                if (currentCategory) {
                    await loadRadarPosts(currentCategory.id);
                } else {
                    await loadHomeData();
                }

            } catch (e) {
                console.error('æŠ•ç¥¨å¤±æ•—', e);
            }
        }

        async function deletePost(postId) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤é›·é”é»ï¼Ÿ')) return;
            try {
                const session = (await supabaseClient.auth.getSession()).data.session;
                const options = {
                    body: JSON.stringify({ action: 'delete-radar-post', payload: { postId } })
                };
                if (session) options.headers = { Authorization: `Bearer ${session.access_token}` };
                
                const { error } = await supabaseClient.functions.invoke('admin-actions', options);
                if (error) throw error;

                if(currentCategory) loadRadarPosts(currentCategory.id);
                else loadHomeData();

            } catch (e) {
                alert('åˆªé™¤å¤±æ•—: ' + e.message);
            }
        }

        function openCategoryModal() {
            document.getElementById('cat-name').value = currentCategory.name;
            document.getElementById('cat-image').value = '';
            document.getElementById('category-modal').classList.remove('hidden');
        }

        document.getElementById('category-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newName = document.getElementById('cat-name').value;
            const fileInput = document.getElementById('cat-image');
            
            try {
                let imageUrl = currentCategory.image_url;

                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const fileName = `cat_${Date.now()}.${file.name.split('.').pop()}`;
                    
                    const { data, error } = await supabaseClient.storage.from('radar-category-images').upload(fileName, file);
                    if (error) throw error;
                    
                    const { data: pub } = supabaseClient.storage.from('radar-category-images').getPublicUrl(fileName);
                    imageUrl = pub.publicUrl;
                }

                const session = (await supabaseClient.auth.getSession()).data.session;
                const { error } = await supabaseClient.functions.invoke('admin-actions', {
                    headers: { Authorization: `Bearer ${session.access_token}` },
                    body: JSON.stringify({ 
                        action: 'update-radar-category', 
                        payload: { id: currentCategory.id, name: newName, image_url: imageUrl } 
                    })
                });

                if (error) throw error;
                
                alert('æ›´æ–°æˆåŠŸ');
                document.getElementById('category-modal').classList.add('hidden');
                loadCategories(); 
                currentCategory.name = newName;
                currentCategory.image_url = imageUrl;
                selectCategory(currentCategory);

            } catch (err) {
                alert('æ›´æ–°å¤±æ•—: ' + err.message);
            }
        });

        document.getElementById('share-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            
            // â˜… 1. å…ˆåŸ·è¡Œåº§æ¨™æ ¼å¼åŒ– (å½ˆæ€§ç‰ˆ)
            // é€™ä¸€æ­¥å¾ˆé‡è¦ï¼Œèƒ½å°‡ Google Maps ç¶²å€è½‰ç‚ºåº§æ¨™ï¼Œä¸¦çµ±ä¸€å°æ•¸é»
            const rawCoords = document.getElementById('input-coords').value;
            const formattedCoords = formatCoordinateString(rawCoords);
            // å°‡æ•´ç†å¾Œçš„åº§æ¨™å¡«å›è¼¸å…¥æ¡†ï¼Œè®“ payload æŠ“åˆ°ä¹¾æ·¨çš„æ•¸æ“š
            document.getElementById('input-coords').value = formattedCoords;

            // â˜… 2. é–å®šæŒ‰éˆ•ç‹€æ…‹
            btn.disabled = true; 
            const originalText = btn.textContent;
            btn.textContent = isEditing ? 'æ›´æ–°ä¸­...' : 'ç™¼é€ä¸­...';

            try {
                const postId = document.getElementById('post-id').value;
                const catId = currentCategory ? currentCategory.id : null;

                const payload = {
                    categoryId: catId,
                    // é€™è£¡æŠ“å–çš„å€¼å·²ç¶“æ˜¯ä¸Šæ–¹æ ¼å¼åŒ–éçš„ formattedCoords
                    coordinates: document.getElementById('input-coords').value,
                    country: document.getElementById('input-country').value || '',
                    region: document.getElementById('input-region').value || '',
                    area: document.getElementById('input-area').value || '',
                    nickname: currentUser ? currentUser.nickname : (localStorage.getItem('guest_nick') || 'åŒ¿åè¨ªå®¢')
                };

                const action = isEditing ? 'update-radar-post' : 'create-radar-post';
                
                if (isEditing) {
                    payload.postId = postId;
                }

                const session = (await supabaseClient.auth.getSession()).data.session;
                const options = {
                    body: JSON.stringify({ action, payload })
                };
                if (session) options.headers = { Authorization: `Bearer ${session.access_token}` };

                // å‘¼å«å¾Œç«¯
                const { data, error } = await supabaseClient.functions.invoke('admin-actions', options);
                
                // 1. è™•ç†ç³»çµ±å±¤ç´šéŒ¯èª¤ (ç¶²è·¯æ–·ç·šã€500éŒ¯èª¤ç­‰)
                if (error) throw error;

                // 2. â˜… è™•ç†æ¥­å‹™é‚è¼¯éŒ¯èª¤ (è™•ç†é‡è¤‡åº§æ¨™å›å‚³çš„ success: false)
                if (data && data.success === false) {
                    // é¡¯ç¤ºå¾Œç«¯å‚³å›ä¾†çš„ message ("æ­¤åº§æ¨™å·²ç¶“è¢«ç™»éŒ„éäº†...")
                    alert('âš ï¸ æç¤ºï¼š' + (data.message || 'æ“ä½œè¢«æ‹’çµ•'));
                    return; // ä¸­æ–·ï¼Œä¸é—œé–‰è¦–çª—ï¼Œä¿ç•™æŒ‰éˆ•é–å®šç‹€æ…‹æˆ–è§£é–éœ€è¦–éœ€æ±‚ (é€™è£¡æœƒé€² finally è§£é–)
                }

                // æˆåŠŸå¾Œçš„è™•ç†
                alert(isEditing ? 'æ›´æ–°æˆåŠŸï¼' : 'ç™¼å¸ƒæˆåŠŸï¼');
                
                closeShareModal(); 
                
                // é‡æ–°è¼‰å…¥åˆ—è¡¨
                if (currentCategory) {
                    loadRadarPosts(currentCategory.id);
                } else {
                    loadHomeData(); 
                }
                
                // å¦‚æœæ˜¯ç™¼å¸ƒæ–°è²¼æ–‡ï¼Œé‡æ–°è¼‰å…¥åˆ†é¡çµ±è¨ˆ(æ•¸é‡æœƒè®Š)
                if (!isEditing && currentCategory) loadCategories(); 

            } catch (err) {
                console.error(err);
                alert('æ“ä½œå¤±æ•—: ' + (err.message || 'æœªçŸ¥éŒ¯èª¤'));
            } finally {
                // è§£é–æŒ‰éˆ•
                btn.disabled = false; 
                btn.textContent = originalText;
            }
        });

        // â˜… å·¥å…·å‡½å¼ï¼šåº§æ¨™æ ¼å¼æ¨™æº–åŒ– (å½ˆæ€§ç‰ˆ - å…¼é¡§åœ°å€è¼¸å…¥)
        function formatCoordinateString(val) {
            if (!val) return "";
            let str = val.trim();

            // 1. å˜—è©¦è§£æ Google Maps ç¶²å€ (æœ€å„ªå…ˆ)
            let match = str.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
            if (match) return `${parseFloat(match[1]).toFixed(7)}, ${parseFloat(match[2]).toFixed(7)}`;
            
            match = str.match(/q=(-?\d+\.\d+),(-?\d+\.\d+)/);
            if (match) return `${parseFloat(match[1]).toFixed(7)}, ${parseFloat(match[2]).toFixed(7)}`;
            
            match = str.match(/!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/);
            if (match) return `${parseFloat(match[1]).toFixed(7)}, ${parseFloat(match[2]).toFixed(7)}`;

            // 2. å˜—è©¦è§£ææ¨™æº–åº§æ¨™
            // å…ˆæŠŠå…¨å½¢é€—è™Ÿè½‰åŠå½¢
            let tempStr = str.replace(/ï¼Œ/g, ',');
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºåº¦åˆ†ç§’ (DMS)
            const isDMS = tempStr.includes('Â°') && (tempStr.includes("'") || tempStr.includes('"') || tempStr.includes('â€™'));
            
            let lat = 0, lng = 0;
            let success = false;

            if (isDMS) {
                // === è™•ç†åº¦åˆ†ç§’ ===
                const numbers = tempStr.match(/(\d+(\.\d+)?)/g);
                const directions = tempStr.match(/[NSEWåŒ—å—æ±è¥¿]/gi) || [];
                
                if (numbers && numbers.length >= 6) {
                    const d1 = parseFloat(numbers[0]), m1 = parseFloat(numbers[1]), s1 = parseFloat(numbers[2]);
                    const d2 = parseFloat(numbers[3]), m2 = parseFloat(numbers[4]), s2 = parseFloat(numbers[5]);

                    lat = d1 + (m1 / 60) + (s1 / 3600);
                    lng = d2 + (m2 / 60) + (s2 / 3600);

                    const dirStr = directions.join('');
                    if (/[Så—]/.test(dirStr)) lat = -lat; 
                    if (/[Wè¥¿]/.test(dirStr)) lng = -lng;

                    success = true;
                }
            } else {
                // === è™•ç†ä¸€èˆ¬å°æ•¸æ ¼å¼ ===
                const numbers = tempStr.match(/(-?\d+\.\d+)/g);
                
                if (numbers && numbers.length >= 2) {
                    lat = parseFloat(numbers[0]);
                    lng = parseFloat(numbers[1]);
                    
                    // ç¯„åœæª¢æŸ¥ (-90~90, -180~180) é¿å…æŠŠæ—¥æœŸèª¤åˆ¤ç‚ºåº§æ¨™
                    if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                        if (/[Så—]/.test(tempStr) && lat > 0) lat = -lat;
                        if (/[Wè¥¿]/.test(tempStr) && lng > 0) lng = -lng;
                        success = true;
                    }
                }
            }

            if (success) {
                // æˆåŠŸè§£æå‡ºåº§æ¨™ -> å›å‚³ 7 ä½å°æ•¸æ ¼å¼
                return `${lat.toFixed(7)}, ${lng.toFixed(7)}`;
            } else {
                // è§£æå¤±æ•— (å¯èƒ½æ˜¯åœ°å€æˆ–åœ°æ¨™åç¨±) -> å›å‚³åŸå­—ä¸²ï¼Œä¸åšä¿®æ”¹
                return val; 
            }
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => alert('å·²è¤‡è£½åº§æ¨™'));
        }

        function toggleCategories() {
            const container = document.getElementById('category-container');
            const btn = document.getElementById('category-expand-btn');
            
            if (container.classList.contains('max-h-[50px]')) {
                container.classList.remove('max-h-[50px]');
                container.classList.add('max-h-[1000px]'); 
                btn.textContent = 'â–² æ”¶åˆåˆ†é¡';
            } else {
                container.classList.add('max-h-[50px]');
                container.classList.remove('max-h-[1000px]');
                btn.textContent = 'â–¼ å±•é–‹æ›´å¤š';
            }
        }

        function selectCategoryById(id) {
            const cat = allCategories.find(c => c.id === id);
            if (cat) selectCategory(cat);
        }

        // åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®åŠŸèƒ½
        function setupInputDropdown(inputId, dropdownId, dataSet) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            
            const renderOptions = (filterText = '') => {
                // å¾ Set è½‰ç‚º Array ä¸¦æ’åº
                const options = Array.from(dataSet).sort();
                
                // éæ¿¾
                const filtered = options.filter(txt => 
                    txt && txt.toLowerCase().includes(filterText.toLowerCase())
                );

                dropdown.innerHTML = '';
                if (filtered.length === 0) {
                    dropdown.innerHTML = '<div class="dropdown-option text-gray-500 cursor-default text-xs">ç„¡ç¬¦åˆé …ç›®</div>';
                } else {
                    filtered.forEach(txt => {
                        const div = document.createElement('div');
                        div.className = 'dropdown-option';
                        div.textContent = txt;
                        div.onclick = () => {
                            input.value = txt;
                            dropdown.classList.remove('show');
                        };
                        dropdown.appendChild(div);
                    });
                }
            };

            input.onfocus = () => {
                renderOptions(input.value);
                dropdown.classList.add('show');
            };
            
            input.oninput = () => {
                renderOptions(input.value);
                dropdown.classList.add('show');
            };

            // é»æ“Šå¤–éƒ¨é—œé–‰
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        }

        // æ¯æ¬¡æ•¸æ“šè¼‰å…¥å¾Œï¼Œæ›´æ–°ä¸‹æ‹‰é¸å–®çš„è³‡æ–™ä¾†æº
        function updateInputDropdowns() {
            // ç¢ºä¿ uniqueSets å·²ç¶“åœ¨ updateFilters() ä¸­è¢«è¨ˆç®—éäº†
            if (document.getElementById('input-country')) {
                setupInputDropdown('input-country', 'dropdown-country', uniqueCountries);
                setupInputDropdown('input-region', 'dropdown-region', uniqueRegions);
                setupInputDropdown('input-area', 'dropdown-area', uniqueAreas);
            }
        }

        // --- ç¶å®šè²¼ä¸ŠæŒ‰éˆ•äº‹ä»¶ ---
        document.getElementById('paste-coord-btn').addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                if(text) {
                    const formatted = formatCoordinateString(text);
                    document.getElementById('input-coords').value = formatted;
                    // ç°¡å–®é–ƒçˆæç¤º
                    const btn = document.getElementById('paste-coord-btn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = 'âœ… OK';
                    setTimeout(() => btn.innerHTML = originalText, 1000);
                } else {
                    alert('å‰ªè²¼ç°¿æ˜¯ç©ºçš„');
                }
            } catch(e) { 
                alert('ç„¡æ³•è®€å–å‰ªè²¼ç°¿ï¼Œè«‹æ‰‹å‹•è²¼ä¸Š'); 
            }
        });
    </script>
</body>
</html>