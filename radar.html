<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´”é»é›·é”ç«™ - è‡è‡å®…é…ç¶²</title>
    <link rel="icon" href="./mashroom_s.png" type="image/png">
    <link rel="apple-touch-icon" href="./mashroom_s.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #111827; color: #d1d5db; }
        .dark-input { background-color: #374151; border-color: #4b5563; color: #d1d5db; }
        
        /* â˜… ä¿®æ”¹ 1: è¼¸å…¥æ¡†èšç„¦æ”¹ç‚ºè—è‰² (Blue-500) */
        .dark-input:focus { border-color: #3b82f6; --tw-ring-color: #3b82f6; outline: none; ring: 2px; }
        
        .category-tab {
            transition: all 0.2s;
            white-space: nowrap; 
            cursor: pointer;
            padding: 4px 10px;
            border-radius: 15px;
            background-color: #374151;
            color: #d1d5db;
        }
        .category-tab:hover {
            background-color: #4b5563;
            color: white;
        }
        
        /* â˜… ä¿®æ”¹ 2: åˆ†é¡æ¨™ç±¤é¸å–ç‹€æ…‹æ”¹ç‚ºè—è‰² (Blue-600) */
        .category-tab.active {
            background-color: #2563eb; 
            color: white;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
        }

        .custom-dropdown-container { position: relative; width: 100%; }
        .dropdown-options {
            position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px;
            background-color: #374151; border: 1px solid #4b5563; border-radius: 0.5rem;
            max-height: 200px; overflow-y: auto; z-index: 60; display: none;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        .dropdown-options.show { display: block; }
        
        .dropdown-option {
            padding: 10px 12px; color: #d1d5db; cursor: pointer; transition: background-color 0.1s;
            font-size: 0.875rem; border-bottom: 1px solid #4b5563; text-align: left;
        }
        .dropdown-option:last-child { border-bottom: none; }
        
        /* ä¸‹æ‹‰é¸å–®æ‡¸åœæ”¹ç‚ºè—è‰² (Blue-600) */
        .dropdown-option:hover {
            background-color: #2563eb;
            color: white;
        }
        .input-with-btn { position: relative; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen pb-20">

    <div class="max-w-7xl mx-auto">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4 border-b border-gray-700 pb-6">
            <h1 class="text-3xl font-bold flex items-center gap-2 cursor-pointer" onclick="loadHomeData()" title="å›åˆ°é¦–é ">
                <span>ğŸ“¡</span>
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">
                    ç´”é»é›·é”ç«™
                </span>
            </h1>
            
            <div class="flex items-center gap-4">
                <button onclick="openShareModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition flex items-center gap-2 transform hover:scale-105">
                    <span>â•</span> åˆ†äº«é›·é”ç´”é»
                </button>
                
                <a href="javascript:void(0)" onclick="handleBack()" class="text-gray-400 hover:text-white transition cursor-pointer">â† è¿”å›</a>
            </div>
            
            <div id="user-display" class="w-full md:w-auto text-center md:text-right text-xs text-gray-500 font-mono"></div>
        </header>
        
        <div class="bg-gray-900 shadow-inner relative group mb-6 rounded-xl overflow-hidden border border-gray-800">
            <div id="category-container" class="overflow-hidden max-h-[50px] transition-all duration-300 px-4 py-3">
                <div id="category-list" class="flex flex-wrap gap-x-3 gap-y-2 text-sm text-gray-400">
                    <span class="category-tab">è¼‰å…¥ä¸­...</span>
                </div>
            </div>
            
            <button id="category-expand-btn" class="w-full text-center bg-gray-800/90 hover:bg-gray-700 text-gray-400 text-xs py-1 hidden shadow-md" onclick="toggleCategories()">
                â–¼ å±•é–‹æ›´å¤š
            </button>
        </div>

    <div class="max-w-3xl mx-auto p-4 space-y-6">

        <div id="category-info-section" class="hidden animate-fade-in">
            <div class="relative w-full h-28 md:h-40 bg-gray-800 rounded-xl overflow-hidden shadow-lg group">
                <img id="category-image" src="" alt="åˆ†é¡åœ–ç‰‡" class="w-full h-full object-contain bg-gray-900/50 hidden">
                <div id="category-placeholder" class="w-full h-full flex items-center justify-center text-gray-600 bg-gray-800">
                    <span class="text-4xl">ğŸ“¡</span>
                </div>
                
                <button id="admin-edit-category-btn" class="hidden absolute top-2 right-2 bg-black/50 hover:bg-black/70 text-white px-2 py-1 rounded text-xs backdrop-blur-sm">
                    âš™ï¸
                </button>

                <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/80 to-transparent p-4">
                    <h2 id="current-category-name" class="text-2xl font-bold text-white shadow-black drop-shadow-md"></h2>
                </div>
            </div>
        </div>

        <div id="share-section" class="hidden">
            <button onclick="openShareModal()" class="w-full py-3 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white font-bold rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                <span>ğŸ“</span> åˆ†äº«æ­¤é¡åˆ¥çš„ç´”é»
            </button>
        </div>

        <div id="filter-section" class="hidden bg-gray-800 p-4 rounded-xl border border-gray-700 grid grid-cols-3 gap-2">
            <div>
                <label class="text-xs text-gray-500 block mb-1">åœ‹å®¶</label>
                <select id="filter-country" class="dark-input w-full p-2 rounded text-sm"><option value="all">å…¨éƒ¨</option></select>
            </div>
            <div>
                <label class="text-xs text-gray-500 block mb-1">åœ°å€</label>
                <select id="filter-region" class="dark-input w-full p-2 rounded text-sm"><option value="all">å…¨éƒ¨</option></select>
            </div>
            <div>
                <label class="text-xs text-gray-500 block mb-1">ç´°é …</label>
                <select id="filter-area" class="dark-input w-full p-2 rounded text-sm"><option value="all">å…¨éƒ¨</option></select>
            </div>
        </div>

        <div id="radar-list" class="grid grid-cols-1 gap-4">
            <p class="text-center text-gray-500 py-10">è«‹é¸æ“‡ä¸Šæ–¹åˆ†é¡ä»¥æŸ¥çœ‹é›·é”é»</p>
        </div>
    </div>

    <div id="share-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-gray-800 w-full max-w-md rounded-2xl p-6 shadow-2xl border border-gray-700">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <span>ğŸ“</span> <span id="modal-title">åˆ†äº«ç´”é»</span>
            </h3>
            
            <form id="share-form" class="space-y-4">
                <input type="hidden" id="post-id"> 
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">é£¾å“é¡åˆ¥ <span class="text-red-500">*</span></label>
                    <select id="input-category-select" required class="dark-input w-full rounded-lg px-3 py-2 text-sm appearance-none bg-gray-700">
                        <option value="" disabled selected>è«‹é¸æ“‡é£¾å“ç¨®é¡...</option>
                        </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">åº§æ¨™</label>
                    <div class="relative"> <input type="text" id="input-coords" placeholder="ä¾‹å¦‚: 22.123456, 120.654321" 
                            class="dark-input w-full p-3 pr-20 rounded-lg font-mono text-sm shadow-sm">
                        
                        <button type="button" id="paste-coord-btn" 
                            class="absolute right-2 top-2 bg-gray-700 hover:bg-gray-600 text-green-400 px-3 py-1 rounded transition font-bold flex items-center gap-1 text-xs" 
                            title="è²¼ä¸Šå‰ªè²¼ç°¿å…§å®¹">
                            ğŸ“‹ è²¼ä¸Š
                        </button>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-1">æ”¯æ´è²¼ä¸Š Google Maps ç¶²å€è‡ªå‹•è½‰æ›</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">åœ‹å®¶</label>
                        <div class="custom-dropdown-container">
                            <input type="text" id="input-country" placeholder="é¸æ“‡æˆ–è¼¸å…¥" autocomplete="off"
                                class="dark-input w-full p-2 rounded-lg text-sm">
                            <div id="dropdown-country" class="dropdown-options"></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">åœ°å€</label>
                        <div class="custom-dropdown-container">
                            <input type="text" id="input-region" placeholder="é¸æ“‡æˆ–è¼¸å…¥" autocomplete="off"
                                class="dark-input w-full p-2 rounded-lg text-sm">
                            <div id="dropdown-region" class="dropdown-options"></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">ç´°é …</label>
                        <div class="custom-dropdown-container">
                            <input type="text" id="input-area" placeholder="é¸æ“‡æˆ–è¼¸å…¥" autocomplete="off"
                                class="dark-input w-full p-2 rounded-lg text-sm">
                            <div id="dropdown-area" class="dropdown-options"></div>
                        </div>
                    </div>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeShareModal()" class="flex-1 py-2 bg-gray-700 text-gray-300 rounded-lg font-bold hover:bg-gray-600">å–æ¶ˆ</button>
                    <button type="submit" id="submit-btn" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-500">ç™¼å¸ƒ</button>
                </div>
            </form>
        </div>
    </div>

    <div id="category-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl border border-gray-700">
            <h3 class="text-xl font-bold text-white mb-4">ç·¨è¼¯é¡åˆ¥</h3>
            <form id="category-form" class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">é¡åˆ¥åç¨±</label>
                    <input type="text" id="cat-name" required class="dark-input w-full p-2 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">ä»£è¡¨åœ–ç‰‡</label>
                    <input type="file" id="cat-image" accept="image/*" class="dark-input w-full p-1 rounded-lg text-xs">
                    <p class="text-xs text-gray-500 mt-1">è‹¥ä¸æ›´æ›è«‹ç•™ç©º</p>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="document.getElementById('category-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-700 rounded text-sm">å–æ¶ˆ</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-bold">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co';
        const PUBLIC_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, PUBLIC_KEY);

        let currentUser = null; 
        let currentCategory = null; 
        let allCategories = [];
        let allPosts = [];
        let isEditing = false;
        let isImpureMode = false;
        let uniqueAreas = new Set();
        let uniqueCountries = new Set();
        let uniqueRegions = new Set(); 

        let isAdmin = false; // ç®¡ç†å“¡ç‹€æ…‹

        // --- ç¶å®šè²¼ä¸ŠæŒ‰éˆ•äº‹ä»¶ (æ”¯æ´ç·¨è¼¯æ¨¡å¼è‡ªå‹•åæŸ¥) ---
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. åˆå§‹åŒ–
            await checkUserStatus();
            await loadCategories();
            await loadHomeData(); 
            
            // 2. è™•ç†è²¼ä¸ŠæŒ‰éˆ•
            const pasteBtn = document.getElementById('paste-coord-btn');
            if (pasteBtn) {
                pasteBtn.addEventListener('click', async () => {
                    try {
                        const text = await navigator.clipboard.readText();
                        if(text) {
                            const formatted = formatCoordinateString(text);
                            
                            if (formatted) {
                                // å¡«å…¥åº§æ¨™
                                document.getElementById('input-coords').value = formatted;
                                
                                // æŒ‰éˆ•å›é¥‹
                                const originalText = pasteBtn.innerHTML;
                                pasteBtn.innerHTML = 'âœ… OK';
                                setTimeout(() => pasteBtn.innerHTML = originalText, 1000);

                                // â˜… ä¿®æ”¹ï¼šç§»é™¤ã€Œæ¬„ä½è¦åœ¨ç©ºã€çš„é™åˆ¶
                                // é‚è¼¯ï¼šæ—¢ç„¶ç”¨æˆ¶æŒ‰äº†è²¼ä¸Šï¼Œä»£è¡¨ä»–è¦æ›åœ°é»ï¼Œç›´æ¥è§¸ç™¼åæŸ¥è¦†è“‹èˆŠè³‡æ–™
                                const [lat, lng] = formatted.split(',').map(s => s.trim());
                                await autoFillLocation(lat, lng);

                            } else {
                                alert('âŒ å‰ªè²¼ç°¿å…§å®¹ä¸æ˜¯æœ‰æ•ˆçš„åº§æ¨™æ ¼å¼ï¼');
                            }
                        } else {
                            alert('å‰ªè²¼ç°¿æ˜¯ç©ºçš„');
                        }
                    } catch(e) { 
                        alert('ç„¡æ³•è®€å–å‰ªè²¼ç°¿ï¼Œè«‹æ‰‹å‹•è²¼ä¸Š'); 
                    }
                });
            }

            // 3. æ‰‹å‹•è¼¸å…¥å„ªåŒ–ï¼šåµæ¸¬åº§æ¨™æ˜¯å¦æœ‰ã€Œè®Šæ›´ã€
            const coordInput = document.getElementById('input-coords');
            let coordsOnFocus = ''; // ç”¨ä¾†è¨˜éŒ„æ¸¸æ¨™é»é€²å»æ™‚çš„èˆŠæ•¸å€¼

            if (coordInput) {
                // é»é€²æ¬„ä½æ™‚ï¼Œå…ˆè¨˜ä½åŸæœ¬çš„åº§æ¨™
                coordInput.addEventListener('focus', function() {
                    coordsOnFocus = this.value.trim();
                });

                // é›¢é–‹æ¬„ä½ (Blur) æ™‚
                coordInput.addEventListener('blur', async function() {
                    const val = this.value.trim();
                    if (!val) return;

                    const formatted = formatCoordinateString(val);
                    
                    // åˆ¤æ–·æ¢ä»¶ï¼š
                    // A. åº§æ¨™æœ‰è¢«ä¿®æ”¹é (val !== coordsOnFocus) -> ä»£è¡¨æ›åœ°é»äº†ï¼Œè¦åæŸ¥
                    // B. æˆ–æ˜¯åœ‹å®¶æ¬„ä½æ˜¯ç©ºçš„ (isCountryEmpty) -> ä»£è¡¨æ˜¯æ–°è²¼æ–‡é‚„æ²’å¡«ï¼Œè¦åæŸ¥
                    const isChanged = (val !== coordsOnFocus);
                    const isCountryEmpty = !document.getElementById('input-country').value;

                    // åªæœ‰ç•¶ã€Œæ ¼å¼æ­£ç¢ºã€ä¸”ã€Œç¬¦åˆä¸Šè¿°ä»»ä¸€æ¢ä»¶ã€æ™‚ï¼Œæ‰è§¸ç™¼
                    if (formatted && (isChanged || isCountryEmpty)) {
                        this.value = formatted; // é †ä¾¿æ ¼å¼åŒ–
                        const [lat, lng] = formatted.split(',').map(s => s.trim());
                        await autoFillLocation(lat, lng);
                    }
                });
            }
        });

        async function checkUserStatus() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            const displayEl = document.getElementById('user-display');
            
            // é‡ç½®ç‹€æ…‹
            currentUser = null;
            isAdmin = false;

            if (session) {
                // --- A. å·²ç™»å…¥æœƒå“¡ (å„ªå…ˆ) ---
                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('nickname, role')
                    .eq('id', session.user.id)
                    .single();
                
                if (profile) {
                    // è¨­å®š currentUser
                    currentUser = { id: session.user.id, nickname: profile.nickname, role: profile.role };
                    
                    const displayName = profile.nickname || 'æœƒå“¡';

                    // åˆ¤æ–·æ˜¯å¦ç‚ºç®¡ç†å“¡
                    if (profile.role === 'ç®¡ç†è€…') {
                        isAdmin = true;
                        // é¡¯ç¤ºï¼š[ç®¡ç†å“¡æ¨¡å¼] æš±ç¨±
                        displayEl.innerHTML = `<span class="text-orange-400 font-bold border border-orange-500/50 px-2 py-0.5 rounded mr-2 text-xs">ç®¡ç†å“¡æ¨¡å¼</span><span class="text-gray-300">${displayName}</span>`;
                        
                        // å¦‚æœæœ‰ç®¡ç†åˆ†é¡çš„æŒ‰éˆ•ï¼Œé¡¯ç¤ºå®ƒ
                        const adminBtn = document.getElementById('admin-edit-category-btn');
                        if(adminBtn) adminBtn.classList.remove('hidden');

                    } else {
                        // é¡¯ç¤ºï¼š[æœƒå“¡] æš±ç¨±
                        displayEl.innerHTML = `<span class="text-purple-400 font-bold border border-purple-500/50 px-2 py-0.5 rounded mr-2 text-xs">æœƒå“¡</span><span class="text-gray-300">${displayName}</span>`;
                    }
                    return; // çµæŸï¼Œä¸è®€å–è¨ªå®¢è³‡æ–™
                }
            }
            
            // --- B. æœªç™»å…¥ (ä½¿ç”¨è¨ªå®¢è³‡æ–™) ---
            const guestNick = localStorage.getItem('guest_nick');
            // æ³¨æ„ï¼šæˆ‘å€‘æ•…æ„ä¸è®€å– guest_codeï¼Œä»¥ç¬¦åˆã€Œä¸æ‹¼æ¥å¥½å‹ç¢¼ã€çš„éœ€æ±‚
            
            if (guestNick) {
                currentUser = { id: null, nickname: guestNick, role: 'guest' };
                // é¡¯ç¤ºï¼š[è¨ªå®¢] æš±ç¨±
                displayEl.innerHTML = `<span class="text-gray-500 font-bold border border-gray-600/50 px-2 py-0.5 rounded mr-2 text-xs">è¨ªå®¢</span><span class="text-gray-400">${guestNick}</span>`;
            } else {
                displayEl.textContent = 'æœªç™»å…¥ (åƒ…ç€è¦½)';
            }
        }

        async function loadCategories() {
            const listEl = document.getElementById('category-list');
            listEl.innerHTML = 'è¼‰å…¥ä¸­...';

            try {
                const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ action: 'get-radar-categories' })
                });
                
                if (error) throw error;
                allCategories = data.data;

                renderCategoryTabs();
            } catch (e) {
                console.error(e);
                listEl.innerHTML = 'ç„¡æ³•è¼‰å…¥åˆ†é¡';
            }
        }

        async function loadHomeData() {
            currentCategory = null; 
            isImpureMode = false;
            
            document.getElementById('category-info-section').classList.add('hidden');
            document.getElementById('share-section').classList.add('hidden'); 
            
            document.querySelectorAll('.category-tab').forEach(el => el.classList.remove('active'));

            const listEl = document.getElementById('radar-list');
            listEl.innerHTML = '<p class="text-center py-10 text-gray-500">æ­£åœ¨æœå°‹å…¨å¢ƒè¨Šè™Ÿ...</p>';

            try {
                const session = (await supabaseClient.auth.getSession()).data.session;
                const options = {
                    body: JSON.stringify({ action: 'get-radar-home-data' })
                };
                if (session) options.headers = { Authorization: `Bearer ${session.access_token}` };

                const { data, error } = await supabaseClient.functions.invoke('admin-actions', options);
                if (error) throw error;
                
                allPosts = data.data;
                                
                const filterSec = document.getElementById('filter-section');
                if(filterSec) filterSec.classList.remove('hidden');

                // é‡æ–°æ¸²æŸ“æ¨™ç±¤ï¼Œç¢ºä¿ã€Œå…¨é¡åˆ¥ã€æŒ‰éˆ•äº®èµ·
                renderCategoryTabs();

                updateFilters(); 
                renderPosts(allPosts); 

            } catch (e) {
                console.error(e);
                listEl.innerHTML = `<p class="text-center text-red-400">è®€å–å¤±æ•—: ${e.message}</p>`;
            }
        }
        
        async function loadImpureData() {
            // 1. è¨­å®šç‹€æ…‹
            currentCategory = null;
            isImpureMode = true;

            // 2. éš±è—ä¸å¿…è¦çš„å€å¡Š
            document.getElementById('category-info-section').classList.add('hidden');
            document.getElementById('share-section').classList.add('hidden');
            
            // 3. UI é¡¯ç¤ºæƒæä¸­
            const listEl = document.getElementById('radar-list');
            listEl.innerHTML = '<p class="text-center py-10 text-gray-500 animate-pulse">æ­£åœ¨æƒæç•°å¸¸è¨Šè™Ÿ...</p>';

            // é‡ç½®åˆ†é¡æŒ‰éˆ•æ¨£å¼ (è®“ã€Œä¸ç´”ã€æŒ‰éˆ•äº®èµ·)
            renderCategoryTabs();

            try {
                // 4. é‡æ–°æŠ“å–å…¨åŸŸè³‡æ–™ (ç¢ºä¿æ‹¿åˆ°æœ€æ–°çš„è¨ˆæ•¸)
                const session = (await supabaseClient.auth.getSession()).data.session;
                const options = {
                    body: JSON.stringify({ action: 'get-radar-home-data' })
                };
                if (session) options.headers = { Authorization: `Bearer ${session.access_token}` };

                const { data, error } = await supabaseClient.functions.invoke('admin-actions', options);
                if (error) throw error;
                
                allPosts = data.data; // æ›´æ–°å…¨åŸŸè³‡æ–™

                // 5. å‰ç«¯ç¯©é¸ï¼šåªä¿ç•™ impure_count > 0 çš„é …ç›®
                // (è¨»ï¼šé›–ç„¶æ‚¨æåˆ°ã€Œå¤§æ–¼1ã€ï¼Œä½†é€šå¸¸å¤§æ–¼ 0 å°±ä»£è¡¨æœ‰ç´€éŒ„ï¼Œè‹¥éœ€åš´æ ¼å¤§æ–¼1è«‹æ”¹ç‚º > 1)
                const impurePosts = allPosts
                    .filter(p => (p.impure_count || 0) > 0)
                    .sort((a, b) => (b.impure_count || 0) - (a.impure_count || 0)); // ä¾ç…§åš´é‡ç¨‹åº¦æ’åº

                // 6. æ›´æ–° UI
                updateFilters(); // æ›´æ–°ä¸‹æ‹‰é¸å–®
                
                if (impurePosts.length === 0) {
                    listEl.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-4xl mb-2">ğŸ‰</div>
                            <p class="text-gray-400 font-bold">ç›®å‰æ²’æœ‰ç™¼ç¾ä»»ä½•ä¸ç´”è¨Šè™Ÿ</p>
                            <p class="text-gray-600 text-sm mt-1">å…¨å¢ƒç‹€æ…‹è‰¯å¥½</p>
                        </div>`;
                } else {
                    renderPosts(impurePosts);
                }

            } catch (e) {
                console.error(e);
                listEl.innerHTML = `<p class="text-center text-red-400">æƒæå¤±æ•—: ${e.message}</p>`;
                // ç™¼ç”ŸéŒ¯èª¤æ™‚é‡ç½®ç‹€æ…‹
                isImpureMode = false;
                renderCategoryTabs();
            }
        }

        function renderCategoryTabs() {
            const listEl = document.getElementById('category-list');
            const container = document.getElementById('category-container');
            const btn = document.getElementById('category-expand-btn');
            
            listEl.innerHTML = '';

            const totalCount = allCategories.reduce((sum, cat) => sum + (cat.count || 0), 0);

            // 1. å…¨é¡åˆ¥æŒ‰éˆ•
            const allSpan = document.createElement('span');
            allSpan.dataset.id = 'all';
            // åˆ¤æ–·é‚è¼¯ï¼šæ²’æœ‰é¸åˆ†é¡ ä¸” ä¸æ˜¯ä¸ç´”æ¨¡å¼
            allSpan.className = `category-tab ${(!currentCategory && !isImpureMode) ? 'active' : ''}`; 
            allSpan.innerHTML = `å…¨é¡åˆ¥ <span class="text-[10px] ml-1 opacity-70">(${totalCount})</span>`;
            allSpan.onclick = () => loadHomeData();
            listEl.appendChild(allSpan);

            // --- ä¿®æ”¹ï¼šä¸ç´”å€æŒ‰éˆ• (ç²¾ç°¡æ–‡å­—) ---
            const impureCount = allPosts.filter(p => p.impure_count > 0).length;
            
            const impureSpan = document.createElement('span');
            impureSpan.dataset.id = 'impure';
            
            if (isImpureMode) {
                // å•Ÿç”¨ç‹€æ…‹ (ç´…åº•ç™½å­—)
                impureSpan.className = 'category-tab active bg-red-600 text-white border-red-600 shadow-[0_0_10px_rgba(220,38,38,0.5)]';
                // å•Ÿç”¨æ™‚ï¼šé¡¯ç¤ºæ•¸é‡
                impureSpan.innerHTML = `âš ï¸ä¸ç´” <span class="text-[10px] ml-1 opacity-70">(${impureCount})</span>`;
            } else {
                // å¾…æ©Ÿç‹€æ…‹ (ç´…æ¡†æ–‡å­—)
                impureSpan.className = 'category-tab text-red-400 border-red-900/50 hover:bg-red-900/30';
                // å¾…æ©Ÿæ™‚ï¼šåªé¡¯ç¤ºæ¨™é¡Œï¼Œç§»é™¤ "(ç›£æ§)"
                impureSpan.innerHTML = `âš ï¸ä¸ç´”`;
            }
            
            impureSpan.onclick = () => loadImpureData();
            listEl.appendChild(impureSpan);

            // 2. å…¶ä»–åˆ†é¡æŒ‰éˆ•
            allCategories.forEach(cat => {
                const span = document.createElement('span');
                span.dataset.id = cat.id;
                
                // åˆ¤æ–·æ˜¯å¦ç‚ºç•¶å‰é¸ä¸­åˆ†é¡
                const isActive = currentCategory && currentCategory.id === cat.id;
                span.className = `category-tab ${isActive ? 'active' : ''}`; 
                span.innerHTML = `${cat.name} <span class="text-[10px] ml-1 opacity-70">(${cat.count || 0})</span>`;
                span.onclick = () => selectCategory(cat);
                listEl.appendChild(span);
            });

            setTimeout(() => {
                if (listEl.offsetHeight > 52) {
                    btn.classList.remove('hidden'); 
                } else {
                    btn.classList.add('hidden');
                }
            }, 0);
        }

        async function selectCategory(cat) {
            // å¦‚æœå†æ¬¡é»æ“Šå·²é¸å–çš„åˆ†é¡ -> å–æ¶ˆé¸å– (å›åˆ°é¦–é )
            if (currentCategory && currentCategory.id === cat.id) {
                await loadHomeData();
                return; 
            }
            currentCategory = cat;
            isImpureMode = false;
            
            // æ”¹ç”¨ dataset.id é€²è¡Œç²¾æº–æ¯”å°
            document.querySelectorAll('.category-tab').forEach(el => {
                el.classList.remove('active');
                // æ³¨æ„ï¼šdataset.id æ˜¯å­—ä¸²ï¼Œcat.id å¯èƒ½æ˜¯æ•¸å­—ï¼Œä½¿ç”¨ == è®“å®ƒå€‘å¯ä»¥æ¯”å°
                if (el.dataset.id == cat.id) el.classList.add('active');
            });

            const infoSec = document.getElementById('category-info-section');
            const imgEl = document.getElementById('category-image');
            const phEl = document.getElementById('category-placeholder');
            const nameEl = document.getElementById('current-category-name');
            const adminBtn = document.getElementById('admin-edit-category-btn');
            const shareSec = document.getElementById('share-section');
            const filterSec = document.getElementById('filter-section');

            if (infoSec) {
                infoSec.classList.remove('hidden');
                if (nameEl) nameEl.textContent = cat.name;

                if (cat.image_url) {
                    if (imgEl) {
                        imgEl.src = cat.image_url;
                        imgEl.classList.remove('hidden');
                    }
                    if (phEl) phEl.classList.add('hidden');
                } else {
                    if (imgEl) imgEl.classList.add('hidden');
                    if (phEl) phEl.classList.remove('hidden');
                }

                if (adminBtn) {
                    if (currentUser && currentUser.role === 'ç®¡ç†è€…') {
                        adminBtn.classList.remove('hidden');
                        adminBtn.onclick = () => openCategoryModal();
                    } else {
                        adminBtn.classList.add('hidden');
                    }
                }
            }

            if (shareSec) shareSec.classList.remove('hidden');
            
            if (filterSec) {
                filterSec.classList.remove('hidden');
            }

            const container = document.getElementById('category-container');
            const btn = document.getElementById('category-expand-btn');
            
            if (container && !container.classList.contains('max-h-[50px]')) {
                container.classList.add('max-h-[50px]');
                container.classList.remove('max-h-[1000px]');
                if (btn) btn.textContent = 'â–¼ å±•é–‹æ›´å¤š';
            }
            
            setTimeout(() => {
                const activeTab = document.querySelector('.category-tab.active');
                if (activeTab) {
                    activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            }, 300);

            await loadRadarPosts(cat.id);
        }

        async function loadRadarPosts(categoryId) {
            const listEl = document.getElementById('radar-list');
            listEl.innerHTML = '<p class="text-center py-10 text-gray-500">æœå°‹è¨Šè™Ÿä¸­...</p>';

            try {
                const session = (await supabaseClient.auth.getSession()).data.session;
                const options = {
                    body: JSON.stringify({ action: 'get-radar-posts', payload: { categoryId } })
                };
                if (session) {
                    options.headers = { Authorization: `Bearer ${session.access_token}` };
                }

                const { data, error } = await supabaseClient.functions.invoke('admin-actions', options);
                if (error) throw error;
                
                allPosts = data.data;
                updateFilters(); 
                renderPosts(allPosts); 

            } catch (e) {
                console.error(e);
                listEl.innerHTML = `<p class="text-center text-red-400">è®€å–å¤±æ•—: ${e.message}</p>`;
            }
        }

        function updateFilters() {
            uniqueCountries = new Set();
            uniqueRegions = new Set();
            uniqueAreas = new Set();
            
            allPosts.forEach(p => {
                if(p.country) uniqueCountries.add(p.country);
                if(p.region) uniqueRegions.add(p.region);
                if(p.area) uniqueAreas.add(p.area);
            });

            const fillSelect = (id, options, defaultText = 'å…¨éƒ¨') => {
                const el = document.getElementById(id);
                if (!el) return; 
                el.innerHTML = defaultText ? `<option value="all">${defaultText}</option>` : '';
                options.sort().forEach(val => {
                    el.add(new Option(val, val));
                });
            };
            
            const fillDatalist = (id, options) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.innerHTML = '';
                options.sort().forEach(val => {
                    el.innerHTML += `<option value="${val}">`;
                });
            }

            fillDatalist('country-list', [...uniqueCountries]);
            fillDatalist('region-list', [...uniqueRegions]);
            fillDatalist('area-list', [...uniqueAreas]);

            const selCountry = document.getElementById('filter-country');
            const selRegion = document.getElementById('filter-region');
            const selArea = document.getElementById('filter-area');

            if(selCountry) {
                const oldVal = selCountry.value;
                fillSelect('filter-country', [...uniqueCountries], 'å…¨éƒ¨åœ‹å®¶');
                if([...uniqueCountries].includes(oldVal)) selCountry.value = oldVal;
                selCountry.onchange = applyFilter;
            }
            if(selRegion) {
                const oldVal = selRegion.value;
                fillSelect('filter-region', [...uniqueRegions], 'å…¨éƒ¨åœ°å€');
                if([...uniqueRegions].includes(oldVal)) selRegion.value = oldVal;
                selRegion.onchange = applyFilter;
            }
            if(selArea) {
                const oldVal = selArea.value;
                fillSelect('filter-area', [...uniqueAreas], 'å…¨éƒ¨ç´°é …');
                if([...uniqueAreas].includes(oldVal)) selArea.value = oldVal;
                selArea.onchange = applyFilter;
            }

            if (typeof updateInputDropdowns === 'function') {
                updateInputDropdowns();
            }
        }

        function applyFilter() {
            const cVal = document.getElementById('filter-country').value;
            const rVal = document.getElementById('filter-region').value;
            const aVal = document.getElementById('filter-area').value; 
            
            const filtered = allPosts.filter(p => {
                const matchC = (cVal === 'all') || (p.country === cVal);
                const matchR = (rVal === 'all') || (p.region === rVal);
                const matchA = (aVal === 'all') || (p.area === aVal);
                return matchC && matchR && matchA;
            });

            renderPosts(filtered);
            
            const regionOptions = new Set();
            allPosts.forEach(p => {
                if (cVal === 'all' || p.country === cVal) regionOptions.add(p.region);
            });
            const selRegion = document.getElementById('filter-region');
            const oldR = selRegion.value;
            selRegion.innerHTML = '<option value="all">å…¨éƒ¨</option>';
            [...regionOptions].sort().forEach(r => selRegion.add(new Option(r, r)));
            if ([...regionOptions].includes(oldR) || oldR === 'all') selRegion.value = oldR;

            const areaOptions = new Set();
            allPosts.forEach(p => {
                const matchC = (cVal === 'all' || p.country === cVal);
                const matchR = (rVal === 'all' || p.region === rVal); 
                if (matchC && matchR && p.area) areaOptions.add(p.area);
            });
            const selArea = document.getElementById('filter-area');
            const oldA = selArea.value;
            selArea.innerHTML = '<option value="all">å…¨éƒ¨</option>';
            [...areaOptions].sort().forEach(a => selArea.add(new Option(a, a)));
            if ([...areaOptions].includes(oldA) || oldA === 'all') selArea.value = oldA;
        }

        function renderPosts(posts) {
            const listEl = document.getElementById('radar-list');
            listEl.innerHTML = '';

            if (posts.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-500 py-10">é€™è£¡é‚„æ²’æœ‰è¨Šè™Ÿ...</p>';
                return;
            }
            
            const catMap = {};
            allCategories.forEach(c => catMap[c.id] = c);

            posts.forEach(p => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 rounded-xl p-4 border border-gray-700 shadow-sm relative';
                
                let isOwner = false;
                if (currentUser) {
                    if (currentUser.role === 'ç®¡ç†è€…') isOwner = true; // åµæ¸¬ç®¡ç†å“¡
                    if (currentUser.id && currentUser.id === p.uploader_id) isOwner = true;
                }

                let controlBtns = '';
                if (isOwner) {
                    const pStr = JSON.stringify(p).replace(/"/g, '&quot;');
                    controlBtns = `
                        <div class="absolute top-3 right-3 flex gap-3">
                            <button onclick="editPost(${pStr})" class="text-gray-500 hover:text-blue-400 transition" title="ç·¨è¼¯">âœï¸</button>
                            <button onclick="deletePost('${p.id}')" class="text-gray-500 hover:text-red-400 transition" title="åˆªé™¤">ğŸ—‘ï¸</button>
                        </div>
                    `;
                }

                const safeName = (p.uploader_nickname || 'æœªçŸ¥').replace(/[\s\uFEFF\xA0]*\d{12}[\s\uFEFF\xA0]*$/, '').trim();
                const pureActive = p.my_vote === 'pure' ? 'text-green-400 bg-green-900/30 border-green-500' : 'text-gray-400 border-gray-600 hover:text-green-300';
                const impureActive = p.my_vote === 'impure' ? 'text-red-400 bg-red-900/30 border-red-500' : 'text-gray-400 border-gray-600 hover:text-red-300';
                const areaTag = p.area ? `<span class="bg-teal-900/30 text-teal-300 border border-teal-500/30 px-2 py-0.5 rounded">${p.area}</span>` : '';

                let categoryBadge = '';
                if (!currentCategory && catMap[p.category_id]) {
                    const c = catMap[p.category_id];
                    categoryBadge = `
                        <span class="ml-auto mr-5 text-[10px] bg-gray-700 text-gray-300 px-2 py-0.5 rounded-full border border-gray-600 cursor-pointer hover:bg-gray-600" onclick="selectCategoryById(${c.id})">
                            ${c.name}
                        </span>`;
                }

                card.innerHTML = `
                    ${controlBtns}
                    <div class="space-y-2 pr-12">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-blue-300 bg-blue-900/30 px-2 py-0.5 rounded-full">ğŸ“¡ è¨Šè™Ÿä¾†æº</span>
                            <span class="text-sm font-bold text-white">${safeName}</span>
                            ${categoryBadge}
                        </div>

                        <div class="flex items-center gap-2 bg-gray-900/50 p-2 rounded-lg border border-gray-700/50">
                            <code class="text-sm text-cyan-300 font-mono flex-1 truncate">${p.coordinates}</code>
                            <button onclick="copyText('${p.coordinates}')" class="text-xs bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded transition">è¤‡è£½</button>
                        </div>

                        <div class="flex flex-wrap gap-2 text-xs">
                            <span class="bg-blue-900/30 text-blue-300 border border-blue-500/30 px-2 py-0.5 rounded">${p.country}</span>
                            <span class="bg-indigo-900/30 text-indigo-300 border border-indigo-500/30 px-2 py-0.5 rounded">${p.region}</span>
                            ${areaTag}
                        </div>

                        <div class="flex gap-3 pt-2 mt-2 border-t border-gray-700/50">
                            <button onclick="votePost('${p.id}', 'pure', this)" class="flex-1 flex items-center justify-center gap-1 py-1.5 rounded border ${pureActive} transition text-sm font-bold">
                                ğŸ¥´ å¥½ç´” <span class="count text-xs ml-1">(${p.pure_count})</span>
                            </button>
                            <button onclick="votePost('${p.id}', 'impure', this)" class="flex-1 flex items-center justify-center gap-1 py-1.5 rounded border ${impureActive} transition text-sm font-bold">
                                ğŸ¥² ä¸ç´” <span class="count text-xs ml-1">(${p.impure_count})</span>
                            </button>
                        </div>
                    </div>
                `;
                listEl.appendChild(card);
            });
        }

        // é–‹å•Ÿåˆ†äº«/ç·¨è¼¯è¦–çª— (ä¿®æ­£ç‰ˆï¼šæ”¯æ´å…¨åŸŸç™¼å¸ƒ)
        function openShareModal(editPost = null) {
            const modal = document.getElementById('share-modal');
            const form = document.getElementById('share-form');
            const title = document.getElementById('modal-title');
            const btn = document.getElementById('submit-btn');
            const catSelect = document.getElementById('input-category-select');

            // 1. é‡ç½®è¡¨å–®
            form.reset();
            isEditing = false;
            
            // 2. å¡«å…¥é¡åˆ¥é¸é … (å¾ allCategories ç”¢ç”Ÿ)
            catSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡é£¾å“ç¨®é¡...</option>';
            // ä¾ç…§åç¨±æ’åºæ–¹ä¾¿å°‹æ‰¾
            const sortedCats = [...allCategories].sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant'));
            
            sortedCats.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id;
                opt.textContent = cat.name;
                catSelect.appendChild(opt);
            });

            // 3. åˆ¤æ–·é è¨­é¸å–çš„é¡åˆ¥
            if (editPost) {
                // [ç·¨è¼¯æ¨¡å¼]ï¼šé¸å–è©²è²¼æ–‡åŸæœ¬çš„é¡åˆ¥
                // æ³¨æ„ï¼šRadar åˆ—è¡¨å›å‚³æ™‚é€šå¸¸æœƒå¸¶è‘— category_idï¼Œè‹¥æ²’æœ‰éœ€èª¿æ•´å¾Œç«¯ select
                // é€™è£¡å‡è¨­æˆ‘å€‘èƒ½å¾ç•¶å‰é é¢ç‹€æ…‹æˆ– editPost å–å¾—
                if (currentCategory) {
                    catSelect.value = currentCategory.id;
                }
                // è‹¥è·¨é¡åˆ¥ç·¨è¼¯åŠŸèƒ½è¤‡é›œï¼Œå»ºè­°ç·¨è¼¯æ™‚é–å®šé¡åˆ¥æˆ–ç”±å¾Œç«¯è£œå…¨è³‡æ–™
            } else {
                // [æ–°å¢æ¨¡å¼]
                if (currentCategory) {
                    // å¦‚æœä½¿ç”¨è€…æ­£åœ¨çœ‹ã€Œå…¬åœ’ã€ï¼Œé è¨­å°±é¸ã€Œå…¬åœ’ã€
                    catSelect.value = currentCategory.id;
                } else {
                    // å¦‚æœä½¿ç”¨è€…åœ¨ã€Œé¦–é ã€ï¼Œä¿æŒæœªé¸å–ç‹€æ…‹ (required æœƒå¼·åˆ¶ä»–é¸)
                    catSelect.value = "";
                }
            }

            // 4. è™•ç†å…¶é¤˜æ¬„ä½
            if (editPost) {
                isEditing = true;
                title.textContent = 'ç·¨è¼¯é›·é”é»';
                btn.textContent = 'æ›´æ–°';
                document.getElementById('post-id').value = editPost.id;
                document.getElementById('input-coords').value = editPost.coordinates;
                document.getElementById('input-country').value = editPost.country || '';
                document.getElementById('input-region').value = editPost.region || '';
                document.getElementById('input-area').value = editPost.area || '';
            } else {
                title.textContent = 'åˆ†äº«é›·é”é»';
                btn.textContent = 'ç™¼å¸ƒ';
                document.getElementById('post-id').value = '';
            }

            modal.classList.remove('hidden');
        }

        // ç›´æ¥å‘¼å« openShareModal çµ±ä¸€è™•ç†
        function editPost(post) {
            // å°‡è²¼æ–‡è³‡æ–™å‚³éçµ¦å…±ç”¨çš„é–‹å•Ÿè¦–çª—å‡½å¼
            openShareModal(post);
        }

        // é–‹å•Ÿåˆ†äº«/ç·¨è¼¯è¦–çª— (ä¿®æ­£ç‰ˆï¼šæ”¯æ´è‡ªå‹•å¸¶å…¥åˆ†é¡èˆ‡ç¼ºæ¼åæŸ¥)
        async function openShareModal(editPost = null) {
            const modal = document.getElementById('share-modal');
            const form = document.getElementById('share-form');
            const title = document.getElementById('modal-title');
            const btn = document.getElementById('submit-btn');
            const catSelect = document.getElementById('input-category-select');

            // 1. é‡ç½®è¡¨å–®èˆ‡ç‹€æ…‹
            form.reset();
            isEditing = false;
            document.getElementById('post-id').value = '';
            
            // 2. å¡«å…¥é¡åˆ¥é¸é … (å¾ allCategories ç”¢ç”Ÿ)
            catSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡é£¾å“ç¨®é¡...</option>';
            const sortedCats = [...allCategories].sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant'));
            
            sortedCats.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id; // value æ˜¯åˆ†é¡çš„ ID
                opt.textContent = cat.name;
                catSelect.appendChild(opt);
            });

            // 3. è™•ç†ã€Œç·¨è¼¯ã€æˆ–ã€Œæ–°å¢ã€æ¨¡å¼
            if (editPost) {
                // === ç·¨è¼¯æ¨¡å¼ ===
                isEditing = true;
                title.textContent = 'ç·¨è¼¯ç´”é»';
                btn.textContent = 'æ›´æ–°';
                
                // å¡«å…¥åŸºæœ¬è³‡æ–™
                document.getElementById('post-id').value = editPost.id;
                document.getElementById('input-coords').value = editPost.coordinates;
                document.getElementById('input-country').value = editPost.country || '';
                document.getElementById('input-region').value = editPost.region || '';
                document.getElementById('input-area').value = editPost.area || '';

                // â˜… ä¿®æ­£ 1ï¼šè‡ªå‹•é¸å–è©²è²¼æ–‡åŸæœ¬çš„åˆ†é¡
                // æª¢æŸ¥ editPost æ˜¯å¦æœ‰ category_idï¼Œæœ‰çš„è©±ç›´æ¥è¨­å®šçµ¦ select
                if (editPost.category_id) {
                    catSelect.value = editPost.category_id;
                }

                // â˜… ä¿®æ­£ 2ï¼šå¦‚æœã€Œåœ‹å®¶ã€æˆ–ã€Œåœ°å€ã€æ˜¯ç©ºçš„ï¼Œè‡ªå‹•è§¸ç™¼åæŸ¥
                const isLocationEmpty = !editPost.country || !editPost.region;
                if (isLocationEmpty && editPost.coordinates) {
                    // è§£æåº§æ¨™
                    const parts = editPost.coordinates.split(',');
                    if (parts.length === 2) {
                        const lat = parts[0].trim();
                        const lng = parts[1].trim();
                        // å‘¼å«è‡ªå‹•å¡«å¯« (ä¸éœ€ awaitï¼Œè®“å®ƒåœ¨èƒŒæ™¯åŸ·è¡Œå³å¯ï¼Œé¿å…å¡ä½è¦–çª—é–‹å•Ÿ)
                        console.log('åµæ¸¬åˆ°åœ°é»è³‡æ–™ç¼ºå¤±ï¼Œæ­£åœ¨è‡ªå‹•åæŸ¥...');
                        autoFillLocation(lat, lng);
                    }
                }

            } else {
                // === æ–°å¢æ¨¡å¼ ===
                title.textContent = 'åˆ†äº«é›·é”é»';
                btn.textContent = 'ç™¼å¸ƒ';
                
                // é è¨­åˆ†é¡é‚è¼¯ï¼šå¦‚æœåœ¨ç‰¹å®šåˆ†é¡é é¢ï¼Œå°±é è¨­é¸è©²åˆ†é¡
                if (currentCategory) {
                    catSelect.value = currentCategory.id;
                } else {
                    catSelect.value = "";
                }
            }

            modal.classList.remove('hidden');
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.add('hidden');
            document.getElementById('share-form').reset();
        }

        async function votePost(postId, type, btnEl) {
            try {
                const session = (await supabaseClient.auth.getSession()).data.session;
                const options = {
                    body: JSON.stringify({ action: 'vote-radar-post', payload: { postId, type } })
                };
                if (session) options.headers = { Authorization: `Bearer ${session.access_token}` };

                const { data, error } = await supabaseClient.functions.invoke('admin-actions', options);
                if (error) throw error;

                if (currentCategory) {
                    await loadRadarPosts(currentCategory.id);
                } else {
                    await loadHomeData();
                }

            } catch (e) {
                console.error('æŠ•ç¥¨å¤±æ•—', e);
            }
        }

        async function deletePost(postId) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤é›·é”é»ï¼Ÿ')) return;
            try {
                const session = (await supabaseClient.auth.getSession()).data.session;
                const options = {
                    body: JSON.stringify({ action: 'delete-radar-post', payload: { postId } })
                };
                if (session) options.headers = { Authorization: `Bearer ${session.access_token}` };
                
                const { error } = await supabaseClient.functions.invoke('admin-actions', options);
                if (error) throw error;

                if(currentCategory) loadRadarPosts(currentCategory.id);
                else loadHomeData();

            } catch (e) {
                alert('åˆªé™¤å¤±æ•—: ' + e.message);
            }
        }

        function openCategoryModal() {
            document.getElementById('cat-name').value = currentCategory.name;
            document.getElementById('cat-image').value = '';
            document.getElementById('category-modal').classList.remove('hidden');
        }

        document.getElementById('category-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newName = document.getElementById('cat-name').value;
            const fileInput = document.getElementById('cat-image');
            
            try {
                let imageUrl = currentCategory.image_url;

                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const fileName = `cat_${Date.now()}.${file.name.split('.').pop()}`;
                    
                    const { data, error } = await supabaseClient.storage.from('radar-category-images').upload(fileName, file);
                    if (error) throw error;
                    
                    const { data: pub } = supabaseClient.storage.from('radar-category-images').getPublicUrl(fileName);
                    imageUrl = pub.publicUrl;
                }

                const session = (await supabaseClient.auth.getSession()).data.session;
                const { error } = await supabaseClient.functions.invoke('admin-actions', {
                    headers: { Authorization: `Bearer ${session.access_token}` },
                    body: JSON.stringify({ 
                        action: 'update-radar-category', 
                        payload: { id: currentCategory.id, name: newName, image_url: imageUrl } 
                    })
                });

                if (error) throw error;
                
                alert('æ›´æ–°æˆåŠŸ');
                document.getElementById('category-modal').classList.add('hidden');
                loadCategories(); 
                currentCategory.name = newName;
                currentCategory.image_url = imageUrl;
                selectCategory(currentCategory);

            } catch (err) {
                alert('æ›´æ–°å¤±æ•—: ' + err.message);
            }
        });

        document.getElementById('share-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            
            // 1. åº§æ¨™æ ¼å¼åŒ–
            const rawCoords = document.getElementById('input-coords').value;
            const formattedCoords = formatCoordinateString(rawCoords);
            document.getElementById('input-coords').value = formattedCoords;

            // â˜…â˜…â˜… æ–°å¢ï¼šå‰ç«¯å¿…å¡«æª¢æŸ¥ (é˜²æ­¢ç©ºè³‡æ–™ç™¼é€) â˜…â˜…â˜…
            const selectedCatId = document.getElementById('input-category-select').value;
            const inputCoords = document.getElementById('input-coords').value;

            if (!selectedCatId) {
                alert("è«‹é¸æ“‡é£¾å“é¡åˆ¥ï¼");
                return;
            }
            if (!inputCoords) {
                alert("è«‹è¼¸å…¥åº§æ¨™ï¼");
                return;
            }

            // 2. é–å®šæŒ‰éˆ•
            btn.disabled = true; 
            const originalText = btn.textContent;
            btn.textContent = isEditing ? 'æ›´æ–°ä¸­...' : 'ç™¼é€ä¸­...';

            try {
                // â˜…â˜…â˜… æ–°å¢ï¼šèº«åˆ†åˆ¤å®šé‚è¼¯ (Logic #3) â˜…â˜…â˜…
                const currentGuestNick = localStorage.getItem('guest_nick');
                let finalNickname = null;

                // é‚è¼¯ï¼šæœ‰è¨ªå®¢æš±ç¨±å°±ç”¨è¨ªå®¢ï¼Œå¦å‰‡çœ‹æœ‰æ²’æœ‰ç™»å…¥æœƒå“¡ï¼Œéƒ½æ²’æœ‰å°±æ“‹ä¸‹
                if (currentGuestNick) {
                    finalNickname = currentGuestNick;
                } else if (currentUser && currentUser.nickname) {
                    finalNickname = currentUser.nickname;
                } else {
                    throw new Error('è«‹å…ˆç™»å…¥æœƒå“¡ï¼Œæˆ–å‰å¾€å¤§å»³è¨­å®šè¨ªå®¢èº«åˆ†å¾Œå†ç™¼å¸ƒã€‚');
                }
                // â˜…â˜…â˜… çµæŸèº«åˆ†åˆ¤å®š â˜…â˜…â˜…

                const postId = document.getElementById('post-id').value;
                
                const payload = {
                    categoryId: selectedCatId, 
                    coordinates: inputCoords,
                    country: document.getElementById('input-country').value || '',
                    region: document.getElementById('input-region').value || '',
                    area: document.getElementById('input-area').value || '',
                    nickname: finalNickname // â˜… ä½¿ç”¨åˆ¤å®šå¾Œçš„æš±ç¨±
                };

                const action = isEditing ? 'update-radar-post' : 'create-radar-post';
                if (isEditing) {
                    payload.postId = postId;
                }

                const session = (await supabaseClient.auth.getSession()).data.session;
                const options = {
                    body: JSON.stringify({ action, payload })
                };
                if (session) options.headers = { Authorization: `Bearer ${session.access_token}` };

                // å‘¼å«å¾Œç«¯
                const { data, error } = await supabaseClient.functions.invoke('admin-actions', options);
                
                if (error) throw error;
                if (data && data.success === false) {
                    alert('âš ï¸ æç¤ºï¼š' + (data.message || 'æ“ä½œè¢«æ‹’çµ•'));
                    return;
                }

                alert(isEditing ? 'æ›´æ–°æˆåŠŸï¼' : 'ç™¼å¸ƒæˆåŠŸï¼');
                closeShareModal(); 
                
                // åˆ·æ–°é‚è¼¯
                if (currentCategory && currentCategory.id == selectedCatId) {
                    loadRadarPosts(selectedCatId);
                } else if (!currentCategory) {
                    loadHomeData(); 
                }
                
                // é‡æ–°è¼‰å…¥åˆ†é¡çµ±è¨ˆ
                loadCategories(); 

            } catch (err) {
                console.error(err);
                alert('æ“ä½œå¤±æ•—: ' + (err.message || 'æœªçŸ¥éŒ¯èª¤'));
            } finally {
                btn.disabled = false; 
                btn.textContent = originalText;
            }
        });

        // â˜… å·¥å…·å‡½å¼ï¼šåº§æ¨™æ ¼å¼æ¨™æº–åŒ– (å½ˆæ€§ç‰ˆ - å…¼é¡§åœ°å€è¼¸å…¥)
        function formatCoordinateString(val) {
            if (!val) return "";
            let str = val.trim();

            // 1. å˜—è©¦è§£æ Google Maps ç¶²å€ (æœ€å„ªå…ˆ)
            let match = str.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
            if (match) return `${parseFloat(match[1]).toFixed(7)}, ${parseFloat(match[2]).toFixed(7)}`;
            
            match = str.match(/q=(-?\d+\.\d+),(-?\d+\.\d+)/);
            if (match) return `${parseFloat(match[1]).toFixed(7)}, ${parseFloat(match[2]).toFixed(7)}`;
            
            match = str.match(/!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/);
            if (match) return `${parseFloat(match[1]).toFixed(7)}, ${parseFloat(match[2]).toFixed(7)}`;

            // 2. å˜—è©¦è§£ææ¨™æº–åº§æ¨™
            // å…ˆæŠŠå…¨å½¢é€—è™Ÿè½‰åŠå½¢
            let tempStr = str.replace(/ï¼Œ/g, ',');
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºåº¦åˆ†ç§’ (DMS)
            const isDMS = tempStr.includes('Â°') && (tempStr.includes("'") || tempStr.includes('"') || tempStr.includes('â€™'));
            
            let lat = 0, lng = 0;
            let success = false;

            if (isDMS) {
                // === è™•ç†åº¦åˆ†ç§’ ===
                const numbers = tempStr.match(/(\d+(\.\d+)?)/g);
                const directions = tempStr.match(/[NSEWåŒ—å—æ±è¥¿]/gi) || [];
                
                if (numbers && numbers.length >= 6) {
                    const d1 = parseFloat(numbers[0]), m1 = parseFloat(numbers[1]), s1 = parseFloat(numbers[2]);
                    const d2 = parseFloat(numbers[3]), m2 = parseFloat(numbers[4]), s2 = parseFloat(numbers[5]);

                    lat = d1 + (m1 / 60) + (s1 / 3600);
                    lng = d2 + (m2 / 60) + (s2 / 3600);

                    const dirStr = directions.join('');
                    if (/[Så—]/.test(dirStr)) lat = -lat; 
                    if (/[Wè¥¿]/.test(dirStr)) lng = -lng;

                    success = true;
                }
            } else {
                // === è™•ç†ä¸€èˆ¬å°æ•¸æ ¼å¼ ===
                const numbers = tempStr.match(/(-?\d+\.\d+)/g);
                
                if (numbers && numbers.length >= 2) {
                    lat = parseFloat(numbers[0]);
                    lng = parseFloat(numbers[1]);
                    
                    // ç¯„åœæª¢æŸ¥ (-90~90, -180~180) é¿å…æŠŠæ—¥æœŸèª¤åˆ¤ç‚ºåº§æ¨™
                    if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                        if (/[Så—]/.test(tempStr) && lat > 0) lat = -lat;
                        if (/[Wè¥¿]/.test(tempStr) && lng > 0) lng = -lng;
                        success = true;
                    }
                }
            }

            if (success) {
                // æˆåŠŸè§£æå‡ºåº§æ¨™ -> å›å‚³ 7 ä½å°æ•¸æ ¼å¼
                return `${lat.toFixed(7)}, ${lng.toFixed(7)}`;
            } else {
                // è§£æå¤±æ•— (å¯èƒ½æ˜¯åœ°å€æˆ–åœ°æ¨™åç¨±) -> å›å‚³åŸå­—ä¸²ï¼Œä¸åšä¿®æ”¹
                return val; 
            }
        }

        // â˜… å·¥å…·å‡½å¼ï¼šè‡ªå‹•åæŸ¥åœ°ç†ä½ç½® (é€éå¾Œç«¯ Proxy)
        async function autoFillLocation(lat, lng) {
            const countryInput = document.getElementById('input-country');
            const regionInput = document.getElementById('input-region');
            const areaInput = document.getElementById('input-area');

            const originalPlaceholders = {
                country: countryInput.placeholder,
                region: regionInput.placeholder,
                area: areaInput.placeholder
            };
            
            countryInput.value = ''; countryInput.placeholder = 'ğŸ” æœå°‹ä¸­...';
            regionInput.value = ''; regionInput.placeholder = 'ğŸ” æœå°‹ä¸­...';
            areaInput.value = ''; areaInput.placeholder = 'ğŸ” æœå°‹ä¸­...';

            try {
                // â˜… ä¿®æ”¹ï¼šæ”¹å‘¼å« Supabase Edge Function (ç”±å¾Œç«¯ä»£ç‚ºæŸ¥è©¢)
                const { data: resData, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ 
                        action: 'reverse-geocode', 
                        payload: { lat, lng } 
                    })
                });

                if (error) throw error;

                // å¾Œç«¯å›å‚³çš„çµæ§‹æ˜¯ { success: true, data: { ...OSMè³‡æ–™... } }
                const data = resData.data;

                if (data && data.address) {
                    const addr = data.address;

                    // 1. åœ‹å®¶
                    if (addr.country) countryInput.value = addr.country;

                    // 2. åœ°å€ (è‡ªå‹•ä¿®æ­£ "è‡º" ç‚º "å°")
                    const region = addr.city || addr.county || addr.state || '';
                    if (region) regionInput.value = region.replace(/è‡º/g, 'å°');

                    // 3. ç´°é …
                    const area = addr.suburb || addr.district || addr.town || addr.village || addr.neighbourhood || '';
                    if (area) areaInput.value = area;
                    
                    // é–ƒçˆç¶ æ¡†æç¤ºæˆåŠŸ
                    [countryInput, regionInput, areaInput].forEach(el => {
                        if(el.value) {
                            el.classList.add('ring-2', 'ring-green-500');
                            setTimeout(() => el.classList.remove('ring-2', 'ring-green-500'), 1000);
                        }
                    });
                }
            } catch (e) {
                console.error('è‡ªå‹•å¡«å¯«ä½ç½®å¤±æ•—:', e);
                // å¤±æ•—æ™‚æ¢å¾©åŸæœ¬çš„ placeholder
                countryInput.placeholder = originalPlaceholders.country;
                regionInput.placeholder = originalPlaceholders.region;
                areaInput.placeholder = originalPlaceholders.area;
            }
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => alert('å·²è¤‡è£½åº§æ¨™'));
        }

        function toggleCategories() {
            const container = document.getElementById('category-container');
            const btn = document.getElementById('category-expand-btn');
            
            if (container.classList.contains('max-h-[50px]')) {
                container.classList.remove('max-h-[50px]');
                container.classList.add('max-h-[1000px]'); 
                btn.textContent = 'â–² æ”¶åˆåˆ†é¡';
            } else {
                container.classList.add('max-h-[50px]');
                container.classList.remove('max-h-[1000px]');
                btn.textContent = 'â–¼ å±•é–‹æ›´å¤š';
            }
        }

        function selectCategoryById(id) {
            const cat = allCategories.find(c => c.id === id);
            if (cat) selectCategory(cat);
        }

        // åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®åŠŸèƒ½
        function setupInputDropdown(inputId, dropdownId, dataSet) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            
            const renderOptions = (filterText = '') => {
                // å¾ Set è½‰ç‚º Array ä¸¦æ’åº
                const options = Array.from(dataSet).sort();
                
                // éæ¿¾
                const filtered = options.filter(txt => 
                    txt && txt.toLowerCase().includes(filterText.toLowerCase())
                );

                dropdown.innerHTML = '';
                if (filtered.length === 0) {
                    dropdown.innerHTML = '<div class="dropdown-option text-gray-500 cursor-default text-xs">ç„¡ç¬¦åˆé …ç›®</div>';
                } else {
                    filtered.forEach(txt => {
                        const div = document.createElement('div');
                        div.className = 'dropdown-option';
                        div.textContent = txt;
                        div.onclick = () => {
                            input.value = txt;
                            dropdown.classList.remove('show');
                        };
                        dropdown.appendChild(div);
                    });
                }
            };

            input.onfocus = () => {
                renderOptions(input.value);
                dropdown.classList.add('show');
            };
            
            input.oninput = () => {
                renderOptions(input.value);
                dropdown.classList.add('show');
            };

            // é»æ“Šå¤–éƒ¨é—œé–‰
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        }

        // æ¯æ¬¡æ•¸æ“šè¼‰å…¥å¾Œï¼Œæ›´æ–°ä¸‹æ‹‰é¸å–®çš„è³‡æ–™ä¾†æº
        function updateInputDropdowns() {
            // ç¢ºä¿ uniqueSets å·²ç¶“åœ¨ updateFilters() ä¸­è¢«è¨ˆç®—éäº†
            if (document.getElementById('input-country')) {
                setupInputDropdown('input-country', 'dropdown-country', uniqueCountries);
                setupInputDropdown('input-region', 'dropdown-region', uniqueRegions);
                setupInputDropdown('input-area', 'dropdown-area', uniqueAreas);
            }
        }

        // æ™ºæ…§è¿”å›åŠŸèƒ½
        function handleBack() {
            // radar.html æ‡‰è©²ä¹Ÿæœ‰åœ¨ checkAuth() æˆ–é¡ä¼¼å‡½å¼ä¸­è¨­å®š currentUser
            if (currentUser) {
                window.location.href = 'dashboard.html';
            } else {
                window.location.href = 'guest.html';
            }
        }
    </script>
</body>
</html>