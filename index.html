<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pikmin Bloom 蘑菇宅配網 - 登入</title>
    <link rel="icon" href="./mashroom_s.png" type="image/png">
    <link rel="apple-touch-icon" href="./mashroom_s.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* 樣式保持不變 */
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #111827; color: #d1d5db; }
        .login-container { background-color: #1f2937; border: 1px solid #374151; }
        .dark-input { background-color: #374151; border-color: #4b5563; color: #d1d5db; }
        .dark-input:focus { --tw-ring-color: #4f46e5; border-color: #4f46e5; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .dark-button { background-color: #4f46e5; transition: all 0.2s ease-in-out; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .dark-button:hover { background-color: #4338ca; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        /* 下拉選單樣式 */
        .custom-dropdown-container { position: relative; width: 100%; }
        .dropdown-options { position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background-color: #374151; border: 1px solid #4b5563; border-radius: 0.75rem; max-height: 280px; overflow-y: auto; z-index: 50; display: none; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        .dropdown-options.show { display: block; }
        .dropdown-item { padding: 12px 16px; color: #d1d5db; cursor: pointer; transition: background-color 0.1s; font-size: 0.95rem; border-bottom: 1px solid #4b5563; }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background-color: #4f46e5; color: white; }
        .input-arrow { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #9ca3af; font-size: 0.8rem; }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4">

    <div class="login-container w-full max-w-md p-8 space-y-8 rounded-2xl shadow-2xl">
        <div class="text-center">
            <img src="./mashroom_s.png" alt="Pikmin Logo" class="w-25 h-25 mr-2 rounded-full flex-shrink-0 object-contain bg-gray-800 inline-block">
        </div>
        <form id="login-form" class="space-y-6">
            <div>
                <label class="text-sm font-bold text-gray-400">遊戲暱稱</label>
                <div class="custom-dropdown-container mt-1">
                    <input type="text" id="nickname-input" name="nickname" required 
                           class="dark-input w-full px-4 py-3 rounded-xl focus:outline-none" 
                           placeholder="輸入或選擇暱稱..." autocomplete="off">
                    <span class="input-arrow">▼</span>
                    
                    <div id="nickname-dropdown" class="dropdown-options">
                        </div>
                </div>
            </div>
            <div>
                <label for="password" class="text-sm font-bold text-gray-400">密碼</label>
                <input id="password" name="password" type="password" autocomplete="current-password" required class="dark-input w-full px-4 py-3 mt-1 rounded-xl focus:outline-none" placeholder="••••••••">
            </div>
            
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 rounded border-gray-500 bg-gray-600 text-indigo-600 focus:ring-indigo-500">
                    <label for="remember-me" class="ml-2 block text-sm text-gray-400">記住我</label> </div>
            </div>

            <div>
                <button type="submit" id="login-button" class="dark-button w-full px-4 py-3 font-bold text-white rounded-xl focus:outline-none">
                    登入
                </button>
            </div>
        </form>

        <div id="message-box" class="p-4 text-center text-sm rounded-xl hidden"></div>

    </div>

    <script>
        // --- 設定 Supabase ---
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ'; // 請確認 key 是否正確
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM 元素 ---
        const loginForm = document.getElementById('login-form');
        const loginButton = document.getElementById('login-button');
        const messageBox = document.getElementById('message-box');
        const rememberMeCheckbox = document.getElementById('remember-me');
        const nicknameInput = document.getElementById('nickname-input');
        const nicknameDropdown = document.getElementById('nickname-dropdown');
        
        let allNicknames = []; // 儲存完整名單

        // --- 輔助函式: 顯示訊息 ---
        function showMessage(text, bgColor, textColor) {
            messageBox.textContent = text;
            messageBox.className = `p-4 text-center text-sm rounded-xl ${bgColor} ${textColor}`;
            messageBox.classList.remove('hidden');
        }

        // --- 1. 檢查初始登入狀態 ---
        async function checkInitialSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                window.location.href = './dashboard.html';
            }
        }

        // --- 2. 載入並填充選單 ---
        async function populateNicknames() {
            try {
                const { data: profiles, error } = await supabaseClient
                    .from('profiles')
                    .select('nickname');

                if (error) throw error;
                
                if (!profiles || profiles.length === 0) {
                    nicknameInput.placeholder = '無可用暱稱';
                    return;
                }

                // 排序：英文在前，中文在後
                profiles.sort((a, b) => {
                    const aIsEn = /^[a-zA-Z0-9]/.test(a.nickname);
                    const bIsEn = /^[a-zA-Z0-9]/.test(b.nickname);
                    if (aIsEn && !bIsEn) return -1;
                    if (!aIsEn && bIsEn) return 1;
                    return a.nickname.localeCompare(b.nickname, 'zh-Hant');
                });

                allNicknames = profiles.map(p => p.nickname);
                renderDropdown(allNicknames);

                // 記憶登入
                const remembered = localStorage.getItem('rememberedNickname');
                if (remembered) {
                    nicknameInput.value = remembered;
                    rememberMeCheckbox.checked = true;
                    // document.getElementById('password').focus(); // 可選：自動聚焦密碼框
                }

            } catch (error) {
                console.error(error);
                nicknameInput.placeholder = '無法載入列表';
            }
        }

        // --- 3. 渲染下拉選單 ---
        function renderDropdown(items) {
            nicknameDropdown.innerHTML = '';
            if (items.length === 0) {
                nicknameDropdown.innerHTML = '<div class="p-3 text-center text-gray-500 text-sm">無符合結果</div>';
                return;
            }
            
            items.forEach(name => {
                const div = document.createElement('div');
                div.className = 'dropdown-item'; // 使用 CSS 定義的樣式
                
                // 去除尾端 ID 顯示
                const displayName = name.trim().replace(/[\s\uFEFF\xA0]*\d{12}$/, '');
                
                div.textContent = displayName;
                
                div.addEventListener('click', () => {
                    nicknameInput.value = name; // 填入完整值
                    nicknameDropdown.classList.remove('show');
                });
                nicknameDropdown.appendChild(div);
            });
        }

        // --- 4. 輸入框互動邏輯 ---
        // 點擊或聚焦時顯示
        nicknameInput.addEventListener('click', () => {
            // 如果輸入框是空的，顯示所有；如果有字，顯示過濾結果
            const term = nicknameInput.value.toLowerCase();
            const listToShow = term ? allNicknames.filter(n => n.toLowerCase().includes(term)) : allNicknames;
            
            renderDropdown(listToShow);
            nicknameDropdown.classList.add('show');
        });

        // 輸入文字時過濾
        nicknameInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allNicknames.filter(n => n.toLowerCase().includes(term));
            renderDropdown(filtered);
            nicknameDropdown.classList.add('show');
        });

        // 點擊外部關閉選單
        document.addEventListener('click', (e) => {
            if (!nicknameInput.contains(e.target) && !nicknameDropdown.contains(e.target)) {
                nicknameDropdown.classList.remove('show');
            }
        });

        // --- 5. 登入表單提交 (單一監聽器) ---
        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // 阻止表單預設提交
            
            // 防止重複點擊
            if (loginButton.disabled) return;

            loginButton.disabled = true;
            loginButton.textContent = '登入中...';
            showMessage('', 'hidden', ''); // 清除舊訊息

            const nickname = nicknameInput.value.trim();
            const password = loginForm.password.value;
            
            if (!nickname) {
                showMessage('請輸入或選擇暱稱！', 'bg-yellow-500', 'text-white');
                loginButton.disabled = false;
                loginButton.textContent = '登入';
                return;
            }
            
            // --- 雙軌登入邏輯 ---
            // 格式 A (新制)：Hex 編碼
            const hexNickname = Array.from(new TextEncoder().encode(nickname))
                .map(b => b.toString(16).padStart(2, '0')).join('');
            const emailNew = `${hexNickname}@pikmin.sys`;

            // 格式 B (舊制)：清洗符號
            const cleanNickname = (nickname || '').split(/[^a-zA-Z0-9\u4e00-\u9fa5\s]/)[0];
            const emailOld = `${encodeURIComponent(cleanNickname)}@pikmin.sys`;

            try {
                // 1. 嘗試新制
                let { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: emailNew,
                    password: password,
                });

                // 2. 如果失敗 (無效登入)，嘗試舊制
                if (error && (error.message.includes('Invalid login') || error.message.includes('Email not confirmed'))) {
                    // console.log('新制失敗，嘗試舊制...');
                    const retry = await supabaseClient.auth.signInWithPassword({
                        email: emailOld,
                        password: password,
                    });
                    
                    if (!retry.error) {
                        data = retry.data;
                        error = null;
                    }
                }

                if (error) throw error;
                
                // 登入成功
                if (rememberMeCheckbox.checked) {
                    localStorage.setItem('rememberedNickname', nickname);
                } else {
                    localStorage.removeItem('rememberedNickname');
                }

                showMessage('登入成功！即將跳轉...', 'bg-green-500', 'text-white');
                setTimeout(() => {
                    window.location.href = './dashboard.html';
                }, 500); // 稍微延遲讓使用者看到成功訊息

            } catch (error) {
                console.error(error); // 方便除錯
                if (error.message.includes('Invalid login credentials')) {
                    showMessage('登入失敗：暱稱或密碼錯誤。', 'bg-red-500', 'text-white');
                } else {
                    showMessage(`登入失敗: ${error.message}`, 'bg-red-500', 'text-white');
                }
                loginButton.disabled = false;
                loginButton.textContent = '登入';
            }
        });
        
        // --- 程式入口 ---
        document.addEventListener('DOMContentLoaded', () => {
            checkInitialSession();
            populateNicknames();
        });
    </script>
</body>
</html>