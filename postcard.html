<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾ç‰‡åœ–æ›¸é¤¨ - è‡è‡å®…é…ç¶²</title>
    <link rel="icon" href="./mashroom_s.png" type="image/png">
    <link rel="apple-touch-icon" href="./mashroom_s.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #111827; color: #d1d5db; }
        .dark-input { background-color: #374151; border-color: #4b5563; color: #d1d5db; }
        .dark-input:focus { border-color: #ec4899; --tw-ring-color: #ec4899; outline: none; ring: 2px; } 
        .card-bg { background-color: #1f2937; border: 1px solid #374151; transition: all 0.3s; }
        .card-bg:hover { border-color: #ec4899; transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }
        .filter-tag { cursor: pointer; transition: all 0.2s; border-radius: 9999px; padding: 4px 12px; font-size: 0.85rem; border: 1px solid #4b5563; background-color: #374151; color: #d1d5db; }
        .filter-tag:hover, .filter-tag.active { background-color: #ec4899; color: white; border-color: #ec4899; }
        .like-btn { cursor: pointer; transition: transform 0.2s; user-select: none; }
        .like-btn:active { transform: scale(1.2); }
        .like-btn.liked { color: #f43f5e; } /* Rose-500 */
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.8); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* === è‡ªè¨‚ä¸‹æ‹‰é¸å–®æ¨£å¼ (ä»¿ç™»å…¥é é¢¨æ ¼) === */
        .custom-dropdown-container {
            position: relative;
            width: 100%;
        }
        .dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background-color: #374151; /* æ·±ç°èƒŒæ™¯ */
            border: 1px solid #4b5563;
            border-radius: 0.5rem; /* rounded-lg */
            max-height: 200px;      /* é™åˆ¶é«˜åº¦ */
            overflow-y: auto;       /* è¶…å‡ºæ²å‹• */
            z-index: 60;            /* ç¢ºä¿è“‹åœ¨å…¶ä»–å…ƒç´ ä¸Š */
            display: none;          /* é è¨­éš±è— */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        .dropdown-options.show {
            display: block;
        }
        .dropdown-option {
            padding: 10px 12px;
            color: #d1d5db;
            cursor: pointer;
            transition: background-color 0.1s;
            font-size: 0.875rem; /* text-sm */
            border-bottom: 1px solid #4b5563;
            text-align: left;
        }
        .dropdown-option:last-child {
            border-bottom: none;
        }
        .dropdown-option:hover {
            background-color: #ec4899; /* Pink-500 */
            color: white;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">
    
    <div class="max-w-7xl mx-auto">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4 border-b border-gray-700 pb-6">
            <h1 class="text-3xl font-bold text-white flex items-center gap-2">
                <span>ğŸ–¼ï¸</span> ç¾ç‰‡åœ–æ›¸é¤¨
            </h1>
            <div class="flex items-center gap-4">
                <button id="add-postcard-btn" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition flex items-center gap-2 transform hover:scale-105">
                    <span>â•</span> åˆ†äº«ç¾ç‰‡
                </button>
                <a href="./dashboard.html" class="text-gray-400 hover:text-white font-bold transition flex items-center gap-1">
                    <span>â†©ï¸</span> è¿”å›ä¸»é 
                </a>
            </div>
        </header>

        <div class="mb-8">
            <div class="flex items-center gap-2 mb-2">
                <span class="text-gray-400 text-sm">ğŸ·ï¸ ç†±é–€æ¨™ç±¤ï¼š</span>
            </div>
            <div id="filter-container" class="flex flex-wrap gap-2 items-center">
                <button class="filter-tag active" data-tag="all">å…¨éƒ¨é¡¯ç¤º</button>
                </div>
        </div>

        <div id="postcard-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <p class="col-span-full text-center py-12 text-gray-500 animate-pulse">æ­£åœ¨å¾è³‡æ–™åº«è®€å–ç¾ç‰‡...</p>
        </div>
    </div>

    <div id="postcard-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-gray-800 border border-gray-600 w-full max-w-md rounded-2xl shadow-2xl p-6 relative">
            <button id="close-modal-x" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">&times;</button>
            <h2 id="modal-title" class="text-2xl font-bold text-white mb-6">åˆ†äº«æ–°ç¾ç‰‡</h2>
            
            <form id="postcard-form" class="space-y-4">
                <input type="hidden" id="edit-id">
                
                <div id="image-upload-section">
                    <label class="block text-sm font-medium text-gray-400 mb-1">ä¸Šå‚³åœ–ç‰‡</label>
                    <input type="file" id="image-upload" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-600 file:text-white hover:file:bg-pink-700 transition cursor-pointer"/>
                </div>

                <div id="preview-section" class="hidden text-center">
                    <p class="text-sm text-gray-400 mb-1 text-left">åœ–ç‰‡é è¦½</p>
                    <img id="preview-image" src="" class="rounded-lg max-h-48 mx-auto object-contain border border-gray-600 shadow-md">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">åº§æ¨™ (ç·¯åº¦, ç¶“åº¦)</label>
                    <div class="relative">
                        <input type="text" id="coordinate-input" required placeholder="ä¾‹å¦‚: 22.6123, 120.3456" class="dark-input w-full rounded-lg shadow-sm pl-3 pr-10 py-2.5">
                        <button type="button" id="paste-coord-btn" class="absolute right-2 top-2 text-gray-400 hover:text-white p-1" title="è²¼ä¸Šå‰ªè²¼ç°¿å…§å®¹">ğŸ“‹</button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">åˆ†é¡æ¨™ç±¤ (æœ€å¤š3å€‹)</label>
                    <div class="grid grid-cols-3 gap-2">
                        
                        <div class="custom-dropdown-container">
                            <input type="text" id="tag-1" placeholder="æ¨™ç±¤1" maxlength="10" class="dark-input w-full rounded-lg shadow-sm px-2 py-2.5 text-center text-sm" autocomplete="off">
                            <div id="dropdown-1" class="dropdown-options text-left"></div>
                        </div>

                        <div class="custom-dropdown-container">
                            <input type="text" id="tag-2" placeholder="æ¨™ç±¤2" maxlength="10" class="dark-input w-full rounded-lg shadow-sm px-2 py-2.5 text-center text-sm" autocomplete="off">
                            <div id="dropdown-2" class="dropdown-options text-left"></div>
                        </div>

                        <div class="custom-dropdown-container">
                            <input type="text" id="tag-3" placeholder="æ¨™ç±¤3" maxlength="10" class="dark-input w-full rounded-lg shadow-sm px-2 py-2.5 text-center text-sm" autocomplete="off">
                            <div id="dropdown-3" class="dropdown-options text-left"></div>
                        </div>

                    </div>
                    <p class="text-xs text-gray-500 mt-1">ç„¡éœ€è¼¸å…¥ # è™Ÿï¼Œé»æ“Šå¯é¸æ“‡ç†±é–€æ¨™ç±¤ (å·²é¸éçš„æœƒè‡ªå‹•éæ¿¾)ã€‚</p>
                </div>

                <div class="flex justify-end gap-3 mt-8 pt-4 border-t border-gray-700">
                    <button type="button" id="close-modal-btn" class="px-5 py-2.5 bg-gray-600 text-gray-200 rounded-lg hover:bg-gray-500 font-bold transition">å–æ¶ˆ</button>
                    <button type="submit" id="submit-btn" class="px-5 py-2.5 bg-pink-600 text-white rounded-lg hover:bg-pink-700 disabled:opacity-50 disabled:cursor-not-allowed font-bold transition shadow-lg">ç™¼å¸ƒ</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-message" class="hidden fixed top-5 right-5 text-white py-3 px-6 rounded-xl shadow-2xl z-50 font-bold flex items-center gap-2 transform transition-all duration-300 translate-y-0"></div>

    <div id="image-viewer-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm transition-opacity duration-300" onclick="closeImageViewer()">
        <div class="relative max-w-5xl w-full max-h-[95vh] flex justify-center items-center p-2" onclick="event.stopPropagation()">
            <button type="button" onclick="closeImageViewer()" class="absolute -top-12 right-0 md:top-4 md:right-4 text-white text-4xl hover:text-gray-300 font-bold bg-black/50 hover:bg-black/70 rounded-full w-12 h-12 flex items-center justify-center transition z-50">&times;</button>
            
            <img id="viewer-image" src="" alt="ç¾ç‰‡å¤§åœ–" class="rounded-lg shadow-2xl max-h-[85vh] md:max-h-[90vh] w-auto object-contain bg-gray-900 border border-gray-800">
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let allPostcards = [];
        let activeTag = 'all';

        // â˜… æ–°å¢ï¼šå°è£åœ–ç‰‡å£“ç¸®åŠŸèƒ½çš„ Promise å‡½å¼
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                new Compressor(file, {
                    quality: 0.6,      // å£“ç¸®å“è³ª (0 ~ 1)ï¼Œ0.6 é€šå¸¸èƒ½å£“åˆ° 500KB ä»¥ä¸‹ä¸”ç•«è³ªè‰¯å¥½
                    maxWidth: 1600,    // æœ€å¤§å¯¬åº¦ (åƒç´ )ï¼Œé¿å…ä¸Šå‚³ 4K/8K è¶…å¤§åœ–
                    maxHeight: 1600,   // æœ€å¤§é«˜åº¦
                    mimeType: 'image/jpeg', // çµ±ä¸€è½‰ç‚º JPEG (ä»¥ç²å¾—æœ€ä½³å£“ç¸®ç‡)
                    success(result) {
                        // result æ˜¯ä¸€å€‹ Blob ç‰©ä»¶ï¼Œæˆ‘å€‘æŠŠå®ƒè½‰å› File ç‰©ä»¶ä»¥ä¾¿ä¸Šå‚³
                        const compressedFile = new File([result], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now(),
                        });
                        resolve(compressedFile);
                    },
                    error(err) {
                        reject(err);
                    },
                });
            });
        }

        // åˆå§‹åŒ–
        async function init() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                alert('è«‹å…ˆç™»å…¥æ‰èƒ½ä½¿ç”¨ç¾ç‰‡åœ–æ›¸é¤¨');
                window.location.replace('./index.html');
                return;
            }
            
            const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
            currentUser = { ...session.user, ...profile };

            loadPostcards();
            initTagDropdowns(); // â˜… å•Ÿå‹•ä¸‹æ‹‰é¸å–®åŠŸèƒ½
        }

        // è¼‰å…¥è³‡æ–™
        async function loadPostcards() {
            const grid = document.getElementById('postcard-grid');
            try {
                const { data, error } = await supabaseClient
                    .from('postcards')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                allPostcards = data;

                const { data: likes } = await supabaseClient
                    .from('postcard_likes')
                    .select('postcard_id')
                    .eq('user_id', currentUser.id);
                
                const likedSet = new Set(likes ? likes.map(l => l.postcard_id) : []);
                allPostcards.forEach(p => { p.isLiked = likedSet.has(p.id); });
                
                updateFilterTags();  
                renderGrid();
            } catch (e) {
                console.error(e);
                grid.innerHTML = '<p class="col-span-full text-center text-red-400">ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
            }
        }

        // ä¿®æ”¹ postcard.html ä¸­çš„ updateFilterTags å‡½å¼
        function updateFilterTags() {
            const tagCounts = {};
            allPostcards.forEach(p => {
                if (p.tags) p.tags.forEach(t => {
                    const cleanTag = t.trim();
                    if(cleanTag) tagCounts[cleanTag] = (tagCounts[cleanTag] || 0) + 1;
                });
            });

            // ä¾ç…§ç†±é–€ç¨‹åº¦æ’åºçš„æ‰€æœ‰æ¨™ç±¤
            const allTags = Object.entries(tagCounts)
                .sort((a, b) => b[1] - a[1])
                .map(x => x[0]);

            const container = document.getElementById('filter-container');
            container.innerHTML = ''; // æ¸…ç©º

            // 1. æ°¸é é¡¯ç¤ºã€Œå…¨éƒ¨é¡¯ç¤ºã€æŒ‰éˆ•
            const allBtn = document.createElement('button');
            allBtn.className = 'filter-tag active';
            allBtn.dataset.tag = 'all';
            allBtn.textContent = `å…¨éƒ¨é¡¯ç¤º (${allPostcards.length})`;
            allBtn.onclick = function() {
                document.querySelectorAll('.filter-tag').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                activeTag = 'all';
                renderGrid();
            };
            container.appendChild(allBtn);

            // 2. è¨­å®šé¡¯ç¤ºæ•¸é‡é™åˆ¶ (ä¾‹å¦‚é è¨­é¡¯ç¤º 6 å€‹)
            const DISPLAY_LIMIT = 6;
            const hasMore = allTags.length > DISPLAY_LIMIT;
            
            // æ±ºå®šè¦æ¸²æŸ“å“ªäº›æ¨™ç±¤ (å¦‚æœæ²’å±•é–‹ï¼Œå°±åªæ‹¿å‰6å€‹ï¼›å¦‚æœå±•é–‹äº†ï¼Œå°±æ‹¿å…¨éƒ¨)
            // é€™è£¡æˆ‘å€‘ç”¨ä¸€å€‹ç°¡å–®çš„è®Šæ•¸ä¾†æ§åˆ¶ä»‹é¢ï¼Œä¸éœ€è¦å…¨åŸŸè®Šæ•¸ï¼Œç›´æ¥æ“ä½œ DOM
            const tagsToShow = allTags.slice(0, DISPLAY_LIMIT);
            const hiddenTags = allTags.slice(DISPLAY_LIMIT);

            // 3. æ¸²æŸ“å‰ 6 å€‹æ¨™ç±¤
            tagsToShow.forEach(tag => createTagButton(tag, tagCounts[tag], container));

            // 4. å¦‚æœæœ‰æ›´å¤šæ¨™ç±¤ï¼Œå»ºç«‹ã€Œæ”¶ç´å€ã€èˆ‡ã€Œæ›´å¤šæŒ‰éˆ•ã€
            if (hasMore) {
                // å»ºç«‹ä¸€å€‹éš±è—çš„å®¹å™¨æ”¾å‰©ä¸‹çš„æ¨™ç±¤
                const hiddenContainer = document.createElement('span');
                hiddenContainer.className = 'hidden flex flex-wrap gap-2 items-center'; // ä½¿ç”¨ flex æ’åˆ—
                hiddenContainer.id = 'more-tags-container';
                
                hiddenTags.forEach(tag => createTagButton(tag, tagCounts[tag], hiddenContainer));
                container.appendChild(hiddenContainer);

                // å»ºç«‹ã€Œæ›´å¤š/æ”¶èµ·ã€åˆ‡æ›æŒ‰éˆ•
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'text-xs text-pink-400 hover:text-pink-300 underline ml-1 font-bold';
                toggleBtn.textContent = `â–¼ æ›´å¤š (${hiddenTags.length})`;
                
                toggleBtn.onclick = () => {
                    const isHidden = hiddenContainer.classList.contains('hidden');
                    if (isHidden) {
                        hiddenContainer.classList.remove('hidden');
                        toggleBtn.textContent = 'â–² æ”¶èµ·';
                    } else {
                        hiddenContainer.classList.add('hidden');
                        toggleBtn.textContent = `â–¼ æ›´å¤š (${hiddenTags.length})`;
                    }
                };
                container.appendChild(toggleBtn);
            }
        }

        // è¼”åŠ©å‡½å¼ï¼šå»ºç«‹æ¨™ç±¤æŒ‰éˆ•
        function createTagButton(tag, count, parent) {
            const btn = document.createElement('button');
            btn.className = 'filter-tag';
            btn.textContent = `#${tag} (${count})`;
            btn.dataset.tag = tag;
            btn.onclick = () => {
                document.querySelectorAll('.filter-tag').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                activeTag = tag;
                renderGrid();
            };
            parent.appendChild(btn);
        }

        // è¼”åŠ©å‡½å¼ï¼šå»ºç«‹æ¨™ç±¤æŒ‰éˆ•
        function createTagButton(tag, count, parent) {
            const btn = document.createElement('button');
            btn.className = 'filter-tag';
            btn.textContent = `#${tag} (${count})`;
            btn.dataset.tag = tag;
            btn.onclick = () => {
                document.querySelectorAll('.filter-tag').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                activeTag = tag;
                renderGrid();
            };
            parent.appendChild(btn);
        }

        // â˜… æ–°å¢ï¼šå–å¾—æ’åºå¾Œçš„ç†±é–€æ¨™ç±¤åˆ—è¡¨
        function getSortedGlobalTags() {
            const tagCounts = {};
            allPostcards.forEach(p => {
                if (p.tags) p.tags.forEach(t => {
                    const cleanTag = t.trim();
                    if(cleanTag) tagCounts[cleanTag] = (tagCounts[cleanTag] || 0) + 1;
                });
            });
            return Object.keys(tagCounts).sort((a, b) => tagCounts[b] - tagCounts[a]);
        }

        // â˜… æ–°å¢ï¼šåˆå§‹åŒ–å–®å€‹ä¸‹æ‹‰é¸å–®çš„é‚è¼¯
        function setupTagDropdown(inputId, dropdownId, otherInputIds) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            
            // æ¸²æŸ“é¸å–®å…§å®¹ (å«éæ¿¾é‚è¼¯)
            const renderOptions = (filterText = '') => {
                const allTags = getSortedGlobalTags();
                
                // 1. å–å¾—ã€Œå…¶ä»–è¼¸å…¥æ¡†ã€ç›®å‰çš„å€¼ (åšæˆæ’é™¤æ¸…å–®)
                const excludedValues = otherInputIds.map(id => document.getElementById(id).value.trim()).filter(v => v);
                
                // 2. éæ¿¾ï¼š(ç¬¦åˆæœå°‹æ–‡å­—) AND (ä¸åœ¨æ’é™¤æ¸…å–®ä¸­)
                const filteredTags = allTags.filter(tag => {
                    const matchText = tag.toLowerCase().includes(filterText.toLowerCase());
                    const notExcluded = !excludedValues.includes(tag);
                    return matchText && notExcluded;
                });

                dropdown.innerHTML = '';
                if (filteredTags.length === 0) {
                    dropdown.innerHTML = '<div class="dropdown-option text-gray-500 cursor-default">ç„¡ç¬¦åˆæ¨™ç±¤</div>';
                } else {
                    filteredTags.forEach(tag => {
                        const div = document.createElement('div');
                        div.className = 'dropdown-option';
                        div.textContent = tag;
                        div.onclick = () => {
                            input.value = tag;
                            dropdown.classList.remove('show');
                        };
                        dropdown.appendChild(div);
                    });
                }
            };

            // äº‹ä»¶ç›£è½
            input.onfocus = () => {
                renderOptions(input.value);
                dropdown.classList.add('show');
            };
            
            input.oninput = () => {
                renderOptions(input.value);
                dropdown.classList.add('show');
            };

            // é»æ“Šå¤–éƒ¨é—œé–‰
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        }

        // â˜… æ–°å¢ï¼šä¸€æ¬¡åˆå§‹åŒ–æ‰€æœ‰ä¸‰å€‹è¼¸å…¥æ¡†
        function initTagDropdowns() {
            setupTagDropdown('tag-1', 'dropdown-1', ['tag-2', 'tag-3']);
            setupTagDropdown('tag-2', 'dropdown-2', ['tag-1', 'tag-3']);
            setupTagDropdown('tag-3', 'dropdown-3', ['tag-1', 'tag-2']);
        }

        function renderGrid() {
            const grid = document.getElementById('postcard-grid');
            const filtered = activeTag === 'all' 
                ? allPostcards 
                : allPostcards.filter(p => p.tags && p.tags.includes(activeTag));

            if (filtered.length === 0) {
                grid.innerHTML = '<p class="col-span-full text-center py-12 text-gray-500 text-lg">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç¾ç‰‡ã€‚</p>';
                return;
            }

            grid.innerHTML = filtered.map(p => {
                const cleanName = (p.uploader_nickname || '').trim().replace(/[\s\uFEFF\xA0]*\d{12}$/, '');
                const tagsHtml = (p.tags || []).map(t => `<span class="text-[10px] bg-gray-700 text-gray-300 px-2 py-0.5 rounded-full mr-1 mb-1 inline-block border border-gray-600">#${t}</span>`).join('');
                
                const canEdit = (p.uploader_id === currentUser.id) || (currentUser.role === 'ç®¡ç†è€…');
                const controlsHtml = canEdit ? `
                    <div class="absolute top-2 right-2 flex gap-1 bg-black/60 backdrop-blur-sm rounded-lg p-1 opacity-0 group-hover:opacity-100 transition duration-200">
                        <button onclick="editCard(${p.id}, event)" class="text-gray-300 hover:text-white p-1.5 hover:bg-gray-700 rounded" title="ç·¨è¼¯">âœï¸</button>
                        <button onclick="deleteCard(${p.id}, event)" class="text-red-400 hover:text-red-300 p-1.5 hover:bg-gray-700 rounded" title="åˆªé™¤">ğŸ—‘ï¸</button>
                    </div>
                ` : '';

                const heartClass = p.isLiked ? 'liked' : 'text-gray-500 hover:text-pink-400';
                const heartIcon = p.isLiked ? 'â¤ï¸' : 'ğŸ¤';

                return `
                    <div class="card-bg rounded-xl overflow-hidden relative group flex flex-col h-full">
                        <div class="aspect-video overflow-hidden bg-gray-900 cursor-pointer relative" onclick="viewImage('${p.image_url}')">
                            <img src="${p.image_url}" loading="lazy" class="w-full h-full object-cover transform group-hover:scale-110 transition duration-700 ease-in-out">
                            ${controlsHtml}
                        </div>
                        <div class="p-4 flex flex-col flex-grow justify-between">
                            <div>
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex items-center gap-1 overflow-hidden">
                                        <span class="text-xs text-gray-400 flex-shrink-0">By</span>
                                        <span class="font-bold text-gray-200 truncate" title="${cleanName}">${cleanName}</span>
                                    </div>
                                    <button onclick="toggleLike(${p.id}, this)" class="like-btn flex items-center gap-1.5 bg-gray-800/50 px-2 py-1 rounded-full ${heartClass}">
                                        <span class="text-base icon filter drop-shadow-md">${heartIcon}</span>
                                        <span class="text-xs font-bold count">${p.likes}</span>
                                    </button>
                                </div>
                                <div class="bg-gray-800/50 rounded-lg p-2 flex justify-between items-center mb-3 border border-gray-700 group-hover:border-gray-600 transition">
                                    <span class="text-xs font-mono text-gray-400 truncate select-all flex-1 mr-2">${p.coordinate || 'æœªçŸ¥åº§æ¨™'}</span>
                                    <button onclick="copyText('${p.coordinate}')" class="text-xs bg-gray-700 hover:bg-gray-600 text-green-400 px-2 py-1.5 rounded transition flex-shrink-0 font-bold flex items-center gap-1">ğŸ“‹ è¤‡è£½</button>
                                </div>
                            </div>
                            <div class="flex flex-wrap content-end">${tagsHtml}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- äº’å‹•åŠŸèƒ½ ---
        const modal = document.getElementById('postcard-modal');
        const form = document.getElementById('postcard-form');
        
        document.getElementById('add-postcard-btn').onclick = () => {
            form.reset();
            document.getElementById('edit-id').value = '';
            document.getElementById('modal-title').textContent = 'åˆ†äº«æ–°ç¾ç‰‡';
            
            // â˜… ä¿®æ”¹ï¼šé‚„åŸ label æ–‡å­—
            const uploadSection = document.getElementById('image-upload-section');
            uploadSection.classList.remove('hidden');
            uploadSection.querySelector('label').textContent = 'ä¸Šå‚³åœ–ç‰‡';
            
            document.getElementById('preview-image').src = '';
            document.getElementById('preview-section').classList.add('hidden');
            document.getElementById('submit-btn').textContent = 'ç™¼å¸ƒ';
            modal.classList.remove('hidden');
        };
        
        const closeModal = () => modal.classList.add('hidden');
        document.getElementById('close-modal-btn').onclick = closeModal;
        document.getElementById('close-modal-x').onclick = closeModal;
        
        document.getElementById('paste-coord-btn').onclick = async () => {
            try {
                const text = await navigator.clipboard.readText();
                if(text) document.getElementById('coordinate-input').value = text;
                else showToast('å‰ªè²¼ç°¿æ˜¯ç©ºçš„', true);
            } catch(e) { showToast('ç„¡æ³•è®€å–å‰ªè²¼ç°¿ï¼Œè«‹æ‰‹å‹•è²¼ä¸Š', true); }
        };

        // ä¿®æ”¹ postcard.html ä¸­çš„ form.onsubmit éƒ¨åˆ†

        form.onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.disabled = true; 
            const originalText = btn.textContent;
            btn.textContent = 'è™•ç†ä¸­...';

            let uploadedFileName = null; // ç”¨æ–¼å›æ»¾

            try {
                const editId = document.getElementById('edit-id').value;
                const coords = document.getElementById('coordinate-input').value.trim();
                const t1 = document.getElementById('tag-1').value.trim();
                const t2 = document.getElementById('tag-2').value.trim();
                const t3 = document.getElementById('tag-3').value.trim();
                const tags = [t1, t2, t3].filter(t => t.length > 0);

                let imageUrl = null;
                const fileInput = document.getElementById('image-upload');

                // â˜… åˆ¤æ–·æ˜¯å¦éœ€è¦ä¸Šå‚³åœ–ç‰‡
                // æƒ…æ³A: æ–°å¢æ¨¡å¼ (å¿…é ˆä¸Šå‚³)
                // æƒ…æ³B: ç·¨è¼¯æ¨¡å¼ ä¸” ä½¿ç”¨è€…æœ‰é¸æ–°æª”æ¡ˆ (é¸æ“‡æ€§ä¸Šå‚³)
                // åŠ å…¥å£“ç¸®é‚è¼¯
                if (!editId || (editId && fileInput.files.length > 0)) {
                    if (fileInput.files.length === 0) throw new Error('è«‹é¸æ“‡åœ–ç‰‡');

                    // 1. å–å¾—åŸå§‹æª”æ¡ˆ
                    const originalFile = fileInput.files[0];
                    
                    // 2. åŸ·è¡Œå£“ç¸® (é¡¯ç¤º Toast è®“ä½¿ç”¨è€…çŸ¥é“æ­£åœ¨è™•ç†)
                    showToast('æ­£åœ¨å£“ç¸®åœ–ç‰‡...', false);
                    const compressedFile = await compressImage(originalFile);
                    
                    // (é™¤éŒ¯ç”¨) æ‚¨å¯ä»¥åœ¨ Console çœ‹åˆ°å£“ç¸®å‰å¾Œçš„å¤§å°å·®ç•°
                    console.log(`å£“ç¸®å‰: ${(originalFile.size/1024/1024).toFixed(2)}MB, å£“ç¸®å¾Œ: ${(compressedFile.size/1024/1024).toFixed(2)}MB`);

                    // 3. ä½¿ç”¨ã€Œå£“ç¸®å¾Œçš„æª”æ¡ˆã€ç”¢ç”Ÿæª”åä¸¦ä¸Šå‚³
                    // æ³¨æ„ï¼šé€™é‚Šæ”¹ç”¨ compressedFile ä¾†è™•ç†
                    uploadedFileName = `${Date.now()}_${Math.floor(Math.random()*1000)}.jpg`; // çµ±ä¸€å­˜ç‚º jpg
                    
                    const { error: upErr } = await supabaseClient.storage.from('postcard-images').upload(uploadedFileName, compressedFile);
                    
                    if (upErr) {
                        uploadedFileName = null;
                        throw upErr;
                    }
                    
                    const { data: publicData } = supabaseClient.storage.from('postcard-images').getPublicUrl(uploadedFileName);
                    imageUrl = publicData.publicUrl;
                }

                if (!editId) {
                    // === æ–°å¢æ¨¡å¼ ===
                    const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                        body: { 
                            action: 'add-postcard', 
                            payload: { 
                                uploaderId: currentUser.id, 
                                uploaderNickname: currentUser.nickname,
                                coordinate: coords, 
                                imageUrl: imageUrl, 
                                tags: tags 
                            } 
                        }
                    });
                    if (error) throw error;
                    if (data && data.error) throw new Error(data.error);
                    showToast('ç™¼å¸ƒæˆåŠŸï¼', false);

                } else {
                    // === ç·¨è¼¯æ¨¡å¼ ===
                    // å¦‚æœ imageUrl æœ‰å€¼ï¼Œä»£è¡¨æœ‰æ›åœ–ï¼›å¦‚æœæ˜¯ nullï¼Œä»£è¡¨æ²’æ›åœ– (å¾Œç«¯æœƒå¿½ç•¥æ›´æ–°)
                    const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                        body: { 
                            action: 'edit-postcard', 
                            payload: { 
                                postcardId: editId, 
                                coordinate: coords, 
                                tags: tags,
                                imageUrl: imageUrl // å‚³å…¥æ–°åœ–ç‰‡ç¶²å€ (æˆ– null)
                            } 
                        }
                    });
                    
                    if (error) throw error;
                    if (data && data.error) throw new Error(data.error);
                    showToast('æ›´æ–°æˆåŠŸï¼', false);
                }

                modal.classList.add('hidden');
                loadPostcards();

            } catch (e) {
                console.error(e);
                
                // â˜… å›æ»¾æ©Ÿåˆ¶ï¼šå¦‚æœå‰›å‰›æœ‰ä¸Šå‚³æ–°åœ–ä½†å¤±æ•—äº†ï¼ŒæŠŠæ–°åœ–åˆªæ‰
                if (uploadedFileName) {
                    await supabaseClient.storage.from('postcard-images').remove([uploadedFileName]);
                }

                let msg = e.message;
                if (msg === 'Edge Function returned a non-2xx status code') {
                    msg = 'å¾Œç«¯é€£ç·šéŒ¯èª¤ (è«‹ç¢ºèª index.ts å·²é‡æ–°éƒ¨ç½²)';
                }
                showToast(`æ“ä½œå¤±æ•—: ${msg}`, true);
            } finally {
                btn.disabled = false; btn.textContent = originalText;
            }
        };

        window.deleteCard = async (id, event) => {
            event.stopPropagation();
            if (!confirm('ã€è­¦å‘Šã€‘ç¢ºå®šè¦åˆªé™¤é€™å¼µç¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
            try {
                const { error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: { action: 'delete-postcard', payload: { postcardId: id } }
                });
                if (error) throw error;
                showToast('å·²åˆªé™¤ç¾ç‰‡', false);
                loadPostcards();
            } catch (e) { showToast('åˆªé™¤å¤±æ•—', true); console.error(e); }
        };

        window.editCard = (id, event) => {
            event.stopPropagation();
            const card = allPostcards.find(p => p.id === id);
            if (!card) return;
            
            document.getElementById('edit-id').value = id;
            document.getElementById('modal-title').textContent = 'ç·¨è¼¯ç¾ç‰‡è³‡è¨Š';
            document.getElementById('coordinate-input').value = card.coordinate || '';
            
            // å¡«å…¥èˆŠæ¨™ç±¤
            const oldTags = card.tags || [];
            document.getElementById('tag-1').value = oldTags[0] || '';
            document.getElementById('tag-2').value = oldTags[1] || '';
            document.getElementById('tag-3').value = oldTags[2] || '';
            
            // â˜… ä¿®æ”¹ï¼šç·¨è¼¯æ¨¡å¼ä¹Ÿè¦é¡¯ç¤ºä¸Šå‚³å€å¡Šï¼Œä½†ä¿®æ”¹æ–‡å­—æç¤º
            const uploadSection = document.getElementById('image-upload-section');
            uploadSection.classList.remove('hidden');
            // æ”¹è®Š label æ–‡å­—æé†’ä½¿ç”¨è€…
            uploadSection.querySelector('label').textContent = 'æ›´æ›åœ–ç‰‡ (è‹¥ä¸ä¿®æ”¹è«‹ç•™ç©º)';
            // æ¸…ç©º file input é˜²æ­¢èª¤å‚³
            document.getElementById('image-upload').value = '';

            // é¡¯ç¤ºç›®å‰çš„åœ–ç‰‡é è¦½
            const preview = document.getElementById('preview-image');
            preview.src = card.image_url;
            document.getElementById('preview-section').classList.remove('hidden');
            
            document.getElementById('submit-btn').textContent = 'å„²å­˜è®Šæ›´';
            modal.classList.remove('hidden');
        };

        window.toggleLike = async (id, btn) => {
            const card = allPostcards.find(p => p.id === id);
            if (!card) return;
            const iconSpan = btn.querySelector('.icon');
            const countSpan = btn.querySelector('.count');
            const wasLiked = card.isLiked;

            card.isLiked = !wasLiked;
            card.likes += (wasLiked ? -1 : 1);
            
            iconSpan.textContent = card.isLiked ? 'â¤ï¸' : 'ğŸ¤';
            countSpan.textContent = card.likes;
            btn.className = `like-btn flex items-center gap-1.5 bg-gray-800/50 px-2 py-1 rounded-full ${card.isLiked ? 'liked' : 'text-gray-500 hover:text-pink-400'}`;

            try {
                const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: { action: 'toggle-postcard-like', payload: { postcardId: id } }
                });
                if (error) throw error;
                if (data.data) {
                    card.likes = data.data.likes;
                    countSpan.textContent = card.likes;
                }
            } catch (e) {
                card.isLiked = wasLiked;
                card.likes += (wasLiked ? 1 : -1);
                iconSpan.textContent = card.isLiked ? 'â¤ï¸' : 'ğŸ¤';
                countSpan.textContent = card.likes;
                console.error('Like failed', e);
            }
        };

        // â˜… ä¿®æ”¹ï¼šé–‹å•Ÿåœ–ç‰‡æª¢è¦–å™¨ (ä¸å†å¦é–‹è¦–çª—)
        window.viewImage = function(url) {
            const modal = document.getElementById('image-viewer-modal');
            const img = document.getElementById('viewer-image');
            
            if(modal && img) {
                img.src = url;
                modal.classList.remove('hidden');
                // ç¦æ­¢èƒŒæ™¯æ²å‹•
                document.body.style.overflow = 'hidden';
            }
        };

        // â˜… æ–°å¢ï¼šé—œé–‰åœ–ç‰‡æª¢è¦–å™¨
        window.closeImageViewer = function() {
            const modal = document.getElementById('image-viewer-modal');
            const img = document.getElementById('viewer-image');
            
            if(modal) {
                modal.classList.add('hidden');
                // æ¢å¾©èƒŒæ™¯æ²å‹•
                document.body.style.overflow = '';
                // å»¶é²æ¸…ç©ºåœ–ç‰‡ï¼Œé¿å…é–ƒçˆ
                setTimeout(() => { if(img) img.src = ''; }, 300);
            }
        };

        // ç¶å®š ESC éµé—œé–‰è¦–çª—
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('image-viewer-modal');
                if (modal && !modal.classList.contains('hidden')) {
                    window.closeImageViewer();
                }
            }
        });

        // â˜… è£œå›éºå¤±çš„ Toast è¨Šæ¯é¡¯ç¤ºå‡½å¼
        function showToast(msg, isErr) {
            const el = document.getElementById('toast-message');
            // è¨­å®šåœ–ç¤ºèˆ‡æ–‡å­—
            el.innerHTML = `${isErr ? 'âŒ' : 'âœ…'} ${msg}`;
            
            // è¨­å®šé¡è‰²èˆ‡æ¨£å¼
            el.className = `fixed top-5 right-5 text-white py-3 px-6 rounded-xl shadow-2xl z-[70] font-bold flex items-center gap-2 transform transition-all duration-300 ${isErr ? 'bg-red-600/95' : 'bg-green-600/95'} translate-y-0`;
            
            // é¡¯ç¤º
            el.classList.remove('hidden');
            
            // 3ç§’å¾Œè‡ªå‹•æ¶ˆå¤±å‹•ç•«
            setTimeout(() => {
                el.classList.add('translate-y-[-20px]', 'opacity-0');
                setTimeout(() => {
                    el.classList.add('hidden');
                    el.classList.remove('translate-y-[-20px]', 'opacity-0');
                }, 300);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>