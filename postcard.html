<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾ç‰‡åœ–æ›¸é¤¨ - è‡è‡å®…é…ç¶²</title>
    <link rel="icon" href="./mashroom_s.png" type="image/png">
    <link rel="apple-touch-icon" href="./mashroom_s.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #111827; color: #d1d5db; }
        .dark-input { background-color: #374151; border-color: #4b5563; color: #d1d5db; }
        .dark-input:focus { border-color: #ec4899; --tw-ring-color: #ec4899; outline: none; ring: 2px; } 
        .card-bg { background-color: #1f2937; border: 1px solid #374151; transition: all 0.3s; }
        .card-bg:hover { border-color: #ec4899; transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }
        .filter-tag { cursor: pointer; transition: all 0.2s; border-radius: 9999px; padding: 4px 12px; font-size: 0.85rem; border: 1px solid #4b5563; background-color: #374151; color: #d1d5db; }
        .filter-tag:hover, .filter-tag.active { background-color: #ec4899; color: white; border-color: #ec4899; }
        .like-btn { cursor: pointer; transition: transform 0.2s; user-select: none; }
        .like-btn:active { transform: scale(1.2); }
        .like-btn.liked { color: #f43f5e; } /* Rose-500 */
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.8); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* === è‡ªè¨‚ä¸‹æ‹‰é¸å–®æ¨£å¼ (ä»¿ç™»å…¥é é¢¨æ ¼) === */
        .custom-dropdown-container {
            position: relative;
            width: 100%;
        }
        .dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background-color: #374151; /* æ·±ç°èƒŒæ™¯ */
            border: 1px solid #4b5563;
            border-radius: 0.5rem; /* rounded-lg */
            max-height: 200px;      /* é™åˆ¶é«˜åº¦ */
            overflow-y: auto;       /* è¶…å‡ºæ²å‹• */
            z-index: 60;            /* ç¢ºä¿è“‹åœ¨å…¶ä»–å…ƒç´ ä¸Š */
            display: none;          /* é è¨­éš±è— */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        .dropdown-options.show {
            display: block;
        }
        .dropdown-option {
            padding: 10px 12px;
            color: #d1d5db;
            cursor: pointer;
            transition: background-color 0.1s;
            font-size: 0.875rem; /* text-sm */
            border-bottom: 1px solid #4b5563;
            text-align: left;
        }
        .dropdown-option:last-child {
            border-bottom: none;
        }
        .dropdown-option:hover {
            background-color: #ec4899; /* Pink-500 */
            color: white;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">
    
    <div class="max-w-7xl mx-auto">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4 border-b border-gray-700 pb-6">
            <h1 class="text-3xl font-bold flex items-center gap-2 cursor-pointer" onclick="window.location.reload()">
                <span>ğŸ–¼ï¸</span> 
                
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-rose-400">
                    ç¾ç‰‡åœ–æ›¸é¤¨
                </span>
            </h1>
            
            <div class="flex items-center gap-4">
                <button id="add-postcard-btn" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition flex items-center gap-2 transform hover:scale-105">
                    <span>â•</span> åˆ†äº«ç¾ç‰‡
                </button>
                 <a href="javascript:history.back()" class="text-gray-400 hover:text-white transition cursor-pointer">â† è¿”å›</a>
            </div>

            <div id="user-display" class="w-full md:w-auto text-center md:text-right text-xs text-gray-500 font-mono"></div>
        </header>

        <div class="mb-8">
            <div class="flex items-center gap-2 mb-2">
                <span class="text-gray-400 text-sm">ğŸ·ï¸ ç†±é–€æ¨™ç±¤ï¼š</span>
            </div>
            <div id="filter-container" class="flex flex-wrap gap-2 items-center">
                <button class="filter-tag active" data-tag="all">å…¨éƒ¨é¡¯ç¤º</button>
                </div>
        </div>

        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 grid grid-cols-3 gap-2 text-sm mb-6">
            <div>
                <label class="text-xs text-gray-500 block mb-1">åœ‹å®¶</label>
                <select id="filter-country" class="dark-input w-full p-2 rounded text-xs"><option value="all">å…¨éƒ¨</option></select>
            </div>
            <div>
                <label class="text-xs text-gray-500 block mb-1">åœ°å€</label>
                <select id="filter-region" class="dark-input w-full p-2 rounded text-xs"><option value="all">å…¨éƒ¨</option></select>
            </div>
            <div>
                <label class="text-xs text-gray-500 block mb-1">ç´°é …</label>
                <select id="filter-area" class="dark-input w-full p-2 rounded text-xs"><option value="all">å…¨éƒ¨</option></select>
            </div>
        </div>

        <div id="postcard-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <p class="col-span-full text-center py-12 text-gray-500 animate-pulse">æ­£åœ¨å¾è³‡æ–™åº«è®€å–ç¾ç‰‡...</p>
        </div>

        <div id="pagination-controls" class="flex justify-center items-center gap-3 mt-8 mb-12 hidden">
            <button onclick="changePage(-1)" id="prev-page-btn" class="flex items-center justify-center w-10 h-10 bg-gray-800 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 disabled:opacity-30 disabled:cursor-not-allowed transition">
                â—€
            </button>
            
            <div class="flex items-center bg-gray-800 border border-gray-600 rounded-lg px-3 py-1">
                <span class="text-sm text-gray-400 mr-2">Page</span>
                <input type="number" id="page-input" value="1" min="1" 
                    class="w-12 bg-gray-900 border border-gray-700 rounded text-center text-white text-sm focus:ring-2 focus:ring-pink-500 outline-none py-1 transition"
                    onchange="jumpToPage(this.value)" 
                    onkeydown="if(event.key==='Enter') jumpToPage(this.value)">
                <span id="total-pages-text" class="text-sm text-gray-400 ml-2 font-mono">/ 1</span>
            </div>

            <button onclick="changePage(1)" id="next-page-btn" class="flex items-center justify-center w-10 h-10 bg-gray-800 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 disabled:opacity-30 disabled:cursor-not-allowed transition">
                â–¶
            </button>
        </div>
    </div>

    <div id="postcard-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-gray-800 border border-gray-600 w-full max-w-md rounded-2xl shadow-2xl p-6 relative max-h-[90vh] overflow-y-auto">
            <button id="close-modal-x" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">&times;</button>
            <h2 id="modal-title" class="text-2xl font-bold text-white mb-6">åˆ†äº«æ–°ç¾ç‰‡</h2>
            
            <form id="postcard-form" class="space-y-4">
                <input type="hidden" id="edit-id">
                
                <div id="image-upload-section">
                    <label class="block text-sm font-medium text-gray-400 mb-1">ä¸Šå‚³åœ–ç‰‡</label>
                    <input type="file" id="image-upload" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-600 file:text-white hover:file:bg-pink-700 transition cursor-pointer"/>
                </div>

                <div id="preview-section" class="hidden text-center">
                    <p class="text-sm text-gray-400 mb-1 text-left">åœ–ç‰‡é è¦½</p>
                    <img id="preview-image" src="" class="rounded-lg max-h-32 md:max-h-48 mx-auto object-contain border border-gray-600 shadow-md">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">åº§æ¨™ (ç·¯åº¦, ç¶“åº¦)</label>
                    <div class="relative">
                        <input type="text" id="coordinate-input" required placeholder="ä¾‹å¦‚: 22.6123, 120.3456 (æ”¯æ´ Google Maps ç¶²å€)" class="dark-input w-full rounded-lg shadow-sm pl-3 pr-16 py-2.5">
                        
                        <button type="button" id="paste-coord-btn" 
                            class="absolute right-2 top-2 bg-gray-700 hover:bg-gray-600 text-green-400 px-2 py-1.5 rounded transition font-bold flex items-center gap-1 text-xs" 
                            title="è²¼ä¸Šå‰ªè²¼ç°¿å…§å®¹">
                            ğŸ“‹ è²¼ä¸Š
                        </button>
                    </div>
                    <p class="text-[12px] text-white font-bold mt-1">è«‹åˆ©ç”¨å³å´ã€Œè²¼ä¸Šã€æŒ‰éˆ•ï¼Œæ”¯æ´Google Mapç¶²å€è½‰åº§æ¨™ï¼Œä¸¦è‡ªå‹•å¸¶å…¥åœ°é»è³‡è¨Šã€‚</p>
                </div>

                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">åœ‹å®¶</label>
                        <div class="custom-dropdown-container">
                            <input type="text" id="input-country" class="dark-input w-full rounded-lg px-2 py-2 text-sm" placeholder="è¼¸å…¥æˆ–é¸æ“‡">
                            <div id="dropdown-country" class="dropdown-options text-left"></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">åœ°å€</label>
                        <div class="custom-dropdown-container">
                            <input type="text" id="input-region" class="dark-input w-full rounded-lg px-2 py-2 text-sm" placeholder="è¼¸å…¥æˆ–é¸æ“‡">
                            <div id="dropdown-region" class="dropdown-options text-left"></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">ç´°é …</label>
                        <div class="custom-dropdown-container">
                            <input type="text" id="input-area" class="dark-input w-full rounded-lg px-2 py-2 text-sm" placeholder="è¼¸å…¥æˆ–é¸æ“‡">
                            <div id="dropdown-area" class="dropdown-options text-left"></div>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1">åˆ†é¡æ¨™ç±¤ (æœ€å¤š3å€‹)</label>
                    <div class="grid grid-cols-3 gap-2">
                        
                        <div class="custom-dropdown-container">
                            <input type="text" id="tag-1" placeholder="æ¨™ç±¤1" maxlength="10" class="dark-input w-full rounded-lg shadow-sm px-2 py-2.5 text-center text-sm" autocomplete="off">
                            <div id="dropdown-1" class="dropdown-options text-left"></div>
                        </div>

                        <div class="custom-dropdown-container">
                            <input type="text" id="tag-2" placeholder="æ¨™ç±¤2" maxlength="10" class="dark-input w-full rounded-lg shadow-sm px-2 py-2.5 text-center text-sm" autocomplete="off">
                            <div id="dropdown-2" class="dropdown-options text-left"></div>
                        </div>

                        <div class="custom-dropdown-container">
                            <input type="text" id="tag-3" placeholder="æ¨™ç±¤3" maxlength="10" class="dark-input w-full rounded-lg shadow-sm px-2 py-2.5 text-center text-sm" autocomplete="off">
                            <div id="dropdown-3" class="dropdown-options text-left"></div>
                        </div>

                    </div>
                    <p class="text-xs text-gray-500 mt-1">ç„¡éœ€è¼¸å…¥ # è™Ÿï¼Œé»æ“Šå¯é¸æ“‡ç†±é–€æ¨™ç±¤ (å·²é¸éçš„æœƒè‡ªå‹•éæ¿¾)ã€‚</p>
                </div>

                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-700 pb-2">
                    <button type="button" id="close-modal-btn" class="px-5 py-2.5 bg-gray-600 text-gray-200 rounded-lg hover:bg-gray-500 font-bold transition">å–æ¶ˆ</button>
                    <button type="submit" id="submit-btn" class="px-5 py-2.5 bg-pink-600 text-white rounded-lg hover:bg-pink-700 disabled:opacity-50 disabled:cursor-not-allowed font-bold transition shadow-lg">ç™¼å¸ƒ</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-message" class="hidden fixed top-5 right-5 text-white py-3 px-6 rounded-xl shadow-2xl z-50 font-bold flex items-center gap-2 transform transition-all duration-300 translate-y-0"></div>

    <div id="image-viewer-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm transition-opacity duration-300" onclick="closeImageViewer()">
        <div class="relative max-w-5xl w-full max-h-[95vh] flex justify-center items-center p-2" onclick="event.stopPropagation()">
            <button type="button" onclick="closeImageViewer()" class="absolute -top-12 right-0 md:top-4 md:right-4 text-white text-4xl hover:text-gray-300 font-bold bg-black/50 hover:bg-black/70 rounded-full w-12 h-12 flex items-center justify-center transition z-50">&times;</button>
            
            <img id="viewer-image" src="" alt="ç¾ç‰‡å¤§åœ–" class="rounded-lg shadow-2xl max-h-[85vh] md:max-h-[90vh] w-auto object-contain bg-gray-900 border border-gray-800">
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // === Cloudflare CDN è¨­å®š ===
        const CDN_HOST = 'https://pikmin-cdn.secretsoulful.workers.dev'; // è«‹ç¢ºèªé€™ä¸²ç¶²å€è·Ÿæ‚¨å‰›å‰›è²¼çš„ä¸€æ¨£

        function getCdnUrl(url) {
            if (!url) return '';
            if (url.includes('htdddmoclmhqebyvzean.supabase.co')) {
                return url.replace('https://htdddmoclmhqebyvzean.supabase.co', CDN_HOST);
            }
            return url;
        }

        // --- å…¨åŸŸè®Šæ•¸ ---
        let currentUser = null;
        let allPostcards = [];
        let activeTag = 'all';
        // åœ°é»è³‡æ–™é›†åˆ (ç”¨æ–¼ç¯©é¸èˆ‡è‡ªå‹•å®Œæˆ)
        let uniqueCountries = new Set(), uniqueRegions = new Set(), uniqueAreas = new Set();

        let currentPage = 1;
        const itemsPerPage = 24; // æ¯é  24 å¼µ

        // --- æ ¸å¿ƒå·¥å…·ï¼šåœ–ç‰‡å£“ç¸® ---
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                new Compressor(file, {
                    quality: 0.6, maxWidth: 1600, maxHeight: 1600, mimeType: 'image/jpeg',
                    success(result) { resolve(new File([result], file.name, { type: 'image/jpeg', lastModified: Date.now() })); },
                    error(err) { reject(err); },
                });
            });
        }

        // --- åˆå§‹åŒ– ---
        async function init() {
            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                alert('è«‹å…ˆç™»å…¥æ‰èƒ½ä½¿ç”¨ç¾ç‰‡åœ–æ›¸é¤¨');
                window.location.replace('./index.html');
                return;
            }
            
            // å–å¾—ä½¿ç”¨è€…è³‡æ–™
            const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
            currentUser = { ...session.user, ...profile };

            // è¼‰å…¥è³‡æ–™ä¸¦åˆå§‹åŒ–ä»‹é¢
            loadPostcards();
            initDropdowns(); 
            
            // ç¶å®šå…¨åŸŸé»æ“Šäº‹ä»¶ (ç”¨æ–¼é—œé–‰ä¸‹æ‹‰é¸å–®)
            document.addEventListener('click', (e) => {
                document.querySelectorAll('.custom-dropdown-container').forEach(container => {
                    const input = container.querySelector('input');
                    const dd = container.querySelector('.dropdown-options');
                    if (input && dd && !container.contains(e.target)) {
                        dd.classList.remove('show');
                    }
                });
            });
        }

        // --- è®€å–è³‡æ–™ ---
        async function loadPostcards() {
            const grid = document.getElementById('postcard-grid');
            try {
                const { data, error } = await supabaseClient
                    .from('postcards')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                allPostcards = data;

                // å–å¾—æŒ‰è®šç‹€æ…‹
                const { data: likes } = await supabaseClient
                    .from('postcard_likes')
                    .select('postcard_id')
                    .eq('user_id', currentUser.id);
                
                const likedSet = new Set(likes ? likes.map(l => l.postcard_id) : []);
                allPostcards.forEach(p => { p.isLiked = likedSet.has(p.id); });
                
                updateFilters(); // æ›´æ–°ç¯©é¸å™¨ (å«æ¨™ç±¤èˆ‡åœ°é»)
                renderGrid();
            } catch (e) {
                console.error(e);
                grid.innerHTML = '<p class="col-span-full text-center text-red-400">ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
            }
        }

        // --- ç¯©é¸å™¨é‚è¼¯ (æ•´åˆæ¨™ç±¤ + åœ°é») ---
        function updateFilters() {
            // 1. æ¨™ç±¤çµ±è¨ˆ
            const tagCounts = {};
            allPostcards.forEach(p => {
                if (!p.is_obsolete && p.tags) p.tags.forEach(t => {
                    const clean = t.trim();
                    if(clean) tagCounts[clean] = (tagCounts[clean] || 0) + 1;
                });
            });
            const sortedTags = Object.keys(tagCounts).sort((a, b) => tagCounts[b] - tagCounts[a]);

            const container = document.getElementById('filter-container');
            container.innerHTML = ''; 

            // æŒ‰éˆ•ï¼šå…¨éƒ¨é¡¯ç¤º
            const allBtn = document.createElement('button');
            allBtn.className = `filter-tag ${activeTag==='all'?'active':''}`;
            allBtn.textContent = `å…¨éƒ¨é¡¯ç¤º (${allPostcards.length})`;
            allBtn.onclick = () => setTag('all');
            container.appendChild(allBtn);

            // æŒ‰éˆ•ï¼šçµ•ç‰ˆå€
            const obsoleteBtn = document.createElement('button');
            obsoleteBtn.className = `filter-tag ${activeTag==='obsolete'?'active':''} text-red-400 border-red-900/50 hover:bg-red-900/30`;
            if(activeTag === 'obsolete') obsoleteBtn.classList.add('bg-red-900/50');
            obsoleteBtn.textContent = `ğŸš« çµ•ç‰ˆå€`;
            obsoleteBtn.onclick = () => setTag('obsolete');
            container.appendChild(obsoleteBtn);

            // æ¨™ç±¤é¡¯ç¤º (å‰6å€‹ + æ›´å¤š)
            const DISPLAY_LIMIT = 6;
            const tagsToShow = sortedTags.slice(0, DISPLAY_LIMIT);
            const hiddenTags = sortedTags.slice(DISPLAY_LIMIT);

            tagsToShow.forEach(tag => createTagButton(tag, tagCounts[tag], container));

            if (hiddenTags.length > 0) {
                const hiddenContainer = document.createElement('span');
                hiddenContainer.className = 'hidden flex flex-wrap gap-2 items-center';
                hiddenContainer.id = 'more-tags-container';
                hiddenTags.forEach(tag => createTagButton(tag, tagCounts[tag], hiddenContainer));
                container.appendChild(hiddenContainer);

                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'text-xs text-pink-400 hover:text-pink-300 underline ml-1 font-bold';
                toggleBtn.textContent = `â–¼ æ›´å¤š (${hiddenTags.length})`;
                toggleBtn.onclick = () => {
                    const isHidden = hiddenContainer.classList.contains('hidden');
                    hiddenContainer.classList.toggle('hidden');
                    toggleBtn.textContent = isHidden ? 'â–² æ”¶èµ·' : `â–¼ æ›´å¤š (${hiddenTags.length})`;
                };
                container.appendChild(toggleBtn);
            }

            // 2. åœ°é»ä¸‹æ‹‰é¸å–®è³‡æ–™æ”¶é›†
            uniqueCountries = new Set(); uniqueRegions = new Set(); uniqueAreas = new Set();
            allPostcards.forEach(p => {
                if (!p.is_obsolete) {
                    if(p.country) uniqueCountries.add(p.country);
                    if(p.region) uniqueRegions.add(p.region);
                    if(p.area) uniqueAreas.add(p.area);
                }
            });
            
            // å¡«å…¥ç¯©é¸å™¨ä¸‹æ‹‰é¸å–®
            fillSelect('filter-country', uniqueCountries, 'å…¨éƒ¨åœ‹å®¶');
            fillSelect('filter-region', uniqueRegions, 'å…¨éƒ¨åœ°å€');
            fillSelect('filter-area', uniqueAreas, 'å…¨éƒ¨ç´°é …');
            
            // æ›´æ–° Modal è¼¸å…¥æ¡†çš„è‡ªå‹•å®Œæˆ
            updateInputDropdowns();
        }

        function createTagButton(tag, count, parent) {
            const btn = document.createElement('button');
            btn.className = `filter-tag ${activeTag===tag?'active':''}`;
            btn.textContent = `#${tag} (${count})`;
            btn.onclick = () => setTag(tag);
            parent.appendChild(btn);
        }

        function fillSelect(id, set, defaultTxt) {
            const el = document.getElementById(id);
            if(!el) return;
            const oldVal = el.value;
            el.innerHTML = `<option value="all">${defaultTxt}</option>`;
            Array.from(set).sort().forEach(v => el.add(new Option(v, v)));
            if(set.has(oldVal)) el.value = oldVal;
            
            // åˆ‡æ›åœ°é»ç¯©é¸æ™‚é‡ç½®é ç¢¼
            el.onchange = () => {
                currentPage = 1;
                renderGrid();
            };
        }

        function setTag(tag) {
            activeTag = tag;
            currentPage = 1; // åˆ‡æ›æ¨™ç±¤æ™‚é‡ç½®é ç¢¼
            updateFilters();
            renderGrid();
        }

        // --- ç•«é¢æ¸²æŸ“ (Grid) â˜…â˜…â˜… é€™è£¡ä¿®æ­£äº†å¡ç‰‡é¡¯ç¤ºæ¨£å¼ ---
        function renderGrid() {
        const grid = document.getElementById('postcard-grid');
        const paginationControls = document.getElementById('pagination-controls');

        const cVal = document.getElementById('filter-country') ? document.getElementById('filter-country').value : 'all';
        const rVal = document.getElementById('filter-region') ? document.getElementById('filter-region').value : 'all';
        const aVal = document.getElementById('filter-area') ? document.getElementById('filter-area').value : 'all';
        
        // 1. ç¯©é¸
        const filtered = allPostcards.filter(p => {
            if (activeTag === 'obsolete') return p.is_obsolete === true;
            if (p.is_obsolete === true) return false;
            if (activeTag !== 'all' && (!p.tags || !p.tags.includes(activeTag))) return false;
            if (cVal !== 'all' && p.country !== cVal) return false;
            if (rVal !== 'all' && p.region !== rVal) return false;
            if (aVal !== 'all' && p.area !== aVal) return false;
            return true;
        });

        if (filtered.length === 0) {
            const msg = activeTag === 'obsolete' ? 'ç›®å‰æ²’æœ‰çµ•ç‰ˆçš„ç¾ç‰‡ã€‚' : 'ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç¾ç‰‡ã€‚';
            grid.innerHTML = `<p class="col-span-full text-center py-12 text-gray-500 text-lg">${msg}</p>`;
            paginationControls.classList.add('hidden');
            return;
        }

        // 2. â˜… åˆ†é è¨ˆç®—
        const totalPages = Math.ceil(filtered.length / itemsPerPage);
        if (currentPage > totalPages) currentPage = 1;

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedItems = filtered.slice(startIndex, endIndex);

        // 3. â˜… æ›´æ–° UI
        paginationControls.classList.remove('hidden');
        const pageInput = document.getElementById('page-input');
        const totalText = document.getElementById('total-pages-text');
        
        if (pageInput && totalText) {
            pageInput.value = currentPage; // æ›´æ–°è¼¸å…¥æ¡†æ•¸å­—
            pageInput.max = totalPages;    // è¨­å®šæœ€å¤§å€¼é˜²æ­¢äº‚è¼¸
            totalText.textContent = `/ ${totalPages}`; // æ›´æ–°ç¸½é æ•¸æ–‡å­—
        }
        document.getElementById('prev-page-btn').disabled = currentPage === 1;
        document.getElementById('next-page-btn').disabled = currentPage === totalPages;

        // 4. æ¸²æŸ“
        grid.innerHTML = paginatedItems.map(p => {
            const cleanName = (p.uploader_nickname || '').trim().replace(/[\s\uFEFF\xA0]*\d{12}$/, '');
            const tagsHtml = (p.tags || []).map(t => `<span class="text-[10px] bg-gray-700 text-gray-300 px-2 py-0.5 rounded-full mr-1 mb-1 inline-block border border-gray-600">#${t}</span>`).join('');
            
            const canEdit = (p.uploader_id === currentUser.id) || (currentUser.role === 'ç®¡ç†è€…');
            const controlsHtml = canEdit ? `
                <div class="absolute top-2 right-2 flex gap-1 bg-black/60 backdrop-blur-sm rounded-lg p-1 opacity-0 group-hover:opacity-100 transition duration-200 z-10">
                    <button onclick="editCard(${p.id}, event)" class="text-gray-300 hover:text-white p-1.5 hover:bg-gray-700 rounded" title="ç·¨è¼¯">âœï¸</button>
                    <button onclick="deleteCard(${p.id}, event)" class="text-red-400 hover:text-red-300 p-1.5 hover:bg-gray-700 rounded" title="åˆªé™¤">ğŸ—‘ï¸</button>
                </div>` : '';

            const heartClass = p.isLiked ? 'liked' : 'text-gray-500 hover:text-pink-400';
            const heartIcon = p.isLiked ? 'â¤ï¸' : 'ğŸ¤';
            const locationParts = [p.country, p.region, p.area].filter(Boolean);
            const fullLocation = locationParts.length > 0 ? locationParts.join(' Â· ') : null;
            const isObsoleteView = activeTag === 'obsolete';
            const obsBtnIcon = isObsoleteView ? 'âœ…ä¸Šæ¶' : 'ğŸš«'; 
            const obsBtnTitle = isObsoleteView ? 'æ¢å¾©ä¸Šæ¶' : 'å›å ±çµ•ç‰ˆ';
            const obsBtnClass = isObsoleteView ? 'text-green-500 hover:text-green-300' : 'text-gray-500 hover:text-red-500';

            return `
                <div class="card-bg rounded-xl overflow-hidden relative group flex flex-col h-full ${p.is_obsolete ? 'opacity-75 border-red-900/30' : ''}">
                    <div class="aspect-video overflow-hidden bg-gray-900 cursor-pointer relative" onclick="viewImage('${p.image_url}')">
                        <img src="${getCdnUrl(p.image_url)}" loading="lazy" class="w-full h-full object-cover transform group-hover:scale-110 transition duration-700 ease-in-out ${p.is_obsolete ? 'grayscale' : ''}">
                        ${controlsHtml}
                        ${p.is_obsolete ? '<div class="absolute inset-0 flex items-center justify-center pointer-events-none"><span class="bg-red-600/80 text-white px-3 py-1 rounded-full text-xs font-bold transform -rotate-12 border border-red-400">å·²çµ•ç‰ˆ</span></div>' : ''}
                    </div>
                    <div class="p-4 flex flex-col flex-grow justify-between">
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-1 overflow-hidden">
                                    <span class="text-xs text-gray-400 flex-shrink-0">By</span>
                                    <span class="font-bold text-gray-200 truncate" title="${cleanName}">${cleanName}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="toggleObsolete(${p.id}, '${cleanName}')" class="flex items-center justify-center w-7 h-7 rounded-full bg-gray-800/50 ${obsBtnClass} transition transform active:scale-90" title="${obsBtnTitle}">
                                        <span class="text-sm filter drop-shadow-md">${obsBtnIcon}</span>
                                    </button>
                                    <button onclick="toggleLike(${p.id}, this)" class="like-btn flex items-center gap-1.5 bg-gray-800/50 px-2 py-1 rounded-full ${heartClass}">
                                        <span class="text-base icon filter drop-shadow-md">${heartIcon}</span>
                                        <span class="text-xs font-bold count">${p.likes}</span>
                                    </button>
                                </div>
                            </div>
                            <div class="bg-gray-800/50 rounded-lg p-2 flex justify-between items-center mb-3 border border-gray-700">
                                <span class="text-xs font-mono text-gray-400 truncate select-all flex-1 mr-2">${p.coordinate || 'æœªçŸ¥åº§æ¨™'}</span>
                                <button onclick="copyText('${p.coordinate}')" class="text-xs bg-gray-700 hover:bg-gray-600 text-green-400 px-2 py-1.5 rounded flex-shrink-0 font-bold flex items-center gap-1">ğŸ“‹ è¤‡è£½</button>
                            </div>
                        </div>
                        <div class="flex flex-wrap content-end mb-2 min-h-[1.5rem]">${tagsHtml}</div>
                        
                        ${fullLocation ? `
                        <div class="pt-2 border-t border-gray-700/50 text-[11px] text-gray-400 flex items-center gap-1">
                            <span>ğŸŒ</span>
                            <span class="truncate" title="${fullLocation}">${fullLocation}</span>
                        </div>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        // åˆ‡æ›é ç¢¼å‡½å¼
        window.changePage = (delta) => {
            currentPage += delta;
            renderGrid();
            // è‡ªå‹•æ²å‹•åˆ°ç¯©é¸å™¨ä¸‹æ–¹ (æå‡æ‰‹æ©Ÿç‰ˆé«”é©—)
            document.getElementById('filter-container').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        };

            // è·³è½‰é é¢å‡½å¼
        window.jumpToPage = (val) => {
            // å–å¾—ç›®å‰çš„ç¯©é¸çµæœç¸½æ•¸ä¾†è¨ˆç®—æœ€å¤§é æ•¸ (éœ€è¦é‡æ–°è·‘ä¸€æ¬¡ç¯©é¸é‚è¼¯ä¾†ç¢ºèªç¯„åœ)
            // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘ç›´æ¥ç”¨ renderGrid è£¡é¢çš„é‚è¼¯ï¼Œæˆ–è€…å°‡ totalPages è¨­ç‚ºå…¨åŸŸè®Šæ•¸
            // é€™è£¡ä½¿ç”¨ä¸€å€‹ç°¡å–®çš„é˜²å‘†æŠ€å·§ï¼šç›´æ¥è®€å– DOM ä¸Šçš„ max å±¬æ€§ (å› ç‚º renderGrid å·²ç¶“è¨­å®šéäº†)
            const input = document.getElementById('page-input');
            const maxPage = parseInt(input.max) || 1;
            let target = parseInt(val);

            if (isNaN(target) || target < 1) target = 1;
            if (target > maxPage) target = maxPage;

            currentPage = target;
            renderGrid();
            
            // è·³è½‰å¾Œå›åˆ°é ‚éƒ¨
            document.getElementById('filter-container').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        };


        // --- è¡¨å–®æäº¤ (å«å¤±æ•—å›æ»¾èˆ‡åº§æ¨™é‡è¤‡æª¢æŸ¥) ---
        const modal = document.getElementById('postcard-modal');
        const form = document.getElementById('postcard-form');

        form.onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.disabled = true; 
            const originalText = btn.textContent;
            btn.textContent = 'è™•ç†ä¸­...';

            let uploadedFileName = null;

            try {
                const editId = document.getElementById('edit-id').value;
                const coords = document.getElementById('coordinate-input').value.trim();
                const tags = [1,2,3].map(i => document.getElementById(`tag-${i}`).value.trim()).filter(Boolean);
                
                const country = document.getElementById('input-country').value.trim();
                const region = document.getElementById('input-region').value.trim();
                const area = document.getElementById('input-area').value.trim();

                let imageUrl = null;
                const fileInput = document.getElementById('image-upload');

                if (!editId || (editId && fileInput.files.length > 0)) {
                    if (fileInput.files.length === 0 && !editId) throw new Error('è«‹é¸æ“‡åœ–ç‰‡');
                    if (fileInput.files.length > 0) {
                        showToast('æ­£åœ¨å£“ç¸®åœ–ç‰‡...', false);
                        const compressedFile = await compressImage(fileInput.files[0]);
                        uploadedFileName = `${Date.now()}_${Math.floor(Math.random()*1000)}.jpg`;
                        const { error: upErr } = await supabaseClient.storage.from('postcard-images').upload(uploadedFileName, compressedFile);
                        if (upErr) { uploadedFileName = null; throw upErr; }
                        const { data } = supabaseClient.storage.from('postcard-images').getPublicUrl(uploadedFileName);
                        imageUrl = data.publicUrl;
                    }
                }

                const payload = {
                    coordinate: coords, tags,
                    country, region, area,
                    imageUrl 
                };

                let resData, resError;
                if (!editId) {
                    const result = await supabaseClient.functions.invoke('admin-actions', {
                        body: { action: 'add-postcard', payload: { ...payload, uploaderId: currentUser.id, uploaderNickname: currentUser.nickname } }
                    });
                    resData = result.data; resError = result.error;
                } else {
                    const result = await supabaseClient.functions.invoke('admin-actions', {
                        body: { action: 'edit-postcard', payload: { ...payload, postcardId: editId } }
                    });
                    resData = result.data; resError = result.error;
                }

                if (resError) throw resError;
                if (resData && resData.success === false) throw new Error(resData.message || 'æ“ä½œå¤±æ•—');
                if (resData && resData.error) throw new Error(resData.error);

                showToast(editId ? 'æ›´æ–°æˆåŠŸï¼' : 'ç™¼å¸ƒæˆåŠŸï¼', false);
                modal.classList.add('hidden');
                loadPostcards();

            } catch (e) {
                console.error(e);
                if (uploadedFileName) await supabaseClient.storage.from('postcard-images').remove([uploadedFileName]);
                showToast(`æ“ä½œå¤±æ•—: ${e.message}`, true);
            } finally {
                btn.disabled = false; btn.textContent = originalText;
            }
        };

        // --- äº’å‹•èˆ‡å·¥å…·å‡½å¼ ---
        document.getElementById('add-postcard-btn').onclick = () => {
            form.reset();
            document.getElementById('edit-id').value = '';
            document.getElementById('modal-title').textContent = 'åˆ†äº«æ–°ç¾ç‰‡';
            document.getElementById('image-upload-section').classList.remove('hidden');
            document.getElementById('image-upload-section').querySelector('label').textContent = 'ä¸Šå‚³åœ–ç‰‡';
            document.getElementById('preview-section').classList.add('hidden');
            document.getElementById('submit-btn').textContent = 'ç™¼å¸ƒ';
            modal.classList.remove('hidden');
        };

        window.editCard = (id, event) => {
            event.stopPropagation();
            const card = allPostcards.find(p => p.id === id);
            if (!card) return;
            
            document.getElementById('edit-id').value = id;
            document.getElementById('modal-title').textContent = 'ç·¨è¼¯ç¾ç‰‡è³‡è¨Š';
            
            const coordVal = card.coordinate || '';
            document.getElementById('coordinate-input').value = coordVal;
            
            // è¨­å®šæ¬„ä½å€¼
            const countryVal = card.country || '';
            document.getElementById('input-country').value = countryVal;
            document.getElementById('input-region').value = card.region || '';
            document.getElementById('input-area').value = card.area || '';
            
            // å¦‚æœåº§æ¨™å­˜åœ¨ï¼Œä½†åœ‹å®¶/åœ°å€æ˜¯ç©ºçš„ï¼ˆä»£è¡¨æ˜¯èˆŠè³‡æ–™æˆ–ä¸Šæ¬¡æ²’å­˜åˆ°ï¼‰ï¼Œè‡ªå‹•è§¸ç™¼åæŸ¥
            if (coordVal && !countryVal) {
                const parts = formatCoordinateString(coordVal).split(',');
                if (parts.length === 2) {
                    // ç¨å¾®å»¶é²ä¸€ä¸‹è®“ Modal å…ˆæ‰“é–‹ï¼Œä½¿ç”¨è€…æ‰çœ‹å¾—åˆ°ã€Œæœå°‹ä¸­...ã€çš„æç¤º
                    setTimeout(() => {
                        autoFillLocation(parts[0].trim(), parts[1].trim());
                    }, 500);
                }
            }

            [1,2,3].forEach(i => document.getElementById(`tag-${i}`).value = (card.tags && card.tags[i-1]) || '');

            const uploadSection = document.getElementById('image-upload-section');
            uploadSection.classList.remove('hidden');
            uploadSection.querySelector('label').textContent = 'æ›´æ›åœ–ç‰‡ (è‹¥ä¸ä¿®æ”¹è«‹ç•™ç©º)';
            document.getElementById('image-upload').value = '';
            document.getElementById('preview-image').src = getCdnUrl(card.image_url);
            document.getElementById('preview-section').classList.remove('hidden');
            document.getElementById('submit-btn').textContent = 'å„²å­˜è®Šæ›´';
            modal.classList.remove('hidden');
        };

        const closeModal = () => modal.classList.add('hidden');
        document.getElementById('close-modal-btn').onclick = closeModal;
        document.getElementById('close-modal-x').onclick = closeModal;

        // --- åº§æ¨™è™•ç†èˆ‡åæŸ¥ ---
        function formatCoordinateString(val) {
            if (!val) return "";
            let str = val.trim();
            let match = str.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
            if (match) return `${parseFloat(match[1]).toFixed(7)}, ${parseFloat(match[2]).toFixed(7)}`;
            match = str.match(/q=(-?\d+\.\d+),(-?\d+\.\d+)/);
            if (match) return `${parseFloat(match[1]).toFixed(7)}, ${parseFloat(match[2]).toFixed(7)}`;
            match = str.match(/!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/);
            if (match) return `${parseFloat(match[1]).toFixed(7)}, ${parseFloat(match[2]).toFixed(7)}`;

            let tempStr = str.replace(/ï¼Œ/g, ',');
            const isDMS = tempStr.includes('Â°') && (tempStr.includes("'") || tempStr.includes('"'));
            let lat = 0, lng = 0, success = false;

            if (isDMS) {
                const numbers = tempStr.match(/(\d+(\.\d+)?)/g);
                const directions = tempStr.match(/[NSEWåŒ—å—æ±è¥¿]/gi) || [];
                if (numbers && numbers.length >= 6) {
                    const d1 = parseFloat(numbers[0]), m1 = parseFloat(numbers[1]), s1 = parseFloat(numbers[2]);
                    const d2 = parseFloat(numbers[3]), m2 = parseFloat(numbers[4]), s2 = parseFloat(numbers[5]);
                    lat = d1 + m1/60 + s1/3600; lng = d2 + m2/60 + s2/3600;
                    const dirStr = directions.join('');
                    if (/[Så—]/.test(dirStr)) lat = -lat; 
                    if (/[Wè¥¿]/.test(dirStr)) lng = -lng;
                    success = true;
                }
            } else {
                const numbers = tempStr.match(/(-?\d+(\.\d+)?)/g);
                if (numbers && numbers.length >= 2) {
                    lat = parseFloat(numbers[0]); lng = parseFloat(numbers[1]);
                    if (/[Så—]/.test(tempStr) && lat > 0) lat = -lat;
                    if (/[Wè¥¿]/.test(tempStr) && lng > 0) lng = -lng;
                    success = true;
                }
            }
            return success ? `${lat.toFixed(7)}, ${lng.toFixed(7)}` : val;
        }

        async function autoFillLocation(lat, lng) {
            const countryInput = document.getElementById('input-country');
            const regionInput = document.getElementById('input-region');
            const areaInput = document.getElementById('input-area');

            countryInput.placeholder = 'ğŸ” æœå°‹ä¸­...';
            try {
                const { data: resData, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ action: 'reverse-geocode', payload: { lat, lng } })
                });
                if (error) throw error;
                const data = resData.data;

                if (data && data.address) {
                    if (data.address.country) countryInput.value = data.address.country;
                    const region = data.address.city || data.address.county || '';
                    if (region) regionInput.value = region.replace(/è‡º/g, 'å°');
                    const area = data.address.suburb || data.address.district || '';
                    if (area) areaInput.value = area;
                    
                    [countryInput, regionInput, areaInput].forEach(el => el.classList.add('ring-2', 'ring-green-500'));
                    setTimeout(() => document.querySelectorAll('.ring-2').forEach(el=>el.classList.remove('ring-2', 'ring-green-500')), 1000);
                }
            } catch (e) { console.error('åæŸ¥å¤±æ•—', e); countryInput.placeholder = 'è¼¸å…¥æˆ–é¸æ“‡'; }
        }

        const coordInput = document.getElementById('coordinate-input');
        if (coordInput) {
            document.getElementById('paste-coord-btn').onclick = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if(text) handleCoordInput(text);
                    else showToast('å‰ªè²¼ç°¿æ˜¯ç©ºçš„', true);
                } catch(e) { showToast('ç„¡æ³•è®€å–å‰ªè²¼ç°¿', true); }
            };
            
            coordInput.addEventListener('blur', function() { handleCoordInput(this.value); });
            coordInput.addEventListener('keydown', function(e) { if(e.key==='Enter') { e.preventDefault(); this.blur(); }});
            
            async function handleCoordInput(raw) {
                const formatted = formatCoordinateString(raw);
                coordInput.value = formatted;
                if (formatted !== raw) showToast('å·²æ ¼å¼åŒ–åº§æ¨™', false);
                const parts = formatted.split(',');
                if(parts.length === 2) await autoFillLocation(parts[0].trim(), parts[1].trim());
            }
        }

        // --- Dropdown (ä¸‹æ‹‰é¸å–®é‚è¼¯) ---
        function setupDropdown(inputId, dropdownId, getSet) {
            const input = document.getElementById(inputId), dd = document.getElementById(dropdownId);
            const render = () => {
                const opts = Array.from(getSet()).sort().filter(x => x.toLowerCase().includes(input.value.toLowerCase()));
                dd.innerHTML = opts.map(x => `<div class="dropdown-option">${x}</div>`).join('') || '<div class="p-2 text-gray-500 text-xs">ç„¡é¸é …</div>';
                Array.from(dd.children).forEach(div => div.onclick = () => { 
                    input.value = div.textContent; 
                    dd.classList.remove('show'); 
                });
            };
            input.onfocus = () => { render(); dd.classList.add('show'); };
            input.oninput = () => { render(); dd.classList.add('show'); };
            // é»æ“Šå¤–éƒ¨é—œé–‰çš„é‚è¼¯å·²ç§»è‡³ init() ä¸­çš„å…¨åŸŸç›£è½å™¨
        }

        function updateInputDropdowns() {
            const allTags = new Set(); 
            allPostcards.forEach(c => !c.is_obsolete && c.tags && c.tags.forEach(t => allTags.add(t)));
            [1,2,3].forEach(i => setupDropdown(`tag-${i}`, `dropdown-${i}`, () => allTags));
            setupDropdown('input-country', 'dropdown-country', () => uniqueCountries);
            setupDropdown('input-region', 'dropdown-region', () => uniqueRegions);
            setupDropdown('input-area', 'dropdown-area', () => uniqueAreas);
        }
        function initDropdowns() { updateInputDropdowns(); }

        // --- å…¶ä»–å·¥å…· ---
        window.deleteCard = async (id, event) => {
            event.stopPropagation();
            if (!confirm('ã€è­¦å‘Šã€‘ç¢ºå®šè¦åˆªé™¤é€™å¼µç¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
            try {
                const { error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: { action: 'delete-postcard', payload: { postcardId: id } }
                });
                if (error) throw error;
                showToast('å·²åˆªé™¤ç¾ç‰‡', false);
                loadPostcards();
            } catch (e) { showToast('åˆªé™¤å¤±æ•—', true); console.error(e); }
        };

        window.toggleLike = async (id, btn) => {
            const card = allPostcards.find(p => p.id === id);
            if (!card) return;
            const iconSpan = btn.querySelector('.icon');
            const countSpan = btn.querySelector('.count');
            const wasLiked = card.isLiked;
            card.isLiked = !wasLiked;
            card.likes += (wasLiked ? -1 : 1);
            iconSpan.textContent = card.isLiked ? 'â¤ï¸' : 'ğŸ¤';
            countSpan.textContent = card.likes;
            btn.className = `like-btn flex items-center gap-1.5 bg-gray-800/50 px-2 py-1 rounded-full ${card.isLiked ? 'liked' : 'text-gray-500 hover:text-pink-400'}`;
            try {
                const { data } = await supabaseClient.functions.invoke('admin-actions', {
                    body: { action: 'toggle-postcard-like', payload: { postcardId: id } }
                });
                if(data.data) { card.likes = data.data.likes; countSpan.textContent = card.likes; }
            } catch (e) { console.error('Like failed', e); }
        };

        window.toggleObsolete = async (id, uploaderName) => {
            if (event) event.stopPropagation();
            const card = allPostcards.find(p => p.id === id);
            if (!card) return;
            const isCurrentlyObsolete = card.is_obsolete;
            const confirmMsg = isCurrentlyObsolete ? 'ç¢ºå®šè¦æ¢å¾©ä¸Šæ¶å—ï¼Ÿ' : 'ç¢ºå®šè¦å›å ±çµ•ç‰ˆå—ï¼Ÿ';
            if (!confirm(confirmMsg)) return;
            try {
                card.is_obsolete = !isCurrentlyObsolete;
                renderGrid();
                await supabaseClient.functions.invoke('admin-actions', {
                    body: { action: 'toggle-postcard-obsolete', payload: { postcardId: id } }
                });
                showToast('ç‹€æ…‹å·²æ›´æ–°', false);
            } catch (e) { console.error(e); card.is_obsolete = isCurrentlyObsolete; renderGrid(); showToast('æ“ä½œå¤±æ•—', true); }
        };

        window.copyText = (text) => {
            if (!text || text.includes('æœªçŸ¥')) return showToast('ç„¡æ•ˆåº§æ¨™', true);
            navigator.clipboard.writeText(text).then(() => showToast('å·²è¤‡è£½åº§æ¨™', false));
        };

        window.viewImage = (url) => {
            const m = document.getElementById('image-viewer-modal');
            const i = document.getElementById('viewer-image');
            
            if(m && i) { 
                i.src = getCdnUrl(url); 
                m.classList.remove('hidden'); 
                document.body.style.overflow = 'hidden'; 
            }
        };

        window.closeImageViewer = () => {
            const m = document.getElementById('image-viewer-modal');
            if(m) { m.classList.add('hidden'); document.body.style.overflow = ''; setTimeout(() => document.getElementById('viewer-image').src='', 300); }
        };
        document.addEventListener('keydown', (e) => { if(e.key==='Escape') window.closeImageViewer(); });

        function showToast(msg, isErr) {
            const el = document.getElementById('toast-message');
            el.innerHTML = `${isErr ? 'âŒ' : 'âœ…'} ${msg}`;
            el.className = `fixed top-5 right-5 text-white py-3 px-6 rounded-xl shadow-2xl z-[70] font-bold flex items-center gap-2 transform transition-all duration-300 ${isErr ? 'bg-red-600/95' : 'bg-green-600/95'} translate-y-0`;
            el.classList.remove('hidden');
            setTimeout(() => {
                el.classList.add('translate-y-[-20px]', 'opacity-0');
                setTimeout(() => { el.classList.add('hidden'); el.classList.remove('translate-y-[-20px]', 'opacity-0'); }, 300);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>