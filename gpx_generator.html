<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPX è·¯å¾‘ç”Ÿæˆå™¨ - è‡è‡å®…é…ç¶²</title>
    <link rel="icon" href="./mashroom_s.png" type="image/png">
    <link rel="apple-touch-icon" href="./mashroom_s.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #111827; color: #d1d5db; }
        .main-container { background-color: #1f2937; border: 1px solid #374151; }
        .dark-input { background-color: #374151; border-color: #4b5563; color: #d1d5db; }
        .dark-input:focus { --tw-ring-color: #22c55e; border-color: #22c55e; }
        .primary-button { background-color: #22c55e; transition: background-color 0.2s; }
        .primary-button:hover:not(:disabled) { background-color: #16a34a; }
        .router-button { background-color: #3b82f6; transition: background-color: 0.2s; }
        .router-button:hover:not(:disabled) { background-color: #2563eb; }
        .secondary-button { background-color: #4b5563; transition: background-color 0.2s; }
        .secondary-button:hover { background-color: #6b7280; }
        .row-number { width: 2rem; text-align: right; color: #6b7280; font-size: 0.875rem; flex-shrink: 0; }
        
        /* â˜… å®‰å…¨æ€§ï¼šé è¨­éš±è—å…§å®¹ï¼Œç›´åˆ°æ¬Šé™æª¢æŸ¥é€šé */
        #app-content { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app-content" class="max-w-4xl mx-auto main-container rounded-2xl shadow-lg p-6 md:p-8">
        <header class="mb-8 flex justify-between items-center">
            <h1 class="text-2xl md:text-3xl font-bold text-white">GPX è·¯å¾‘ç”Ÿæˆå™¨</h1>
            <a href="./dashboard.html" class="text-indigo-400 hover:text-indigo-300 font-bold transition">è¿”å›ä¸»é </a>
        </header>

        <div class="space-y-6">
            <div>
                <label for="route-name" class="block text-sm font-medium text-gray-400 mb-1">è·¯å¾‘åç¨±</label>
                <input type="text" id="route-name" class="dark-input w-full md:w-1/2 rounded-md" value="æˆ‘çš„è·¯å¾‘">
            </div>

            <div>
                <div class="flex items-center gap-4 mb-2">
                    <label class="block text-sm font-medium text-gray-400">åº§æ¨™é» (æ ¼å¼ï¼šç·¯åº¦, ç¶“åº¦)</label>
                    <button id="paste-all-button" class="secondary-button text-xs font-bold py-1 px-3 rounded-full">å¾å‰ªè²¼ç°¿è²¼ä¸Šå¤šè¡Œ</button>
                </div>
                <div id="coords-container" class="space-y-2 max-h-[50vh] overflow-y-auto pr-2"></div>
                <button id="add-row-button" class="mt-4 secondary-button font-bold py-2 px-4 rounded-lg text-sm">å¢åŠ æ¬„ä½</button>
            </div>

            <div class="border-t border-gray-600 pt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="generate-router-button" class="w-full router-button font-bold py-3 px-6 rounded-lg shadow-lg hover:scale-105 transition transform">ç”Ÿæˆ Router è·¯å¾‘</button>
                <button id="generate-joystick-button" class="w-full primary-button font-bold py-3 px-6 rounded-lg shadow-lg hover:scale-105 transition transform">ç”Ÿæˆ Joystick è·¯å¾‘</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // â˜… å®‰å…¨æ€§æª¢æŸ¥ï¼šè‹¥ç„¡ç™»å…¥ï¼Œç›´æ¥è¸¢å›é¦–é 
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                alert('è«‹å…ˆç™»å…¥æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ï¼');
                window.location.replace('./index.html');
            } else {
                // é€šéé©—è­‰ï¼Œé¡¯ç¤ºå…§å®¹
                document.getElementById('app-content').style.display = 'block';
            }
        }
        checkAuth();

        // --- ä»¥ä¸‹ç‚ºåŸæœ‰é‚è¼¯ ---
        const coordsContainer = document.getElementById('coords-container');
        const addRowButton = document.getElementById('add-row-button');
        const pasteAllButton = document.getElementById('paste-all-button');
        const routeNameInput = document.getElementById('route-name');
        const generateRouterButton = document.getElementById('generate-router-button');
        const generateJoystickButton = document.getElementById('generate-joystick-button');

        function updateRowNumbers() {
            const rows = coordsContainer.querySelectorAll('.coord-row');
            rows.forEach((row, index) => {
                row.querySelector('.row-number').textContent = `${index + 1}.`;
            });
        }
        function addCoordRow(coordText = '') {
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2 coord-row';
            row.innerHTML = `
                <span class="row-number"></span>
                <button class="p-1 secondary-button rounded-md paste-button" title="è²¼ä¸Šå–®ç­†åº§æ¨™">ğŸ“‹</button>
                <input type="text" placeholder="ç·¯åº¦, ç¶“åº¦" value="${coordText}" class="dark-input w-full rounded-md coord-input">
                <button class="text-red-500 hover:text-red-400 text-xl font-bold delete-button" title="åˆªé™¤æ­¤è¡Œ">&times;</button>
            `;
            coordsContainer.appendChild(row);
        }
        coordsContainer.addEventListener('click', async (event) => {
            const target = event.target;
            if (target.classList.contains('delete-button')) {
                target.closest('.coord-row').remove();
                updateRowNumbers();
            }
            if (target.classList.contains('paste-button')) {
                try {
                    const text = await navigator.clipboard.readText();
                    target.nextElementSibling.value = text.trim();
                } catch (err) {
                    alert('è®€å–å‰ªè²¼ç°¿å¤±æ•—');
                }
            }
        });
        async function pasteAllFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                const lines = text.trim().split('\n');
                if (lines.length > 0 && lines[0] !== '') {
                    coordsContainer.innerHTML = '';
                    lines.forEach(line => addCoordRow(line.trim()));
                    updateRowNumbers();
                }
            } catch (err) {
                alert('è®€å–å‰ªè²¼ç°¿å¤±æ•—');
            }
        }
        function getCoordinates() {
            const allCoordInputs = coordsContainer.querySelectorAll('.coord-input');
            const coords = [];
            allCoordInputs.forEach(input => {
                const value = input.value.trim();
                if (!value) return;
                const parts = value.split(/[,\s\t]+/);
                if (parts.length >= 2) {
                    const lat = parseFloat(parts[0]);
                    const lon = parseFloat(parts[1]);
                    if (!isNaN(lat) && !isNaN(lon)) {
                        coords.push({ lat, lon });
                    }
                }
            });
            return coords;
        }
        function generateRouterGpxFile() {
            const coords = getCoordinates();
            const routeName = routeNameInput.value.trim().replace(/[<>:"/\\|?*]/g, '') || 'æœªå‘½åè·¯å¾‘';
            if (coords.length === 0) { alert('è«‹è‡³å°‘è¼¸å…¥ä¸€çµ„æœ‰æ•ˆçš„åº§æ¨™ï¼'); return; }
            const waypoints = coords.map(c => `  <wpt lat="${c.lat}" lon="${c.lon}"></wpt>`).join('\n');
            const trackpoints = coords.map(c => `    <trkpt lat="${c.lat}" lon="${c.lon}"></trkpt>`).join('\n');
            const gpxContent = `<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<gpx version="1.1" creator="Gemini GPX Generator" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">
${waypoints}
<trk><name>${routeName}</name><trkseg>${trackpoints}</trkseg></trk></gpx>`;
            downloadGpxFile(gpxContent, routeName);
        }
        function generateJoystickGpxFile() {
            const coords = getCoordinates();
            const routeName = routeNameInput.value.trim().replace(/[<>:"/\\|?*]/g, '') || 'æœªå‘½åè·¯å¾‘';
            if (coords.length === 0) { alert('è«‹è‡³å°‘è¼¸å…¥ä¸€çµ„æœ‰æ•ˆçš„åº§æ¨™ï¼'); return; }
            const routepoints = coords.map(c => `<rtept lat="${c.lat}" lon="${c.lon}"/>`).join('');
            const gpxContent = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="GPS JoyStick"><rte><name>${routeName}</name><number>0</number>${routepoints}</rte></gpx>`;
            downloadGpxFile(gpxContent, routeName);
        }
        function downloadGpxFile(content, fileName) {
            const blob = new Blob([content], { type: 'application/gpx+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `${fileName}.gpx`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }
        function initializePage() {
            coordsContainer.innerHTML = '';
            for (let i = 0; i < 20; i++) { addCoordRow(); }
            updateRowNumbers();
        }
        addRowButton.addEventListener('click', () => { addCoordRow(); updateRowNumbers(); });
        pasteAllButton.addEventListener('click', pasteAllFromClipboard);
        generateRouterButton.addEventListener('click', generateRouterGpxFile);
        generateJoystickButton.addEventListener('click', generateJoystickGpxFile);
        initializePage();
    </script>
</body>
</html>