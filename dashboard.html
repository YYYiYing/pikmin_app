<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>菇菇宅配網 - Pikmin Bloom 蘑菇報名表5.0</title>
    <link rel="icon" href="./mashroom_s.png" type="image/png">
    <link rel="apple-touch-icon" href="./mashroom_s.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .header-gradient {
            background: #1f2937;
            border-bottom: 1px solid #374151;
        }
        .challenge-card {
            background-color: #1f2937;
            border: 1px solid #374151;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex; 
            flex-direction: column;
            justify-content: space-between;
        }
        .challenge-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.25);
            border-color: #4f46e5;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-weight: bold;
            font-size: 0.8rem;
            text-transform: uppercase;
        }
        .status-open { background-color: #10b981; color: white; }
        .status-full { background-color: #ef4444; color: white; }
        .status-pending { background-color: #f59e0b; color: white; }
        
        .dispatch-pending { background-color: #4b5563; color: white; }
        .dispatch-sent { background-color: #14b8a6; color: white; }

        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); }
        .modal-content {
            background-color: #1f2937;
            border: 1px solid #374151;
        }
        .dark-input {
            background-color: #374151;
            border-color: #4b5563;
            color: #d1d5db;
        }
        .dark-input:focus {
            --tw-ring-color: #4f46e5;
            border-color: #4f46e5;
        }
        .participant-list {
            border-top: 1px solid #374151;
            margin-top: 1rem;
            padding-top: 1rem;
        }
        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #d1d5db;
        }
        .participant-rank {
            font-weight: bold;
            color: #6366f1; /* indigo-500 */
        }

        .leaderboard-tab {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .leaderboard-tab.active {
            border-color: #4f46e5;
            color: #a5b4fc;
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #374151;
        }
        .leaderboard-rank {
            font-size: 1.2rem;
            font-weight: bold;
            width: 40px;
            text-align: center;
        }
        .leaderboard-nickname {
            flex-grow: 1;
        }
        .leaderboard-count {
            font-weight: bold;
        }
        .filter-tab {
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 9999px;
            transition: all 0.2s ease;
            font-weight: 600;
        }
        .filter-tab.active {
            background-color: #4f46e5;
            color: white;
        }
        .filter-tab:not(.active) {
            background-color: #374151;
            color: #d1d5db;
        }
        .filter-tab:not(.active):hover {
            background-color: #4b5563;
        }
    </style>
</head>
<body class="bg-gray-900">

<header class="header-gradient shadow-md sticky top-0 z-20">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center relative">
        
        <div class="flex items-center gap-4">
            <button id="hamburger-button" class="p-2 md:hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-list text-white" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                </svg>
            </button>
            <h1 class="text-2xl font-bold text-white flex items-center">
                <img src="./mashroom.png" alt="Pikmin Logo" class="w-10 h-10 mr-2 rounded-full">
                菇菇宅配網
            </h1>
            
            <div id="online-users-container" class="flex items-center gap-2 text-sm text-white cursor-pointer hover:text-gray-300 transition" title="查看在線列表">
                <span></span>
                <button id="refresh-button" title="重新整理" class="hover:text-white transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="flex items-center gap-x-4">
            <span id="user-info" class="font-semibold text-gray-200 text-sm text-center">讀取中...</span>
            
            <div class="hidden md:flex items-center gap-x-4">
                <button id="leaderboard-button" class="text-gray-300 hover:text-white transition text-sm">🏆 排行榜</button>
                <a href="./partner.html" class="text-gray-300 hover:text-white transition text-sm">🚚 菇菇宅配通</a>
                <a id="admin-link" href="./admin.html" class="hidden text-orange-400 hover:text-orange-300 font-bold transition text-sm">⚙️ 管理後台</a>
                <button id="change-password-button" class="bg-gray-700 text-white px-3 py-1.5 text-xs rounded-full font-bold hover:bg-gray-600 transition">改密碼</button>
                <button id="logout-button" class="bg-red-700 text-white px-3 py-1.5 text-xs rounded-full font-bold hover:bg-red-600 transition">登出</button>
            </div>
        </div>

        <div id="mobile-menu" class="hidden absolute top-full left-0 mt-2 w-48 bg-gray-800 rounded-lg shadow-lg p-2">
            <div class="space-y-1">
                <button id="leaderboard-button-mobile" class="w-full text-left text-gray-300 hover:bg-gray-700 p-2 rounded-md">🏆 排行榜</button>
                <a href="./partner.html" class="block text-gray-300 hover:bg-gray-700 p-2 rounded-md">🚚 菇菇宅配通</a>
            </div>
            <hr class="border-gray-600 my-2">
            <a id="admin-link-mobile" href="./admin.html" class="hidden text-orange-400 hover:bg-gray-700 p-2 rounded-md font-bold">⚙️ 管理後台</a>
            <hr class="border-gray-600 my-2">
            <div class="space-y-1">
                <button id="change-password-button-mobile" class="w-full text-left text-gray-300 hover:bg-gray-700 p-2 rounded-md">改密碼</button>
                <button id="logout-button-mobile" class="w-full text-left text-red-400 hover:bg-gray-700 p-2 rounded-md">登出</button>
            </div>
        </div>
        
    </div>
</header>

    <main class="container mx-auto p-4 md:p-8">
        <div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4 flex-wrap justify-center">
                
                <div id="filter-tabs" class="flex space-x-2">
                    <button data-filter="all" class="filter-tab active text-xs md:text-base">全部挑戰</button>
                    <button data-filter="full" class="filter-tab text-xs md:text-base">已額滿</button>
                    <button data-filter="signed-up" class="filter-tab text-xs md:text-base">我的報名</button>
                    <button id="hosted-tab" data-filter="hosted" class="filter-tab hidden text-xs md:text-base">我的發布</button>
                </div>
                
                <button id="screenshot-button" class="text-gray-400 hover:text-white transition text-xs md:text-base">📸 截圖</button>
            
            </div>
            <button id="post-challenge-button" class="hidden bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition transform hover:scale-105 w-full md:w-auto">
                🍄 發布新挑戰
            </button>
        </div>
        <div id="challenges-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <p id="loading-indicator" class="text-center col-span-full text-gray-400">正在載入挑戰列表，請稍候...</p>
        </div>
    </main>
    
    <div id="online-users-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-xs rounded-2xl shadow-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-100">在線人員</h2>
                <button type="button" id="close-online-users-modal" class="text-gray-500 hover:text-white text-2xl">&times;</button>
            </div>
            <ul id="online-users-list" class="space-y-2 max-h-64 overflow-y-auto text-gray-300"></ul>
        </div>
    </div>

    <!-- 新增/發布挑戰 Modal -->
    <div id="challenge-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
            <div class="modal-content w-full max-w-lg rounded-2xl shadow-xl p-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-100">發布一個新挑戰</h2>
                <form id="challenge-form">
                <div class="space-y-4">

                    <div>
                        <label for="mushroom-type" class="block text-sm font-medium text-gray-400">蘑菇種類</label>
                        <select id="mushroom-type" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="巨菇" selected>巨菇</option>
                            <option value="活動菇">活動菇</option>
                            <option value="大晶">大晶</option>
                            <option value="大火">大火</option>
                            <option value="大水">大水</option>
                            <option value="大電">大電</option>
                            <option value="大毒">大毒</option>
                            <option value="大紅">大紅</option>
                            <option value="大黃">大黃</option>
                            <option value="大藍">大藍</option>
                            <option value="大紫">大紫</option>
                            <option value="大粉">大粉</option>
                            <option value="大灰">大灰</option>
                            <option value="大白">大白</option>
                            <option value="晶">晶</option>
                            <option value="水">水</option>
                            <option value="火">火</option>
                            <option value="電">電</option>
                            <option value="毒">毒</option>
                        </select>
                    </div>

                    <div>
                        <label for="slots" class="block text-sm font-medium text-gray-400">名額</label>
                        <input type="number" id="slots" min="1" required class="dark-input mt-1 block w-full rounded-md shadow-sm" value="4">
                    </div>

                    <div>
                        <div class="flex justify-between items-center">
                            <label for="start-time" class="block text-sm font-medium text-gray-400">開放報名時間</label>
                            <button type="button" id="set-time-now-button" class="text-xs bg-indigo-500 text-white px-2 py-1 rounded-md hover:bg-indigo-600">立即開放</button>
                        </div>
                        <input type="datetime-local" id="start-time" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                        
                        <div class="mt-2 flex items-center">
                            <input id="remember-time-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:bg-gray-600 dark:border-gray-500">
                            <label for="remember-time-checkbox" class="ml-2 block text-sm text-gray-400">記住時間 (下次自動帶入)</label>
                        </div>
                    </div>

                    <div>
                        <label for="details" class="block text-sm font-medium text-gray-400">用餐時段</label>
                        <select id="details" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="宵夜" selected>宵夜</option>
                            <option value="早餐">早餐</option>
                            <option value="滿人開">滿人開</option>
                        </select>
                    </div>

                </div>

                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="cancel-modal-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">取消</button>
                    <button type="submit" id="submit-challenge-button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-50">確認發布</button>
                </div>
                </form>
            </div>
        </div>

    <!-- 【新增功能】編輯挑戰 Modal -->
    <div id="edit-challenge-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-xl p-8">
            <h2 class="text-2xl font-bold mb-6 text-gray-100">編輯挑戰內容</h2>
            <form id="edit-challenge-form">
                <input type="hidden" id="edit-challenge-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-mushroom-type" class="block text-sm font-medium text-gray-400">蘑菇種類</label>
                        <select id="edit-mushroom-type" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="巨菇">巨菇</option><option value="活動菇">活動菇</option><option value="大晶">大晶</option><option value="大火">大火</option><option value="大水">大水</option><option value="大電">大電</option><option value="大毒">大毒</option><option value="大紅">大紅</option><option value="大黃">大黃</option><option value="大藍">大藍</option><option value="大紫">大紫</option><option value="大粉">大粉</option><option value="大灰">大灰</option><option value="大白">大白</option><option value="晶">晶</option><option value="水">水</option><option value="火">火</option><option value="電">電</option><option value="毒">毒</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-slots" class="block text-sm font-medium text-gray-400">名額</label>
                        <input type="number" id="edit-slots" min="1" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                    </div>
                    <div>
                        <div class="flex justify-between items-center">
                            <label for="edit-start-time" class="block text-sm font-medium text-gray-400">開放報名時間</label>
                            <button type="button" id="edit-set-time-now-button" class="text-xs bg-indigo-500 text-white px-2 py-1 rounded-md hover:bg-indigo-600">立即開放</button>
                        </div>
                        <input type="datetime-local" id="edit-start-time" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="edit-details" class="block text-sm font-medium text-gray-400">用餐時段</label>
                        <select id="edit-details" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="滿人開">滿人開</option><option value="早餐">早餐</option><option value="宵夜">宵夜</option>
                        </select>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="cancel-edit-modal-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">取消</button>
                    <button type="submit" id="submit-edit-challenge-button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-50">確認儲存</button>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop"><div class="modal-content w-full max-w-sm rounded-2xl shadow-xl p-8"><h2 class="text-xl font-bold mb-4 text-white">確認刪除</h2><p class="text-gray-400 mb-6">您確定要刪除這個挑戰嗎？此操作無法復原。</p><div class="flex justify-end space-x-4"><button type="button" id="cancel-delete-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">取消</button><button type="button" id="confirm-delete-button" class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 disabled:opacity-50">確認刪除</button></div></div></div>
    <div id="leaderboard-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop"><div class="modal-content w-full max-w-lg rounded-2xl shadow-xl p-8"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gray-100">🏆 排行榜</h2><button type="button" id="close-leaderboard-button" class="text-gray-500 hover:text-white">&times;</button></div><div id="leaderboard-tabs" class="flex border-b border-gray-600 mb-4 overflow-x-auto"><button data-type="count" data-period="week" class="leaderboard-tab active whitespace-nowrap">本週報名王</button><button data-type="count" data-period="month" class="leaderboard-tab whitespace-nowrap">本月報名王</button><button data-type="speed" data-period="week" class="leaderboard-tab whitespace-nowrap">本週最速</button><button data-type="speed" data-period="month" class="leaderboard-tab whitespace-nowrap">本月最速</button></div><div id="leaderboard-content" class="space-y-2 max-h-96 overflow-y-auto"><p>讀取中...</p></div></div></div>
    <div id="password-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop"><div class="modal-content w-full max-w-md rounded-2xl shadow-xl p-8"><h2 class="text-2xl font-bold mb-6 text-gray-100">修改密碼</h2><form id="password-form"><div class="space-y-4"><div><label for="new-password" class="block text-sm font-medium text-gray-400">新密碼 (至少6位數)</label><input type="password" id="new-password" required minlength="6" class="dark-input mt-1 block w-full rounded-md shadow-sm"></div><div><label for="confirm-password" class="block text-sm font-medium text-gray-400">確認新密碼</label><input type="password" id="confirm-password" required minlength="6" class="dark-input mt-1 block w-full rounded-md shadow-sm"></div></div><div class="mt-8 flex justify-end space-x-4"><button type="button" id="cancel-password-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">取消</button><button type="submit" id="submit-password-button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-50">確認修改</button></div></form></div></div>
    <div id="toast-message" class="hidden fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg"></div>

    <script>
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co'; 
        const SUPABASE_ANON_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const userInfoEl = document.getElementById('user-info');
        const changePasswordButton = document.getElementById('change-password-button');
        const logoutButton = document.getElementById('logout-button');
        const postChallengeButton = document.getElementById('post-challenge-button');
        const challengesListEl = document.getElementById('challenges-list');
        const challengeModal = document.getElementById('challenge-modal');
        const challengeForm = document.getElementById('challenge-form');
        const cancelModalButton = document.getElementById('cancel-modal-button');
        const setTimeNowButton = document.getElementById('set-time-now-button');
        const submitChallengeButton = document.getElementById('submit-challenge-button');
        const toastMessage = document.getElementById('toast-message');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const cancelDeleteButton = document.getElementById('cancel-delete-button');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const leaderboardButton = document.getElementById('leaderboard-button');
        const leaderboardModal = document.getElementById('leaderboard-modal');
        const leaderboardTabs = document.getElementById('leaderboard-tabs');
        const leaderboardContent = document.getElementById('leaderboard-content');
        const closeLeaderboardButton = document.getElementById('close-leaderboard-button');
        const passwordModal = document.getElementById('password-modal');
        const passwordForm = document.getElementById('password-form');
        const cancelPasswordButton = document.getElementById('cancel-password-button');
        const submitPasswordButton = document.getElementById('submit-password-button');
        const filterTabs = document.getElementById('filter-tabs');
        const hostedTab = document.getElementById('hosted-tab');
        const adminLink = document.getElementById('admin-link'); 
        const onlineUsersContainer = document.getElementById('online-users-container');
        const refreshButton = document.getElementById('refresh-button');
        const onlineUsersModal = document.getElementById('online-users-modal');
        const onlineUsersList = document.getElementById('online-users-list');
        const closeOnlineUsersModalButton = document.getElementById('close-online-users-modal');
        const editChallengeModal = document.getElementById('edit-challenge-modal');
        const editChallengeForm = document.getElementById('edit-challenge-form');
        const cancelEditModalButton = document.getElementById('cancel-edit-modal-button');
        const editSetTimeNowButton = document.getElementById('edit-set-time-now-button');
        const screenshotButton = document.getElementById('screenshot-button');
        const hamburgerButton = document.getElementById('hamburger-button');
        const mobileMenu = document.getElementById('mobile-menu');
        
        let currentUserProfile = null;
        let challengeToDeleteId = null;
        let userSignedUpChallengeIds = new Set(); 
        let countdownInterval = null; 
        let activeFilter = 'all';
        let onlineNicknames = []; 
        let challengesData = {}; 

        //蘑菇樣式對照表
        const mushroomStyles = {
        '巨菇':     { bg: 'bg-cyan-400',     text: 'text-black' },
        '活動菇':   { bg: 'bg-lime-400',     text: 'text-black' },
        '大火':     { bg: 'bg-red-600',      text: 'text-white' },
        '火':       { bg: 'bg-red-600',      text: 'text-white' },
        '大紅':     { bg: 'bg-red-600',      text: 'text-white' },
        '大電':     { bg: 'bg-yellow-400',   text: 'text-black' },
        '電':       { bg: 'bg-yellow-400',   text: 'text-black' },
        '大黃':     { bg: 'bg-yellow-400',   text: 'text-black' },
        '大水':     { bg: 'bg-blue-600',     text: 'text-white' },
        '水':       { bg: 'bg-blue-600',     text: 'text-white' },
        '大藍':     { bg: 'bg-blue-600',     text: 'text-white' },
        '大晶':     { bg: 'bg-sky-300',      text: 'text-black' },
        '晶':       { bg: 'bg-sky-300',      text: 'text-black' },
        '大毒':     { bg: 'bg-green-700',    text: 'text-white' },
        '毒':       { bg: 'bg-green-700',    text: 'text-white' },
        '大白':     { bg: 'bg-white',        text: 'text-black' },
        '大紫':     { bg: 'bg-purple-600',   text: 'text-white' },
        '大粉':     { bg: 'bg-pink-300',     text: 'text-black' },
        '大灰':     { bg: 'bg-gray-500',     text: 'text-white' },
        };

        async function initializePage() {

            // 在頁面初始化時，靜默呼叫後端函式，更新自己的最後活躍時間
            await supabaseClient.rpc('update_last_active');

            supabaseClient.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_OUT' || !session) {
                    if (countdownInterval) clearInterval(countdownInterval);
                    window.location.replace('./index.html');
                }
            });

            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) return;
            
            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .single();

            if (error || !profile) {
                console.error('獲取個人檔案失敗或無效:', error);
                await supabaseClient.auth.signOut();
                return;
            }
            
            currentUserProfile = profile;
            displayUserInfo();
            
            await fetchUserSignups();
            await fetchChallenges();
            setupRealtimeListeners();
            setupOnlinePresence();
            startGlobalCountdown();
        }

        function displayUserInfo() {
            // 如果尚未讀取到使用者資料，則不執行
            if (!currentUserProfile) return;

            // 更新標題列中的歡迎訊息
            userInfoEl.textContent = `你好，${currentUserProfile.nickname}！`;
            
            // 判斷是否為「管理者」或「發菇者」，以顯示發布相關按鈕
            if (currentUserProfile.role === '管理者' || currentUserProfile.role === '發菇者' || currentUserProfile.role === '發菇及報名者') {
                postChallengeButton.classList.remove('hidden');
                hostedTab.classList.remove('hidden');
            }
            
            // ------------------- ★ 這裡是核心修改處 ★ -------------------
            // 判斷是否為「管理者」
            if (currentUserProfile.role === '管理者') {
                // (原本就有的) 讓桌面版的「管理後台」連結顯示出來
                adminLink.classList.remove('hidden');

                // (我們新增的) 同步讓行動版漢堡選單中的「管理後台」連結也顯示出來
                document.getElementById('admin-link-mobile').classList.remove('hidden');
            }
        }
        
        async function fetchUserSignups() {
            const { data, error } = await supabaseClient
                .from('signups')
                .select('challenge_id')
                .eq('user_id', currentUserProfile.id);

            if (error) {
                console.error('獲取使用者報名紀錄失敗:', error);
                return;
            }
            userSignedUpChallengeIds = new Set(data.map(signup => signup.challenge_id));
        }
        
        async function fetchChallenges() {
            const { data: challenges, error } = await supabaseClient
                .from('challenges')
                .select(`*, host:profiles(nickname, id), signups(*, profile:profiles(nickname))`)
                .order('start_time', { ascending: false });

            if (error) {
                console.error('獲取挑戰列表失敗:', error);
                challengesListEl.innerHTML = '<p class="text-center col-span-full text-red-400">無法載入挑戰，請稍後再試。</p>';
                return;
            }
            
            challengesData = {}; 
            challenges.forEach(c => {
                challengesData[c.id] = c;
            });

            const loadingIndicator = document.getElementById('loading-indicator');
            if(loadingIndicator) loadingIndicator.remove();
            
            challengesListEl.innerHTML = ''; 
            challenges.forEach(challenge => renderChallenge(challenge));
            applyFilter();
        }

        function renderChallenge(challenge) {
            if (!challenge || !challenge.host) {
                console.warn('收到不完整的挑戰資料，已略過渲染:', challenge);
                return;
            }
            challengesData[challenge.id] = challenge; 

            const card = document.createElement('div');
            card.className = 'challenge-card bg-gray-800 rounded-xl shadow-md overflow-hidden p-6 flex flex-col justify-between';
            card.id = `challenge-${challenge.id}`;
            const statusClass = challenge.status === '開放報名中' ? 'status-open' : (challenge.status === '已額滿' ? 'status-full' : 'status-pending');
            
            card.dataset.status = challenge.status;

            // 1. 根據蘑菇類型從對照表取得對應的樣式
            const type = challenge.mushroom_type;
            // 若找不到對應類型，則使用預設樣式
            const defaultStyle = { bg: 'bg-transparent', text: 'text-gray-100' };
            const style = mushroomStyles[type] || defaultStyle;

            // 2. 組合出完整的標題 CSS 樣式字串 (加上內距 padding 和圓角，使其像個標籤)
            const titleClasses = `text-xl font-bold px-3 py-1 rounded-md ${style.bg} ${style.text}`;

            const isHost = challenge.host && challenge.host.id === currentUserProfile.id;
            const isSignedUp = userSignedUpChallengeIds.has(challenge.id);

            if (isHost) card.dataset.isHosted = 'true';
            if (isSignedUp) card.dataset.isSignedUp = 'true';
            
            const hostControlsHtml = isHost ? `
                <button data-id="${challenge.id}" class="edit-challenge-button text-gray-500 hover:text-yellow-400 transition" title="編輯">✏️</button>
                <button data-id="${challenge.id}" class="delete-challenge-button text-gray-500 hover:text-red-500 transition" title="刪除">🗑️</button>
            ` : '';

            let actionButtonHtml;
            if (isHost) {
                actionButtonHtml = `<button class="w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg cursor-default">您是發菇者</button>`;
            } else if (isSignedUp) {
                actionButtonHtml = `<button class="cancel-signup-button w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition" data-challenge-id="${challenge.id}">取消報名</button>`;
            } else if (challenge.status === '預計開放') {
                actionButtonHtml = `<button class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed" disabled>尚未開放</button>`;
            } else if (challenge.status === '已額滿') {
                actionButtonHtml = `<button class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed" disabled>已額滿</button>`;
            } else {
                // ★ 修改：增加判斷，若角色為「發菇者」，則無法報名
                if (currentUserProfile.role === '發菇者') {
                    actionButtonHtml = `<button class="w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg cursor-default" disabled>僅發布權限</button>`;
                } else {
                    actionButtonHtml = `<button class="signup-button w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition" data-challenge-id="${challenge.id}">報名</button>`;
                }
            }

            const signupCount = challenge.signups ? challenge.signups.length : 0;
            
            let participantsHtml = '';
            if (signupCount > 0) {
                const sortedSignups = [...challenge.signups].sort((a, b) => new Date(a.signed_up_at) - new Date(b.signed_up_at));
                const participantsList = sortedSignups.map((signup, index) => {
                    const rank = index + 1;
                    const rankText = `${rank}${getRankSuffix(rank)}`;
                    const nickname = signup.profile ? signup.profile.nickname : '未知用戶';
                    const time = formatSignupTime(signup.signed_up_at);
                    return `<div class="participant-item"><span><span class="participant-rank">${rankText}</span> ${nickname}</span><span>${time}</span></div>`;
                }).join('');
                participantsHtml = `<div class="participant-list">${participantsList}</div>`;
            }

            let startTimeHtml;
            if (challenge.status === '預計開放' && new Date(challenge.start_time) > new Date()) { 
                startTimeHtml = `<p><strong>等待時間:</strong> <span class="countdown-timer" data-starttime="${challenge.start_time}">計算中...</span></p>`;
            } else {
                startTimeHtml = `<p><strong>開放時間:</strong> ${new Date(challenge.start_time).toLocaleString('zh-TW', { hour12: false })}</p>`;
            }

            let dispatchTagHtml = '';
            if (signupCount > 0) {
                const dispatchStatus = challenge.dispatch_status || '待發';
                const dispatchClass = dispatchStatus === '已發' ? 'dispatch-sent' : 'dispatch-pending';
                const isClickable = isHost ? 'cursor-pointer' : '';
                dispatchTagHtml = `<span class="status-badge ${dispatchClass} ${isClickable} dispatch-status-tag" data-id="${challenge.id}" data-current-status="${dispatchStatus}">${dispatchStatus}</span>`;
            }

            card.innerHTML = `
                <div>
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="${titleClasses}">${challenge.mushroom_type}</h3>
                        <div class="flex items-center space-x-2">
                        ${dispatchTagHtml}
                        <span class="status-badge ${statusClass}">${challenge.status}</span>
                        ${hostControlsHtml}
                        </div>
                    </div>
                    <div class="text-gray-400 space-y-2 mb-4">
                        <p><strong>發菇者:</strong> ${challenge.host ? challenge.host.nickname : '未知'}</p>
                        <p><strong>用餐時段:</strong> ${challenge.details || '未指定'}</p>
                        <p><strong>名額:</strong> <span id="signup-count-${challenge.id}">${signupCount}</span> / ${challenge.slots}</p>
                        ${startTimeHtml}
                    </div>
                    ${participantsHtml}
                </div>
                <div class="mt-4">${actionButtonHtml}</div>
            `;
            
            const existingCard = document.getElementById(card.id);
            if(existingCard) {
                challengesListEl.replaceChild(card, existingCard);
            } else {
                challengesListEl.prepend(card);
            }
        }
        async function reloadChallengeCard(challengeId) {
            const { data: challenge, error } = await supabaseClient
                .from('challenges')
                .select(`*, host:profiles(nickname, id), signups(*, profile:profiles(nickname))`)
                .eq('id', challengeId)
                .single();
            
            if (error) {
                if (error.code === 'PGRST116') {
                    const cardToRemove = document.getElementById(`challenge-${challengeId}`);
                    if(cardToRemove) cardToRemove.remove();
                } else {
                    console.error('重載卡片失敗:', error);
                }
                return;
            }
            renderChallenge(challenge);
            applyFilter();
        }
        
        function setupRealtimeListeners() {
            supabaseClient.channel('public:challenges')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'challenges' }, payload => {
                    const eventType = payload.eventType;
                    const challengeId = eventType === 'DELETE' ? payload.old.id : payload.new.id;
                    if (eventType === 'DELETE') {
                        const cardToRemove = document.getElementById(`challenge-${challengeId}`);
                        if (cardToRemove) cardToRemove.remove();
                    } else {
                        reloadChallengeCard(challengeId);
                    }
                })
                .subscribe();

            supabaseClient.channel('public:signups')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'signups' }, (payload) => {
                    const challengeId = payload.new?.challenge_id || payload.old?.challenge_id;
                    if (challengeId) {
                        fetchUserSignups().then(() => {
                           reloadChallengeCard(challengeId);
                        });
                    }
                })
                .subscribe();
        }

        function setupOnlinePresence() {
            const channel = supabaseClient.channel('online-users', {
                config: {
                    presence: {
                        key: currentUserProfile.nickname,
                    },
                },
            });

            const updatePresence = () => {
                const presenceState = channel.presenceState();
                onlineNicknames = Object.keys(presenceState);
                onlineUsersContainer.querySelector('span').textContent = `在線: ${onlineNicknames.length}人`;
            };

            channel
                .on('presence', { event: 'sync' }, updatePresence)
                .on('presence', { event: 'join' }, updatePresence)
                .on('presence', { event: 'leave' }, updatePresence)
                .subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        await channel.track({ online_at: new Date().toISOString() });
                    }
                });
        }

        document.addEventListener('DOMContentLoaded', initializePage);
        
        refreshButton.addEventListener('click', () => {
            window.location.reload();
        });

        filterTabs.addEventListener('click', (e) => {
            const tab = e.target.closest('.filter-tab');
            if (!tab || tab.classList.contains('active')) return;
            filterTabs.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            activeFilter = tab.dataset.filter;
            applyFilter();
        });
        
        onlineUsersContainer.addEventListener('click', (e) => {
            if(e.target.closest('#refresh-button')) return;

            onlineUsersList.innerHTML = onlineNicknames.map(name => `<li class="p-1">${name}</li>`).join('');
            onlineUsersModal.classList.remove('hidden');
        });
        closeOnlineUsersModalButton.addEventListener('click', () => {
            onlineUsersModal.classList.add('hidden');
        });

        logoutButton.addEventListener('click', async () => {
            logoutButton.disabled = true;
            logoutButton.textContent = '登出中...';
            const { error } = await supabaseClient.auth.signOut();
            if (error) {
                showToast(`登出時發生錯誤: ${error.message}`, true);
                logoutButton.disabled = false;
                logoutButton.textContent = '登出';
            }
        });
        
        // 【必要修正】請用這段程式碼替換掉你原本的 postChallengeButton.addEventListener('click', ...)
        postChallengeButton.addEventListener('click', () => {
            challengeForm.reset();
            challengeForm['mushroom-type'].value = '巨菇';
            challengeForm['slots'].value = 4;
            
            // --- 以下是讀取時間的核心邏輯 ---
            const rememberTimeCheckbox = document.getElementById('remember-time-checkbox');
            const rememberedTime = localStorage.getItem('rememberedChallengeTime');
            
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const datePart = now.toISOString().split('T')[0];

            if (rememberedTime) {
                // 如果 localStorage 中有記憶的時間，就使用它
                challengeForm['start-time'].value = `${datePart}T${rememberedTime}`;
                rememberTimeCheckbox.checked = true; // 並將核取框打勾
            } else {
                // 否則，使用當前時間
                challengeForm['start-time'].value = now.toISOString().slice(0, 16);
                rememberTimeCheckbox.checked = false; // 並取消核取框打勾
            }
            
            challengeModal.classList.remove('hidden');
        });

        cancelModalButton.addEventListener('click', () => challengeModal.classList.add('hidden'));
        
        setTimeNowButton.addEventListener('click', () => {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            challengeForm['start-time'].value = now.toISOString().slice(0, 16);
        });

        challengeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitChallengeButton.disabled = true;
            submitChallengeButton.textContent = '發布中...';

            const form = e.target;
            
            // 【新增】在提交表單時，根據 checkbox 狀態儲存或移除時間
            const rememberTimeCheckbox = document.getElementById('remember-time-checkbox');
            const timeValue = form['start-time'].value; // e.g., "2025-06-22T14:30"

            if (rememberTimeCheckbox.checked && timeValue) {
                const timePart = timeValue.split('T')[1]; // e.g., "14:30"
                localStorage.setItem('rememberedChallengeTime', timePart);
            } else {
                localStorage.removeItem('rememberedChallengeTime');
            }

            const startTime = new Date(timeValue);
            const newChallengeData = {
                host_id: currentUserProfile.id,
                mushroom_type: form['mushroom-type'].value,
                slots: parseInt(form['slots'].value),
                start_time: startTime.toISOString(),
                details: form['details'].value,
                status: startTime > new Date() ? '預計開放' : '開放報名中'
            };

            const { data: insertedChallenge, error } = await supabaseClient
                .from('challenges')
                .insert(newChallengeData)
                .select()
                .single(); 
            
            if (error) {
                showToast(`發布失敗: ${error.message}`, true);
            } else {
                showToast('新挑戰已成功發布！', false);
                challengeModal.classList.add('hidden');
                
                const fullChallengeObject = {
                    ...insertedChallenge,
                    host: { id: currentUserProfile.id, nickname: currentUserProfile.nickname },
                    signups: []
                };
                renderChallenge(fullChallengeObject);
                applyFilter();
            }
            submitChallengeButton.disabled = false;
            submitChallengeButton.textContent = '確認發布';
        });
        
        challengesListEl.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-challenge-button');
            if (deleteButton) {
                challengeToDeleteId = deleteButton.dataset.id;
                deleteConfirmModal.classList.remove('hidden');
                return;
            }

            const editButton = e.target.closest('.edit-challenge-button');
            if (editButton) {
                const challengeId = editButton.dataset.id;
                openEditModal(challengeId);
                return;
            }

            const signupButton = e.target.closest('.signup-button');
            if (signupButton) {
                handleSignUp(signupButton.dataset.challengeId, signupButton);
                return;
            }
            const cancelButton = e.target.closest('.cancel-signup-button');
            if (cancelButton) {
                handleCancelSignUp(cancelButton.dataset.challengeId, cancelButton);
                return;
            }
            const dispatchTag = e.target.closest('.dispatch-status-tag');
            if (dispatchTag && dispatchTag.classList.contains('cursor-pointer')) {
                handleToggleDispatchStatus(dispatchTag.dataset.id, dispatchTag.dataset.currentStatus);
                return;
            }
        });
        
        function openEditModal(challengeId) {
            const challenge = challengesData[challengeId];
            if (!challenge) {
                showToast('找不到挑戰資料，可能已被刪除。', true);
                return;
            }

            document.getElementById('edit-challenge-id').value = challenge.id;
            document.getElementById('edit-mushroom-type').value = challenge.mushroom_type;
            document.getElementById('edit-slots').value = challenge.slots;
            
            const localTime = new Date(challenge.start_time);
            localTime.setMinutes(localTime.getMinutes() - localTime.getTimezoneOffset());
            document.getElementById('edit-start-time').value = localTime.toISOString().slice(0, 16);

            document.getElementById('edit-details').value = challenge.details;
            
            editChallengeModal.classList.remove('hidden');
        }

        cancelEditModalButton.addEventListener('click', () => {
            editChallengeModal.classList.add('hidden');
        });

        // ★ 編輯蘑菇立即發布時間監聽器
        editSetTimeNowButton.addEventListener('click', () => {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            // 將編輯視窗內的時間輸入框，設定為當前時間
            document.getElementById('edit-start-time').value = now.toISOString().slice(0, 16);
        });

        editChallengeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = document.getElementById('submit-edit-challenge-button');
            submitButton.disabled = true;
            submitButton.textContent = '儲存中...';

            const challengeId = document.getElementById('edit-challenge-id').value;
            const newStartTime = new Date(document.getElementById('edit-start-time').value);
            
            const updatedData = {
                mushroom_type: document.getElementById('edit-mushroom-type').value,
                slots: parseInt(document.getElementById('edit-slots').value),
                start_time: newStartTime.toISOString(),
                details: document.getElementById('edit-details').value,
                status: newStartTime > new Date() ? '預計開放' : '開放報名中'
            };

            const { error } = await supabaseClient
                .from('challenges')
                .update(updatedData)
                .eq('id', challengeId);
            
            if (error) {
                showToast(`更新失敗: ${error.message}`, true);
            } else {
                showToast('挑戰已成功更新！', false);
                editChallengeModal.classList.add('hidden');
                reloadChallengeCard(challengeId);
            }

            submitButton.disabled = false;
            submitButton.textContent = '確認儲存';
        });

        async function deleteChallenge(id) {
            confirmDeleteButton.disabled = true;
            confirmDeleteButton.textContent = '刪除中...';
            const { error } = await supabaseClient.from('challenges').delete().eq('id', id);
            
            if (error) {
                showToast(`刪除失敗: ${error.message}`, true);
            } else {
                showToast('挑戰已成功刪除！', false);
                const cardToRemove = document.getElementById(`challenge-${id}`);
                if (cardToRemove) {
                    cardToRemove.remove();
                }
            }
            hideDeleteConfirmModal();
        }
        
        cancelDeleteButton.addEventListener('click', () => hideDeleteConfirmModal());
        confirmDeleteButton.addEventListener('click', () => { if (challengeToDeleteId) deleteChallenge(challengeToDeleteId); });
        function hideDeleteConfirmModal() {
            challengeToDeleteId = null;
            deleteConfirmModal.classList.add('hidden');
            confirmDeleteButton.disabled = false;
            confirmDeleteButton.textContent = '確認刪除';
        }

        async function handleSignUp(challengeId, buttonEl) {
            buttonEl.disabled = true;
            buttonEl.textContent = '報名中...';
            const numericChallengeId = parseInt(challengeId);
            const { error } = await supabaseClient.rpc('signup_for_challenge', {
                challenge_id_to_signup: numericChallengeId
            });

            if (error) {
                showToast(`報名失敗: ${error.message.includes('full') ? '蘑菇已額滿！' : error.message}`, true);
                reloadChallengeCard(challengeId);
            } else {
                showToast('報名成功！', false);
                userSignedUpChallengeIds.add(numericChallengeId);
                reloadChallengeCard(challengeId); 
            }
        }

        async function handleCancelSignUp(challengeId, buttonEl) {
            buttonEl.disabled = true;
            buttonEl.textContent = '取消中...';
            const numericChallengeId = parseInt(challengeId);
            const { error } = await supabaseClient.rpc('cancel_signup_and_update_challenge', {
                challenge_id_to_cancel: numericChallengeId
            });

            if (error) {
                showToast(`取消失敗: ${error.message}`, true);
                reloadChallengeCard(challengeId);
            } else {
                showToast('已取消報名', false);
                userSignedUpChallengeIds.delete(numericChallengeId);
                reloadChallengeCard(challengeId);
            }
        }

        async function handleToggleDispatchStatus(challengeId, currentStatus) {
            const newStatus = currentStatus === '待發' ? '已發' : '待發';
            
            const updateData = { 
                dispatch_status: newStatus,
                dispatched_at: newStatus === '已發' ? new Date().toISOString() : null
            };
            
            const { error } = await supabaseClient
                .from('challenges')
                .update(updateData)
                .eq('id', challengeId);
            
            if (error) {
                showToast(`更新失敗: ${error.message}`, true);
                reloadChallengeCard(challengeId);
            } else {
                reloadChallengeCard(challengeId);
            }
        }
        
        leaderboardButton.addEventListener('click', () => {
            leaderboardModal.classList.remove('hidden');
            const firstTab = leaderboardTabs.querySelector('.leaderboard-tab');
            if(firstTab) {
                switchLeaderboardTab(firstTab);
            }
        });
        closeLeaderboardButton.addEventListener('click', () => {
            leaderboardModal.classList.add('hidden');
        });
        leaderboardTabs.addEventListener('click', (e) => {
            const tab = e.target.closest('.leaderboard-tab');
            if (tab && !tab.classList.contains('active')) {
                switchLeaderboardTab(tab);
            }
        });
        function switchLeaderboardTab(tab) {
            leaderboardTabs.querySelectorAll('.leaderboard-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            const type = tab.dataset.type;
            const period = tab.dataset.period;
            
            fetchLeaderboard(type, period);
        }
        async function fetchLeaderboard(type, period) {
            leaderboardContent.innerHTML = '<p>讀取中...</p>';
            
            const functionName = type === 'count' 
                ? 'get_leaderboard_from_profiles' 
                : 'get_speed_leaderboard_from_profiles';

            const { data, error } = await supabaseClient.rpc(functionName, {
                period_type: period
            });

            if (error) {
                console.error(`獲取 ${type} (${period}) 排行榜失敗:`, error);
                leaderboardContent.innerHTML = `<p class="text-red-400">無法載入排行榜資料。</p>`;
                return;
            }
            
            if (type === 'count') {
                renderCountLeaderboard(data);
            } else {
                renderSpeedLeaderboard(data);
            }
        }
        function renderCountLeaderboard(data) {
            if (!data || data.length === 0) {
                leaderboardContent.innerHTML = '<p>目前沒有紀錄。</p>'; 
                return;
            }

            let rank = 0;
            let lastScore = -1;

            const listHtml = data.map((item, index) => {
                // 如果當前分數與上一位不同，則名次+1
                if (item.signup_count !== lastScore) {
                    rank++;
                }
                lastScore = item.signup_count;

                let rankDisplay;
                if (rank === 1) { rankDisplay = '🥇'; }
                else if (rank === 2) { rankDisplay = '🥈'; }
                else if (rank === 3) { rankDisplay = '🥉'; }
                else { rankDisplay = rank; }

                return `<div class="leaderboard-item"><span class="leaderboard-rank">${rankDisplay}</span><span class="leaderboard-nickname">${item.nickname}</span><span class="leaderboard-count">${item.signup_count} 次</span></div>`;
            }).join('');
            leaderboardContent.innerHTML = listHtml;
        }

        function renderSpeedLeaderboard(data) {
            if (!data || data.length === 0) {
                leaderboardContent.innerHTML = '<p>目前沒有紀錄。</p>'; 
                return;
            }
            
            let rank = 0;
            let lastTime = -1.0;

            const listHtml = data.map((item, index) => {
                const currentTime = parseFloat(item.fastest_time_seconds);

                // 如果當前時間與上一位不同，則名次+1
                if (currentTime !== lastTime) {
                    rank++;
                }
                lastTime = currentTime;

                let rankDisplay;
                if (rank === 1) { rankDisplay = '🥇'; }
                else if (rank === 2) { rankDisplay = '🥈'; }
                else if (rank === 3) { rankDisplay = '🥉'; }
                else { rankDisplay = rank; }
                
                const timeInSeconds = currentTime.toFixed(3);
                return `<div class="leaderboard-item"><span class="leaderboard-rank">${rankDisplay}</span><span class="leaderboard-nickname">${item.nickname}</span><span class="leaderboard-count">${timeInSeconds} s</span></div>`;
            }).join('');
            leaderboardContent.innerHTML = listHtml;
        }
        
        changePasswordButton.addEventListener('click', () => {
            passwordForm.reset();
            passwordModal.classList.remove('hidden');
        });
        cancelPasswordButton.addEventListener('click', () => {
            passwordModal.classList.add('hidden');
        });
        passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            if (newPassword.length < 6) {
                showToast('密碼長度至少需要6位數。', true); return;
            }
            if (newPassword !== confirmPassword) {
                showToast('兩次輸入的新密碼不一致。', true); return;
            }
            submitPasswordButton.disabled = true;
            submitPasswordButton.textContent = '修改中...';
            const { error } = await supabaseClient.auth.updateUser({ password: newPassword });
            if (error) {
                showToast(`密碼修改失敗: ${error.message}`, true);
            } else {
                showToast('密碼修改成功！下次登入時請使用新密碼。', false);
                passwordModal.classList.add('hidden');
            }
            submitPasswordButton.disabled = false;
            submitPasswordButton.textContent = '確認修改';
        });

        function getRankSuffix(rank) {
            if (rank % 100 >= 11 && rank % 100 <= 13) return 'th';
            switch (rank % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }
        function formatSignupTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const timeString = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            const milliseconds = date.getMilliseconds().toString().padStart(3, '0');
            return `${timeString}.${milliseconds}`;
        }
        
        async function triggerChallengeOpening(challengeId, timerElement) {
            if (!timerElement.classList.contains('countdown-timer')) {
                return;
            }
            timerElement.classList.remove('countdown-timer');
            timerElement.textContent = '開放中...';

            const { error } = await supabaseClient
                .from('challenges')
                .update({ status: '開放報名中' })
                .eq('id', challengeId)
                .eq('status', '預計開放');
            
            reloadChallengeCard(challengeId);

            if (error) {
                console.log(`嘗試自動開啟挑戰 ${challengeId} 時，它可能已被其他使用者更新。錯誤訊息: ${error.message}`);
            }
        }

        function updateAllCountdowns() {
            document.querySelectorAll('.countdown-timer').forEach(el => {
                const startTime = new Date(el.dataset.starttime);
                const diff = startTime - new Date();

                if (diff < 1000) {
                    const card = el.closest('.challenge-card');
                    if (card) {
                        const challengeId = parseInt(card.id.split('-')[1]);
                        if (challengeId) {
                            triggerChallengeOpening(challengeId, el);
                        }
                    }
                } else {
                    const days = Math.floor(diff / 86400000);
                    const hours = Math.floor((diff % 86400000) / 3600000);
                    const minutes = Math.floor((diff % 3600000) / 60000);
                    const seconds = Math.floor((diff % 60000) / 1000);
                    if (days > 0) el.textContent = `${days}天${hours}小時後`;
                    else if (hours > 0) el.textContent = `${hours}小時${minutes}分鐘後`;
                    else if (minutes > 0) el.textContent = `${minutes}分鐘${seconds}秒後`;
                    else el.textContent = `${seconds}秒後`;
                }
            });
        }

        function startGlobalCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(updateAllCountdowns, 1000); 
            updateAllCountdowns();
        }
        function showToast(message, isError = false) {
            toastMessage.textContent = message;
            toastMessage.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            toastMessage.classList.remove('hidden');
            setTimeout(() => { toastMessage.classList.add('hidden'); }, 3000);
        }

        function applyFilter() {
            let visibleCount = 0;
            const allCards = challengesListEl.querySelectorAll('.challenge-card');
            
            allCards.forEach(card => {
                let show = false;
                if (activeFilter === 'all') {
                    if (card.dataset.status !== '已額滿') {
                        show = true;
                    }
                } else if (activeFilter === 'full') {
                    if (card.dataset.status === '已額滿') {
                        show = true;
                    }
                } else if (activeFilter === 'signed-up') {
                    if (card.dataset.isSignedUp === 'true') show = true;
                } else if (activeFilter === 'hosted') {
                    if (card.dataset.isHosted === 'true') show = true;
                }
                card.style.display = show ? 'flex' : 'none';
                if(show) visibleCount++;
            });

            const noItemsMessage = document.getElementById('no-items-message');
            if (noItemsMessage) noItemsMessage.remove();

            if(visibleCount === 0 && allCards.length > 0) {
                const p = document.createElement('p');
                p.id = 'no-items-message';
                p.className = 'text-center col-span-full text-gray-400';
                p.textContent = '這個分類下沒有挑戰喔！';
                challengesListEl.appendChild(p);
            }
        }
        // 複製桌面版按鈕事件到行動版
        mobileMenu.querySelector('#leaderboard-button-mobile').addEventListener('click', () => leaderboardButton.click());
        mobileMenu.querySelector('#change-password-button-mobile').addEventListener('click', () => changePasswordButton.click());
        mobileMenu.querySelector('#logout-button-mobile').addEventListener('click', () => logoutButton.click());

        // 處理截圖功能的事件監聽器
        screenshotButton.addEventListener('click', () => {
            const challengesListElement = document.getElementById('challenges-list');
            const originalButtonText = screenshotButton.innerHTML;

            // 提供使用者操作回饋
            screenshotButton.disabled = true;
            screenshotButton.innerHTML = '截圖中...';

            html2canvas(challengesListElement, {
                backgroundColor: '#111827', 
                useCORS: true, 
                scale: 2 
            }).then(canvas => {
                const link = document.createElement('a');
                const now = new Date();
                const timestamp = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
                link.download = `菇菇挑戰列表_${timestamp}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                link.remove();
            }).catch(err => {
                console.error('截圖失敗:', err);
                showToast('截圖失敗，請查看控制台錯誤。', true);
            }).finally(() => {
                screenshotButton.disabled = false;
                screenshotButton.innerHTML = originalButtonText;
            });
        });

        // ★ 新增：漢堡選單開關邏輯
        hamburgerButton.addEventListener('click', (event) => {
            event.stopPropagation(); // 防止事件冒泡到 window
            mobileMenu.classList.toggle('hidden');
        });
        
        // ★ 新增：點擊頁面其他地方時，自動關閉選單
        window.addEventListener('click', (event) => {
            if (!mobileMenu.classList.contains('hidden') && !mobileMenu.contains(event.target)) {
                mobileMenu.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
