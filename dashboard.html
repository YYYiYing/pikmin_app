<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡è‡å®…é…ç¶² - Pikmin Bloom è˜‘è‡å ±åè¡¨5.0</title>
    <link rel="icon" href="./mashroom_s.png" type="image/png">
    <link rel="apple-touch-icon" href="./mashroom_s.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .header-gradient {
            background: #1f2937;
            border-bottom: 1px solid #374151;
        }
        .challenge-card {
            background-color: #1f2937;
            border: 1px solid #374151;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex; 
            flex-direction: column;
            justify-content: space-between;
        }
        .challenge-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.25);
            border-color: #4f46e5;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-weight: bold;
            font-size: 0.8rem;
            text-transform: uppercase;
            white-space: nowrap; /* â˜… æ–°å¢é€™è¡Œï¼šå¼·åˆ¶æ¨™ç±¤å…§æ–‡å­—ä¸æ›è¡Œ */
        }

        .status-open { background-color: #10b981; color: white; }
        .status-full { background-color: #ef4444; color: white; }
        .status-pending { background-color: #f59e0b; color: white; }
        
        .dispatch-pending { background-color: #4b5563; color: white; }
        .dispatch-sent { background-color: #14b8a6; color: white; }

        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); }
        .modal-content {
            background-color: #1f2937;
            border: 1px solid #374151;
        }
        .dark-input {
            background-color: #374151;
            border-color: #4b5563;
            color: #d1d5db;
        }
        .dark-input:focus {
            --tw-ring-color: #4f46e5;
            border-color: #4f46e5;
        }
        .participant-list {
            border-top: 1px solid #374151;
            margin-top: 1rem;
            padding-top: 1rem;
        }
        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #d1d5db;
        }
        .participant-rank {
            font-weight: bold;
            color: #6366f1; /* indigo-500 */
        }

        .leaderboard-tab {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .leaderboard-tab.active {
            border-color: #4f46e5;
            color: #a5b4fc;
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #374151;
        }
        .leaderboard-rank {
            font-size: 1.2rem;
            font-weight: bold;
            width: 40px;
            text-align: center;
        }
        .leaderboard-nickname {
            flex-grow: 1;
        }
        .leaderboard-count {
            font-weight: bold;
        }
        .filter-tab {
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 9999px;
            transition: all 0.2s ease;
            font-weight: 600;
        }
        .filter-tab.active {
            background-color: #4f46e5;
            color: white;
        }
        .filter-tab:not(.active) {
            background-color: #374151;
            color: #d1d5db;
        }
        .filter-tab:not(.active):hover {
            background-color: #4b5563;
        }
        .filter-tab:not(.active):hover {
            background-color: #4b5563;
        }
        
        /* ä¿®æ”¹ï¼šè·‘é¦¬ç‡ˆå‹•ç•« (æ”¹ç‚ºç”± JS æ§åˆ¶é‡æ’­) */
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .animate-marquee {
            /* é€™è£¡çš„æ™‚é–“ 20s æ˜¯é è¨­å€¼ï¼Œç¨å¾Œ JS æœƒå‹•æ…‹è¦†å¯« */
            animation: marquee 20s linear forwards; 
            padding-left: 0; /* ç§»é™¤ä¹‹å‰çš„ paddingï¼Œç”± transform æ§åˆ¶ä½ç½® */
            display: inline-block;
            white-space: nowrap;
        }

        /* æ–°å¢ï¼šå†·å»ä¸­çš„æŒ‰éˆ•æ¨£å¼ */
        .btn-cooldown {
            background-color: #4b5563 !important; /* ç°è‰² */
            cursor: not-allowed !important;
            filter: grayscale(100%);
            transform: none !important;
        }
    </style>
</head>
<body class="bg-gray-900">

<header class="header-gradient shadow-md sticky top-0 z-20">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center relative">
        
        <div class="flex items-center gap-4">
            <button id="hamburger-button" class="p-2 md:hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-list text-white" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                </svg>
            </button>
            
            <div class="flex items-center gap-2">
                <h1 class="text-xl font-bold text-white flex items-center">
                    <img src="./mashroom.png" alt="Pikmin Logo" class="w-10 h-10 mr-2 rounded-full flex-shrink-0">
                    <span class="hidden md:inline-block">è‡è‡å®…é…ç¶²</span>
                </h1>

                <div id="online-users-container" class="flex items-center gap-2 text-sm text-white cursor-pointer hover:text-gray-300 transition whitespace-nowrap" title="æŸ¥çœ‹åœ¨ç·šåˆ—è¡¨">
                    <span></span>
                    <button id="refresh-button" title="é‡æ–°æ•´ç†" class="hover:text-white transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-x-4 flex-wrap justify-end">
            <span id="user-info" class="font-semibold text-gray-200 text-sm text-center">è®€å–ä¸­...</span>
            <span id="daily-quota-display" class="text-sm text-gray-400 border-l border-gray-600 pl-4 ml-2"></span>
            
            <div class="hidden md:flex items-center gap-x-4">
                <button id="leaderboard-button" class="text-gray-300 hover:text-white transition text-sm">ğŸ† æ’è¡Œæ¦œ</button>
                <a href="./partner.html" class="text-gray-300 hover:text-white transition text-sm">ğŸ¤ æ‘æ°‘å¥½å‹ç¢¼</a>
                <a href="https://joystick-gpx-convert.netlify.app/" target="_blank" class="text-gray-300 hover:text-white transition text-sm">ğŸ”ƒ è·¯å¾‘è½‰æª”</a>
                <a id="gpx-generator-link" href="./gpx_generator.html" class="text-green-400 hover:text-green-300 font-bold transition text-sm">ğŸ—ºï¸ è·¯å¾‘ç”Ÿæˆ</a>
                <a id="admin-link" href="./admin.html" class="hidden text-orange-400 hover:text-orange-300 font-bold transition text-sm">âš™ï¸ ç®¡ç†å¾Œå°</a>
                <button id="change-password-button" class="bg-gray-700 text-white px-3 py-1.5 text-xs rounded-full font-bold hover:bg-gray-600 transition">ãŠ™ï¸ æ”¹å¯†ç¢¼</button>
                <button id="logout-button" class="bg-red-700 text-white px-3 py-1.5 text-xs rounded-full font-bold hover:bg-red-600 transition">ğŸƒâ€â™‚ï¸ ç™»å‡º</button>
            </div>
        </div>

        <div id="mobile-menu" class="hidden absolute top-full left-0 mt-2 w-48 bg-gray-800 rounded-lg shadow-lg p-2">
            <div class="space-y-1">
                <button id="leaderboard-button-mobile" class="w-full text-left text-gray-300 hover:bg-gray-700 p-2 rounded-md">ğŸ† æ’è¡Œæ¦œ</button>
                <a href="./partner.html" class="block text-gray-300 hover:bg-gray-700 p-2 rounded-md">ğŸ¤ æ‘æ°‘å¥½å‹ç¢¼</a>
                <a href="https://joystick-gpx-convert.netlify.app/" target="_blank" class="block text-gray-300 hover:bg-gray-700 p-2 rounded-md">ğŸ”ƒ è·¯å¾‘è½‰æª”</a>
                <a id="gpx-generator-link-mobile" href="./gpx_generator.html" class="block text-green-400 hover:bg-gray-700 p-2 rounded-md font-bold">ğŸ—ºï¸ è·¯å¾‘ç”Ÿæˆ</a>
            </div>
            <hr class="border-gray-600 my-2">
            <div class="space-y-1">
                <a id="admin-link-mobile" href="./admin.html" class="hidden block text-orange-400 hover:bg-gray-700 p-2 rounded-md font-bold">âš™ï¸ ç®¡ç†å¾Œå°</a>
            </div>
            <hr class="border-gray-600 my-2">
            <div class="space-y-1">
                <button id="change-password-button-mobile" class="w-full text-left text-gray-300 hover:bg-gray-700 p-2 rounded-md">ãŠ™ï¸ æ”¹å¯†ç¢¼</button>
                <button id="logout-button-mobile" class="w-full text-left text-red-400 hover:bg-gray-700 p-2 rounded-md">ğŸƒâ€â™‚ï¸ ç™»å‡º</button>
            </div>
        </div>
        
    </div>
</header>

    <div class="bg-gray-800 border-b border-gray-700 py-2 overflow-hidden">
        <div class="container mx-auto px-4 relative flex items-center">
            <span class="text-xs font-bold text-yellow-400 mr-2 flex-shrink-0">âš¡ å¿«è¨Š |</span>
            <div class="overflow-hidden w-full">
                <div id="marquee-content" class="whitespace-nowrap text-xs text-gray-300 animate-marquee inline-block">
                    è®€å–æ¦®è­½æ¦œä¸­...
                </div>
            </div>
        </div>
    </div>

    <div class="w-full bg-gray-900 border-b border-gray-700">
        <div id="wishing-well-section" class="container mx-auto px-4 flex items-stretch h-4 md:h-4 relative group">
            
            <div id="wish-action-area" class="w-20 md:w-24 flex-shrink-0 flex items-center justify-center bg-gray-800 border-r border-gray-700 hover:bg-gray-700 transition cursor-pointer text-gray-200 select-none">
                <button id="open-wish-modal-btn" class="flex items-center gap-1 text-[10px] md:text-xs font-bold focus:outline-none pointer-events-none">
                    <span class="animate-pulse">âœ¨</span> 
                    <span>é»æˆ‘è¨±é¡˜</span>
                </button>
                
                <span id="wished-message" class="hidden flex items-center gap-1 text-[10px] md:text-xs font-bold text-green-400 cursor-default">
                    <span>âœ…</span>
                    <span class="hidden md:inline">æ˜æ—¥å†ä¾†</span>
                    <span class="md:hidden">OK</span>
                </span>
            </div>

            <div id="wishing-well-bar" class="flex-grow flex items-center relative overflow-hidden bg-gray-900 cursor-pointer" title="é»æ“ŠæŸ¥çœ‹è©³ç´°æ•¸æ“š">
                <div class="w-full text-center text-[10px] md:text-xs text-gray-500">å°šç„¡è¨±é¡˜æ•¸æ“š</div>
            </div>
        </div>
    </div>

    <div id="wish-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-sm rounded-2xl shadow-xl p-6 bg-gray-800 border border-gray-600">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">âœ¨ è¨±é¡˜æ± </h3>
                <button id="close-wish-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <p class="text-sm text-gray-400 mb-4">è«‹é¸æ“‡æ‚¨æœ€æƒ³è¦çš„ç²¾è¯ (æœ€å¤šå¯é¸ 3 ç¨®)</p>
            
            <div class="grid grid-cols-2 gap-3 mb-6" id="wish-options">
                
                <label class="flex items-center space-x-2 p-3 rounded-lg border border-gray-600 bg-gray-700/50 cursor-pointer hover:bg-gray-700 transition select-none">
                    <input type="checkbox" value="å·¨è‡" class="wish-checkbox form-checkbox h-5 w-5 text-indigo-500 rounded border-gray-500 bg-gray-600 focus:ring-0 focus:ring-offset-0">
                    <span class="text-gray-200 font-bold flex items-center">
                        <span class="text-3xl mr-1 filter drop-shadow-md">ğŸ„</span> 
                        <span>å·¨è‡</span>
                    </span>
                </label>

                <label class="flex items-center space-x-2 p-3 rounded-lg border border-gray-600 bg-gray-700/50 cursor-pointer hover:bg-gray-700 transition select-none">
                    <input type="checkbox" value="æ´»å‹•è‡" class="wish-checkbox form-checkbox h-5 w-5 text-indigo-500 rounded border-gray-500 bg-gray-600 focus:ring-0 focus:ring-offset-0">
                    <span class="text-gray-200 font-bold flex items-center">
                        <span class="text-xl mr-1 filter drop-shadow-md">ğŸ„</span> 
                        <span>æ´»å‹•è‡</span>
                    </span>
                </label>

                <label class="flex items-center space-x-2 p-3 rounded-lg border border-gray-600 bg-gray-700/50 cursor-pointer hover:bg-gray-700 transition select-none">
                    <input type="checkbox" value="ç™½" class="wish-checkbox form-checkbox h-5 w-5 text-indigo-500 rounded border-gray-500 bg-gray-600 focus:ring-0 focus:ring-offset-0">
                    <span class="text-gray-200 font-bold">âšª ç™½è‰²</span>
                </label>
                <label class="flex items-center space-x-2 p-3 rounded-lg border border-gray-600 bg-gray-700/50 cursor-pointer hover:bg-gray-700 transition select-none">
                    <input type="checkbox" value="ç´…" class="wish-checkbox form-checkbox h-5 w-5 text-indigo-500 rounded border-gray-500 bg-gray-600 focus:ring-0 focus:ring-offset-0">
                    <span class="text-red-400 font-bold">ğŸ”´ ç´…è‰²</span>
                </label>
                <label class="flex items-center space-x-2 p-3 rounded-lg border border-gray-600 bg-gray-700/50 cursor-pointer hover:bg-gray-700 transition select-none">
                    <input type="checkbox" value="é»ƒ" class="wish-checkbox form-checkbox h-5 w-5 text-indigo-500 rounded border-gray-500 bg-gray-600 focus:ring-0 focus:ring-offset-0">
                    <span class="text-yellow-400 font-bold">ğŸŸ¡ é»ƒè‰²</span>
                </label>
                <label class="flex items-center space-x-2 p-3 rounded-lg border border-gray-600 bg-gray-700/50 cursor-pointer hover:bg-gray-700 transition select-none">
                    <input type="checkbox" value="è—" class="wish-checkbox form-checkbox h-5 w-5 text-indigo-500 rounded border-gray-500 bg-gray-600 focus:ring-0 focus:ring-offset-0">
                    <span class="text-blue-400 font-bold">ğŸ”µ è—è‰²</span>
                </label>
            </div>

            <button id="submit-wish-btn" class="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold rounded-xl shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                é€å‡ºè¨±é¡˜
            </button>
        </div>
    </div>

    <main class="container mx-auto p-4 md:p-8">
        <div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4 flex-wrap justify-center">
                
            <div id="filter-tabs" class="flex space-x-2 overflow-x-auto no-scrollbar">
                <button data-filter="all" class="filter-tab active text-xs md:text-base whitespace-nowrap px-3 md:px-4">å…¨éƒ¨æŒ‘æˆ°</button>
                <button data-filter="full" class="filter-tab text-xs md:text-base whitespace-nowrap px-3 md:px-4">å·²é¡æ»¿</button>
                <button data-filter="signed-up" class="filter-tab text-xs md:text-base whitespace-nowrap px-3 md:px-4">æˆ‘çš„å ±å</button>
                <button id="hosted-tab" data-filter="hosted" class="filter-tab hidden text-xs md:text-base whitespace-nowrap px-3 md:px-4">æˆ‘çš„ç™¼å¸ƒ</button>
            </div>
                
                <div class="flex items-center space-x-2 ml-2">
                    <button id="signup-sub-button" class="text-gray-400 hover:text-indigo-400 transition text-xs md:text-base flex items-center gap-1" title="è¨‚é–±æ–°è˜‘è‡é€šçŸ¥">
                        <span id="signup-email-icon">ğŸ“§</span> <span id="signup-email-text">å ±åé€šçŸ¥</span>
                    </button>
                    <button id="full-sub-button" class="text-gray-400 hover:text-red-400 transition text-xs md:text-base flex items-center gap-1" title="è¨‚é–±è˜‘è‡é¡æ»¿é€šçŸ¥">
                        <span id="full-email-icon">ğŸ””</span> <span id="full-email-text">é¡æ»¿é€šçŸ¥</span>
                    </button>
                </div>

                <button id="screenshot-button" class="text-gray-400 hover:text-white transition text-xs md:text-base">ğŸ“¸ æˆªåœ–</button>
            </div>
            <button id="post-challenge-button" class="hidden bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition transform hover:scale-105 w-full md:w-auto">
                ğŸ„ ç™¼å¸ƒæ–°æŒ‘æˆ°
            </button>
        </div>
        <div id="challenges-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <p id="loading-indicator" class="text-center col-span-full text-gray-400">æ­£åœ¨è¼‰å…¥æŒ‘æˆ°åˆ—è¡¨ï¼Œè«‹ç¨å€™...</p>
        </div>
    </main>
    
    <div id="online-users-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-xs rounded-2xl shadow-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-100">åœ¨ç·šäººå“¡</h2>
                <button type="button" id="close-online-users-modal" class="text-gray-500 hover:text-white text-2xl">&times;</button>
            </div>
            <ul id="online-users-list" class="space-y-2 max-h-64 overflow-y-auto text-gray-300"></ul>
        </div>
    </div>

    <!-- åŒæ­¥å‰©é¤˜æ™‚é–“ Modal -->
    <div id="sync-time-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-sm rounded-2xl shadow-xl p-8">
            <h2 class="text-xl font-bold mb-4 text-gray-100">â±ï¸ è¨­å®šè˜‘è‡å‰©é¤˜æ™‚é–“</h2>
            <p class="text-sm text-gray-400 mb-6">è«‹è¼¸å…¥éŠæˆ²ä¸­é¡¯ç¤ºçš„å‰©é¤˜æ™‚é–“ï¼Œç³»çµ±å°‡è‡ªå‹•è¨ˆç®—çµæŸæ™‚é–“ã€‚</p>
            
            <form id="sync-time-form">
                <input type="hidden" id="sync-challenge-id">
                <div class="flex space-x-2 mb-6">
                    <div class="flex-1">
                        <label class="block text-xs text-gray-400 mb-1">å¤©</label>
                        <input type="number" id="sync-days" min="0" value="0" class="dark-input w-full rounded-md text-center">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs text-gray-400 mb-1">å°æ™‚</label>
                        <input type="number" id="sync-hours" min="0" max="23" value="0" class="dark-input w-full rounded-md text-center">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs text-gray-400 mb-1">åˆ†é˜</label>
                        <input type="number" id="sync-minutes" min="0" max="59" value="0" class="dark-input w-full rounded-md text-center">
                    </div>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-sync-button" class="px-4 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">å–æ¶ˆ</button>
                    <button type="button" id="clear-sync-button" class="px-4 py-2 bg-red-800 text-white rounded-lg font-semibold hover:bg-red-700">æ¸…é™¤æ™‚é–“</button>
                    <button type="submit" id="confirm-sync-button" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700">æ›´æ–°</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- æ–°å¢/ç™¼å¸ƒæŒ‘æˆ° Modal -->
    <div id="challenge-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
            <div class="modal-content w-full max-w-lg rounded-2xl shadow-xl p-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-100">ç™¼å¸ƒä¸€å€‹æ–°æŒ‘æˆ°</h2>
                <form id="challenge-form">
                <div class="space-y-4">
                    <div>
                        <label for="mushroom-type" class="block text-sm font-medium text-gray-400">è˜‘è‡ç¨®é¡</label>
                        <select id="mushroom-type" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="å·¨è‡" selected>å·¨è‡</option>
                            <option value="æ´»å‹•è‡">æ´»å‹•è‡</option>
                            <option value="ç¾ç‰‡è‡">ç¾ç‰‡è‡</option>
                            <option value="å¤§æ™¶">å¤§æ™¶</option>
                            <option value="å¤§ç«">å¤§ç«</option>
                            <option value="å¤§æ°´">å¤§æ°´</option>
                            <option value="å¤§é›»">å¤§é›»</option>
                            <option value="å¤§æ¯’">å¤§æ¯’</option>
                            <option value="å¤§å†°è—">å¤§å†°è—</option>
                            <option value="å¤§ç´…">å¤§ç´…</option>
                            <option value="å¤§é»ƒ">å¤§é»ƒ</option>
                            <option value="å¤§è—">å¤§è—</option>
                            <option value="å¤§ç´«">å¤§ç´«</option>
                            <option value="å¤§ç²‰">å¤§ç²‰</option>
                            <option value="å¤§ç°">å¤§ç°</option>
                            <option value="å¤§ç™½">å¤§ç™½</option>
                            <option value="æ™¶">æ™¶</option>
                            <option value="æ°´">æ°´</option>
                            <option value="ç«">ç«</option>
                            <option value="é›»">é›»</option>
                            <option value="æ¯’">æ¯’</option>
                            <option value="æ¸¬è©¦">æ¸¬è©¦</option>
                        </select>
                    </div>

                    <div>
                        <label for="slots" class="block text-sm font-medium text-gray-400">åé¡</label>
                        <input type="number" id="slots" min="1" required class="dark-input mt-1 block w-full rounded-md shadow-sm" value="4">
                    </div>

                    <div>
                        <div class="flex justify-between items-center">
                            <label for="start-time" class="block text-sm font-medium text-gray-400">é–‹æ”¾å ±åæ™‚é–“</label>
                            <button type="button" id="set-time-now-button" class="text-xs bg-indigo-500 text-white px-2 py-1 rounded-md hover:bg-indigo-600">ç«‹å³é–‹æ”¾</button>
                        </div>
                        <input type="datetime-local" id="start-time" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                        
                        <div class="mt-2 flex items-center">
                            <input id="remember-time-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:bg-gray-600 dark:border-gray-500">
                            <label for="remember-time-checkbox" class="ml-2 block text-sm text-gray-400">è¨˜ä½æ™‚é–“ (ä¸‹æ¬¡è‡ªå‹•å¸¶å…¥)</label>
                        </div>
                    </div>

                    <div>
                        <label for="details" class="block text-sm font-medium text-gray-400">ç”¨é¤æ™‚æ®µ</label>
                        <select id="details" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="å®µå¤œ" selected>å®µå¤œ</option>
                            <option value="æ—©é¤">æ—©é¤</option>
                            <option value="åˆé¤">åˆé¤</option>
                            <option value="ä¸‹åˆèŒ¶">ä¸‹åˆèŒ¶</option>
                            <option value="æ™šé¤">æ™šé¤</option>
                            <option value="æ»¿äººé–‹">æ»¿äººé–‹</option>
                        </select>
                    </div>
                    <div>
                        <label for="cooking-style" class="block text-sm font-medium text-gray-400">ç«ä¾¯</label>
                        <select id="cooking-style" class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="å¤§ç«å¿«ç‚’ï¼ˆæˆ°åŠ›å…¨é–‹ï¼‰">å¤§ç«å¿«ç‚’ï¼ˆæˆ°åŠ›å…¨é–‹ï¼‰</option>
                            <option value="ç´°ç«æ…¢ç‡‰ï¼ˆæ§åˆ¶æˆ°åŠ›ï¼‰">ç´°ç«æ…¢ç‡‰ï¼ˆæ§åˆ¶æˆ°åŠ›ï¼‰</option>
                            <option value="éš¨ä¾¿äº‚ç‚’ï¼ˆä¸é™æˆ°åŠ›ï¼‰"selected>éš¨ä¾¿äº‚ç‚’ï¼ˆä¸é™æˆ°åŠ›ï¼‰</option>
                        </select>
                    </div>

                    <div>
                        <label for="challenge-image" class="block text-sm font-medium text-gray-400">è˜‘è‡ç¾ç‰‡ (é¸å¡«)</label>
                        <input type="file" id="challenge-image" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 mt-1"/>
                        <p class="text-xs text-gray-500 mt-1">å¯ä¸Šå‚³æ˜ä¿¡ç‰‡åœ–æª”ï¼Œæ”¯æ´jpg, pngæ ¼å¼ï¼Œæª”æ¡ˆåˆ¥å¤ªå¤§ã€‚</p>
                    </div>
                    </div>

                <div class="mt-8 flex justify-end space-x-4">       
                    <button type="button" id="cancel-modal-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">å–æ¶ˆ</button>
                    <button type="submit" id="submit-challenge-button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-50">ç¢ºèªç™¼å¸ƒ</button>
                </div>
                </form>
            </div>
        </div>

    <!-- ç·¨è¼¯æŒ‘æˆ° Modal -->
<div id="edit-challenge-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-xl p-8">
            <h2 class="text-2xl font-bold mb-6 text-gray-100">ç·¨è¼¯æŒ‘æˆ°å…§å®¹</h2>
            <form id="edit-challenge-form">
                <input type="hidden" id="edit-challenge-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-mushroom-type" class="block text-sm font-medium text-gray-400">è˜‘è‡ç¨®é¡</label>
                        <select id="edit-mushroom-type" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="å·¨è‡">å·¨è‡</option>
                            <option value="æ´»å‹•è‡">æ´»å‹•è‡</option>
                            <option value="ç¾ç‰‡è‡">ç¾ç‰‡è‡</option>
                            <option value="å¤§æ™¶">å¤§æ™¶</option>
                            <option value="å¤§ç«">å¤§ç«</option>
                            <option value="å¤§æ°´">å¤§æ°´</option>
                            <option value="å¤§é›»">å¤§é›»</option>
                            <option value="å¤§æ¯’">å¤§æ¯’</option>
                            <option value="å¤§å†°è—">å¤§å†°è—</option>
                            <option value="å¤§ç´…">å¤§ç´…</option>
                            <option value="å¤§é»ƒ">å¤§é»ƒ</option>
                            <option value="å¤§è—">å¤§è—</option>
                            <option value="å¤§ç´«">å¤§ç´«</option>
                            <option value="å¤§ç²‰">å¤§ç²‰</option>
                            <option value="å¤§ç°">å¤§ç°</option>
                            <option value="å¤§ç™½">å¤§ç™½</option>
                            <option value="æ™¶">æ™¶</option>
                            <option value="æ°´">æ°´</option>
                            <option value="ç«">ç«</option>
                            <option value="é›»">é›»</option>
                            <option value="æ¯’">æ¯’</option>
                            <option value="æ¸¬è©¦">æ¸¬è©¦</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-slots" class="block text-sm font-medium text-gray-400">åé¡</label>
                        <input type="number" id="edit-slots" min="1" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                    </div>
                    <div>
                        <div class="flex justify-between items-center">
                            <label for="edit-start-time" class="block text-sm font-medium text-gray-400">é–‹æ”¾å ±åæ™‚é–“</label>
                            <button type="button" id="edit-set-time-now-button" class="text-xs bg-indigo-500 text-white px-2 py-1 rounded-md hover:bg-indigo-600">ç«‹å³é–‹æ”¾</button>
                        </div>
                        <input type="datetime-local" id="edit-start-time" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="edit-details" class="block text-sm font-medium text-gray-400">ç”¨é¤æ™‚æ®µ</label>
                        <select id="edit-details" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="å®µå¤œ" selected>å®µå¤œ</option>
                            <option value="æ—©é¤">æ—©é¤</option>
                            <option value="åˆé¤">åˆé¤</option>
                            <option value="ä¸‹åˆèŒ¶">ä¸‹åˆèŒ¶</option>
                            <option value="æ™šé¤">æ™šé¤</option>
                            <option value="æ»¿äººé–‹">æ»¿äººé–‹</option>                
                        </select>
                    </div>
                    
                    <div>
                        <label for="edit-cooking-style" class="block text-sm font-medium text-gray-400">ç«ä¾¯</label>
                        <select id="edit-cooking-style" class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="å¤§ç«å¿«ç‚’ï¼ˆæˆ°åŠ›å…¨é–‹ï¼‰">å¤§ç«å¿«ç‚’ï¼ˆæˆ°åŠ›å…¨é–‹ï¼‰</option>
                            <option value="ç´°ç«æ…¢ç‡‰ï¼ˆæ§åˆ¶æˆ°åŠ›ï¼‰">ç´°ç«æ…¢ç‡‰ï¼ˆæ§åˆ¶æˆ°åŠ›ï¼‰</option>
                            <option value="éš¨ä¾¿äº‚ç‚’ï¼ˆä¸é™æˆ°åŠ›ï¼‰">éš¨ä¾¿äº‚ç‚’ï¼ˆä¸é™æˆ°åŠ›ï¼‰</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-challenge-image" class="block text-sm font-medium text-gray-400">è˜‘è‡ç¾ç‰‡ (é¸å¡«)</label>
                        <input type="file" id="edit-challenge-image" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 mt-1"/>
                        <p class="text-xs text-gray-500 mt-1">å¯ä¸Šå‚³æ˜ä¿¡ç‰‡åœ–æª”ï¼Œæ”¯æ´jpg, pngæ ¼å¼ï¼Œæª”æ¡ˆåˆ¥å¤ªå¤§ã€‚</p>
                    </div>
                    </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="cancel-edit-modal-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">å–æ¶ˆ</button>
                    <button type="submit" id="submit-edit-challenge-button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-50">ç¢ºèªå„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
            <div class="modal-content w-full max-w-sm rounded-2xl shadow-xl p-8">
                <h2 class="text-xl font-bold mb-4 text-white">ç¢ºèªåˆªé™¤</h2>
                <p class="text-gray-400 mb-6">æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹æŒ‘æˆ°å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-delete-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">å–æ¶ˆ</button>
                    <button type="button" id="confirm-delete-button" class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 disabled:opacity-50">ç¢ºèªåˆªé™¤</button>
                </div>
            </div>
        </div>

        <div id="leaderboard-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-xl p-8 flex flex-col max-h-[90vh]">
            
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-100">ğŸ† æ¦®è­½æ¦œ</h2>
                    <p class="text-xs text-gray-400 mt-1">æ¯ 30 åˆ†é˜æ›´æ–°ä¸€æ¬¡æ•¸æ“š</p>
                </div>
                <button type="button" id="close-leaderboard-button" class="text-gray-500 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            
            <div class="flex justify-center mb-4">
                <div class="bg-gray-700 p-1 rounded-lg inline-flex w-full sm:w-auto">
                    <button id="period-week-btn" class="flex-1 sm:flex-none px-6 py-1.5 rounded-md text-sm font-bold transition bg-indigo-600 text-white shadow-sm">æœ¬é€±æ’è¡Œ</button>
                    <button id="period-month-btn" class="flex-1 sm:flex-none px-6 py-1.5 rounded-md text-sm font-bold text-gray-400 hover:text-gray-200 transition">æœ¬æœˆæ’è¡Œ</button>
                </div>
            </div>

            <div class="flex justify-center mb-4">
                <div id="leaderboard-tabs" class="bg-gray-700 p-1 rounded-lg inline-flex w-full sm:w-auto">
                    <button data-type="host" class="flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition bg-indigo-600 text-white shadow-sm">ğŸ„ ç™¼è‡ç‹</button>
                    <button data-type="count" class="flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-bold text-gray-400 hover:text-gray-200 transition">ğŸ“ å ±åç‹</button>
                    <button data-type="speed" class="flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-bold text-gray-400 hover:text-gray-200 transition">âš¡ æœ€é€Ÿå‚³èªª</button>
                </div>
            </div>

            <div id="leaderboard-content" class="space-y-2 overflow-y-auto flex-grow min-h-[200px]">
                <p class="text-center text-gray-500 mt-8">è®€å–ä¸­...</p>
            </div>
        </div>
    </div>

        <div id="image-viewer-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" onclick="closeImageViewer()">
        <div class="relative max-w-3xl w-full max-h-[90vh] flex justify-center p-2" onclick="event.stopPropagation()">
            <button type="button" onclick="closeImageViewer()" class="absolute top-4 right-4 text-white text-3xl hover:text-gray-300 font-bold bg-black/50 rounded-full w-10 h-10 flex items-center justify-center">&times;</button>
            <img id="viewer-image" src="" alt="è˜‘è‡ç¾ç‰‡" class="rounded-lg shadow-2xl max-h-[85vh] object-contain bg-gray-900">
        </div>
        </div>

        <div id="password-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
            <div class="modal-content w-full max-w-md rounded-2xl shadow-xl p-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-100">ä¿®æ”¹å¯†ç¢¼</h2>
                <form id="password-form">
                    <div class="space-y-4">
                        <div>
                            <label for="new-password" class="block text-sm font-medium text-gray-400">æ–°å¯†ç¢¼ (è‡³å°‘6ä½æ•¸)</label>
                            <input type="password" id="new-password" required minlength="6" class="dark-input mt-1 block w-full rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="confirm-password" class="block text-sm font-medium text-gray-400">ç¢ºèªæ–°å¯†ç¢¼</label>
                            <input type="password" id="confirm-password" required minlength="6" class="dark-input mt-1 block w-full rounded-md shadow-sm">
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end space-x-4">
                        <button type="button" id="cancel-password-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">å–æ¶ˆ</button>
                        <button type="submit" id="submit-password-button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-50">ç¢ºèªä¿®æ”¹</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="toast-message" class="hidden fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg"></div>

<script>
    // =========================================================================
    // 1. åˆå§‹åŒ–é…ç½®èˆ‡å…¨åŸŸè®Šæ•¸ (Configuration & Globals)
    // =========================================================================
    const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ';
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ä½¿ç”¨è€…èˆ‡è³‡æ–™ç‹€æ…‹
    let currentUserProfile = null;
    let challengesData = {};        // å„²å­˜æ‰€æœ‰æŒ‘æˆ°è³‡æ–™ (Key: ID)
    let userSignedUpChallengeIds = new Set(); // ä½¿ç”¨è€…å·²å ±åçš„ ID
    let onlineNicknames = [];       // åœ¨ç·šåå–®
    
    // æ§åˆ¶ç‹€æ…‹
    let countdownInterval = null;   // å…¨åŸŸè¨ˆæ™‚å™¨
    let activeFilter = 'all';       // ç¯©é¸æ¢ä»¶
    let globalCooldownUntil = 0;    // æŒ‰éˆ•å†·å»æ™‚é–“æˆ³è¨˜
    let globalCooldownTimer = null; // å†·å»å€’æ•¸è¨ˆæ™‚å™¨
    let challengeToDeleteId = null; // å¾…åˆªé™¤ ID

    // æ’è¡Œæ¦œç‹€æ…‹
    let currentLeaderboardPeriod = 'week'; 
    let currentLeaderboardType = 'host';   

    // è˜‘è‡æ¨£å¼è¨­å®š (å¡ç‰‡ç”¨)
    const mushroomStyles = {
        'å·¨è‡':     { bg: 'bg-cyan-400',     text: 'text-black' },
        'æ´»å‹•è‡':   { bg: 'bg-lime-400',     text: 'text-black' },
        'ç¾ç‰‡è‡':   { bg: 'bg-[#ff0080]',    text: 'text-white' },
        'å¤§ç«':     { bg: 'bg-red-600',      text: 'text-white' },
        'ç«':       { bg: 'bg-red-600',      text: 'text-white' },
        'å¤§ç´…':     { bg: 'bg-red-600',      text: 'text-white' },
        'å¤§é›»':     { bg: 'bg-yellow-400',   text: 'text-black' },
        'é›»':       { bg: 'bg-yellow-400',   text: 'text-black' },
        'å¤§é»ƒ':     { bg: 'bg-yellow-400',   text: 'text-black' },
        'å¤§æ°´':     { bg: 'bg-blue-600',     text: 'text-white' },
        'æ°´':       { bg: 'bg-blue-600',     text: 'text-white' },
        'å¤§è—':     { bg: 'bg-blue-600',     text: 'text-white' },
        'å¤§æ™¶':     { bg: 'bg-sky-300',      text: 'text-black' },
        'æ™¶':       { bg: 'bg-sky-300',      text: 'text-black' },
        'å¤§å†°è—':   { bg: 'bg-sky-300',      text: 'text-black' },
        'å¤§æ¯’':     { bg: 'bg-green-700',    text: 'text-white' },
        'æ¯’':       { bg: 'bg-green-700',    text: 'text-white' },
        'å¤§ç™½':     { bg: 'bg-white',        text: 'text-black' },
        'å¤§ç´«':     { bg: 'bg-purple-600',   text: 'text-white' },
        'å¤§ç²‰':     { bg: 'bg-pink-300',     text: 'text-black' },
        'å¤§ç°':     { bg: 'bg-gray-500',     text: 'text-white' },
        'æ¸¬è©¦':     { bg: 'bg-black',        text: 'text-white' },
    };

    // è¨±é¡˜æ± å°ˆç”¨è¨­å®š
    const wishStyles = {
        'å·¨è‡':   { class: 'bg-cyan-400 text-black',   icon: 'ğŸ„' },
        'æ´»å‹•è‡': { class: 'bg-lime-400 text-black',   icon: 'ğŸ„' },
        'ç™½':     { class: 'bg-gray-100 text-black',   icon: 'âšª' },
        'ç´…':     { class: 'bg-red-600 text-white',    icon: 'ğŸ”´' },
        'é»ƒ':     { class: 'bg-yellow-400 text-black', icon: 'ğŸŸ¡' },
        'è—':     { class: 'bg-blue-600 text-white',   icon: 'ğŸ”µ' }
    };
    const wishOrder = ['å·¨è‡', 'æ´»å‹•è‡', 'ç™½', 'ç´…', 'é»ƒ', 'è—'];


    // =========================================================================
    // 2. DOM å…ƒç´ é¸å– (DOM Elements)
    // =========================================================================
    const userInfoEl = document.getElementById('user-info');
    const logoutButton = document.getElementById('logout-button');
    const changePasswordButton = document.getElementById('change-password-button');
    const hamburgerButton = document.getElementById('hamburger-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const adminLink = document.getElementById('admin-link');
    const onlineUsersContainer = document.getElementById('online-users-container');
    const refreshButton = document.getElementById('refresh-button');
    
    const postChallengeButton = document.getElementById('post-challenge-button');
    const challengesListEl = document.getElementById('challenges-list');
    const filterTabs = document.getElementById('filter-tabs');
    const hostedTab = document.getElementById('hosted-tab');
    const screenshotButton = document.getElementById('screenshot-button');

    // Modals
    const challengeModal = document.getElementById('challenge-modal');
    const challengeForm = document.getElementById('challenge-form');
    const cancelModalButton = document.getElementById('cancel-modal-button');
    const setTimeNowButton = document.getElementById('set-time-now-button');
    const submitChallengeButton = document.getElementById('submit-challenge-button');
    
    const editChallengeModal = document.getElementById('edit-challenge-modal');
    const editChallengeForm = document.getElementById('edit-challenge-form');
    const cancelEditModalButton = document.getElementById('cancel-edit-modal-button');
    const editSetTimeNowButton = document.getElementById('edit-set-time-now-button');

    const deleteConfirmModal = document.getElementById('delete-confirm-modal');
    const cancelDeleteButton = document.getElementById('cancel-delete-button');
    const confirmDeleteButton = document.getElementById('confirm-delete-button');

    const leaderboardButton = document.getElementById('leaderboard-button');
    const leaderboardModal = document.getElementById('leaderboard-modal');
    const leaderboardTabs = document.getElementById('leaderboard-tabs');
    const leaderboardContent = document.getElementById('leaderboard-content');
    const closeLeaderboardButton = document.getElementById('close-leaderboard-button');
    const periodWeekBtn = document.getElementById('period-week-btn');
    const periodMonthBtn = document.getElementById('period-month-btn');

    const passwordModal = document.getElementById('password-modal');
    const passwordForm = document.getElementById('password-form');
    const cancelPasswordButton = document.getElementById('cancel-password-button');
    const submitPasswordButton = document.getElementById('submit-password-button');

    const onlineUsersModal = document.getElementById('online-users-modal');
    const onlineUsersList = document.getElementById('online-users-list');
    const closeOnlineUsersModalButton = document.getElementById('close-online-users-modal');

    const syncTimeModal = document.getElementById('sync-time-modal');
    const syncTimeForm = document.getElementById('sync-time-form');
    const cancelSyncButton = document.getElementById('cancel-sync-button');
    const clearSyncButton = document.getElementById('clear-sync-button');

    const signupSubButton = document.getElementById('signup-sub-button');
    const signupIcon = document.getElementById('signup-email-icon');
    const signupText = document.getElementById('signup-email-text');
    const fullSubButton = document.getElementById('full-sub-button');
    const fullIcon = document.getElementById('full-email-icon');
    const fullText = document.getElementById('full-email-text');

    const toastMessage = document.getElementById('toast-message');

    // è¨±é¡˜æ±  DOM (ä½¿ç”¨ const ç¢ºä¿ä¸æœƒè¢«é‡è¤‡å®£å‘Š)
    const wishingWellBar = document.getElementById('wishing-well-bar');
    const wishActionArea = document.getElementById('wish-action-area');
    const openWishModalBtn = document.getElementById('open-wish-modal-btn');
    const wishedMessage = document.getElementById('wished-message');
    const wishModal = document.getElementById('wish-modal');
    const closeWishModalBtn = document.getElementById('close-wish-modal');
    const submitWishBtn = document.getElementById('submit-wish-btn');
    const wishCheckboxes = document.querySelectorAll('.wish-checkbox');


    // =========================================================================
    // 3. æ ¸å¿ƒåˆå§‹åŒ–é‚è¼¯ (Initialization)
    // =========================================================================

    /** [æ ¸å¿ƒ] é é¢è¼‰å…¥å…¥å£ */
    async function initializePage() {
        await supabaseClient.rpc('update_last_active');

        // æ¯æ—¥ä¸Šé™è¨­å®š
        const { data: settings, error: limitError } = await supabaseClient
            .from('daily_settings').select('setting_value').eq('setting_name', 'daily_signup_limit');
        window.dailySignupLimit = (limitError || !settings?.length) ? 3 : settings[0].setting_value;

        // ç›£è½ç™»å…¥ç‹€æ…‹
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT' || !session) {
                if (countdownInterval) clearInterval(countdownInterval);
                window.location.replace('./index.html');
            }
        });

        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) return;

        const { data: profile, error } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
        if (error || !profile) {
            console.error('Profile Error:', error);
            await supabaseClient.auth.signOut();
            return;
        }

        currentUserProfile = profile;
        
        // ä¾åºå•Ÿå‹•å„åŠŸèƒ½
        displayUserInfo();
        initWishingWell();          // â˜… å•Ÿå‹•è¨±é¡˜æ±  (ç¾åœ¨å‡½å¼å·²å®šç¾©ï¼Œä¸æœƒå ±éŒ¯)
        await fetchUserSignups();
        await fetchChallenges();
        
        setupRealtimeListeners();
        setupOnlinePresence();
        startGlobalCountdown();
        updateMarquee();
    }

    document.addEventListener('DOMContentLoaded', initializePage);


    // =========================================================================
    // 4. è¨±é¡˜æ± åŠŸèƒ½æ¨¡çµ„ (Wishing Well) - å·²æ•´åˆä¿®å¾©
    // =========================================================================

    /** [è¨±é¡˜] åˆå§‹åŒ– */
    async function initWishingWell() {
        if (!wishActionArea) return; 
        updateWishButtonState();
        await loadWishStats();
        setupWishListeners(); 
    }

    /** [è¨±é¡˜] è¼‰å…¥æ•¸æ“š */
    /** [è¨±é¡˜] åˆå§‹åŒ– */
    async function initWishingWell() {
        if (!wishActionArea) return; 
        updateWishButtonState();
        await loadWishStats();
        setupWishListeners(); 
    }

    /** [è¨±é¡˜] è¼‰å…¥æ•¸æ“š */
    async function loadWishStats() {
        try {
            const { data: stats, error } = await supabaseClient.from('wish_stats').select('*');
            if (error) throw error;
            renderWishingWell(stats || []);
        } catch (err) {
            console.error('è¼‰å…¥è¨±é¡˜å¤±æ•—:', err);
            if(wishingWellBar) wishingWellBar.innerHTML = '<div class="w-full text-center text-xs text-red-400">æ•¸æ“šè¼‰å…¥ç•°å¸¸</div>';
        }
    }

    /** [è¨±é¡˜] æ¸²æŸ“é•·æ¢åœ– (ä¿®æ­£ç‰ˆï¼šæ”¾å¯¬é¡¯ç¤ºæ¨™æº–) */
    function renderWishingWell(stats) {
        if (!wishingWellBar) return;
        
        const totalVotes = stats.reduce((sum, item) => sum + item.count, 0);

        // è‹¥ç„¡æ•¸æ“šï¼Œé¡¯ç¤ºé è¨­æ–‡å­—
        if (totalVotes === 0) {
            wishingWellBar.innerHTML = '<div class="w-full text-center text-[10px] text-gray-500 leading-none flex items-center justify-center h-full">å¿«ä¾†æ¶é ­é¦™ï¼</div>';
            return;
        }

        wishingWellBar.innerHTML = ''; 

        const sortedStats = wishOrder
            .map(type => {
                const found = stats.find(s => s.mushroom_type === type);
                return found ? found : { mushroom_type: type, count: 0 };
            })
            .filter(item => item.count > 0);

        sortedStats.forEach(item => {
            const percentage = (item.count / totalVotes) * 100;
            const styleConfig = wishStyles[item.mushroom_type] || { class: 'bg-gray-500 text-white', icon: '' };
            
            const segment = document.createElement('div');
            
            // è¨­å®šå¤–å±¤å®¹å™¨æ¨£å¼
            segment.className = `h-full relative overflow-hidden transition-all duration-500 ${styleConfig.class} group cursor-help`;
            segment.style.width = `${percentage}%`;
            segment.title = `${item.mushroom_type}: ${item.count}ç¥¨ (${percentage.toFixed(1)}%)`;

            // â˜… ä¿®æ”¹é‡é» 1ï¼šé–€æª»å¾ 12% é™ç‚º 6% (è®“æ›´å¤šè‰²å¡Šèƒ½é¡¯ç¤ºå…§å®¹)
            if (percentage > 6) {
                // â˜… ä¿®æ”¹é‡é» 2ï¼šç§»é™¤ 'hidden sm:flex' (è®“æ‰‹æ©Ÿç‰ˆä¹Ÿèƒ½é¡¯ç¤º)
                // åŠ å…¥ drop-shadow è®“æ–‡å­—åœ¨æ·ºè‰²èƒŒæ™¯(å¦‚ç™½è‰²/é»ƒè‰²)ä¸Šæ›´æ¸…æ™°
                segment.innerHTML = `
                    <div class="w-full h-full flex items-center justify-center text-[10px] md:text-xs font-bold leading-none whitespace-nowrap px-1 drop-shadow-md">
                        <span class="mr-0.5 md:mr-1 filter drop-shadow-sm">${styleConfig.icon}</span>
                        <span>${item.count}</span>
                    </div>
                `;
            }

            wishingWellBar.appendChild(segment);
        });
    }

    /** [è¨±é¡˜] æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ (é‚è¼¯ä¿®æ”¹ï¼šè¨ˆæ•¸ < 3 éƒ½é¡¯ç¤º) */
    function updateWishButtonState() {
        if (!currentUserProfile) return;
        
        const currentCount = currentUserProfile.daily_wish_count || 0;
        const isFull = currentCount >= 3;

        // ç¢ºä¿é‡æ–°æŠ“å– DOM å…ƒç´ ï¼Œé¿å…åƒè€ƒéºå¤±
        const btn = document.getElementById('open-wish-modal-btn');
        const msg = document.getElementById('wished-message');

        if (isFull) {
            // é¡åº¦å·²æ»¿
            if (btn) btn.classList.add('hidden');
            if (msg) {
                msg.classList.remove('hidden');
                msg.innerHTML = `<span class="text-green-400">âœ…</span><span class="text-gray-400">æ˜æ—¥å†ä¾†</span>`;
            }
        } else {
            // é‚„æœ‰é¡åº¦
            if (btn) {
                btn.classList.remove('hidden');
                // é¸ç”¨ï¼šå¦‚æœæ‚¨å¸Œæœ›æŒ‰éˆ•æ–‡å­—ç›´æ¥é¡¯ç¤ºå‰©é¤˜ç¥¨æ•¸ï¼Œå¯è§£é–‹ä¸‹é¢é€™è¡Œ
                // btn.querySelector('span:last-child').textContent = `è¨±é¡˜ (${currentCount}/3)`;
            }
            if (msg) msg.classList.add('hidden');
        }
    }

    /** [è¨±é¡˜] è¨­å®šç›£è½å™¨ (å«å‹•æ…‹é¡åº¦è¨ˆç®—) */
    function setupWishListeners() {
        // é‡æ–°æŠ“å–æ‰€æœ‰å…ƒç´ 
        const wishActionArea = document.getElementById('wish-action-area');
        const wishModal = document.getElementById('wish-modal');
        const closeWishModalBtn = document.getElementById('close-wish-modal');
        const submitWishBtn = document.getElementById('submit-wish-btn');
        const wishCheckboxes = document.querySelectorAll('.wish-checkbox');

        // å·¦å´é»æ“Š
        if (wishActionArea) {
            const newArea = wishActionArea.cloneNode(true);
            wishActionArea.parentNode.replaceChild(newArea, wishActionArea);
            newArea.addEventListener('click', (e) => {
                e.preventDefault(); 
                if (!currentUserProfile) { showToast('è«‹å…ˆç™»å…¥', true); return; }
                
                const currentCount = currentUserProfile.daily_wish_count || 0;
                if (currentCount >= 3) {
                    showToast('ä»Šæ—¥å·²å®Œæˆ 3 æ¬¡è¨±é¡˜ï¼Œè«‹æ˜æ—¥å†ä¾†ï¼', false);
                    return;
                }

                // é‡ç½®å‹¾é¸
                if (wishCheckboxes) wishCheckboxes.forEach(cb => cb.checked = false);
                
                // â˜… ä¿®æ”¹ï¼šæ›´æ–° Modal æ¨™é¡Œé¡¯ç¤ºé€²åº¦
                const modalTitle = document.querySelector('#wish-modal h3');
                if(modalTitle) modalTitle.textContent = `âœ¨ è¨±é¡˜æ±  (${currentCount}/3)`;

                if (wishModal) wishModal.classList.remove('hidden');
            });
        }

        // é—œé–‰ Modal
        if (closeWishModalBtn) {
            const newClose = closeWishModalBtn.cloneNode(true);
            closeWishModalBtn.parentNode.replaceChild(newClose, closeWishModalBtn);
            newClose.addEventListener('click', () => { if (wishModal) wishModal.classList.add('hidden'); });
        }
        if (wishModal) {
             wishModal.onclick = (e) => { if (e.target === wishModal) wishModal.classList.add('hidden'); };
        }

        // è¤‡é¸é™åˆ¶
        if (wishCheckboxes) {
            wishCheckboxes.forEach(cb => {
                cb.onchange = () => {
                    const currentCount = currentUserProfile.daily_wish_count || 0;
                    const remainingQuota = 3 - currentCount;
                    const selectedCount = document.querySelectorAll('.wish-checkbox:checked').length;
                    
                    if (selectedCount > remainingQuota) {
                        cb.checked = false;
                        showToast(`æ‚¨ä»Šæ—¥åªå‰© ${remainingQuota} ç¥¨å›‰ï¼`, true);
                    }
                };
            });
        }

        // é€å‡º
        if (submitWishBtn) {
            const newSubmit = submitWishBtn.cloneNode(true);
            submitWishBtn.parentNode.replaceChild(newSubmit, submitWishBtn);
            newSubmit.addEventListener('click', async () => {
                const selected = Array.from(document.querySelectorAll('.wish-checkbox:checked')).map(cb => cb.value);
                if (selected.length === 0) { showToast('è«‹è‡³å°‘é¸æ“‡ä¸€ç¨®ï¼', true); return; }

                newSubmit.disabled = true; newSubmit.textContent = 'è¨±é¡˜ä¸­...';
                try {
                    const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                        body: { action: 'submit-wish', payload: { userId: currentUserProfile.id, types: selected } }
                    });
                    if (error) throw error;
                    if (data?.error) throw new Error(data.error);

                    const count = selected.length;
                    showToast(`âœ¨ æˆåŠŸæŠ•ä¸‹ ${count} ç¥¨ï¼`, false);
                    if (wishModal) wishModal.classList.add('hidden');
                    
                    // â˜… é—œéµï¼šç«‹å³æ›´æ–°æœ¬åœ°ç‹€æ…‹ä¸¦åˆ·æ–° UI
                    currentUserProfile.daily_wish_count = (currentUserProfile.daily_wish_count || 0) + count;
                    updateWishButtonState(); // é€™è£¡æœƒç«‹å³è§¸ç™¼ã€Œæ˜æ—¥å†ä¾†ã€çš„åˆ‡æ›
                    
                    await loadWishStats();
                } catch (err) {
                    console.error(err);
                    showToast(`è¨±é¡˜å¤±æ•—: ${err.message}`, true);
                } finally {
                    newSubmit.disabled = false; newSubmit.textContent = 'é€å‡ºè¨±é¡˜';
                }
            });
        }
    }


    // =========================================================================
    // 5. ä½¿ç”¨è€…ä»‹é¢èˆ‡æ¬Šé™ (UI & Profile)
    // =========================================================================

    function displayUserInfo() {
        if (!currentUserProfile) return;
        const displayName = (currentUserProfile.nickname || '').split(/[^a-zA-Z0-9\u4e00-\u9fa5\s]/)[0];
        userInfoEl.textContent = `ä½ å¥½ï¼Œ${displayName}ï¼`;
        updateQuotaDisplay();

        if (['ç®¡ç†è€…', 'ç™¼è‡è€…', 'ç™¼è‡åŠå ±åè€…'].includes(currentUserProfile.role)) {
            postChallengeButton.classList.remove('hidden');
            hostedTab.classList.remove('hidden');
        }
        if (currentUserProfile.role === 'ç®¡ç†è€…') {
            adminLink.classList.remove('hidden');
            const mobAdmin = document.getElementById('admin-link-mobile');
            if(mobAdmin) mobAdmin.classList.remove('hidden');
        }
        checkSubscriptionStatus();
    }

    function updateQuotaDisplay() {
        const quotaEl = document.getElementById('daily-quota-display');
        if (!currentUserProfile || !quotaEl) return;
        const count = currentUserProfile.daily_signup_count || 0;
        quotaEl.textContent = `æœ¬æ—¥é¡åº¦: ${count} / ${window.dailySignupLimit}`;
    }

    async function refreshUserProfile() {
        const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', currentUserProfile.id).single();
        if (!error) currentUserProfile = data;
    }

    // ç™»å‡º
    logoutButton.addEventListener('click', async () => {
        logoutButton.disabled = true; logoutButton.textContent = 'ç™»å‡ºä¸­...';
        try { await supabaseClient.auth.signOut(); } catch(e) {}
        localStorage.removeItem('sb-' + SUPABASE_ANON_KEY + '-auth-token');
        window.location.replace('./index.html');
    });

    // ä¿®æ”¹å¯†ç¢¼
    changePasswordButton.addEventListener('click', () => { passwordForm.reset(); passwordModal.classList.remove('hidden'); });
    cancelPasswordButton.addEventListener('click', () => passwordModal.classList.add('hidden'));
    passwordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newPw = document.getElementById('new-password').value;
        const confirmPw = document.getElementById('confirm-password').value;
        if (newPw.length < 6) { showToast('å¯†ç¢¼é•·åº¦éœ€å¤§æ–¼6ä½', true); return; }
        if (newPw !== confirmPw) { showToast('å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´', true); return; }
        
        submitPasswordButton.disabled = true;
        const { error } = await supabaseClient.auth.updateUser({ password: newPw });
        if (error) showToast(`å¤±æ•—: ${error.message}`, true);
        else { showToast('ä¿®æ”¹æˆåŠŸ', false); passwordModal.classList.add('hidden'); }
        submitPasswordButton.disabled = false;
    });


    // =========================================================================
    // 6. æŒ‘æˆ°è³‡æ–™è™•ç† (Data Fetching & Rendering)
    // =========================================================================

    async function fetchUserSignups() {
        const { data, error } = await supabaseClient.from('signups').select('challenge_id').eq('user_id', currentUserProfile.id);
        if (!error) userSignedUpChallengeIds = new Set(data.map(s => s.challenge_id));
    }

    async function fetchChallenges() {
        const { data: challenges, error } = await supabaseClient
            .from('challenges')
            .select(`*, host:profiles(nickname, id), signups(*, profile:profiles(nickname))`)
            .order('start_time', { ascending: false });

        if (error) { challengesListEl.innerHTML = '<p class="text-center col-span-full text-red-400">ç„¡æ³•è¼‰å…¥æŒ‘æˆ°ã€‚</p>'; return; }

        challengesData = {};
        challenges.forEach(c => { challengesData[c.id] = c; });
        document.getElementById('loading-indicator')?.remove();
        
        refreshAllChallengeCards();
    }

    function refreshAllChallengeCards() {
        if (!challengesData) return;
        challengesListEl.innerHTML = '';
        Object.values(challengesData).forEach(challenge => renderChallenge(challenge));
        applyFilter();
    }

    // â˜… æ ¸å¿ƒæ¸²æŸ“é‚è¼¯ (é€™æ˜¯æ‚¨åŸæœ¬ renderChallenge çš„å„ªåŒ–ç‰ˆ)
    function renderChallenge(challenge) {
        if (!challenge || !challenge.host) return;
        challengesData[challenge.id] = challenge; // æ›´æ–°å¿«å–

        const dailyLimitReached = currentUserProfile && currentUserProfile.daily_signup_count >= window.dailySignupLimit;
        const card = document.createElement('div');
        card.className = 'challenge-card bg-gray-800 rounded-xl shadow-md overflow-hidden p-6 flex flex-col justify-between';
        card.id = `challenge-${challenge.id}`;
        
        const statusClass = challenge.status === 'é–‹æ”¾å ±åä¸­' ? 'status-open' : (challenge.status === 'å·²é¡æ»¿' ? 'status-full' : 'status-pending');
        card.dataset.status = challenge.status;

        const type = challenge.mushroom_type;
        const style = mushroomStyles[type] || { bg: 'bg-transparent', text: 'text-gray-100' };
        const titleClasses = `text-xl font-bold px-3 py-1 rounded-md ${style.bg} ${style.text} whitespace-nowrap`;

        const isHost = challenge.host && challenge.host.id === currentUserProfile.id;
        const isSignedUp = userSignedUpChallengeIds.has(challenge.id);
        const signupCount = challenge.signups ? challenge.signups.length : 0;
        const dispatchStatus = challenge.dispatch_status || 'å¾…ç™¼';

        if (isHost) card.dataset.isHosted = 'true';
        if (isSignedUp) card.dataset.isSignedUp = 'true';

        // æ“ä½œæŒ‰éˆ•é‚è¼¯ (åŒ…å«å†·å»èˆ‡æ¬Šé™)
        let actionButtonHtml;
        if (isHost) {
            if (signupCount > 0) {
                const btnBgClass = dispatchStatus === 'å·²ç™¼' ? 'bg-teal-600 hover:bg-teal-700' : 'bg-gray-700 hover:bg-gray-600';
                actionButtonHtml = `<button class="w-full ${btnBgClass} text-white font-bold py-2 px-4 rounded-lg transition cursor-pointer dispatch-status-tag" data-id="${challenge.id}" data-current-status="${dispatchStatus}">æ›´æ–°ç™¼è‡ç‹€æ…‹</button>`;
            } else {
                actionButtonHtml = `<button class="w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg cursor-default">æ‚¨æ˜¯ç™¼è‡è€…</button>`;
            }
        } else if (isSignedUp) {
            actionButtonHtml = `<button class="cancel-signup-button w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition" data-challenge-id="${challenge.id}">å–æ¶ˆå ±å</button>`;
        } else if (challenge.status === 'é è¨ˆé–‹æ”¾') {
            actionButtonHtml = `<button class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed" disabled>å°šæœªé–‹æ”¾</button>`;
        } else if (challenge.status === 'å·²é¡æ»¿') {
            actionButtonHtml = `<button class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed" disabled>å·²é¡æ»¿</button>`;
        } else if (dailyLimitReached) { 
            actionButtonHtml = `<button class="w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed" disabled>å ±åé¡åº¦å·²æ»¿</button>`;
        } else {
            if (currentUserProfile.role === 'ç™¼è‡è€…') {
                actionButtonHtml = `<button class="w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg cursor-default" disabled>åƒ…ç™¼å¸ƒæ¬Šé™</button>`;
            } else {
                const cooldownLeft = Math.ceil((globalCooldownUntil - Date.now()) / 1000);
                if (cooldownLeft > 0) {
                    actionButtonHtml = `<button class="signup-button w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed btn-cooldown" disabled>å†·å»ä¸­ ${cooldownLeft}s</button>`;
                } else {
                    actionButtonHtml = `<button class="signup-button w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition" data-challenge-id="${challenge.id}">å ±å</button>`;
                }
            }
        }

        // Host ç·¨è¼¯åˆªé™¤éˆ•
        const hostControlsHtml = isHost ? `
            <button data-id="${challenge.id}" class="edit-challenge-button text-gray-500 hover:text-yellow-400 transition" title="ç·¨è¼¯">âœï¸</button>
            <button data-id="${challenge.id}" class="delete-challenge-button text-gray-500 hover:text-red-500 transition" title="åˆªé™¤">ğŸ—‘ï¸</button>
        ` : '';

        // åƒåŠ è€…åå–®
        let participantsHtml = '';
        if (signupCount > 0) {
            const sortedSignups = [...challenge.signups].sort((a, b) => new Date(a.signed_up_at) - new Date(b.signed_up_at));
            const list = sortedSignups.map((signup, index) => {
                const rankText = `${index + 1}${getRankSuffix(index + 1)}`;
                const nickname = signup.profile ? signup.profile.nickname : 'æœªçŸ¥';
                const time = formatSignupTime(signup.signed_up_at);
                return `<div class="participant-item"><span><span class="participant-rank">${rankText}</span> ${nickname}</span><span>${time}</span></div>`;
            }).join('');
            participantsHtml = `<div class="participant-list">${list}</div>`;
        }

        // æ™‚é–“é¡¯ç¤º
        let startTimeHtml;
        if (challenge.status === 'é è¨ˆé–‹æ”¾' && new Date(challenge.start_time) > new Date()) { 
            startTimeHtml = `<p><strong>ç­‰å¾…æ™‚é–“:</strong> <span class="countdown-timer" data-starttime="${challenge.start_time}">è¨ˆç®—ä¸­...</span></p>`;
        } else {
            startTimeHtml = `<p><strong>é–‹æ”¾æ™‚é–“:</strong> ${new Date(challenge.start_time).toLocaleString('zh-TW', { hour12: false })}</p>`;
        }

        // åœ–ç‰‡æŒ‰éˆ•
        let imageBtnHtml = (challenge.image_url && challenge.image_url.startsWith('http')) 
            ? `<div class="mt-2"><button onclick="openImageViewer('${challenge.image_url}')" class="text-xs bg-gray-700 text-indigo-300 px-3 py-1.5 rounded hover:bg-gray-600 border border-gray-600 flex items-center gap-2 transition">ğŸ“· æŸ¥çœ‹æ˜ä¿¡ç‰‡</button></div>` : '';

        // ç™¼é€æ¨™ç±¤
        let dispatchTagHtml = '';
        if (signupCount > 0) {
            const dispatchClass = dispatchStatus === 'å·²ç™¼' ? 'dispatch-sent' : 'dispatch-pending';
            const isClickable = isHost ? 'cursor-pointer' : '';
            dispatchTagHtml = `<span class="status-badge ${dispatchClass} ${isClickable} dispatch-status-tag" data-id="${challenge.id}" data-current-status="${dispatchStatus}">${dispatchStatus}</span>`;
        }

        // ç«ä¾¯æ¨£å¼
        let cookingStyleClass = 'text-gray-400 border-gray-500/30';
        const cStyle = challenge.cooking_style || '';
        if (cStyle.includes('å¤§ç«å¿«ç‚’')) cookingStyleClass = 'text-red-500 border-red-500/30';
        else if (cStyle.includes('ç´°ç«æ…¢ç‡‰')) cookingStyleClass = 'text-orange-400 border-orange-400/30';
        else if (cStyle.includes('éš¨ä¾¿äº‚ç‚’')) cookingStyleClass = 'text-yellow-400 border-yellow-400/30';

        // å€’æ•¸èˆ‡æ”¶æˆæ™‚é–“
        let countdownDisplayHtml = '<span class="text-gray-500">å€’æ•¸:--</span>';
        let dataEndTime = challenge.countdown_end_time || '';
        let harvestHtmlBlock = `<div class="harvest-timer text-white font-bold mt-1" data-endtime="${dataEndTime}"></div>`;
        if (dataEndTime) countdownDisplayHtml = 'è¨ˆç®—ä¸­...';

        const battleTimerHtml = `
            <span class="battle-timer text-white font-bold" data-endtime="${dataEndTime}">${countdownDisplayHtml}</span>
            <button class="open-sync-modal-button text-xs bg-gray-700 text-gray-300 px-2 py-0.5 rounded ml-2 hover:bg-gray-600 border border-gray-600 transition" data-id="${challenge.id}" title="æ ¡æ­£æ™‚é–“">æ ¡æ™‚</button>
        `;

        // çµ„åˆ HTML
        card.innerHTML = `
            <div>
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-2">
                        <h3 class="${titleClasses}">${challenge.mushroom_type}</h3>
                        <span class="text-sm font-bold text-gray-500">#${challenge.id}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        ${dispatchTagHtml}
                        <span class="status-badge ${statusClass}">${challenge.status === 'é–‹æ”¾å ±åä¸­' ? 'å ±åä¸­' : challenge.status}</span>
                        ${hostControlsHtml}
                    </div>
                </div>
                <div class="flex flex-col mb-3 pl-1">
                    <div class="flex items-center">${battleTimerHtml}</div>
                    ${harvestHtmlBlock}
                </div>
                <div class="text-gray-400 space-y-2 mb-4">
                    <p><strong>ç™¼è‡è€…:</strong> ${challenge.host ? challenge.host.nickname : 'æœªçŸ¥'}</p>
                    <p><strong>ç”¨é¤æ™‚æ®µ:</strong> ${challenge.details || 'æœªæŒ‡å®š'}</p>
                    <p><strong>åé¡:</strong> <span id="signup-count-${challenge.id}">${signupCount}</span> / ${challenge.slots}</p>
                    ${startTimeHtml}
                    <div class="flex items-center mt-1"><strong class="mr-2">ç«ä¾¯:</strong><span class="${cookingStyleClass} border px-2 py-0.5 rounded text-sm font-bold">ğŸ”¥ ${cStyle || 'æœªæŒ‡å®š'}</span></div>
                    ${imageBtnHtml}
                </div>
                ${participantsHtml}
            </div>
            <div class="mt-4">${actionButtonHtml}</div>
        `;

        const existingCard = document.getElementById(card.id);
        if(existingCard) challengesListEl.replaceChild(card, existingCard);
        else challengesListEl.prepend(card);
    }

    async function reloadChallengeCard(challengeId) {
        const { data: challenge, error } = await supabaseClient.from('challenges')
            .select(`*, host:profiles(nickname, id), signups(*, profile:profiles(nickname))`)
            .eq('id', challengeId).single();
        
        if (error) {
            if (error.code === 'PGRST116') {
                const el = document.getElementById(`challenge-${challengeId}`);
                if(el) el.remove();
            } else console.error('é‡è¼‰å¤±æ•—:', error);
            return;
        }
        renderChallenge(challenge);
        applyFilter();
    }


    // =========================================================================
    // 7. äº’å‹•æ“ä½œ (Interactions: Post, Edit, Delete, Signup)
    // =========================================================================

    /** [ç™¼å¸ƒ] */
    postChallengeButton.addEventListener('click', () => {
        challengeForm.reset();
        challengeForm['mushroom-type'].value = 'å·¨è‡';
        challengeForm['slots'].value = 4;
        
        const remTime = localStorage.getItem('rememberedChallengeTime');
        const remDetails = localStorage.getItem('rememberedChallengeDetails');
        const remStyle = localStorage.getItem('rememberedCookingStyle');
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const datePart = now.toISOString().split('T')[0];

        if (remTime) {
            challengeForm['start-time'].value = `${datePart}T${remTime}`;
            if(remDetails) challengeForm['details'].value = remDetails;
            if(remStyle) document.getElementById('cooking-style').value = remStyle;
            document.getElementById('remember-time-checkbox').checked = true;
        } else {
            challengeForm['start-time'].value = now.toISOString().slice(0, 16);
            document.getElementById('remember-time-checkbox').checked = false;
        }
        document.getElementById('challenge-image').value = '';
        challengeModal.classList.remove('hidden');
    });
    cancelModalButton.addEventListener('click', () => challengeModal.classList.add('hidden'));
    setTimeNowButton.addEventListener('click', () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        challengeForm['start-time'].value = now.toISOString().slice(0, 16);
    });

    challengeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitChallengeButton.disabled = true; submitChallengeButton.textContent = 'ç™¼å¸ƒä¸­...';
        
        const form = e.target;
        const timeVal = form['start-time'].value;
        const styleVal = document.getElementById('cooking-style').value;

        if (document.getElementById('remember-time-checkbox').checked) {
            localStorage.setItem('rememberedChallengeTime', timeVal.split('T')[1]);
            localStorage.setItem('rememberedChallengeDetails', form['details'].value);
            localStorage.setItem('rememberedCookingStyle', styleVal);
        } else {
            localStorage.removeItem('rememberedChallengeTime');
            localStorage.removeItem('rememberedChallengeDetails');
            localStorage.removeItem('rememberedCookingStyle');
        }

        let publicImageUrl = null;
        const fileInput = document.getElementById('challenge-image');
        if (fileInput.files.length > 0) {
            try {
                const file = fileInput.files[0];
                const fileName = `${Date.now()}_${Math.floor(Math.random()*1000)}.${file.name.split('.').pop()}`;
                const { error: upErr } = await supabaseClient.storage.from('challenge-images').upload(fileName, file);
                if(upErr) throw upErr;
                const { data } = supabaseClient.storage.from('challenge-images').getPublicUrl(fileName);
                publicImageUrl = data.publicUrl;
            } catch (err) {
                console.error('åœ–ç‰‡ä¸Šå‚³å¤±æ•—:', err);
                showToast('åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œå°‡ä¸å«åœ–ç‰‡ç™¼å¸ƒ', true);
            }
        }

        const startTime = new Date(timeVal);
        const { data: newChal, error } = await supabaseClient.from('challenges').insert({
            host_id: currentUserProfile.id,
            mushroom_type: form['mushroom-type'].value,
            slots: parseInt(form['slots'].value),
            start_time: startTime.toISOString(),
            details: form['details'].value,
            status: startTime > new Date() ? 'é è¨ˆé–‹æ”¾' : 'é–‹æ”¾å ±åä¸­',
            cooking_style: styleVal,
            image_url: publicImageUrl
        }).select().single();

        if (error) showToast(`ç™¼å¸ƒå¤±æ•—: ${error.message}`, true);
        else {
            showToast('ç™¼å¸ƒæˆåŠŸï¼', false);
            challengeModal.classList.add('hidden');
            const fullObj = { ...newChal, host: { id: currentUserProfile.id, nickname: currentUserProfile.nickname }, signups: [] };
            renderChallenge(fullObj);
            applyFilter();
        }
        submitChallengeButton.disabled = false; submitChallengeButton.textContent = 'ç¢ºèªç™¼å¸ƒ';
    });

    /** [ç·¨è¼¯] */
    function openEditModal(challengeId) {
        const c = challengesData[challengeId];
        if (!c) { showToast('æ‰¾ä¸åˆ°è³‡æ–™', true); return; }
        
        document.getElementById('edit-challenge-id').value = c.id;
        document.getElementById('edit-mushroom-type').value = c.mushroom_type;
        document.getElementById('edit-slots').value = c.slots;
        
        const localTime = new Date(c.start_time);
        localTime.setMinutes(localTime.getMinutes() - localTime.getTimezoneOffset());
        document.getElementById('edit-start-time').value = localTime.toISOString().slice(0, 16);
        document.getElementById('edit-details').value = c.details;
        document.getElementById('edit-cooking-style').value = c.cooking_style || 'å¤§ç«å¿«ç‚’ï¼ˆæˆ°åŠ›å…¨é–‹ï¼‰';
        editChallengeModal.classList.remove('hidden');
    }
    cancelEditModalButton.addEventListener('click', () => editChallengeModal.classList.add('hidden'));
    editSetTimeNowButton.addEventListener('click', () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('edit-start-time').value = now.toISOString().slice(0, 16);
    });
    editChallengeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submit-edit-challenge-button');
        btn.disabled = true; btn.textContent = 'å„²å­˜ä¸­...';
        
        const id = document.getElementById('edit-challenge-id').value;
        const newSlots = parseInt(document.getElementById('edit-slots').value);
        const newTime = new Date(document.getElementById('edit-start-time').value);
        
        const curSignups = challengesData[id]?.signups?.length || 0;
        let status = (newTime > new Date()) ? 'é è¨ˆé–‹æ”¾' : (curSignups >= newSlots ? 'å·²é¡æ»¿' : 'é–‹æ”¾å ±åä¸­');

        const updateData = {
            mushroom_type: document.getElementById('edit-mushroom-type').value,
            slots: newSlots,
            start_time: newTime.toISOString(),
            details: document.getElementById('edit-details').value,
            status: status,
            cooking_style: document.getElementById('edit-cooking-style').value
        };

        const fileInput = document.getElementById('edit-challenge-image');
        if (fileInput.files.length > 0) {
            try {
                const file = fileInput.files[0];
                const fileName = `${Date.now()}_edit_${Math.floor(Math.random()*1000)}.${file.name.split('.').pop()}`;
                const { error: upErr } = await supabaseClient.storage.from('challenge-images').upload(fileName, file);
                if(upErr) throw upErr;
                const { data } = supabaseClient.storage.from('challenge-images').getPublicUrl(fileName);
                updateData.image_url = data.publicUrl;
            } catch (err) {
                console.error(err);
                showToast('åœ–ç‰‡ä¸Šå‚³å¤±æ•—', true);
            }
        }

        const { error } = await supabaseClient.from('challenges').update(updateData).eq('id', id);
        if(error) showToast(`æ›´æ–°å¤±æ•—: ${error.message}`, true);
        else {
            showToast('æ›´æ–°æˆåŠŸ', false);
            editChallengeModal.classList.add('hidden');
            fileInput.value = '';
            reloadChallengeCard(id);
        }
        btn.disabled = false; btn.textContent = 'ç¢ºèªå„²å­˜';
    });

    /** [åˆªé™¤] */
    async function deleteChallenge(id) {
        confirmDeleteButton.disabled = true; confirmDeleteButton.textContent = 'åˆªé™¤ä¸­...';
        try {
            const { data: cData } = await supabaseClient.from('challenges').select('image_url').eq('id', id).single();
            if(cData && cData.image_url) {
                const fileName = cData.image_url.split('/').pop();
                await supabaseClient.storage.from('challenge-images').remove([fileName]);
            }
            const { error } = await supabaseClient.from('challenges').delete().eq('id', id);
            if(error) throw error;
            showToast('åˆªé™¤æˆåŠŸ', false);
            const card = document.getElementById(`challenge-${id}`);
            if(card) card.remove();
        } catch (err) { showToast(`åˆªé™¤å¤±æ•—: ${err.message}`, true); }
        finally { hideDeleteConfirmModal(); }
    }
    function hideDeleteConfirmModal() {
        challengeToDeleteId = null;
        deleteConfirmModal.classList.add('hidden');
        confirmDeleteButton.disabled = false;
        confirmDeleteButton.textContent = 'ç¢ºèªåˆªé™¤';
    }
    cancelDeleteButton.addEventListener('click', hideDeleteConfirmModal);
    confirmDeleteButton.addEventListener('click', () => { if(challengeToDeleteId) deleteChallenge(challengeToDeleteId); });

    /** [å ±å] */
    async function handleSignUp(challengeId, buttonEl) {
        buttonEl.disabled = true; buttonEl.textContent = 'å ±åä¸­...';
        const nid = parseInt(challengeId);
        const { error } = await supabaseClient.rpc('signup_for_challenge', { challenge_id_to_signup: nid });

        if (error) {
            showToast(`å ±åå¤±æ•—: ${error.message.includes('limit') ? 'æœ¬æ—¥é¡åº¦å·²æ»¿' : error.message}`, true);
            buttonEl.disabled = false; buttonEl.textContent = 'å ±å';
            reloadChallengeCard(challengeId);
        } else {
            showToast('å ±åæˆåŠŸï¼', false);
            userSignedUpChallengeIds.add(nid);
            triggerGlobalCooldown();
            await reloadChallengeCard(challengeId);
            await refreshUserProfile();
            refreshAllChallengeCards();
            updateQuotaDisplay();
        }
    }

    function triggerGlobalCooldown() {
        globalCooldownUntil = Date.now() + 3000;
        if (globalCooldownTimer) clearInterval(globalCooldownTimer);
        globalCooldownTimer = setInterval(() => {
            const timeLeft = Math.ceil((globalCooldownUntil - Date.now()) / 1000);
            const btns = document.querySelectorAll('.signup-button');
            if (timeLeft <= 0) {
                clearInterval(globalCooldownTimer);
                globalCooldownUntil = 0;
                refreshAllChallengeCards();
            } else {
                btns.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('btn-cooldown', 'bg-gray-600');
                    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    btn.textContent = `å†·å»ä¸­ ${timeLeft}s`;
                });
            }
        }, 100);
    }

    /** [å–æ¶ˆå ±å] */
    async function handleCancelSignUp(challengeId, buttonEl) {
        buttonEl.disabled = true; buttonEl.textContent = 'å–æ¶ˆä¸­...';
        const nid = parseInt(challengeId);
        const { error } = await supabaseClient.rpc('cancel_signup_and_update_challenge', { challenge_id_to_cancel: nid });
        if (error) {
            showToast(`å–æ¶ˆå¤±æ•—: ${error.message}`, true);
            reloadChallengeCard(challengeId);
        } else {
            showToast('å·²å–æ¶ˆå ±å', false);
            userSignedUpChallengeIds.delete(nid);
            await reloadChallengeCard(challengeId);
            await refreshUserProfile();
            refreshAllChallengeCards();
            updateQuotaDisplay();
        }
    }

    /** [ç™¼è»Š] */
    async function handleToggleDispatchStatus(challengeId, currentStatus) {
        const newStatus = currentStatus === 'å¾…ç™¼' ? 'å·²ç™¼' : 'å¾…ç™¼';
        const { error } = await supabaseClient.from('challenges').update({ 
            dispatch_status: newStatus,
            dispatched_at: newStatus === 'å·²ç™¼' ? new Date().toISOString() : null
        }).eq('id', challengeId);
        
        if(error) showToast(`æ›´æ–°å¤±æ•—`, true);
        reloadChallengeCard(challengeId);
    }

    // â˜…â˜…â˜… äº‹ä»¶å§”æ´¾ï¼šæ‰€æœ‰å¡ç‰‡æŒ‰éˆ•æ“ä½œéƒ½åœ¨é€™è£¡çµ±ä¸€è™•ç† â˜…â˜…â˜…
    challengesListEl.addEventListener('click', (e) => {
        const target = e.target;
        
        // 1. åˆªé™¤
        const delBtn = target.closest('.delete-challenge-button');
        if (delBtn) { challengeToDeleteId = delBtn.dataset.id; deleteConfirmModal.classList.remove('hidden'); return; }
        
        // 2. ç·¨è¼¯
        const editBtn = target.closest('.edit-challenge-button');
        if (editBtn) { openEditModal(editBtn.dataset.id); return; }
        
        // 3. å ±å
        const signBtn = target.closest('.signup-button');
        if (signBtn) { handleSignUp(signBtn.dataset.challengeId, signBtn); return; }
        
        // 4. å–æ¶ˆ
        const cancelBtn = target.closest('.cancel-signup-button');
        if (cancelBtn) { handleCancelSignUp(cancelBtn.dataset.challengeId, cancelBtn); return; }
        
        // 5. ç™¼è»Š
        const dispatchBtn = target.closest('.dispatch-status-tag');
        if (dispatchBtn && dispatchBtn.classList.contains('cursor-pointer')) {
            handleToggleDispatchStatus(dispatchBtn.dataset.id, dispatchBtn.dataset.currentStatus);
            return;
        }
        
        // 6. æ ¡æ™‚ (Sync)
        const syncBtn = target.closest('.open-sync-modal-button');
        if (syncBtn) {
            const id = syncBtn.dataset.id;
            document.getElementById('sync-challenge-id').value = id;
            const c = challengesData[id];
            if (c && c.countdown_end_time) {
                const diff = new Date(c.countdown_end_time) - new Date();
                if (diff > 0) {
                    document.getElementById('sync-days').value = Math.floor(diff / 86400000);
                    document.getElementById('sync-hours').value = Math.floor((diff % 86400000) / 3600000);
                    document.getElementById('sync-minutes').value = Math.floor((diff % 3600000) / 60000);
                }
            } else {
                document.getElementById('sync-days').value = 0;
                document.getElementById('sync-hours').value = 0;
                document.getElementById('sync-minutes').value = 0;
            }
            syncTimeModal.classList.remove('hidden');
        }
    });


    // =========================================================================
    // 8. è¨ˆæ™‚å™¨èˆ‡åŒæ­¥ (Timer & Sync)
    // =========================================================================

    syncTimeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const d = parseInt(document.getElementById('sync-days').value)||0;
        const h = parseInt(document.getElementById('sync-hours').value)||0;
        const m = parseInt(document.getElementById('sync-minutes').value)||0;
        if(d===0 && h===0 && m===0) { alert('è«‹è¼¸å…¥æ™‚é–“'); return; }
        
        const endTime = new Date(new Date().getTime() + (d*86400000 + h*3600000 + m*60000));
        await updateChallengeTimer(endTime.toISOString());
    });
    cancelSyncButton.addEventListener('click', () => syncTimeModal.classList.add('hidden'));
    clearSyncButton.addEventListener('click', () => updateChallengeTimer(null));

    async function updateChallengeTimer(isoTime) {
        const id = document.getElementById('sync-challenge-id').value;
        const btn = document.getElementById('confirm-sync-button');
        btn.disabled = true; btn.textContent = 'æ›´æ–°ä¸­...';
        try {
            const { error } = await supabaseClient.rpc('update_challenge_countdown', { p_challenge_id: parseInt(id), p_end_time: isoTime });
            if(error) throw error;
            showToast('æ™‚é–“å·²æ›´æ–°', false);
            syncTimeModal.classList.add('hidden');
            await reloadChallengeCard(id);
            updateBattleTimers();
        } catch(e) { showToast(`å¤±æ•—: ${e.message}`, true); }
        finally { btn.disabled = false; btn.textContent = 'æ›´æ–°'; }
    }

    function updateAllCountdowns() {
        document.querySelectorAll('.countdown-timer').forEach(el => {
            const diff = new Date(el.dataset.starttime) - new Date();
            if (diff < 1000) {
                el.classList.remove('countdown-timer');
                el.textContent = 'å³å°‡é–‹æ”¾...';
                const card = el.closest('.challenge-card');
                if(card) reloadChallengeCard(parseInt(card.id.split('-')[1]));
            } else {
                const d = Math.floor(diff/86400000), h = Math.floor((diff%86400000)/3600000);
                const m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
                if(d>0) el.textContent = `${d}å¤©${h}æ™‚å¾Œ`;
                else if(h>0) el.textContent = `${h}æ™‚${m}åˆ†å¾Œ`;
                else el.textContent = `${m}åˆ†${s}ç§’å¾Œ`;
            }
        });
    }

    function updateBattleTimers() {
        document.querySelectorAll('.battle-timer').forEach(el => {
            const endStr = el.dataset.endtime;
            const cardContainer = el.closest('.flex-col');
            const harvestEl = cardContainer ? cardContainer.querySelector('.harvest-timer') : null;

            if (!endStr || endStr === 'null' || endStr === 'undefined') {
                el.textContent = '--:--';
                el.className = 'battle-timer text-gray-500 font-bold';
                if(harvestEl) harvestEl.textContent = '';
                return;
            }

            const end = new Date(endStr);
            const diff = end - new Date();

            if(harvestEl) {
                const pad = n => n.toString().padStart(2,'0');
                harvestEl.textContent = `æ”¶æˆæ™‚é–“ã€€${end.getFullYear()}/${pad(end.getMonth()+1)}/${pad(end.getDate())} ${end.getHours()}:${pad(end.getMinutes())}`;
            }

            if (diff <= 0) {
                el.textContent = 'å·²çµæŸ';
                el.className = 'battle-timer text-red-400 font-bold';
            } else {
                el.className = 'battle-timer text-white font-bold';
                if (diff < 60000) el.textContent = `å€’æ•¸:${Math.floor(diff/1000)}ç§’`;
                else {
                    const d = Math.floor(diff/86400000), h = Math.floor((diff%86400000)/3600000);
                    const m = Math.floor((diff%3600000)/60000);
                    const mm = m.toString().padStart(2,'0');
                    if(d>0) el.textContent = `å€’æ•¸ã€€${d}å¤©${h}å°æ™‚${mm}åˆ†`;
                    else if(h>0) el.textContent = `å€’æ•¸ã€€${h}å°æ™‚${mm}åˆ†`;
                    else el.textContent = `å€’æ•¸ã€€${m}åˆ†`;
                }
            }
        });
    }

    function startGlobalCountdown() {
        if (countdownInterval) clearInterval(countdownInterval);
        updateAllCountdowns(); updateBattleTimers();
        countdownInterval = setInterval(() => { updateAllCountdowns(); updateBattleTimers(); }, 1000);
    }


    // =========================================================================
    // 9. æ’è¡Œæ¦œèˆ‡è·‘é¦¬ç‡ˆ (Leaderboard & Marquee)
    // =========================================================================

    leaderboardButton.addEventListener('click', () => {
        leaderboardModal.classList.remove('hidden');
        currentLeaderboardPeriod = 'week'; currentLeaderboardType = 'host';
        updateLeaderboardUI();
    });
    closeLeaderboardButton.addEventListener('click', () => leaderboardModal.classList.add('hidden'));
    
    periodWeekBtn.addEventListener('click', () => { currentLeaderboardPeriod='week'; updateLeaderboardUI(); });
    periodMonthBtn.addEventListener('click', () => { currentLeaderboardPeriod='month'; updateLeaderboardUI(); });
    leaderboardTabs.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (btn && btn.dataset.type) { currentLeaderboardType = btn.dataset.type; updateLeaderboardUI(); }
    });

    function updateLeaderboardUI() {
        const activeClass = 'flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition bg-indigo-600 text-white shadow-sm';
        const inactiveClass = 'flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-bold text-gray-400 hover:text-gray-200 transition';
        
        periodWeekBtn.className = currentLeaderboardPeriod==='week' ? activeClass : inactiveClass;
        periodMonthBtn.className = currentLeaderboardPeriod==='month' ? activeClass : inactiveClass;
        document.querySelectorAll('#leaderboard-tabs button').forEach(btn => {
            btn.className = (btn.dataset.type === currentLeaderboardType) ? activeClass : inactiveClass;
        });
        fetchLeaderboard(currentLeaderboardType, currentLeaderboardPeriod);
    }

    async function fetchLeaderboard(type, period) {
        leaderboardContent.innerHTML = '<p class="text-center text-gray-400 py-8">è®€å–ä¸­...</p>';
        let func = type === 'count' ? 'get_leaderboard_from_profiles' : (type === 'speed' ? 'get_speed_leaderboard_from_profiles' : 'get_host_leaderboard');
        
        try {
            const { data, error } = await supabaseClient.rpc(func, { period_type: period });
            if(error) throw error;
            
            if (type === 'count') renderCountLeaderboard(data);
            else if (type === 'speed') renderSpeedLeaderboard(data);
            else renderHostLeaderboard(data);
        } catch (e) { leaderboardContent.innerHTML = '<p class="text-center text-red-400">è¼‰å…¥å¤±æ•—</p>'; }
    }

    function renderCountLeaderboard(data) {
        if(!data?.length) { leaderboardContent.innerHTML='<p class="text-center text-gray-500 py-8">ç„¡ç´€éŒ„</p>'; return; }
        let rank=0, last=-1;
        leaderboardContent.innerHTML = data.map(item => {
            if(item.signup_count!==last) rank++; last=item.signup_count;
            return `<div class="flex items-center py-3 border-b border-gray-700 hover:bg-gray-800/50 transition">
                    <span class="w-12 text-center font-bold text-lg text-gray-300 flex-shrink-0">${rank<=3?['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][rank-1]:rank}</span>
                    <span class="flex-1 min-w-0 px-3 truncate text-gray-200">${item.nickname||'æœªçŸ¥'}</span>
                    <span class="w-24 text-right font-bold text-indigo-400 flex-shrink-0">${item.signup_count} æ¬¡</span></div>`;
        }).join('');
    }

    function renderSpeedLeaderboard(data) {
        if(!data?.length) { leaderboardContent.innerHTML='<p class="text-center text-gray-500 py-8">ç„¡ç´€éŒ„</p>'; return; }
        let rank=0, last=-1;
        leaderboardContent.innerHTML = data.map(item => {
            const t = parseFloat(item.fastest_time_seconds);
            if(t!==last) rank++; last=t;
            return `<div class="flex items-center py-3 border-b border-gray-700 hover:bg-gray-800/50 transition">
                    <span class="w-12 text-center font-bold text-lg text-gray-300 flex-shrink-0">${rank<=3?['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][rank-1]:rank}</span>
                    <span class="flex-1 min-w-0 px-3 truncate text-gray-200">${item.nickname||'æœªçŸ¥'}</span>
                    <span class="w-24 text-right font-bold text-yellow-400 flex-shrink-0">${!isNaN(t)?t.toFixed(3):'N/A'} s</span></div>`;
        }).join('');
    }

    function renderHostLeaderboard(data) {
        if(!data?.length) { leaderboardContent.innerHTML='<p class="text-center text-gray-500 py-8">ç„¡ç´€éŒ„</p>'; return; }
        let rank=0, last=-1;
        leaderboardContent.innerHTML = data.map(item => {
            if(item.host_count!==last) rank++; last=item.host_count;
            return `<div class="flex items-center py-3 border-b border-gray-700 hover:bg-gray-800/50 transition">
                    <span class="w-12 text-center font-bold text-lg text-gray-300 flex-shrink-0">${rank<=3?['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][rank-1]:rank}</span>
                    <span class="flex-1 min-w-0 px-3 truncate text-gray-200">${item.nickname||'æœªçŸ¥'}</span>
                    <span class="w-24 text-right font-bold text-green-400 flex-shrink-0">${item.host_count} è‡</span></div>`;
        }).join('');
    }

    async function updateMarquee() {
        const marqueeEl = document.getElementById('marquee-content');
        try {
            const [sData, spData, hData] = await Promise.all([
                supabaseClient.rpc('get_leaderboard_from_profiles', { period_type: 'month' }),
                supabaseClient.rpc('get_speed_leaderboard_from_profiles', { period_type: 'month' }),
                supabaseClient.rpc('get_host_leaderboard', { period_type: 'month' }) 
            ]);
            let parts = [];
            if(hData.data?.[0]) parts.push(`â˜…&nbsp;&nbsp;&nbsp;ğŸ„ æœ¬æœˆç™¼è‡ç‹ï¼š${hData.data[0].nickname} (${hData.data[0].host_count}æœµ)`);
            if(sData.data?.[0]) parts.push(`ğŸ† æœ¬æœˆå ±åç‹ï¼š${sData.data[0].nickname} (${sData.data[0].signup_count}æ¬¡)`);
            if(spData.data?.[0]) parts.push(`âš¡ æœ¬æœˆæœ€é€Ÿå‚³èªªï¼š${spData.data[0].nickname} (${parseFloat(spData.data[0].fastest_time_seconds).toFixed(2)}ç§’)&nbsp;&nbsp;&nbsp;â˜…`);

            if(parts.length > 0) {
                marqueeEl.innerHTML = parts.join(' &nbsp;&nbsp; â˜… &nbsp; ');
                marqueeEl.style.animationDuration = '20s';
                const run = () => {
                    marqueeEl.classList.remove('animate-marquee');
                    void marqueeEl.offsetWidth;
                    marqueeEl.classList.add('animate-marquee');
                };
                marqueeEl.addEventListener('animationend', () => setTimeout(run, 1000));
                run();
            } else marqueeEl.textContent = 'ç›®å‰å°šç„¡æŒ‘æˆ°ç´€éŒ„ï¼Œå¿«ä¾†æ¶é ­é¦™ï¼';
        } catch(e) { console.error(e); marqueeEl.textContent = 'æ­¡è¿ä¾†åˆ°è‡è‡å®…é…ç¶²ï¼'; }
    }


    // =========================================================================
    // 10. å…¶ä»–å·¥å…· (Subscription, Realtime, Utils)
    // =========================================================================

    /** [è¨‚é–±] */
    function checkSubscriptionStatus() {
        if(!currentUserProfile) return;
        updateSubBtn(signupSubButton, signupIcon, signupText, !!currentUserProfile.notification_email, currentUserProfile.notification_email, 'text-green-500', 'å ±åé€šçŸ¥', 'signup');
        updateSubBtn(fullSubButton, fullIcon, fullText, !!currentUserProfile.full_notification_email, currentUserProfile.full_notification_email, 'text-pink-500', 'é¡æ»¿é€šçŸ¥', 'full');
    }
    function updateSubBtn(btn, icon, txt, isSub, email, color, name, type) {
        if(isSub) {
            icon.textContent='ğŸ“­'; txt.textContent='å·²è¨‚é–±';
            btn.className=`${color} hover:opacity-80 transition text-xs md:text-base flex items-center gap-1`;
            btn.title=`æ¥æ”¶ä¿¡ç®±: ${email} (é»æ“Šå–æ¶ˆ)`;
        } else {
            icon.textContent= name==='é¡æ»¿é€šçŸ¥'?'ğŸ””':'ğŸ“§'; txt.textContent=name;
            btn.className=`text-gray-400 hover:${name==='é¡æ»¿é€šçŸ¥'?'text-red-400':'text-indigo-400'} transition text-xs md:text-base flex items-center gap-1`;
            btn.title=`è¨‚é–±${name}`;
        }
        btn.onclick = () => handleSubClick(type, isSub, email, name);
    }
    async function handleSubClick(type, isSub, currentEmail, name) {
        if(!isSub) {
            let email = prompt(`ã€è¨‚é–±${name}ã€‘\nè«‹è¼¸å…¥ Gmailï¼š`);
            if(email) {
                email=email.trim(); if(!email.includes('@')) email+='@gmail.com';
                if(!email.endsWith('@gmail.com')) { alert('è«‹ç”¨ Gmail'); return; }
                await doSub(email, type);
            }
        } else {
            if(confirm(`ç›®å‰ä¿¡ç®±ï¼š${currentEmail}\nç¢ºå®šå–æ¶ˆï¼Ÿ`)) await doSub(null, type);
        }
    }

    /** [è¨‚é–±] åŸ·è¡Œè¨‚é–±/é€€è¨‚å‹•ä½œ */
    async function doSub(email, type) {
        const btn = type === 'full' ? fullSubButton : signupSubButton;
        // æš«å­˜åŸæœ¬æŒ‰éˆ•æ–‡å­—ä»¥ä¾¿æ¢å¾© (å„ªåŒ–ç‰ˆé€šå¸¸ä¸éœ€è¦ï¼Œä½†ä¿ç•™ä»¥é˜²è¬ä¸€)
        // const originalText = btn.textContent; 
        
        btn.disabled = true;
        
        try {
            const { data, error } = await supabaseClient.functions.invoke('admin-actions', { 
                body: { 
                    action: 'update-subscription', 
                    payload: { 
                        userId: currentUserProfile.id, 
                        email: email, 
                        type: type 
                    } 
                } 
            });

            if (error) throw error;
            if (data?.error) throw new Error(data.error);

            // æ›´æ–°æœ¬åœ°ç‹€æ…‹
            if (type === 'full') currentUserProfile.full_notification_email = email;
            else currentUserProfile.notification_email = email;
            
            checkSubscriptionStatus();

            // å®šç¾©ç¾¤çµ„ç¶²å€
            const groupUrl = type === 'full' 
                ? "https://groups.google.com/g/full_quota_notify" 
                : "https://groups.google.com/g/mushroom_notify/members";

            if (email) {
                // === è¨‚é–±æˆåŠŸ ===
                showToast('è¨‚é–±æˆåŠŸï¼', false);
                setTimeout(() => {
                    alert('å³å°‡è½‰å¾€Googleç¶²è·¯è«–å£‡ï¼Œè«‹æŒ‰ã€Œè¦æ±‚åŠ å…¥ç¾¤çµ„ã€ï¼Œç­‰å¯©æ ¸é€šéå³å¯æ”¶åˆ°é€šçŸ¥ã€‚');
                    window.location.href = groupUrl;
                }, 500);
            } else {
                // === â˜… ä¿®æ”¹ï¼šé€€è¨‚æˆåŠŸ (åŠ å…¥æç¤ºèˆ‡è½‰å€) ===
                showToast('å·²å–æ¶ˆè¨‚é–±', false);
                setTimeout(() => {
                    alert('ã€âš ï¸ é‡è¦æé†’ã€‘\n\nç³»çµ±å·²æ¸…é™¤æ‚¨çš„ä¿¡ç®±ç´€éŒ„ï¼Œä½†æ‚¨ä»éœ€æ‰‹å‹•é€€å‡º Google ç¾¤çµ„ã€‚\n\né»æ“Šç¢ºå®šå¾Œå°‡è½‰å¾€ç¾¤çµ„é é¢ï¼Œè«‹æ‰¾åˆ°ã€Œé€€å‡ºç¾¤çµ„ã€æŒ‰éˆ•ä»¥å®Œæˆé€€è¨‚ã€‚');
                    window.location.href = groupUrl;
                }, 500);
            }

        } catch (e) { 
            showToast('æ“ä½œå¤±æ•—', true); 
            console.error(e); 
        } finally { 
            btn.disabled = false; 
        }
    }

    /** [Realtime] */
    function setupRealtimeListeners() {
        supabaseClient.channel('public:challenges')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'challenges' }, payload => {
                if(payload.eventType==='DELETE') {
                    const el = document.getElementById(`challenge-${payload.old.id}`);
                    if(el) el.remove();
                } else reloadChallengeCard(payload.new.id);
            }).subscribe();
        supabaseClient.channel('public:signups')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'signups' }, payload => {
                const cid = payload.new?.challenge_id || payload.old?.challenge_id;
                if(cid) fetchUserSignups().then(() => reloadChallengeCard(cid));
            }).subscribe();
    }

    /** [åœ¨ç·šç‹€æ…‹] */
    function setupOnlinePresence() {
        const ch = supabaseClient.channel('online-users', { config: { presence: { key: currentUserProfile.nickname } } });
        const upd = () => {
            onlineNicknames = Object.keys(ch.presenceState());
            onlineUsersContainer.querySelector('span').textContent = `åœ¨ç·š: ${onlineNicknames.length}äºº`;
        };
        ch.on('presence', { event: 'sync' }, upd).on('presence', { event: 'join' }, upd).on('presence', { event: 'leave' }, upd)
          .subscribe(status => { if(status==='SUBSCRIBED') ch.track({ online_at: new Date().toISOString() }); });
    }

    /** [å·¥å…·] æˆªåœ– */
    screenshotButton.addEventListener('click', () => {
        screenshotButton.disabled=true; screenshotButton.innerHTML='æˆªåœ–ä¸­...';
        html2canvas(challengesListEl, { backgroundColor: '#111827', useCORS: true, scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `è‡è‡æŒ‘æˆ°_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }).catch(e => showToast('æˆªåœ–å¤±æ•—', true))
          .finally(() => { screenshotButton.disabled=false; screenshotButton.innerHTML='ğŸ“¸ æˆªåœ–'; });
    });

    /** [å·¥å…·] é€šç”¨ */
    function showToast(msg, isErr) {
        toastMessage.textContent = msg;
        toastMessage.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg ${isErr?'bg-red-600':'bg-green-600'}`;
        toastMessage.classList.remove('hidden');
        setTimeout(() => toastMessage.classList.add('hidden'), 3000);
    }
    function getRankSuffix(n) { if(n%100>=11&&n%100<=13)return'th'; switch(n%10){case 1:return'st';case 2:return'nd';case 3:return'rd';default:return'th';} }
    function formatSignupTime(iso) { 
        if(!iso)return''; const d=new Date(iso); 
        return `${d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false})}.${d.getMilliseconds().toString().padStart(3,'0')}`;
    }

    // Filter Tabs
    filterTabs.addEventListener('click', (e) => {
        const t = e.target.closest('.filter-tab');
        if(!t || t.classList.contains('active')) return;
        document.querySelectorAll('.filter-tab').forEach(el=>el.classList.remove('active'));
        t.classList.add('active'); activeFilter = t.dataset.filter; applyFilter();
    });
    function applyFilter() {
        let count=0;
        const cards = document.querySelectorAll('.challenge-card');
        cards.forEach(c => {
            let show=false;
            if(activeFilter==='all' && c.dataset.status!=='å·²é¡æ»¿') show=true;
            else if(activeFilter==='full' && c.dataset.status==='å·²é¡æ»¿') show=true;
            else if(activeFilter==='signed-up' && c.dataset.isSignedUp==='true') show=true;
            else if(activeFilter==='hosted' && c.dataset.isHosted==='true') show=true;
            c.style.display = show ? 'flex' : 'none';
            if(show) count++;
        });
        const msg = document.getElementById('no-items-message'); if(msg) msg.remove();
        if(count===0 && cards.length>0) challengesListEl.insertAdjacentHTML('beforeend', '<p id="no-items-message" class="text-center col-span-full text-gray-400">é€™å€‹åˆ†é¡ä¸‹æ²’æœ‰æŒ‘æˆ°å–”ï¼</p>');
    }

    // Mobile Menu
    hamburgerButton.addEventListener('click', (e) => { e.stopPropagation(); mobileMenu.classList.toggle('hidden'); });
    window.addEventListener('click', (e) => { if(!mobileMenu.classList.contains('hidden') && !mobileMenu.contains(e.target)) mobileMenu.classList.add('hidden'); });
    mobileMenu.querySelector('#leaderboard-button-mobile').onclick = () => leaderboardButton.click();
    mobileMenu.querySelector('#change-password-button-mobile').onclick = () => changePasswordButton.click();
    mobileMenu.querySelector('#logout-button-mobile').onclick = () => logoutButton.click();

    // Global Image Viewer
    window.openImageViewer = function(url) {
        const m = document.getElementById('image-viewer-modal'), i = document.getElementById('viewer-image');
        if(m && i) { i.src=url; m.classList.remove('hidden'); }
    };
    window.closeImageViewer = function() {
        const m = document.getElementById('image-viewer-modal'), i = document.getElementById('viewer-image');
        if(m) { m.classList.add('hidden'); setTimeout(() => { if(i) i.src=''; }, 300); }
    };

    // åœ¨ç·šåˆ—è¡¨
    onlineUsersContainer.addEventListener('click', (e) => {
        if(e.target.closest('#refresh-button')) return;
        onlineUsersList.innerHTML = onlineNicknames.map(n=>`<li class="p-1">${n}</li>`).join('');
        onlineUsersModal.classList.remove('hidden');
    });
    closeOnlineUsersModalButton.addEventListener('click', () => onlineUsersModal.classList.add('hidden'));
    
    /** [å·¥å…·] é‡æ–°æ•´ç†æŒ‰éˆ• (ä¿®å¾©) */
    if (refreshButton) {
        refreshButton.addEventListener('click', (e) => {
            e.stopPropagation(); // é˜²æ­¢é»æ“Šæ™‚åŒæ™‚è§¸ç™¼ã€Œé–‹å•Ÿåœ¨ç·šåå–®ã€
            window.location.reload();
        });
    }

</script>
</body>
</html>
