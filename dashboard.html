<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡è‡å®…é…ç¶² - Pikmin Bloom è˜‘è‡å ±åè¡¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .header-gradient {
            background: #1f2937;
            border-bottom: 1px solid #374151;
        }
        .challenge-card {
            background-color: #1f2937;
            border: 1px solid #374151;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex; 
            flex-direction: column;
            justify-content: space-between;
        }
        .challenge-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.25);
            border-color: #4f46e5;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-weight: bold;
            font-size: 0.8rem;
            text-transform: uppercase;
        }
        .status-open { background-color: #10b981; color: white; }
        .status-full { background-color: #ef4444; color: white; }
        .status-pending { background-color: #f59e0b; color: white; }
        
        .dispatch-pending { background-color: #4b5563; color: white; }
        .dispatch-sent { background-color: #14b8a6; color: white; }

        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); }
        .modal-content {
            background-color: #1f2937;
            border: 1px solid #374151;
        }
        .dark-input {
            background-color: #374151;
            border-color: #4b5563;
            color: #d1d5db;
        }
        .dark-input:focus {
            --tw-ring-color: #4f46e5;
            border-color: #4f46e5;
        }
        .participant-list {
            border-top: 1px solid #374151;
            margin-top: 1rem;
            padding-top: 1rem;
        }
        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #d1d5db;
        }
        .participant-rank {
            font-weight: bold;
            color: #6366f1; /* indigo-500 */
        }

        .leaderboard-tab {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .leaderboard-tab.active {
            border-color: #4f46e5;
            color: #a5b4fc;
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #374151;
        }
        .leaderboard-rank {
            font-size: 1.2rem;
            font-weight: bold;
            width: 40px;
            text-align: center;
        }
        .leaderboard-nickname {
            flex-grow: 1;
        }
        .leaderboard-count {
            font-weight: bold;
        }
        .filter-tab {
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 9999px;
            transition: all 0.2s ease;
            font-weight: 600;
        }
        .filter-tab.active {
            background-color: #4f46e5;
            color: white;
        }
        .filter-tab:not(.active) {
            background-color: #374151;
            color: #d1d5db;
        }
        .filter-tab:not(.active):hover {
            background-color: #4b5563;
        }
    </style>
</head>
<body class="bg-gray-900">

    <header class="header-gradient shadow-md sticky top-0 z-10">
        <!-- RWD: åœ¨å°è¢å¹•(md)ä»¥ä¸‹ï¼Œflex-col è®“å…ƒç´ å‚ç›´æ’åˆ—ï¼Œå¤§è¢å¹•(md)ä»¥ä¸Šæ‰æ˜¯ flex-row æ°´å¹³æ’åˆ— -->
        <div class="container mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-2xl font-bold text-white flex items-center mb-2 md:mb-0">
                <img src="https://s1.aigei.com/src/img/png/12/12945d6a5a45428f80e73fd0ba96b619.png?imageMogr2/auto-orient/thumbnail/!282x282r/gravity/Center/crop/282x282/quality/85/%7CimageView2/2/w/282&e=2051020800&token=P7S2Xpzfz11vAkASLTkfHN7Fw-oOZBecqeJaxypL:tvIa-J9rw1PINd8_blDaacB-7CM=" alt="Pikmin Logo" class="w-10 h-10 mr-2 rounded-full">
                è‡è‡å®…é…ç¶²
            </h1>
             <!-- RWD: ä½¿ç”¨ flex-wrap è®“æŒ‰éˆ•åœ¨ç©ºé–“ä¸è¶³æ™‚å¯ä»¥æ›è¡Œï¼Œä¸¦èª¿æ•´é–“è· -->
            <div class="flex items-center flex-wrap justify-center gap-x-4 gap-y-2">
                <span id="user-info" class="font-semibold text-gray-200 text-sm order-first md:order-none w-full md:w-auto text-center">è®€å–ä¸­...</span>
                <button id="leaderboard-button" class="text-gray-300 hover:text-white transition text-sm">ğŸ† æ’è¡Œæ¦œ</button>
                <a href="./partner.html" class="text-gray-300 hover:text-white transition text-sm">ğŸšš è‡è‡å®…é…é€š</a>
                <a id="admin-link" href="./admin.html" class="hidden text-orange-400 hover:text-orange-300 font-bold transition text-sm">âš™ï¸ ç®¡ç†å¾Œå°</a>
                <button id="change-password-button" class="bg-gray-700 text-white px-3 py-1.5 text-xs rounded-full font-bold hover:bg-gray-600 transition">æ”¹å¯†ç¢¼</button>
                <button id="logout-button" class="bg-red-700 text-white px-3 py-1.5 text-xs rounded-full font-bold hover:bg-red-600 transition">ç™»å‡º</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <!-- RWD: åœ¨å°è¢å¹•(md)ä»¥ä¸‹ï¼Œflex-col è®“å…ƒç´ å‚ç›´æ’åˆ—ä¸¦ç½®ä¸­ï¼Œå¤§è¢å¹•ä»¥ä¸Šæ¢å¾©åŸç‹€ -->
        <div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div id="filter-tabs" class="flex space-x-2 flex-wrap justify-center">
                <button data-filter="all" class="filter-tab active">å…¨éƒ¨æŒ‘æˆ°</button>
                <button data-filter="signed-up" class="filter-tab">æˆ‘çš„å ±å</button>
                <button id="hosted-tab" data-filter="hosted" class="filter-tab hidden">æˆ‘çš„ç™¼å¸ƒ</button>
            </div>
            <button id="post-challenge-button" class="hidden bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition transform hover:scale-105 w-full md:w-auto">
                ğŸ„ ç™¼å¸ƒæ–°æŒ‘æˆ°
            </button>
        </div>
        <!-- RWD: grid-cols-1 æ˜¯é è¨­(æ‰‹æ©Ÿ)ï¼Œmd:ä»¥ä¸Šè®Šå…©æ¬„ï¼Œlg:ä»¥ä¸Šè®Šä¸‰æ¬„ï¼Œé€™æ˜¯åŸæœ¬å°±æ­£ç¢ºçš„å¯«æ³• -->
        <div id="challenges-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <p id="loading-indicator" class="text-center col-span-full text-gray-400">æ­£åœ¨è¼‰å…¥æŒ‘æˆ°åˆ—è¡¨ï¼Œè«‹ç¨å€™...</p>
        </div>
    </main>
    
    <!-- Modals (ç¨‹å¼ç¢¼ä¸è®Š) -->
    <div id="challenge-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop"><div class="modal-content w-full max-w-lg rounded-2xl shadow-xl p-8"><h2 class="text-2xl font-bold mb-6 text-gray-100">ç™¼å¸ƒä¸€å€‹æ–°æŒ‘æˆ°</h2><form id="challenge-form"><div class="space-y-4"><div><label for="mushroom-type" class="block text-sm font-medium text-gray-400">è˜‘è‡ç¨®é¡</label><select id="mushroom-type" required class="dark-input mt-1 block w-full rounded-md shadow-sm"><option value="å·¨è‡" selected>å·¨è‡</option><option value="æ´»å‹•è‡">æ´»å‹•è‡</option><option value="å¤§æ™¶">å¤§æ™¶</option><option value="å¤§ç«">å¤§ç«</option><option value="å¤§æ°´">å¤§æ°´</option><option value="å¤§é›»">å¤§é›»</option><option value="å¤§æ¯’">å¤§æ¯’</option><option value="å¤§ç´…">å¤§ç´…</option><option value="å¤§é»ƒ">å¤§é»ƒ</option><option value="å¤§è—">å¤§è—</option><option value="å¤§ç´«">å¤§ç´«</option><option value="å¤§ç²‰">å¤§ç²‰</option><option value="å¤§ç°">å¤§ç°</option><option value="å¤§ç™½">å¤§ç™½</option><option value="æ™¶">æ™¶</option><option value="æ°´">æ°´</option><option value="ç«">ç«</option><option value="é›»">é›»</option><option value="æ¯’">æ¯’</option></select></div><div><label for="slots" class="block text-sm font-medium text-gray-400">åé¡</label><input type="number" id="slots" min="1" required class="dark-input mt-1 block w-full rounded-md shadow-sm"></div><div><div class="flex justify-between items-center"><label for="start-time" class="block text-sm font-medium text-gray-400">é–‹æ”¾å ±åæ™‚é–“</label><button type="button" id="set-time-now-button" class="text-xs bg-indigo-500 text-white px-2 py-1 rounded-md hover:bg-indigo-600">ç«‹å³é–‹æ”¾</button></div><input type="datetime-local" id="start-time" required class="dark-input mt-1 block w-full rounded-md shadow-sm"></div><div><label for="details" class="block text-sm font-medium text-gray-400">ç”¨é¤æ™‚æ®µ</label><select id="details" required class="dark-input mt-1 block w-full rounded-md shadow-sm"><option value="æ»¿äººé–‹">æ»¿äººé–‹</option><option value="æ—©é¤">æ—©é¤</option><option value="å®µå¤œ" selected>å®µå¤œ</option></select></div></div><div class="mt-8 flex justify-end space-x-4"><button type="button" id="cancel-modal-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">å–æ¶ˆ</button><button type="submit" id="submit-challenge-button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-50">ç¢ºèªç™¼å¸ƒ</button></div></form></div></div>
    <div id="delete-confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop"><div class="modal-content w-full max-w-sm rounded-2xl shadow-xl p-8"><h2 class="text-xl font-bold mb-4 text-white">ç¢ºèªåˆªé™¤</h2><p class="text-gray-400 mb-6">æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹æŒ‘æˆ°å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p><div class="flex justify-end space-x-4"><button type="button" id="cancel-delete-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">å–æ¶ˆ</button><button type="button" id="confirm-delete-button" class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 disabled:opacity-50">ç¢ºèªåˆªé™¤</button></div></div></div>
    <div id="leaderboard-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop"><div class="modal-content w-full max-w-lg rounded-2xl shadow-xl p-8"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gray-100">ğŸ† æ’è¡Œæ¦œ</h2><button type="button" id="close-leaderboard-button" class="text-gray-500 hover:text-white">&times;</button></div><div id="leaderboard-tabs" class="flex border-b border-gray-600 mb-4 overflow-x-auto"><button data-type="count" data-period="week" class="leaderboard-tab active whitespace-nowrap">æœ¬é€±å ±åç‹</button><button data-type="count" data-period="month" class="leaderboard-tab whitespace-nowrap">æœ¬æœˆå ±åç‹</button><button data-type="speed" data-period="week" class="leaderboard-tab whitespace-nowrap">æœ¬é€±æœ€é€Ÿ</button><button data-type="speed" data-period="month" class="leaderboard-tab whitespace-nowrap">æœ¬æœˆæœ€é€Ÿ</button></div><div id="leaderboard-content" class="space-y-2 max-h-96 overflow-y-auto"><p>è®€å–ä¸­...</p></div></div></div>
    <div id="password-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop"><div class="modal-content w-full max-w-md rounded-2xl shadow-xl p-8"><h2 class="text-2xl font-bold mb-6 text-gray-100">ä¿®æ”¹å¯†ç¢¼</h2><form id="password-form"><div class="space-y-4"><div><label for="new-password" class="block text-sm font-medium text-gray-400">æ–°å¯†ç¢¼ (è‡³å°‘6ä½æ•¸)</label><input type="password" id="new-password" required minlength="6" class="dark-input mt-1 block w-full rounded-md shadow-sm"></div><div><label for="confirm-password" class="block text-sm font-medium text-gray-400">ç¢ºèªæ–°å¯†ç¢¼</label><input type="password" id="confirm-password" required minlength="6" class="dark-input mt-1 block w-full rounded-md shadow-sm"></div></div><div class="mt-8 flex justify-end space-x-4"><button type="button" id="cancel-password-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">å–æ¶ˆ</button><button type="submit" id="submit-password-button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-50">ç¢ºèªä¿®æ”¹</button></div></form></div></div>
    <div id="toast-message" class="hidden fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg"></div>

    <script>
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0ZGRkbW9jbG1ocWVieXZ6ZWFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzNjQ5NDAsImV4cCI6MjA2NDk0MDk0MH0.HW9N1aGETLdhMGlqGtQwDhKXhILX0AxfzDGPqlMkrTk';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const userInfoEl = document.getElementById('user-info');
        const changePasswordButton = document.getElementById('change-password-button');
        const logoutButton = document.getElementById('logout-button');
        const postChallengeButton = document.getElementById('post-challenge-button');
        const challengesListEl = document.getElementById('challenges-list');
        const challengeModal = document.getElementById('challenge-modal');
        const challengeForm = document.getElementById('challenge-form');
        const cancelModalButton = document.getElementById('cancel-modal-button');
        const setTimeNowButton = document.getElementById('set-time-now-button');
        const submitChallengeButton = document.getElementById('submit-challenge-button');
        const toastMessage = document.getElementById('toast-message');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const cancelDeleteButton = document.getElementById('cancel-delete-button');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const leaderboardButton = document.getElementById('leaderboard-button');
        const leaderboardModal = document.getElementById('leaderboard-modal');
        const leaderboardTabs = document.getElementById('leaderboard-tabs');
        const leaderboardContent = document.getElementById('leaderboard-content');
        const closeLeaderboardButton = document.getElementById('close-leaderboard-button');
        const passwordModal = document.getElementById('password-modal');
        const passwordForm = document.getElementById('password-form');
        const cancelPasswordButton = document.getElementById('cancel-password-button');
        const submitPasswordButton = document.getElementById('submit-password-button');
        const filterTabs = document.getElementById('filter-tabs');
        const hostedTab = document.getElementById('hosted-tab');
        const adminLink = document.getElementById('admin-link'); // ã€æ¬Šé™æ•´åˆã€‘

        let currentUserProfile = null;
        let challengeToDeleteId = null;
        let userSignedUpChallengeIds = new Set(); 
        let countdownInterval = null; 
        let activeFilter = 'all';

        async function initializePage() {
            supabaseClient.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_OUT' || !session) {
                    if (countdownInterval) clearInterval(countdownInterval);
                    window.location.replace('./index.html');
                }
            });

            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) return;
            
            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .single();

            if (error || !profile) {
                console.error('ç²å–å€‹äººæª”æ¡ˆå¤±æ•—æˆ–ç„¡æ•ˆ:', error);
                await supabaseClient.auth.signOut();
                return;
            }
            
            currentUserProfile = profile;
            displayUserInfo();
            
            await fetchUserSignups();
            await fetchChallenges();
            setupRealtimeListeners();
            startGlobalCountdown();
        }

        function displayUserInfo() {
            if (!currentUserProfile) return;
            userInfoEl.textContent = `ä½ å¥½ï¼Œ${currentUserProfile.nickname}ï¼`;
            
            if (currentUserProfile.role === 'ç®¡ç†è€…' || currentUserProfile.role === 'ç™¼è‡è€…') {
                postChallengeButton.classList.remove('hidden');
                hostedTab.classList.remove('hidden');
            }
            
            if (currentUserProfile.role === 'ç®¡ç†è€…') {
                adminLink.classList.remove('hidden');
            }
        }
        
        async function fetchUserSignups() {
            const { data, error } = await supabaseClient
                .from('signups')
                .select('challenge_id')
                .eq('user_id', currentUserProfile.id);

            if (error) {
                console.error('ç²å–ä½¿ç”¨è€…å ±åç´€éŒ„å¤±æ•—:', error);
                return;
            }
            userSignedUpChallengeIds = new Set(data.map(signup => signup.challenge_id));
        }
        
        async function fetchChallenges() {
            const { data: challenges, error } = await supabaseClient
                .from('challenges')
                .select(`*, host:profiles(nickname, id), signups(*, profile:profiles(nickname))`)
                .order('start_time', { ascending: false });

            if (error) {
                console.error('ç²å–æŒ‘æˆ°åˆ—è¡¨å¤±æ•—:', error);
                challengesListEl.innerHTML = '<p class="text-center col-span-full text-red-400">ç„¡æ³•è¼‰å…¥æŒ‘æˆ°ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
                return;
            }
            
            const loadingIndicator = document.getElementById('loading-indicator');
            if(loadingIndicator) loadingIndicator.remove();
            
            challengesListEl.innerHTML = ''; 
            challenges.forEach(challenge => renderChallenge(challenge));
            applyFilter();
        }

        function renderChallenge(challenge) {
            const card = document.createElement('div');
            card.className = 'challenge-card bg-gray-800 rounded-xl shadow-md overflow-hidden p-6 flex flex-col justify-between';
            card.id = `challenge-${challenge.id}`;
            const statusClass = challenge.status === 'é–‹æ”¾å ±åä¸­' ? 'status-open' : (challenge.status === 'å·²é¡æ»¿' ? 'status-full' : 'status-pending');

            const isHost = challenge.host && challenge.host.id === currentUserProfile.id;
            const isSignedUp = userSignedUpChallengeIds.has(challenge.id);

            if (isHost) card.dataset.isHosted = 'true';
            if (isSignedUp) card.dataset.isSignedUp = 'true';

            const deleteButtonHtml = isHost ? `<button data-id="${challenge.id}" class="delete-challenge-button text-gray-500 hover:text-red-500 transition">ğŸ—‘ï¸</button>` : '';
            const isFull = challenge.status === 'å·²é¡æ»¿';

            let actionButtonHtml;
            if (isHost) {
                actionButtonHtml = `<button class="w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg cursor-default">æ‚¨æ˜¯ç™¼è‡è€…</button>`;
            } else if (isSignedUp) {
                actionButtonHtml = `<button class="cancel-signup-button w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition" data-challenge-id="${challenge.id}">å–æ¶ˆå ±å</button>`;
            } else if (challenge.status === 'é è¨ˆé–‹æ”¾') {
                actionButtonHtml = `<button class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed" disabled>å°šæœªé–‹æ”¾</button>`;
            } else if (isFull) {
                actionButtonHtml = `<button class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed" disabled>å·²é¡æ»¿</button>`;
            } else {
                 actionButtonHtml = `<button class="signup-button w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition" data-challenge-id="${challenge.id}">å ±å</button>`;
            }

            const signupCount = challenge.signups ? challenge.signups.length : 0;
            
            let participantsHtml = '';
            if (signupCount > 0) {
                const sortedSignups = [...challenge.signups].sort((a, b) => new Date(a.signed_up_at) - new Date(b.signed_up_at));
                const participantsList = sortedSignups.map((signup, index) => {
                    const rank = index + 1;
                    const rankText = `${rank}${getRankSuffix(rank)}`;
                    const nickname = signup.profile ? signup.profile.nickname : 'æœªçŸ¥ç”¨æˆ¶';
                    const time = formatSignupTime(signup.signed_up_at);
                    return `<div class="participant-item"><span><span class="participant-rank">${rankText}</span> ${nickname}</span><span>${time}</span></div>`;
                }).join('');
                participantsHtml = `<div class="participant-list">${participantsList}</div>`;
            }

            let startTimeHtml;
            if (challenge.status === 'é è¨ˆé–‹æ”¾' && new Date(challenge.start_time) > new Date()) { 
                startTimeHtml = `<p><strong>ç­‰å¾…æ™‚é–“:</strong> <span class="countdown-timer" data-starttime="${challenge.start_time}">è¨ˆç®—ä¸­...</span></p>`;
            } else {
                startTimeHtml = `<p><strong>é–‹æ”¾æ™‚é–“:</strong> ${new Date(challenge.start_time).toLocaleString('zh-TW', { hour12: false })}</p>`;
            }

            let dispatchTagHtml = '';
            if (signupCount > 0) {
                const dispatchStatus = challenge.dispatch_status || 'å¾…ç™¼';
                const dispatchClass = dispatchStatus === 'å·²ç™¼' ? 'dispatch-sent' : 'dispatch-pending';
                const isClickable = isHost ? 'cursor-pointer' : '';
                dispatchTagHtml = `<span class="status-badge ${dispatchClass} ${isClickable} dispatch-status-tag" data-id="${challenge.id}" data-current-status="${dispatchStatus}">${dispatchStatus}</span>`;
            }

            card.innerHTML = `
                <div>
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold text-gray-100">${challenge.mushroom_type}</h3>
                        <div class="flex items-center space-x-2">
                           ${dispatchTagHtml}
                           <span class="status-badge ${statusClass}">${challenge.status}</span>
                           ${deleteButtonHtml}
                        </div>
                    </div>
                    <div class="text-gray-400 space-y-2 mb-4">
                        <p><strong>ç™¼è‡è€…:</strong> ${challenge.host ? challenge.host.nickname : 'æœªçŸ¥'}</p>
                        <p><strong>ç”¨é¤æ™‚æ®µ:</strong> ${challenge.details || 'æœªæŒ‡å®š'}</p>
                        <p><strong>åé¡:</strong> <span id="signup-count-${challenge.id}">${signupCount}</span> / ${challenge.slots}</p>
                        ${startTimeHtml}
                    </div>
                    ${participantsHtml}
                </div>
                <div class="mt-4">${actionButtonHtml}</div>
            `;
            
            const existingCard = document.getElementById(card.id);
            if(existingCard) {
                challengesListEl.replaceChild(card, existingCard);
            } else {
                challengesListEl.prepend(card);
            }
        }

        async function reloadChallengeCard(challengeId) {
            const { data: challenge, error } = await supabaseClient
                .from('challenges')
                .select(`*, host:profiles(nickname, id), signups(*, profile:profiles(nickname))`)
                .eq('id', challengeId)
                .single();
            
            if (error) {
                if (error.code === 'PGRST116') {
                    const cardToRemove = document.getElementById(`challenge-${challengeId}`);
                    if(cardToRemove) cardToRemove.remove();
                } else {
                    console.error('é‡è¼‰å¡ç‰‡å¤±æ•—:', error);
                }
                return;
            }
            renderChallenge(challenge);
            applyFilter();
        }
        
        function setupRealtimeListeners() {
            supabaseClient.channel('public:challenges')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'challenges' }, payload => {
                    const eventType = payload.eventType;
                    const challengeId = eventType === 'DELETE' ? payload.old.id : payload.new.id;
                    if (eventType === 'DELETE') {
                        const cardToRemove = document.getElementById(`challenge-${challengeId}`);
                        if (cardToRemove) cardToRemove.remove();
                    } else {
                        reloadChallengeCard(challengeId);
                    }
                })
                .subscribe();

            supabaseClient.channel('public:signups')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'signups' }, (payload) => {
                    const challengeId = payload.new?.challenge_id || payload.old?.challenge_id;
                    if (challengeId) {
                        fetchUserSignups().then(() => {
                           reloadChallengeCard(challengeId);
                        });
                    }
                })
                .subscribe();
        }

        document.addEventListener('DOMContentLoaded', initializePage);

        filterTabs.addEventListener('click', (e) => {
            const tab = e.target.closest('.filter-tab');
            if (!tab || tab.classList.contains('active')) return;
            filterTabs.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            activeFilter = tab.dataset.filter;
            applyFilter();
        });

        logoutButton.addEventListener('click', async () => {
            logoutButton.disabled = true;
            logoutButton.textContent = 'ç™»å‡ºä¸­...';
            const { error } = await supabaseClient.auth.signOut();
            if (error) {
                showToast(`ç™»å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, true);
                logoutButton.disabled = false;
                logoutButton.textContent = 'ç™»å‡º';
            }
        });
        
        postChallengeButton.addEventListener('click', () => {
            challengeForm.reset();
            challengeForm['mushroom-type'].value = 'å·¨è‡';
            challengeForm['slots'].value = 4;
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            challengeForm['start-time'].value = now.toISOString().slice(0, 16);
            challengeModal.classList.remove('hidden');
        });

        cancelModalButton.addEventListener('click', () => challengeModal.classList.add('hidden'));
        
        setTimeNowButton.addEventListener('click', () => {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            challengeForm['start-time'].value = now.toISOString().slice(0, 16);
        });

        challengeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitChallengeButton.disabled = true;
            submitChallengeButton.textContent = 'ç™¼å¸ƒä¸­...';

            const form = e.target;
            const startTime = new Date(form['start-time'].value);
            const newChallengeData = {
                host_id: currentUserProfile.id,
                mushroom_type: form['mushroom-type'].value,
                slots: parseInt(form['slots'].value),
                start_time: startTime.toISOString(),
                details: form['details'].value,
                status: startTime > new Date() ? 'é è¨ˆé–‹æ”¾' : 'é–‹æ”¾å ±åä¸­'
            };

            const { data: insertedChallenge, error } = await supabaseClient
                .from('challenges')
                .insert(newChallengeData)
                .select()
                .single(); 
            
            if (error) {
                showToast(`ç™¼å¸ƒå¤±æ•—: ${error.message}`, true);
            } else {
                showToast('æ–°æŒ‘æˆ°å·²æˆåŠŸç™¼å¸ƒï¼', false);
                challengeModal.classList.add('hidden');
                
                const fullChallengeObject = {
                    ...insertedChallenge,
                    host: { id: currentUserProfile.id, nickname: currentUserProfile.nickname },
                    signups: []
                };
                renderChallenge(fullChallengeObject);
                applyFilter();
            }
            submitChallengeButton.disabled = false;
            submitChallengeButton.textContent = 'ç¢ºèªç™¼å¸ƒ';
        });
        
        challengesListEl.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-challenge-button');
            if (deleteButton) {
                challengeToDeleteId = deleteButton.dataset.id;
                deleteConfirmModal.classList.remove('hidden');
                return;
            }
            const signupButton = e.target.closest('.signup-button');
            if (signupButton) {
                handleSignUp(signupButton.dataset.challengeId, signupButton);
                return;
            }
            const cancelButton = e.target.closest('.cancel-signup-button');
            if (cancelButton) {
                handleCancelSignUp(cancelButton.dataset.challengeId, cancelButton);
                return;
            }
            const dispatchTag = e.target.closest('.dispatch-status-tag');
            if (dispatchTag && dispatchTag.classList.contains('cursor-pointer')) {
                handleToggleDispatchStatus(dispatchTag.dataset.id, dispatchTag.dataset.currentStatus);
                return;
            }
        });
        
        async function deleteChallenge(id) {
            confirmDeleteButton.disabled = true;
            confirmDeleteButton.textContent = 'åˆªé™¤ä¸­...';
            const { error } = await supabaseClient.from('challenges').delete().eq('id', id);
            
            if (error) {
                showToast(`åˆªé™¤å¤±æ•—: ${error.message}`, true);
            } else {
                showToast('æŒ‘æˆ°å·²æˆåŠŸåˆªé™¤ï¼', false);
                const cardToRemove = document.getElementById(`challenge-${id}`);
                if (cardToRemove) {
                    cardToRemove.remove();
                }
            }
            hideDeleteConfirmModal();
        }
        
        cancelDeleteButton.addEventListener('click', () => hideDeleteConfirmModal());
        confirmDeleteButton.addEventListener('click', () => { if (challengeToDeleteId) deleteChallenge(challengeToDeleteId); });
        function hideDeleteConfirmModal() {
            challengeToDeleteId = null;
            deleteConfirmModal.classList.add('hidden');
            confirmDeleteButton.disabled = false;
            confirmDeleteButton.textContent = 'ç¢ºèªåˆªé™¤';
        }

        async function handleSignUp(challengeId, buttonEl) {
            buttonEl.disabled = true;
            buttonEl.textContent = 'å ±åä¸­...';
            const numericChallengeId = parseInt(challengeId);
            const { error } = await supabaseClient.rpc('signup_for_challenge', {
                challenge_id_to_signup: numericChallengeId
            });

            if (error) {
                showToast(`å ±åå¤±æ•—: ${error.message.includes('full') ? 'è˜‘è‡å·²é¡æ»¿ï¼' : error.message}`, true);
                reloadChallengeCard(challengeId);
            } else {
                showToast('å ±åæˆåŠŸï¼', false);
                userSignedUpChallengeIds.add(numericChallengeId);
                reloadChallengeCard(challengeId); 
            }
        }

        async function handleCancelSignUp(challengeId, buttonEl) {
            buttonEl.disabled = true;
            buttonEl.textContent = 'å–æ¶ˆä¸­...';
            const numericChallengeId = parseInt(challengeId);
            const { error } = await supabaseClient.rpc('cancel_signup_and_update_challenge', {
                challenge_id_to_cancel: numericChallengeId
            });

            if (error) {
                showToast(`å–æ¶ˆå¤±æ•—: ${error.message}`, true);
                reloadChallengeCard(challengeId);
            } else {
                showToast('å·²å–æ¶ˆå ±å', false);
                userSignedUpChallengeIds.delete(numericChallengeId);
                reloadChallengeCard(challengeId);
            }
        }

        async function handleToggleDispatchStatus(challengeId, currentStatus) {
            const newStatus = currentStatus === 'å¾…ç™¼' ? 'å·²ç™¼' : 'å¾…ç™¼';
            const { error } = await supabaseClient
                .from('challenges')
                .update({ dispatch_status: newStatus })
                .eq('id', challengeId);
            
            if (error) {
                showToast(`æ›´æ–°ç‹€æ…‹å¤±æ•—: ${error.message}`, true);
                reloadChallengeCard(challengeId);
            } else {
                reloadChallengeCard(challengeId);
            }
        }
        
        leaderboardButton.addEventListener('click', () => {
            leaderboardModal.classList.remove('hidden');
            const firstTab = leaderboardTabs.querySelector('.leaderboard-tab');
            if(firstTab) {
                switchLeaderboardTab(firstTab);
            }
        });
        closeLeaderboardButton.addEventListener('click', () => {
            leaderboardModal.classList.add('hidden');
        });
        leaderboardTabs.addEventListener('click', (e) => {
            const tab = e.target.closest('.leaderboard-tab');
            if (tab && !tab.classList.contains('active')) {
                switchLeaderboardTab(tab);
            }
        });
        function switchLeaderboardTab(tab) {
            leaderboardTabs.querySelectorAll('.leaderboard-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            const type = tab.dataset.type;
            const period = tab.dataset.period;
            
            fetchLeaderboard(type, period);
        }
        async function fetchLeaderboard(type, period) {
            leaderboardContent.innerHTML = '<p>è®€å–ä¸­...</p>';
            
            const functionName = type === 'count' 
                ? 'get_leaderboard_from_profiles' 
                : 'get_speed_leaderboard_from_profiles';

            const { data, error } = await supabaseClient.rpc(functionName, {
                period_type: period
            });

            if (error) {
                console.error(`ç²å– ${type} (${period}) æ’è¡Œæ¦œå¤±æ•—:`, error);
                leaderboardContent.innerHTML = `<p class="text-red-400">ç„¡æ³•è¼‰å…¥æ’è¡Œæ¦œè³‡æ–™ã€‚</p>`;
                return;
            }
            
            if (type === 'count') {
                renderCountLeaderboard(data);
            } else {
                renderSpeedLeaderboard(data);
            }
        }
        function renderCountLeaderboard(data) {
            if (!data || data.length === 0) {
                leaderboardContent.innerHTML = '<p>ç›®å‰æ²’æœ‰ç´€éŒ„ã€‚</p>'; return;
            }
            const listHtml = data.map((item, index) => {
                const rank = index + 1;
                let rankDisplay = rank === 1 ? 'ğŸ¥‡' : (rank === 2 ? 'ğŸ¥ˆ' : (rank === 3 ? 'ğŸ¥‰' : rank));
                return `<div class="leaderboard-item"><span class="leaderboard-rank">${rankDisplay}</span><span class="leaderboard-nickname">${item.nickname}</span><span class="leaderboard-count">${item.signup_count} æ¬¡</span></div>`;
            }).join('');
            leaderboardContent.innerHTML = listHtml;
        }
        function renderSpeedLeaderboard(data) {
            if (!data || data.length === 0) {
                leaderboardContent.innerHTML = '<p>ç›®å‰æ²’æœ‰ç´€éŒ„ã€‚</p>'; return;
            }
            const listHtml = data.map((item, index) => {
                const rank = index + 1;
                let rankDisplay = rank === 1 ? 'ğŸ¥‡' : (rank === 2 ? 'ğŸ¥ˆ' : (rank === 3 ? 'ğŸ¥‰' : rank));
                const timeInSeconds = parseFloat(item.fastest_time_seconds).toFixed(3);
                return `<div class="leaderboard-item"><span class="leaderboard-rank">${rankDisplay}</span><span class="leaderboard-nickname">${item.nickname}</span><span class="leaderboard-count">${timeInSeconds} s</span></div>`;
            }).join('');
            leaderboardContent.innerHTML = listHtml;
        }
        
        changePasswordButton.addEventListener('click', () => {
            passwordForm.reset();
            passwordModal.classList.remove('hidden');
        });
        cancelPasswordButton.addEventListener('click', () => {
            passwordModal.classList.add('hidden');
        });
        passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            if (newPassword.length < 6) {
                showToast('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦6ä½æ•¸ã€‚', true); return;
            }
            if (newPassword !== confirmPassword) {
                showToast('å…©æ¬¡è¼¸å…¥çš„æ–°å¯†ç¢¼ä¸ä¸€è‡´ã€‚', true); return;
            }
            submitPasswordButton.disabled = true;
            submitPasswordButton.textContent = 'ä¿®æ”¹ä¸­...';
            const { error } = await supabaseClient.auth.updateUser({ password: newPassword });
            if (error) {
                showToast(`å¯†ç¢¼ä¿®æ”¹å¤±æ•—: ${error.message}`, true);
            } else {
                showToast('å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼ä¸‹æ¬¡ç™»å…¥æ™‚è«‹ä½¿ç”¨æ–°å¯†ç¢¼ã€‚', false);
                passwordModal.classList.add('hidden');
            }
            submitPasswordButton.disabled = false;
            submitPasswordButton.textContent = 'ç¢ºèªä¿®æ”¹';
        });

        function getRankSuffix(rank) {
            if (rank % 100 >= 11 && rank % 100 <= 13) return 'th';
            switch (rank % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }
        function formatSignupTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const timeString = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            const milliseconds = date.getMilliseconds().toString().padStart(3, '0');
            return `${timeString}.${milliseconds}`;
        }
        
        async function triggerChallengeOpening(challengeId, timerElement) {
            if (!timerElement.classList.contains('countdown-timer')) {
                return;
            }
            timerElement.classList.remove('countdown-timer');
            timerElement.textContent = 'é–‹æ”¾ä¸­...';

            const { error } = await supabaseClient
                .from('challenges')
                .update({ status: 'é–‹æ”¾å ±åä¸­' })
                .eq('id', challengeId)
                .eq('status', 'é è¨ˆé–‹æ”¾');
            
            reloadChallengeCard(challengeId);

            if (error) {
                console.log(`å˜—è©¦è‡ªå‹•é–‹å•ŸæŒ‘æˆ° ${challengeId} æ™‚ï¼Œå®ƒå¯èƒ½å·²è¢«å…¶ä»–ä½¿ç”¨è€…æ›´æ–°ã€‚éŒ¯èª¤è¨Šæ¯: ${error.message}`);
            }
        }

        function updateAllCountdowns() {
            document.querySelectorAll('.countdown-timer').forEach(el => {
                const startTime = new Date(el.dataset.starttime);
                const diff = startTime - new Date();

                if (diff < 1000) {
                    const card = el.closest('.challenge-card');
                    if (card) {
                        const challengeId = parseInt(card.id.split('-')[1]);
                        if (challengeId) {
                            triggerChallengeOpening(challengeId, el);
                        }
                    }
                } else {
                    const days = Math.floor(diff / 86400000);
                    const hours = Math.floor((diff % 86400000) / 3600000);
                    const minutes = Math.floor((diff % 3600000) / 60000);
                    const seconds = Math.floor((diff % 60000) / 1000);
                    if (days > 0) el.textContent = `${days}å¤©${hours}å°æ™‚å¾Œ`;
                    else if (hours > 0) el.textContent = `${hours}å°æ™‚${minutes}åˆ†é˜å¾Œ`;
                    else if (minutes > 0) el.textContent = `${minutes}åˆ†é˜${seconds}ç§’å¾Œ`;
                    else el.textContent = `${seconds}ç§’å¾Œ`;
                }
            });
        }

        function startGlobalCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(updateAllCountdowns, 1000); 
            updateAllCountdowns();
        }
        function showToast(message, isError = false) {
            toastMessage.textContent = message;
            toastMessage.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            toastMessage.classList.remove('hidden');
            setTimeout(() => { toastMessage.classList.add('hidden'); }, 3000);
        }

        function applyFilter() {
            let visibleCount = 0;
            const allCards = challengesListEl.querySelectorAll('.challenge-card');
            
            allCards.forEach(card => {
                let show = false;
                if (activeFilter === 'all') {
                    show = true;
                } else if (activeFilter === 'signed-up') {
                    if (card.dataset.isSignedUp === 'true') show = true;
                } else if (activeFilter === 'hosted') {
                    if (card.dataset.isHosted === 'true') show = true;
                }
                card.style.display = show ? 'flex' : 'none';
                if(show) visibleCount++;
            });

            const noItemsMessage = document.getElementById('no-items-message');
            if (noItemsMessage) noItemsMessage.remove();

            if(visibleCount === 0 && allCards.length > 0) {
                const p = document.createElement('p');
                p.id = 'no-items-message';
                p.className = 'text-center col-span-full text-gray-400';
                p.textContent = 'é€™å€‹åˆ†é¡ä¸‹æ²’æœ‰æŒ‘æˆ°å–”ï¼';
                challengesListEl.appendChild(p);
            }
        }
    </script>
</body>
</html>
