<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡è‡å®…é…ç¶² - Pikmin Bloom è˜‘è‡å ±åè¡¨5.0</title>
    <link rel="icon" href="./mashroom_s.png" type="image/png">
    <link rel="apple-touch-icon" href="./mashroom_s.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .header-gradient {
            background: #1f2937;
            border-bottom: 1px solid #374151;
        }
        .challenge-card {
            background-color: #1f2937;
            border: 1px solid #374151;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex; 
            flex-direction: column;
            justify-content: space-between;
        }
        .challenge-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.25);
            border-color: #4f46e5;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-weight: bold;
            font-size: 0.8rem;
            text-transform: uppercase;
        }
        .status-open { background-color: #10b981; color: white; }
        .status-full { background-color: #ef4444; color: white; }
        .status-pending { background-color: #f59e0b; color: white; }
        
        .dispatch-pending { background-color: #4b5563; color: white; }
        .dispatch-sent { background-color: #14b8a6; color: white; }

        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); }
        .modal-content {
            background-color: #1f2937;
            border: 1px solid #374151;
        }
        .dark-input {
            background-color: #374151;
            border-color: #4b5563;
            color: #d1d5db;
        }
        .dark-input:focus {
            --tw-ring-color: #4f46e5;
            border-color: #4f46e5;
        }
        .participant-list {
            border-top: 1px solid #374151;
            margin-top: 1rem;
            padding-top: 1rem;
        }
        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #d1d5db;
        }
        .participant-rank {
            font-weight: bold;
            color: #6366f1; /* indigo-500 */
        }

        .leaderboard-tab {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .leaderboard-tab.active {
            border-color: #4f46e5;
            color: #a5b4fc;
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #374151;
        }
        .leaderboard-rank {
            font-size: 1.2rem;
            font-weight: bold;
            width: 40px;
            text-align: center;
        }
        .leaderboard-nickname {
            flex-grow: 1;
        }
        .leaderboard-count {
            font-weight: bold;
        }
        .filter-tab {
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 9999px;
            transition: all 0.2s ease;
            font-weight: 600;
        }
        .filter-tab.active {
            background-color: #4f46e5;
            color: white;
        }
        .filter-tab:not(.active) {
            background-color: #374151;
            color: #d1d5db;
        }
        .filter-tab:not(.active):hover {
            background-color: #4b5563;
        }
        .filter-tab:not(.active):hover {
            background-color: #4b5563;
        }
        
        /* ä¿®æ”¹ï¼šè·‘é¦¬ç‡ˆå‹•ç•« (æ”¹ç‚ºç”± JS æ§åˆ¶é‡æ’­) */
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .animate-marquee {
            /* é€™è£¡çš„æ™‚é–“ 20s æ˜¯é è¨­å€¼ï¼Œç¨å¾Œ JS æœƒå‹•æ…‹è¦†å¯« */
            animation: marquee 20s linear forwards; 
            padding-left: 0; /* ç§»é™¤ä¹‹å‰çš„ paddingï¼Œç”± transform æ§åˆ¶ä½ç½® */
            display: inline-block;
            white-space: nowrap;
        }

        /* æ–°å¢ï¼šå†·å»ä¸­çš„æŒ‰éˆ•æ¨£å¼ */
        .btn-cooldown {
            background-color: #4b5563 !important; /* ç°è‰² */
            cursor: not-allowed !important;
            filter: grayscale(100%);
            transform: none !important;
        }
    </style>
</head>
<body class="bg-gray-900">

<header class="header-gradient shadow-md sticky top-0 z-20">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center relative">
        
        <div class="flex items-center gap-4">
            <button id="hamburger-button" class="p-2 md:hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-list text-white" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                </svg>
            </button>
            
            <div class="flex items-center gap-2">
                <h1 class="text-xl font-bold text-white flex items-center">
                    <img src="./mashroom.png" alt="Pikmin Logo" class="w-10 h-10 mr-2 rounded-full">
                    <span class="hidden md:inline-block">è‡è‡å®…é…ç¶²</span>
                </h1>
                <div id="online-users-container" class="flex items-center gap-2 text-sm text-white cursor-pointer hover:text-gray-300 transition" title="æŸ¥çœ‹åœ¨ç·šåˆ—è¡¨">
                    <span></span>
                    <button id="refresh-button" title="é‡æ–°æ•´ç†" class="hover:text-white transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-x-4 flex-wrap justify-end">
            <span id="user-info" class="font-semibold text-gray-200 text-sm text-center">è®€å–ä¸­...</span>
            <span id="daily-quota-display" class="text-sm text-gray-400 border-l border-gray-600 pl-4 ml-2"></span>
            
            <div class="hidden md:flex items-center gap-x-4">
                <button id="leaderboard-button" class="text-gray-300 hover:text-white transition text-sm">ğŸ† æ’è¡Œæ¦œ</button>
                <a href="./partner.html" class="text-gray-300 hover:text-white transition text-sm">ğŸ¤ æ‘æ°‘å¥½å‹ç¢¼</a>
                <a href="https://joystick-gpx-convert.netlify.app/" target="_blank" class="text-gray-300 hover:text-white transition text-sm">ğŸ”ƒ è·¯å¾‘è½‰æª”</a>
                <a id="gpx-generator-link" href="./gpx_generator.html" class="text-green-400 hover:text-green-300 font-bold transition text-sm">ğŸ—ºï¸ è·¯å¾‘ç”Ÿæˆ</a>
                <a id="admin-link" href="./admin.html" class="hidden text-orange-400 hover:text-orange-300 font-bold transition text-sm">âš™ï¸ ç®¡ç†å¾Œå°</a>
                <button id="change-password-button" class="bg-gray-700 text-white px-3 py-1.5 text-xs rounded-full font-bold hover:bg-gray-600 transition">ãŠ™ï¸ æ”¹å¯†ç¢¼</button>
                <button id="logout-button" class="bg-red-700 text-white px-3 py-1.5 text-xs rounded-full font-bold hover:bg-red-600 transition">ğŸƒâ€â™‚ï¸ ç™»å‡º</button>
            </div>
        </div>

        <div id="mobile-menu" class="hidden absolute top-full left-0 mt-2 w-48 bg-gray-800 rounded-lg shadow-lg p-2">
            <div class="space-y-1">
                <button id="leaderboard-button-mobile" class="w-full text-left text-gray-300 hover:bg-gray-700 p-2 rounded-md">ğŸ† æ’è¡Œæ¦œ</button>
                <a href="./partner.html" class="block text-gray-300 hover:bg-gray-700 p-2 rounded-md">ğŸ¤ æ‘æ°‘å¥½å‹ç¢¼</a>
                <a href="https://joystick-gpx-convert.netlify.app/" target="_blank" class="block text-gray-300 hover:bg-gray-700 p-2 rounded-md">ğŸ”ƒ è·¯å¾‘è½‰æª”</a>
                <a id="gpx-generator-link-mobile" href="./gpx_generator.html" class="block text-green-400 hover:bg-gray-700 p-2 rounded-md font-bold">ğŸ—ºï¸ è·¯å¾‘ç”Ÿæˆ</a>
            </div>
            <hr class="border-gray-600 my-2">
            <div class="space-y-1">
                <a id="admin-link-mobile" href="./admin.html" class="hidden block text-orange-400 hover:bg-gray-700 p-2 rounded-md font-bold">âš™ï¸ ç®¡ç†å¾Œå°</a>
            </div>
            <hr class="border-gray-600 my-2">
            <div class="space-y-1">
                <button id="change-password-button-mobile" class="w-full text-left text-gray-300 hover:bg-gray-700 p-2 rounded-md">ãŠ™ï¸ æ”¹å¯†ç¢¼</button>
                <button id="logout-button-mobile" class="w-full text-left text-red-400 hover:bg-gray-700 p-2 rounded-md">ğŸƒâ€â™‚ï¸ ç™»å‡º</button>
            </div>
        </div>
        
    </div>
</header>

    <div class="bg-gray-800 border-b border-gray-700 py-2 overflow-hidden">
        <div class="container mx-auto px-4 relative flex items-center">
            <span class="text-xs font-bold text-yellow-400 mr-2 flex-shrink-0">âš¡ å¿«è¨Š |</span>
            <div class="overflow-hidden w-full">
                <div id="marquee-content" class="whitespace-nowrap text-xs text-gray-300 animate-marquee inline-block">
                    è®€å–æ¦®è­½æ¦œä¸­...
                </div>
            </div>
        </div>
    </div>

    <main class="container mx-auto p-4 md:p-8">
        <div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4 flex-wrap justify-center">
                
            <div id="filter-tabs" class="flex space-x-2 overflow-x-auto no-scrollbar">
                <button data-filter="all" class="filter-tab active text-xs md:text-base whitespace-nowrap px-3 md:px-4">å…¨éƒ¨æŒ‘æˆ°</button>
                <button data-filter="full" class="filter-tab text-xs md:text-base whitespace-nowrap px-3 md:px-4">å·²é¡æ»¿</button>
                <button data-filter="signed-up" class="filter-tab text-xs md:text-base whitespace-nowrap px-3 md:px-4">æˆ‘çš„å ±å</button>
                <button id="hosted-tab" data-filter="hosted" class="filter-tab hidden text-xs md:text-base whitespace-nowrap px-3 md:px-4">æˆ‘çš„ç™¼å¸ƒ</button>
            </div>
                
<button id="email-sub-button" class="text-gray-400 hover:text-indigo-400 transition text-xs md:text-base flex items-center gap-1 ml-2">
                    <span id="email-icon">ğŸ“§</span> <span id="email-text">è¨‚é–±é€šçŸ¥</span>
                </button>
                <button id="screenshot-button" class="text-gray-400 hover:text-white transition text-xs md:text-base">ğŸ“¸ æˆªåœ–</button>
            </div>
            <button id="post-challenge-button" class="hidden bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition transform hover:scale-105 w-full md:w-auto">
                ğŸ„ ç™¼å¸ƒæ–°æŒ‘æˆ°
            </button>
        </div>
        <div id="challenges-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <p id="loading-indicator" class="text-center col-span-full text-gray-400">æ­£åœ¨è¼‰å…¥æŒ‘æˆ°åˆ—è¡¨ï¼Œè«‹ç¨å€™...</p>
        </div>
    </main>
    
    <div id="online-users-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-xs rounded-2xl shadow-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-100">åœ¨ç·šäººå“¡</h2>
                <button type="button" id="close-online-users-modal" class="text-gray-500 hover:text-white text-2xl">&times;</button>
            </div>
            <ul id="online-users-list" class="space-y-2 max-h-64 overflow-y-auto text-gray-300"></ul>
        </div>
    </div>

    <!-- åŒæ­¥å‰©é¤˜æ™‚é–“ Modal -->
    <div id="sync-time-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-sm rounded-2xl shadow-xl p-8">
            <h2 class="text-xl font-bold mb-4 text-gray-100">â±ï¸ è¨­å®šè˜‘è‡å‰©é¤˜æ™‚é–“</h2>
            <p class="text-sm text-gray-400 mb-6">è«‹è¼¸å…¥éŠæˆ²ä¸­é¡¯ç¤ºçš„å‰©é¤˜æ™‚é–“ï¼Œç³»çµ±å°‡è‡ªå‹•è¨ˆç®—çµæŸæ™‚é–“ã€‚</p>
            
            <form id="sync-time-form">
                <input type="hidden" id="sync-challenge-id">
                <div class="flex space-x-2 mb-6">
                    <div class="flex-1">
                        <label class="block text-xs text-gray-400 mb-1">å¤©</label>
                        <input type="number" id="sync-days" min="0" value="0" class="dark-input w-full rounded-md text-center">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs text-gray-400 mb-1">å°æ™‚</label>
                        <input type="number" id="sync-hours" min="0" max="23" value="0" class="dark-input w-full rounded-md text-center">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs text-gray-400 mb-1">åˆ†é˜</label>
                        <input type="number" id="sync-minutes" min="0" max="59" value="0" class="dark-input w-full rounded-md text-center">
                    </div>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-sync-button" class="px-4 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">å–æ¶ˆ</button>
                    <button type="button" id="clear-sync-button" class="px-4 py-2 bg-red-800 text-white rounded-lg font-semibold hover:bg-red-700">æ¸…é™¤æ™‚é–“</button>
                    <button type="submit" id="confirm-sync-button" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700">æ›´æ–°</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- æ–°å¢/ç™¼å¸ƒæŒ‘æˆ° Modal -->
    <div id="challenge-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
            <div class="modal-content w-full max-w-lg rounded-2xl shadow-xl p-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-100">ç™¼å¸ƒä¸€å€‹æ–°æŒ‘æˆ°</h2>
                <form id="challenge-form">
                <div class="space-y-4">
                    <div>
                        <label for="mushroom-type" class="block text-sm font-medium text-gray-400">è˜‘è‡ç¨®é¡</label>
                        <select id="mushroom-type" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="å·¨è‡" selected>å·¨è‡</option>
                            <option value="æ´»å‹•è‡">æ´»å‹•è‡</option>
                            <option value="ç¾ç‰‡è‡">ç¾ç‰‡è‡</option>
                            <option value="å¤§æ™¶">å¤§æ™¶</option>
                            <option value="å¤§ç«">å¤§ç«</option>
                            <option value="å¤§æ°´">å¤§æ°´</option>
                            <option value="å¤§é›»">å¤§é›»</option>
                            <option value="å¤§æ¯’">å¤§æ¯’</option>
                            <option value="å¤§å†°è—">å¤§å†°è—</option>
                            <option value="å¤§ç´…">å¤§ç´…</option>
                            <option value="å¤§é»ƒ">å¤§é»ƒ</option>
                            <option value="å¤§è—">å¤§è—</option>
                            <option value="å¤§ç´«">å¤§ç´«</option>
                            <option value="å¤§ç²‰">å¤§ç²‰</option>
                            <option value="å¤§ç°">å¤§ç°</option>
                            <option value="å¤§ç™½">å¤§ç™½</option>
                            <option value="æ™¶">æ™¶</option>
                            <option value="æ°´">æ°´</option>
                            <option value="ç«">ç«</option>
                            <option value="é›»">é›»</option>
                            <option value="æ¯’">æ¯’</option>
                            <option value="æ¸¬è©¦">æ¸¬è©¦</option>
                        </select>
                    </div>

                    <div>
                        <label for="slots" class="block text-sm font-medium text-gray-400">åé¡</label>
                        <input type="number" id="slots" min="1" required class="dark-input mt-1 block w-full rounded-md shadow-sm" value="4">
                    </div>

                    <div>
                        <div class="flex justify-between items-center">
                            <label for="start-time" class="block text-sm font-medium text-gray-400">é–‹æ”¾å ±åæ™‚é–“</label>
                            <button type="button" id="set-time-now-button" class="text-xs bg-indigo-500 text-white px-2 py-1 rounded-md hover:bg-indigo-600">ç«‹å³é–‹æ”¾</button>
                        </div>
                        <input type="datetime-local" id="start-time" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                        
                        <div class="mt-2 flex items-center">
                            <input id="remember-time-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:bg-gray-600 dark:border-gray-500">
                            <label for="remember-time-checkbox" class="ml-2 block text-sm text-gray-400">è¨˜ä½æ™‚é–“ (ä¸‹æ¬¡è‡ªå‹•å¸¶å…¥)</label>
                        </div>
                    </div>

                    <div>
                        <label for="details" class="block text-sm font-medium text-gray-400">ç”¨é¤æ™‚æ®µ</label>
                        <select id="details" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="å®µå¤œ" selected>å®µå¤œ</option>
                            <option value="æ—©é¤">æ—©é¤</option>
                            <option value="åˆé¤">åˆé¤</option>
                            <option value="ä¸‹åˆèŒ¶">ä¸‹åˆèŒ¶</option>
                            <option value="æ™šé¤">æ™šé¤</option>
                            <option value="æ»¿äººé–‹">æ»¿äººé–‹</option>
                        </select>
                    </div>
                    <div>
                        <label for="cooking-style" class="block text-sm font-medium text-gray-400">ç«ä¾¯</label>
                        <select id="cooking-style" class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="å¤§ç«å¿«ç‚’ï¼ˆæˆ°åŠ›å…¨é–‹ï¼‰">å¤§ç«å¿«ç‚’ï¼ˆæˆ°åŠ›å…¨é–‹ï¼‰</option>
                            <option value="ç´°ç«æ…¢ç‡‰ï¼ˆæ§åˆ¶æˆ°åŠ›ï¼‰">ç´°ç«æ…¢ç‡‰ï¼ˆæ§åˆ¶æˆ°åŠ›ï¼‰</option>
                            <option value="éš¨ä¾¿äº‚ç‚’ï¼ˆä¸é™æˆ°åŠ›ï¼‰"selected>éš¨ä¾¿äº‚ç‚’ï¼ˆä¸é™æˆ°åŠ›ï¼‰</option>
                        </select>
                    </div>

                    <div>
                        <label for="challenge-image" class="block text-sm font-medium text-gray-400">è˜‘è‡ç¾ç‰‡ (é¸å¡«)</label>
                        <input type="file" id="challenge-image" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 mt-1"/>
                        <p class="text-xs text-gray-500 mt-1">å¯ä¸Šå‚³æ˜ä¿¡ç‰‡åœ–æª”ï¼Œæ”¯æ´jpg, pngæ ¼å¼ï¼Œæª”æ¡ˆåˆ¥å¤ªå¤§ã€‚</p>
                    </div>
                    </div>

                <div class="mt-8 flex justify-end space-x-4">       
                    <button type="button" id="cancel-modal-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">å–æ¶ˆ</button>
                    <button type="submit" id="submit-challenge-button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-50">ç¢ºèªç™¼å¸ƒ</button>
                </div>
                </form>
            </div>
        </div>

    <!-- ç·¨è¼¯æŒ‘æˆ° Modal -->
<div id="edit-challenge-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-xl p-8">
            <h2 class="text-2xl font-bold mb-6 text-gray-100">ç·¨è¼¯æŒ‘æˆ°å…§å®¹</h2>
            <form id="edit-challenge-form">
                <input type="hidden" id="edit-challenge-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-mushroom-type" class="block text-sm font-medium text-gray-400">è˜‘è‡ç¨®é¡</label>
                        <select id="edit-mushroom-type" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="å·¨è‡">å·¨è‡</option>
                            <option value="æ´»å‹•è‡">æ´»å‹•è‡</option>
                            <option value="ç¾ç‰‡è‡">ç¾ç‰‡è‡</option>
                            <option value="å¤§æ™¶">å¤§æ™¶</option>
                            <option value="å¤§ç«">å¤§ç«</option>
                            <option value="å¤§æ°´">å¤§æ°´</option>
                            <option value="å¤§é›»">å¤§é›»</option>
                            <option value="å¤§æ¯’">å¤§æ¯’</option>
                            <option value="å¤§å†°è—">å¤§å†°è—</option>
                            <option value="å¤§ç´…">å¤§ç´…</option>
                            <option value="å¤§é»ƒ">å¤§é»ƒ</option>
                            <option value="å¤§è—">å¤§è—</option>
                            <option value="å¤§ç´«">å¤§ç´«</option>
                            <option value="å¤§ç²‰">å¤§ç²‰</option>
                            <option value="å¤§ç°">å¤§ç°</option>
                            <option value="å¤§ç™½">å¤§ç™½</option>
                            <option value="æ™¶">æ™¶</option>
                            <option value="æ°´">æ°´</option>
                            <option value="ç«">ç«</option>
                            <option value="é›»">é›»</option>
                            <option value="æ¯’">æ¯’</option>
                            <option value="æ¸¬è©¦">æ¸¬è©¦</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-slots" class="block text-sm font-medium text-gray-400">åé¡</label>
                        <input type="number" id="edit-slots" min="1" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                    </div>
                    <div>
                        <div class="flex justify-between items-center">
                            <label for="edit-start-time" class="block text-sm font-medium text-gray-400">é–‹æ”¾å ±åæ™‚é–“</label>
                            <button type="button" id="edit-set-time-now-button" class="text-xs bg-indigo-500 text-white px-2 py-1 rounded-md hover:bg-indigo-600">ç«‹å³é–‹æ”¾</button>
                        </div>
                        <input type="datetime-local" id="edit-start-time" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="edit-details" class="block text-sm font-medium text-gray-400">ç”¨é¤æ™‚æ®µ</label>
                        <select id="edit-details" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="å®µå¤œ" selected>å®µå¤œ</option>
                            <option value="æ—©é¤">æ—©é¤</option>
                            <option value="åˆé¤">åˆé¤</option>
                            <option value="ä¸‹åˆèŒ¶">ä¸‹åˆèŒ¶</option>
                            <option value="æ™šé¤">æ™šé¤</option>
                            <option value="æ»¿äººé–‹">æ»¿äººé–‹</option>                
                        </select>
                    </div>
                    
                    <div>
                        <label for="edit-cooking-style" class="block text-sm font-medium text-gray-400">ç«ä¾¯</label>
                        <select id="edit-cooking-style" class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="å¤§ç«å¿«ç‚’ï¼ˆæˆ°åŠ›å…¨é–‹ï¼‰">å¤§ç«å¿«ç‚’ï¼ˆæˆ°åŠ›å…¨é–‹ï¼‰</option>
                            <option value="ç´°ç«æ…¢ç‡‰ï¼ˆæ§åˆ¶æˆ°åŠ›ï¼‰">ç´°ç«æ…¢ç‡‰ï¼ˆæ§åˆ¶æˆ°åŠ›ï¼‰</option>
                            <option value="éš¨ä¾¿äº‚ç‚’ï¼ˆä¸é™æˆ°åŠ›ï¼‰">éš¨ä¾¿äº‚ç‚’ï¼ˆä¸é™æˆ°åŠ›ï¼‰</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-challenge-image" class="block text-sm font-medium text-gray-400">è˜‘è‡ç¾ç‰‡ (é¸å¡«)</label>
                        <input type="file" id="edit-challenge-image" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 mt-1"/>
                        <p class="text-xs text-gray-500 mt-1">å¯ä¸Šå‚³æ˜ä¿¡ç‰‡åœ–æª”ï¼Œæ”¯æ´jpg, pngæ ¼å¼ï¼Œæª”æ¡ˆåˆ¥å¤ªå¤§ã€‚</p>
                    </div>
                    </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="cancel-edit-modal-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">å–æ¶ˆ</button>
                    <button type="submit" id="submit-edit-challenge-button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-50">ç¢ºèªå„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
            <div class="modal-content w-full max-w-sm rounded-2xl shadow-xl p-8">
                <h2 class="text-xl font-bold mb-4 text-white">ç¢ºèªåˆªé™¤</h2>
                <p class="text-gray-400 mb-6">æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹æŒ‘æˆ°å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-delete-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">å–æ¶ˆ</button>
                    <button type="button" id="confirm-delete-button" class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 disabled:opacity-50">ç¢ºèªåˆªé™¤</button>
                </div>
            </div>
        </div>

        <div id="leaderboard-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-xl p-8 flex flex-col max-h-[90vh]">
            
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-100">ğŸ† æ¦®è­½æ¦œ</h2>
                    <p class="text-xs text-gray-400 mt-1">æ¯ 30 åˆ†é˜æ›´æ–°ä¸€æ¬¡æ•¸æ“š</p>
                </div>
                <button type="button" id="close-leaderboard-button" class="text-gray-500 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            
            <div class="flex justify-center mb-4">
                <div class="bg-gray-700 p-1 rounded-lg inline-flex w-full sm:w-auto">
                    <button id="period-week-btn" class="flex-1 sm:flex-none px-6 py-1.5 rounded-md text-sm font-bold transition bg-indigo-600 text-white shadow-sm">æœ¬é€±æ’è¡Œ</button>
                    <button id="period-month-btn" class="flex-1 sm:flex-none px-6 py-1.5 rounded-md text-sm font-bold text-gray-400 hover:text-gray-200 transition">æœ¬æœˆæ’è¡Œ</button>
                </div>
            </div>

            <div class="flex justify-center mb-4">
                <div id="leaderboard-tabs" class="bg-gray-700 p-1 rounded-lg inline-flex w-full sm:w-auto">
                    <button data-type="host" class="flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition bg-indigo-600 text-white shadow-sm">ğŸ„ ç™¼è‡ç‹</button>
                    <button data-type="count" class="flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-bold text-gray-400 hover:text-gray-200 transition">ğŸ“ å ±åç‹</button>
                    <button data-type="speed" class="flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-bold text-gray-400 hover:text-gray-200 transition">âš¡ æœ€é€Ÿå‚³èªª</button>
                </div>
            </div>

            <div id="leaderboard-content" class="space-y-2 overflow-y-auto flex-grow min-h-[200px]">
                <p class="text-center text-gray-500 mt-8">è®€å–ä¸­...</p>
            </div>
        </div>
    </div>

        <div id="image-viewer-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" onclick="closeImageViewer()">
        <div class="relative max-w-3xl w-full max-h-[90vh] flex justify-center p-2" onclick="event.stopPropagation()">
            <button type="button" onclick="closeImageViewer()" class="absolute top-4 right-4 text-white text-3xl hover:text-gray-300 font-bold bg-black/50 rounded-full w-10 h-10 flex items-center justify-center">&times;</button>
            <img id="viewer-image" src="" alt="è˜‘è‡ç¾ç‰‡" class="rounded-lg shadow-2xl max-h-[85vh] object-contain bg-gray-900">
        </div>
        </div>

        <div id="password-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
            <div class="modal-content w-full max-w-md rounded-2xl shadow-xl p-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-100">ä¿®æ”¹å¯†ç¢¼</h2>
                <form id="password-form">
                    <div class="space-y-4">
                        <div>
                            <label for="new-password" class="block text-sm font-medium text-gray-400">æ–°å¯†ç¢¼ (è‡³å°‘6ä½æ•¸)</label>
                            <input type="password" id="new-password" required minlength="6" class="dark-input mt-1 block w-full rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="confirm-password" class="block text-sm font-medium text-gray-400">ç¢ºèªæ–°å¯†ç¢¼</label>
                            <input type="password" id="confirm-password" required minlength="6" class="dark-input mt-1 block w-full rounded-md shadow-sm">
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end space-x-4">
                        <button type="button" id="cancel-password-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">å–æ¶ˆ</button>
                        <button type="submit" id="submit-password-button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-50">ç¢ºèªä¿®æ”¹</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="toast-message" class="hidden fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg"></div>

    <script>
        const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co'; 
        const SUPABASE_ANON_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const userInfoEl = document.getElementById('user-info');
        const changePasswordButton = document.getElementById('change-password-button');
        const logoutButton = document.getElementById('logout-button');
        const postChallengeButton = document.getElementById('post-challenge-button');
        const challengesListEl = document.getElementById('challenges-list');
        const challengeModal = document.getElementById('challenge-modal');
        const challengeForm = document.getElementById('challenge-form');
        const cancelModalButton = document.getElementById('cancel-modal-button');
        const setTimeNowButton = document.getElementById('set-time-now-button');
        const submitChallengeButton = document.getElementById('submit-challenge-button');
        const toastMessage = document.getElementById('toast-message');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const cancelDeleteButton = document.getElementById('cancel-delete-button');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const leaderboardButton = document.getElementById('leaderboard-button');
        const leaderboardModal = document.getElementById('leaderboard-modal');
        const leaderboardTabs = document.getElementById('leaderboard-tabs');
        const leaderboardContent = document.getElementById('leaderboard-content');
        const closeLeaderboardButton = document.getElementById('close-leaderboard-button');
        const passwordModal = document.getElementById('password-modal');
        const passwordForm = document.getElementById('password-form');
        const cancelPasswordButton = document.getElementById('cancel-password-button');
        const submitPasswordButton = document.getElementById('submit-password-button');
        const filterTabs = document.getElementById('filter-tabs');
        const hostedTab = document.getElementById('hosted-tab');
        const adminLink = document.getElementById('admin-link'); 
        const onlineUsersContainer = document.getElementById('online-users-container');
        const refreshButton = document.getElementById('refresh-button');
        const onlineUsersModal = document.getElementById('online-users-modal');
        const onlineUsersList = document.getElementById('online-users-list');
        const closeOnlineUsersModalButton = document.getElementById('close-online-users-modal');
        const editChallengeModal = document.getElementById('edit-challenge-modal');
        const editChallengeForm = document.getElementById('edit-challenge-form');
        const cancelEditModalButton = document.getElementById('cancel-edit-modal-button');
        const editSetTimeNowButton = document.getElementById('edit-set-time-now-button');
        const screenshotButton = document.getElementById('screenshot-button');
        const hamburgerButton = document.getElementById('hamburger-button');
        const mobileMenu = document.getElementById('mobile-menu');

        // â–¼â–¼â–¼ ã€æ–°å¢ã€‘Email è¨‚é–±ç›¸é—œè®Šæ•¸ â–¼â–¼â–¼
        const emailSubButton = document.getElementById('email-sub-button');
        const emailIcon = document.getElementById('email-icon');
        const emailText = document.getElementById('email-text');
        // â–²â–²â–² ã€æ–°å¢çµæŸã€‘ â–²â–²â–²

        // --- è˜‘è‡å€’æ•¸è¨ˆæ™‚ç›¸é—œè®Šæ•¸ ---
        const syncTimeModal = document.getElementById('sync-time-modal');
        const syncTimeForm = document.getElementById('sync-time-form');
        const cancelSyncButton = document.getElementById('cancel-sync-button');
        const clearSyncButton = document.getElementById('clear-sync-button');

        // 1. ç›£è½å¡ç‰‡ä¸Šçš„ã€Œæ ¡æ™‚ã€æŒ‰éˆ•é»æ“Š
        challengesListEl.addEventListener('click', (e) => {
            const btn = e.target.closest('.open-sync-modal-button');
            if (!btn) return;

            const challengeId = btn.dataset.id;
            document.getElementById('sync-challenge-id').value = challengeId;
            
            // é‡ç½®è¼¸å…¥æ¡†
            document.getElementById('sync-days').value = 0;
            document.getElementById('sync-hours').value = 0;
            document.getElementById('sync-minutes').value = 0;

            syncTimeModal.classList.remove('hidden');
        });

        // 2. é—œé–‰ Modal
        cancelSyncButton.addEventListener('click', () => syncTimeModal.classList.add('hidden'));

        // 3. è™•ç†ã€Œæ¸…é™¤æ™‚é–“ã€ (è¨­ç‚º NULL)
        clearSyncButton.addEventListener('click', async () => {
            await updateChallengeTimer(null);
        });

        // 4. è™•ç†ã€Œæ›´æ–°æ™‚é–“ã€ (è¨ˆç®— End Time ä¸¦å¯«å…¥)
        syncTimeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const days = parseInt(document.getElementById('sync-days').value) || 0;
            const hours = parseInt(document.getElementById('sync-hours').value) || 0;
            const minutes = parseInt(document.getElementById('sync-minutes').value) || 0;

            if (days === 0 && hours === 0 && minutes === 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„å‰©é¤˜æ™‚é–“');
                return;
            }

            // è¨ˆç®—ç›®æ¨™çµæŸæ™‚é–“ (ç¾åœ¨æ™‚é–“ + è¼¸å…¥çš„å‰©é¤˜æ™‚é–“)
            const now = new Date();
            const totalMilliseconds = (days * 24 * 60 * 60 * 1000) + (hours * 60 * 60 * 1000) + (minutes * 60 * 1000);
            const endTime = new Date(now.getTime() + totalMilliseconds);

            await updateChallengeTimer(endTime.toISOString());
        });

        // â˜… ä¿®æ”¹å¾Œï¼šå¯«å…¥å¾Œç«‹å³é‡æ•´å¡ç‰‡ï¼Œè§£æ±ºéœ€æ‰‹å‹•F5çš„å•é¡Œ
        async function updateChallengeTimer(endTimeISO) {
            const challengeId = document.getElementById('sync-challenge-id').value;
            const btn = document.getElementById('confirm-sync-button');
            const clearBtn = document.getElementById('clear-sync-button');
            
            btn.disabled = true; clearBtn.disabled = true;
            btn.textContent = 'æ›´æ–°ä¸­...';

            try {
                // 1. å‘¼å«é ç«¯ RPC æ›´æ–°è³‡æ–™åº«
                const { error } = await supabaseClient.rpc('update_challenge_countdown', {
                    p_challenge_id: parseInt(challengeId),
                    p_end_time: endTimeISO
                });

                if (error) throw error;

                showToast('æ™‚é–“å·²æ›´æ–°ï¼', false);
                syncTimeModal.classList.add('hidden');
                
                // 2. â˜… é—œéµä¿®æ­£ï¼šä¸»å‹•åˆ·æ–°è©²å¼µå¡ç‰‡ (ä¸ç”¨ç­‰ Realtime æ¨æ’­)
                await reloadChallengeCard(challengeId);
                
                // 3. â˜… é—œéµä¿®æ­£ï¼šç«‹å³è§¸ç™¼ä¸€æ¬¡å€’æ•¸è¨ˆç®— (æ¶ˆé™¤ "è¨ˆç®—ä¸­..." çš„ç­‰å¾…æ„Ÿ)
                updateBattleTimers();

            } catch (error) {
                console.error(error);
                showToast(`æ›´æ–°å¤±æ•—: ${error.message}`, true);
            } finally {
                btn.disabled = false; clearBtn.disabled = false;
                btn.textContent = 'æ›´æ–°';
            }
        }

        let currentUserProfile = null;
        let challengeToDeleteId = null;
        let userSignedUpChallengeIds = new Set(); 
        let countdownInterval = null; 
        let activeFilter = 'all';
        let onlineNicknames = []; 
        let challengesData = {}; 
        
       /* â–¼â–¼â–¼ æ–°å¢ï¼šå†·å»æ™‚é–“æ§åˆ¶è®Šæ•¸ â–¼â–¼â–¼ */
        let globalCooldownUntil = 0; 
        let globalCooldownTimer = null;
        
        /* â–¼â–¼â–¼ æ–°å¢ï¼šæ’è¡Œæ¦œç‹€æ…‹è®Šæ•¸ â–¼â–¼â–¼ */
        let currentLeaderboardPeriod = 'week'; // é è¨­çœ‹æœ¬é€±
        let currentLeaderboardType = 'host';   // é è¨­çœ‹ç™¼è‡ç‹

        //è˜‘è‡æ¨£å¼å°ç…§è¡¨
        const mushroomStyles = {
        'å·¨è‡':     { bg: 'bg-cyan-400',     text: 'text-black' },
        'æ´»å‹•è‡':   { bg: 'bg-lime-400',     text: 'text-black' },
        'ç¾ç‰‡è‡':   { bg: 'bg-[#ff0080]',    text: 'text-white' },
        'å¤§ç«':     { bg: 'bg-red-600',      text: 'text-white' },
        'ç«':       { bg: 'bg-red-600',      text: 'text-white' },
        'å¤§ç´…':     { bg: 'bg-red-600',      text: 'text-white' },
        'å¤§é›»':     { bg: 'bg-yellow-400',   text: 'text-black' },
        'é›»':       { bg: 'bg-yellow-400',   text: 'text-black' },
        'å¤§é»ƒ':     { bg: 'bg-yellow-400',   text: 'text-black' },
        'å¤§æ°´':     { bg: 'bg-blue-600',     text: 'text-white' },
        'æ°´':       { bg: 'bg-blue-600',     text: 'text-white' },
        'å¤§è—':     { bg: 'bg-blue-600',     text: 'text-white' },
        'å¤§æ™¶':     { bg: 'bg-sky-300',      text: 'text-black' },
        'æ™¶':       { bg: 'bg-sky-300',      text: 'text-black' },
        'å¤§å†°è—':     { bg: 'bg-sky-300',      text: 'text-black' },
        'å¤§æ¯’':     { bg: 'bg-green-700',    text: 'text-white' },
        'æ¯’':       { bg: 'bg-green-700',    text: 'text-white' },
        'å¤§ç™½':     { bg: 'bg-white',        text: 'text-black' },
        'å¤§ç´«':     { bg: 'bg-purple-600',   text: 'text-white' },
        'å¤§ç²‰':     { bg: 'bg-pink-300',     text: 'text-black' },
        'å¤§ç°':     { bg: 'bg-gray-500',     text: 'text-white' },
        'æ¸¬è©¦':     { bg: 'bg-black',        text: 'text-white' },
        };

        // â˜… ä¿®æ”¹ï¼šç°¡åŒ–å‡½å¼ï¼Œç›´æ¥é¡¯ç¤ºå¾è³‡æ–™åº«ç²å–çš„è¨ˆæ•¸ï¼Œä¸å†é€²è¡Œä»»ä½•æ—¥æœŸåˆ¤æ–·
        function updateQuotaDisplay() {
            const quotaEl = document.getElementById('daily-quota-display');
            if (!currentUserProfile || !quotaEl) return;

            const currentCount = currentUserProfile.daily_signup_count || 0;
            quotaEl.textContent = `æœ¬æ—¥é¡åº¦: ${currentCount} / ${window.dailySignupLimit}`;
        }

        // â˜… æ–°å¢ï¼šå¾è³‡æ–™åº«é‡æ–°ç²å–ä¸¦æ›´æ–°ç•¶å‰ä½¿ç”¨è€…çš„å€‹äººè³‡æ–™
        async function refreshUserProfile() {
            const { data, error } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', currentUserProfile.id)
                .single();
            
            if (error) {
                console.error('åˆ·æ–°ä½¿ç”¨è€…è³‡æ–™å¤±æ•—:', error);
                return;
            }
            currentUserProfile = data;
        }

        async function initializePage() {

            // åœ¨é é¢åˆå§‹åŒ–æ™‚ï¼Œéœé»˜å‘¼å«å¾Œç«¯å‡½å¼ï¼Œæ›´æ–°è‡ªå·±çš„æœ€å¾Œæ´»èºæ™‚é–“
            await supabaseClient.rpc('update_last_active');

            // â˜… ä¿®æ”¹ï¼šä½¿ç”¨æ›´ç©©å¥çš„æ–¹å¼ç²å–æ¯æ—¥å ±åä¸Šé™è¨­å®š
            const { data: settings, error: limitError } = await supabaseClient
                .from('daily_settings')
                .select('setting_value')
                .eq('setting_name', 'daily_signup_limit');
        
            if (limitError || !settings || settings.length === 0) {
                console.error('ç„¡æ³•ç²å–æ¯æ—¥å ±åä¸Šé™è¨­å®šï¼Œå°‡ä½¿ç”¨é è¨­å€¼ 3ã€‚', limitError);
                window.dailySignupLimit = 3; // è‹¥ç™¼ç”ŸéŒ¯èª¤æˆ–æ‰¾ä¸åˆ°è¨­å®šï¼Œä½¿ç”¨é è¨­å€¼
            } else {
                window.dailySignupLimit = settings[0].setting_value; // æˆåŠŸç²å–ï¼Œä½¿ç”¨è³‡æ–™åº«ä¸­çš„å€¼
            }

            supabaseClient.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_OUT' || !session) {
                    if (countdownInterval) clearInterval(countdownInterval);
                    window.location.replace('./index.html');
                }
            });

            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) return;
            
            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .single();

            if (error || !profile) {
                console.error('ç²å–å€‹äººæª”æ¡ˆå¤±æ•—æˆ–ç„¡æ•ˆ:', error);
                await supabaseClient.auth.signOut();
                return;
            }
            
            currentUserProfile = profile;
            displayUserInfo();
            
            await fetchUserSignups();
            await fetchChallenges();
            setupRealtimeListeners();
            setupOnlinePresence();
            startGlobalCountdown();
            updateMarquee();
        }

        // --- æ–°å¢é–‹å§‹ï¼šè·‘é¦¬ç‡ˆé‚è¼¯ ---
        // --- ä¿®æ”¹ï¼šè·‘é¦¬ç‡ˆé‚è¼¯ (å–®æ¬¡å¾ªç’° + å»¶é²é‡æ’­) ---
        async function updateMarquee() {
            const marqueeEl = document.getElementById('marquee-content');
            // è¨­å®šè·‘é¦¬ç‡ˆé€Ÿåº¦ (ç§’)ï¼Œæ‚¨å¯ä»¥åœ¨æ­¤èª¿æ•´
            const duration = 20; 
            // è¨­å®šè·‘å®Œå¾Œçš„ä¼‘æ¯æ™‚é–“ (æ¯«ç§’)
            const delay = 1000;

            try {
                // å¹³è¡Œæ’ˆå–æ•¸æ“š
                const [signUpData, speedData, hostData] = await Promise.all([
                    supabaseClient.rpc('get_leaderboard_from_profiles', { period_type: 'month' }),
                    supabaseClient.rpc('get_speed_leaderboard_from_profiles', { period_type: 'month' }),
                    supabaseClient.rpc('get_host_leaderboard', { period_type: 'month' }) 
                ]);

                let textParts = [];
                
                // ä¾åºé¡¯ç¤ºï¼šç™¼è‡(é€±) -> å ±å(æœˆ) -> æœ€é€Ÿ(æœˆ)
                if (hostData.data && hostData.data.length > 0) {
                    const top = hostData.data[0];
                    textParts.push(`â˜…&nbsp;&nbsp;&nbsp;ğŸ„ æœ¬æœˆç™¼è‡ç‹ï¼š${top.nickname} (${top.host_count}æœµ)`);
                }
                if (signUpData.data && signUpData.data.length > 0) {
                    const top = signUpData.data[0];
                    textParts.push(`ğŸ† æœ¬æœˆå ±åç‹ï¼š${top.nickname} (${top.signup_count}æ¬¡)`);
                }
                if (speedData.data && speedData.data.length > 0) {
                    const top = speedData.data[0];
                    textParts.push(`âš¡ æœ¬æœˆæœ€é€Ÿå‚³èªªï¼š${top.nickname} (${parseFloat(top.fastest_time_seconds).toFixed(2)}ç§’)&nbsp;&nbsp;&nbsp;â˜…`);
                }

                if (textParts.length > 0) {
                    // åªçµ„åˆä¸€æ¬¡ï¼Œä¸é‡è¤‡
                    const fullText = textParts.join(' &nbsp;&nbsp; â˜… &nbsp; ');
                    marqueeEl.innerHTML = fullText;
                    
                    // è¨­å®š CSS å‹•ç•«æ™‚é–“
                    marqueeEl.style.animationDuration = `${duration}s`;
                    
                    // å®šç¾©é‡æ’­å‡½å¼
                    const runAnimation = () => {
                        marqueeEl.classList.remove('animate-marquee');
                        // å¼·åˆ¶ç€è¦½å™¨é‡ç¹ª (Reflow)ï¼Œé€™æ¨£ç§»é™¤ class å†åŠ å›å»æ‰æœƒæœ‰å‹•ç•«æ•ˆæœ
                        void marqueeEl.offsetWidth; 
                        marqueeEl.classList.add('animate-marquee');
                    };

                    // ç›£è½å‹•ç•«çµæŸäº‹ä»¶
                    marqueeEl.addEventListener('animationend', () => {
                        // å‹•ç•«çµæŸå¾Œï¼Œç­‰å¾… delay æ™‚é–“ï¼Œå†é‡æ–°åŸ·è¡Œ
                        setTimeout(runAnimation, delay);
                    });

                    // å•Ÿå‹•ç¬¬ä¸€æ¬¡å‹•ç•«
                    runAnimation();

                } else {
                    marqueeEl.textContent = 'ç›®å‰å°šç„¡æŒ‘æˆ°ç´€éŒ„ï¼Œå¿«ä¾†æ¶é ­é¦™ï¼';
                }
            } catch (e) {
                console.error('è·‘é¦¬ç‡ˆæ›´æ–°å¤±æ•—', e);
                marqueeEl.textContent = 'æ­¡è¿ä¾†åˆ°è‡è‡å®…é…ç¶²ï¼';
            }
        }

        function displayUserInfo() {
            // å¦‚æœå°šæœªè®€å–åˆ°ä½¿ç”¨è€…è³‡æ–™ï¼Œå‰‡ä¸åŸ·è¡Œ
            if (!currentUserProfile) return;

            // æ›´æ–°æ¨™é¡Œåˆ—ä¸­çš„æ­¡è¿è¨Šæ¯ï¼Œä¿®æ”¹è§£ææš±ç¨±ï¼Œåªé¡¯ç¤ºç¬¦è™Ÿèˆ‡æ•¸å­—å‰çš„éƒ¨åˆ†
            const displayName = (currentUserProfile.nickname || '').split(/[^a-zA-Z0-9\u4e00-\u9fa5\s]/)[0];
            userInfoEl.textContent = `ä½ å¥½ï¼Œ${displayName}ï¼`;
            updateQuotaDisplay(); // â˜… æ–°å¢ï¼šåœ¨ä½¿ç”¨è€…è³‡è¨Šé¡¯ç¤ºæ™‚ï¼Œæ›´æ–°é¡åº¦é¡¯ç¤º
            // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œç®¡ç†è€…ã€æˆ–ã€Œç™¼è‡è€…ã€ï¼Œä»¥é¡¯ç¤ºç™¼å¸ƒç›¸é—œæŒ‰éˆ•
            if (currentUserProfile.role === 'ç®¡ç†è€…' || currentUserProfile.role === 'ç™¼è‡è€…' || currentUserProfile.role === 'ç™¼è‡åŠå ±åè€…') {
                postChallengeButton.classList.remove('hidden');
                hostedTab.classList.remove('hidden');
            }
            
            // ------------------- â˜… é€™è£¡æ˜¯æ ¸å¿ƒä¿®æ”¹è™• â˜… -------------------
            // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œç®¡ç†è€…ã€
            if (currentUserProfile.role === 'ç®¡ç†è€…') {
                // (åŸæœ¬å°±æœ‰çš„) è®“æ¡Œé¢ç‰ˆçš„ã€Œç®¡ç†å¾Œå°ã€é€£çµé¡¯ç¤ºå‡ºä¾†
                adminLink.classList.remove('hidden');

                // (æˆ‘å€‘æ–°å¢çš„) åŒæ­¥è®“è¡Œå‹•ç‰ˆæ¼¢å ¡é¸å–®ä¸­çš„ã€Œç®¡ç†å¾Œå°ã€é€£çµä¹Ÿé¡¯ç¤ºå‡ºä¾†
                document.getElementById('admin-link-mobile').classList.remove('hidden');
                // â˜… æ–°å¢ï¼šåŒæ­¥é¡¯ç¤º GPX ç”Ÿæˆå™¨é€£çµ
                //document.getElementById('gpx-generator-link').classList.remove('hidden');
                //document.getElementById('gpx-generator-link-mobile').classList.remove('hidden');              
                
            }
            // â–¼â–¼â–¼ ã€æ–°å¢ã€‘æª¢æŸ¥ä¸¦é¡¯ç¤ºè¨‚é–±ç‹€æ…‹ â–¼â–¼â–¼
            checkSubscriptionStatus();
            // â–²â–²â–² ã€æ–°å¢çµæŸã€‘ â–²â–²â–²
        }
        
        async function fetchUserSignups() {
            const { data, error } = await supabaseClient
                .from('signups')
                .select('challenge_id')
                .eq('user_id', currentUserProfile.id);

            if (error) {
                console.error('ç²å–ä½¿ç”¨è€…å ±åç´€éŒ„å¤±æ•—:', error);
                return;
            }
            userSignedUpChallengeIds = new Set(data.map(signup => signup.challenge_id));
        }
        
        async function fetchChallenges() {
            const { data: challenges, error } = await supabaseClient
                .from('challenges')
                .select(`*, host:profiles(nickname, id), signups(*, profile:profiles(nickname))`)
                .order('start_time', { ascending: false });

            if (error) {
                console.error('ç²å–æŒ‘æˆ°åˆ—è¡¨å¤±æ•—:', error);
                challengesListEl.innerHTML = '<p class="text-center col-span-full text-red-400">ç„¡æ³•è¼‰å…¥æŒ‘æˆ°ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
                return;
            }
            
            challengesData = {}; 
            challenges.forEach(c => {
                challengesData[c.id] = c;
            });

            const loadingIndicator = document.getElementById('loading-indicator');
            if(loadingIndicator) loadingIndicator.remove();
            
            challengesListEl.innerHTML = ''; 
            challenges.forEach(challenge => renderChallenge(challenge));
            applyFilter();
        }

function renderChallenge(challenge) {
            if (!challenge || !challenge.host) {
                console.warn('æ”¶åˆ°ä¸å®Œæ•´çš„æŒ‘æˆ°è³‡æ–™ï¼Œå·²ç•¥éæ¸²æŸ“:', challenge);
                return;
            }
            challengesData[challenge.id] = challenge; 
            // â˜… é¡åº¦åˆ¤æ–·é‚è¼¯ (ä¿ç•™åŸåŠŸèƒ½)
            const dailyLimitReached = currentUserProfile && currentUserProfile.daily_signup_count >= window.dailySignupLimit;
        
            const card = document.createElement('div');
            card.className = 'challenge-card bg-gray-800 rounded-xl shadow-md overflow-hidden p-6 flex flex-col justify-between';
            card.id = `challenge-${challenge.id}`;
            const statusClass = challenge.status === 'é–‹æ”¾å ±åä¸­' ? 'status-open' : (challenge.status === 'å·²é¡æ»¿' ? 'status-full' : 'status-pending');
            
            card.dataset.status = challenge.status;

            // 1. æ ¹æ“šè˜‘è‡é¡å‹å¾å°ç…§è¡¨å–å¾—å°æ‡‰çš„æ¨£å¼
            const type = challenge.mushroom_type;
            const defaultStyle = { bg: 'bg-transparent', text: 'text-gray-100' };
            const style = mushroomStyles[type] || defaultStyle;
            
            // â˜… ä¿®æ”¹ï¼šåŠ å…¥ whitespace-nowrap å¼·åˆ¶æ–‡å­—ä¸æ›è¡Œ
            const titleClasses = `text-xl font-bold px-3 py-1 rounded-md ${style.bg} ${style.text} whitespace-nowrap`;
            
            const isHost = challenge.host && challenge.host.id === currentUserProfile.id;
            const isSignedUp = userSignedUpChallengeIds.has(challenge.id);
            const signupCount = challenge.signups ? challenge.signups.length : 0;
            const dispatchStatus = challenge.dispatch_status || 'å¾…ç™¼';

            if (isHost) card.dataset.isHosted = 'true';
            if (isSignedUp) card.dataset.isSignedUp = 'true';
            
            // Host æ§åˆ¶æŒ‰éˆ• (ä¿ç•™åŸåŠŸèƒ½)
            const hostControlsHtml = isHost ? `
                <button data-id="${challenge.id}" class="edit-challenge-button text-gray-500 hover:text-yellow-400 transition" title="ç·¨è¼¯">âœï¸</button>
                <button data-id="${challenge.id}" class="delete-challenge-button text-gray-500 hover:text-red-500 transition" title="åˆªé™¤">ğŸ—‘ï¸</button>
            ` : '';

            // 4. æº–å‚™ä¸»æ“ä½œæŒ‰éˆ• (å ±å/å–æ¶ˆ/æ›´æ–°ç‹€æ…‹) - (å®Œå…¨ä¿ç•™æ‚¨æä¾›çš„é‚è¼¯ï¼Œå«å†·å»æ™‚é–“)
            let actionButtonHtml;
            if (isHost) {
                if (signupCount > 0) {
                    const btnBgClass = dispatchStatus === 'å·²ç™¼' 
                        ? 'bg-teal-600 hover:bg-teal-700' 
                        : 'bg-gray-700 hover:bg-gray-600';

                    actionButtonHtml = `<button 
                        class="w-full ${btnBgClass} text-white font-bold py-2 px-4 rounded-lg transition cursor-pointer dispatch-status-tag" 
                        data-id="${challenge.id}" 
                        data-current-status="${dispatchStatus}">
                        æ›´æ–°ç™¼è‡ç‹€æ…‹
                    </button>`;
                } else {
                    actionButtonHtml = `<button class="w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg cursor-default">æ‚¨æ˜¯ç™¼è‡è€…</button>`;
                }
            } else if (isSignedUp) {
                actionButtonHtml = `<button class="cancel-signup-button w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition" data-challenge-id="${challenge.id}">å–æ¶ˆå ±å</button>`;
            } else if (challenge.status === 'é è¨ˆé–‹æ”¾') {
                actionButtonHtml = `<button class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed" disabled>å°šæœªé–‹æ”¾</button>`;
            } else if (challenge.status === 'å·²é¡æ»¿') {
                actionButtonHtml = `<button class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed" disabled>å·²é¡æ»¿</button>`;
            } else if (dailyLimitReached) { 
                actionButtonHtml = `<button class="w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed" disabled>å ±åé¡åº¦å·²æ»¿</button>`;
            } else {
                if (currentUserProfile.role === 'ç™¼è‡è€…') {
                    actionButtonHtml = `<button class="w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg cursor-default" disabled>åƒ…ç™¼å¸ƒæ¬Šé™</button>`;
                } else {
                    // å†·å»æª¢æŸ¥ (ä¿ç•™åŸåŠŸèƒ½)
                    const cooldownLeft = Math.ceil((globalCooldownUntil - Date.now()) / 1000);
                    if (cooldownLeft > 0) {
                        actionButtonHtml = `<button class="signup-button w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed btn-cooldown" disabled>å†·å»ä¸­ ${cooldownLeft}s</button>`;
                    } else {
                        actionButtonHtml = `<button class="signup-button w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition" data-challenge-id="${challenge.id}">å ±å</button>`;
                    }
                }
            }

            // 5. æº–å‚™åƒåŠ è€…åå–® (ä¿ç•™åŸåŠŸèƒ½)
            let participantsHtml = '';
            if (signupCount > 0) {
                const sortedSignups = [...challenge.signups].sort((a, b) => new Date(a.signed_up_at) - new Date(b.signed_up_at));
                const participantsList = sortedSignups.map((signup, index) => {
                    const rank = index + 1;
                    const rankText = `${rank}${getRankSuffix(rank)}`;
                    const nickname = signup.profile ? signup.profile.nickname : 'æœªçŸ¥ç”¨æˆ¶';
                    const time = formatSignupTime(signup.signed_up_at);
                    return `<div class="participant-item"><span><span class="participant-rank">${rankText}</span> ${nickname}</span><span>${time}</span></div>`;
                }).join('');
                participantsHtml = `<div class="participant-list">${participantsList}</div>`;
            }

            // 6. æº–å‚™æ™‚é–“é¡¯ç¤º
            let startTimeHtml;
            if (challenge.status === 'é è¨ˆé–‹æ”¾' && new Date(challenge.start_time) > new Date()) { 
                startTimeHtml = `<p><strong>ç­‰å¾…æ™‚é–“:</strong> <span class="countdown-timer" data-starttime="${challenge.start_time}">è¨ˆç®—ä¸­...</span></p>`;
            } else {
                startTimeHtml = `<p><strong>é–‹æ”¾æ™‚é–“:</strong> ${new Date(challenge.start_time).toLocaleString('zh-TW', { hour12: false })}</p>`;
            }

            // â–¼â–¼â–¼ ã€æ–°å¢ã€‘åœ–ç‰‡æŒ‰éˆ•ç”Ÿæˆ â–¼â–¼â–¼
            let imageBtnHtml = '';
            if (challenge.image_url && challenge.image_url.startsWith('http')) {
                imageBtnHtml = `
                <div class="mt-2">
                    <button onclick="openImageViewer('${challenge.image_url}')" class="text-xs bg-gray-700 text-indigo-300 px-3 py-1.5 rounded hover:bg-gray-600 border border-gray-600 flex items-center gap-2 transition">
                        ğŸ“· æŸ¥çœ‹æ˜ä¿¡ç‰‡
                    </button>
                </div>`;
            }

            let dispatchTagHtml = '';
            if (signupCount > 0) {
                const dispatchClass = dispatchStatus === 'å·²ç™¼' ? 'dispatch-sent' : 'dispatch-pending';
                const isClickable = isHost ? 'cursor-pointer' : '';
                dispatchTagHtml = `<span class="status-badge ${dispatchClass} ${isClickable} dispatch-status-tag" data-id="${challenge.id}" data-current-status="${dispatchStatus}">${dispatchStatus}</span>`;
            }

            // â–¼â–¼â–¼ ã€æ–°å¢ã€‘ç«ä¾¯é¡è‰²åˆ¤æ–·é‚è¼¯ â–¼â–¼â–¼
            let cookingStyleClass = 'text-gray-400 border-gray-500/30'; // é è¨­å€¼
            const cStyle = challenge.cooking_style || '';

            if (cStyle.includes('å¤§ç«å¿«ç‚’')) {
                cookingStyleClass = 'text-red-500 border-red-500/30';    // ç´…è‰²
            } else if (cStyle.includes('ç´°ç«æ…¢ç‡‰')) {
                cookingStyleClass = 'text-orange-400 border-orange-400/30'; // æ©˜è‰²
            } else if (cStyle.includes('éš¨ä¾¿äº‚ç‚’')) {
                cookingStyleClass = 'text-yellow-400 border-yellow-400/30'; // é»ƒè‰²
            }
            // â–²â–²â–² åˆ¤æ–·çµæŸ â–²â–²â–²

            // 1. æº–å‚™å€’æ•¸è¨ˆæ™‚èˆ‡æ”¶æˆæ™‚é–“çš„è³‡æ–™
            let countdownDisplayHtml = '<span class="text-gray-500">å€’æ•¸:--</span>';
            let dataEndTime = '';
            let harvestTimeHtml = ''; // é è¨­ç‚ºç©ºï¼Œç¨å¾Œç”± JS å¡«å…¥ï¼Œæˆ–è‹¥ç„¡æ™‚é–“å‰‡ä¸é¡¯ç¤º

            if (challenge.countdown_end_time) {
                dataEndTime = challenge.countdown_end_time;
                countdownDisplayHtml = 'è¨ˆç®—ä¸­...'; 
            }

            // 2. çµ„åˆæŒ‰éˆ•èˆ‡é¡¯ç¤ºæ–‡å­— (å€’æ•¸è¨ˆæ™‚å€å¡Š)
            const battleTimerHtml = `
                <span class="battle-timer text-white font-bold" data-endtime="${dataEndTime}">
                    ${countdownDisplayHtml}
                </span>
                <button class="open-sync-modal-button text-xs bg-gray-700 text-gray-300 px-2 py-0.5 rounded ml-2 hover:bg-gray-600 border border-gray-600 transition" 
                        data-id="${challenge.id}" title="æ ¡æ­£æ™‚é–“">
                    æ ¡æ™‚
                </button>
            `;

            // â˜… æ–°å¢ï¼šæ”¶æˆæ™‚é–“å€å¡Š (çµ¦äºˆä¸€å€‹ class è®“ JS å¯ä»¥é¸å–åˆ°)
            // mt-1 å¢åŠ ä¸€é»é»ä¸Šé‚Šè·ï¼Œtext-xs è®“å­—é«”æ¯”å€’æ•¸å°ä¸€é»ä»¥åˆ†å‡ºå±¤ç´š
            const harvestHtmlBlock = `
                <div class="harvest-timer text-white font-bold mt-1" data-endtime="${dataEndTime}">
                    </div>
            `;

            // 3. ä¿®æ”¹ card.innerHTML
            card.innerHTML = `
                <div>
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <h3 class="${titleClasses}">
                                ${challenge.mushroom_type}
                            </h3>
                            <span class="text-sm font-bold text-gray-500">#${challenge.id}</span>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            ${dispatchTagHtml}
                            <span class="status-badge ${statusClass}">${challenge.status}</span>
                            ${hostControlsHtml}
                        </div>
                    </div>

                    <div class="flex flex-col mb-3 pl-1"> 
                        <div class="flex items-center">
                            ${battleTimerHtml}
                        </div>
                        ${harvestHtmlBlock}
                    </div>

                    <div class="text-gray-400 space-y-2 mb-4">
                        <p><strong>ç™¼è‡è€…:</strong> ${challenge.host ? challenge.host.nickname : 'æœªçŸ¥'}</p>
                        <p><strong>ç”¨é¤æ™‚æ®µ:</strong> ${challenge.details || 'æœªæŒ‡å®š'}</p>
                        <p><strong>åé¡:</strong> <span id="signup-count-${challenge.id}">${signupCount}</span> / ${challenge.slots}</p>
                        
                        ${startTimeHtml}
                        
                        <div class="flex items-center mt-1">
                            <strong class="mr-2">ç«ä¾¯:</strong>
                            <span class="${cookingStyleClass} border px-2 py-0.5 rounded text-sm font-bold">
                                ğŸ”¥ ${cStyle || 'æœªæŒ‡å®š'}
                            </span>
                        </div>

                        ${imageBtnHtml}
                    </div>
                    ${participantsHtml}
                </div>
                <div class="mt-4">${actionButtonHtml}</div>
            `;
            
            const existingCard = document.getElementById(card.id);
            if(existingCard) {
                challengesListEl.replaceChild(card, existingCard);
            } else {
                challengesListEl.prepend(card);
            }
        }

        async function reloadChallengeCard(challengeId) {
            const { data: challenge, error } = await supabaseClient
                .from('challenges')
                .select(`*, host:profiles(nickname, id), signups(*, profile:profiles(nickname))`)
                .eq('id', challengeId)
                .single();
            
            if (error) {
                if (error.code === 'PGRST116') {
                    const cardToRemove = document.getElementById(`challenge-${challengeId}`);
                    if(cardToRemove) cardToRemove.remove();
                } else {
                    console.error('é‡è¼‰å¡ç‰‡å¤±æ•—:', error);
                }
                return;
            }
            renderChallenge(challenge);
            applyFilter();
        }
        
        // â˜… æ–°å¢ï¼šä¸€å€‹å°ˆé–€ç”¨ä¾†åˆ·æ–°æ‰€æœ‰æŒ‘æˆ°å¡ç‰‡ç‹€æ…‹çš„å‡½å¼
        function refreshAllChallengeCards() {
            // challengesData æ˜¯ä¸€å€‹å…¨åŸŸè®Šæ•¸ï¼Œå„²å­˜äº†å¾è³‡æ–™åº«ç²å–çš„æ‰€æœ‰æŒ‘æˆ°
            if (!challengesData) return;

            // æ¸…ç©ºç¾æœ‰åˆ—è¡¨
            challengesListEl.innerHTML = '';
            
            // éæ­·æ‰€æœ‰æŒ‘æˆ°è³‡æ–™ï¼Œä¸¦ç‚ºæ¯ä¸€ç­†é‡æ–°æ¸²æŸ“ä¸€æ¬¡å¡ç‰‡
            Object.values(challengesData).forEach(challenge => {
                renderChallenge(challenge);
            });

            // é‡æ–°å¥—ç”¨ä½¿ç”¨è€…ç•¶å‰çš„ç¯©é¸æ¢ä»¶
            applyFilter();
        }

        function setupRealtimeListeners() {
            supabaseClient.channel('public:challenges')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'challenges' }, payload => {
                    const eventType = payload.eventType;
                    const challengeId = eventType === 'DELETE' ? payload.old.id : payload.new.id;
                    if (eventType === 'DELETE') {
                        const cardToRemove = document.getElementById(`challenge-${challengeId}`);
                        if (cardToRemove) cardToRemove.remove();
                    } else {
                        reloadChallengeCard(challengeId);
                    }
                })
                .subscribe();

            supabaseClient.channel('public:signups')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'signups' }, (payload) => {
                    const challengeId = payload.new?.challenge_id || payload.old?.challenge_id;
                    if (challengeId) {
                        fetchUserSignups().then(() => {
                           reloadChallengeCard(challengeId);
                        });
                    }
                })
                .subscribe();
        }

        function setupOnlinePresence() {
            const channel = supabaseClient.channel('online-users', {
                config: {
                    presence: {
                        key: currentUserProfile.nickname,
                    },
                },
            });

            const updatePresence = () => {
                const presenceState = channel.presenceState();
                onlineNicknames = Object.keys(presenceState);
                onlineUsersContainer.querySelector('span').textContent = `åœ¨ç·š: ${onlineNicknames.length}äºº`;
            };

            channel
                .on('presence', { event: 'sync' }, updatePresence)
                .on('presence', { event: 'join' }, updatePresence)
                .on('presence', { event: 'leave' }, updatePresence)
                .subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        await channel.track({ online_at: new Date().toISOString() });
                    }
                });
        }

        // â–¼â–¼â–¼ æ–°å¢ï¼šåœ–ç‰‡è¦–çª—æ§åˆ¶é‚è¼¯ (æ›è¼‰åˆ° window ä»¥ä¾¿ HTML onclick å‘¼å«) â–¼â–¼â–¼
        
        // é–‹å•Ÿåœ–ç‰‡è¦–çª—ï¼Œæ¥æ”¶åœ–ç‰‡ URL ä½œç‚ºåƒæ•¸
        window.openImageViewer = function(url) {
            const modal = document.getElementById('image-viewer-modal');
            const img = document.getElementById('viewer-image');
            if (modal && img) {
                // è¨­å®šåœ–ç‰‡ä¾†æº
                img.src = url;
                // é¡¯ç¤º Modal
                modal.classList.remove('hidden');
            }
        };

        // é—œé–‰åœ–ç‰‡è¦–çª—
        window.closeImageViewer = function() {
            const modal = document.getElementById('image-viewer-modal');
            if (modal) {
                // éš±è— Modal
                modal.classList.add('hidden');
                // å»¶é²æ¸…ç©º srcï¼Œé¿å…ä¸‹æ¬¡æ‰“é–‹æ™‚ç¬é–“é–ƒçˆèˆŠåœ–ï¼Œä¸¦é‡‹æ”¾è¨˜æ†¶é«”
                setTimeout(() => { 
                    const img = document.getElementById('viewer-image');
                    if(img) img.src = ''; 
                }, 300);
            }
        };

        document.addEventListener('DOMContentLoaded', initializePage);
        
        refreshButton.addEventListener('click', () => {
            window.location.reload();
        });

        filterTabs.addEventListener('click', (e) => {
            const tab = e.target.closest('.filter-tab');
            if (!tab || tab.classList.contains('active')) return;
            filterTabs.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            activeFilter = tab.dataset.filter;
            applyFilter();
        });
        
        onlineUsersContainer.addEventListener('click', (e) => {
            if(e.target.closest('#refresh-button')) return;

            onlineUsersList.innerHTML = onlineNicknames.map(name => `<li class="p-1">${name}</li>`).join('');
            onlineUsersModal.classList.remove('hidden');
        });
        closeOnlineUsersModalButton.addEventListener('click', () => {
            onlineUsersModal.classList.add('hidden');
        });

        logoutButton.addEventListener('click', async () => {
            logoutButton.disabled = true;
            logoutButton.textContent = 'ç™»å‡ºä¸­...';
            const { error } = await supabaseClient.auth.signOut();
            if (error) {
                showToast(`ç™»å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, true);
                logoutButton.disabled = false;
                logoutButton.textContent = 'ç™»å‡º';
            }
        });
        
        // ã€å¿…è¦ä¿®æ­£ã€‘è«‹ç”¨é€™æ®µç¨‹å¼ç¢¼æ›¿æ›æ‰ä½ åŸæœ¬çš„ postChallengeButton.addEventListener('click', ...)
        postChallengeButton.addEventListener('click', () => {
            challengeForm.reset();
            challengeForm['mushroom-type'].value = 'å·¨è‡';
            challengeForm['slots'].value = 4;
            
            // --- ä»¥ä¸‹æ˜¯è®€å–æ™‚é–“çš„æ ¸å¿ƒé‚è¼¯ ---
            const rememberTimeCheckbox = document.getElementById('remember-time-checkbox');
            const rememberedTime = localStorage.getItem('rememberedChallengeTime');
            // â–¼â–¼â–¼ ã€æ–°å¢ã€‘è®€å–è¨˜æ†¶çš„ç”¨é¤æ™‚æ®µ â–¼â–¼â–¼
            const rememberedDetails = localStorage.getItem('rememberedChallengeDetails'); 
            // â–¼â–¼â–¼ ã€æ–°å¢ã€‘è®€å–è¨˜æ†¶çš„ç«ä¾¯ â–¼â–¼â–¼
            const rememberedStyle = localStorage.getItem('rememberedCookingStyle');

            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const datePart = now.toISOString().split('T')[0];

            if (rememberedTime) {
                // å¦‚æœ localStorage ä¸­æœ‰è¨˜æ†¶çš„æ™‚é–“ï¼Œå°±ä½¿ç”¨å®ƒ
                challengeForm['start-time'].value = `${datePart}T${rememberedTime}`;
                
                // â–¼â–¼â–¼ ã€æ–°å¢ã€‘å¦‚æœæœ‰è¨˜æ†¶çš„æ™‚æ®µï¼Œä¹Ÿä¸€ä½µå¸¶å…¥ â–¼â–¼â–¼
                if (rememberedDetails) {
                    challengeForm['details'].value = rememberedDetails;
                }
                // â–¼â–¼â–¼ ã€æ–°å¢ã€‘å¦‚æœæœ‰è¨˜æ†¶çš„ç«ä¾¯ï¼Œä¹Ÿä¸€ä½µå¸¶å…¥ â–¼â–¼â–¼
                if (rememberedStyle) {
                    document.getElementById('cooking-style').value = rememberedStyle;
                }
                
                rememberTimeCheckbox.checked = true; // ä¸¦å°‡æ ¸å–æ¡†æ‰“å‹¾
            } else {
                // å¦å‰‡ï¼Œä½¿ç”¨ç•¶å‰æ™‚é–“
                challengeForm['start-time'].value = now.toISOString().slice(0, 16);
                rememberTimeCheckbox.checked = false; // ä¸¦å–æ¶ˆæ ¸å–æ¡†æ‰“å‹¾
            }

            // â–¼â–¼â–¼ ã€æ–°å¢ã€‘æ¸…ç©ºæª”æ¡ˆè¼¸å…¥æ¡† (é¿å…æ®˜ç•™ä¸Šæ¬¡é¸æ“‡çš„æª”æ¡ˆ) â–¼â–¼â–¼
            document.getElementById('challenge-image').value = '';

            challengeModal.classList.remove('hidden');
        });

        cancelModalButton.addEventListener('click', () => challengeModal.classList.add('hidden'));
        
        setTimeNowButton.addEventListener('click', () => {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            challengeForm['start-time'].value = now.toISOString().slice(0, 16);
        });

        challengeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitChallengeButton.disabled = true;
            submitChallengeButton.textContent = 'ç™¼å¸ƒä¸­...';

            const form = e.target;
            
            // --- 1. è™•ç†è¨˜æ†¶åŠŸèƒ½ (æ™‚é–“ã€æ™‚æ®µã€ç«ä¾¯) ---
            const rememberTimeCheckbox = document.getElementById('remember-time-checkbox');
            const timeValue = form['start-time'].value; 
            // â–¼â–¼â–¼ ã€æ–°å¢ã€‘å–å¾—ç«ä¾¯é¸å–®çš„å€¼ â–¼â–¼â–¼
            const cookingStyleVal = document.getElementById('cooking-style').value;

            if (rememberTimeCheckbox.checked && timeValue) {
                const timePart = timeValue.split('T')[1]; 
                localStorage.setItem('rememberedChallengeTime', timePart);
                localStorage.setItem('rememberedChallengeDetails', form['details'].value);
                
                // â–¼â–¼â–¼ ã€æ–°å¢ã€‘ä¸€ä½µå„²å­˜ç«ä¾¯åˆ° localStorage â–¼â–¼â–¼
                localStorage.setItem('rememberedCookingStyle', cookingStyleVal);

            } else {
                localStorage.removeItem('rememberedChallengeTime');
                localStorage.removeItem('rememberedChallengeDetails');
                
                // â–¼â–¼â–¼ ã€æ–°å¢ã€‘ç§»é™¤ç«ä¾¯è¨˜æ†¶ â–¼â–¼â–¼
                localStorage.removeItem('rememberedCookingStyle');
            }

            // --- 2. è™•ç†åœ–ç‰‡ä¸Šå‚³ (æ ¸å¿ƒæ–°å¢åŠŸèƒ½) ---
            // â–¼â–¼â–¼ ã€æ–°å¢ã€‘åœ–ç‰‡ä¸Šå‚³é‚è¼¯ â–¼â–¼â–¼
            let publicImageUrl = null;
            const fileInput = document.getElementById('challenge-image');
            
            // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦æœ‰é¸å–æª”æ¡ˆ
            if (fileInput.files && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                // å–å¾—å‰¯æª”åä¸¦ç”¢ç”Ÿä¸é‡è¤‡çš„æª”å (æ™‚é–“æˆ³è¨˜_éš¨æ©Ÿæ•¸)
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}_${Math.floor(Math.random()*1000)}.${fileExt}`;
                
                try {
                    // ä¸Šå‚³åˆ° challenge-images å„²å­˜æ¡¶
                    const { data: uploadData, error: uploadError } = await supabaseClient
                        .storage
                        .from('challenge-images') 
                        .upload(fileName, file);

                    if (uploadError) throw uploadError;

                    // ä¸Šå‚³æˆåŠŸå¾Œï¼Œå–å¾—å…¬é–‹é€£çµ
                    const { data: publicUrlData } = supabaseClient
                        .storage
                        .from('challenge-images')
                        .getPublicUrl(fileName);
                    
                    publicImageUrl = publicUrlData.publicUrl;
                } catch (err) {
                    console.error('åœ–ç‰‡ä¸Šå‚³å¤±æ•—:', err);
                    // å¦‚æœä¸Šå‚³å¤±æ•—ï¼Œé¡¯ç¤ºé»ƒè‰²è­¦å‘Šï¼Œä½†ç¨‹å¼ç¹¼çºŒå¾€ä¸‹è·‘ (å…è¨±ç™¼å¸ƒç„¡åœ–æŒ‘æˆ°)
                    showToast('åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼ŒæŒ‘æˆ°å°‡ä¸å«åœ–ç‰‡ç™¼å¸ƒã€‚', true);
                }
            }
            // â–²â–²â–² åœ–ç‰‡è™•ç†çµæŸ â–²â–²â–²

            // --- 3. æº–å‚™å¯«å…¥è³‡æ–™åº« ---
            const startTime = new Date(timeValue);
            const newChallengeData = {
                host_id: currentUserProfile.id,
                mushroom_type: form['mushroom-type'].value,
                slots: parseInt(form['slots'].value),
                start_time: startTime.toISOString(),
                details: form['details'].value,
                status: startTime > new Date() ? 'é è¨ˆé–‹æ”¾' : 'é–‹æ”¾å ±åä¸­',
                
                // â–¼â–¼â–¼ ã€æ–°å¢ã€‘å°‡ç«ä¾¯èˆ‡åœ–ç‰‡ç¶²å€å¯«å…¥è³‡æ–™åº«æ¬„ä½ â–¼â–¼â–¼
                cooking_style: cookingStyleVal,
                image_url: publicImageUrl
            };

            // --- 4. åŸ·è¡Œè³‡æ–™åº«å¯«å…¥ ---
            const { data: insertedChallenge, error } = await supabaseClient
                .from('challenges')
                .insert(newChallengeData)
                .select()
                .single(); 
            
            // --- 5. è™•ç†çµæœèˆ‡ UI æ›´æ–° ---
            if (error) {
                showToast(`ç™¼å¸ƒå¤±æ•—: ${error.message}`, true);
            } else {
                showToast('æ–°æŒ‘æˆ°å·²æˆåŠŸç™¼å¸ƒï¼', false);
                challengeModal.classList.add('hidden');
                
                // æ‰‹å‹•çµ„åˆå®Œæ•´çš„æŒ‘æˆ°ç‰©ä»¶ (åŒ…å« host è³‡è¨Š) ä»¥ä¾¿ç«‹å³æ¸²æŸ“
                const fullChallengeObject = {
                    ...insertedChallenge,
                    host: { id: currentUserProfile.id, nickname: currentUserProfile.nickname },
                    signups: []
                };
                renderChallenge(fullChallengeObject);
                applyFilter();
            }
            submitChallengeButton.disabled = false;
            submitChallengeButton.textContent = 'ç¢ºèªç™¼å¸ƒ';
        });
        
        challengesListEl.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-challenge-button');
            if (deleteButton) {
                challengeToDeleteId = deleteButton.dataset.id;
                deleteConfirmModal.classList.remove('hidden');
                return;
            }

            const editButton = e.target.closest('.edit-challenge-button');
            if (editButton) {
                const challengeId = editButton.dataset.id;
                openEditModal(challengeId);
                return;
            }

            const signupButton = e.target.closest('.signup-button');
            if (signupButton) {
                handleSignUp(signupButton.dataset.challengeId, signupButton);
                return;
            }
            const cancelButton = e.target.closest('.cancel-signup-button');
            if (cancelButton) {
                handleCancelSignUp(cancelButton.dataset.challengeId, cancelButton);
                return;
            }
            const dispatchTag = e.target.closest('.dispatch-status-tag');
            if (dispatchTag && dispatchTag.classList.contains('cursor-pointer')) {
                handleToggleDispatchStatus(dispatchTag.dataset.id, dispatchTag.dataset.currentStatus);
                return;
            }
        });
        
        function openEditModal(challengeId) {
            const challenge = challengesData[challengeId];
            if (!challenge) {
                showToast('æ‰¾ä¸åˆ°æŒ‘æˆ°è³‡æ–™ï¼Œå¯èƒ½å·²è¢«åˆªé™¤ã€‚', true);
                return;
            }

            document.getElementById('edit-challenge-id').value = challenge.id;
            document.getElementById('edit-mushroom-type').value = challenge.mushroom_type;
            document.getElementById('edit-slots').value = challenge.slots;
            
            const localTime = new Date(challenge.start_time);
            localTime.setMinutes(localTime.getMinutes() - localTime.getTimezoneOffset());
            document.getElementById('edit-start-time').value = localTime.toISOString().slice(0, 16);

            document.getElementById('edit-details').value = challenge.details;
           
            document.getElementById('edit-cooking-style').value = challenge.cooking_style || 'å¤§ç«å¿«ç‚’ï¼ˆæˆ°åŠ›å…¨é–‹ï¼‰';
            
            editChallengeModal.classList.remove('hidden');
        }

        cancelEditModalButton.addEventListener('click', () => {
            editChallengeModal.classList.add('hidden');
        });

        // â˜… ç·¨è¼¯è˜‘è‡ç«‹å³ç™¼å¸ƒæ™‚é–“ç›£è½å™¨
        editSetTimeNowButton.addEventListener('click', () => {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            // å°‡ç·¨è¼¯è¦–çª—å…§çš„æ™‚é–“è¼¸å…¥æ¡†ï¼Œè¨­å®šç‚ºç•¶å‰æ™‚é–“
            document.getElementById('edit-start-time').value = now.toISOString().slice(0, 16);
        });

        // ç·¨è¼¯æŒ‘æˆ°è¡¨å–®æäº¤ç›£è½å™¨
        editChallengeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = document.getElementById('submit-edit-challenge-button');
            submitButton.disabled = true;
            submitButton.textContent = 'å„²å­˜ä¸­...';

            const challengeId = document.getElementById('edit-challenge-id').value;
            const newSlots = parseInt(document.getElementById('edit-slots').value); 
            const newStartTime = new Date(document.getElementById('edit-start-time').value);

            // 1. ç‹€æ…‹åˆ¤æ–·é‚è¼¯ (ä¿æŒä¸è®Š)
            const currentChallengeData = challengesData[challengeId];
            const currentSignupCount = currentChallengeData?.signups?.length || 0;
            let newStatus;

            if (newStartTime > new Date()) {
                newStatus = 'é è¨ˆé–‹æ”¾';
            } else if (currentSignupCount >= newSlots) {
                newStatus = 'å·²é¡æ»¿';
            } else {
                newStatus = 'é–‹æ”¾å ±åä¸­';
            }

            // 2. æº–å‚™åŸºæœ¬çš„æ›´æ–°è³‡æ–™ (å…ˆä¸å«åœ–ç‰‡)
            const updatedData = {
                mushroom_type: document.getElementById('edit-mushroom-type').value,
                slots: newSlots, 
                start_time: newStartTime.toISOString(),
                details: document.getElementById('edit-details').value,
                status: newStatus, 
                // å¾æ–°çš„ ID (edit-cooking-style) è®€å–é¸ä¸­çš„å€¼
                cooking_style: document.getElementById('edit-cooking-style').value
            };

            // â–¼â–¼â–¼ ã€æ–°å¢ã€‘ç·¨è¼¯æ¨¡å¼çš„åœ–ç‰‡ä¸Šå‚³é‚è¼¯ â–¼â–¼â–¼
            const fileInput = document.getElementById('edit-challenge-image');
            
            // åªæœ‰ç•¶ä½¿ç”¨è€…ã€ŒçœŸçš„é¸äº†æ–°æª”æ¡ˆã€æ™‚ï¼Œæ‰åŸ·è¡Œä¸Šå‚³ä¸¦æ›´æ–°æ¬„ä½
            if (fileInput.files && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}_edit_${Math.floor(Math.random()*1000)}.${fileExt}`;
                
                try {
                    // ä¸Šå‚³æ–°åœ–ç‰‡
                    const { error: uploadError } = await supabaseClient
                        .storage
                        .from('challenge-images') 
                        .upload(fileName, file);

                    if (uploadError) throw uploadError;

                    // å–å¾—æ–°åœ–ç‰‡ç¶²å€
                    const { data: publicUrlData } = supabaseClient
                        .storage
                        .from('challenge-images')
                        .getPublicUrl(fileName);
                    
                    // å°‡æ–°ç¶²å€åŠ å…¥æ›´æ–°æ¸…å–® (é€™æœƒè¦†è“‹èˆŠåœ–é€£çµ)
                    updatedData.image_url = publicUrlData.publicUrl;

                } catch (err) {
                    console.error('ç·¨è¼¯åœ–ç‰‡ä¸Šå‚³å¤±æ•—:', err);
                    showToast('åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œæœ¬æ¬¡ä¿®æ”¹å°‡ä¸åŒ…å«æ–°åœ–ç‰‡ã€‚', true);
                }
            }
            // â–²â–²â–² æ–°å¢çµæŸ (è‹¥æ²’é¸æª”æ¡ˆï¼ŒupdatedData å°±ä¸æœƒæœ‰ image_urlï¼ŒèˆŠåœ–æœƒè¢«ä¿ç•™) â–²â–²â–²

            // 3. åŸ·è¡Œè³‡æ–™åº«æ›´æ–°
            const { error } = await supabaseClient
                .from('challenges')
                .update(updatedData)
                .eq('id', challengeId);
            
            if (error) {
                showToast(`æ›´æ–°å¤±æ•—: ${error.message}`, true);
            } else {
                showToast('æŒ‘æˆ°å·²æˆåŠŸæ›´æ–°ï¼', false);
                editChallengeModal.classList.add('hidden');
                
                // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥æ¡†ï¼Œé¿å…ä¸‹æ¬¡æ‰“é–‹é‚„ç•™è‘—
                fileInput.value = '';
                
                // é‡æ–°è¼‰å…¥å¡ç‰‡
                reloadChallengeCard(challengeId);
            }

            submitButton.disabled = false;
            submitButton.textContent = 'ç¢ºèªå„²å­˜';
        });

        // åˆªé™¤æŒ‘æˆ°çš„æ ¸å¿ƒå‡½å¼
        async function deleteChallenge(id) {
            confirmDeleteButton.disabled = true;
            confirmDeleteButton.textContent = 'åˆªé™¤ä¸­...';

            try {
                // 1. å…ˆæŸ¥è©¢è©²æŒ‘æˆ°çš„è³‡æ–™ï¼Œå–å¾—ç…§ç‰‡ç¶²å€ (image_url)
                const { data: challengeData, error: fetchError } = await supabaseClient
                    .from('challenges')
                    .select('image_url')
                    .eq('id', id)
                    .single();

                // å¦‚æœé€£è³‡æ–™éƒ½æŸ¥ä¸åˆ°ï¼Œå¯èƒ½å·²ç¶“è¢«åˆªé™¤äº†ï¼Œç›´æ¥è·³é
                if (!fetchError && challengeData && challengeData.image_url) {
                    try {
                        // è§£ææª”æ¡ˆåç¨±ï¼šå¾ URL (ä¾‹å¦‚ .../filename.jpg) å–å‡º filename.jpg
                        const fileName = challengeData.image_url.split('/').pop();
                        
                        // å‘¼å« Storage API åˆªé™¤æª”æ¡ˆ
                        const { error: storageError } = await supabaseClient
                            .storage
                            .from('challenge-images')
                            .remove([fileName]);

                        if (storageError) {
                            console.warn('ç…§ç‰‡åˆªé™¤å¤±æ•— (æ¬Šé™ä¸è¶³æˆ–æª”æ¡ˆä¸å­˜åœ¨):', storageError);
                        } else {
                            console.log('å°æ‡‰ç…§ç‰‡å·²æˆåŠŸåˆªé™¤');
                        }
                    } catch (err) {
                        console.warn('è§£æç…§ç‰‡è·¯å¾‘æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
                    }
                }

                // 2. ç…§ç‰‡è™•ç†å®Œç•¢(æˆ–ç•¥é)å¾Œï¼ŒåŸ·è¡Œè³‡æ–™åº«åˆªé™¤
                const { error: deleteError } = await supabaseClient
                    .from('challenges')
                    .delete()
                    .eq('id', id);
                
                if (deleteError) throw deleteError;

                // 3. æˆåŠŸå¾Œçš„ UI æ›´æ–°
                showToast('æŒ‘æˆ°å·²æˆåŠŸåˆªé™¤ï¼', false);
                const cardToRemove = document.getElementById(`challenge-${id}`);
                if (cardToRemove) {
                    cardToRemove.remove();
                }

            } catch (error) {
                showToast(`åˆªé™¤å¤±æ•—: ${error.message}`, true);
            } finally {
                hideDeleteConfirmModal();
            }
        }
        
        cancelDeleteButton.addEventListener('click', () => hideDeleteConfirmModal());
        confirmDeleteButton.addEventListener('click', () => { if (challengeToDeleteId) deleteChallenge(challengeToDeleteId); });
        function hideDeleteConfirmModal() {
            challengeToDeleteId = null;
            deleteConfirmModal.classList.add('hidden');
            confirmDeleteButton.disabled = false;
            confirmDeleteButton.textContent = 'ç¢ºèªåˆªé™¤';
        }

        async function handleSignUp(challengeId, buttonEl) {
            buttonEl.disabled = true;
            buttonEl.textContent = 'å ±åä¸­...';
            const numericChallengeId = parseInt(challengeId);
            const { error } = await supabaseClient.rpc('signup_for_challenge', {
                challenge_id_to_signup: numericChallengeId
            });

            if (error) {
                showToast(`å ±åå¤±æ•—: ${error.message.includes('Daily signup limit reached') ? 'æœ¬æ—¥å ±åé¡åº¦å·²æ»¿ï¼' : (error.message.includes('full') ? 'è˜‘è‡å·²é¡æ»¿ï¼' : error.message)}`, true);
                // å¦‚æœå ±åå¤±æ•—ï¼Œåªéœ€å¾©åŸè¢«é»æ“Šçš„æŒ‰éˆ•ç‹€æ…‹å³å¯
                buttonEl.disabled = false;
                buttonEl.textContent = 'å ±å';
            } else {
                showToast('å ±åæˆåŠŸï¼', false);
                userSignedUpChallengeIds.add(numericChallengeId);

                // --- è§¸ç™¼å…¨åŸŸ 3 ç§’å†·å» ---
                triggerGlobalCooldown(); 

                // â˜… ä¿®æ”¹ï¼šæ¡ç”¨æ··åˆæ›´æ–°ç­–ç•¥
                await reloadChallengeCard(challengeId); // 1. ç«‹å³æ›´æ–°è¢«é»æ“Šçš„å¡ç‰‡ï¼Œæä¾›æœ€å¿«é€Ÿçš„å›é¥‹
                await refreshUserProfile();           // 2. ç²å–æœ€æ–°çš„ä½¿ç”¨è€…å…¨åŸŸç‹€æ…‹
                refreshAllChallengeCards();         // 3. æ ¹æ“šæœ€æ–°ç‹€æ…‹ï¼Œæ›´æ–°æ‰€æœ‰å…¶ä»–å¡ç‰‡
                updateQuotaDisplay();                 // 4. æ›´æ–°é ‚éƒ¨çš„é¡åº¦é¡¯ç¤º             
            }
        }
        // --- å†·å»å‡½å¼å®šç¾© ---
        // --- ä¿®æ”¹ï¼šå†·å»å‡½å¼å®šç¾© (æ”¹ç‚ºåŸºæ–¼æ™‚é–“æˆ³è¨˜) ---
        function triggerGlobalCooldown() {
            // 1. è¨­å®šå†·å»çµæŸæ™‚é–“ (ç¾åœ¨æ™‚é–“ + 3000æ¯«ç§’)
            globalCooldownUntil = Date.now() + 3000;

            // 2. æ¸…é™¤èˆŠçš„è¨ˆæ™‚å™¨ (é¿å…é‡è¤‡åŸ·è¡Œ)
            if (globalCooldownTimer) clearInterval(globalCooldownTimer);

            // 3. å•Ÿå‹•è¨ˆæ™‚å™¨ï¼Œæ¯ 100ms æª¢æŸ¥ä¸€æ¬¡
            globalCooldownTimer = setInterval(() => {
                const timeLeft = Math.ceil((globalCooldownUntil - Date.now()) / 1000);

                // æŠ“å–ç•«é¢ä¸Šæ‰€æœ‰çš„å ±åæŒ‰éˆ• (åŒ…å«å‰›å‰›è¢«åˆ·æ–°å‡ºä¾†çš„)
                const allSignupButtons = document.querySelectorAll('.signup-button');

                if (timeLeft <= 0) {
                    // --- æ™‚é–“åˆ° ---
                    clearInterval(globalCooldownTimer);
                    globalCooldownUntil = 0; // é‡ç½®æ™‚é–“
                    
                    // å¼·åˆ¶åˆ·æ–°ä¸€æ¬¡åˆ—è¡¨ï¼Œè®“æ‰€æœ‰æŒ‰éˆ•è®Šå›è—è‰²ç‹€æ…‹
                    refreshAllChallengeCards();
                } else {
                    // --- é‚„åœ¨å†·å»ä¸­ ---
                    allSignupButtons.forEach(btn => {
                        // å¼·åˆ¶è¦†å¯«æŒ‰éˆ•ç‹€æ…‹ (é˜²æ­¢åˆ·æ–°å¾Œè®Šå›è—è‰²)
                        btn.disabled = true;
                        btn.classList.add('btn-cooldown');
                        btn.classList.remove('bg-blue-600', 'hover:bg-blue-700'); // ç§»é™¤è—è‰²æ¨£å¼
                        btn.classList.add('bg-gray-600'); // åŠ å…¥ç°è‰²æ¨£å¼
                        btn.textContent = `å†·å»ä¸­ ${timeLeft}s`;
                    });
                }
            }, 100);
        }

        async function handleCancelSignUp(challengeId, buttonEl) {
            buttonEl.disabled = true;
            buttonEl.textContent = 'å–æ¶ˆä¸­...';
            const numericChallengeId = parseInt(challengeId);
            const { error } = await supabaseClient.rpc('cancel_signup_and_update_challenge', {
                challenge_id_to_cancel: numericChallengeId
            });

            if (error) {
                showToast(`å–æ¶ˆå¤±æ•—: ${error.message}`, true);
                reloadChallengeCard(challengeId);
            } else {
                showToast('å·²å–æ¶ˆå ±å', false);
                userSignedUpChallengeIds.delete(numericChallengeId);
                // â˜… ä¿®æ”¹ï¼šæ¡ç”¨æ··åˆæ›´æ–°ç­–ç•¥
                await reloadChallengeCard(challengeId); // 1. ç«‹å³æ›´æ–°è¢«é»æ“Šçš„å¡ç‰‡
                await refreshUserProfile();           // 2. ç²å–æœ€æ–°çš„ä½¿ç”¨è€…å…¨åŸŸç‹€æ…‹
                refreshAllChallengeCards();         // 3. æ ¹æ“šæœ€æ–°ç‹€æ…‹ï¼Œæ›´æ–°æ‰€æœ‰å…¶ä»–å¡ç‰‡
                updateQuotaDisplay();                 // 4. æ›´æ–°é ‚éƒ¨çš„é¡åº¦é¡¯ç¤º
            }
        }

        async function handleToggleDispatchStatus(challengeId, currentStatus) {
            const newStatus = currentStatus === 'å¾…ç™¼' ? 'å·²ç™¼' : 'å¾…ç™¼';
            
            const updateData = { 
                dispatch_status: newStatus,
                dispatched_at: newStatus === 'å·²ç™¼' ? new Date().toISOString() : null
            };
            
            const { error } = await supabaseClient
                .from('challenges')
                .update(updateData)
                .eq('id', challengeId);
            
            if (error) {
                showToast(`æ›´æ–°å¤±æ•—: ${error.message}`, true);
                reloadChallengeCard(challengeId);
            } else {
                reloadChallengeCard(challengeId);
            }
        }
        
        // â–¼â–¼â–¼ è«‹å°‡é€™æ•´æ®µç¨‹å¼ç¢¼ï¼Œæ›¿æ›æ‰æ‚¨åŸæœ¬æä¾›çš„é‚£ä¸€æ®µèˆŠç›£è½å™¨ â–¼â–¼â–¼

        // å–å¾—é€±æœŸåˆ‡æ›æŒ‰éˆ•å…ƒç´ 
        const periodWeekBtn = document.getElementById('period-week-btn');
        const periodMonthBtn = document.getElementById('period-month-btn');

        // é–‹å•Ÿ Modal
        leaderboardButton.addEventListener('click', () => {
            leaderboardModal.classList.remove('hidden');
            // æ¯æ¬¡é–‹å•Ÿæ™‚ï¼Œé‡ç½®å›é è¨­ç‹€æ…‹ (é€±æ’è¡Œ / ç™¼è‡ç‹)
            currentLeaderboardPeriod = 'week';
            currentLeaderboardType = 'host';
            updateLeaderboardUI();
        });

        closeLeaderboardButton.addEventListener('click', () => {
            leaderboardModal.classList.add('hidden');
        });

        // ç›£è½ï¼šé€±æœŸåˆ‡æ›æŒ‰éˆ• (æœ¬é€±)
        periodWeekBtn.addEventListener('click', () => {
            currentLeaderboardPeriod = 'week';
            updateLeaderboardUI();
        });

        // ç›£è½ï¼šé€±æœŸåˆ‡æ›æŒ‰éˆ• (æœ¬æœˆ)
        periodMonthBtn.addEventListener('click', () => {
            currentLeaderboardPeriod = 'month';
            updateLeaderboardUI();
        });

        // â–¼â–¼â–¼ ã€ä¿®æ­£ 1ã€‘ç›£è½åˆ†é¡æŒ‰éˆ•é»æ“Š (æ”¹ç‚ºåµæ¸¬ button æ¨™ç±¤) â–¼â–¼â–¼
        leaderboardTabs.addEventListener('click', (e) => {
            // é€™è£¡æ”¹æˆæŠ“å– closest('button')ï¼Œå› ç‚ºæˆ‘å€‘ HTML è£¡å·²ç¶“æ²’æœ‰ .leaderboard-tab class äº†
            const btn = e.target.closest('button');
            
            // ç¢ºä¿æœ‰é»åˆ°æŒ‰éˆ•ï¼Œä¸”æŒ‰éˆ•ä¸Šæœ‰ data-type å±¬æ€§
            if (btn && btn.dataset.type) {
                currentLeaderboardType = btn.dataset.type;
                updateLeaderboardUI();
            }
        });

        // æ ¸å¿ƒ UI æ›´æ–°å‡½å¼ï¼šè² è²¬åˆ‡æ›æŒ‰éˆ•æ¨£å¼ä¸¦å‘¼å«è³‡æ–™æŠ“å–
        function updateLeaderboardUI() {
            // å®šç¾©å…©ç¨®æ¨£å¼ (Active: è—åº•ç™½å­— / Inactive: ç°å­—)
            const activeClass = 'flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition bg-indigo-600 text-white shadow-sm';
            const inactiveClass = 'flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-bold text-gray-400 hover:text-gray-200 transition';

            // 1. æ›´æ–°é€±æœŸæŒ‰éˆ•æ¨£å¼ (æœ¬é€± / æœ¬æœˆ)
            if (currentLeaderboardPeriod === 'week') {
                periodWeekBtn.className = activeClass;
                periodMonthBtn.className = inactiveClass;
            } else {
                periodWeekBtn.className = inactiveClass;
                periodMonthBtn.className = activeClass;
            }

            // 2. æ›´æ–°ä¸‹æ–¹é¡å‹æŒ‰éˆ•æ¨£å¼ (ç™¼è‡ / å ±å / æœ€é€Ÿ)
            // é¸å– #leaderboard-tabs å®¹å™¨å…§çš„æ‰€æœ‰ button
            const typeButtons = document.querySelectorAll('#leaderboard-tabs button');
            
            typeButtons.forEach(btn => {
                if (btn.dataset.type === currentLeaderboardType) {
                    btn.className = activeClass;
                } else {
                    btn.className = inactiveClass;
                }
            });

            // 3. æ ¹æ“šç•¶å‰ç‹€æ…‹æŠ“å–è³‡æ–™
            fetchLeaderboard(currentLeaderboardType, currentLeaderboardPeriod);
        }
        // â–²â–²â–² ä¿®æ­£çµæŸ â–²â–²â–²
    
        async function fetchLeaderboard(type, period) {
            const leaderboardContent = document.getElementById('leaderboard-content');
            leaderboardContent.innerHTML = '<p class="text-center text-gray-400 py-8">è®€å–ä¸­...</p>';
            
            let functionName;
            // æ ¹æ“šé¡å‹é¸æ“‡å°æ‡‰çš„ RPC å‡½å¼
            if (type === 'count') functionName = 'get_leaderboard_from_profiles';
            else if (type === 'speed') functionName = 'get_speed_leaderboard_from_profiles';
            else if (type === 'host') functionName = 'get_host_leaderboard';

            try {
                const { data, error } = await supabaseClient.rpc(functionName, {
                    period_type: period
                });

                if (error) {
                    console.error(`ç²å– ${type} (${period}) æ’è¡Œæ¦œå¤±æ•—:`, error);
                    leaderboardContent.innerHTML = `<p class="text-center text-red-400 py-8">ç„¡æ³•è¼‰å…¥æ•¸æ“š (${error.message})</p>`;
                    return;
                }
                
                // æ ¹æ“šé¡å‹å‘¼å«å°æ‡‰çš„æ¸²æŸ“å‡½å¼
                if (type === 'count') renderCountLeaderboard(data);
                else if (type === 'speed') renderSpeedLeaderboard(data);
                else if (type === 'host') renderHostLeaderboard(data);

            } catch (err) {
                console.error("åŸ·è¡Œ fetchLeaderboard æ™‚ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤:", err);
                leaderboardContent.innerHTML = '<p class="text-center text-red-400 py-8">ç™¼ç”Ÿç³»çµ±éŒ¯èª¤</p>';
            }
        }

        // 1. æ¸²æŸ“ã€Œå ±åç‹ã€
        function renderCountLeaderboard(data) {
            const leaderboardContent = document.getElementById('leaderboard-content');
            if (!data || data.length === 0) {
                leaderboardContent.innerHTML = '<p class="text-center text-gray-500 py-8">ç›®å‰æ²’æœ‰ç´€éŒ„ã€‚</p>'; 
                return;
            }

            let rank = 0;
            let lastScore = -1;

            const listHtml = data.map((item) => {
                if (item.signup_count !== lastScore) {
                    rank++;
                }
                lastScore = item.signup_count;

                let rankDisplay;
                if (rank === 1) rankDisplay = 'ğŸ¥‡';
                else if (rank === 2) rankDisplay = 'ğŸ¥ˆ';
                else if (rank === 3) rankDisplay = 'ğŸ¥‰';
                else rankDisplay = rank;

                // â˜… ä¿®æ­£çµæ§‹ï¼šä½¿ç”¨ flex, w-12, flex-1, w-24 ç¢ºä¿å°é½Šèˆ‡ä¸ç ´ç‰ˆ
                return `
                    <div class="flex items-center py-3 border-b border-gray-700 hover:bg-gray-800/50 transition">
                        <span class="w-12 text-center font-bold text-lg text-gray-300 flex-shrink-0">${rankDisplay}</span>
                        <span class="flex-1 min-w-0 px-3 truncate text-gray-200">${item.nickname || 'æœªçŸ¥'}</span>
                        <span class="w-24 text-right font-bold text-indigo-400 flex-shrink-0">${item.signup_count} æ¬¡</span>
                    </div>`;
            }).join('');
            leaderboardContent.innerHTML = listHtml;
        }

        // 2. æ¸²æŸ“ã€Œæœ€é€Ÿå‚³èªªã€
        function renderSpeedLeaderboard(data) {
            const leaderboardContent = document.getElementById('leaderboard-content');
            if (!data || data.length === 0) {
                leaderboardContent.innerHTML = '<p class="text-center text-gray-500 py-8">ç›®å‰æ²’æœ‰ç´€éŒ„ã€‚</p>'; 
                return;
            }
            
            let rank = 0;
            let lastTime = -1.0;

            const listHtml = data.map((item) => {
                const currentTime = parseFloat(item.fastest_time_seconds);

                if (currentTime !== lastTime) {
                    rank++;
                }
                lastTime = currentTime;

                let rankDisplay;
                if (rank === 1) rankDisplay = 'ğŸ¥‡';
                else if (rank === 2) rankDisplay = 'ğŸ¥ˆ';
                else if (rank === 3) rankDisplay = 'ğŸ¥‰';
                else rankDisplay = rank;
                
                const timeInSeconds = !isNaN(currentTime) ? currentTime.toFixed(3) : 'N/A';
                
                // â˜… ä¿®æ­£çµæ§‹ï¼šç¢ºä¿èˆ‡å ±åç‹ä¸€è‡´
                return `
                    <div class="flex items-center py-3 border-b border-gray-700 hover:bg-gray-800/50 transition">
                        <span class="w-12 text-center font-bold text-lg text-gray-300 flex-shrink-0">${rankDisplay}</span>
                        <span class="flex-1 min-w-0 px-3 truncate text-gray-200">${item.nickname || 'æœªçŸ¥'}</span>
                        <span class="w-24 text-right font-bold text-yellow-400 flex-shrink-0">${timeInSeconds} s</span>
                    </div>`;
            }).join('');
            leaderboardContent.innerHTML = listHtml;
        }

        // 3. æ¸²æŸ“ã€Œç™¼è‡ç‹ã€
        function renderHostLeaderboard(data) {
            const leaderboardContent = document.getElementById('leaderboard-content');
            if (!data || data.length === 0) {
                leaderboardContent.innerHTML = '<p class="text-center text-gray-500 py-8">ç›®å‰æ²’æœ‰ç´€éŒ„ã€‚</p>'; 
                return;
            }

            let rank = 0;
            let lastScore = -1;

            const listHtml = data.map((item) => {
                if (item.host_count !== lastScore) {
                    rank++;
                }
                lastScore = item.host_count;

                let rankDisplay;
                if (rank === 1) rankDisplay = 'ğŸ¥‡'; 
                else if (rank === 2) rankDisplay = 'ğŸ¥ˆ'; 
                else if (rank === 3) rankDisplay = 'ğŸ¥‰'; 
                else rankDisplay = rank;

                // â˜… ä¿®æ­£çµæ§‹ï¼šç¢ºä¿ä¸‰è€…é¢¨æ ¼çµ±ä¸€
                return `
                    <div class="flex items-center py-3 border-b border-gray-700 hover:bg-gray-800/50 transition">
                        <span class="w-12 text-center font-bold text-lg text-gray-300 flex-shrink-0">${rankDisplay}</span>
                        <span class="flex-1 min-w-0 px-3 truncate text-gray-200">${item.nickname || 'æœªçŸ¥'}</span>
                        <span class="w-24 text-right font-bold text-green-400 flex-shrink-0">${item.host_count} è‡</span>
                    </div>`;
            }).join('');
            leaderboardContent.innerHTML = listHtml;
        }
        
        changePasswordButton.addEventListener('click', () => {
            passwordForm.reset();
            passwordModal.classList.remove('hidden');
        });
        cancelPasswordButton.addEventListener('click', () => {
            passwordModal.classList.add('hidden');
        });
        passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            if (newPassword.length < 6) {
                showToast('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦6ä½æ•¸ã€‚', true); return;
            }
            if (newPassword !== confirmPassword) {
                showToast('å…©æ¬¡è¼¸å…¥çš„æ–°å¯†ç¢¼ä¸ä¸€è‡´ã€‚', true); return;
            }
            submitPasswordButton.disabled = true;
            submitPasswordButton.textContent = 'ä¿®æ”¹ä¸­...';
            const { error } = await supabaseClient.auth.updateUser({ password: newPassword });
            if (error) {
                showToast(`å¯†ç¢¼ä¿®æ”¹å¤±æ•—: ${error.message}`, true);
            } else {
                showToast('å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼ä¸‹æ¬¡ç™»å…¥æ™‚è«‹ä½¿ç”¨æ–°å¯†ç¢¼ã€‚', false);
                passwordModal.classList.add('hidden');
            }
            submitPasswordButton.disabled = false;
            submitPasswordButton.textContent = 'ç¢ºèªä¿®æ”¹';
        });

        function getRankSuffix(rank) {
            if (rank % 100 >= 11 && rank % 100 <= 13) return 'th';
            switch (rank % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }
        function formatSignupTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const timeString = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            const milliseconds = date.getMilliseconds().toString().padStart(3, '0');
            return `${timeString}.${milliseconds}`;
        }

        function updateAllCountdowns() {
            document.querySelectorAll('.countdown-timer').forEach(el => {
                const startTime = new Date(el.dataset.starttime);
                const diff = startTime - new Date();

                // â˜… ä¿®æ”¹ï¼šé‡æ–°åŠ å…¥å€’æ•¸çµæŸæ™‚çš„è™•ç†é‚è¼¯
                if (diff < 1000) {
                    // å€’æ•¸çµæŸï¼Œå¾ class ä¸­ç§»é™¤ .countdown-timerï¼Œé¿å…é‡è¤‡è§¸ç™¼
                    el.classList.remove('countdown-timer');
                    el.textContent = 'å³å°‡é–‹æ”¾...';

                    // æ‰¾åˆ°é€™å¼µå¡ç‰‡ï¼Œä¸¦ä¸»å‹•è§¸ç™¼ä¸€æ¬¡åˆ·æ–°
                    const card = el.closest('.challenge-card');
                    if (card) {
                        const challengeId = parseInt(card.id.split('-')[1]);
                        if (challengeId) {
                            // å‘¼å« reloadChallengeCard ä¾†ç²å–æœ€æ–°çš„å¡ç‰‡ç‹€æ…‹
                            reloadChallengeCard(challengeId);
                        }
                    }
                } else {
                    const days = Math.floor(diff / 86400000);
                    const hours = Math.floor((diff % 86400000) / 3600000);
                    const minutes = Math.floor((diff % 3600000) / 60000);
                    const seconds = Math.floor((diff % 60000) / 1000);
                    if (days > 0) el.textContent = `${days}å¤©${hours}å°æ™‚å¾Œ`;
                    else if (hours > 0) el.textContent = `${hours}å°æ™‚${minutes}åˆ†é˜å¾Œ`;
                    else if (minutes > 0) el.textContent = `${minutes}åˆ†é˜${seconds}ç§’å¾Œ`;
                    else el.textContent = `${seconds}ç§’å¾Œ`;
                }
            });
        }

        // å•Ÿå‹•å…¨åŸŸå€’æ•¸è¨ˆæ™‚å™¨
        function startGlobalCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                updateAllCountdowns(); // åŸæœ¬çš„ï¼šé è¨ˆé–‹æ”¾å€’æ•¸
                updateBattleTimers();  // â˜… æ–°å¢çš„ï¼šè˜‘è‡æˆ°é¬¥å€’æ•¸
            }, 1000); 
            
            // ç«‹å³åŸ·è¡Œä¸€æ¬¡
            updateAllCountdowns();
            updateBattleTimers();
        }

        function showToast(message, isError = false) {
            toastMessage.textContent = message;
            toastMessage.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            toastMessage.classList.remove('hidden');
            setTimeout(() => { toastMessage.classList.add('hidden'); }, 3000);
        }

        function applyFilter() {
            let visibleCount = 0;
            const allCards = challengesListEl.querySelectorAll('.challenge-card');
            
            allCards.forEach(card => {
                let show = false;
                if (activeFilter === 'all') {
                    if (card.dataset.status !== 'å·²é¡æ»¿') {
                        show = true;
                    }
                } else if (activeFilter === 'full') {
                    if (card.dataset.status === 'å·²é¡æ»¿') {
                        show = true;
                    }
                } else if (activeFilter === 'signed-up') {
                    if (card.dataset.isSignedUp === 'true') show = true;
                } else if (activeFilter === 'hosted') {
                    if (card.dataset.isHosted === 'true') show = true;
                }
                card.style.display = show ? 'flex' : 'none';
                if(show) visibleCount++;
            });

            const noItemsMessage = document.getElementById('no-items-message');
            if (noItemsMessage) noItemsMessage.remove();

            if(visibleCount === 0 && allCards.length > 0) {
                const p = document.createElement('p');
                p.id = 'no-items-message';
                p.className = 'text-center col-span-full text-gray-400';
                p.textContent = 'é€™å€‹åˆ†é¡ä¸‹æ²’æœ‰æŒ‘æˆ°å–”ï¼';
                challengesListEl.appendChild(p);
            }
        }

        // â–¼â–¼â–¼ ã€æ–°ç‰ˆ v3ã€‘Gmail è¨‚é–±åŠŸèƒ½æ ¸å¿ƒé‚è¼¯ â–¼â–¼â–¼
        
        function checkSubscriptionStatus() {
            if (!currentUserProfile) return;
            
            const hasEmail = !!currentUserProfile.notification_email;

            if (!hasEmail) {
                // æœªè¨‚é–±
                emailIcon.textContent = 'ğŸ“§';
                emailText.textContent = 'è¨‚é–±é€šçŸ¥';
                emailSubButton.className = 'text-gray-400 hover:text-indigo-400 transition text-xs md:text-base flex items-center gap-1 ml-2';
                emailSubButton.title = 'é»æ“Šè¨‚é–± Google Groups é€šçŸ¥';
            } else {
                // å·²è¨‚é–±
                emailIcon.textContent = 'ğŸ“­';
                emailText.textContent = 'å·²è¨‚é–±';
                emailSubButton.className = 'text-green-500 hover:text-green-400 transition text-xs md:text-base flex items-center gap-1 ml-2';
                emailSubButton.title = `æ¥æ”¶ä¿¡ç®±: ${currentUserProfile.notification_email} (é»æ“Šå¯å–æ¶ˆè¨‚é–±)`;
            }
        }

        // â–¼â–¼â–¼ ã€ä¿®æ”¹ã€‘è¨‚é–±æŒ‰éˆ• (å« Gmail è‡ªå‹•è£œå…¨åŠŸèƒ½) â–¼â–¼â–¼
        emailSubButton.addEventListener('click', async () => {
            const hasEmail = !!currentUserProfile.notification_email;

            if (!hasEmail) {
                // --- è¨‚é–±æµç¨‹ ---
                let email = prompt('è«‹è¼¸å…¥æ‚¨çš„ Gmail å¸³è™Ÿï¼š\n(è‹¥æœªè¼¸å…¥ @gmail.com ç³»çµ±å°‡è‡ªå‹•è£œä¸Š)');
                
                if (email) {
                    email = email.trim(); // å»é™¤å‰å¾Œç©ºç™½

                    // â˜… è‡ªå‹•è£œå…¨é‚è¼¯ï¼šå¦‚æœæ²’æœ‰ @ ç¬¦è™Ÿï¼Œé è¨­è£œä¸Š @gmail.com
                    if (!email.includes('@')) {
                        email += '@gmail.com';
                    }
                    
                    // å¼·åˆ¶æª¢æŸ¥æ˜¯å¦ç‚º gmail
                    if (!email.toLowerCase().endsWith('@gmail.com')) {
                        alert('æ ¼å¼éŒ¯èª¤ï¼ç‚ºäº†é…åˆ Google ç¾¤çµ„åŠŸèƒ½ï¼Œè«‹å‹™å¿…ä½¿ç”¨ @gmail.com ä¿¡ç®±ã€‚');
                        return;
                    }

                    await updateEmailSubscription(email);
                }
            } else {
                // --- å–æ¶ˆè¨‚é–±æµç¨‹ ---
                if (confirm(`ç›®å‰çš„è¨‚é–±ä¿¡ç®±ï¼š${currentUserProfile.notification_email}\n\nç¢ºå®šè¦å–æ¶ˆè¨‚é–±å—ï¼Ÿ`)) {
                    await updateEmailSubscription(null); 
                }
            }
        });
        // â–²â–²â–² ã€ä¿®æ”¹çµæŸã€‘ â–²â–²â–²

        async function updateEmailSubscription(email) {
            emailSubButton.disabled = true;
            const originalText = emailText.textContent;
            emailText.textContent = 'è™•ç†ä¸­...';

            try {
                const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: { 
                        action: 'update-subscription', 
                        payload: { 
                            userId: currentUserProfile.id, 
                            email: email 
                        } 
                    }
                });

                if (error) throw error;
                if (data.error) throw new Error(data.error);

                // æ›´æ–°æœ¬åœ°ç‹€æ…‹
                currentUserProfile.notification_email = email; 
                checkSubscriptionStatus();
                
                if (email) {
                    showToast('è¨‚é–±æˆåŠŸï¼è«‹ç­‰å¾…ç®¡ç†å“¡å°‡æ‚¨åŠ å…¥ç¾¤çµ„ã€‚', false);
                } else {
                    showToast('å·²å–æ¶ˆè¨‚é–±ã€‚', false);
                }

            } catch (err) {
                console.error(err);
                showToast('æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', true);
                emailText.textContent = originalText;
            } finally {
                emailSubButton.disabled = false;
            }
        }
        // â–²â–²â–² ã€æ–°ç‰ˆ v3ã€‘çµæŸ â–²â–²â–²
        
        // è¤‡è£½æ¡Œé¢ç‰ˆæŒ‰éˆ•äº‹ä»¶åˆ°è¡Œå‹•ç‰ˆ
        mobileMenu.querySelector('#leaderboard-button-mobile').addEventListener('click', () => leaderboardButton.click());
        mobileMenu.querySelector('#change-password-button-mobile').addEventListener('click', () => changePasswordButton.click());
        mobileMenu.querySelector('#logout-button-mobile').addEventListener('click', () => logoutButton.click());

        // è™•ç†æˆªåœ–åŠŸèƒ½çš„äº‹ä»¶ç›£è½å™¨
        screenshotButton.addEventListener('click', () => {
            const challengesListElement = document.getElementById('challenges-list');
            const originalButtonText = screenshotButton.innerHTML;

            // æä¾›ä½¿ç”¨è€…æ“ä½œå›é¥‹
            screenshotButton.disabled = true;
            screenshotButton.innerHTML = 'æˆªåœ–ä¸­...';

            html2canvas(challengesListElement, {
                backgroundColor: '#111827', 
                useCORS: true, 
                scale: 2 
            }).then(canvas => {
                const link = document.createElement('a');
                const now = new Date();
                const timestamp = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
                link.download = `è‡è‡æŒ‘æˆ°åˆ—è¡¨_${timestamp}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                link.remove();
            }).catch(err => {
                console.error('æˆªåœ–å¤±æ•—:', err);
                showToast('æˆªåœ–å¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ§åˆ¶å°éŒ¯èª¤ã€‚', true);
            }).finally(() => {
                screenshotButton.disabled = false;
                screenshotButton.innerHTML = originalButtonText;
            });
        });

        // â˜… æ–°å¢ï¼šæ¼¢å ¡é¸å–®é–‹é—œé‚è¼¯
        hamburgerButton.addEventListener('click', (event) => {
            event.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡åˆ° window
            mobileMenu.classList.toggle('hidden');
        });
        
        // â˜… æ–°å¢ï¼šé»æ“Šé é¢å…¶ä»–åœ°æ–¹æ™‚ï¼Œè‡ªå‹•é—œé–‰é¸å–®
        window.addEventListener('click', (event) => {
            if (!mobileMenu.classList.contains('hidden') && !mobileMenu.contains(event.target)) {
                mobileMenu.classList.add('hidden');
            }
        });
        
// â˜… ä¿®æ”¹å¾Œçš„æ–°ç‰ˆå‡½å¼ï¼šæ•´åˆä¸è£œé›¶é‚è¼¯èˆ‡æ”¶æˆæ™‚é–“é¡¯ç¤º
function updateBattleTimers() {
    // éæ­·æ¯ä¸€å€‹å€’æ•¸è¨ˆæ™‚å™¨
    document.querySelectorAll('.battle-timer').forEach(el => {
        const endTimeStr = el.dataset.endtime;
        // æ‰¾åˆ°åŒä¸€å€‹å¡ç‰‡å…§çš„ "æ”¶æˆæ™‚é–“" é¡¯ç¤ºå€å¡Š (å®ƒæ˜¯ battle-timer çš„é„°å±…)
        // çµæ§‹æ˜¯: .flex-col > .flex(battle-timer) + .harvest-timer
        const cardContainer = el.closest('.flex-col'); 
        const harvestEl = cardContainer ? cardContainer.querySelector('.harvest-timer') : null;

        // 1. å¦‚æœæ²’æœ‰è¨­å®šæ™‚é–“ï¼Œé¡¯ç¤ºç°¡æ½”çš„é è¨­å€¼
        if (!endTimeStr || endTimeStr === 'null' || endTimeStr === 'undefined') {
            el.textContent = '--:--'; 
            el.classList.remove('text-red-400', 'text-white');
            el.classList.add('text-gray-500'); 
            if(harvestEl) harvestEl.textContent = ''; // æ¸…ç©ºæ”¶æˆæ™‚é–“
            return;
        }

        const endTime = new Date(endTimeStr);
        const now = new Date();
        const diff = endTime - now;

        // â˜… è¨ˆç®—ä¸¦é¡¯ç¤ºæ”¶æˆæ™‚é–“ (æ ¼å¼ï¼šæ”¶æˆæ™‚é–“ã€€yyyy/MM/dd HH:mm)
        if (harvestEl) {
            const yyyy = endTime.getFullYear();
            const mo = (endTime.getMonth() + 1).toString().padStart(2, '0');
            const dd = endTime.getDate().toString().padStart(2, '0');
            const h = endTime.getHours().toString().padStart(2, '0');
            const m = endTime.getMinutes().toString().padStart(2, '0');
            harvestEl.textContent = `æ”¶æˆæ™‚é–“ã€€${yyyy}/${mo}/${dd} ${h}:${m}`;
        }

        // 2. åˆ¤æ–·æ˜¯å¦å·²çµæŸ
        if (diff <= 0) {
            el.textContent = 'å·²çµæŸ';
            el.classList.remove('text-white', 'text-gray-500');
            el.classList.add('text-red-400'); 
            return;
        }

        // 3. å°šæœªçµæŸï¼Œé¡¯ç¤ºç™½è‰²
        el.classList.remove('text-gray-500', 'text-red-400');
        el.classList.add('text-white');

        // â˜… æ ¸å¿ƒå€’æ•¸é‚è¼¯
        if (diff < 60000) { 
            // ã€æƒ…å¢ƒ Dã€‘å°æ–¼ 1 åˆ†é˜ -> é¡¯ç¤ºç§’æ•¸
            const seconds = Math.floor(diff / 1000);
            el.textContent = `å€’æ•¸:${seconds}ç§’`;
        } else {
            // è¨ˆç®—åŸºæœ¬å–®ä½
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            // åˆ†é˜è£œé›¶ (è®“ 8 è®Šæˆ 08)
            const mm = minutes.toString().padStart(2, '0');
            
            // â˜… ä¿®æ”¹é‡é»ï¼šå°æ™‚ "ä¸" è£œé›¶ (ç›´æ¥ä½¿ç”¨ hours è®Šæ•¸)
            const hh = hours; 

            if (days > 0) {
                // ã€æƒ…å¢ƒ Aã€‘å¤§æ–¼ 1 å¤©
                el.textContent = `å€’æ•¸ã€€${days}å¤©${hh}å°æ™‚${mm}åˆ†`;
            } else if (hours > 0) {
                // ã€æƒ…å¢ƒ Bã€‘å°æ–¼ 1 å¤©ï¼Œä½†æœ‰å°æ™‚ (éš±è—å¤©æ•¸)
                el.textContent = `å€’æ•¸ã€€${hh}å°æ™‚${mm}åˆ†`;
            } else {
                // ã€æƒ…å¢ƒ Cã€‘å°æ–¼ 1 å°æ™‚ (éš±è—æ™‚æ•¸)
                // åˆ†é˜å¦‚æœä¸è£œé›¶æœƒè®Šæˆ "å€’æ•¸ 5åˆ†"ï¼Œè‹¥æ‚¨å¸Œæœ›é€™è£¡ä¹Ÿä¸è£œé›¶ï¼Œå¯æ”¹ç”¨ `minutes`
                el.textContent = `å€’æ•¸ã€€${minutes}åˆ†`;
            }
        }
    });
}    </script>
</body>
</html>
