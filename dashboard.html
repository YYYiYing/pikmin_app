<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>菇菇宅配網 Pikmin Bloom 蘑菇報名表6.0</title>
    <link rel="icon" href="./mashroom_s.png" type="image/png">
    <link rel="apple-touch-icon" href="./mashroom_s.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .header-gradient {
            background: #1f2937;
            border-bottom: 1px solid #374151;
        }
        .challenge-card {
            background-color: #1f2937;
            border: 1px solid #374151;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex; 
            flex-direction: column;
            justify-content: space-between;
        }
        .challenge-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.25);
            border-color: #4f46e5;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-weight: bold;
            font-size: 0.8rem;
            text-transform: uppercase;
            white-space: nowrap; /* 強制標籤內文字不換行 */
        }

        .status-open { background-color: #10b981; color: white; }
        .status-full { background-color: #ef4444; color: white; }
        .status-pending { background-color: #f59e0b; color: white; }
        
        .dispatch-pending { background-color: #4b5563; color: white; }
        .dispatch-sent { background-color: #14b8a6; color: white; }

        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); }
        .modal-content {
            background-color: #1f2937;
            border: 1px solid #374151;
        }
        .dark-input {
            background-color: #374151;
            border-color: #4b5563;
            color: #d1d5db;
        }
        .dark-input:focus {
            --tw-ring-color: #4f46e5;
            border-color: #4f46e5;
        }
        .participant-list {
            border-top: 1px solid #374151;
            margin-top: 1rem;
            padding-top: 1rem;
        }
        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #d1d5db;
        }
        .participant-rank {
            font-weight: bold;
            color: #6366f1; /* indigo-500 */
        }

        .leaderboard-tab {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .leaderboard-tab.active {
            border-color: #4f46e5;
            color: #a5b4fc;
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #374151;
        }
        .leaderboard-rank {
            font-size: 1.2rem;
            font-weight: bold;
            width: 40px;
            text-align: center;
        }
        .leaderboard-nickname {
            flex-grow: 1;
        }
        .leaderboard-count {
            font-weight: bold;
        }
        .filter-tab {
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 9999px;
            transition: all 0.2s ease;
            font-weight: 600;
        }
        .filter-tab.active {
            background-color: #4f46e5;
            color: white;
        }
        .filter-tab:not(.active) {
            background-color: #374151;
            color: #d1d5db;
        }
        .filter-tab:not(.active):hover {
            background-color: #4b5563;
        }

        /* 隱藏捲動條但保留捲動功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* 跑馬燈動畫 (改為由 JS 控制重播) */
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .animate-marquee {
            /* 將 forwards 改為 infinite，實現無限循環 */
            animation: marquee 20s linear infinite; 
            padding-left: 0;
            display: inline-block;
            white-space: nowrap;
        }

        /* 冷卻中的按鈕樣式 */
        .btn-cooldown {
            background-color: #4b5563 !important; /* 灰色 */
            cursor: not-allowed !important;
            filter: grayscale(100%);
            transform: none !important;
        }
        /* === 自訂下拉選單樣式 (仿原生 Select 但支援搜尋) === */
        .custom-dropdown-container {
            position: relative;
            width: 100%;
        }
        
        /* 下拉選單本體 */
        .dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background-color: #374151; /* 深灰背景 */
            border: 1px solid #4b5563;
            border-radius: 0.75rem; /* rounded-xl */
            max-height: 280px;      /* 限制高度 */
            overflow-y: auto;       /* 超出捲動 */
            z-index: 50;
            display: none;          /* 預設隱藏 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        /* 顯示狀態 */
        .dropdown-options.show {
            display: block;
        }

        /* 選項樣式 */
        .dropdown-option {
            padding: 12px 16px;
            color: #d1d5db;
            cursor: pointer;
            transition: background-color 0.1s;
            font-size: 0.95rem;
            border-bottom: 1px solid #4b5563;
        }
        .dropdown-option:last-child {
            border-bottom: none;
        }
        .dropdown-option:hover {
            background-color: #4f46e5; /* 懸浮變靛藍色 */
            color: white;
        }

        /* 右側箭頭裝飾 */
        .input-arrow {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none; /* 讓點擊穿透到 input */
            color: #9ca3af;
            font-size: 0.8rem;
        }

        /* === 音樂播放器氣泡模式 CSS === */

        /* 1. 播放器容器基礎轉場設定 */
        #bg-music-player {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 90vw; /* 避免手機版太寬 */
        }

        /* 2. 縮小狀態 (Collapsed) */
        #bg-music-player.player-collapsed {
            /* 定位到右下角 */
            left: auto !important;
            right: 1.5rem !important; /* right-6 */
            bottom: 1.5rem !important; /* bottom-6 */
            transform: translateX(0) !important;
            
            /* 變形為圓形氣泡 */
            width: 3.5rem;
            height: 3.5rem;
            padding: 0;
            border-radius: 9999px;
            background-color: rgba(17, 24, 39, 0.9); /* bg-gray-900 */
            border: 2px solid #ec4899; /* pink-500 */
            cursor: pointer;
            overflow: hidden;
            
            /* 內容置中 */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        /* 3. 縮小狀態下：隱藏原本的控制列與連結 */
        #bg-music-player.player-collapsed .player-controls-wrapper,
        #bg-music-player.player-collapsed > a {
            opacity: 0;
            pointer-events: none;
            position: absolute; /* 避免佔位 */
        }

        /* 4. 縮小狀態下：顯示氣泡圖示 */
        #bg-music-player.player-collapsed .bubble-icon {
            opacity: 1;
            transform: scale(1);
        }

        /* 5. 展開狀態下：隱藏氣泡圖示 */
        .bubble-icon {
            position: absolute;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s ease;
            font-size: 1.5rem;
            pointer-events: none;
            animation: bounce-slow 2s infinite;
        }

        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
    </style>
</head>
<body class="bg-gray-900">

<header class="header-gradient shadow-md sticky top-0 z-20">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center relative">
        
        <div class="flex items-center gap-4">
            <button id="hamburger-button" class="p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-list text-white" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                </svg>
            </button>
            
            <div class="flex items-center gap-2">
                <img src="./mashroom_s.png" alt="Pikmin Logo" class="w-10 h-10 mr-2 rounded-full flex-shrink-0 object-contain bg-gray-800">
                
                <h1 class="text-xl font-bold text-white hidden md:block text-center leading-none whitespace-nowrap flex-shrink-0">
                    菇菇🍄<br>宅配網🚚
                </h1>

                <div id="online-users-container" class="flex items-center gap-2 text-sm text-white cursor-pointer hover:text-gray-300 transition whitespace-nowrap" title="查看在線列表">
                    <span></span>
                    <button id="refresh-button" title="重新整理" class="hover:text-white transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-x-4 flex-wrap justify-end">
            <span id="user-info" class="font-semibold text-gray-200 text-sm text-center">讀取中...</span>
            <span id="daily-quota-display" class="text-sm text-gray-400 border-l border-gray-600 pl-4 ml-2"></span>
            
            <div class="hidden md:flex items-center gap-x-4">
                <a id="admin-link" href="./admin.html" class="hidden text-orange-400 hover:text-orange-300 font-bold transition text-sm">⚙️ 管理後台</a>
                <button id="manage-alts-button" class="bg-gray-700 text-white px-3 py-1.5 text-xs rounded-full font-bold hover:bg-gray-600 transition">🎭 分身</button>
                <button id="change-nickname-button" class="bg-gray-700 text-white px-3 py-1.5 text-xs rounded-full font-bold hover:bg-gray-600 transition">🏷️ 改暱稱</button>
                <button id="change-password-button" class="bg-gray-700 text-white px-3 py-1.5 text-xs rounded-full font-bold hover:bg-gray-600 transition">㊙️ 改密碼</button>
                <button id="logout-button" class="bg-red-700 text-white px-3 py-1.5 text-xs rounded-full font-bold hover:bg-red-600 transition">🏃‍♂️ 登出</button>
            </div>
        </div>

        <div id="mobile-menu" class="hidden absolute top-full left-0 mt-2 w-52 bg-gray-800 rounded-lg shadow-lg p-2 max-h-[80vh] overflow-y-auto z-50 border border-gray-700">
            <div class="space-y-1">
                <button id="leaderboard-button" class="w-full text-left text-yellow-400 hover:bg-gray-700 p-2 rounded-md font-bold">🏆 排行榜</button>
                <a href="./radar.html" class="block text-blue-400 hover:bg-gray-700 p-2 rounded-md font-bold">📡 純點雷達站</a>
                <a href="./gallery.html" class="block text-purple-400 hover:bg-gray-700 p-2 rounded-md font-bold">🎨 美片藝廊(公開)</a>
                <a href="./postcard.html" class="block text-pink-400 hover:bg-gray-700 p-2 rounded-md font-bold">🖼️ 美片圖書館(私房)</a>
                <a href="./partner.html" class="block text-cyan-400 hover:bg-gray-700 p-2 rounded-md font-bold">🤝 村民好友碼</a>
                <a href="https://joystick-gpx-convert.netlify.app/" target="_blank" class="block text-green-400 hover:bg-gray-700 p-2 rounded-md font-bold">🔃 路徑轉檔</a>
                <a id="gpx-generator-link-mobile" href="./gpx_generator.html" class="block text-green-400 hover:bg-gray-700 p-2 rounded-md font-bold">🗺️ 路徑生成</a>
                <a href="./guest.html" class="block text-fuchsia-400 hover:bg-gray-700 p-2 rounded-md font-bold">🛸 天外奇菇</a>
            </div>
            <hr class="border-gray-600 my-2">
            <div class="space-y-1">
                
                <a id="admin-link-mobile" href="./admin.html" class="hidden block text-orange-400 hover:bg-gray-700 p-2 rounded-md font-bold">⚙️ 管理後台</a>
            </div>
            <hr class="border-gray-600 my-2">
            <div class="space-y-1">
                <button id="manage-alts-button-mobile" class="w-full text-left text-gray-300 hover:bg-gray-700 p-2 rounded-md">🎭 分身設定</button>
                <button id="change-nickname-button-mobile" class="w-full text-left text-gray-300 hover:bg-gray-700 p-2 rounded-md">🏷️ 改暱稱</button>
                <button id="change-password-button-mobile" class="w-full text-left text-gray-300 hover:bg-gray-700 p-2 rounded-md">㊙️ 改密碼</button>
                <button id="logout-button-mobile" class="w-full text-left text-red-400 hover:bg-gray-700 p-2 rounded-md">🏃‍♂️ 登出</button>
            </div>
        </div>
    </div>

    <div id="bg-music-player" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-40 flex flex-col gap-1 items-center group transition-all duration-500">

    <div class="bubble-icon">🎵</div>

    <a href="https://www.youtube.com/playlist?list=PLnvczP3jeVcKbv9p3sHtYmIEPZpuBlOAi" target="_blank" class="ml-2 text-[10px] text-gray-400 hover:text-pink-400 transition no-underline flex items-center gap-1 shadow-sm bg-black/60 px-2 py-0.5 rounded-full backdrop-blur-sm border border-gray-700" title="前往官方播放清單">
        <span>🎵</span>
        <span>Music by Pikmin Bloom Official</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
            <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
        </svg>
    </a>

    <div class="player-controls-wrapper bg-gray-900/90 backdrop-blur border border-gray-700 rounded-full px-4 py-2 shadow-2xl flex items-center gap-3 w-auto transition-all duration-300 hover:bg-gray-800 hover:border-gray-600 hover:scale-105">
        
        <div id="youtube-player-container" class="absolute opacity-0 pointer-events-none w-[1px] h-[1px] overflow-hidden"></div>

        <button id="music-toggle-btn" class="text-gray-300 hover:text-pink-500 transition focus:outline-none">
            <svg id="icon-play" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-play-fill" viewBox="0 0 16 16">
                <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
            </svg>
            <svg id="icon-pause" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-pause-fill hidden" viewBox="0 0 16 16">
                <path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/>
            </svg>
        </button>

        <button id="music-next-btn" class="text-gray-400 hover:text-pink-500 transition focus:outline-none" title="下一首">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-skip-end-fill" viewBox="0 0 16 16">
                <path d="M12.5 4a.5.5 0 0 0-1 0v3.248L5.233 3.612C4.693 3.3 4 3.678 4 4.308v7.384c0 .63.692 1.01 1.233.697L11.5 8.753V12a.5.5 0 0 0 1 0V4z"/>
            </svg>
        </button>

        <span id="music-time" class="text-xs font-mono text-gray-400 select-none w-20 text-center">0:00 / 0:00</span>

        <input type="range" id="music-progress" class="w-20 md:w-32 h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-pink-500" value="0" min="0" max="100" step="1">

        <button id="music-volume-btn" class="text-gray-300 hover:text-white transition focus:outline-none">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-volume-up-fill" viewBox="0 0 16 16">
                <path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303l.708.707z"/>
                <path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.483 5.483 0 0 1 11.025 8a5.483 5.483 0 0 1-1.61 3.09l.706.706z"/>
                <path d="M8.707 11.182A4.486 4.486 0 0 0 10.025 8a4.486 4.486 0 0 0-1.318-3.182L8 5.525A3.489 3.489 0 0 1 8.99 8 3.49 3.49 0 0 1 8 10.475l.707.707zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06z"/>
            </svg>
        </button>
    </div>
</div>
</header>

    <div class="bg-gray-800 border-b border-gray-700 py-2 overflow-hidden">
        <div class="container mx-auto px-4 relative flex items-center">
            <span class="text-xs font-bold text-yellow-400 mr-2 flex-shrink-0">⚡ 快訊 |</span>
            <div class="overflow-hidden w-full">
                <div id="marquee-content" class="whitespace-nowrap text-xs text-gray-300 animate-marquee inline-block">
                    讀取榮譽榜中...
                </div>
            </div>
        </div>
    </div>

    <div class="w-full bg-gray-900 border-b border-gray-700">
        <div id="wishing-well-section" class="container mx-auto px-4 flex items-stretch h-4 md:h-4 relative group">
            
            <div id="wish-action-area" class="w-20 md:w-24 flex-shrink-0 flex items-center justify-center bg-gray-800 border-r border-gray-700 hover:bg-gray-700 transition cursor-pointer text-gray-200 select-none">
                <button id="open-wish-modal-btn" class="flex items-center gap-1 text-[10px] md:text-xs font-bold focus:outline-none pointer-events-none">
                    <span class="animate-pulse">✨</span> 
                    <span>點我許願</span>
                </button>
                
                <span id="wished-message" class="hidden flex items-center gap-1 text-[10px] md:text-xs font-bold text-green-400 cursor-default">
                    <span>✅</span>
                    <span class="hidden md:inline">明日再來</span>
                    <span class="md:hidden">OK</span>
                </span>
            </div>

            <div id="wishing-well-bar" class="flex-grow flex items-center relative overflow-hidden bg-gray-900 cursor-pointer" title="點擊查看詳細數據">
                <div class="w-full text-center text-[10px] md:text-xs text-gray-500">尚無許願數據</div>
            </div>
        </div>
    </div>

    <div id="wish-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-sm rounded-2xl shadow-xl p-6 bg-gray-800 border border-gray-600">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">✨ 許願池</h3>
                <button id="close-wish-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <p class="text-sm text-gray-400 mb-4">請選擇您最想要的精華 (最多可選 3 種)</p>
            
            <div class="grid grid-cols-2 gap-3 mb-6" id="wish-options">
                
                <label class="flex items-center space-x-2 p-3 rounded-lg border border-gray-600 bg-gray-700/50 cursor-pointer hover:bg-gray-700 transition select-none">
                    <input type="checkbox" value="巨菇" class="wish-checkbox form-checkbox h-5 w-5 text-indigo-500 rounded border-gray-500 bg-gray-600 focus:ring-0 focus:ring-offset-0">
                    <span class="text-cyan-400 font-bold flex items-center">
                        <span class="text-3xl mr-1 filter drop-shadow-md">🍄</span> 
                        <span>巨菇</span>
                    </span>
                </label>

                <label class="flex items-center space-x-2 p-3 rounded-lg border border-gray-600 bg-gray-700/50 cursor-pointer hover:bg-gray-700 transition select-none">
                    <input type="checkbox" value="活動菇" class="wish-checkbox form-checkbox h-5 w-5 text-indigo-500 rounded border-gray-500 bg-gray-600 focus:ring-0 focus:ring-offset-0">
                    <span class="text-lime-400 font-bold flex items-center">
                        <span class="text-lg mr-1 filter drop-shadow-md">🍄</span> 
                        <span>活動菇</span>
                    </span>
                </label>

                <label class="flex items-center space-x-2 p-3 rounded-lg border border-gray-600 bg-gray-700/50 cursor-pointer hover:bg-gray-700 transition select-none">
                    <input type="checkbox" value="白" class="wish-checkbox form-checkbox h-5 w-5 text-indigo-500 rounded border-gray-500 bg-gray-600 focus:ring-0 focus:ring-offset-0">
                    <span class="text-gray-200 font-bold">⚪ 白色</span>
                </label>
                <label class="flex items-center space-x-2 p-3 rounded-lg border border-gray-600 bg-gray-700/50 cursor-pointer hover:bg-gray-700 transition select-none">
                    <input type="checkbox" value="紅" class="wish-checkbox form-checkbox h-5 w-5 text-indigo-500 rounded border-gray-500 bg-gray-600 focus:ring-0 focus:ring-offset-0">
                    <span class="text-red-400 font-bold">🔴 紅色</span>
                </label>
                <label class="flex items-center space-x-2 p-3 rounded-lg border border-gray-600 bg-gray-700/50 cursor-pointer hover:bg-gray-700 transition select-none">
                    <input type="checkbox" value="黃" class="wish-checkbox form-checkbox h-5 w-5 text-indigo-500 rounded border-gray-500 bg-gray-600 focus:ring-0 focus:ring-offset-0">
                    <span class="text-yellow-400 font-bold">🟡 黃色</span>
                </label>
                <label class="flex items-center space-x-2 p-3 rounded-lg border border-gray-600 bg-gray-700/50 cursor-pointer hover:bg-gray-700 transition select-none">
                    <input type="checkbox" value="藍" class="wish-checkbox form-checkbox h-5 w-5 text-indigo-500 rounded border-gray-500 bg-gray-600 focus:ring-0 focus:ring-offset-0">
                    <span class="text-blue-400 font-bold">🔵 藍色</span>
                </label>
            </div>

            <button id="submit-wish-btn" class="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold rounded-xl shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                送出許願
            </button>
        </div>
    </div>

    <main class="container mx-auto p-4 md:p-8 pb-28">
        <div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4 flex-wrap justify-center">
                
            <div id="filter-tabs" class="flex space-x-2 overflow-x-auto no-scrollbar p-2">
                <button data-filter="all" class="filter-tab active relative text-xs md:text-base whitespace-nowrap px-3 md:px-4">
                    全部挑戰
                    <span id="badge-all" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full z-10 shadow-sm border border-gray-900">0</span>
                </button>
                
                <button data-filter="imported" class="filter-tab relative text-xs md:text-base whitespace-nowrap px-3 md:px-4 text-pink-400 border-pink-500/30">
                    進口菇
                    <span id="badge-imported" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full z-10 shadow-sm border border-gray-900">0</span>
                </button>

                <button data-filter="full" class="filter-tab relative text-xs md:text-base whitespace-nowrap px-3 md:px-4">
                    已額滿
                    <span id="badge-full" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full z-10 shadow-sm border border-gray-900">0</span>
                </button>

                <button data-filter="signed-up" class="filter-tab relative text-xs md:text-base whitespace-nowrap px-3 md:px-4">
                    已報名
                    <span id="badge-signed" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full z-10 shadow-sm border border-gray-900">0</span>
                </button>

                <button id="hosted-tab" data-filter="hosted" class="filter-tab hidden relative text-xs md:text-base whitespace-nowrap px-3 md:px-4">
                    已發布
                    <span id="badge-hosted" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full z-10 shadow-sm border border-gray-900">0</span>
                </button>
            </div>
                
                <div class="flex items-center space-x-2 ml-2">
                    <button id="signup-sub-button" class="text-gray-400 hover:text-indigo-400 transition text-xs md:text-base flex items-center gap-1" title="訂閱新蘑菇通知">
                        <span id="signup-email-icon">📧</span> <span id="signup-email-text">報名通知</span>
                    </button>
                    <button id="full-sub-button" class="text-gray-400 hover:text-red-400 transition text-xs md:text-base flex items-center gap-1" title="訂閱蘑菇額滿通知">
                        <span id="full-email-icon">🔔</span> <span id="full-email-text">額滿通知</span>
                    </button>
                </div>

                <button id="screenshot-button" class="text-gray-400 hover:text-white transition text-xs md:text-base">📸 截圖</button>
            </div>
            <button id="post-challenge-button" class="hidden bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition transform hover:scale-105 w-full md:w-auto">
                🍄 發布新挑戰
            </button>
        </div>
        <div id="challenges-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <p id="loading-indicator" class="text-center col-span-full text-gray-400">正在載入挑戰列表，請稍候...</p>
        </div>
    </main>
    
    <div id="online-users-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-xs rounded-2xl shadow-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-100">在線人員</h2>
                <button type="button" id="close-online-users-modal" class="text-gray-500 hover:text-white text-2xl">&times;</button>
            </div>
            <ul id="online-users-list" class="space-y-2 max-h-64 overflow-y-auto text-gray-300"></ul>
        </div>
    </div>

    <!-- 同步剩餘時間 Modal -->
    <div id="sync-time-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-sm rounded-2xl shadow-xl p-8">
            <h2 class="text-xl font-bold mb-4 text-gray-100">⏱️ 設定蘑菇剩餘時間</h2>
            <p class="text-sm text-gray-400 mb-6">請輸入遊戲中顯示的剩餘時間，系統將自動計算結束時間。</p>
            
            <form id="sync-time-form">
                <input type="hidden" id="sync-challenge-id">
                <div class="flex space-x-2 mb-6">
                    <div class="flex-1">
                        <label class="block text-xs text-gray-400 mb-1">天</label>
                        <input type="number" id="sync-days" min="0" value="0" class="dark-input w-full rounded-md text-center" onfocus="this.select()">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs text-gray-400 mb-1">小時</label>
                        <input type="number" id="sync-hours" min="0" max="23" value="0" class="dark-input w-full rounded-md text-center" onfocus="this.select()">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs text-gray-400 mb-1">分鐘</label>
                        <input type="number" id="sync-minutes" min="0" max="59" value="0" class="dark-input w-full rounded-md text-center" onfocus="this.select()">
                    </div>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-sync-button" class="px-4 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">取消</button>
                    <button type="button" id="clear-sync-button" class="px-4 py-2 bg-red-800 text-white rounded-lg font-semibold hover:bg-red-700">清除時間</button>
                    <button type="submit" id="confirm-sync-button" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700">更新</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 新增/發布挑戰 Modal -->
    <div id="challenge-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-6 text-gray-100">發布一個新挑戰</h2>
            <form id="challenge-form">
                <div class="space-y-4">
                    <div>
                        <label for="post-identity" class="block text-sm font-medium text-gray-400">發布身分</label>
                        <select id="post-identity" class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="main">主帳號 (讀取中...)</option>
                        </select>
                    </div>
                    <div>
                        <label for="mushroom-type" class="block text-sm font-medium text-gray-400">蘑菇種類</label>
                        <select id="mushroom-type" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="巨菇" selected>巨菇</option>
                            <option value="活動菇">活動菇</option>
                            <option value="美片菇">美片菇</option>
                            <option value="大晶">大晶</option>
                            <option value="大火">大火</option>
                            <option value="大水">大水</option>
                            <option value="大電">大電</option>
                            <option value="大毒">大毒</option>
                            <option value="大冰藍">大冰藍</option>
                            <option value="大紅">大紅</option>
                            <option value="大黃">大黃</option>
                            <option value="大藍">大藍</option>
                            <option value="大紫">大紫</option>
                            <option value="大粉">大粉</option>
                            <option value="大灰">大灰</option>
                            <option value="大白">大白</option>
                            <option value="晶">晶</option>
                            <option value="水">水</option>
                            <option value="火">火</option>
                            <option value="電">電</option>
                            <option value="毒">毒</option>
                            <option value="測試">測試</option>
                        </select>
                    </div>

                    <div>
                        <label for="slots" class="block text-sm font-medium text-gray-400">名額</label>
                        <input type="number" id="slots" min="1" max="4" required class="dark-input mt-1 block w-full rounded-md shadow-sm" value="4">
                    </div>

                    <div>
                        <div class="flex justify-between items-center">
                            <label for="start-time" class="block text-sm font-medium text-gray-400">開放報名時間</label>
                            <button type="button" id="set-time-now-button" class="text-xs bg-indigo-500 text-white px-2 py-1 rounded-md hover:bg-indigo-600">立即開放</button>
                        </div>
                        <input type="datetime-local" id="start-time" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            
                        <div class="mt-2 flex items-center">
                            <input id="remember-time-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:bg-gray-600 dark:border-gray-500">
                            <label for="remember-time-checkbox" class="ml-2 block text-sm text-gray-400">記住時間 (下次自動帶入)</label>
                        </div>
                    </div>

                    <div>
                        <label for="details" class="block text-sm font-medium text-gray-400">用餐時段</label>
                        <select id="details" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="宵夜" selected>宵夜 (21:00~01:00)</option>
                            <option value="早餐">早餐 (06:00~11:00)</option>
                            <option value="午餐">午餐 (11:00~15:00)</option>
                            <option value="下午茶">下午茶 (15:00~17:00)</option>
                            <option value="晚餐">晚餐 (17:00~21:00)</option>
                            <option value="滿人開">滿人開 (人滿後發)</option>
                        </select>
                    </div>
                    <div>
                        <label for="cooking-style" class="block text-sm font-medium text-gray-400">火侯</label>
                        <select id="cooking-style" class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="大火快炒（戰力全開）">大火快炒（戰力全開）</option>
                            <option value="細火慢燉（控制戰力）">細火慢燉（控制戰力）</option>
                            <option value="隨便亂炒（不限戰力）"selected>隨便亂炒（不限戰力）</option>
                        </select>
                    </div>

                    <div>
                        <label for="challenge-image" class="block text-sm font-medium text-gray-400">蘑菇美片 (選填)</label>
                        <div class="flex gap-2 mt-1">
                            <input type="file" id="challenge-image" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700"/>
                            <button type="button" onclick="openLibraryModal('challenge-image')" class="flex-shrink-0 bg-pink-600 hover:bg-pink-700 text-white px-3 py-2 rounded-lg font-bold text-sm transition shadow-md whitespace-nowrap">
                                🖼️ 美片
                            </button>
                        </div>
                        </div>
                    </div>
                    
                    <div>
                        <label for="challenge-notes" class="block text-sm font-medium text-gray-400">備註 (選填)</label>
                        <input type="text" id="challenge-notes" maxlength="150" class="dark-input mt-1 block w-full rounded-md shadow-sm" placeholder="補充說明...">
                    </div>

                    <div class="mt-8 flex justify-end space-x-4">       
                        <button type="button" id="cancel-modal-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">取消</button>
                        <button type="submit" id="submit-challenge-button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-50">確認發布</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 編輯挑戰 Modal -->
    <div id="edit-challenge-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-6 text-gray-100">編輯挑戰內容</h2>
            <form id="edit-challenge-form">
                <input type="hidden" id="edit-challenge-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-post-identity" class="block text-sm font-medium text-gray-400">發布身分</label>
                        <select id="edit-post-identity" class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="main">主帳號</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-mushroom-type" class="block text-sm font-medium text-gray-400">蘑菇種類</label>
                        <select id="edit-mushroom-type" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="巨菇">巨菇</option>
                            <option value="活動菇">活動菇</option>
                            <option value="美片菇">美片菇</option>
                            <option value="大晶">大晶</option>
                            <option value="大火">大火</option>
                            <option value="大水">大水</option>
                            <option value="大電">大電</option>
                            <option value="大毒">大毒</option>
                            <option value="大冰藍">大冰藍</option>
                            <option value="大紅">大紅</option>
                            <option value="大黃">大黃</option>
                            <option value="大藍">大藍</option>
                            <option value="大紫">大紫</option>
                            <option value="大粉">大粉</option>
                            <option value="大灰">大灰</option>
                            <option value="大白">大白</option>
                            <option value="晶">晶</option>
                            <option value="水">水</option>
                            <option value="火">火</option>
                            <option value="電">電</option>
                            <option value="毒">毒</option>
                            <option value="測試">測試</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-slots" class="block text-sm font-medium text-gray-400">名額</label>
                        <input type="number" id="edit-slots" min="1" max="4" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                    </div>
                    <div>
                        <div class="flex justify-between items-center">
                            <label for="edit-start-time" class="block text-sm font-medium text-gray-400">開放報名時間</label>
                            <button type="button" id="edit-set-time-now-button" class="text-xs bg-indigo-500 text-white px-2 py-1 rounded-md hover:bg-indigo-600">立即開放</button>
                        </div>
                        <input type="datetime-local" id="edit-start-time" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="edit-details" class="block text-sm font-medium text-gray-400">用餐時段</label>
                        <select id="edit-details" required class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="宵夜">宵夜 (21:00~01:00)</option>
                            <option value="早餐">早餐 (06:00~11:00)</option>
                            <option value="午餐">午餐 (11:00~15:00)</option>
                            <option value="下午茶">下午茶 (15:00~17:00)</option>
                            <option value="晚餐">晚餐 (17:00~21:00)</option>
                            <option value="滿人開">滿人開 (人滿後發)</option>               
                        </select>
                    </div>
                    
                    <div>
                        <label for="edit-cooking-style" class="block text-sm font-medium text-gray-400">火侯</label>
                        <select id="edit-cooking-style" class="dark-input mt-1 block w-full rounded-md shadow-sm">
                            <option value="大火快炒（戰力全開）">大火快炒（戰力全開）</option>
                            <option value="細火慢燉（控制戰力）">細火慢燉（控制戰力）</option>
                            <option value="隨便亂炒（不限戰力）">隨便亂炒（不限戰力）</option>
                        </select>
                    </div>

                    <div>
                        <label for="edit-challenge-image" class="block text-sm font-medium text-gray-400">蘑菇美片 (選填)</label>
                        <div class="flex gap-2 mt-1">
                            <input type="file" id="edit-challenge-image" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700"/>
                            <button type="button" onclick="openLibraryModal('challenge-image')" class="flex-shrink-0 bg-pink-600 hover:bg-pink-700 text-white px-3 py-2 rounded-lg font-bold text-sm transition shadow-md whitespace-nowrap">
                                🖼️ 美片
                            </button>
                        </div>
                    </div>

                    <div>
                        <label for="edit-challenge-notes" class="block text-sm font-medium text-gray-400">備註 (選填)</label>
                        <input type="text" id="edit-challenge-notes" maxlength="150" class="dark-input mt-1 block w-full rounded-md shadow-sm" placeholder="補充說明...">
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="cancel-edit-modal-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">取消</button>
                    <button type="submit" id="submit-edit-challenge-button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-50">確認儲存</button>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
            <div class="modal-content w-full max-w-sm rounded-2xl shadow-xl p-8">
                <h2 class="text-xl font-bold mb-4 text-white">確認刪除</h2>
                <p class="text-gray-400 mb-6">您確定要刪除這個挑戰嗎？此操作無法復原。</p>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-delete-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">取消</button>
                    <button type="button" id="confirm-delete-button" class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 disabled:opacity-50">確認刪除</button>
                </div>
            </div>
        </div>

        <div id="leaderboard-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content w-full max-w-lg rounded-2xl shadow-xl p-8 flex flex-col max-h-[90vh]">
            
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-100">🏆 榮譽榜</h2>
                    <p class="text-xs text-gray-400 mt-1">每 30 分鐘更新一次數據</p>
                </div>
                <button type="button" id="close-leaderboard-button" class="text-gray-500 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            
            <div class="flex justify-center mb-4">
                <div class="bg-gray-700 p-1 rounded-lg inline-flex w-full sm:w-auto">
                    <button id="period-week-btn" class="flex-1 sm:flex-none px-6 py-1.5 rounded-md text-sm font-bold transition bg-indigo-600 text-white shadow-sm">本週排行</button>
                    <button id="period-month-btn" class="flex-1 sm:flex-none px-6 py-1.5 rounded-md text-sm font-bold text-gray-400 hover:text-gray-200 transition">本月排行</button>
                </div>
            </div>

            <div class="flex justify-center mb-4">
                <div id="leaderboard-tabs" class="bg-gray-700 p-1 rounded-lg inline-flex w-full sm:w-auto">
                    <button data-type="host" class="flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition bg-indigo-600 text-white shadow-sm">🍄 發菇王</button>
                    <button data-type="count" class="flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-bold text-gray-400 hover:text-gray-200 transition">📝 報名王</button>
                    <button data-type="speed" class="flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-bold text-gray-400 hover:text-gray-200 transition">⚡ 最速傳說</button>
                    <button data-type="postcard" class="flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-bold text-gray-400 hover:text-gray-200 transition">🖼️ 美片王</button>
                </div>
            </div>

            <div id="leaderboard-content" class="space-y-2 overflow-y-auto flex-grow min-h-[200px]">
                <p class="text-center text-gray-500 mt-8">讀取中...</p>
            </div>
        </div>
    </div>

        <div id="image-viewer-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" onclick="closeImageViewer()">
        <div class="relative max-w-3xl w-full max-h-[90vh] flex justify-center p-2" onclick="event.stopPropagation()">
            <button type="button" onclick="closeImageViewer()" class="absolute top-4 right-4 text-white text-3xl hover:text-gray-300 font-bold bg-black/50 rounded-full w-10 h-10 flex items-center justify-center">&times;</button>
            <img id="viewer-image" src="" alt="蘑菇美片" class="rounded-lg shadow-2xl max-h-[85vh] object-contain bg-gray-900">
        </div>
        </div>

        <div id="nickname-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
            <div class="modal-content w-full max-w-sm rounded-2xl shadow-xl p-8">
                <h2 class="text-2xl font-bold mb-4 text-gray-100">修改暱稱</h2>
                <p class="text-sm text-red-400 mb-6 font-bold">⚠️ 修改後，下次登入請使用新暱稱！</p>
                <form id="nickname-form">
                    <label for="new-nickname-input" class="block text-sm font-medium text-gray-400">新暱稱</label>
                    <input type="text" id="new-nickname-input" required maxlength="30" class="dark-input mt-1 block w-full rounded-md shadow-sm" placeholder="輸入新名字...">
                    
                    <div class="mt-8 flex justify-end space-x-4">
                        <button type="button" id="cancel-nickname-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">取消</button>
                        <button type="submit" id="submit-nickname-button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-50">確認修改</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="password-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
            <div class="modal-content w-full max-w-md rounded-2xl shadow-xl p-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-100">修改密碼</h2>
                <form id="password-form">
                    <div class="space-y-4">
                        <div>
                            <label for="new-password" class="block text-sm font-medium text-gray-400">新密碼 (至少6位數)</label>
                            <input type="password" id="new-password" required minlength="6" class="dark-input mt-1 block w-full rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="confirm-password" class="block text-sm font-medium text-gray-400">確認新密碼</label>
                            <input type="password" id="confirm-password" required minlength="6" class="dark-input mt-1 block w-full rounded-md shadow-sm">
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end space-x-4">
                        <button type="button" id="cancel-password-button" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">取消</button>
                        <button type="submit" id="submit-password-button" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-50">確認修改</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="toast-message" class="hidden fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg"></div>

        <button id="back-to-top-btn" class="hidden fixed bottom-24 right-4 z-30 bg-gray-700/80 hover:bg-indigo-600 text-white p-3 rounded-full shadow-lg border border-gray-600 transition-all duration-300 backdrop-blur-sm group translate-y-4 opacity-0" title="回到頂部">
            <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" width="24" height="24" fill="currentColor" class="bi bi-arrow-up-short group-hover:-translate-y-1 transition-transform" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 12a.5.5 0 0 0 .5-.5V5.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 5.707V11.5a.5.5 0 0 0 .5.5z"/>
            </svg>
        </button>

<div id="library-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-backdrop">
    <div class="modal-content w-full max-w-4xl rounded-2xl shadow-xl p-6 bg-gray-800 border border-gray-600 flex flex-col max-h-[90vh] overflow-y-auto">
        
        <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <span>🖼️</span> 選擇美片
            </h3>
            <button type="button" onclick="closeLibraryModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>

        <div class="flex justify-center mb-4">
            <div class="bg-gray-700 p-1 rounded-lg inline-flex">
                <button onclick="switchArtTab('library')" id="tab-library" class="px-6 py-1.5 rounded-md text-sm font-bold transition bg-pink-600 text-white shadow-sm">
                    📖 圖書館 (私房)
                </button>
                <button onclick="switchArtTab('gallery')" id="tab-gallery" class="px-6 py-1.5 rounded-md text-sm font-bold text-gray-400 hover:text-gray-200 transition">
                    🎨 藝廊 (公開)
                </button>
            </div>
        </div>
        
        <div id="lib-loading" class="hidden text-center py-4">
            <span class="text-pink-400 animate-pulse font-bold">正在讀取美片數據...</span>
        </div>

        <div id="library-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 p-2 overflow-y-auto min-h-[200px]">
            </div>

        <div id="lib-pagination" class="flex justify-center items-center gap-3 mt-4 mb-2">
            <button onclick="changeLibPage(-1)" id="lib-prev-btn" class="flex items-center justify-center w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded text-gray-300 disabled:opacity-30 disabled:cursor-not-allowed transition">◀</button>
            
            <div class="flex items-center bg-gray-900 border border-gray-700 rounded px-2 py-1">
                <span class="text-xs text-gray-500 mr-2">Page</span>
                <input type="number" id="lib-page-input" value="1" min="1" 
                       class="w-12 bg-transparent text-center text-white text-sm outline-none focus:ring-1 focus:ring-pink-500 rounded transition"
                       onchange="jumpToLibPage(this.value)" 
                       onkeydown="if(event.key==='Enter') jumpToLibPage(this.value)">
                <span id="lib-total-pages" class="text-sm text-gray-500 font-mono border-l border-gray-700 pl-2 ml-1">/ 1</span>
            </div>

            <button onclick="changeLibPage(1)" id="lib-next-btn" class="flex items-center justify-center w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded text-gray-300 disabled:opacity-30 disabled:cursor-not-allowed transition">▶</button>
        </div>

        <div class="mt-4 flex justify-end pt-2 border-t border-gray-700">
            <button type="button" onclick="closeLibraryModal()" class="px-6 py-2 bg-gray-600 text-gray-200 rounded-lg font-semibold hover:bg-gray-500">取消</button>
        </div>
    </div>
</div>

<div id="alts-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
    <div class="modal-content w-full max-w-md rounded-2xl shadow-xl p-6 bg-gray-800 border border-gray-600">
        <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
            <h2 class="text-xl font-bold text-gray-100">🎭 管理分身帳號</h2>
            <button type="button" id="close-alts-modal" class="text-gray-500 hover:text-white text-2xl leading-none">&times;</button>
        </div>

        <div class="mb-6">
            <h3 class="text-sm font-bold text-gray-400 mb-2">已建立的分身</h3>
            <ul id="alts-list" class="space-y-2 max-h-40 overflow-y-auto pr-2">
                <li class="text-center text-gray-500 text-sm">讀取中...</li>
            </ul>
        </div>

        <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
            <h3 class="text-sm font-bold text-indigo-400 mb-3">➕ 新增分身</h3>
            <div class="space-y-3">
                <div>
                    <input type="text" id="alt-nickname-input" placeholder="分身暱稱 (例: 小號)" class="dark-input w-full rounded-md text-sm px-3 py-2">
                </div>
                <div>
                    <input type="text" id="alt-code-input" placeholder="好友碼 (12位數字)" maxlength="14" class="dark-input w-full rounded-md text-sm px-3 py-2">
                </div>
                <button id="add-alt-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 rounded-lg text-sm transition">
                    新增至列表
                </button>
            </div>
        </div>
    </div>
</div>

<div id="comment-viewer-modal" class="hidden fixed inset-0 z-[80] flex items-center justify-center p-4 modal-backdrop">
    <div class="modal-content w-full max-w-sm rounded-2xl shadow-xl p-6 bg-gray-800 border border-gray-600 transform transition-all scale-100">
        <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                <span>💬</span> 完整留言
            </h3>
            <button onclick="document.getElementById('comment-viewer-modal').classList.add('hidden')" class="text-gray-400 hover:text-white text-2xl transition">&times;</button>
        </div>
        <div id="comment-viewer-content" class="text-cyan-300 text-base break-words font-medium leading-relaxed bg-gray-900/50 p-4 rounded-lg border border-gray-700"></div>
    </div>
</div>

<style>
    /* 選圖專用樣式 */
    .lib-item { cursor: pointer; border: 2px solid transparent; transition: all 0.2s; position: relative; }
    .lib-item:hover { transform: scale(1.02); }
    .lib-item.selected { border-color: #ec4899; box-shadow: 0 0 10px rgba(236, 72, 153, 0.5); }
    .lib-item.selected::after {
        content: '✔'; position: absolute; top: 5px; right: 5px;
        background: #ec4899; color: white; width: 24px; height: 24px;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-weight: bold; font-size: 14px;
    }
</style>


<script>
    // =========================================================================
    // 1. 初始化配置與全域變數 (Configuration & Globals)
    // =========================================================================
    const SUPABASE_URL = 'https://htdddmoclmhqebyvzean.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_95x4eVN3GHlRFfnJQHaXpg_csrMp2fJ';
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const CDN_HOST = 'https://pikmin-cdn.secretsoulful.workers.dev';

    function getCdnUrl(url) {
        if (!url) return '';
        if (url.includes('htdddmoclmhqebyvzean.supabase.co')) {
            return url.replace('https://htdddmoclmhqebyvzean.supabase.co', CDN_HOST);
        }
        return url;
    }

    // 使用者與資料狀態
    let currentUserProfile = null;
    let challengesData = {};        // 儲存所有挑戰資料 (Key: ID)
    let userSignedUpChallengeIds = new Set(); // 使用者已報名的 ID
    let onlineNicknames = [];       // 在線名單
    // 報名ID 對應 挑戰ID 的快取表
    let signupIdToChallengeMap = {};

    // 控制狀態
    let countdownInterval = null;   // 全域計時器
    let activeFilter = 'all';       // 篩選條件
    let globalCooldownUntil = 0;    // 按鈕冷卻時間戳記
    let globalCooldownTimer = null; // 冷卻倒數計時器
    let challengeToDeleteId = null; // 待刪除 ID

    // 排行榜狀態
    let currentLeaderboardPeriod = 'week'; 
    let currentLeaderboardType = 'host';   

    // 蘑菇樣式設定 (卡片用)
    const mushroomStyles = {
        '巨菇':     { bg: 'bg-cyan-400',     text: 'text-black' },
        '活動菇':   { bg: 'bg-lime-400',     text: 'text-black' },
        '美片菇':   { bg: 'bg-[#ff0080]',    text: 'text-white' },
        '大火':     { bg: 'bg-red-600',      text: 'text-white' },
        '火':       { bg: 'bg-red-600',      text: 'text-white' },
        '大紅':     { bg: 'bg-red-600',      text: 'text-white' },
        '大電':     { bg: 'bg-yellow-400',   text: 'text-black' },
        '電':       { bg: 'bg-yellow-400',   text: 'text-black' },
        '大黃':     { bg: 'bg-yellow-400',   text: 'text-black' },
        '大水':     { bg: 'bg-blue-600',     text: 'text-white' },
        '水':       { bg: 'bg-blue-600',     text: 'text-white' },
        '大藍':     { bg: 'bg-blue-600',     text: 'text-white' },
        '大晶':     { bg: 'bg-sky-300',      text: 'text-black' },
        '晶':       { bg: 'bg-sky-300',      text: 'text-black' },
        '大冰藍':   { bg: 'bg-sky-300',      text: 'text-black' },
        '大毒':     { bg: 'bg-green-700',    text: 'text-white' },
        '毒':       { bg: 'bg-green-700',    text: 'text-white' },
        '大白':     { bg: 'bg-white',        text: 'text-black' },
        '大紫':     { bg: 'bg-purple-600',   text: 'text-white' },
        '大粉':     { bg: 'bg-pink-300',     text: 'text-black' },
        '大灰':     { bg: 'bg-gray-500',     text: 'text-white' },
        '測試':     { bg: 'bg-black',        text: 'text-white' },
    };

    // 許願池專用設定
    const wishStyles = {
        '巨菇':   { class: 'bg-cyan-400 text-black',   icon: '🍄' },
        '活動菇': { class: 'bg-lime-400 text-black',   icon: '🍄' },
        '白':     { class: 'bg-gray-100 text-black',   icon: '⚪' },
        '紅':     { class: 'bg-red-600 text-white',    icon: '🔴' },
        '黃':     { class: 'bg-yellow-400 text-black', icon: '🟡' },
        '藍':     { class: 'bg-blue-600 text-white',   icon: '🔵' }
    };
    const wishOrder = ['巨菇', '活動菇', '白', '紅', '黃', '藍'];

    // ==========================================
    // ▼▼▼ 美片選擇器 (圖書館 + 藝廊整合版) ▼▼▼
    // ==========================================
    
    let currentLibraryTargetInputId = null;
    let currentArtTab = 'library'; // 當前標籤: 'library' | 'gallery'
    
    // 資料快取 (分別儲存，避免重複讀取)
    const artCache = {
        library: null, // 存圖書館資料
        gallery: null  // 存藝廊資料
    };
    
    // 分頁狀態 (分開紀錄頁碼)
    const artPages = {
        library: 1,
        gallery: 1
    };
    
    const libItemsPerPage = 24; // 統一設定為 24 張

    // 開啟視窗
    window.openLibraryModal = function(targetInputId) {
        currentLibraryTargetInputId = targetInputId;
        const modal = document.getElementById('library-modal');
        modal.classList.remove('hidden');
        
        // 預設打開圖書館 (或上次停留的標籤)
        switchArtTab(currentArtTab); 
    };

    window.closeLibraryModal = function() {
        document.getElementById('library-modal').classList.add('hidden');
        document.querySelectorAll('.lib-item').forEach(el => el.classList.remove('selected'));
    };

    // ★ 切換標籤函式
    window.switchArtTab = async function(tabName) {
        currentArtTab = tabName;
        
        // 1. 更新按鈕樣式
        const libBtn = document.getElementById('tab-library');
        const galBtn = document.getElementById('tab-gallery');
        const activeClass = 'bg-pink-600 text-white shadow-sm';
        const inactiveClass = 'text-gray-400 hover:text-gray-200';

        if (tabName === 'library') {
            libBtn.className = `px-6 py-1.5 rounded-md text-sm font-bold transition ${activeClass}`;
            galBtn.className = `px-6 py-1.5 rounded-md text-sm font-bold transition ${inactiveClass}`;
        } else {
            galBtn.className = `px-6 py-1.5 rounded-md text-sm font-bold transition ${activeClass}`;
            libBtn.className = `px-6 py-1.5 rounded-md text-sm font-bold transition ${inactiveClass}`;
        }

        // 2. 檢查快取，若無則抓取
        if (!artCache[tabName]) {
            await fetchArtData(tabName);
        } else {
            renderLibraryGrid();
        }
    };

    // ★ 抓取資料 (根據標籤決定來源)
    async function fetchArtData(tabName) {
        const loadingEl = document.getElementById('lib-loading');
        const grid = document.getElementById('library-grid');
        
        loadingEl.classList.remove('hidden');
        grid.innerHTML = ''; // 清空以顯示載入中

        try {
            let data = [];
            
            if (tabName === 'library') {
                // === A. 讀取圖書館 (postcards 資料表) ===
                const { data: res, error } = await supabaseClient
                    .from('postcards')
                    .select('id, image_url')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                data = res;

            } else {
                // === B. 讀取藝廊 (guest_postcards 資料表 - 透過 RPC) ===
                // 使用既有的 list-guest-postcards 功能
                const { data: res, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: JSON.stringify({ action: 'list-guest-postcards' })
                });
                
                if (error) throw error;
                // 注意：list-guest-postcards 回傳結構可能包含 data.data
                data = res.data || []; 
            }

            // 存入快取
            artCache[tabName] = data;
            artPages[tabName] = 1; // 重置頁碼
            
            renderLibraryGrid();

        } catch (err) {
            console.error(`讀取 ${tabName} 失敗:`, err);
            grid.innerHTML = '<p class="col-span-full text-center text-red-400 py-10">資料讀取失敗，請稍後再試。</p>';
        } finally {
            loadingEl.classList.add('hidden');
        }
    }

    // 渲染網格 (通用)
    function renderLibraryGrid() {
        const grid = document.getElementById('library-grid');
        const pagination = document.getElementById('lib-pagination');
        
        // 取得當前資料與頁碼
        const data = artCache[currentArtTab] || [];
        const page = artPages[currentArtTab];

        if (data.length === 0) {
            grid.innerHTML = '<p class="col-span-full text-center text-gray-500 mt-10">此區尚無美片</p>';
            pagination.classList.add('hidden');
            return;
        }

        pagination.classList.remove('hidden');

        // 1. 計算分頁
        const totalPages = Math.ceil(data.length / libItemsPerPage);
        
        // 防呆校正
        if (artPages[currentArtTab] > totalPages) artPages[currentArtTab] = 1;
        
        // 2. 切割資料
        const start = (artPages[currentArtTab] - 1) * libItemsPerPage;
        const end = start + libItemsPerPage;
        const paginatedItems = data.slice(start, end);

        // 3. 更新 UI 控制項
        document.getElementById('lib-page-input').value = artPages[currentArtTab];
        document.getElementById('lib-total-pages').textContent = `/ ${totalPages}`;
        document.getElementById('lib-prev-btn').disabled = artPages[currentArtTab] === 1;
        document.getElementById('lib-next-btn').disabled = artPages[currentArtTab] === totalPages;

        // 4. 渲染圖片 (使用 getCdnUrl)
        grid.innerHTML = paginatedItems.map(p => `
            <div class="lib-item w-full h-20 md:h-40 rounded-lg overflow-hidden bg-gray-900 group relative border border-gray-700 shadow-sm" onclick="selectLibImage('${p.image_url}', this)">
                <img src="${getCdnUrl(p.image_url)}" loading="lazy" class="w-full h-full object-cover transform transition-transform duration-500 group-hover:scale-110">
                
                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                    <span class="text-white font-bold bg-pink-600 px-3 py-1 rounded-full text-sm select-none shadow-lg transform scale-95 group-hover:scale-100 transition">
                        點擊選擇
                    </span>
                </div>
                
                <div class="selection-indicator absolute top-2 right-2 hidden">
                    <span class="bg-pink-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold shadow-md">✓</span>
                </div>
            </div>
        `).join('');
        
        grid.scrollTop = 0;
    }

    // 翻頁控制
    window.changeLibPage = (delta) => {
        artPages[currentArtTab] += delta;
        renderLibraryGrid();
    };

    window.jumpToLibPage = (val) => {
        const data = artCache[currentArtTab] || [];
        const totalPages = Math.ceil(data.length / libItemsPerPage);
        let target = parseInt(val);
        
        if (isNaN(target) || target < 1) target = 1;
        if (target > totalPages) target = totalPages;
        
        artPages[currentArtTab] = target;
        renderLibraryGrid();
    };

    // 圖片選取邏輯 (維持原本優化版)
    window.selectLibImage = async function(imageUrl, element) {
        document.querySelectorAll('.lib-item').forEach(el => el.classList.remove('selected'));
        if (element) element.classList.add('selected');
        
        showToast('正在下載圖片...', false);

        try {
            const safeUrl = getCdnUrl(imageUrl);
            const response = await fetch(safeUrl);
            if (!response.ok) throw new Error(`下載失敗 (${response.status})`);
            
            const blob = await response.blob();
            
            // 檔名加入來源標記 (lib_ 或 gal_) 以示區別 (選用)
            const prefix = currentArtTab === 'library' ? 'lib' : 'gal';
            const filename = `${prefix}_${Date.now()}_${Math.floor(Math.random()*1000)}.jpg`;
            const file = new File([blob], filename, { type: blob.type });

            const container = new DataTransfer();
            container.items.add(file);
            
            const targetInput = document.getElementById(currentLibraryTargetInputId);
            if (targetInput) {
                targetInput.files = container.files;
                targetInput.classList.add('ring-2', 'ring-pink-500');
                setTimeout(() => targetInput.classList.remove('ring-2', 'ring-pink-500'), 1000);
            }

            showToast('已套用美片！', false);
            setTimeout(closeLibraryModal, 500);

        } catch (err) {
            console.error('圖片轉換失敗:', err);
            showToast('圖片下載失敗，請稍後再試', true);
        }
    };

    // =========================================================================
    // 2. DOM 元素選取 (DOM Elements)
    // =========================================================================
    const userInfoEl = document.getElementById('user-info');
    const logoutButton = document.getElementById('logout-button');
    const changePasswordButton = document.getElementById('change-password-button');
    const hamburgerButton = document.getElementById('hamburger-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const adminLink = document.getElementById('admin-link');
    const onlineUsersContainer = document.getElementById('online-users-container');
    const refreshButton = document.getElementById('refresh-button');
    
    const postChallengeButton = document.getElementById('post-challenge-button');
    const challengesListEl = document.getElementById('challenges-list');
    const filterTabs = document.getElementById('filter-tabs');
    const hostedTab = document.getElementById('hosted-tab');
    const screenshotButton = document.getElementById('screenshot-button');

    // Modals
    const challengeModal = document.getElementById('challenge-modal');
    const challengeForm = document.getElementById('challenge-form');
    const cancelModalButton = document.getElementById('cancel-modal-button');
    const setTimeNowButton = document.getElementById('set-time-now-button');
    const submitChallengeButton = document.getElementById('submit-challenge-button');
    
    const editChallengeModal = document.getElementById('edit-challenge-modal');
    const editChallengeForm = document.getElementById('edit-challenge-form');
    const cancelEditModalButton = document.getElementById('cancel-edit-modal-button');
    const editSetTimeNowButton = document.getElementById('edit-set-time-now-button');

    const deleteConfirmModal = document.getElementById('delete-confirm-modal');
    const cancelDeleteButton = document.getElementById('cancel-delete-button');
    const confirmDeleteButton = document.getElementById('confirm-delete-button');

    const leaderboardButton = document.getElementById('leaderboard-button');
    const leaderboardModal = document.getElementById('leaderboard-modal');
    const leaderboardTabs = document.getElementById('leaderboard-tabs');
    const leaderboardContent = document.getElementById('leaderboard-content');
    const closeLeaderboardButton = document.getElementById('close-leaderboard-button');
    const periodWeekBtn = document.getElementById('period-week-btn');
    const periodMonthBtn = document.getElementById('period-month-btn');

    const passwordModal = document.getElementById('password-modal');
    const passwordForm = document.getElementById('password-form');
    const cancelPasswordButton = document.getElementById('cancel-password-button');
    const submitPasswordButton = document.getElementById('submit-password-button');

    const onlineUsersModal = document.getElementById('online-users-modal');
    const onlineUsersList = document.getElementById('online-users-list');
    const closeOnlineUsersModalButton = document.getElementById('close-online-users-modal');

    const syncTimeModal = document.getElementById('sync-time-modal');
    const syncTimeForm = document.getElementById('sync-time-form');
    const cancelSyncButton = document.getElementById('cancel-sync-button');
    const clearSyncButton = document.getElementById('clear-sync-button');

    const signupSubButton = document.getElementById('signup-sub-button');
    const signupIcon = document.getElementById('signup-email-icon');
    const signupText = document.getElementById('signup-email-text');
    const fullSubButton = document.getElementById('full-sub-button');
    const fullIcon = document.getElementById('full-email-icon');
    const fullText = document.getElementById('full-email-text');

    const toastMessage = document.getElementById('toast-message');

    // 許願池 DOM (使用 const 確保不會被重複宣告)
    const wishingWellBar = document.getElementById('wishing-well-bar');
    const wishActionArea = document.getElementById('wish-action-area');
    const openWishModalBtn = document.getElementById('open-wish-modal-btn');
    const wishedMessage = document.getElementById('wished-message');
    const wishModal = document.getElementById('wish-modal');
    const closeWishModalBtn = document.getElementById('close-wish-modal');
    const submitWishBtn = document.getElementById('submit-wish-btn');
    const wishCheckboxes = document.querySelectorAll('.wish-checkbox');


    // =========================================================================
    // 3. 核心初始化邏輯 (Initialization)
    // =========================================================================

    /** [核心] 頁面載入入口 */
    async function initializePage() {
        // ★ 修改：加入錯誤處理，避免因為更新時間失敗而卡住整個網頁
        try {
            await supabaseClient.rpc('update_last_active');
        } catch (err) {
            console.warn('非致命錯誤：更新最後上線時間失敗', err);
            // 這裡不 return，讓程式繼續往下跑
        }

        // 每日上限設定
        const { data: settings, error: limitError } = await supabaseClient
            .from('daily_settings').select('setting_value').eq('setting_name', 'daily_signup_limit');
        window.dailySignupLimit = (limitError || !settings?.length) ? 3 : settings[0].setting_value;

        // 監聽登入狀態
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT' || !session) {
                if (countdownInterval) clearInterval(countdownInterval);
                window.location.replace('./index.html');
            }
        });

        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) return;

        const { data: profile, error } = await supabaseClient.from('profiles').select('*').eq('id', session.user.id).single();
        if (error || !profile) {
            console.error('Profile Error:', error);
            await supabaseClient.auth.signOut();
            return;
        }

        currentUserProfile = profile;
        
        // 依序啟動各功能
        displayUserInfo();
        initWishingWell();
        await fetchUserSignups();
        await fetchChallenges();
        
        setupRealtimeListeners();
        setupOnlinePresence();
        startGlobalCountdown();
        updateMarquee();
    }

    document.addEventListener('DOMContentLoaded', initializePage);


    // =========================================================================
    // 4. 許願池功能模組 (Wishing Well) - 已整合修復
    // =========================================================================

    /** [許願] 初始化 */
    async function initWishingWell() {
        if (!wishActionArea) return; 
        updateWishButtonState();
        await loadWishStats();
        setupWishListeners(); 
    }

    /** [許願] 載入數據 */
    /** [許願] 初始化 */
    async function initWishingWell() {
        if (!wishActionArea) return; 
        updateWishButtonState();
        await loadWishStats();
        setupWishListeners(); 
    }

    /** [許願] 載入數據 */
    async function loadWishStats() {
        try {
            const { data: stats, error } = await supabaseClient.from('wish_stats').select('*');
            if (error) throw error;
            renderWishingWell(stats || []);
        } catch (err) {
            console.error('載入許願失敗:', err);
            if(wishingWellBar) wishingWellBar.innerHTML = '<div class="w-full text-center text-xs text-red-400">數據載入異常</div>';
        }
    }

    /** [許願] 渲染長條圖 (修正版：放寬顯示標準) */
    function renderWishingWell(stats) {
        if (!wishingWellBar) return;
        
        const totalVotes = stats.reduce((sum, item) => sum + item.count, 0);

        // 若無數據，顯示預設文字
        if (totalVotes === 0) {
            wishingWellBar.innerHTML = '<div class="w-full text-center text-[10px] text-gray-500 leading-none flex items-center justify-center h-full">快來搶頭香！</div>';
            return;
        }

        wishingWellBar.innerHTML = ''; 

        const sortedStats = wishOrder
            .map(type => {
                const found = stats.find(s => s.mushroom_type === type);
                return found ? found : { mushroom_type: type, count: 0 };
            })
            .filter(item => item.count > 0);

        sortedStats.forEach(item => {
            const percentage = (item.count / totalVotes) * 100;
            const styleConfig = wishStyles[item.mushroom_type] || { class: 'bg-gray-500 text-white', icon: '' };
            
            const segment = document.createElement('div');
            
            // 設定外層容器樣式
            segment.className = `h-full relative overflow-hidden transition-all duration-500 ${styleConfig.class} group cursor-help`;
            segment.style.width = `${percentage}%`;
            segment.title = `${item.mushroom_type}: ${item.count}票 (${percentage.toFixed(1)}%)`;

            // 門檻從 12% 降為 6% (讓更多色塊能顯示內容)
            if (percentage > 6) {
                // 移除 'hidden sm:flex' (讓手機版也能顯示)
                // 加入 drop-shadow 讓文字在淺色背景(如白色/黃色)上更清晰
                segment.innerHTML = `
                    <div class="w-full h-full flex items-center justify-center text-[10px] md:text-xs font-bold leading-none whitespace-nowrap px-1 drop-shadow-md">
                        <span class="mr-0.5 md:mr-1 filter drop-shadow-sm">${styleConfig.icon}</span>
                        <span>${item.count}</span>
                    </div>
                `;
            }

            wishingWellBar.appendChild(segment);
        });
    }

    /** [許願] 更新按鈕狀態 (計數 < 3 都顯示) */
    function updateWishButtonState() {
        if (!currentUserProfile) return;
        
        const currentCount = currentUserProfile.daily_wish_count || 0;
        const isFull = currentCount >= 3;

        // 確保重新抓取 DOM 元素，避免參考遺失
        const btn = document.getElementById('open-wish-modal-btn');
        const msg = document.getElementById('wished-message');

        if (isFull) {
            // 額度已滿
            if (btn) btn.classList.add('hidden');
            if (msg) {
                msg.classList.remove('hidden');
                msg.innerHTML = `<span class="text-green-400">✅</span><span class="text-gray-400">明日再來</span>`;
            }
        } else {
            // 還有額度
            if (btn) {
                btn.classList.remove('hidden');
                // 選用：如果您希望按鈕文字直接顯示剩餘票數，可解開下面這行
                // btn.querySelector('span:last-child').textContent = `許願 (${currentCount}/3)`;
            }
            if (msg) msg.classList.add('hidden');
        }
    }

    /** [許願] 設定監聽器 (含動態額度計算) */
    function setupWishListeners() {
        // 重新抓取所有元素
        const wishActionArea = document.getElementById('wish-action-area');
        const wishModal = document.getElementById('wish-modal');
        const closeWishModalBtn = document.getElementById('close-wish-modal');
        const submitWishBtn = document.getElementById('submit-wish-btn');
        const wishCheckboxes = document.querySelectorAll('.wish-checkbox');

        // 左側點擊
        if (wishActionArea) {
            const newArea = wishActionArea.cloneNode(true);
            wishActionArea.parentNode.replaceChild(newArea, wishActionArea);
            newArea.addEventListener('click', (e) => {
                e.preventDefault(); 
                if (!currentUserProfile) { showToast('請先登入', true); return; }
                
                const currentCount = currentUserProfile.daily_wish_count || 0;
                if (currentCount >= 3) {
                    showToast('今日已完成 3 次許願，請明日再來！', false);
                    return;
                }

                // 重置勾選
                if (wishCheckboxes) wishCheckboxes.forEach(cb => cb.checked = false);
                
                // 更新 Modal 標題顯示進度
                const modalTitle = document.querySelector('#wish-modal h3');
                if(modalTitle) modalTitle.textContent = `✨ 許願池 (${currentCount}/3)`;

                if (wishModal) wishModal.classList.remove('hidden');
            });
        }

        // 關閉 Modal
        if (closeWishModalBtn) {
            const newClose = closeWishModalBtn.cloneNode(true);
            closeWishModalBtn.parentNode.replaceChild(newClose, closeWishModalBtn);
            newClose.addEventListener('click', () => { if (wishModal) wishModal.classList.add('hidden'); });
        }
        if (wishModal) {
             wishModal.onclick = (e) => { if (e.target === wishModal) wishModal.classList.add('hidden'); };
        }

        // 複選限制
        if (wishCheckboxes) {
            wishCheckboxes.forEach(cb => {
                cb.onchange = () => {
                    const currentCount = currentUserProfile.daily_wish_count || 0;
                    const remainingQuota = 3 - currentCount;
                    const selectedCount = document.querySelectorAll('.wish-checkbox:checked').length;
                    
                    if (selectedCount > remainingQuota) {
                        cb.checked = false;
                        showToast(`您今日只剩 ${remainingQuota} 票囉！`, true);
                    }
                };
            });
        }

        // 送出
        if (submitWishBtn) {
            const newSubmit = submitWishBtn.cloneNode(true);
            submitWishBtn.parentNode.replaceChild(newSubmit, submitWishBtn);
            newSubmit.addEventListener('click', async () => {
                const selected = Array.from(document.querySelectorAll('.wish-checkbox:checked')).map(cb => cb.value);
                if (selected.length === 0) { showToast('請至少選擇一種！', true); return; }

                newSubmit.disabled = true; newSubmit.textContent = '許願中...';
                try {
                    const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                        body: { action: 'submit-wish', payload: { userId: currentUserProfile.id, types: selected } }
                    });
                    if (error) throw error;
                    if (data?.error) throw new Error(data.error);

                    const count = selected.length;
                    showToast(`✨ 成功投下 ${count} 票！`, false);
                    if (wishModal) wishModal.classList.add('hidden');
                    
                    // 立即更新本地狀態並刷新 UI
                    currentUserProfile.daily_wish_count = (currentUserProfile.daily_wish_count || 0) + count;
                    updateWishButtonState(); // 這裡會立即觸發「明日再來」的切換
                    
                    await loadWishStats();
                } catch (err) {
                    console.error(err);
                    showToast(`許願失敗: ${err.message}`, true);
                } finally {
                    newSubmit.disabled = false; newSubmit.textContent = '送出許願';
                }
            });
        }
    }


    // =========================================================================
    // 5. 使用者介面與權限 (UI & Profile)
    // =========================================================================

    function displayUserInfo() {
    if (!currentUserProfile) return;

    // 1. 處理顯示名稱 (保留既有名稱清洗邏輯)
    const displayName = (currentUserProfile.nickname || '').split(/[^a-zA-Z0-9\u4e00-\u9fa5\s!?.~_+\-]/)[0];

    // =================
    // 顯示個人缺席愛睏值
    // =================
    const absScore = currentUserProfile.absent_score || 0;
    let absDisplay = '';

    if (absScore > 0) {
        // 如果有分數，顯示紅色警示字樣，並加上左邊距
        absDisplay = `<span class="text-red-400 font-bold ml-2" title="目前累積的缺席指數">💤+${absScore}</span>`;
    }
    // =========================================================

    // 2. 更新畫面 (改用 innerHTML 以支援 span 顏色標籤)
    userInfoEl.innerHTML = `你好，${displayName}！${absDisplay}`;

    updateQuotaDisplay();

    // 3. 權限顯示判斷 (使用你提供的正常運作版本)
    // 判斷發菇按鈕與分頁
    if (['管理者', '發菇者', '發菇及報名者'].includes(currentUserProfile.role)) {
        if (postChallengeButton) postChallengeButton.classList.remove('hidden');
        if (hostedTab) hostedTab.classList.remove('hidden');
    }

    // 判斷管理後台連結 (移除白名單檢查，改回單純檢查角色)
    if (currentUserProfile.role === '管理者') {
        const adminLink = document.getElementById('admin-link');
        if (adminLink) adminLink.classList.remove('hidden');
        
        const mobAdmin = document.getElementById('admin-link-mobile');
        if (mobAdmin) mobAdmin.classList.remove('hidden');
    }
        checkSubscriptionStatus();
    }

    function updateQuotaDisplay() {
        const quotaEl = document.getElementById('daily-quota-display');
        if (!currentUserProfile || !quotaEl) return;
        const count = currentUserProfile.daily_signup_count || 0;
        quotaEl.textContent = `本日額度: ${count} / ${window.dailySignupLimit}`;
    }

    async function refreshUserProfile() {
        const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', currentUserProfile.id).single();
        if (!error) currentUserProfile = data;
    }

    // 登出按鈕邏輯優化
    logoutButton.addEventListener('click', async () => {
        logoutButton.disabled = true; 
        logoutButton.textContent = '登出中...';
        
        try { 
            await supabaseClient.auth.signOut(); 
        } catch(e) { 
            console.warn(e); 
        }
        
        // 清除本地暫存
        localStorage.removeItem('sb-' + SUPABASE_ANON_KEY + '-auth-token');
        
        // 使用 replace 來跳轉，通常比 reload 更乾淨，且不會產生 unload 警告
        window.location.replace('./index.html');
    });

    // 修改密碼
    changePasswordButton.addEventListener('click', () => { passwordForm.reset(); passwordModal.classList.remove('hidden'); });
    cancelPasswordButton.addEventListener('click', () => passwordModal.classList.add('hidden'));
    passwordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newPw = document.getElementById('new-password').value;
        const confirmPw = document.getElementById('confirm-password').value;
        if (newPw.length < 6) { showToast('密碼長度需大於6位', true); return; }
        if (newPw !== confirmPw) { showToast('兩次密碼不一致', true); return; }
        
        submitPasswordButton.disabled = true;
        const { error } = await supabaseClient.auth.updateUser({ password: newPw });
        if (error) showToast(`失敗: ${error.message}`, true);
        else { showToast('修改成功', false); passwordModal.classList.add('hidden'); }
        submitPasswordButton.disabled = false;
    });


    // =========================================================================
    // 6. 挑戰資料處理 (Data Fetching & Rendering)
    // =========================================================================

    async function fetchUserSignups() {
        const { data, error } = await supabaseClient.from('signups').select('challenge_id').eq('user_id', currentUserProfile.id);
        if (!error) userSignedUpChallengeIds = new Set(data.map(s => s.challenge_id));
    }

    async function fetchChallenges() {
        const { data: challenges, error } = await supabaseClient
            .from('challenges')
            // 在 signups 的 profile 關聯中，加入 daily_signup_count
            .select(`*, host:profiles(nickname, id), signups(*, profile:profiles(nickname, absent_score, daily_signup_count))`)
            .order('start_time', { ascending: false });

        if (error) { challengesListEl.innerHTML = '<p class="text-center col-span-full text-red-400">無法載入挑戰。</p>'; return; }

        challengesData = {};
        challenges.forEach(c => { challengesData[c.id] = c; });
        document.getElementById('loading-indicator')?.remove();
        
        refreshAllChallengeCards();
    }

    function refreshAllChallengeCards() {
        if (!challengesData) return;
        challengesListEl.innerHTML = '';
        
        // 將資料轉為陣列以便排序
        const challengesArray = Object.values(challengesData);

        // ★★★ 排序邏輯修改 ★★★
        // 規則：
        // 1. 「開放報名中」置頂
        // 2. 其餘狀態排在後面
        // 3. 同一狀態內，依照 ID 由大到小 (新到舊) 排序
        challengesArray.sort((a, b) => {
            // 判斷是否為開放報名中
            const aIsOpen = a.status === '報名中';
            const bIsOpen = b.status === '報名中';

            // 如果 a 是開放中，b 不是 -> a 排前面 (-1)
            if (aIsOpen && !bIsOpen) return -1;
            
            // 如果 b 是開放中，a 不是 -> b 排前面 (1)
            if (!aIsOpen && bIsOpen) return 1;

            // 如果狀態權重相同 (都是開放 或 都不是)，則比較 ID (新到舊)
            return b.id - a.id;
        });

        // 依照排序後的順序渲染
        challengesArray.forEach(challenge => renderChallenge(challenge));
        
        applyFilter();
        // 更新紅點
        updateFilterBadges();
    }

        // 計算當前使用者正在排幾個備取
    function calculateUserWaitlistCount() {
        let count = 0;
        if (!currentUserProfile || !userSignedUpChallengeIds) return 0;

        userSignedUpChallengeIds.forEach(signedCid => {
            const c = challengesData[signedCid];
            if (c && c.signups) {
                // 找到我的報名資料
                const mySignup = c.signups.find(s => s.user_id === currentUserProfile.id);
                if (mySignup) {
                    // 計算我的排名 (過濾掉比我晚報名的)
                    // 注意：這裡假設 signups 已經是排序過的，或者是用時間比對
                    const myTime = new Date(mySignup.signed_up_at).getTime();
                    // 排名 = 比我早或同時報名的人數
                    const rank = c.signups.filter(s => new Date(s.signed_up_at).getTime() <= myTime).length;
                    
                    if (rank > c.slots) {
                        count++;
                    }
                }
            }
        });
        return count;
    }

    // 核心渲染邏輯 (含分身顯示功能優化版)
    /** [核心] 渲染單張挑戰卡片 (修復版：統一變數名稱 + 時段轉換) */
    function renderChallenge(challenge) {
        if (!challenge) return;
        challengesData[challenge.id] = challenge; // 更新快取

        // --- 1. 時段顯示轉換 ---
        const detailsMap = {
            '宵夜': '宵夜 (21:00~01:00)',
            '早餐': '早餐 (06:00~11:00)',
            '午餐': '午餐 (11:00~15:00)',
            '下午茶': '下午茶 (15:00~17:00)',
            '晚餐': '晚餐 (17:00~21:00)',
            '滿人開': '滿人開 (人滿後發)'
        };
        const displayDetails = detailsMap[challenge.details] || challenge.details || '未指定';

        // --- 2. 基本變數設定 ---
        const dailyLimitReached = currentUserProfile && currentUserProfile.daily_signup_count >= window.dailySignupLimit;
        
        // 預先計算排名與身分 (為了判斷下方按鈕權限)
        let amIWaitlist = false;
        let amICheckedIn = false;
        
        if (challenge.signups && challenge.signups.length > 0) {
            // 必須先依照報名時間排序，才能算出正確排名
            const sortedForRank = [...challenge.signups].sort((a, b) => new Date(a.signed_up_at) - new Date(b.signed_up_at));
            const myIndex = sortedForRank.findIndex(s => s.user_id === currentUserProfile.id);
            
            if (myIndex !== -1) {
                // 如果排名數值 (Index+1) 大於 名額 (slots)，就是備取
                amIWaitlist = (myIndex + 1) > challenge.slots;
                // 順便取得是否已入 (供後續鎖定判斷)
                amICheckedIn = sortedForRank[myIndex].is_checked_in === true;
            }
        }

        const card = document.createElement('div');
        card.className = 'challenge-card bg-gray-800 rounded-xl shadow-md overflow-hidden p-6 flex flex-col justify-between';
        card.id = `challenge-${challenge.id}`;
        
        const statusClass = challenge.status === '開放報名中' ? 'status-open' : (challenge.status === '已額滿' ? 'status-full' : 'status-pending');
        card.dataset.status = challenge.status;

        const type = challenge.mushroom_type;
        const style = mushroomStyles[type] || { bg: 'bg-transparent', text: 'text-gray-100' };
        const titleClasses = `text-xl font-bold px-3 py-1 rounded-md ${style.bg} ${style.text} whitespace-nowrap`;

        const isHost = challenge.host && challenge.host.id === currentUserProfile.id;
        const isAdmin = currentUserProfile && currentUserProfile.role === '管理者';
        const isSignedUp = userSignedUpChallengeIds.has(challenge.id);
        const signupCount = challenge.signups ? challenge.signups.length : 0;
        const dispatchStatus = challenge.dispatch_status || '待發';

        // 設定 Dataset (供過濾器使用)
        if (isHost) card.dataset.isHosted = 'true';
        if (isSignedUp) card.dataset.isSignedUp = 'true';
        if (challenge.is_guest) card.dataset.isGuest = 'true';

        // --- 3. 發菇者顯示邏輯 ---
        let guestTagHtml = '';
        if (challenge.is_guest) {
            guestTagHtml = `<span class="bg-pink-800 text-white text-[10px] px-2 py-0.5 rounded mr-2 border border-pink-500">訪客</span>`;
        }

        const realHostNickname = challenge.host ? challenge.host.nickname : (challenge.display_host_name || '未知訪客');
        const displayString = challenge.is_guest ? challenge.display_host_name : (challenge.display_host_name || realHostNickname);

        // 發菇者好友碼複製
        const hasCode = /\d{12}/.test(displayString);
        const hostNameClass = hasCode 
            ? "text-indigo-300 font-bold cursor-pointer hover:text-white hover:underline transition select-none" 
            : "text-indigo-300 font-bold";
        const hostClickEvent = hasCode 
            ? `onclick="copyHostFriendCode('${displayString}')" title="點擊複製好友碼"` 
            : "";

        // 主帳號後綴顯示 (僅當分身名稱與主帳號不同時才顯示)
        let mainAccountSuffix = '';
        if (challenge.host && challenge.host.nickname) {
            // 1. 取得主帳號純名稱 (去除符號後)
            const rawMainName = challenge.host.nickname.split(/[✈️💪]/)[0].trim();
            
            // 2. 取得目前卡片顯示的名稱 (去除符號後)
            // displayString 是上面計算出來的變數
            const currentName = displayString.split(/[✈️💪]/)[0].trim();

            // 3. 比對：只有當兩者「不相同」時，才顯示主帳號提示
            if (rawMainName && rawMainName !== currentName) {
                mainAccountSuffix = ` <span class="text-gray-500 text-xs font-normal ml-1">(${rawMainName})</span>`;
            }
        }

        // --- 4. 備註顯示 ---
        let notesHtml = '';
        if (challenge.notes && challenge.notes.trim() !== '') {
            notesHtml = `
                <div class="mt-2 text-sm text-yellow-200/90 italic border-l-2 border-yellow-500/50 pl-2 break-words">
                    📝 ${challenge.notes}
                </div>
            `;
        }

        // --- 5. 操作按鈕邏輯 ---
        let actionButtonHtml;
        if (isHost) {
            if (signupCount > 0) {
                const btnBgClass = dispatchStatus === '已發' ? 'bg-teal-600 hover:bg-teal-700' : 'bg-gray-700 hover:bg-gray-600';
                actionButtonHtml = `<button class="w-full ${btnBgClass} text-white font-bold py-2 px-4 rounded-lg transition cursor-pointer dispatch-status-tag" data-id="${challenge.id}" data-current-status="${dispatchStatus}">更新發菇狀態</button>`;
            } else {
                actionButtonHtml = `<button class="w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg cursor-default">您是發菇者</button>`;
            }
        } else if (isSignedUp) {
            // 操作按鈕邏輯 (已入鎖定 > 備取豁免 > 已發鎖定)
            
            if (amICheckedIn) {
                // 狀況 A: 被點名已入 -> 顯示「已上車」並鎖定 (優先權最高)
                actionButtonHtml = `<button class="w-full bg-green-700 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed border border-green-500 shadow-inner" disabled>🚗 已上車</button>`;
            } else if (dispatchStatus === '已發') {
                // 狀況 B: 已發車
                if (amIWaitlist) {
                    // 如果是「備取」，即使已發車，也允許取消 (因為正取滿了，備取沒望了)
                    actionButtonHtml = `<button class="cancel-signup-button w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition" data-challenge-id="${challenge.id}">取消報名 (備取)</button>`;
                } else {
                    // 如果是「正取」，已發車則鎖定 (因為可能正在打怪中)
                    actionButtonHtml = `<button class="w-full bg-gray-600 text-gray-300 font-bold py-2 px-4 rounded-lg cursor-not-allowed border border-gray-500" disabled>🚗 已發車 (請聯繫機長)</button>`;
                }
            } else {
                // 狀況 C: 未發車且未被點名 -> 允許取消
                actionButtonHtml = `<button class="cancel-signup-button w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition" data-challenge-id="${challenge.id}">取消報名</button>`;
            }
        } else if (challenge.status === '預計開放') {
            actionButtonHtml = `<button class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed" disabled>尚未開放</button>`;
        } 
        // 只有當「人數 >= 名額 + 2」時，才真正顯示已額滿並鎖定
        else if (challenge.status === '已額滿' && signupCount >= (challenge.slots + 2)) {
            actionButtonHtml = `<button class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed" disabled>已額滿</button>`;
        } else {
            // 判斷目前是否屬於備取階段 (人數已達標，但未滿 +2)
            const isWaitlist = signupCount >= challenge.slots;

            // 1. 正取檢查：如果「不是」備取，且「每日額度已滿」，則鎖定 (訪客菇除外)
            if (!isWaitlist && dailyLimitReached && !challenge.is_guest) { 
                actionButtonHtml = `<button class="w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed" disabled>報名額度已滿</button>`;
            } 
            // 2. 備取檢查：如果「是」備取，且「手上已有3個備取」，則鎖定 (不扣每日額度)
            else if (isWaitlist && calculateUserWaitlistCount() >= 3) {
                actionButtonHtml = `<button class="w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed" disabled>備取數量已達上限(3)</button>`;
            }
            else {
                if (currentUserProfile.role === '發菇者') {
                    actionButtonHtml = `<button class="w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg cursor-default" disabled>僅發布權限</button>`;
                } else {
                    const cooldownLeft = Math.ceil((globalCooldownUntil - Date.now()) / 1000);
                    if (cooldownLeft > 0) {
                        actionButtonHtml = `<button class="signup-button w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed btn-cooldown" disabled>冷卻中 ${cooldownLeft}s</button>`;
                    } else {
                        // 根據是否為備取，顯示不同按鈕樣式
                        if (isWaitlist) {
                            const waitRank = signupCount - challenge.slots + 1;
                            // 備取按鈕 (橘色)
                            actionButtonHtml = `<button class="signup-button w-full bg-orange-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-700 transition" data-challenge-id="${challenge.id}">報名備取 (備${waitRank})</button>`;
                        } else {
                            // 正取按鈕 (藍色)
                            actionButtonHtml = `<button class="signup-button w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition" data-challenge-id="${challenge.id}">報名</button>`;
                        }
                    }
                }
            }
        }

        const canControl = isHost || isAdmin;

        const hostControlsHtml = canControl ? `
            <button data-id="${challenge.id}" class="edit-challenge-button text-gray-500 hover:text-yellow-400 transition" title="編輯">✏️</button>
            <button data-id="${challenge.id}" class="delete-challenge-button text-gray-500 hover:text-red-500 transition" title="刪除">🗑️</button>
        ` : '';

        // --- 6. 參加者名單 (統一使用 rawNickname) ---
        let participantsHtml = '';
        if (signupCount > 0) {
            const sortedSignups = [...challenge.signups].sort((a, b) => new Date(a.signed_up_at) - new Date(b.signed_up_at));
            sortedSignups.forEach(s => { signupIdToChallengeMap[s.id] = challenge.id; });
            const isCurrentUserHost = (challenge.host && challenge.host.id === currentUserProfile.id);

            const list = sortedSignups.map((signup, index) => {
                // 備取分隔線邏輯
                let separatorHtml = '';
                if (index === challenge.slots) {
                    separatorHtml = `
                        <div class="flex items-center my-2 select-none">
                            <div class="flex-grow border-t border-dashed border-orange-500/50"></div>
                            <span class="mx-2 text-[10px] text-orange-400 font-bold bg-orange-900/30 px-2 rounded-full">備取區</span>
                            <div class="flex-grow border-t border-dashed border-orange-500/50"></div>
                        </div>
                    `;
                }

                // 排名顯示邏輯
                let rankText;
                if (index >= challenge.slots) {
                    const waitRank = index - challenge.slots + 1;
                    rankText = `<span class="text-orange-400">備${waitRank}</span>`;
                } else {
                    rankText = `${index + 1}${getRankSuffix(index + 1)}`;
                }
                
                // 1. 處理暱稱
                let rawNickname = signup.profile ? signup.profile.nickname : (signup.guest_name || '未知');
                const dailyCount = signup.profile?.daily_signup_count;
                const dailyCountHtml = (dailyCount !== undefined && dailyCount !== null) 
                    ? `<span class="text-xs text-gray-400 font-normal select-none" title="今日已報名 ${dailyCount} 次">(${dailyCount})</span>` 
                    : '';

                const cleanName = rawNickname.replace(/[\s\uFEFF\xA0]*\d{12}[\s\uFEFF\xA0]*$/, '').trim();
                const codeMatch = rawNickname.match(/(\d{12})/);
                
                let displayNameDisplay = ''; 
                if (codeMatch) {
                    const code = codeMatch[1];
                    displayNameDisplay = `<span class="cursor-pointer hover:text-white hover:underline transition select-none" onclick="copyHostFriendCode('${rawNickname}')" title="點擊複製好友碼: ${code}">${cleanName}</span>`;
                } else {
                    displayNameDisplay = cleanName;
                }
                
                // 2. 處理愛睏值
                const absScore = signup.profile?.absent_score || 0;
                let statusIcon = absScore > 0 ? `<span class="text-xs text-red-400 border border-red-500/50 rounded px-1 ml-1 flex-shrink-0 cursor-help" title="累積缺席點數">💤+${absScore}</span>` : '';

                // 1. 處理「已入」靜態標記 (預設邏輯)
                // 邏輯：如果是發菇者，我們用按鈕來顯示狀態，所以不顯示靜態標籤，避免重複雜亂
                let checkedInIcon = '';
                const showStaticIcon = signup.is_checked_in && !isCurrentUserHost; 

                if (showStaticIcon) {
                    checkedInIcon = `<span class="text-[10px] bg-green-600/20 text-green-400 border border-green-500/50 rounded px-1.5 py-0.5 ml-1 font-bold flex-shrink-0 select-none cursor-default" title="發菇者確認已入場">✅已入</span>`;
                }

                // 3. 處理留言按鈕
                const commentVal = signup.comment || '';
                const isMe = signup.user_id === currentUserProfile.id;
                let commentBlock = '';
                if (isMe) {
                    const hasComment = commentVal && commentVal.trim() !== '';
                    const bgClass = 'bg-gray-700 hover:bg-gray-600';
                    const textClass = hasComment ? 'text-cyan-300' : 'text-gray-400 hover:text-white';
                    const borderClass = hasComment ? 'border-gray-500' : 'border-gray-500 border-dashed';
                    const icon = hasComment ? '📝' : '✏️';
                    const title = hasComment ? '編輯留言' : '新增留言';
                    commentBlock = `<button onclick="window.editUserSignupComment(${challenge.id}, '${commentVal.replace(/'/g, "\\'")}', event)" class="ml-1 relative z-10 text-xs border ${borderClass} ${bgClass} ${textClass} px-1.5 py-0.5 rounded transition flex items-center justify-center h-5 min-w-[24px] flex-shrink-0" title="${title}">${icon}</button>`;
                } else {
                    if (commentVal) {
                        const safeComment = commentVal.replace(/'/g, "\\'");
                        commentBlock = `<button onclick="window.openDashboardComment('${safeComment}', event)" class="ml-1 relative z-10 text-xs text-cyan-300 bg-gray-700 px-1.5 py-0.5 rounded cursor-pointer border border-gray-600 hover:bg-gray-600 hover:border-cyan-400 transition select-none shadow-sm flex items-center justify-center h-5 min-w-[24px] flex-shrink-0" title="查看完整留言">📝</button>`;
                    }
                }

                // 4. 處理操作按鈕 (整合 已入/缺席 邏輯)
                let actionBtn = '';
                if (isCurrentUserHost) {
                    const baseBtnStyle = "mr-1 md:mr-2 text-[10px] px-1 md:px-2 py-0.5 rounded transition whitespace-nowrap border";
                    
                    // A. 點名按鈕 (整合狀態顯示)
                    // 狀態：已入 (亮綠色，帶勾勾) vs 未入 (灰色框，無勾勾)
                    const checkInBtnText = signup.is_checked_in ? '✅已入' : '已入';
                    const checkInBtnStyle = signup.is_checked_in 
                        ? "bg-green-600 text-white border-green-500 hover:bg-green-700 shadow-md font-bold" // 已入樣式
                        : "bg-transparent text-gray-400 border-gray-600 hover:bg-gray-700 hover:text-white"; // 未入樣式

                    const checkInBtn = `<button onclick="window.toggleSignupCheckedIn(${challenge.id}, ${signup.id}, '${cleanName}', event)" 
                        class="${baseBtnStyle} ${checkInBtnStyle}" 
                        title="切換已入狀態">${checkInBtnText}</button>`;

                    // B. 缺席按鈕 (邏輯：如果已入，則不顯示缺席按鈕)
                    let absentBtn = '';
                    if (!signup.is_checked_in) {
                        const hasReported = challenge.absent_records && challenge.absent_records.some(r => r.reporter_id === currentUserProfile.id && r.absentee_id === signup.user_id);
                        
                        if (hasReported) {
                            absentBtn = `<button onclick="revokeAbsent(${challenge.id}, '${signup.user_id}', '${cleanName}')" 
                                class="${baseBtnStyle} bg-gray-700 text-gray-400 border-gray-600 hover:bg-gray-600 hover:text-white" 
                                title="撤銷缺席標記">撤銷</button>`;
                        } else {
                            absentBtn = `<button onclick="reportAbsent(${challenge.id}, '${signup.user_id}', '${cleanName}')" 
                                class="${baseBtnStyle} bg-transparent text-red-400 border-red-900/30 hover:bg-gray-700 hover:text-red-300" 
                                title="回報缺席">缺席</button>`;
                        }
                    }
                    
                    // 組合按鈕
                    actionBtn = checkInBtn + absentBtn;
                }

                const time = formatSignupTime(signup.signed_up_at);
                
                // 5. 組合 HTML (調整排版)
                return `
                    ${separatorHtml}
                    <div class="participant-item group py-1 flex justify-between items-center">
                        <div class="flex items-center flex-1 min-w-0 pr-1 overflow-hidden">
                            <span class="participant-rank w-8 flex-shrink-0 text-center mr-1">${rankText}</span>

                            <span class="text-gray-200 truncate font-bold min-w-[30px]" title="${cleanName}">
                                ${displayNameDisplay}${dailyCountHtml}
                            </span>
                            
                            ${statusIcon}
                            ${commentBlock}
                            </div>

                        <div class="flex items-center flex-shrink-0 ml-2">
                            ${actionBtn}
                            ${checkedInIcon}
                            <span class="text-[10px] md:text-xs tracking-tighter md:tracking-normal text-gray-500 font-mono w-14 md:w-20 text-right whitespace-nowrap">${time}</span>
                        </div>
                    </div>`;
            }).join('');
            participantsHtml = `<div class="participant-list">${list}</div>`;
        }

        // --- 7. 時間、圖片、倒數計時 ---
        let startTimeHtml;
        if (challenge.status === '預計開放' && new Date(challenge.start_time) > new Date()) { 
            startTimeHtml = `<p><strong>等待時間:</strong> <span class="countdown-timer" data-starttime="${challenge.start_time}">計算中...</span></p>`;
        } else {
            startTimeHtml = `<p><strong>開放時間:</strong> ${new Date(challenge.start_time).toLocaleString('zh-TW', { hour12: false })}</p>`;
        }
        let imageBtnHtml = (challenge.image_url && challenge.image_url.startsWith('http')) 
            ? `<div class="mt-2"><button onclick="openImageViewer('${challenge.image_url}')" class="text-xs bg-gray-700 text-indigo-300 px-3 py-1.5 rounded hover:bg-gray-600 border border-gray-600 flex items-center gap-2 transition">📷 查看明信片</button></div>` : '';

        // 發送標籤
        let dispatchTagHtml = '';
        if (signupCount > 0 && challenge.is_guest !== true) {
            const dispatchClass = dispatchStatus === '已發' ? 'dispatch-sent' : 'dispatch-pending';
            const isClickable = isHost ? 'cursor-pointer' : '';
            dispatchTagHtml = `<span class="status-badge ${dispatchClass} ${isClickable} dispatch-status-tag" data-id="${challenge.id}" data-current-status="${dispatchStatus}">${dispatchStatus}</span>`;
        }

        // 火侯
        let cookingStyleClass = 'text-gray-400 border-gray-500/30';
        const cStyle = challenge.cooking_style || '';
        if (cStyle.includes('大火快炒')) cookingStyleClass = 'text-red-500 border-red-500/30';
        else if (cStyle.includes('細火慢燉')) cookingStyleClass = 'text-orange-400 border-orange-400/30';
        else if (cStyle.includes('隨便亂炒')) cookingStyleClass = 'text-yellow-400 border-yellow-400/30';

        // 倒數計時
        let countdownDisplayHtml = '<span class="text-gray-500">倒數:--</span>';
        let dataEndTime = challenge.countdown_end_time || '';
        let harvestHtmlBlock = `<div class="harvest-timer text-white font-bold mt-1" data-endtime="${dataEndTime}"></div>`;
        if (dataEndTime) countdownDisplayHtml = '計算中...';
        const battleTimerHtml = `<span class="battle-timer text-white font-bold" data-endtime="${dataEndTime}">${countdownDisplayHtml}</span><button class="open-sync-modal-button text-xs bg-gray-700 text-gray-300 px-2 py-0.5 rounded ml-2 hover:bg-gray-600 border border-gray-600 transition" data-id="${challenge.id}" title="校正時間">校時</button>`;

        // 名額顯示格式化邏輯 (解決 6/4 問題)
        let slotsDisplayHtml = '';
        if (signupCount > challenge.slots) {
            // 進入備取階段
            const waitCount = signupCount - challenge.slots;
            // 顯示格式：名額 4/4 <span橘色>備取 1/2</span>
            slotsDisplayHtml = `${challenge.slots} / ${challenge.slots} <span class="font-bold ml-2">備取 ${waitCount} / 2</span>`;
        } else {
            // 一般階段：保留原本的 ID 供後續可能的邏輯使用
            slotsDisplayHtml = `<span id="signup-count-${challenge.id}">${signupCount}</span> / ${challenge.slots}`;
        }

        // --- 8. 組裝 HTML ---
        card.innerHTML = `
            <div>
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-2">
                        ${guestTagHtml}
                        <h3 class="${titleClasses}">${challenge.mushroom_type}</h3>
                        <span class="text-sm font-bold text-gray-500">#${challenge.id}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        ${dispatchTagHtml}
                        <span class="status-badge ${statusClass}">${challenge.status === '開放報名中' ? '報名中' : challenge.status}</span>
                        ${hostControlsHtml}
                    </div>
                </div>
                <div class="flex flex-col mb-3 pl-1">
                    <div class="flex items-center">${battleTimerHtml}</div>
                    ${harvestHtmlBlock}
                </div>
                <div class="text-gray-400 space-y-2 mb-4">
                    <p><strong>發菇者:</strong> <span class="${hostNameClass}" ${hostClickEvent}>${displayString}</span>${mainAccountSuffix}</p>

                    <p><strong>呼叫時段: 📣</strong> ${displayDetails}</p>
                    
                    <p><strong>名額:</strong> ${slotsDisplayHtml}</p>
                    ${startTimeHtml}
                    <div class="flex items-center mt-1"><strong class="mr-2">火侯:</strong><span class="${cookingStyleClass} border px-2 py-0.5 rounded text-sm font-bold">🔥 ${cStyle || '未指定'}</span></div>
                    ${notesHtml}
                    ${imageBtnHtml}
                </div>
                ${participantsHtml}
            </div>
            <div class="mt-4">${actionButtonHtml}</div>
        `;

        const existingCard = document.getElementById(card.id);
        if(existingCard) challengesListEl.replaceChild(card, existingCard);
        else challengesListEl.prepend(card);
    }

    async function reloadChallengeCard(challengeId) {
        const { data: challenge, error } = await supabaseClient.from('challenges')
            // 同樣加入 daily_signup_count
            .select(`*, host:profiles(nickname, id), signups(*, profile:profiles(nickname, absent_score, daily_signup_count)), absent_records(reporter_id, absentee_id)`)
            .eq('id', challengeId).single();
        
        if (error) {
            if (error.code === 'PGRST116') {
                const el = document.getElementById(`challenge-${challengeId}`);
                if(el) el.remove();
            } else console.error('重載失敗:', error);
            return;
        }
        renderChallenge(challenge);
        applyFilter();
        updateFilterBadges();
    }

    // =========================================================================
    // 7. 互動操作 (Interactions: Post, Edit, Delete, Signup)
    // =========================================================================

    /** [發布] 開啟發布視窗 */
    // 這裡加上了 async
    postChallengeButton.addEventListener('click', async () => {
        // 1. 重置表單與預設值 (保留既有功能)
        challengeForm.reset();
        challengeForm['mushroom-type'].value = '巨菇';
        challengeForm['slots'].value = 4;
        
        const remTime = localStorage.getItem('rememberedChallengeTime');
        const remDetails = localStorage.getItem('rememberedChallengeDetails');
        const remStyle = localStorage.getItem('rememberedCookingStyle');
        const remIdentity = localStorage.getItem('rememberedIdentity');
        const remNotes = localStorage.getItem('rememberedNotes');

        const now = new Date();
        // 使用 toLocalISOString 取得正確的本地日期字串，避免 UTC 落差
        const datePart = toLocalISOString(now).split('T')[0];

        if (remTime) {
            // 如果有記住時間 (只記住 HH:mm)，日期用今天，時間用記憶的
            challengeForm['start-time'].value = `${datePart}T${remTime}`;
            
            if(remDetails) challengeForm['details'].value = remDetails;
            if(remStyle) document.getElementById('cooking-style').value = remStyle;
            if(remNotes) document.getElementById('challenge-notes').value = remNotes;
            document.getElementById('remember-time-checkbox').checked = true;
        } else {
            // 使用新的工具函式，精準帶入現在時間
            challengeForm['start-time'].value = toLocalISOString(now);
            
            document.getElementById('remember-time-checkbox').checked = false;
            document.getElementById('challenge-notes').value = '';
        }
        document.getElementById('challenge-image').value = '';

        // 載入身分選單邏輯
        const identitySelect = document.getElementById('post-identity');
        
        // A. 先重置為「主帳號」
        if (currentUserProfile) {
            identitySelect.innerHTML = `<option value="main">${currentUserProfile.nickname} (主帳號)</option>`;
        }

        // B. 確保分身列表已從資料庫載入 (若 myAlts 為空，則即時抓取一次)
        // 因為這裡用了 await，所以外層必須是 async function
        if (typeof myAlts === 'undefined' || myAlts.length === 0) {
            try {
                const { data } = await supabaseClient.from('user_alts').select('*');
                if (data) myAlts = data;
            } catch (e) {
                console.error('分身載入失敗', e);
            }
        }

        // C. 將分身加入選單
        if (myAlts && myAlts.length > 0) {
            myAlts.forEach(alt => {
                const option = document.createElement('option');
                option.value = alt.full_display; // 值直接存 "暱稱✈️好友碼"
                option.textContent = `🎭 ${alt.full_display}`;
                identitySelect.appendChild(option);
            });
        }
        
        if (remTime && remIdentity) {
            // 檢查該身分是否還在清單內 (避免分身被刪除後報錯)
            const optionExists = Array.from(identitySelect.options).some(opt => opt.value === remIdentity);
            if(optionExists) identitySelect.value = remIdentity;
        }

        // 3. 顯示 Modal
        challengeModal.classList.remove('hidden');
    });

    // 編輯視窗的取消按鈕邏輯
    // ---------------------------------------------------------
    const cancelEditBtn = document.getElementById('cancel-edit-modal-button');
    if (cancelEditBtn) {
        cancelEditBtn.addEventListener('click', () => {
            // 隱藏編輯視窗
            document.getElementById('edit-challenge-modal').classList.add('hidden');
            // 建議：重置表單，避免下次打開殘留資料 (選用)
            document.getElementById('edit-challenge-form').reset(); 
        });
    }

    //  關閉發布視窗
    cancelModalButton.addEventListener('click', () => challengeModal.classList.add('hidden'));
    setTimeNowButton.addEventListener('click', () => {
        // 直接使用工具函式
        challengeForm['start-time'].value = toLocalISOString(new Date());
    });

    // 編輯視窗的立即開放按鈕
    if (editSetTimeNowButton) {
        editSetTimeNowButton.addEventListener('click', () => {
            // 使用工具函式取得當前時間，並填入編輯視窗的時間欄位
            document.getElementById('edit-start-time').value = toLocalISOString(new Date());
        });
    }

    // 【發布】表單送出
    challengeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitChallengeButton.disabled = true; 
        submitChallengeButton.textContent = '發布中...';
        
        const form = e.target;
        const timeVal = form['start-time'].value;
        const styleVal = document.getElementById('cooking-style').value;

        // 1. 記憶時間設定
        if (document.getElementById('remember-time-checkbox').checked) {
            localStorage.setItem('rememberedChallengeTime', timeVal.split('T')[1]);
            localStorage.setItem('rememberedChallengeDetails', form['details'].value);
            localStorage.setItem('rememberedCookingStyle', styleVal);
            
            // 記憶身分與備註
            localStorage.setItem('rememberedIdentity', form['post-identity'].value);
            localStorage.setItem('rememberedNotes', document.getElementById('challenge-notes').value);
        } else {
            localStorage.removeItem('rememberedChallengeTime');
            localStorage.removeItem('rememberedChallengeDetails');
            localStorage.removeItem('rememberedCookingStyle');
            
            // 移除身分與備註記憶
            localStorage.removeItem('rememberedIdentity');
            localStorage.removeItem('rememberedNotes');
        }

        const selectedIdentity = document.getElementById('post-identity').value;
        // 如果選的是 'main'，使用當前登入者的暱稱，否則使用分身字串
        const displayHostName = selectedIdentity === 'main' ? currentUserProfile.nickname : selectedIdentity;
        // =========================================================

        let publicImageUrl = null;
        const fileInput = document.getElementById('challenge-image');
        
        // 取得備註內容
        const notesVal = document.getElementById('challenge-notes').value.trim();

        // 2. 圖片上傳邏輯
        if (fileInput.files.length > 0) {
            try {
                const file = fileInput.files[0];
                const fileName = `${Date.now()}_${Math.floor(Math.random()*1000)}.${file.name.split('.').pop()}`;
                const { error: upErr } = await supabaseClient.storage.from('challenge-images').upload(fileName, file);
                if(upErr) throw upErr;
                const { data } = supabaseClient.storage.from('challenge-images').getPublicUrl(fileName);
                publicImageUrl = data.publicUrl;
            } catch (err) {
                console.error('圖片上傳失敗:', err);
                showToast('圖片上傳失敗，將不含圖片發布', true);
            }
        }

        const startTime = new Date(timeVal);
        
        // 3. 寫入資料庫
        const { data: newChal, error } = await supabaseClient.from('challenges').insert({
            host_id: currentUserProfile.id,
            display_host_name: displayHostName, 
            mushroom_type: form['mushroom-type'].value,
            slots: parseInt(form['slots'].value),
            start_time: startTime.toISOString(),
            details: form['details'].value,
            status: startTime > new Date() ? '預計開放' : '開放報名中',
            cooking_style: styleVal,
            image_url: publicImageUrl,
            notes: notesVal // 寫入備註
        }).select().single();

        if (error) {
            showToast(`發布失敗: ${error.message}`, true);
        } else {
            showToast('發布成功！', false);
            challengeModal.classList.add('hidden');
            
            // 4. 前端渲染更新
            // 這裡建議明確帶入 display_host_name，確保剛發布完卡片上就立刻顯示正確的分身名字
            const fullObj = { 
                ...newChal, 
                host: { id: currentUserProfile.id, nickname: currentUserProfile.nickname }, 
                signups: [],
                display_host_name: displayHostName 
            };
            
            renderChallenge(fullObj);
            applyFilter();
        }
        submitChallengeButton.disabled = false; 
        submitChallengeButton.textContent = '確認發布';
    });

    /** [編輯] 開啟編輯視窗 (含分身選單載入) */
    async function openEditModal(challengeId) {
        const c = challengesData[challengeId];
        if (!c) { showToast('找不到資料', true); return; }
        
        // --- 1. 填入既有資料 (保留您原本的邏輯) ---
        document.getElementById('edit-challenge-id').value = c.id;
        // 暫存舊圖網址 (給後續垃圾清理用)
        document.getElementById('edit-challenge-form').dataset.originalImage = c.image_url || '';
        
        document.getElementById('edit-mushroom-type').value = c.mushroom_type;
        document.getElementById('edit-slots').value = c.slots;
        
        // 時間處理 (將 UTC 資料庫時間轉為本地 Input 格式)
        if (c.start_time) {
            document.getElementById('edit-start-time').value = toLocalISOString(new Date(c.start_time));
        }
        
        document.getElementById('edit-details').value = c.details;
        document.getElementById('edit-cooking-style').value = c.cooking_style || '大火快炒（戰力全開）';

        // 填入備註 (若無則為空字串)
        document.getElementById('edit-challenge-notes').value = c.notes || '';

        // --- 2. 載入與設定「發布身分」 ---
        const identitySelect = document.getElementById('edit-post-identity');
        
        // 重置選單，先放入主帳號
        identitySelect.innerHTML = `<option value="main">${currentUserProfile.nickname} (主帳號)</option>`;
        
        // 確保有分身資料 (若尚未載入過，嘗試載入一次)
        if (typeof myAlts === 'undefined' || myAlts.length === 0) {
            const { data } = await supabaseClient.from('user_alts').select('*');
            if (data) myAlts = data;
        }

        // 將分身加入選項
        if (myAlts && myAlts.length > 0) {
            myAlts.forEach(alt => {
                const option = document.createElement('option');
                option.value = alt.full_display;
                option.textContent = `🎭 ${alt.full_display}`;
                identitySelect.appendChild(option);
            });
        }

        // 設定當前選中的值
        // 如果資料庫欄位是空的，或是等於主帳號暱稱，就選 'main'
        // 否則選對應的分身字串
        if (!c.display_host_name || c.display_host_name === currentUserProfile.nickname) {
            identitySelect.value = 'main';
        } else {
            // 如果該分身已被刪除，select 預設會停在 'main'，這也是合理的 fallback
            identitySelect.value = c.display_host_name;
        }

        // 3. 顯示 Modal
        editChallengeModal.classList.remove('hidden');
    }

    // 編輯挑戰表單送出 (含分身邏輯與垃圾圖檔清理)
    editChallengeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submit-edit-challenge-button');
        btn.disabled = true; 
        btn.textContent = '儲存中...';
        
        const id = document.getElementById('edit-challenge-id').value;
        const newSlots = parseInt(document.getElementById('edit-slots').value);
        const newTime = new Date(document.getElementById('edit-start-time').value);
        
        // 取得暫存的舊圖網址 (用於垃圾清理)
        const oldImageUrl = editChallengeForm.dataset.originalImage;

        // 取得備註
        const notesVal = document.getElementById('edit-challenge-notes').value.trim();
        
        // 計算狀態 (保留您原本的邏輯)
        const curSignups = challengesData[id]?.signups?.length || 0;
        let status = (newTime > new Date()) ? '預計開放' : (curSignups >= newSlots ? '已額滿' : '開放報名中');

        // 這裡是編輯視窗，ID 必須是 edit-post-identity，不能用 post-identity
        const selectedIdentity = document.getElementById('edit-post-identity').value;
        const displayHostName = selectedIdentity === 'main' ? currentUserProfile.nickname : selectedIdentity;

        const updateData = {
            mushroom_type: document.getElementById('edit-mushroom-type').value,
            slots: newSlots,
            start_time: newTime.toISOString(),
            details: document.getElementById('edit-details').value,
            status: status,
            cooking_style: document.getElementById('edit-cooking-style').value,
            display_host_name: displayHostName, // 寫入新的顯示名稱
            notes: notesVal // 更新備註
        };

        const fileInput = document.getElementById('edit-challenge-image');
        let newUploadedFileName = null; 

        try {
            // --- 圖片上傳邏輯 (保留) ---
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const fileName = `${Date.now()}_edit_${Math.floor(Math.random()*1000)}.${file.name.split('.').pop()}`;
                
                const { error: upErr } = await supabaseClient.storage.from('challenge-images').upload(fileName, file);
                if(upErr) throw upErr;
                
                newUploadedFileName = fileName; 
                const { data } = supabaseClient.storage.from('challenge-images').getPublicUrl(fileName);
                updateData.image_url = data.publicUrl;
            }

            // --- 更新資料庫 ---
            const { error } = await supabaseClient.from('challenges').update(updateData).eq('id', id);
            if(error) throw error;

            // --- 舊圖垃圾清理邏輯 (保留) ---
            // 只有當「有上傳新圖」且「原本有舊圖」且「新舊圖不同」時才刪除
            if (updateData.image_url && oldImageUrl && oldImageUrl !== updateData.image_url) {
                try {
                    const oldFileName = oldImageUrl.split('/').pop();
                    if (oldFileName) {
                        await supabaseClient.storage.from('challenge-images').remove([oldFileName]);
                        console.log('已清理舊圖:', oldFileName);
                    }
                } catch (delErr) {
                    console.error('舊圖刪除失敗 (不影響更新):', delErr);
                }
            }

            showToast('更新成功', false);
            editChallengeModal.classList.add('hidden');
            fileInput.value = ''; 
            reloadChallengeCard(id);

        } catch (err) {
            console.error(err);
            showToast(`更新失敗: ${err.message}`, true);
            
            // 若資料庫更新失敗，但圖已上傳，則刪除剛上傳的新圖 (回滾機制)
            if (newUploadedFileName) {
                await supabaseClient.storage.from('challenge-images').remove([newUploadedFileName]);
            }
        } finally {
            btn.disabled = false; 
            btn.textContent = '確認儲存';
        }
    });

    /** [刪除] */
    async function deleteChallenge(id) {
        confirmDeleteButton.disabled = true; confirmDeleteButton.textContent = '刪除中...';
        try {
            const { data: cData } = await supabaseClient.from('challenges').select('image_url').eq('id', id).single();
            if(cData && cData.image_url) {
                const fileName = cData.image_url.split('/').pop();
                await supabaseClient.storage.from('challenge-images').remove([fileName]);
            }
            const { error } = await supabaseClient.from('challenges').delete().eq('id', id);
            if(error) throw error;
            showToast('刪除成功', false);
            const card = document.getElementById(`challenge-${id}`);
            if(card) card.remove();
        } catch (err) { showToast(`刪除失敗: ${err.message}`, true); }
        finally { hideDeleteConfirmModal(); }
    }

    function hideDeleteConfirmModal() {
        challengeToDeleteId = null;
        deleteConfirmModal.classList.add('hidden');
        confirmDeleteButton.disabled = false;
        confirmDeleteButton.textContent = '確認刪除';
    }
    cancelDeleteButton.addEventListener('click', hideDeleteConfirmModal);
    confirmDeleteButton.addEventListener('click', () => { if(challengeToDeleteId) deleteChallenge(challengeToDeleteId); });

    // 用來鎖定/解鎖所有報名按鈕的工具函式
    function setAllButtonsLoading(isLoading) {
        // 選取所有帶有 .signup-button class 的按鈕
        const btns = document.querySelectorAll('.signup-button');
        
        btns.forEach(btn => {
            if (isLoading) {
                // === 鎖定模式 ===
                // 只有當按鈕原本是「可點擊」的狀態 (沒被 disabled)，我們才標記並鎖定它
                // 這樣可以避免誤開那些原本就在冷卻中或無權限的按鈕
                if (!btn.disabled) {
                    btn.dataset.wasEnabled = "true"; // 暫存標記：記住它原本是活的
                    btn.disabled = true;             // 鎖定
                    btn.classList.add('cursor-not-allowed', 'opacity-50'); // 視覺變灰
                }
            } else {
                // === 解鎖模式 ===
                // 只恢復那些「原本是活的」按鈕
                if (btn.dataset.wasEnabled === "true") {
                    btn.disabled = false;
                    btn.classList.remove('cursor-not-allowed', 'opacity-50');
                    delete btn.dataset.wasEnabled;   // 清除標記
                }
            }
        });
    }

    /** [報名] */
    async function handleSignUp(challengeId, buttonEl) {
        // 1. 按下的瞬間，立刻鎖定「全場」按鈕！防止使用者在等待期間去點別張
        setAllButtonsLoading(true); 
        
        // 更改當前按鈕文字，提供視覺回饋
        buttonEl.textContent = '報名中...';

        const nid = parseInt(challengeId);
        // 呼叫後端 (這裡已經有 SQL 悲觀鎖保護了)
        const { error } = await supabaseClient.rpc('signup_for_challenge', { challenge_id_to_signup: nid });

        if (error) {
            // 2a. 報名失敗 (例如：手速慢了被搶光、或額度不足)
            showToast(`報名失敗: ${error.message.includes('limit') ? '本日額度已滿' : error.message}`, true);
            
            // 恢復當前按鈕的文字
            buttonEl.textContent = '報名'; 
            
            // 失敗了要「解鎖全場」，讓使用者可以趕快去搶別張！
            setAllButtonsLoading(false);
            
            // 重新整理這張卡片 (例如更新顯示為已額滿)
            reloadChallengeCard(challengeId);
        } else {
            // 2b. 報名成功！
            showToast('報名成功！', false);
            
            // 注意：這裡「不需要」呼叫 setAllButtonsLoading(false)
            // 因為接下來 refreshAllChallengeCards() 會重繪整個列表 (舊按鈕會消失)
            // 且 triggerGlobalCooldown() 會接手進行 3 秒全域鎖定
            
            userSignedUpChallengeIds.add(nid);
            triggerGlobalCooldown(); // 啟動全域 3 秒冷卻
            
            await reloadChallengeCard(challengeId);
            await refreshUserProfile();
            refreshAllChallengeCards();
            updateQuotaDisplay();
        }
    }

    function triggerGlobalCooldown() {
        globalCooldownUntil = Date.now() + 3000;
        if (globalCooldownTimer) clearInterval(globalCooldownTimer);
        globalCooldownTimer = setInterval(() => {
            const timeLeft = Math.ceil((globalCooldownUntil - Date.now()) / 1000);
            const btns = document.querySelectorAll('.signup-button');
            if (timeLeft <= 0) {
                clearInterval(globalCooldownTimer);
                globalCooldownUntil = 0;
                refreshAllChallengeCards();
            } else {
                btns.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('btn-cooldown', 'bg-gray-600');
                    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    btn.textContent = `冷卻中 ${timeLeft}s`;
                });
            }
        }, 100);
    }

    /** [取消報名] */
    async function handleCancelSignUp(challengeId, buttonEl) {
        // 防呆確認，按下「取消」則不執行後續動作
        if (!confirm('確定要取消報名嗎？')) return;

        buttonEl.disabled = true; buttonEl.textContent = '取消中...';
        const nid = parseInt(challengeId);
        const { error } = await supabaseClient.rpc('cancel_signup_and_update_challenge', { challenge_id_to_cancel: nid });
        if (error) {
            showToast(`取消失敗: ${error.message}`, true);
            reloadChallengeCard(challengeId);
        } else {
            showToast('已取消報名', false);
            userSignedUpChallengeIds.delete(nid);
            await reloadChallengeCard(challengeId);
            await refreshUserProfile();
            refreshAllChallengeCards();
            updateQuotaDisplay();
        }
    }
    
    /** [發車] */
    async function handleToggleDispatchStatus(challengeId, currentStatus) {
        const newStatus = currentStatus === '待發' ? '已發' : '待發';
        const { error } = await supabaseClient.from('challenges').update({ 
            dispatch_status: newStatus,
            dispatched_at: newStatus === '已發' ? new Date().toISOString() : null
        }).eq('id', challengeId);
        
        if(error) showToast(`更新失敗`, true);
        reloadChallengeCard(challengeId);
    }

    // 事件委派：所有卡片按鈕操作都在這裡統一處理
    challengesListEl.addEventListener('click', (e) => {
        const target = e.target;
        
        // 1. 刪除
        const delBtn = target.closest('.delete-challenge-button');
        if (delBtn) { challengeToDeleteId = delBtn.dataset.id; deleteConfirmModal.classList.remove('hidden'); return; }
        
        // 2. 編輯
        const editBtn = target.closest('.edit-challenge-button');
        if (editBtn) { openEditModal(editBtn.dataset.id); return; }
        
        // 3. 報名
        const signBtn = target.closest('.signup-button');
        if (signBtn) { handleSignUp(signBtn.dataset.challengeId, signBtn); return; }
        
        // 4. 取消
        const cancelBtn = target.closest('.cancel-signup-button');
        if (cancelBtn) { handleCancelSignUp(cancelBtn.dataset.challengeId, cancelBtn); return; }
        
        // 5. 發車
        const dispatchBtn = target.closest('.dispatch-status-tag');
        if (dispatchBtn && dispatchBtn.classList.contains('cursor-pointer')) {
            handleToggleDispatchStatus(dispatchBtn.dataset.id, dispatchBtn.dataset.currentStatus);
            return;
        }
        
        // 6. 校時 (Sync)
        const syncBtn = target.closest('.open-sync-modal-button');
        if (syncBtn) {
            const id = syncBtn.dataset.id;
            document.getElementById('sync-challenge-id').value = id;
            const c = challengesData[id];
            if (c && c.countdown_end_time) {
                const diff = new Date(c.countdown_end_time) - new Date();
                if (diff > 0) {
                    document.getElementById('sync-days').value = Math.floor(diff / 86400000);
                    document.getElementById('sync-hours').value = Math.floor((diff % 86400000) / 3600000);
                    document.getElementById('sync-minutes').value = Math.floor((diff % 3600000) / 60000);
                }
            } else {
                document.getElementById('sync-days').value = 0;
                document.getElementById('sync-hours').value = 0;
                document.getElementById('sync-minutes').value = 0;
            }
            syncTimeModal.classList.remove('hidden');
        }
    });


    // =========================================================================
    // 8. 計時器與同步 (Timer & Sync)
    // =========================================================================

    syncTimeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const d = parseInt(document.getElementById('sync-days').value)||0;
        const h = parseInt(document.getElementById('sync-hours').value)||0;
        const m = parseInt(document.getElementById('sync-minutes').value)||0;
        if(d===0 && h===0 && m===0) { alert('請輸入時間'); return; }
        
        const endTime = new Date(new Date().getTime() + (d*86400000 + h*3600000 + m*60000));
        await updateChallengeTimer(endTime.toISOString());
    });
    cancelSyncButton.addEventListener('click', () => syncTimeModal.classList.add('hidden'));
    clearSyncButton.addEventListener('click', () => updateChallengeTimer(null));

    async function updateChallengeTimer(isoTime) {
        const id = document.getElementById('sync-challenge-id').value;
        const btn = document.getElementById('confirm-sync-button');
        btn.disabled = true; btn.textContent = '更新中...';
        try {
            const { error } = await supabaseClient.rpc('update_challenge_countdown', { p_challenge_id: parseInt(id), p_end_time: isoTime });
            if(error) throw error;
            showToast('時間已更新', false);
            syncTimeModal.classList.add('hidden');
            await reloadChallengeCard(id);
            updateBattleTimers();
        } catch(e) { showToast(`失敗: ${e.message}`, true); }
        finally { btn.disabled = false; btn.textContent = '更新'; }
    }

    function updateAllCountdowns() {
        document.querySelectorAll('.countdown-timer').forEach(el => {
            const diff = new Date(el.dataset.starttime) - new Date();
            if (diff < 1000) {
                el.classList.remove('countdown-timer');
                el.textContent = '即將開放...';
                const card = el.closest('.challenge-card');
                if(card) reloadChallengeCard(parseInt(card.id.split('-')[1]));
            } else {
                const d = Math.floor(diff/86400000), h = Math.floor((diff%86400000)/3600000);
                const m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
                if(d>0) el.textContent = `${d}天${h}時後`;
                else if(h>0) el.textContent = `${h}時${m}分後`;
                else el.textContent = `${m}分${s}秒後`;
            }
        });
    }

    function updateBattleTimers() {
        document.querySelectorAll('.battle-timer').forEach(el => {
            const endStr = el.dataset.endtime;
            const cardContainer = el.closest('.flex-col');
            const harvestEl = cardContainer ? cardContainer.querySelector('.harvest-timer') : null;

            if (!endStr || endStr === 'null' || endStr === 'undefined') {
                el.textContent = '--:--';
                el.className = 'battle-timer text-gray-500 font-bold';
                if(harvestEl) harvestEl.textContent = '';
                return;
            }

            const end = new Date(endStr);
            const diff = end - new Date();

            if(harvestEl) {
                const pad = n => n.toString().padStart(2,'0');
                harvestEl.textContent = `收成時間　${end.getFullYear()}/${pad(end.getMonth()+1)}/${pad(end.getDate())} ${end.getHours()}:${pad(end.getMinutes())}`;
            }

            if (diff <= 0) {
                el.textContent = '已結束';
                el.className = 'battle-timer text-red-400 font-bold';
            } else {
                el.className = 'battle-timer text-white font-bold';
                if (diff < 60000) el.textContent = `倒數:${Math.floor(diff/1000)}秒`;
                else {
                    const d = Math.floor(diff/86400000), h = Math.floor((diff%86400000)/3600000);
                    const m = Math.floor((diff%3600000)/60000);
                    const mm = m.toString().padStart(2,'0');
                    if(d>0) el.textContent = `倒數　${d}天${h}小時${mm}分`;
                    else if(h>0) el.textContent = `倒數　${h}小時${mm}分`;
                    else el.textContent = `倒數　${m}分`;
                }
            }
        });
    }

    function startGlobalCountdown() {
        if (countdownInterval) clearInterval(countdownInterval);
        updateAllCountdowns(); updateBattleTimers();
        countdownInterval = setInterval(() => { updateAllCountdowns(); updateBattleTimers(); }, 1000);
    }


    // =========================================================================
    // 9. 排行榜與跑馬燈 (Leaderboard & Marquee)
    // =========================================================================

    leaderboardButton.addEventListener('click', () => {
        leaderboardModal.classList.remove('hidden');
        currentLeaderboardPeriod = 'week'; currentLeaderboardType = 'host';
        updateLeaderboardUI();
    });
    closeLeaderboardButton.addEventListener('click', () => leaderboardModal.classList.add('hidden'));
    
    periodWeekBtn.addEventListener('click', () => { currentLeaderboardPeriod='week'; updateLeaderboardUI(); });
    periodMonthBtn.addEventListener('click', () => { currentLeaderboardPeriod='month'; updateLeaderboardUI(); });
    leaderboardTabs.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (btn && btn.dataset.type) { currentLeaderboardType = btn.dataset.type; updateLeaderboardUI(); }
    });

    function updateLeaderboardUI() {
        const activeClass = 'flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-bold transition bg-indigo-600 text-white shadow-sm';
        const inactiveClass = 'flex-1 sm:flex-none px-4 py-1.5 rounded-md text-sm font-bold text-gray-400 hover:text-gray-200 transition';
        
        periodWeekBtn.className = currentLeaderboardPeriod==='week' ? activeClass : inactiveClass;
        periodMonthBtn.className = currentLeaderboardPeriod==='month' ? activeClass : inactiveClass;
        document.querySelectorAll('#leaderboard-tabs button').forEach(btn => {
            btn.className = (btn.dataset.type === currentLeaderboardType) ? activeClass : inactiveClass;
        });
        fetchLeaderboard(currentLeaderboardType, currentLeaderboardPeriod);
    }

    async function fetchLeaderboard(type, period) {
        leaderboardContent.innerHTML = '<p class="text-center text-gray-400 py-8">讀取中...</p>';
        
        // 判斷 RPC 函式名稱
        let func;
        if (type === 'count') func = 'get_leaderboard_from_profiles';
        else if (type === 'speed') func = 'get_speed_leaderboard_from_profiles';
        else if (type === 'postcard') func = 'get_postcard_leaderboard'; 
        else func = 'get_host_leaderboard';
        
        try {
            const { data, error } = await supabaseClient.rpc(func, { period_type: period });
            if(error) throw error;
            
            if (type === 'count') renderCountLeaderboard(data);
            else if (type === 'speed') renderSpeedLeaderboard(data);
            else if (type === 'postcard') renderPostcardLeaderboard(data); // 渲染函式
            else renderHostLeaderboard(data);
        } catch (e) { leaderboardContent.innerHTML = '<p class="text-center text-red-400">載入失敗</p>'; }
    }

    function renderCountLeaderboard(data) {
        if(!data?.length) { leaderboardContent.innerHTML='<p class="text-center text-gray-500 py-8">無紀錄</p>'; return; }
        let rank=0, last=-1;
        leaderboardContent.innerHTML = data.map(item => {
            if(item.signup_count!==last) rank++; last=item.signup_count;
            return `<div class="flex items-center py-3 border-b border-gray-700 hover:bg-gray-800/50 transition">
                    <span class="w-12 text-center font-bold text-lg text-gray-300 flex-shrink-0">${rank<=3?['🥇','🥈','🥉'][rank-1]:rank}</span>
                    <span class="flex-1 min-w-0 px-3 truncate text-gray-200">${item.nickname||'未知'}</span>
                    <span class="w-24 text-right font-bold text-indigo-400 flex-shrink-0">${item.signup_count} 次</span></div>`;
        }).join('');
    }

    function renderSpeedLeaderboard(data) {
        if(!data?.length) { leaderboardContent.innerHTML='<p class="text-center text-gray-500 py-8">無紀錄</p>'; return; }
        let rank=0, last=-1;
        leaderboardContent.innerHTML = data.map(item => {
            const t = parseFloat(item.fastest_time_seconds);
            if(t!==last) rank++; last=t;
            return `<div class="flex items-center py-3 border-b border-gray-700 hover:bg-gray-800/50 transition">
                    <span class="w-12 text-center font-bold text-lg text-gray-300 flex-shrink-0">${rank<=3?['🥇','🥈','🥉'][rank-1]:rank}</span>
                    <span class="flex-1 min-w-0 px-3 truncate text-gray-200">${item.nickname||'未知'}</span>
                    <span class="w-24 text-right font-bold text-yellow-400 flex-shrink-0">${!isNaN(t)?t.toFixed(3):'N/A'} s</span></div>`;
        }).join('');
    }

    function renderHostLeaderboard(data) {
        if(!data?.length) { leaderboardContent.innerHTML='<p class="text-center text-gray-500 py-8">無紀錄</p>'; return; }
        let rank=0, last=-1;
        leaderboardContent.innerHTML = data.map(item => {
            if(item.host_count!==last) rank++; last=item.host_count;
            return `<div class="flex items-center py-3 border-b border-gray-700 hover:bg-gray-800/50 transition">
                    <span class="w-12 text-center font-bold text-lg text-gray-300 flex-shrink-0">${rank<=3?['🥇','🥈','🥉'][rank-1]:rank}</span>
                    <span class="flex-1 min-w-0 px-3 truncate text-gray-200">${item.nickname||'未知'}</span>
                    <span class="w-24 text-right font-bold text-green-400 flex-shrink-0">${item.host_count} 菇</span></div>`;
        }).join('');
    }
    
    function renderPostcardLeaderboard(data) {
        if(!data?.length) { leaderboardContent.innerHTML='<p class="text-center text-gray-500 py-8">無紀錄</p>'; return; }
        let rank=0, last=-1;
        leaderboardContent.innerHTML = data.map(item => {
            if(item.postcard_count!==last) rank++; last=item.postcard_count;
            return `<div class="flex items-center py-3 border-b border-gray-700 hover:bg-gray-800/50 transition">
                    <span class="w-12 text-center font-bold text-lg text-gray-300 flex-shrink-0">${rank<=3?['🥇','🥈','🥉'][rank-1]:rank}</span>
                    <span class="flex-1 min-w-0 px-3 truncate text-gray-200">${item.nickname||'未知'}</span>
                    <span class="w-24 text-right font-bold text-pink-400 flex-shrink-0">${item.postcard_count} 張</span></div>`;
        }).join('');
    }

    async function updateMarquee() {
        const marqueeEl = document.getElementById('marquee-content');
        try {
            const [sData, spData, hData, pData] = await Promise.all([
                supabaseClient.rpc('get_leaderboard_from_profiles', { period_type: 'month' }),
                supabaseClient.rpc('get_speed_leaderboard_from_profiles', { period_type: 'month' }),
                supabaseClient.rpc('get_host_leaderboard', { period_type: 'month' }),
                supabaseClient.rpc('get_postcard_leaderboard', { period_type: 'month' })
            ]);
            
            // 定義清洗暱稱的小工具
            const clean = (name) => (name || '').trim().replace(/[\s\uFEFF\xA0]*\d{12}$/, '');

            let parts = [];
            
            // 為每一項冠軍加上對應的顏色與粗體 class
            
            // 1. 發菇王 (綠色)
            if(hData.data?.[0]) {
                parts.push(`<span class="text-gray-400">★&nbsp;&nbsp;&nbsp;</span>🍄 本月發菇王：<span class="text-green-400 font-bold">${clean(hData.data[0].nickname)} (${hData.data[0].host_count}朵)</span>`);
            }
            
            // 2. 報名王 (靛藍色)
            if(sData.data?.[0]) {
                parts.push(`🏆 本月報名王：<span class="text-indigo-400 font-bold">${clean(sData.data[0].nickname)} (${sData.data[0].signup_count}次)</span>`);
            }
            
            // 3. 最速傳說 (黃色)
            if(spData.data?.[0]) {
                parts.push(`⚡ 本月最速傳說：<span class="text-yellow-400 font-bold">${clean(spData.data[0].nickname)} (${parseFloat(spData.data[0].fastest_time_seconds).toFixed(2)}秒)</span>`);
            }
            
            // 4. 美片王 (粉色)
            if(pData.data?.[0]) {
                parts.push(`🖼️ 本月美片王：<span class="text-pink-400 font-bold">${clean(pData.data[0].nickname)} (${pData.data[0].postcard_count}張)</span><span class="text-gray-400">&nbsp;&nbsp;&nbsp;★</span>`);
            }

            if(parts.length > 0) {
                marqueeEl.innerHTML = parts.join(' &nbsp;&nbsp; <span class="text-gray-400">★</span> &nbsp; '); // 中間用灰色星星隔開，視覺更整潔
                
                // 重置動畫
                marqueeEl.classList.remove('animate-marquee');
                void marqueeEl.offsetWidth; 
                marqueeEl.classList.add('animate-marquee');
                
            } else {
                marqueeEl.textContent = '目前尚無挑戰紀錄，快來搶頭香！';
            }
        } catch(e) { 
            console.error(e); 
            marqueeEl.textContent = '歡迎來到菇菇宅配網！'; 
        }
    }


    // =========================================================================
    // 10. 其他工具 (Subscription, Realtime, Utils)
    // =========================================================================

    /** [訂閱] */
    function checkSubscriptionStatus() {
        if(!currentUserProfile) return;
        // 讀取新的 is_subscribed_... 欄位
        updateSubBtn(signupSubButton, signupIcon, signupText, currentUserProfile.is_subscribed_signup, 'text-green-500', '報名通知', 'signup');
        updateSubBtn(fullSubButton, fullIcon, fullText, currentUserProfile.is_subscribed_full, 'text-pink-500', '額滿通知', 'full');
    }

    // 修改 updateSubBtn 簽名 (拿掉 email 參數)
    function updateSubBtn(btn, icon, txt, isSub, color, name, type) {
        if(isSub) {
            icon.textContent='📭'; txt.textContent='已加入';
            btn.className=`${color} hover:opacity-80 transition text-xs md:text-base flex items-center gap-1`;
            btn.title=`已加入${name}群組 (點擊前往設定/退出)`;
        } else {
            icon.textContent= name==='額滿通知'?'🔔':'📧'; txt.textContent=name;
            btn.className=`text-gray-400 hover:${name==='額滿通知'?'text-red-400':'text-indigo-400'} transition text-xs md:text-base flex items-center gap-1`;
            btn.title=`點擊前往 Google Groups 加入${name}`;
        }
        btn.onclick = () => handleSubClick(type, isSub, name);
    }

    /** [訂閱] 執行訂閱/退訂動作 (導引至 Google Groups) */
    async function handleSubClick(type, isCurrentlySubscribed, name) {
        const btn = type === 'full' ? fullSubButton : signupSubButton;
        btn.disabled = true;
        
        // 定義網址
        const joinUrl = type === 'full' 
            ? "https://groups.google.com/g/full_quota_notify" 
            : "https://groups.google.com/g/mushroom_notify";
            
        const leaveUrl = type === 'full' 
            ? "https://groups.google.com/g/full_quota_notify/membership" 
            : "https://groups.google.com/u/1/g/mushroom_notify/membership";

        const targetUrl = isCurrentlySubscribed ? leaveUrl : joinUrl;
        const actionText = isCurrentlySubscribed ? '退出' : '加入';
        
        // 提示訊息
        const confirmMsg = isCurrentlySubscribed
            ? `您確定要退出【${name}】嗎？\n\n系統將標記為未訂閱，並引導您至 Google Groups 頁面，請手動點擊「退出群組」。`
            : `您想要加入【${name}】嗎？\n\n系統將引導您至 Google Groups 頁面，請手動點擊「申請加入」。`;

        if (!confirm(confirmMsg)) {
            btn.disabled = false;
            return;
        }

        try {
            // 呼叫後端更新狀態 (單純紀錄 True/False)
            const { data, error } = await supabaseClient.functions.invoke('admin-actions', { 
                body: { 
                    action: 'update-subscription', 
                    payload: { 
                        userId: currentUserProfile.id, 
                        type: type,
                        status: !isCurrentlySubscribed // 切換狀態
                    } 
                } 
            });

            if (error) throw error;
            if (data?.error) throw new Error(data.error);

            // 更新本地狀態
            if (type === 'full') currentUserProfile.is_subscribed_full = !isCurrentlySubscribed;
            else currentUserProfile.is_subscribed_signup = !isCurrentlySubscribed;
            
            checkSubscriptionStatus();

            // 跳轉
            window.location.href = targetUrl;

        } catch (e) { 
            showToast('狀態更新失敗', true); 
            console.error(e); 
        } finally { 
            btn.disabled = false; 
        }
    }

    /** [訂閱] 執行訂閱/退訂動作 */
    async function doSub(email, type) {
        const btn = type === 'full' ? fullSubButton : signupSubButton;
        // 暫存原本按鈕文字以便恢復 (優化版通常不需要，但保留以防萬一)
        // const originalText = btn.textContent; 
        
        btn.disabled = true;
        
        try {
            const { data, error } = await supabaseClient.functions.invoke('admin-actions', { 
                body: { 
                    action: 'update-subscription', 
                    payload: { 
                        userId: currentUserProfile.id, 
                        email: email, 
                        type: type 
                    } 
                } 
            });

            if (error) throw error;
            if (data?.error) throw new Error(data.error);

            // 更新本地狀態
            if (type === 'full') currentUserProfile.full_notification_email = email;
            else currentUserProfile.notification_email = email;
            
            checkSubscriptionStatus();

            // 定義群組網址
            const groupUrl = type === 'full' 
                ? "https://groups.google.com/g/full_quota_notify" 
                : "https://groups.google.com/g/mushroom_notify/members";

            if (email) {
                // === 訂閱成功 ===
                showToast('訂閱成功！', false);
                setTimeout(() => {
                    alert('即將轉往Google網路論壇，請按「要求加入群組」，等審核通過即可收到通知。');
                    window.location.href = groupUrl;
                }, 500);
            } else {
                // === 退訂成功 (加入提示與轉址) ===
                showToast('已取消訂閱', false);
                setTimeout(() => {
                    alert('【⚠️ 重要提醒】\n\n系統已清除您的信箱紀錄，但您仍需手動退出 Google 群組。\n\n點擊確定後將轉往群組頁面，請找到「退出群組」按鈕以完成退訂。');
                    window.location.href = groupUrl;
                }, 500);
            }

        } catch (e) { 
            showToast('操作失敗', true); 
            console.error(e); 
        } finally { 
            btn.disabled = false; 
        }
    }

    /** [Realtime] 最終完美版監聽器 (含前端查表) */
    function setupRealtimeListeners() {
        supabaseClient.channel('room_db_changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'challenges' }, payload => {
                if (payload.eventType === 'DELETE') {
                    const el = document.getElementById(`challenge-${payload.old.id}`);
                    if (el) el.remove();
                    // 同步刪除本地快取資料，並更新紅點
                    if (challengesData[payload.old.id]) {
                        delete challengesData[payload.old.id];
                        updateFilterBadges();
                    }
                } else {
                    reloadChallengeCard(payload.new.id);
                }
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'signups' }, payload => {
                
                // 1. 嘗試直接取得 (新增/修改會有 new.challenge_id，刪除若有開 Full 會有 old.challenge_id)
                let cid = payload.new?.challenge_id || payload.old?.challenge_id;

                // 2. 如果是刪除 (DELETE) 且資料庫沒給 challenge_id，我們自己查表！
                if (!cid && payload.eventType === 'DELETE' && payload.old?.id) {
                    const deletedSignupId = payload.old.id;
                    cid = signupIdToChallengeMap[deletedSignupId];
                    
                    if (cid) {
                        console.log(`[前端查表成功] 報名ID ${deletedSignupId} 屬於 挑戰ID ${cid}`);
                        // 刪除快取，避免記憶體洩漏 (雖然 JS 物件很小沒差，但養成好習慣)
                        delete signupIdToChallengeMap[deletedSignupId];
                    }
                }

                if (cid) {
                    fetchUserSignups().then(() => reloadChallengeCard(cid));
                }
            })
            .subscribe();
    }

    /** [在線狀態 - 內部人員專用] */
    function setupOnlinePresence() {
        // 1. 設定身分：直接使用 Profile 暱稱 (內部人員必有 Profile)
        if (!currentUserProfile) return; // 防呆
        const myIdentity = currentUserProfile.nickname;
        
        // 2. 使用獨立的 'online-users' 頻道
        // 這與 guest.html 的 'guest-room' 完全分開，互不干擾
        const ch = supabaseClient.channel('online-users', { 
            config: { presence: { key: myIdentity } } 
        });

        const updateState = () => {
            const state = ch.presenceState();
            // 直接取得所有 Key (即暱稱)，不需要過濾訪客代碼
            onlineNicknames = Object.keys(state);
            
            // 排序 (讓中文/英文名稱排列整齊)
            onlineNicknames.sort((a, b) => a.localeCompare(b, 'zh-Hant'));

            // 3. 更新 Header UI (在線人數)
            const container = document.getElementById('online-users-container');
            if (container) {
                const span = container.querySelector('span');
                if (span) {
                    span.textContent = `在線: ${onlineNicknames.length} 人`;
                }
            }
        };

        ch.on('presence', { event: 'sync' }, updateState)
          .on('presence', { event: 'join' }, updateState)
          .on('presence', { event: 'leave' }, updateState)
          .subscribe(status => { 
              if(status === 'SUBSCRIBED') ch.track({ online_at: new Date().toISOString() });
          });
          
        // 4. Modal 顯示清單邏輯
        const modal = document.getElementById('online-users-modal');
        const listEl = document.getElementById('online-users-list');
        const closeBtn = document.getElementById('close-online-users-modal');

        if(onlineUsersContainer) { 
            onlineUsersContainer.onclick = (e) => {
                if(e.target.closest('#refresh-button')) return;
                
                if (listEl) {
                    listEl.innerHTML = onlineNicknames.map(n => 
                        `<li class="p-2 border-b border-gray-700 last:border-0 hover:bg-gray-700/50 rounded flex items-center gap-2">
                            <span class="text-green-400 text-xs">●</span>
                            <span class="text-gray-200">${n}</span>
                        </li>`
                    ).join('');
                }
                if (modal) modal.classList.remove('hidden');
            };
        }
        if(closeBtn) closeBtn.onclick = () => modal.classList.add('hidden');
        if(modal) modal.onclick = (e) => { if(e.target === modal) modal.classList.add('hidden'); };
    }
        
    /** [工具] 截圖 */
    screenshotButton.addEventListener('click', () => {
        screenshotButton.disabled=true; screenshotButton.innerHTML='截圖中...';
        html2canvas(challengesListEl, { backgroundColor: '#111827', useCORS: true, scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `菇菇挑戰_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }).catch(e => showToast('截圖失敗', true))
          .finally(() => { screenshotButton.disabled=false; screenshotButton.innerHTML='📸 截圖'; });
    });

    /** [工具] 通用提示框 (修正版：加入 z-index 確保顯示在最上層) */
    function showToast(msg, isErr) {
        const toastMessage = document.getElementById('toast-message');
        if (!toastMessage) return;

        // 設定內容
        toastMessage.textContent = msg;
        
        // 設定樣式：
        // 1. z-[100]: 確保蓋過 Header 和 Modal
        // 2. shadow-2xl, rounded-xl: 讓樣式更立體好看
        // 3. transition: 加入滑順的動畫效果
        toastMessage.className = `fixed top-5 right-5 text-white py-3 px-6 rounded-xl shadow-2xl z-[100] font-bold flex items-center gap-2 transform transition-all duration-300 ${isErr ? 'bg-red-600/95' : 'bg-green-600/95'}`;
        
        // 顯示
        toastMessage.classList.remove('hidden');
        
        // 3秒後自動消失
        setTimeout(() => {
            toastMessage.classList.add('hidden');
        }, 3000);
    }

    // 工具函式：取得本地時間字串 (格式：YYYY-MM-DDTHH:mm)
    // 這能確保輸入框顯示的時間完全等於您的系統時間，不會有時差
    function toLocalISOString(date) {
        const pad = (n) => n.toString().padStart(2, '0');
        const year = date.getFullYear();
        const month = pad(date.getMonth() + 1);
        const day = pad(date.getDate());
        const hours = pad(date.getHours());
        const minutes = pad(date.getMinutes());
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // 排名後綴 (保留原版)
    function getRankSuffix(n) { if(n%100>=11&&n%100<=13)return'th'; switch(n%10){case 1:return'st';case 2:return'nd';case 3:return'rd';default:return'th';} }
    
    // 時間格式化 (保留原版)
    function formatSignupTime(iso) { 
        if(!iso)return''; const d=new Date(iso); 
        return `${d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false})}.${d.getMilliseconds().toString().padStart(3,'0')}`;
    }

    // Filter Tabs
    filterTabs.addEventListener('click', (e) => {
        const t = e.target.closest('.filter-tab');
        if(!t || t.classList.contains('active')) return;
        document.querySelectorAll('.filter-tab').forEach(el=>el.classList.remove('active'));
        t.classList.add('active'); activeFilter = t.dataset.filter; applyFilter();
    });
    
    function applyFilter() {
        let count = 0;
        const cards = document.querySelectorAll('.challenge-card');
        
        cards.forEach(c => {
            let show = false;
            // 直接讀取卡片上的 dataset 屬性 (由 renderChallenge 寫入)
            const status = c.dataset.status; 
            const isSignedUp = c.dataset.isSignedUp === 'true';
            const isHosted = c.dataset.isHosted === 'true';
            const isGuest = c.dataset.isGuest === 'true';

            switch (activeFilter) {
                case 'all':
                    // 1. 全部挑戰：顯示「非訪客」且「非已額滿」的卡片
                    // (包含：開放報名中、預計開放)
                    if (!isGuest && status !== '已額滿') {
                        show = true;
                    }
                    break;
                    
                case 'imported':
                    // 2. 進口菇：顯示「訪客菇」且「非已額滿」的卡片
                    if (isGuest && status !== '已額滿') {
                        show = true;
                    }
                    break;
                    
                case 'full':
                    // 3. 已額滿：顯示所有「已額滿」的卡片 (包含內部與訪客，可在此報名備取)
                    if (status === '已額滿') {
                        show = true;
                    }
                    break;
                    
                case 'signed-up':
                    // 4. 已報名
                    if (isSignedUp) show = true;
                    break;
                    
                case 'hosted':
                    // 5. 已發布
                    if (isHosted) show = true;
                    break;
            }

            c.style.display = show ? 'flex' : 'none';
            if (show) count++;
        });

        // 處理「查無資料」的提示訊息
        const msg = document.getElementById('no-items-message');
        if (msg) msg.remove();
        
        if (count === 0 && cards.length > 0) {
            let emptyText = '這個分類下沒有挑戰喔！';
            if (activeFilter === 'imported') emptyText = '目前沒有進口菇訊號 🛸';
            
            challengesListEl.insertAdjacentHTML('beforeend', `<p id="no-items-message" class="text-center col-span-full text-gray-400 py-8">${emptyText}</p>`);
        }
    }

    // Mobile Menu
    hamburgerButton.addEventListener('click', (e) => { e.stopPropagation(); mobileMenu.classList.toggle('hidden'); });
    window.addEventListener('click', (e) => { if(!mobileMenu.classList.contains('hidden') && !mobileMenu.contains(e.target)) mobileMenu.classList.add('hidden'); });

    mobileMenu.querySelector('#change-password-button-mobile').onclick = () => changePasswordButton.click();
    mobileMenu.querySelector('#logout-button-mobile').onclick = () => logoutButton.click();

    // Global Image Viewer
    window.openImageViewer = function(url) {
        const m = document.getElementById('image-viewer-modal'), i = document.getElementById('viewer-image');
        if(m && i) { i.src=url; m.classList.remove('hidden'); }
    };
    window.closeImageViewer = function() {
        const m = document.getElementById('image-viewer-modal'), i = document.getElementById('viewer-image');
        if(m) { m.classList.add('hidden'); setTimeout(() => { if(i) i.src=''; }, 300); }
    };

    window.copyText = (text) => {
        // 確保文本不為空
        if (!text || text.trim() === '') {
            showToast('座標資料為空，無法複製', true);
            return;
        }

        navigator.clipboard.writeText(text)
            .then(() => {
                // 複製成功
                showToast('已複製座標', false);
            })
            .catch(err => {
                // 複製失敗 (可能是權限問題或瀏覽器限制)
                console.error('複製失敗:', err);
                showToast('複製失敗，請檢查權限設定', true);
            });
    };

    // 在線列表
    onlineUsersContainer.addEventListener('click', (e) => {
        if(e.target.closest('#refresh-button')) return;
        onlineUsersList.innerHTML = onlineNicknames.map(n=>`<li class="p-1">${n}</li>`).join('');
        onlineUsersModal.classList.remove('hidden');
    });
    closeOnlineUsersModalButton.addEventListener('click', () => onlineUsersModal.classList.add('hidden'));
    
    /** [工具] 重新整理按鈕 (修復) */
    if (refreshButton) {
        refreshButton.addEventListener('click', (e) => {
            e.stopPropagation(); // 防止點擊時同時觸發「開啟在線名單」
            window.location.reload();
        });
    }

    // =======================
    // ▼▼▼ 使用者改暱稱邏輯 ▼▼▼
    // =======================
    const changeNicknameBtn = document.getElementById('change-nickname-button');
    const changeNicknameBtnMob = document.getElementById('change-nickname-button-mobile');
    const nicknameModal = document.getElementById('nickname-modal');
    const nicknameForm = document.getElementById('nickname-form');
    const cancelNicknameBtn = document.getElementById('cancel-nickname-button');
    const newNicknameInput = document.getElementById('new-nickname-input');
    const submitNicknameBtn = document.getElementById('submit-nickname-button');

    function openNicknameModal() {
        if(!currentUserProfile) return;
        // 預帶入舊暱稱
        newNicknameInput.value = currentUserProfile.nickname || '';
        nicknameModal.classList.remove('hidden');
    }

    // 綁定按鈕 (電腦版 & 手機版)
    if(changeNicknameBtn) changeNicknameBtn.addEventListener('click', openNicknameModal);
    if(changeNicknameBtnMob) changeNicknameBtnMob.addEventListener('click', openNicknameModal);
    
    // 關閉 Modal
    if(cancelNicknameBtn) cancelNicknameBtn.addEventListener('click', () => nicknameModal.classList.add('hidden'));

    // 送出表單
    if(nicknameForm) {
        nicknameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newName = newNicknameInput.value.trim();
            
            // 基本防呆
            if(!newName) return;
            if(newName === currentUserProfile.nickname) {
                showToast('新暱稱與舊暱稱相同', true); return;
            }

            submitNicknameBtn.disabled = true;
            submitNicknameBtn.textContent = '修改中...';

            try {
                // 呼叫後端 API
                const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                    body: { 
                        action: 'user-update-nickname', 
                        payload: { newNickname: newName } 
                    }
                });

                if (error) throw error;
                if (data?.error) throw new Error(data.error);

                // 成功後提示並登出
                showToast('修改成功！請重新登入', false);
                nicknameModal.classList.add('hidden');
                
                // 強制登出，讓使用者用新名字重新登入 (延遲 1.5 秒讓使用者看到成功訊息)
                setTimeout(() => {
                    logoutButton.click();
                }, 1500);

            } catch (err) {
                console.error(err);
                showToast(`修改失敗: ${err.message}`, true);
            } finally {
                submitNicknameBtn.disabled = false;
                submitNicknameBtn.textContent = '確認修改';
            }
        });
    }

    // --- 分身功能變數 ---
    const manageAltsBtn = document.getElementById('manage-alts-button');
    const manageAltsBtnMob = document.getElementById('manage-alts-button-mobile');
    const altsModal = document.getElementById('alts-modal');
    const closeAltsModalBtn = document.getElementById('close-alts-modal');
    const altsListEl = document.getElementById('alts-list');
    const addAltBtn = document.getElementById('add-alt-btn');
    const altNicknameInput = document.getElementById('alt-nickname-input');
    const altCodeInput = document.getElementById('alt-code-input');
    let myAlts = []; // 儲存分身列表

    // 綁定事件
    if(manageAltsBtn) manageAltsBtn.addEventListener('click', openAltsModal);
    if(manageAltsBtnMob) manageAltsBtnMob.addEventListener('click', openAltsModal);
    if(closeAltsModalBtn) closeAltsModalBtn.addEventListener('click', () => altsModal.classList.add('hidden'));

    // 點擊 Modal 外部關閉
    altsModal.addEventListener('click', (e) => {
        if (e.target === altsModal) altsModal.classList.add('hidden');
    });

    addAltBtn.addEventListener('click', handleAddAlt);

    // 開啟管理視窗
    async function openAltsModal() {
        altsModal.classList.remove('hidden');
        await fetchAlts();
    }

    // 從資料庫讀取分身
    async function fetchAlts() {
        altsListEl.innerHTML = '<li class="text-center text-gray-500 text-sm">讀取中...</li>';
        try {
            const { data, error } = await supabaseClient
                .from('user_alts')
                .select('*')
                .order('created_at', { ascending: true });
            
            if (error) throw error;
            myAlts = data || [];
            renderAltsList();
        } catch (e) {
            console.error(e);
            altsListEl.innerHTML = '<li class="text-center text-red-400 text-sm">讀取失敗</li>';
        }
    }

    // 渲染列表
    function renderAltsList() {
        if (myAlts.length === 0) {
            altsListEl.innerHTML = '<li class="text-center text-gray-500 text-sm py-2">尚未建立分身</li>';
            return;
        }
        
        altsListEl.innerHTML = myAlts.map(alt => `
            <div class="flex justify-between items-center bg-gray-700/50 p-2 rounded-lg border border-gray-600">
                <span class="text-sm text-gray-200 font-mono">${alt.full_display}</span>
                <button onclick="deleteAlt(${alt.id})" class="text-red-400 hover:text-red-300 px-2 text-xs font-bold">刪除</button>
            </div>
        `).join('');
    }

    // 新增分身
    async function handleAddAlt() {
        const nick = altNicknameInput.value.trim();
        let code = altCodeInput.value.trim();
        
        if (!nick || !code) {
            showToast('請輸入完整資訊', true);
            return;
        }
        
        // 簡單過濾好友碼 (只留數字)
        code = code.replace(/\D/g, '');
        if (code.length !== 12) {
            showToast('好友碼必須為 12 位數字', true);
            return;
        }
        
        const fullDisplay = `${nick}✈️${code}`; // 自動組合
        
        addAltBtn.disabled = true;
        addAltBtn.textContent = '處理中...';
        
        try {
            const { error } = await supabaseClient
                .from('user_alts')
                .insert({
                    user_id: currentUserProfile.id,
                    alt_nickname: nick,
                    friend_code: code,
                    full_display: fullDisplay
                });
                
            if (error) throw error;
            
            showToast('分身新增成功', false);
            altNicknameInput.value = '';
            altCodeInput.value = '';
            await fetchAlts(); // 重新讀取
        } catch (e) {
            showToast('新增失敗: ' + e.message, true);
        } finally {
            addAltBtn.disabled = false;
            addAltBtn.textContent = '新增至列表';
        }
    }

    // 刪除分身 (需掛載到 window)
    window.deleteAlt = async (id) => {
        if (!confirm('確定要刪除這個分身嗎？')) return;
        try {
            const { error } = await supabaseClient.from('user_alts').delete().eq('id', id);
            if (error) throw error;
            await fetchAlts();
        } catch (e) {
            showToast('刪除失敗', true);
        }
    };

    // 工具函式：更新畫面上所有卡片中，特定使用者的缺席分數與按鈕狀態
    async function syncUserStatusOnAllCards(targetUserId) {
        // 1. 先去資料庫抓這個人「最新」的分數 (確保數據絕對正確)
        const { data: userData, error } = await supabaseClient
            .from('profiles')
            .select('absent_score')
            .eq('id', targetUserId)
            .single();

        if (error || !userData) return;
        const newScore = userData.absent_score;

        // 2. 遍歷所有已載入的卡片資料 (challengesData)
        // 我們不重新 fetch 所有挑戰 (太慢)，而是直接修改本地快取
        Object.values(challengesData).forEach(challenge => {
            if (!challenge.signups) return;

            // 檢查這張卡片有沒有這個人
            const participant = challenge.signups.find(s => s.user_id === targetUserId);
            
            if (participant) {
                // A. 更新分數
                if (participant.profile) {
                    participant.profile.absent_score = newScore;
                }

                // B. 重新渲染這張卡片 (這樣分數和按鈕狀態才會更新)
                renderChallenge(challenge);
            }
        });
    }

    // 回報缺席 (修正版：全域同步 + 手動更新按鈕狀態)
    async function reportAbsent(challengeId, userId, userName) {
        if (!confirm(`確認回報「${userName}」本次缺席嗎？\n\n• 對方缺席指數將 +2\n• 此操作稍後可撤銷`)) return;
        
        try {
            const { error } = await supabaseClient.rpc('report_absentee', { 
                p_challenge_id: challengeId, 
                p_absentee_id: userId 
            });
            
            if (error) {
                if (error.message.includes('unique constraint') || error.message.includes('duplicate')) {
                    showToast('已經回報過了', true);
                    // 發生衝突時，強制重整該卡片以修正按鈕狀態
                    reloadChallengeCard(challengeId);
                } else {
                    showToast(`回報失敗: ${error.message}`, true);
                }
            } else {
                showToast(`已標記 ${userName} 缺席`, false);

                // 關鍵 1：手動更新本地快取，讓按鈕立刻變色 (解決 409 問題)
                const c = challengesData[challengeId];
                if (c) {
                    if (!c.absent_records) c.absent_records = [];
                    // 塞入一筆假紀錄，讓 renderChallenge 知道「我檢舉過他了」
                    c.absent_records.push({ 
                        reporter_id: currentUserProfile.id, 
                        absentee_id: userId 
                    });
                }

                // 關鍵 2：觸發全域同步，更新所有卡片上的分數
                await syncUserStatusOnAllCards(userId);
            }
        } catch (e) {
            console.error(e);
            showToast('系統錯誤', true);
        }
    }

    // 撤銷檢舉 (修正版：全域同步 + 手動更新按鈕狀態)
    async function revokeAbsent(challengeId, userId, userName) {
        if (!confirm(`確定要撤銷對「${userName}」的缺席回報嗎？\n\n• 對方將扣除 2 點缺席指數`)) return;
        
        try {
            const { error } = await supabaseClient.rpc('revoke_absentee', { 
                p_challenge_id: challengeId, 
                p_absentee_id: userId 
            });
            
            if (error) throw error;
            
            showToast(`已撤銷檢舉`, false);

            // 關鍵 1：手動移除本地快取中的檢舉紀錄
            const c = challengesData[challengeId];
            if (c && c.absent_records) {
                c.absent_records = c.absent_records.filter(
                    r => !(r.reporter_id === currentUserProfile.id && r.absentee_id === userId)
                );
            }

            // 關鍵 2：觸發全域同步，更新所有卡片上的分數
            await syncUserStatusOnAllCards(userId);

        } catch (e) {
            showToast(`撤銷失敗: ${e.message}`, true);
        }
    }

    // 複製發菇者好友碼的專用函式
    function copyHostFriendCode(fullString) {
        // 1. 嘗試提取 12 位數字
        const match = fullString.match(/(\d{12})/);
        
        if (match) {
            const code = match[1];
            // 2. 提取暱稱 (移除好友碼與分隔符號，用於提示訊息)
            // 使用與您之前一致的正則表達式，移除尾端的 12 位數
            let nickname = fullString.replace(/[\s\uFEFF\xA0]*\d{12}[\s\uFEFF\xA0]*$/, '').trim();
            // 如果有飛機符號，也稍微修飾一下 (可選)
            nickname = nickname.replace(/✈️$/, '').trim();

            navigator.clipboard.writeText(code).then(() => {
                // 3. 顯示成功提示
                showToast(`已複製 [${nickname}] 好友碼`, false);
            }).catch(err => {
                console.error('複製失敗:', err);
                showToast('複製失敗，請手動複製', true);
            });
        } else {
            // 防呆：如果字串裡沒有好友碼 (例如舊資料只有暱稱)
            showToast('此發菇者未設定好友碼', true);
        }
    }

    // 更新所有分類的通知紅點
    function updateFilterBadges() {
        // 定義計數器
        let counts = {
            all: 0,      // 內部菇 & 未額滿
            imported: 0, // 訪客菇 & 未額滿
            full: 0,     // 任何菇 & 已額滿
            signed: 0,   // 我報名的
            hosted: 0    // 我發布的
        };

        // 遍歷所有資料進行統計
        Object.values(challengesData).forEach(c => {
            const isFull = c.status === '已額滿';
            const isGuest = c.is_guest === true;
            const isSigned = userSignedUpChallengeIds.has(c.id);
            const isHosted = c.host && currentUserProfile && c.host.id === currentUserProfile.id;

            // 1. 全部挑戰 (邏輯：非訪客菇 且 未額滿)
            if (!isGuest && !isFull) counts.all++;

            // 2. 進口菇 (邏輯：訪客菇 且 未額滿)
            if (isGuest && !isFull) counts.imported++;

            // 3. 已額滿 (邏輯：狀態為已額滿)
            if (isFull) counts.full++;

            // 4. 已報名
            if (isSigned) counts.signed++;

            // 5. 已發布
            if (isHosted) counts.hosted++;
        });

        // 更新 UI 顯示 (封裝成小函式方便呼叫)
        const setBadge = (id, count) => {
            const el = document.getElementById(id);
            if (!el) return;
            if (count > 0) {
                el.textContent = count > 99 ? '99+' : count;
                el.classList.remove('hidden');
                // 只有數字變動時才跳動 (這裡簡化為每次更新都跳一下，或可不做判斷)
                el.classList.remove('animate-bounce');
                void el.offsetWidth; // 觸發 reflow
                el.classList.add('animate-bounce');
                setTimeout(() => el.classList.remove('animate-bounce'), 1000);
            } else {
                el.classList.add('hidden');
            }
        };

        setBadge('badge-all', counts.all);
        setBadge('badge-imported', counts.imported);
        setBadge('badge-full', counts.full);
        setBadge('badge-signed', counts.signed);
        setBadge('badge-hosted', counts.hosted);
    }

    // ==========================================
    // ▼▼▼ YouTube 背景音樂控制邏輯 (播放清單版) ▼▼▼
    // ==========================================
    
    // 1. 載入 YouTube IFrame API (這段通用代碼只需執行一次，若您頁面已有可省略)
    if (!window.YT) { 
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }

    var musicPlayer;
    var musicTimer;
    var isDragging = false; 

    // 2. API 準備好後建立播放器
    function onYouTubeIframeAPIReady() {
        musicPlayer = new YT.Player('youtube-player-container', {
            height: '200', 
            width: '200',
            playerVars: {
                'listType': 'playlist',
                'list': 'PLnvczP3jeVcKbv9p3sHtYmIEPZpuBlOAi',
                'playsinline': 1,
                'controls': 0,
                'disablekb': 1,
                'fs': 0,
                'rel': 0,
                'loop': 1,
                'autoplay': 1,
                'shuffle': 1,
                'mute': 1  // 繞過瀏覽器限制
            },
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
        });
    }

    // 3. 播放器準備就緒
    function onPlayerReady(event) {
        event.target.setShuffle(true);
        
        setTimeout(() => {
            if (!musicPlayer || !musicPlayer.getDuration) return;
            const total = musicPlayer.getDuration();
            if (total) document.getElementById('music-progress').max = Math.floor(total);
        }, 1000);

        // 1. 讀取使用者上次的靜音偏好
        const isUserMuted = localStorage.getItem('bg_music_muted') === 'true';
        const volBtn = document.getElementById('music-volume-btn');

        if (isUserMuted) {
            // 2. 如果使用者上次是靜音，直接靜音播放
            console.log("依照使用者偏好：靜音播放");
            musicPlayer.mute();
            musicPlayer.playVideoAt(0);

            // 更新按鈕為紅色
            if(volBtn) {
                // dashboard 原本的 class 是 text-gray-300
                volBtn.classList.remove('text-gray-300', 'text-white');
                volBtn.classList.add('text-red-500');
            }
        } else {
            // 3. 如果使用者想要有聲，執行您原本的嘗試播放邏輯
            const attemptPlay = () => {
                musicPlayer.setVolume(50);
                musicPlayer.unMute(); 
                musicPlayer.playVideoAt(0);

                setTimeout(() => {
                    const state = musicPlayer.getPlayerState();
                    if (state === -1 || state === 2) {
                        console.log("有聲播放被阻擋，切換為靜音自動播放");
                        musicPlayer.mute(); 
                        musicPlayer.playVideoAt(0); 
                        
                        if(volBtn) {
                            volBtn.classList.remove('text-gray-300');
                            volBtn.classList.add('text-red-500');
                        }
                    } else {
                        // 成功播放有聲，確保按鈕是灰色
                        if(volBtn) {
                            volBtn.classList.remove('text-red-500');
                            volBtn.classList.add('text-gray-300');
                        }
                    }
                }, 1000);
            };

            attemptPlay();
        }
    }

    // 4. 監聽狀態
    function onPlayerStateChange(event) {
        const btnPlay = document.getElementById('icon-play');
        const btnPause = document.getElementById('icon-pause');

        if (event.data == YT.PlayerState.PLAYING) {
            btnPlay.classList.add('hidden');
            btnPause.classList.remove('hidden');
            startTimer();
        } else {
            btnPlay.classList.remove('hidden');
            btnPause.classList.add('hidden');
            stopTimer();
        }
    }

    // --- 按鈕互動 ---
    
    // 播放/暫停
    document.getElementById('music-toggle-btn').addEventListener('click', function() {
        if (!musicPlayer || !musicPlayer.getPlayerState) return;
        const state = musicPlayer.getPlayerState();
        if (state == YT.PlayerState.PLAYING) {
            musicPlayer.pauseVideo();
        } else {
            musicPlayer.playVideo();
        }
    });

    // 下一首按鈕
    document.getElementById('music-next-btn').addEventListener('click', function() {
        if (musicPlayer && musicPlayer.nextVideo) {
            musicPlayer.nextVideo();
        }
    });

    // 進度條
    const progressBar = document.getElementById('music-progress');
    progressBar.addEventListener('input', function() {
        isDragging = true;
        const current = this.value;
        const total = musicPlayer.getDuration();
        updateTimeDisplay(current, total);
    });

    progressBar.addEventListener('change', function() {
        isDragging = false;
        musicPlayer.seekTo(this.value, true);
    });

    // 靜音
    document.getElementById('music-volume-btn').addEventListener('click', function() {
        if (!musicPlayer) return;
        if (musicPlayer.isMuted()) {
            // 開啟聲音
            musicPlayer.unMute();
            this.classList.remove('text-red-500');
            // 注意：dashboard 原本這裡寫 text-gray-600，建議改回 text-gray-300 比較亮
            this.classList.add('text-gray-300'); 
            
            // 記憶：有聲
            localStorage.setItem('bg_music_muted', 'false');
        } else {
            // 關閉聲音
            musicPlayer.mute();
            this.classList.remove('text-gray-300'); // 移除亮灰色
            this.classList.add('text-red-500'); 
            
            // 記憶：靜音
            localStorage.setItem('bg_music_muted', 'true');
        }
    });

    // --- 輔助函式 ---
    function startTimer() {
        if (musicTimer) clearInterval(musicTimer);
        musicTimer = setInterval(() => {
            if (!musicPlayer || isDragging || !musicPlayer.getCurrentTime) return;
            const current = musicPlayer.getCurrentTime();
            const total = musicPlayer.getDuration();
            
            // 某些時候抓不到總長度，給預設值
            if (total) {
                document.getElementById('music-progress').max = Math.floor(total);
                document.getElementById('music-progress').value = Math.floor(current);
                updateTimeDisplay(current, total);
            }
        }, 1000);
    }

    function stopTimer() {
        if (musicTimer) clearInterval(musicTimer);
    }

    function updateTimeDisplay(current, total) {
        const format = (seconds) => {
            if (isNaN(seconds)) return "0:00";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        };
        document.getElementById('music-time').textContent = `${format(current)} / ${format(total)}`;
    }

    // ==========================================
    // ▼▼▼ 音樂播放器氣泡縮放邏輯 ▼▼▼
    // ==========================================

    // 1. 取得元素
    const playerContainer = document.getElementById('bg-music-player');
    let collapseTimer = null;
    const COLLAPSE_DELAY = 3000; // 3秒後縮小

    // 2. 定義縮小函式
    function collapsePlayer() {
        if(playerContainer) {
            playerContainer.classList.add('player-collapsed');
        }
    }

    // 3. 定義展開函式
    function expandPlayer() {
        if(playerContainer) {
            playerContainer.classList.remove('player-collapsed');
            resetCollapseTimer(); // 展開後重新開始倒數
        }
    }

    // 4. 重置計時器 (如果滑鼠還在上面，就不縮小；滑鼠離開才縮小)
    function resetCollapseTimer() {
        if (collapseTimer) clearTimeout(collapseTimer);
        collapseTimer = setTimeout(collapsePlayer, COLLAPSE_DELAY);
    }

    // 5. 初始化與事件綁定
    if (playerContainer) {
        // A. 頁面載入後，先啟動一次倒數
        resetCollapseTimer();

        // B. 滑鼠移入：展開並暫停縮小倒數
        playerContainer.addEventListener('mouseenter', () => {
            if(playerContainer.classList.contains('player-collapsed')) {
                expandPlayer();
            }
            if (collapseTimer) clearTimeout(collapseTimer); // 清除倒數，保持展開
        });

        // C. 滑鼠移出：開始 3 秒倒數準備縮小
        playerContainer.addEventListener('mouseleave', () => {
            resetCollapseTimer();
        });

        // D. 點擊氣泡：展開 (適用於觸控裝置或點擊氣泡時)
        playerContainer.addEventListener('click', (e) => {
            // 如果目前是縮小狀態，則展開
            if (playerContainer.classList.contains('player-collapsed')) {
                expandPlayer();
                e.stopPropagation(); // 避免點擊氣泡瞬間就觸發其他事件
            }
        });
    }

    // Dashboard 專用：查看留言
    window.openDashboardComment = (text, event) => {
        if (event) event.stopPropagation();
        const modal = document.getElementById('comment-viewer-modal');
        const content = document.getElementById('comment-viewer-content');
        if (modal && content) {
            content.textContent = text;
            modal.classList.remove('hidden');
        }
    };

    // Dashboard 專用：編輯留言 (修復版：呼叫後端 API) 
    window.editUserSignupComment = async (challengeId, currentVal, event) => {
        if (event) event.stopPropagation();

        const newVal = prompt('請輸入留言:', currentVal);
        if (newVal === null) return; // 取消

        // 顯示載入中
        showToast('更新留言中...', false);

        try {
            // 改用 functions.invoke 呼叫後端
            const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                body: { 
                    action: 'user-update-signup-comment', 
                    payload: { 
                        challengeId: challengeId, 
                        comment: newVal 
                    } 
                } 
            });

            if (error) throw error;
            if (data && data.error) throw new Error(data.error);

            showToast('留言已更新', false);
            // Realtime 會自動刷新畫面

        } catch (e) {
            console.error(e);
            showToast(`更新失敗: ${e.message}`, true);
        }
    };

    // Dashboard 專用：發菇者執行點名 (Toggle Checked In)
    window.toggleSignupCheckedIn = async (challengeId, signupId, userName, event) => {
        if (event) event.stopPropagation();

        // 簡單的視覺回饋
        const btn = event.target;
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = '...';

        try {
            const { data, error } = await supabaseClient.functions.invoke('admin-actions', {
                body: { 
                    action: 'toggle-signup-checked-in', 
                    payload: { 
                        challengeId: challengeId, 
                        signupId: signupId
                    } 
                } 
            });

            if (error) throw error;
            if (data && data.error) throw new Error(data.error);

            // 成功後提示
            showToast(`已更新 ${userName} 的點名狀態`, false);
            // Realtime 會自動刷新畫面 (reloadChallengeCard)

        } catch (e) {
            console.error(e);
            showToast(`操作失敗: ${e.message}`, true);
            btn.disabled = false;
            btn.textContent = originalText;
        }
    };

    // 返回頂端功能 (Back to Top) 
    
    // 1. 宣告變數
    const backToTopBtn = document.getElementById('back-to-top-btn');
    const headerTitle = document.querySelector('header h1'); // 抓取 LOGO 文字
    const headerImg = document.querySelector('header img');  // 抓取 LOGO 圖片

    // 2. 定義捲動行為 (加速 + 煞車修正版)
    function scrollToTop() {
        const currentScroll = window.scrollY;
        
        // ▼▼▼ 速度調整區 (數字越小越快) ▼▼▼
        const speedFactor = 4; 

        if (currentScroll > 0) {
            // 煞車機制：如果距離頂部小於 10px，直接歸零並結束函式
            // 這樣可以防止程式進入無限迴圈
            if (currentScroll < 10) {
                window.scrollTo(0, 0);
                return; // 這裡最關鍵，讓程式「停下來」
            }

            // 否則繼續往上捲
            window.requestAnimationFrame(scrollToTop);
            window.scrollTo(0, currentScroll - (currentScroll / speedFactor));
        }
    }

    // 3. 監聽畫面捲動：控制按鈕顯隱
    window.addEventListener('scroll', () => {
        if (!backToTopBtn) return;
        
        // 當捲動超過 300px 時顯示
        if (window.scrollY > 300) {
            backToTopBtn.classList.remove('hidden');
            // 小延遲讓 display:block 生效後再執行動畫
            requestAnimationFrame(() => {
                backToTopBtn.classList.remove('opacity-0', 'translate-y-4');
            });
        } else {
            backToTopBtn.classList.add('opacity-0', 'translate-y-4');
            // 等動畫結束後再隱藏 (配合 duration-300)
            setTimeout(() => {
                if (window.scrollY <= 300) backToTopBtn.classList.add('hidden');
            }, 300);
        }
    });

    // 4. 綁定按鈕點擊
    if (backToTopBtn) {
        backToTopBtn.addEventListener('click', (e) => {
            e.preventDefault();
            scrollToTop();
        });
    }

    // 5. (額外優化) 讓點擊 Header LOGO 也能回頂端，手機操作更順手
    if (headerTitle) {
        headerTitle.style.cursor = 'pointer';
        headerTitle.addEventListener('click', scrollToTop);
    }
    if (headerImg) {
        headerImg.style.cursor = 'pointer';
        headerImg.addEventListener('click', scrollToTop);
    }

</script>
</body>
</html>